"use strict";var fe=Object.defineProperty,_e=Object.defineProperties,Oe=Object.getOwnPropertyDescriptors,$t=Object.getOwnPropertySymbols,Te=Object.prototype.hasOwnProperty,Ie=Object.prototype.propertyIsEnumerable,Xt=(U,L,r)=>L in U?fe(U,L,{enumerable:!0,configurable:!0,writable:!0,value:r}):U[L]=r,N=(U,L)=>{for(var r in L||(L={}))Te.call(L,r)&&Xt(U,r,L[r]);if($t)for(var r of $t(L))Ie.call(L,r)&&Xt(U,r,L[r]);return U},nt=(U,L)=>_e(U,Oe(L));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[1409],{128:(U,L,r)=>{r.d(L,{B:()=>y});var n=r(15861),S=r(22558),G=r(21726),ot=r(35948),o=r(34117),s=r(31283),yt=r(77712),K=r(61556),b=r(29840);function y(h){var f;const l=null!=(f=null==h?void 0:h.origins)?f:[void 0];return(P,O)=>{const T=function D(h,l,f){var P;if("resource"===(null==h?void 0:h.type))return function p(h,l,f){const P=(0,o.Oe)(l,f);return{type:String,read:(O,T,w)=>{const C=(0,b.r)(O,T,w);return P.type===String?C:"function"==typeof P.type?new P.type({url:C}):void 0},write:{writer(O,T,w,C){if(!C||!C.resources)return"string"==typeof O?void(T[w]=(0,b.t)(O,C)):void(T[w]=O.write({},C));const R=function Ct(h){return null==h?null:"string"==typeof h?h:h.url}(O),B=(0,b.t)(R,nt(N({},C),{verifyItemRelativeUrls:C&&C.verifyItemRelativeUrls?{writtenUrls:C.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0}),b.M.NO),tt=P.type!==String&&(!(0,S.l)(this)||C&&C.origin&&this.originIdOf(f)>(0,s.M9)(C.origin)),Y={object:this,propertyName:f,value:O,targetUrl:B,dest:T,targetPropertyName:w,context:C,params:h};C&&C.portalItem&&B&&!(0,G.YP)(B)?tt?function Et(h){var et;const{context:l,targetUrl:f,params:P,value:O,dest:T,targetPropertyName:w}=h;if(!l.portalItem)return;const C=l.portalItem.resourceFromPath(f),R=bt(O,f,l),B=(0,K.B)(R),tt=(0,G.Ml)(C.path),Y=null!=(et=null==P?void 0:P.compress)&&et;B===tt?(l.resources&&ut(nt(N({},h),{resource:C,content:R,compress:Y,updates:l.resources.toUpdate})),T[w]=f):W(h)}(Y):function At({context:h,targetUrl:l,dest:f,targetPropertyName:P}){h.portalItem&&h.resources&&(h.resources.toKeep.push({resource:h.portalItem.resourceFromPath(l),compress:!1}),f[P]=l)}(Y):C&&C.portalItem&&(null==B||null!=(0,b.i)(B)||(0,G.jc)(B)||tt)?W(Y):T[w]=B}}}}(h,l,f);switch(null!=(P=null==h?void 0:h.type)?P:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:O,write:T}=b.a;return{read:O,write:T}}}}(h,P,O);for(const w of l){const C=(0,yt.CJ)(P,w,O);for(const R in T)C[R]=T[R]}}}function W(h){var ft,_t,Ot;const{targetUrl:l,params:f,value:P,context:O,dest:T,targetPropertyName:w}=h;if(!O.portalItem)return;const C=(0,b.p)(l),R=null!=(ft=null==C?void 0:C.filename)?ft:(0,ot.D)(),B=null!=(_t=null==f?void 0:f.prefix)?_t:null==C?void 0:C.prefix,tt=bt(P,l,O),Y=(0,G.v_)(B,R),et=`${Y}.${(0,K.B)(tt)}`,rt=O.portalItem.resourceFromPath(et);(0,G.jc)(l)&&O.resources&&O.resources.pendingOperations.push(function st(h){return X.apply(this,arguments)}(l).then(St=>{rt.path=`${Y}.${(0,K.B)(St)}`,T[w]=rt.itemRelativeUrl}).catch(()=>{}));const z=null!=(Ot=null==f?void 0:f.compress)&&Ot;O.resources&&ut(nt(N({},h),{resource:rt,content:tt,compress:z,updates:O.resources.toAdd})),T[w]=rt.itemRelativeUrl}function ut({object:h,propertyName:l,updates:f,resource:P,content:O,compress:T}){f.push({resource:P,content:O,compress:T,finish:w=>{!function Lt(h,l,f){"string"==typeof h[l]?h[l]=f.url:h[l].url=f.url}(h,l,w)}})}function bt(h,l,f){return"string"==typeof h?{url:l}:new Blob([JSON.stringify(h.toJSON(f))],{type:"application/json"})}function X(){return(X=(0,n.Z)(function*(h){const l=(yield Promise.resolve().then(r.bind(r,84792))).default,{data:f}=yield l(h,{responseType:"blob"});return f})).apply(this,arguments)}},22558:(U,L,r)=>{function n(S){return S&&"getAtOrigin"in S&&"originOf"in S}r.d(L,{l:()=>n})},61556:(U,L,r)=>{r.d(L,{B:()=>S});var n=r(21726);function S(b){return o[function G(b){return b instanceof Blob?b.type:function ot(b){const y=(0,n.Ml)(b);return K[y]||s}(b.url)}(b)]||yt}const o={},s="text/plain",yt=o[s],K={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const b in K)o[K[b]]=b},1437:(U,L,r)=>{r.d(L,{p:()=>b});var n=r(17626),S=r(54024),G=r(62208),ot=r(60330),o=r(77712),K=(r(90912),r(85931),r(76898));const b=y=>{let D=class extends((0,ot.v)(y)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(p){this._userInteractive=p}get updating(){return!1}get visible(){return!(0,G.pC)(this.parent)||this.parent.visible&&!this.parent.suspended}set visible(p){this._overrideIfSome("visible",p)}forceInteractiveForViewModel(){return this._interactiveViewModelCount++,(0,S.kB)(()=>this._interactiveViewModelCount--)}};return(0,n._)([(0,o.Cb)({readOnly:!0})],D.prototype,"type",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],D.prototype,"analysis",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],D.prototype,"parent",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],D.prototype,"view",void 0),(0,n._)([(0,o.Cb)({type:Boolean})],D.prototype,"interactive",null),(0,n._)([(0,o.Cb)()],D.prototype,"_userInteractive",void 0),(0,n._)([(0,o.Cb)({readOnly:!0})],D.prototype,"updating",null),(0,n._)([(0,o.Cb)()],D.prototype,"visible",null),(0,n._)([(0,o.Cb)()],D.prototype,"_interactiveViewModelCount",void 0),D=(0,n._)([(0,K.j)("esri.views.3d.analysis.AnalysisView3D")],D),D}},95310:(U,L,r)=>{r.r(L),r.d(L,{default:()=>me});var n=r(17626),S=r(14517),G=r(46160),ot=r(61885),o=r(62208),s=r(77712),K=(r(90912),r(85931)),b=r(76898),y=r(28093),D=r(1437),p=r(91558);let W=class extends S.Z{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new p.Z([3,252,111,1]),this.visibleOuterColor=new p.Z([3,252,111,.15]),this.occludedInnerColor=new p.Z([252,3,69,1]),this.occludedOuterColor=new p.Z([252,3,69,.1]),this.undefinedInnerColor=new p.Z([255,255,255,1]),this.undefinedOuterColor=new p.Z([127,127,127,.2])}};(0,n._)([(0,s.Cb)({type:Number})],W.prototype,"innerWidth",void 0),(0,n._)([(0,s.Cb)({type:Number})],W.prototype,"outerWidth",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],W.prototype,"visibleInnerColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],W.prototype,"visibleOuterColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],W.prototype,"occludedInnerColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],W.prototype,"occludedOuterColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],W.prototype,"undefinedInnerColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],W.prototype,"undefinedOuterColor",void 0),W=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],W);var Et=r(15861),ut=(r(29132),r(8425)),bt=r(59213),st=r(72392),X=r(54024),Ct=r(63290),Lt=r(10699),h=r(32917),l=r(84161),f=r(17760),P=r(55915),O=r(65401),T=r(70562),w=r(60507);let C=class extends S.Z{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,n._)([(0,s.Cb)()],C.prototype,"target",void 0),(0,n._)([(0,s.Cb)()],C.prototype,"intersectedGraphic",void 0),(0,n._)([(0,s.Cb)()],C.prototype,"intersectedLocation",void 0),(0,n._)([(0,s.Cb)()],C.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,s.Cb)({type:Boolean})],C.prototype,"visible",void 0),C=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],C);let R=class extends S.Z{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,y.c)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,y.c)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,y.c)(),targetAdjusted:(0,y.c)()},this.computationResult={start:(0,y.c)(),end:(0,y.c)(),intersection:(0,y.c)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,n._)([(0,s.Cb)()],R.prototype,"target",void 0),(0,n._)([(0,s.Cb)()],R.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,s.Cb)()],R.prototype,"inputPoints",void 0),(0,n._)([(0,s.Cb)()],R.prototype,"computationResult",void 0),(0,n._)([(0,s.Cb)()],R.prototype,"result",void 0),R=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],R);var rt,B=r(23841),tt=r(26242),Y=r(38114),et=r(58817);let z=rt=class extends S.Z{constructor(t){super(t)}clone(){return new rt({type:this.type,id:(0,et.d9)(this.id),mapPoint:(0,et.d9)(this.mapPoint),renderPoint:(0,y.a)(this.renderPoint),normal:(0,et.d9)(this.normal),ray:(0,et.d9)(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&(0,o._W)(this.mapPoint,t.mapPoint)&&(0,l.F)(this.renderPoint,t.renderPoint)&&(0,K.fS)(this.normal,t.normal)&&(0,T.fS)(this.ray,t.ray)&&this.graphic===t.graphic}};(0,n._)([(0,s.Cb)()],z.prototype,"type",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],z.prototype,"id",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],z.prototype,"mapPoint",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],z.prototype,"renderPoint",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],z.prototype,"normal",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],z.prototype,"graphic",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],z.prototype,"ray",void 0),z=rt=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],z);var ft=r(77926),_t=r(26046),Ot=r(90793),St=r(62483),Q=r(67857),ct=r(93867);let pt=class extends S.Z{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=(0,St.Z8)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=Q.eC.MIN}getScreenPointIntersection(t){const e=(0,B.md)(t,tt.qW.get()),i=(0,_t.u4)(this.view.state.camera,e,wt);return this._getRayIntersection(i)}_getRayIntersection(t,e){if((0,o.Wi)(t)||(0,o.Wi)(this.view.sceneIntersectionHelper))return null;this.intersector.options.store=Q.eC.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this.intersector,e);const i=this.intersector.results.min,a=(0,y.c)();if(!i.getIntersectionPoint(a))return null;const d=this.view.renderCoordsHelper.fromRenderCoords(a,this.view.spatialReference),c=(0,y.a)(i.normal);if((0,ft.GS)(i))return new z({type:Q.q7.OBJECT,id:`${i.target.layerUid}/${i.target.nodeIndex}/${i.target.componentIndex}`,mapPoint:d,renderPoint:a,normal:c,ray:(0,T.JG)(t),graphic:null});if((0,Ot.TX)(i))return new z({type:Q.q7.TERRAIN,id:i.target.lij.slice(),mapPoint:d,renderPoint:a,normal:c,ray:(0,T.JG)(t),graphic:null});const u=(0,ct.tB)(i,this.view);if((0,o.pC)(u)){const _=u.layer,m=u.sourceLayer;let g;return g=m&&"scene"===m.type?(0,Y.MS)(u,m.objectIdField):u.uid,new z({type:Q.q7.OBJECT,id:`${null==_?void 0:_.uid}/${g}`,mapPoint:d,renderPoint:a,normal:c,ray:(0,T.JG)(t),graphic:u})}return null}updateFromGroundIntersection(t,e,i){const a=Yt,d=Qt,c=kt,u=qt;(0,l.c)(d,t),this.view.renderCoordsHelper.worldUpAtPosition(d,c),(0,l.n)(c,c);const _=this.view.basemapTerrain.visibleElevationBounds,m=_?Math.abs(_.max-_.min):100,g=e>=0?1:-1;(0,l.g)(u,c,g*(m+Math.abs(e))),(0,l.a)(a,d,u),(0,T.zk)(a,d,wt);const v=this._getRayIntersection(wt,{include:this._terrainIntersectionOptionsLayerUids});return(0,o.pC)(v)?((0,l.g)(u,c,g*e),(0,l.a)(i,v.renderPoint,u),(0,y.a)(v.normal)):((0,l.c)(i,t),null)}};(0,n._)([(0,s.Cb)()],pt.prototype,"view",void 0),(0,n._)([(0,s.Cb)()],pt.prototype,"intersector",void 0),pt=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],pt);const Yt=(0,y.c)(),Qt=(0,y.c)(),kt=(0,y.c)(),qt=(0,y.c)(),wt=(0,T.Ue)();var Dt=r(54865),ht=r(87091),te=r(72642);const Zt="esri.views.3d.analysis.LineOfSight.LineOfSightController",Ht=Ct.Z.getLogger(Zt);let M=class extends(ot.Z.EventedMixin(S.Z)){constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new f.t,this._frameTask=ht.sq,this._handles=new st.Z,this._computationHandles=new st.Z,this._externalObserverUpdate=!0}initialize(){var e;const t=null==(e=this.view.resourceController)?void 0:e.scheduler;this._frameTask=t?t.registerTask(ht.T8.LINE_OF_SIGHT_TOOL):ht.sq,this._intersector=new pt({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){const e=t.computation,{inputPoints:i,computationResult:a}=e,{observerAdjusted:d,targetAdjusted:c}=i,{start:u,end:_}=a;(0,l.c)(u,d),(0,l.c)(_,c),this._canCompute(e)?this._computeIntersection(t):this._interpolateIntersection(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_updateAdjustedPointsFromFeatures(t){const e=this.view,{sceneIntersectionHelper:i}=e,{inputPoints:a}=t,{observerAdjusted:d,observerFeatureId:c,targetFeatureId:u,targetAdjusted:_}=a;if((0,o.Wi)(c)&&(0,o.Wi)(u))return;const m=(0,l.i)(d,_),g=this._intersector.intersector,v=(0,T.zk)(a.observer,a.target,jt);g.options.store=Q.eC.ALL,i.intersectToolIntersectorRay(v,g);let E=null,I=null,H=null,x=null;for(const j of g.results.all){const V=(0,ct.tB)(j,this.view);if((0,o.Wi)(V)||(0,o.Wi)(j.distanceInRenderSpace))continue;const $=(0,ut.pD)(V);(0,o.Wi)($)||((0,o.pC)(c)&&$===c&&((0,o.Wi)(E)&&(E=this._getFeatureDistanceThreshold(j,e,m)),j.distanceInRenderSpace<E&&(H=j)),(0,o.pC)(u)&&$===u&&((0,o.Wi)(I)&&(I=this._getFeatureDistanceThreshold(j,e,m)),(0,o.Wi)(x)&&j.distanceInRenderSpace<m&&m-j.distanceInRenderSpace<I&&(x=j)))}(0,o.pC)(H)&&H.getIntersectionPoint(d)&&(a.observerSurfaceNormal=H.getTransformedNormal((0,y.c)())),(0,o.pC)(x)&&x.getIntersectionPoint(_)&&(a.targetSurfaceNormal=x.getTransformedNormal((0,y.c)()))}_getFeatureDistanceThreshold(t,e,i){if((0,ct._s)(t)){const a=(0,ct.VB)(t,e);if((0,o.pC)(a))return Math.min(a*ie,i)}return 1e-5*i}_adjustStartEndPositions(t){const e=this._screenPixelSize,i=this.view,{inputPoints:a}=t,{observer:d,observerSurfaceNormal:c,target:u,targetSurfaceNormal:_,observerAdjusted:m,targetAdjusted:g}=a,v=Tt;(0,l.c)(m,d),(0,l.c)(g,u),this._updateAdjustedPointsFromFeatures(t),(0,o.pC)(c)?(0,l.c)(v,c):(0,l.b)(v,g,m);const E=e;(0,l.n)(v,v),(0,l.g)(v,v,Math.min(E,1)),(0,l.a)(m,m,v),(0,o.pC)(_)?(0,l.c)(v,_):(0,l.b)(v,m,g);const I=i.state.camera.computeScreenPixelSizeAt(g);(0,l.n)(v,v),(0,l.g)(v,v,Math.min(I,1)),(0,l.a)(g,g,v)}_computeIntersection({computation:t,interpolationInfo:e}){const{view:i}=this,{sceneIntersectionHelper:a,renderCoordsHelper:d}=i;if((0,o.Wi)(a))return;const c=this._intersector.intersector,{computationResult:u,inputPoints:_}=t,{observer:m,target:g}=_,{start:v,end:E}=u,I=(0,T.zk)(v,E,jt);c.options.store=Q.eC.MIN,a.intersectToolIntersectorRay(I,c);const H=c.results.min,x=u.intersection,j=Tt;let V=!0;if((0,o.pC)(H)&&H.getIntersectionPoint(x)){(0,l.c)(e.originalIntersection,x),(0,l.c)(e.originalObserver,v),(0,l.c)(e.originalTarget,E),d.fromRenderCoords(x,j,i.spatialReference);const F=1-(0,l.j)(E,g)/(0,l.j)(v,g);V=(0,l.j)(m,x)>=F*(0,l.j)(m,g)}const $=new te.Z(j,i.spatialReference);{const{result:F,target:it}=t;(0,o.pC)(F)?(F.target=it,F.intersectedGraphic=V?null:(0,ct.tB)(H,i),F.intersectedLocation=V?null:$,F.visible=V):t.result=new C({target:it,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:V?null:(0,ct.tB)(H,i),intersectedLocation:V?null:$,visible:V})}u.isValid=_.isValid=!0,u.isTargetVisible=V}_interpolateIntersection({computation:t,interpolationInfo:e}){const{computationResult:i,inputPoints:a}=t,{start:d,end:c,intersection:u}=i,{originalIntersection:_,originalObserver:m,originalTarget:g}=e;if((0,l.c)(u,_),a.isValid){const v=Tt,E=(0,l.j)(m,_)/(0,l.j)(m,g);(0,l.w)(v,d,m),(0,l.g)(v,v,1-E),(0,l.a)(u,u,v),(0,l.w)(v,c,g),(0,l.g)(v,v,E),(0,l.a)(u,u,v),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}_canCompute(t){const i=this.view.frustum;if((0,o.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,o.Wi)(t.elevationAlignedTargetLocation)||(0,o.Wi)(i))return!1;const{observerAdjusted:a,targetAdjusted:d}=t.inputPoints,c=i.intersectsPoint(a),u=i.intersectsPoint(d);return c&&u}_onObserverPositionChange(t,e,i,a,d){if(this._externalObserverUpdate=d,(0,o.Wi)(t))return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if((0,o.Wi)(e))return(0,Dt.e)(this.analysis,t.spatialReference,Ht),void(this.analysisViewData.elevationAlignedObserver=null);const c=this._getEffectiveElevationInfo(e,i),{absoluteZ:u,elevation:_}=(0,w.tq)(e.x,e.y,e.z,this.view.spatialReference,this.view,c),m=e.clone();m.z=u,this._effectiveObserverElevationMode=c.mode,this.analysisViewData.elevationAlignedObserver=m;const g=(0,y.c)();this.view.renderCoordsHelper.toRenderCoords(m,g),this._elevationAlignedObserverPositionRenderSpace=g,this._observerGroundOffsetRenderSpace=u-_,this._observerFeatureId=(0,ut.pD)(a),this.priority=ht.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,a,d){const{inputPoints:c}=t;switch((0,l.c)(c.observer,e),c.observerFeatureId=d,c.observerSurfaceNormal=null,a){case"on-the-ground":case"relative-to-ground":{const u=this._intersector.updateFromGroundIntersection(c.observer,i,c.observer);(0,o.Wi)(c.observerFeatureId)&&(c.observerSurfaceNormal=u)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=ht.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,a,d,c=!0){const u=t.inputPoints;if(c&&(u.isValid=!1),(0,o.Wi)(i))return(0,o.pC)(e)&&(0,Dt.e)(this.analysis,e.spatialReference,Ht),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();const _=this._getEffectiveElevationInfo(i,a),{absoluteZ:m,elevation:g}=(0,w.tq)(i.x,i.y,i.z,this.view.spatialReference,this.view,_),v=i.clone();switch(v.z=m,t.elevationAlignedTargetLocation=v,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,u.target),u.targetFeatureId=(0,ut.pD)(d),u.targetSurfaceNormal=null,_.mode){case"on-the-ground":case"relative-to-ground":{const E=this._intersector.updateFromGroundIntersection(u.target,m-g,u.target);(0,o.Wi)(u.targetFeatureId)&&(u.targetSurfaceNormal=E)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=ht.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return(0,X.AL)([this._updatingHandles.add(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:(0,P.dz)(t.target.position,this.view.spatialReference)}),({computation:e,targetPosition:i,targetElevationInfo:a,targetFeatureInfo:d,projectedTargetPosition:c})=>{(0,o.pC)(c.pending)?this._updatingHandles.addPromise(c.pending):this._onTargetPositionChange(e,i,c.geometry,a,d)},h.nn)])}_connectComputationToObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())},h.nn)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:e,observer:i,observerGroundOffset:a,observerElevationMode:d,observerFeatureId:c})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,a,d,c)},h.nn)}_connectComputationToCamera(t){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()})}_connectComputationToSlicePlane(t){return this._updatingHandles.add(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){const e=(i,a)=>{const d=this.analysis.observer,c=t.target;let u=null,_=null,m=null,g=null,v=null,E=null;if((0,o.pC)(d)&&(0,o.pC)(d.position)){const I=(0,P.dz)(d.position,this.view.spatialReference);if((0,o.pC)(I.pending))return this._updatingHandles.addPromise(I.pending),void I.pending.finally(()=>e(i,a));u=I.geometry,_=d.elevationInfo,m=d.feature}if((0,o.pC)(c.position)){const I=(0,P.dz)(c.position,this.view.spatialReference);if((0,o.pC)(I.pending))return this._updatingHandles.addPromise(I.pending),void I.pending.finally(()=>e(i,a));g=I.geometry,v=c.elevationInfo,E=c.feature}(0,o.Wi)(u)&&(0,o.Wi)(g)||((0,P.dH)(i,a,It,this.view.spatialReference),(0,o.pC)(u)&&(0,O.Qn)(It,u)&&this._onObserverPositionChange((0,o.pC)(d)?d.position:null,u,_,m,!1),(0,o.pC)(g)&&(0,O.Qn)(It,g)&&this._onTargetPositionChange(t,c.position,g,v,E,!1),(0,o.pC)(u)&&(0,o.pC)(g)&&(0,O.I7)(It,u,g)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",i=>e(i.extent,i.spatialReference))}_connectComputationToTask(t){var e=this;let i=o.YP;const a={computation:t,interpolationInfo:{originalIntersection:(0,y.c)(),originalObserver:(0,y.c)(),originalTarget:(0,y.c)()}};return(0,X.AL)([this._updatingHandles.add(()=>t.inputPoints,()=>{i=(0,o.IM)(i),i=(0,bt.vr)(function(){var d=(0,Et.Z)(function*(c){yield(0,Lt.R8)(e._frameTask.schedule(()=>e._computeResult(a),c))});return function(c){return d.apply(this,arguments)}}())},{initial:!0,equals:()=>!1}),(0,X.kB)(()=>i=(0,o.IM)(i))])}_connectComputation(t){const e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(const i of e)this._removeTarget(i);for(const i of t)this._addTarget(i)}_onCursorTargetChange(t,e){(0,o.pC)(e)&&this._removeTarget(e),(0,o.pC)(t)&&this._addTarget(t)}_addTarget(t){this._computations.some(e=>e.target===t)||this._computations.add(new R({target:t}))}_removeTarget(t){const e=this._computations.findIndex(i=>i.target===t);this._computations.removeAt(e)}_connectObserver(){return(0,X.AL)([this._updatingHandles.add(()=>({observerPosition:(0,o.pC)(this.analysis.observer)?this.analysis.observer.position:null,projectedObserverPosition:(0,P.dz)((0,o.pC)(this.analysis.observer)?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:(0,o.pC)(this.analysis.observer)?this.analysis.observer.elevationInfo:null,observerFeatureInfo:(0,o.pC)(this.analysis.observer)?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:a})=>{(0,o.pC)(e.pending)?this._updatingHandles.addPromise(e.pending):this._onObserverPositionChange(t,e.geometry,i,a,!0)},h.nn)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,t=>this._onComputationCollectionChange(t),{initial:!0,final:!0})}_connectTargets(){return(0,X.AL)([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(t,e)=>{this._onCursorTargetChange(t,e)})])}get _isCameraDirty(){const t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if((0,o.Wi)(t)||(0,o.Wi)(i))return!1;const a=Tt;i.toRenderCoords(t,a);const d=e.state.camera.computeScreenPixelSizeAt(a);return Math.abs((d-this._screenPixelSize)/this._screenPixelSize)>ee}_getEffectiveElevationInfo(t,e){return t.hasZ?(0,o.Pt)(e,{mode:"absolute-height",offset:0}):{mode:"on-the-ground",offset:0}}};(0,n._)([(0,s.Cb)({constructOnly:!0})],M.prototype,"analysis",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],M.prototype,"analysisViewData",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],M.prototype,"view",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"updating",null),(0,n._)([(0,s.Cb)()],M.prototype,"priority",null),(0,n._)([(0,s.Cb)()],M.prototype,"updateOnCameraChange",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"_computations",null),(0,n._)([(0,s.Cb)()],M.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,n._)([(0,s.Cb)()],M.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"_effectiveObserverElevationMode",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"_observerFeatureId",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"_screenPixelSize",null),(0,n._)([(0,s.Cb)({readOnly:!0})],M.prototype,"_updatingHandles",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"_frameTask",void 0),(0,n._)([(0,s.Cb)()],M.prototype,"_isCameraDirty",null),M=(0,n._)([(0,b.j)(Zt)],M);const ee=.1,Tt=(0,y.c)(),jt=(0,T.Ue)(),It=(0,O.cS)(),ie=.05;var Ut=r(61642),Wt=r(57574),zt=r(13777),xt=r(82706);let k=class extends S.Z{constructor(t){super(t),this.enabled=!0,this.glowColor=new p.Z([255,127,0]),this.glowWidth=8,this.innerColor=new p.Z([255,255,255]),this.innerWidth=.75,this.globalAlpha=.75}};(0,n._)([(0,s.Cb)({type:Boolean})],k.prototype,"enabled",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],k.prototype,"glowColor",void 0),(0,n._)([(0,s.Cb)({type:Number})],k.prototype,"glowWidth",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],k.prototype,"innerColor",void 0),(0,n._)([(0,s.Cb)({type:Number})],k.prototype,"innerWidth",void 0),(0,n._)([(0,s.Cb)({type:Number})],k.prototype,"globalAlpha",void 0),k=(0,n._)([(0,b.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],k);let vt=class extends S.Z{constructor(t){super(t),this.size=.5,this.color=new p.Z([255,127,0,.75])}};(0,n._)([(0,s.Cb)({type:Number})],vt.prototype,"size",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],vt.prototype,"color",void 0),vt=(0,n._)([(0,b.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],vt);let at=class extends S.Z{constructor(t){super(t),this.size=.5,this.visibleColor=new p.Z([3,252,111,.75]),this.occludedColor=new p.Z([252,3,69,.75]),this.undefinedColor=new p.Z([127,127,127,.75])}};(0,n._)([(0,s.Cb)({type:Number})],at.prototype,"size",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],at.prototype,"visibleColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],at.prototype,"occludedColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],at.prototype,"undefinedColor",void 0),at=(0,n._)([(0,b.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],at);class q extends S.Z{constructor(e){super(e),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new p.Z([3,252,111,1]),this.visibleOuterColor=new p.Z([3,252,111,.15]),this.occludedInnerColor=new p.Z([252,3,69,1]),this.occludedOuterColor=new p.Z([252,3,69,.1]),this.undefinedInnerColor=new p.Z([255,255,255,1]),this.undefinedOuterColor=new p.Z([127,127,127,.2])}}(0,n._)([(0,s.Cb)({type:Number})],q.prototype,"innerWidth",void 0),(0,n._)([(0,s.Cb)({type:Number})],q.prototype,"outerWidth",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],q.prototype,"visibleInnerColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],q.prototype,"visibleOuterColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],q.prototype,"occludedInnerColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],q.prototype,"occludedOuterColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],q.prototype,"undefinedInnerColor",void 0),(0,n._)([(0,s.Cb)({type:p.Z})],q.prototype,"undefinedOuterColor",void 0);let lt=class extends S.Z{constructor(t){super(t),this.laserLine=new k,this.observer=new vt,this.target=new at,this.lineOfSight=new q}};(0,n._)([(0,s.Cb)({type:k})],lt.prototype,"laserLine",void 0),(0,n._)([(0,s.Cb)({type:vt})],lt.prototype,"observer",void 0),(0,n._)([(0,s.Cb)({type:at})],lt.prototype,"target",void 0),(0,n._)([(0,s.Cb)({type:q})],lt.prototype,"lineOfSight",void 0),lt=(0,n._)([(0,b.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],lt);var ne=r(45403),oe=r(19142),se=r(40345),re=r(95277),ae=r(57521),gt=r(33786);function Pt(t,e,i){return new se.r((0,ae.PI)((0,oe.EA)(p.Z.toUnitRGBA(e)),t,32,32),i)}function Bt(t){const e=[];return t.customColor1&&e.push(Pt(t.size,t.customColor1,gt.jg.Custom1)),t.customColor2&&e.push(Pt(t.size,t.customColor2,gt.jg.Custom2)),t.customColor3&&e.push(Pt(t.size,t.customColor3,gt.jg.Custom3)),t.color&&e.push(Pt(t.size,t.color)),e}var dt,t,de=r(23018),ue=(r(45458),r(22712)),Ft=r(75079),Nt=r(41900),Vt=r(85112);(t=dt||(dt={})).Ready="ready",t.Creating="creating",t.Created="created";let Z=class extends ue.f{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.configuration=new lt,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new st.Z,this._handles=new st.Z,this._updatingHandles=new f.t,this._manipulatorHandles=new st.Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new pt({view:this.view}),this._handles.add((0,h.YP)(()=>this.state,t=>{t===dt.Created&&this.finishToolCreation()},h.tX)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([this._updatingHandles.add(()=>N({},this.configuration.observer),()=>this._updateObserverManipulatorStyle()),this._updatingHandles.add(()=>{var t;return null==(t=this.analysisViewData)?void 0:t.elevationAlignedObserver},t=>this._onObserverLocationChange(t),h.nn),this._updatingHandles.add(()=>N({},this.configuration.laserLine),()=>this._createVisualElements(),h.nn),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),h.nn)])}destroy(){this._updatingHandles=(0,o.SC)(this._updatingHandles),this._handles=(0,o.SC)(this._handles),this._manipulatorHandles=(0,o.SC)(this._manipulatorHandles),this._analysisHandles=(0,o.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?this.hasGrabbedManipulators?dt.Created:dt.Creating:(0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)?dt.Created:dt.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return(0,o.pC)(this.analysisViewData)&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&(0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){"immediate-click"===t.type&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void Ct.Z.getLogger(this.declaredClass).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const e=this._analysisHandles;if(e.has(t))return;const i=this._createTargetManipulator(t.target);(0,o.Wi)(this._targetTrackerManipulator)&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([this._updatingHandles.add(()=>this._getLineOfSightManipulatorStateDependencies(t),()=>this._updateManipulatorState(i,t),h.nn),this._updatingHandles.add(()=>t.elevationAlignedTargetLocation,a=>this._onTargetLocationChange(a,i),h.nn)],t)}_disconnectComputation(t){if(this.destroyed)return void Ct.Z.getLogger(this.declaredClass).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);const e=this._getTargetManipulator(t.target);(0,o.pC)(e)&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),(0,o.pC)(this._targetTrackerManipulator)&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,o.SC)(this.analysisViewData.cursorTarget)}_createManipulator(t,e,i){const a=function le(t,e){const i=Bt(e),a=new ne.Z({view:t,renderObjects:i,elevationInfo:{mode:"absolute-height",offset:0}});return(0,re.t)(a),a}(this.view,t);return a.metadata=i,this._manipulatorHandles.add([e(a),a.events.on("grab-changed",d=>this._manipulatorGrabChanged(a,d)),a.events.on("immediate-click",d=>this._manipulatorClick(a,d))],a),this.manipulators.add(a),a}_createTargetManipulator(t){const e=this.configuration,d=this._createManipulator({size:e.target.size,customColor1:e.target.visibleColor,customColor2:e.target.occludedColor,customColor3:e.target.undefinedColor,visible:!0},c=>this._createTargetManipulatorDragPipeline(c),{target:t,type:"target"});return(0,o.pC)(t.position)?d.elevationAlignedLocation=t.position:d.available=!1,d}_getTargetManipulator(t){let e=null;return this.manipulators.forEach(i=>{const a=i.manipulator;(0,o.Wi)(e)&&"target"===a.metadata.type&&a.metadata.target===t&&(e=a)}),e}_createObserverManipulator(){const t=this.configuration;return this._createManipulator({size:t.observer.size,color:t.observer.color,visible:!0},i=>this._createObserverManipulatorDragPipeline(i),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const t=this._observerManipulator,e=this.configuration.observer;t.renderObjects=Bt({size:e.size,color:e.color,visible:t.available})}_screenToIntersection(){return t=>{const e=this._intersector.getScreenPointIntersection(t.screenEnd);return(0,o.Wi)(e)?null:nt(N({},t),{intersection:e})}}_createTargetManipulatorDragPipeline(t){return(0,Ft.Xd)(t,(e,i,a)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),a.next(this._cancelTargetDragStep(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return(0,Ft.Xd)(t,(e,i,a)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),a.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>((0,o.pC)(t.intersection.mapPoint)?((0,o.Wi)(this.analysis.observer)&&(this.analysis.observer=new Ut.Z),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){const t=(0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);const i=e.intersection.mapPoint;return(0,o.pC)(i)&&(t.elevationAlignedLocation=i),e}}_cancelTargetDragStep(t){const e=(0,o.yw)(t.position,i=>i.clone());return i=>(t.position=e,i)}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_updateManipulatorState(t,e){const{isValid:i,isTargetVisible:a}=e.computationResult;t.state=i?a?gt.jg.Custom1:gt.jg.Custom2:gt.jg.Custom3}_getLineOfSightManipulatorStateDependencies(t){const{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:(0,o.pC)(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){const{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:a,observerPosition:d,visible:c}=t;if((0,o.Wi)(e))return;const u=(0,o.pC)(i)?i:a&&(0,o.pC)(d)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&(0,o.pC)(u)&&c?(e.visible=!0,e.heightManifoldTarget=u.renderLocation,e.lineVerticalPlaneSegment=u!==this._observerManipulator?(0,zt.zk)(this._observerManipulator.renderLocation,u.renderLocation,ce):null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createVisualElements(){const t=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new de.W({view:this.view,attached:!0,visible:this.visible,style:{glowColor:p.Z.toUnitRGB(t.glowColor),glowWidth:t.glowWidth,innerColor:p.Z.toUnitRGB(t.innerColor),innerWidth:t.innerWidth,globalAlpha:t.globalAlpha}})}_removeVisualElements(){(0,o.pC)(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(t){(0,o.Wi)(t)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t)}_onTargetLocationChange(t,e){(0,o.pC)(t)?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){const e=this._intersector.getScreenPointIntersection(t);if(!(0,o.Wi)(e)&&!(0,o.Wi)(e.mapPoint))if((0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)){this._clearCursorTracker();const i=new Wt.Z;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{const i=new Ut.Z;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==Vt.t.Right&&(this._addPointFromClickEvent((0,Nt.vT)(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==Vt.t.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&"Escape"===t.key&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||(0,o.Wi)(this.analysis.observer)||(0,o.Wi)(this.analysis.observer.position)))return;const e=(0,Nt.vT)(t),i=this._intersector.getScreenPointIntersection(e);(0,o.pC)(i)&&(0,o.pC)(i.mapPoint)&&((0,o.Wi)(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new Wt.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if((0,o.Wi)(e.mapPoint))return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.type){case Q.q7.OBJECT:if((0,o.pC)(e.graphic)){const a=e.graphic,d=(0,w.RL)(a);"on-the-ground"===d.mode&&(d.mode="relative-to-ground",d.offset=0),t.elevationInfo=new xt.Z(d),t.feature=a}else t.elevationInfo=null,t.feature=null;break;case Q.q7.TERRAIN:case Q.q7.I3S:t.elevationInfo=new xt.Z({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}const i=e.mapPoint.clone();i.z=(0,w.vQ)(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if("observer"===t.metadata.type||t.grabbing||t.dragging||e.button!==Vt.t.Right||this.analysis.targets.length<=1)return;const{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement}}};(0,n._)([(0,s.Cb)({constructOnly:!0})],Z.prototype,"view",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],Z.prototype,"analysis",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],Z.prototype,"state",null),(0,n._)([(0,s.Cb)({readOnly:!0})],Z.prototype,"cursor",null),(0,n._)([(0,s.Cb)()],Z.prototype,"removeIncompleteOnCancel",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],Z.prototype,"updating",null),(0,n._)([(0,s.Cb)({type:lt})],Z.prototype,"configuration",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],Z.prototype,"analysisViewData",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],Z.prototype,"_showTracker",null),(0,n._)([(0,s.Cb)()],Z.prototype,"_latestPointerMovePointerType",void 0),(0,n._)([(0,s.Cb)()],Z.prototype,"_shouldRenderTracker",null),(0,n._)([(0,s.Cb)()],Z.prototype,"_laserlineVisualElement",void 0),(0,n._)([(0,s.Cb)()],Z.prototype,"_grabbedManipulator",void 0),Z=(0,n._)([(0,b.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],Z);const ce=(0,zt.Ue)();var pe=r(43703);class he{constructor(e,i,a,d){this.visibleLineVisualElement=e,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=a,this.targetVisualElement=d}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}var Rt=r(87469),Gt=r(30693),Mt=r(40723);let J=class extends S.Z{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new st.Z,this._updatingHandles=new f.t}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=(0,o.SC)(this._updatingHandles),this._computationHandles=(0,o.SC)(this._computationHandles),this._observerVisualElement=(0,o.SC)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){return{disablePartialOcclusion:()=>{for(const t of this._lineOfSightVisualElements)t.visibleLineVisualElement.renderOccluded=Mt.yD.Occlude,t.occludedLineVisualElement.renderOccluded=Mt.yD.Occlude,t.undefinedLineVisualElement.renderOccluded=Mt.yD.Occlude},visualizations:this._lineOfSightVisualElements}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const t=this._configuration,e=this.view,i={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth},a=p.Z.toUnitRGBA(t.visibleOuterColor),d=p.Z.toUnitRGBA(t.visibleInnerColor),c=p.Z.toUnitRGBA(t.occludedOuterColor),u=p.Z.toUnitRGBA(t.occludedInnerColor),_=p.Z.toUnitRGBA(t.undefinedOuterColor),m=p.Z.toUnitRGBA(t.undefinedInnerColor),g=new Rt.r(nt(N({},i),{color:a,innerColor:d})),v=new Rt.r(nt(N({},i),{color:c,innerColor:u})),E=new Rt.r(nt(N({},i),{color:_,innerColor:m})),I=new Gt.L(nt(N({view:e,attached:!0},Kt),{size:8})),H=new he(g,v,E,I);return this._lineOfSightVisualElements.push(H),H}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){const a=this._configuration,{computationResult:d,inputPoints:c}=t,{start:u,end:_,intersection:m,isValid:g,isTargetVisible:v}=d,{observer:E}=c,I=Ce;I[12]=E[0],I[13]=E[1],I[14]=E[2];const H=(0,l.b)(ve,u,E),x=(0,l.b)(ge,_,E),j=(0,l.b)(ye,m,E),{visibleLineVisualElement:V,occludedLineVisualElement:$,undefinedLineVisualElement:F,targetVisualElement:it}=e,be=(0,o.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,o.Wi)(t.elevationAlignedTargetLocation),mt=this.visible&&!be;V.visible=mt,$.visible=mt,F.visible=mt,it.visible=mt,it.attached=!i.interactiveAndEditable,mt&&(V.geometry=null,$.geometry=null,F.geometry=null,it.geometry=t.elevationAlignedTargetLocation,g?v?(V.geometry=[[(0,y.d)(H),(0,y.d)(x)]],V.transform=I,V.color=p.Z.toUnitRGBA(a.visibleOuterColor),it.color=p.Z.toUnitRGBA(a.visibleInnerColor)):(V.geometry=[[(0,y.d)(H),(0,y.d)(j)]],V.transform=I,V.color=p.Z.toUnitRGBA(a.occludedOuterColor),$.geometry=[[(0,y.d)(j),(0,y.d)(x)]],$.transform=I,it.color=p.Z.toUnitRGBA(a.occludedInnerColor)):(F.geometry=[[(0,y.d)(H),(0,y.d)(x)]],F.transform=I,it.color=p.Z.toUnitRGBA(a.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){const{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:a}=this._configuration;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:a,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){const e=this._computationHandles;if(e.has(t))return;const i=this._createLineOfSightVisualization();e.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(t),a=>this._updateLineOfSightVisualization(t,i,a),{initial:!0,equals:()=>!1}),(0,X.kB)(()=>this._destroyLineOfSightVisualization(i))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_createObserverVisualization(){const t=p.Z.toUnitRGBA(this._configuration.visibleInnerColor),e=new Gt.L(N({view:this.view,attached:!1,color:t},Kt));this._observerVisualElement=e,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:a,visible:d})=>{(0,o.Wi)(i)||a||!d?e.attached=!1:(e.geometry=i,this._observerVisualElement.attached=!0)},h.nn))}};(0,n._)([(0,s.Cb)({constructOnly:!0})],J.prototype,"analysis",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],J.prototype,"analysisViewData",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0})],J.prototype,"view",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],J.prototype,"visible",null),(0,n._)([(0,s.Cb)()],J.prototype,"updating",null),(0,n._)([(0,s.Cb)()],J.prototype,"interactiveAndEditable",null),(0,n._)([(0,s.Cb)()],J.prototype,"test",null),(0,n._)([(0,s.Cb)()],J.prototype,"_configuration",null),J=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],J);const Kt={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},ve=(0,y.c)(),ge=(0,y.c)(),ye=(0,y.c)(),Ce=(0,pe.c)();var Jt=r(95925);let A=class extends((0,D.p)(ot.Z.EventedMixin(S.Z))){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new G.Z,this.elevationAlignedObserver=null,this.configuration=new W,this.observerEngineLocation=(0,y.c)(),this.cursorTarget=null,this.editable=!0}initialize(){const t=this.view,e=this.analysis;this._analysisController=new M({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new J({analysis:e,analysisViewData:this,view:t}),this.addHandles([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),(0,Jt.Lp)(this,Z)])}destroy(){(0,Jt.Yq)(this),this._analysisController=(0,o.SC)(this._analysisController),this._analysisVisualization=(0,o.SC)(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return(0,o.pC)(this._analysisController)&&this._analysisController.updating||(0,o.pC)(this._analysisVisualization)&&this._analysisVisualization.updating}getResultForTarget(t){const e=this.computations.find(i=>i.target===t);return(0,o.yw)(e,i=>i.result)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}};(0,n._)([(0,s.Cb)({readOnly:!0})],A.prototype,"type",void 0),(0,n._)([(0,s.Cb)({constructOnly:!0,nonNullable:!0})],A.prototype,"analysis",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"tool",void 0),(0,n._)([(0,s.Cb)({readOnly:!0})],A.prototype,"results",null),(0,n._)([(0,s.Cb)()],A.prototype,"priority",null),(0,n._)([(0,s.Cb)()],A.prototype,"computations",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"elevationAlignedObserver",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"configuration",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"observerEngineLocation",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"cursorTarget",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"updating",null),(0,n._)([(0,s.Cb)()],A.prototype,"editable",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"_analysisController",void 0),(0,n._)([(0,s.Cb)()],A.prototype,"_analysisVisualization",void 0),A=(0,n._)([(0,b.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],A);const me=A}}]);
"use strict";var me=Object.defineProperty,be=Object.defineProperties,fe=Object.getOwnPropertyDescriptors,Xt=Object.getOwnPropertySymbols,_e=Object.prototype.hasOwnProperty,Oe=Object.prototype.propertyIsEnumerable,$t=(x,w,s)=>w in x?me(x,w,{enumerable:!0,configurable:!0,writable:!0,value:s}):x[w]=s,Q=(x,w)=>{for(var s in w||(w={}))_e.call(w,s)&&$t(x,s,w[s]);if(Xt)for(var s of Xt(w))Oe.call(w,s)&&$t(x,s,w[s]);return x},vt=(x,w)=>be(x,fe(w));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[2114],{40405:(x,w,s)=>{s.d(w,{B:()=>_t});var n=s(15861),T=s(62208),it=s(22558),F=s(21726),o=s(35948),r=s(34117),nt=s(31283),ot=s(77712);function rt(p){return M[function E(p){return p instanceof Blob?p.type:function C(p){const _=(0,F.Ml)(p);return ft[_]||u}(p.url)}(p)]||B}const M={},u="text/plain",B=M[u],ft={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip"};for(const p in ft)M[ft[p]]=p;var dt=s(29840);function _t(p){const _=(0,T.pC)(p)&&p.origins?p.origins:[void 0];return(f,L)=>{const V=function st(p,_,f){if((0,T.pC)(p)&&"resource"===p.type)return function at(p,_,f){const L=(0,r.VZ)(_,f);return{type:String,read:(V,R,P)=>{const v=(0,dt.r)(V,R,P);return L.type===String?v:"function"==typeof L.type?new L.type({url:v}):void 0},write:{writer(V,R,P,v){if(!v||!v.resources)return"string"==typeof V?void(R[P]=(0,dt.t)(V,v)):void(R[P]=V.write({},v));const tt=function gt(p){return(0,T.Wi)(p)?null:"string"==typeof p?p:p.url}(V),Z=tt?(0,dt.t)(tt,vt(Q({},v),{verifyItemRelativeUrls:v&&v.verifyItemRelativeUrls?{writtenUrls:v.verifyItemRelativeUrls.writtenUrls,rootPath:null}:null}),dt.M.NO):null,pt=L.type!==String&&(!(0,it.l)(this)||v&&v.origin&&this.originIdOf(f)>(0,nt.M9)(v.origin));v&&v.portalItem&&(0,T.pC)(Z)&&!(0,F.YP)(Z)?pt?function Tt(p,_,f,L,V,R,P,v){const tt=P.portalItem.resourceFromPath(L),Z=h(f,L,P);rt(Z)===(0,F.Ml)(tt.path)?(b(p,_,tt,Z,P.resources.toUpdate),V[R]=L):k(p,_,f,L,V,R,P,v)}(this,f,V,Z,R,P,v,p):function It(p,_,f,L){L.resources.toKeep.push({resource:L.portalItem.resourceFromPath(p)}),_[f]=p}(Z,R,P,v):v&&v.portalItem&&((0,T.Wi)(Z)||(0,T.pC)((0,dt.i)(Z))||(0,F.jc)(Z)||pt)?k(this,f,V,Z,R,P,v,p):R[P]=Z}}}}(p,_,f);switch((0,T.pC)(p)&&p.type?p.type:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:L,write:V}=dt.p;return{read:L,write:V}}}}(p,f,L);for(const R of _){const P=(0,ot.CJ)(f,R,L);for(const v in V)P[v]=V[v]}}}function k(p,_,f,L,V,R,P,v){const tt=(0,o.D)(),Z=h(f,L,P),pt=(0,F.v_)((0,T.U2)(v,"prefix"),tt),Et=`${pt}.${rt(Z)}`,z=P.portalItem.resourceFromPath(Et);(0,F.jc)(L)&&P.resources.pendingOperations.push(function wt(p){return q.apply(this,arguments)}(L).then(lt=>{z.path=`${pt}.${rt(lt)}`,V[R]=z.itemRelativeUrl}).catch(()=>{})),b(p,_,z,Z,P.resources.toAdd),V[R]=z.itemRelativeUrl}function b(p,_,f,L,V){V.push({resource:f,content:L,finish:R=>{!function Y(p,_,f){"string"==typeof p[_]?p[_]=f.url:p[_].url=f.url}(p,_,R)}})}function h(p,_,f){return"string"==typeof p?{url:_}:new Blob([JSON.stringify(p.toJSON(f))],{type:"application/json"})}function q(){return(q=(0,n.Z)(function*(p){const _=(yield Promise.resolve().then(s.bind(s,84792))).default,{data:f}=yield _(p,{responseType:"blob"});return f})).apply(this,arguments)}},22558:(x,w,s)=>{function n(T){return T&&"getAtOrigin"in T&&"originOf"in T}s.d(w,{l:()=>n})},1437:(x,w,s)=>{s.d(w,{p:()=>E});var n=s(17626),T=s(54024),it=s(62208),F=s(60330),o=s(77712),rt=(s(85931),s(8314),s(90912),s(76898));const E=C=>{let M=class extends((0,F.v)(C)){constructor(){super(...arguments),this.parent=null,this._userInteractive=!1,this._interactiveViewModelCount=0}get interactive(){return this._interactiveViewModelCount>0||this._userInteractive}set interactive(u){this._userInteractive=u}get updating(){return!1}get visible(){return!(0,it.pC)(this.parent)||this.parent.visible&&!this.parent.suspended}set visible(u){void 0!==u?this._override("visible",u):this._clearOverride("visible")}forceInteractiveForViewModel(){return this._interactiveViewModelCount++,(0,T.kB)(()=>this._interactiveViewModelCount--)}};return(0,n._)([(0,o.Cb)({readOnly:!0})],M.prototype,"type",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],M.prototype,"analysis",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],M.prototype,"parent",void 0),(0,n._)([(0,o.Cb)({constructOnly:!0})],M.prototype,"view",void 0),(0,n._)([(0,o.Cb)({type:Boolean})],M.prototype,"interactive",null),(0,n._)([(0,o.Cb)()],M.prototype,"_userInteractive",void 0),(0,n._)([(0,o.Cb)({readOnly:!0})],M.prototype,"updating",null),(0,n._)([(0,o.Cb)()],M.prototype,"visible",null),(0,n._)([(0,o.Cb)()],M.prototype,"_interactiveViewModelCount",void 0),M=(0,n._)([(0,rt.j)("esri.views.3d.analysis.AnalysisView3D")],M),M}},99024:(x,w,s)=>{s.r(w),s.d(w,{default:()=>ye});var n=s(17626),T=s(14517),it=s(46160),F=s(61885),o=s(62208),r=s(77712),nt=s(85931),E=(s(8314),s(90912),s(76898)),C=s(28093),M=s(1437),u=s(91558);let B=class extends T.Z{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new u.Z([3,252,111,1]),this.visibleOuterColor=new u.Z([3,252,111,.15]),this.occludedInnerColor=new u.Z([252,3,69,1]),this.occludedOuterColor=new u.Z([252,3,69,.1]),this.undefinedInnerColor=new u.Z([255,255,255,1]),this.undefinedOuterColor=new u.Z([127,127,127,.2])}};(0,n._)([(0,r.Cb)({type:Number})],B.prototype,"innerWidth",void 0),(0,n._)([(0,r.Cb)({type:Number})],B.prototype,"outerWidth",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],B.prototype,"visibleInnerColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],B.prototype,"visibleOuterColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],B.prototype,"occludedInnerColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],B.prototype,"occludedOuterColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],B.prototype,"undefinedInnerColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],B.prototype,"undefinedOuterColor",void 0),B=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],B);var ft=s(15861),_t=(s(29132),s(8425)),st=s(72392),at=s(54024),k=s(58817),Tt=s(63290),It=s(10699),b=s(32917),h=s(84161),wt=s(17760),q=s(55915),gt=s(65401),Y=s(70562),p=s(60507);let _=class extends T.Z{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,n._)([(0,r.Cb)()],_.prototype,"target",void 0),(0,n._)([(0,r.Cb)()],_.prototype,"intersectedGraphic",void 0),(0,n._)([(0,r.Cb)()],_.prototype,"intersectedLocation",void 0),(0,n._)([(0,r.Cb)()],_.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,r.Cb)({type:Boolean})],_.prototype,"visible",void 0),_=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],_);let f=class extends T.Z{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,C.c)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,C.c)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,C.c)(),targetAdjusted:(0,C.c)()},this.computationResult={start:(0,C.c)(),end:(0,C.c)(),intersection:(0,C.c)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,n._)([(0,r.Cb)()],f.prototype,"target",void 0),(0,n._)([(0,r.Cb)()],f.prototype,"elevationAlignedTargetLocation",void 0),(0,n._)([(0,r.Cb)()],f.prototype,"inputPoints",void 0),(0,n._)([(0,r.Cb)()],f.prototype,"computationResult",void 0),(0,n._)([(0,r.Cb)()],f.prototype,"result",void 0),f=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],f);var P,L=s(23841),V=s(26242),R=s(38114);let v=P=class extends T.Z{constructor(t){super(t)}clone(){return new P({type:this.type,id:(0,k.d9)(this.id),point:(0,k.d9)(this.point),normal:(0,k.d9)(this.normal),ray:(0,k.d9)(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&(0,o._W)(this.point,t.point)&&(0,nt.fS)(this.normal,t.normal)&&(0,Y.fS)(this.ray,t.ray)&&this.graphic===t.graphic}};(0,n._)([(0,r.Cb)()],v.prototype,"type",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],v.prototype,"id",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],v.prototype,"point",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],v.prototype,"normal",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],v.prototype,"graphic",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],v.prototype,"ray",void 0),v=P=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],v);var tt=s(77926),Z=s(26046),pt=s(90793),Et=s(62483),z=s(67857),lt=s(55314);let yt=class extends T.Z{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=(0,Et.Z8)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=z.eC.MIN}getScreenPointIntersection(t){const e=(0,L.md)(t,V.qW.get()),i=(0,Z.u4)(this.view.state.camera,e,Rt);return this._getRayIntersection(i)}_getRayIntersection(t,e){if((0,o.Wi)(t)||(0,o.Wi)(this.view.sceneIntersectionHelper))return null;this.intersector.options.store=z.eC.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this.intersector,e);const i=this.intersector.results.min;if(!i.getIntersectionPoint(Vt))return null;const a=this.view.renderCoordsHelper.fromRenderCoords(Vt,this.view.spatialReference),c=(0,C.d)(i.normal);if((0,tt.G)(i))return new v({type:z.q7.OBJECT,id:`${i.target.layerUid}/${i.target.nodeIndex}/${i.target.componentIndex}`,point:a,normal:c,ray:(0,Y.JG)(t),graphic:null});if((0,pt.T)(i))return new v({type:z.q7.TERRAIN,id:i.target.lij.slice(),point:a,normal:c,ray:(0,Y.JG)(t),graphic:null});const l=(0,lt.tB)(i,this.view);if((0,o.pC)(l)){const d=l.layer,O=l.sourceLayer;let g;return g=O&&"scene"===O.type?(0,R.MS)(l,O.objectIdField):l.uid,new v({type:z.q7.OBJECT,id:`${d.uid}/${g}`,point:a,normal:c,ray:(0,Y.JG)(t),graphic:l})}return null}updateFromGroundIntersection(t,e,i){const a=Vt,c=Jt,l=Qt,d=kt,O=qt;(0,h.c)(c,t),this.view.renderCoordsHelper.worldUpAtPosition(c,l),(0,h.n)(l,l);const g=this.view.basemapTerrain.elevationBounds,m=this.view.renderCoordsHelper.getAltitude(c),y=g?Math.abs(g.max-g.min):100,S=m>0?1:-1;(0,h.g)(d,l,S*(y+Math.abs(e))),(0,h.a)(a,c,d),(0,Y.zk)(a,c,Rt);const I=this._getRayIntersection(Rt,{include:this._terrainIntersectionOptionsLayerUids});return(0,o.pC)(I)&&(0,o.pC)(I.point)?(this.view.renderCoordsHelper.toRenderCoords(I.point,O),(0,h.g)(d,l,S*e),(0,h.a)(i,O,d),(0,C.a)(I.normal)):((0,h.c)(i,t),null)}};(0,n._)([(0,r.Cb)()],yt.prototype,"view",void 0),(0,n._)([(0,r.Cb)()],yt.prototype,"intersector",void 0),yt=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],yt);const Vt=(0,C.c)(),Jt=(0,C.c)(),Qt=(0,C.c)(),kt=(0,C.c)(),qt=(0,C.c)(),Rt=(0,Y.Ue)();var Zt=s(54865),Ct=s(87091),te=s(49672);const jt=Tt.Z.getLogger("esri.views.3d.analysis.LineOfSight.LineOfSightController");let D=class extends(F.Z.EventedMixin(T.Z)){constructor(t){super(t),this.updateOnCameraChange=!0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new wt.t,this._frameTask=Ct.sq,this._handles=new st.Z,this._computationHandles=new st.Z,this._externalObserverUpdate=!0}initialize(){var e;const t=null==(e=this.view.resourceController)?void 0:e.scheduler;this._frameTask=t?t.registerTask(Ct.T8.LINE_OF_SIGHT_TOOL):Ct.sq,this._intersector=new yt({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}getLineOfSightComputationDependencies(t){const{inputPoints:e}=t;return{inputPoints:e}}_computeResult(t){const e=t.computation,{inputPoints:i,computationResult:a}=e,{observerAdjusted:c,targetAdjusted:l}=i,{start:d,end:O}=a;(0,h.c)(d,c),(0,h.c)(O,l),this._canCompute(e)?this._computeIntersection(t):this._interpolateIntersection(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_updateAdjustedPointsFromFeatures(t){const e=this.view,{sceneIntersectionHelper:i}=e,{inputPoints:a}=t,{observerAdjusted:c,observerFeatureId:l,targetFeatureId:d,targetAdjusted:O}=a;if((0,o.Wi)(l)&&(0,o.Wi)(d))return;const g=(0,h.i)(c,O),m=this._intersector.intersector,y=(0,Y.zk)(a.observer,a.target,Wt);m.options.store=z.eC.ALL,i.intersectToolIntersectorRay(y,m);let S=null,I=null,G=null,H=null;for(const U of m.results.all){const A=(0,lt.tB)(U,this.view);if((0,o.Wi)(A)||(0,o.Wi)(U.distanceInRenderSpace))continue;const K=(0,_t.pD)(A);(0,o.Wi)(K)||((0,o.pC)(l)&&K===l&&((0,o.Wi)(S)&&(S=this._getFeatureDistanceThreshold(U,e,g)),U.distanceInRenderSpace<S&&(G=U)),(0,o.pC)(d)&&K===d&&((0,o.Wi)(I)&&(I=this._getFeatureDistanceThreshold(U,e,g)),(0,o.Wi)(H)&&U.distanceInRenderSpace<g&&g-U.distanceInRenderSpace<I&&(H=U)))}(0,o.pC)(G)&&G.getIntersectionPoint(c)&&(a.observerSurfaceNormal=G.getTransformedNormal((0,C.c)())),(0,o.pC)(H)&&H.getIntersectionPoint(O)&&(a.targetSurfaceNormal=H.getTransformedNormal((0,C.c)()))}_getFeatureDistanceThreshold(t,e,i){if((0,lt._s)(t)){const a=(0,lt.VB)(t,e);if((0,o.pC)(a))return Math.min(a*ie,i)}return 1e-5*i}_adjustStartEndPositions(t){const e=this._screenPixelSize,i=this.view,{inputPoints:a}=t,{observer:c,observerSurfaceNormal:l,target:d,targetSurfaceNormal:O,observerAdjusted:g,targetAdjusted:m}=a,y=St;(0,h.c)(g,c),(0,h.c)(m,d),this._updateAdjustedPointsFromFeatures(t),(0,o.pC)(l)?(0,h.c)(y,l):(0,h.b)(y,m,g);const S=e;(0,h.n)(y,y),(0,h.g)(y,y,Math.min(S,1)),(0,h.a)(g,g,y),(0,o.pC)(O)?(0,h.c)(y,O):(0,h.b)(y,g,m);const I=i.state.camera.computeScreenPixelSizeAt(m);(0,h.n)(y,y),(0,h.g)(y,y,Math.min(I,1)),(0,h.a)(m,m,y)}_computeIntersection({computation:t,interpolationInfo:e}){const{view:i}=this,{sceneIntersectionHelper:a,renderCoordsHelper:c}=i;if((0,o.Wi)(a))return;const l=this._intersector.intersector,{computationResult:d,inputPoints:O}=t,{observer:g,target:m}=O,{start:y,end:S}=d,I=(0,Y.zk)(y,S,Wt);l.options.store=z.eC.MIN,a.intersectToolIntersectorRay(I,l);const G=l.results.min,H=d.intersection,U=St;let A=!0;if((0,o.pC)(G)&&G.getIntersectionPoint(H)){(0,h.c)(e.originalIntersection,H),(0,h.c)(e.originalObserver,y),(0,h.c)(e.originalTarget,S),c.fromRenderCoords(H,U,i.spatialReference);const N=1-(0,h.j)(S,m)/(0,h.j)(y,m);A=(0,h.j)(g,H)>=N*(0,h.j)(g,m)}const K=new te.Z(U,i.spatialReference);{const{result:N,target:et}=t;(0,o.pC)(N)?(N.target=et,N.intersectedGraphic=A?null:(0,lt.tB)(G,i),N.intersectedLocation=A?null:K,N.visible=A):t.result=new _({target:et,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:A?null:(0,lt.tB)(G,i),intersectedLocation:A?null:K,visible:A})}d.isValid=O.isValid=!0,d.isTargetVisible=A}_interpolateIntersection({computation:t,interpolationInfo:e}){const{computationResult:i,inputPoints:a}=t,{start:c,end:l,intersection:d}=i,{originalIntersection:O,originalObserver:g,originalTarget:m}=e;if((0,h.c)(d,O),a.isValid){const y=St,S=(0,h.j)(g,O)/(0,h.j)(g,m);(0,h.v)(y,c,g),(0,h.g)(y,y,1-S),(0,h.a)(d,d,y),(0,h.v)(y,l,m),(0,h.g)(y,y,S),(0,h.a)(d,d,y),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}_canCompute(t){const i=this.view.frustum;if((0,o.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,o.Wi)(t.elevationAlignedTargetLocation)||(0,o.Wi)(i))return!1;const{observerAdjusted:a,targetAdjusted:c}=t.inputPoints,l=i.intersectsPoint(a),d=i.intersectsPoint(c);return l&&d}_onObserverPositionChange(t,e,i,a,c){if(this._externalObserverUpdate=c,(0,o.Wi)(t))return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if((0,o.Wi)(e))return(0,Zt.e)(this.analysis,t.spatialReference,jt),void(this.analysisViewData.elevationAlignedObserver=null);const l=this._getEffectiveElevationInfo(e,i),{absoluteZ:d,elevation:O}=(0,p.tq)(e.x,e.y,e.z,this.view.spatialReference,this.view,l),g=e.clone();g.z=d,this._effectiveObserverElevationMode=l.mode,this.analysisViewData.elevationAlignedObserver=g;const m=(0,C.c)();this.view.renderCoordsHelper.toRenderCoords(g,m),this._elevationAlignedObserverPositionRenderSpace=m,this._observerGroundOffsetRenderSpace=d-O,this._observerFeatureId=(0,_t.pD)(a),this.priority=Ct.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,a,c){const{inputPoints:l}=t;switch((0,h.c)(l.observer,e),l.observerFeatureId=c,l.observerSurfaceNormal=null,a){case"on-the-ground":case"relative-to-ground":{const d=this._intersector.updateFromGroundIntersection(l.observer,i,l.observer);(0,o.Wi)(l.observerFeatureId)&&(l.observerSurfaceNormal=d)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=Ct.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,a,c,l=!0){const d=t.inputPoints;if(l&&(d.isValid=!1),(0,o.Wi)(i))return(0,o.pC)(e)&&(0,Zt.e)(this.analysis,e.spatialReference,jt),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();const O=this._getEffectiveElevationInfo(i,a),{absoluteZ:g,elevation:m}=(0,p.tq)(i.x,i.y,i.z,this.view.spatialReference,this.view,O),y=i.clone();switch(y.z=g,t.elevationAlignedTargetLocation=y,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,d.target),d.targetFeatureId=(0,_t.pD)(c),d.targetSurfaceNormal=null,O.mode){case"on-the-ground":case"relative-to-ground":{const S=this._intersector.updateFromGroundIntersection(d.target,g-m,d.target);(0,o.Wi)(d.targetFeatureId)&&(d.targetSurfaceNormal=S)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=Ct.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return(0,at.AL)([(0,b.YP)(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:(0,q.dz)(t.target.position,this.view.spatialReference)}),({computation:e,targetPosition:i,targetElevationInfo:a,targetFeatureInfo:c,projectedTargetPosition:l})=>{(0,o.pC)(l.pending)?this._updatingHandles.addPromise(l.pending):this._onTargetPositionChange(e,i,l.geometry,a,c)},b.tX)])}_connectComputationToObserver(t){return(0,b.YP)(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())},b.tX)}_connectComputationToRenderSpaceObserver(t){return(0,b.YP)(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:e,observer:i,observerGroundOffset:a,observerElevationMode:c,observerFeatureId:l})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,a,c,l)},b.tX)}_connectComputationToCamera(t){return(0,b.YP)(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()},b.Z_)}_connectComputationToSlicePlane(t){return(0,b.YP)(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){const e=(i,a)=>{const c=this.analysis.observer,l=t.target;let d=null,O=null,g=null,m=null,y=null,S=null;if((0,o.pC)(c)&&(0,o.pC)(c.position)){const I=(0,q.dz)(c.position,this.view.spatialReference);if((0,o.pC)(I.pending))return this._updatingHandles.addPromise(I.pending),void I.pending.finally(()=>e(i,a));d=I.geometry,O=c.elevationInfo,g=c.feature}if((0,o.pC)(l.position)){const I=(0,q.dz)(l.position,this.view.spatialReference);if((0,o.pC)(I.pending))return this._updatingHandles.addPromise(I.pending),void I.pending.finally(()=>e(i,a));m=I.geometry,y=l.elevationInfo,S=l.feature}(0,o.Wi)(d)&&(0,o.Wi)(m)||((0,q.dH)(i,a,Lt,this.view.spatialReference),(0,o.pC)(d)&&(0,gt.Qn)(Lt,d)&&this._onObserverPositionChange((0,o.pC)(c)?c.position:null,d,O,g,!1),(0,o.pC)(m)&&(0,gt.Qn)(Lt,m)&&this._onTargetPositionChange(t,l.position,m,y,S,!1),(0,o.pC)(d)&&(0,o.pC)(m)&&(0,gt.I7)(Lt,d,m)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",i=>e(i.extent,i.spatialReference))}_connectComputationToTask(t){var e=this;let i=o.YP;const a={computation:t,interpolationInfo:{originalIntersection:(0,C.c)(),originalObserver:(0,C.c)(),originalTarget:(0,C.c)()}};return(0,at.AL)([(0,b.YP)(()=>this.getLineOfSightComputationDependencies(t),()=>{i=(0,o.IM)(i),i=(0,It.vr)(function(){var c=(0,ft.Z)(function*(l){yield(0,It.R8)(e._frameTask.schedule(()=>e._computeResult(a),l))});return function(l){return c.apply(this,arguments)}}())},{sync:!0,initial:!0,equals:k.fS}),(0,at.kB)(()=>i=(0,o.IM)(i))])}_connectComputation(t){const e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(const i of e)this._removeTarget(i);for(const i of t)this._addTarget(i)}_onCursorTargetChange(t,e){(0,o.pC)(e)&&this._removeTarget(e),(0,o.pC)(t)&&this._addTarget(t)}_addTarget(t){this._computations.some(e=>e.target===t)||this._computations.add(new f({target:t}))}_removeTarget(t){const e=this._computations.findIndex(i=>i.target===t);this._computations.removeAt(e)}_connectObserver(){return(0,at.AL)([(0,b.YP)(()=>({observerPosition:(0,o.pC)(this.analysis.observer)?this.analysis.observer.position:null,projectedObserverPosition:(0,q.dz)((0,o.pC)(this.analysis.observer)?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:(0,o.pC)(this.analysis.observer)?this.analysis.observer.elevationInfo:null,observerFeatureInfo:(0,o.pC)(this.analysis.observer)?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:a})=>{(0,o.pC)(e.pending)?this._updatingHandles.addPromise(e.pending):this._onObserverPositionChange(t,e.geometry,i,a,!0)},b.tX)])}_connectComputations(){return(0,b.on)(()=>this._computations,"change",t=>this._onComputationCollectionChange(t),{onListenerAdd:t=>{for(const e of t)this._connectComputation(e)},onListenerRemove:t=>{for(const e of t)this._disconnectComputation(e)},sync:!0})}_connectTargets(){return(0,at.AL)([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),(0,b.YP)(()=>this.analysisViewData.cursorTarget,(t,e)=>{this._onCursorTargetChange(t,e)})])}get _isCameraDirty(){const t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if((0,o.Wi)(t)||(0,o.Wi)(i))return!1;const a=St;i.toRenderCoords(t,a);const c=e.state.camera.computeScreenPixelSizeAt(a);return Math.abs((c-this._screenPixelSize)/this._screenPixelSize)>ee}_getEffectiveElevationInfo(t,e){return t.hasZ?(0,o.Pt)(e,{mode:"absolute-height",offset:0}):{mode:"on-the-ground",offset:0}}};(0,n._)([(0,r.Cb)({constructOnly:!0})],D.prototype,"analysis",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],D.prototype,"analysisViewData",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],D.prototype,"view",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"updating",null),(0,n._)([(0,r.Cb)()],D.prototype,"priority",null),(0,n._)([(0,r.Cb)()],D.prototype,"updateOnCameraChange",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"_computations",null),(0,n._)([(0,r.Cb)()],D.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,n._)([(0,r.Cb)()],D.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"_effectiveObserverElevationMode",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"_observerFeatureId",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"_screenPixelSize",null),(0,n._)([(0,r.Cb)({readOnly:!0})],D.prototype,"_updatingHandles",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"_frameTask",void 0),(0,n._)([(0,r.Cb)()],D.prototype,"_isCameraDirty",null),D=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightController")],D);const ee=.1,St=(0,C.c)(),Wt=(0,Y.Ue)(),Lt=(0,gt.cS)(),ie=.05;var zt=s(61642),At=s(57574),Ut=s(13777),xt=s(82706);let X=class extends T.Z{constructor(t){super(t),this.enabled=!0,this.glowColor=new u.Z([255,127,0]),this.glowWidth=8,this.innerColor=new u.Z([255,255,255]),this.innerWidth=.75,this.globalAlpha=.75}};(0,n._)([(0,r.Cb)({type:Boolean})],X.prototype,"enabled",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],X.prototype,"glowColor",void 0),(0,n._)([(0,r.Cb)({type:Number})],X.prototype,"glowWidth",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],X.prototype,"innerColor",void 0),(0,n._)([(0,r.Cb)({type:Number})],X.prototype,"innerWidth",void 0),(0,n._)([(0,r.Cb)({type:Number})],X.prototype,"globalAlpha",void 0),X=(0,n._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],X);let mt=class extends T.Z{constructor(t){super(t),this.size=.5,this.color=new u.Z([255,127,0,.75])}};(0,n._)([(0,r.Cb)({type:Number})],mt.prototype,"size",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],mt.prototype,"color",void 0),mt=(0,n._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],mt);let ct=class extends T.Z{constructor(t){super(t),this.size=.5,this.visibleColor=new u.Z([3,252,111,.75]),this.occludedColor=new u.Z([252,3,69,.75]),this.undefinedColor=new u.Z([127,127,127,.75])}};(0,n._)([(0,r.Cb)({type:Number})],ct.prototype,"size",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],ct.prototype,"visibleColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],ct.prototype,"occludedColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],ct.prototype,"undefinedColor",void 0),ct=(0,n._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],ct);class $ extends T.Z{constructor(e){super(e),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new u.Z([3,252,111,1]),this.visibleOuterColor=new u.Z([3,252,111,.15]),this.occludedInnerColor=new u.Z([252,3,69,1]),this.occludedOuterColor=new u.Z([252,3,69,.1]),this.undefinedInnerColor=new u.Z([255,255,255,1]),this.undefinedOuterColor=new u.Z([127,127,127,.2])}}(0,n._)([(0,r.Cb)({type:Number})],$.prototype,"innerWidth",void 0),(0,n._)([(0,r.Cb)({type:Number})],$.prototype,"outerWidth",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],$.prototype,"visibleInnerColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],$.prototype,"visibleOuterColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],$.prototype,"occludedInnerColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],$.prototype,"occludedOuterColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],$.prototype,"undefinedInnerColor",void 0),(0,n._)([(0,r.Cb)({type:u.Z})],$.prototype,"undefinedOuterColor",void 0);let ut=class extends T.Z{constructor(t){super(t),this.laserLine=new X,this.observer=new mt,this.target=new ct,this.lineOfSight=new $}};(0,n._)([(0,r.Cb)({type:X})],ut.prototype,"laserLine",void 0),(0,n._)([(0,r.Cb)({type:mt})],ut.prototype,"observer",void 0),(0,n._)([(0,r.Cb)({type:ct})],ut.prototype,"target",void 0),(0,n._)([(0,r.Cb)({type:$})],ut.prototype,"lineOfSight",void 0),ut=(0,n._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],ut);var ne=s(45403),oe=s(19142),re=s(95277),se=s(57521),bt=s(33786);function Pt(t,e,i){return{geometry:se.Z.createSphereGeometry(t,32,32),material:(0,oe.EA)(u.Z.toUnitRGBA(e)),stateMask:i}}function Ht(t){const e=[];return t.customColor1&&e.push(Pt(t.size,t.customColor1,bt.jg.Custom1)),t.customColor2&&e.push(Pt(t.size,t.customColor2,bt.jg.Custom2)),t.customColor3&&e.push(Pt(t.size,t.customColor3,bt.jg.Custom3)),t.color&&e.push(Pt(t.size,t.color)),e}var ht,t,le=s(23018),ce=(s(45458),s(22712)),Ft=s(75079),Bt=s(41900),Mt=s(85112);(t=ht||(ht={})).Ready="ready",t.Creating="creating",t.Created="created",it.Z.ofType(At.Z);const Gt=Tt.Z.getLogger("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool");let j=class extends ce.f{constructor(t){super(t),this.preferManipulatorCursor=!0,this.removeIncompleteOnCancel=!1,this.configuration=new ut,this.analysisViewData=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new st.Z,this._handles=new st.Z,this._manipulatorHandles=new st.Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new yt({view:this.view}),this._handles.add((0,b.YP)(()=>this.state,t=>{t===ht.Created&&this.finishToolCreation()},b.tX)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([(0,b.YP)(()=>Q({},this.configuration.observer),()=>this._updateObserverManipulatorStyle(),b.Z_),(0,b.YP)(()=>this.analysisViewData.elevationAlignedObserver,t=>this._onObserverLocationChange(t),b.tX),(0,b.YP)(()=>Q({},this.configuration.laserLine),()=>this._createVisualElements(),b.tX),(0,b.YP)(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations()])}destroy(){this._handles=(0,o.SC)(this._handles),this._manipulatorHandles=(0,o.SC)(this._manipulatorHandles),this._analysisHandles=(0,o.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?(0,o.pC)(this._grabbedManipulator)?ht.Created:ht.Creating:(0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)?ht.Created:ht.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return!!(0,o.pC)(this.analysisViewData)&&this.analysisViewData.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&(0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)&&!this.hasFocusedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){"immediate-click"===t.type&&this._clickHandler(t)}onShow(){}onHide(){this._grabbedManipulator=null}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return(0,b.on)(()=>this.analysisViewData.computations,"change",t=>this._onComputationsCollectionChange(t),{onListenerAdd:t=>{for(const e of t)this._connectComputation(e)},onListenerRemove:t=>{for(const e of t)this._disconnectComputation(e)},sync:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void Gt.warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const e=this._analysisHandles;if(e.has(t))return;const i=this._createTargetManipulator(t.target);(0,o.Wi)(this._targetTrackerManipulator)&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([(0,b.YP)(()=>this._getLineOfSightManipulatorStateDependencies(t),()=>this._updateManipulatorState(i,t),b.tX),(0,b.YP)(()=>t.elevationAlignedTargetLocation,a=>this._onTargetLocationChange(a,i),b.tX)],t)}_disconnectComputation(t){if(this.destroyed)return void Gt.warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);const e=this._getTargetManipulator(t.target);(0,o.pC)(e)&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),(0,o.pC)(this._targetTrackerManipulator)&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,o.SC)(this.analysisViewData.cursorTarget)}_createManipulator(t,e,i){const a=function ae(t,e){const i=Ht(e),a=new ne.Z({view:t,renderObjects:i,elevationInfo:{mode:"absolute-height",offset:0}});return(0,re.t)(a),a}(this.view,t);return a.metadata=i,this._manipulatorHandles.add([e(a),a.events.on("grab-changed",c=>this._manipulatorGrabChanged(a,c)),a.events.on("immediate-click",c=>this._manipulatorClick(a,c))],a),this.manipulators.add(a),a}_createTargetManipulator(t){const e=this.configuration,c=this._createManipulator({size:e.target.size,customColor1:e.target.visibleColor,customColor2:e.target.occludedColor,customColor3:e.target.undefinedColor,visible:!0},l=>this._createTargetManipulatorDragPipeline(l),{target:t,type:"target"});return(0,o.pC)(t.position)?c.elevationAlignedLocation=t.position:c.available=!1,c}_getTargetManipulator(t){let e=null;return this.manipulators.forEach(i=>{const a=i.manipulator;(0,o.Wi)(e)&&"target"===a.metadata.type&&a.metadata.target===t&&(e=a)}),e}_createObserverManipulator(){const t=this.configuration;return this._createManipulator({size:t.observer.size,color:t.observer.color,visible:!0},i=>this._createObserverManipulatorDragPipeline(i),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const t=this._observerManipulator,e=this.configuration.observer;t.renderObjects=Ht({size:e.size,color:e.color,visible:t.available})}_screenToIntersection(){return t=>{const e=this._intersector.getScreenPointIntersection(t.screenEnd);return(0,o.Wi)(e)?null:vt(Q({},t),{intersection:e})}}_createTargetManipulatorDragPipeline(t){return(0,Ft.Xd)(t,(e,i,a)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),a.next(this._cancelTargetDragStep(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return(0,Ft.Xd)(t,(e,i,a)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),a.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>((0,o.pC)(t.intersection.point)?((0,o.Wi)(this.analysis.observer)&&(this.analysis.observer=new zt.Z),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){const t=(0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);const i=e.intersection.point;return(0,o.pC)(i)&&(t.elevationAlignedLocation=i),e}}_cancelTargetDragStep(t){const e=(0,o.yw)(t.position,i=>i.clone());return i=>(t.position=e,i)}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_updateManipulatorState(t,e){const{isValid:i,isTargetVisible:a}=e.computationResult;t.state=i?a?bt.jg.Custom1:bt.jg.Custom2:bt.jg.Custom3}_getLineOfSightManipulatorStateDependencies(t){const{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:(0,o.pC)(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){const{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:a,observerPosition:c,visible:l}=t;if((0,o.Wi)(e))return;const d=(0,o.pC)(i)?i:a&&(0,o.pC)(c)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&(0,o.pC)(d)&&l?(e.visible=!0,e.heightManifoldTarget=d.renderLocation,e.lineVerticalPlaneSegment=d!==this._observerManipulator?(0,Ut.zk)(this._observerManipulator.renderLocation,d.renderLocation,ue):null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createVisualElements(){const t=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new le.W({view:this.view,attached:!0,visible:this.visible,style:{glowColor:u.Z.toUnitRGB(t.glowColor),glowWidth:t.glowWidth,innerColor:u.Z.toUnitRGB(t.innerColor),innerWidth:t.innerWidth,globalAlpha:t.globalAlpha}})}_removeVisualElements(){(0,o.pC)(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(t){(0,o.Wi)(t)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t)}_onTargetLocationChange(t,e){(0,o.pC)(t)?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){const e=this._intersector.getScreenPointIntersection(t);if(!(0,o.Wi)(e)&&!(0,o.Wi)(e.point))if((0,o.pC)(this.analysis.observer)&&(0,o.pC)(this.analysis.observer.position)){this._clearCursorTracker();const i=new At.Z;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{const i=new zt.Z;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==Mt.t.Right&&(this._addPointFromClickEvent((0,Bt.vT)(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==Mt.t.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&"Escape"===t.key&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasFocusedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||(0,o.Wi)(this.analysis.observer)||(0,o.Wi)(this.analysis.observer.position)))return;const e=(0,Bt.vT)(t),i=this._intersector.getScreenPointIntersection(e);(0,o.pC)(i)&&(0,o.pC)(i.point)&&((0,o.Wi)(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new At.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if((0,o.Wi)(e.point))return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.type){case z.q7.OBJECT:if((0,o.pC)(e.graphic)){const a=e.graphic,c=(0,p.RL)(a);"on-the-ground"===c.mode&&(c.mode="relative-to-ground",c.offset=0),t.elevationInfo=new xt.ZP(c),t.feature=a}else t.elevationInfo=null,t.feature=null;break;case z.q7.TERRAIN:case z.q7.I3S:t.elevationInfo=new xt.ZP({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}const i=e.point.clone();i.z=(0,p.vQ)(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if("observer"===t.metadata.type||t.grabbing||t.dragging||e.button!==Mt.t.Right||this.analysis.targets.length<=1)return;const{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement}}};(0,n._)([(0,r.Cb)({constructOnly:!0})],j.prototype,"view",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],j.prototype,"analysis",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],j.prototype,"state",null),(0,n._)([(0,r.Cb)({readOnly:!0})],j.prototype,"cursor",null),(0,n._)([(0,r.Cb)({readOnly:!0})],j.prototype,"preferManipulatorCursor",void 0),(0,n._)([(0,r.Cb)()],j.prototype,"removeIncompleteOnCancel",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],j.prototype,"updating",null),(0,n._)([(0,r.Cb)({type:ut})],j.prototype,"configuration",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],j.prototype,"analysisViewData",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],j.prototype,"_showTracker",null),(0,n._)([(0,r.Cb)()],j.prototype,"_latestPointerMovePointerType",void 0),(0,n._)([(0,r.Cb)()],j.prototype,"_shouldRenderTracker",null),(0,n._)([(0,r.Cb)()],j.prototype,"_laserlineVisualElement",void 0),(0,n._)([(0,r.Cb)()],j.prototype,"_grabbedManipulator",void 0),j=(0,n._)([(0,E.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],j);const ue=(0,Ut.Ue)();var de=s(43703),Dt=s(87469),Nt=s(30693);let J=class extends T.Z{constructor(t){super(t),this._lineOfSightVisualizations=[],this._computationHandles=new st.Z}initialize(){this.own(this._connectComputations()),this._createObserverVisualization()}destroy(){this._computationHandles=(0,o.SC)(this._computationHandles),this._observerVisualElement=(0,o.SC)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get testInfo(){return{visualizations:this._lineOfSightVisualizations}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const t=this._configuration,e=this.view,i={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth},a=u.Z.toUnitRGBA(t.visibleOuterColor),c=u.Z.toUnitRGBA(t.visibleInnerColor),l=u.Z.toUnitRGBA(t.occludedOuterColor),d=u.Z.toUnitRGBA(t.occludedInnerColor),O=u.Z.toUnitRGBA(t.undefinedOuterColor),g=u.Z.toUnitRGBA(t.undefinedInnerColor),m={visibleLineVisualElement:new Dt.r(vt(Q({},i),{color:a,innerColor:c})),occludedLineVisualElement:new Dt.r(vt(Q({},i),{color:l,innerColor:d})),undefinedLineVisualElement:new Dt.r(vt(Q({},i),{color:O,innerColor:g})),targetVisualElement:new Nt.L(vt(Q({view:e,attached:!0},Yt),{size:8}))};return this._lineOfSightVisualizations.push(m),m}_destroyLineOfSightVisualization(t){t.visibleLineVisualElement=(0,o.SC)(t.visibleLineVisualElement),t.occludedLineVisualElement=(0,o.SC)(t.occludedLineVisualElement),t.undefinedLineVisualElement=(0,o.SC)(t.undefinedLineVisualElement),t.targetVisualElement=(0,o.SC)(t.targetVisualElement),this._lineOfSightVisualizations.splice(this._lineOfSightVisualizations.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){const a=this._configuration,{computationResult:c,inputPoints:l}=t,{start:d,end:O,intersection:g,isValid:m,isTargetVisible:y}=c,{observer:S}=l,I=ge;I[12]=S[0],I[13]=S[1],I[14]=S[2];const G=(0,h.b)(pe,d,S),H=(0,h.b)(he,O,S),U=(0,h.b)(ve,g,S),{visibleLineVisualElement:A,occludedLineVisualElement:K,undefinedLineVisualElement:N,targetVisualElement:et}=e,Ce=(0,o.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,o.Wi)(t.elevationAlignedTargetLocation),Ot=this.visible&&!Ce;A.visible=Ot,K.visible=Ot,N.visible=Ot,et.visible=Ot,et.attached=!i.interactiveAndEditable,Ot&&(A.geometry=null,K.geometry=null,N.geometry=null,et.geometry=t.elevationAlignedTargetLocation,m?y?(A.geometry=[[(0,C.d)(G),(0,C.d)(H)]],A.transform=I,A.color=u.Z.toUnitRGBA(a.visibleOuterColor),et.color=u.Z.toUnitRGBA(a.visibleInnerColor)):(A.geometry=[[(0,C.d)(G),(0,C.d)(U)]],A.transform=I,A.color=u.Z.toUnitRGBA(a.occludedOuterColor),K.geometry=[[(0,C.d)(U),(0,C.d)(H)]],K.transform=I,et.color=u.Z.toUnitRGBA(a.occludedInnerColor)):(N.geometry=[[(0,C.d)(G),(0,C.d)(H)]],N.transform=I,et.color=u.Z.toUnitRGBA(a.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){const{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:a}=this._configuration;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:a,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){const e=this._computationHandles;if(e.has(t))return;const i=this._createLineOfSightVisualization();e.add([(0,b.YP)(()=>this._getLineOfSightVisualizationDependencies(t),a=>this._updateLineOfSightVisualization(t,i,a),{sync:!0,initial:!0,equals:k.fS}),(0,at.kB)(()=>this._destroyLineOfSightVisualization(i))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return(0,b.on)(()=>this.analysisViewData.computations,"change",t=>this._onComputationsCollectionChange(t),{sync:!0,onListenerAdd:t=>{for(const e of t)this._connectComputation(e)},onListenerRemove:t=>{for(const e of t)this._disconnectComputation(e)}})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_createObserverVisualization(){const t=u.Z.toUnitRGBA(this._configuration.visibleInnerColor),e=new Nt.L(Q({view:this.view,attached:!1,color:t},Yt));this._observerVisualElement=e,this.own((0,b.YP)(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:i,interactiveAndEditable:a,visible:c})=>{(0,o.Wi)(i)||a||!c?e.attached=!1:(e.geometry=i,this._observerVisualElement.attached=!0)},b.nn))}};(0,n._)([(0,r.Cb)({constructOnly:!0})],J.prototype,"analysis",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],J.prototype,"analysisViewData",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0})],J.prototype,"view",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],J.prototype,"visible",null),(0,n._)([(0,r.Cb)()],J.prototype,"interactiveAndEditable",null),(0,n._)([(0,r.Cb)()],J.prototype,"testInfo",null),(0,n._)([(0,r.Cb)()],J.prototype,"_configuration",null),J=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],J);const Yt={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},pe=(0,C.c)(),he=(0,C.c)(),ve=(0,C.c)(),ge=(0,de.c)();var Kt=s(95925);let W=class extends((0,M.p)(F.Z.EventedMixin(T.Z))){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new it.Z,this.elevationAlignedObserver=null,this.configuration=new B,this.observerEngineLocation=(0,C.c)(),this.cursorTarget=null,this.editable=!0}initialize(){const t=this.view,e=this.analysis;this._analysisController=new D({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new J({analysis:e,analysisViewData:this,view:t}),this.own([this._analysisController.on("result-changed",i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)}),(0,Kt.Lp)(this,j)])}destroy(){(0,Kt.Yq)(this),this._analysisController=(0,o.SC)(this._analysisController),this._analysisVisualization=(0,o.SC)(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return(0,o.pC)(this._analysisController)&&this._analysisController.updating}getResultForTarget(t){const e=this.computations.find(i=>i.target===t);return(0,o.yw)(e,i=>i.result)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}};(0,n._)([(0,r.Cb)({readOnly:!0})],W.prototype,"type",void 0),(0,n._)([(0,r.Cb)({constructOnly:!0,nonNullable:!0})],W.prototype,"analysis",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"tool",void 0),(0,n._)([(0,r.Cb)({readOnly:!0})],W.prototype,"results",null),(0,n._)([(0,r.Cb)()],W.prototype,"priority",null),(0,n._)([(0,r.Cb)()],W.prototype,"computations",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"elevationAlignedObserver",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"configuration",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"observerEngineLocation",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"cursorTarget",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"updating",null),(0,n._)([(0,r.Cb)()],W.prototype,"editable",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"_analysisController",void 0),(0,n._)([(0,r.Cb)()],W.prototype,"_analysisVisualization",void 0),W=(0,n._)([(0,E.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],W);const ye=W},54865:(x,w,s)=>{s.d(w,{G:()=>F,e:()=>o});var n=s(62208),T=s(55915),it=s(53929);function F(r,nt,ot,rt=!1){const E=(0,T.fM)(r,nt);return(0,n.Wi)(E)?null:(E.hasZ&&!rt||!(0,n.pC)(ot)||(E.z=(0,n.Pt)((0,it.KO)(ot,E),0)),E)}function o(r,nt,ot){ot.warnOnce(`Failed to project analysis geometry (id: '${r.id}'), projection from spatial reference (wkid: '${nt.wkid}') to view spatial reference is not supported. Projection may be possible after calling projection.load().`)}}}]);
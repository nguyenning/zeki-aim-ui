"use strict";var br=Object.defineProperty,Ir=Object.defineProperties,Tr=Object.getOwnPropertyDescriptors,Di=Object.getOwnPropertySymbols,Sr=Object.prototype.hasOwnProperty,wr=Object.prototype.propertyIsEnumerable,Oi=(q,O,I)=>O in q?br(q,O,{enumerable:!0,configurable:!0,writable:!0,value:I}):q[O]=I,bt=(q,O)=>{for(var I in O||(O={}))Sr.call(O,I)&&Oi(q,I,O[I]);if(Di)for(var I of Di(O))wr.call(O,I)&&Oi(q,I,O[I]);return q},Nt=(q,O)=>Ir(q,Tr(O));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[8460],{97938:(q,O,I)=>{I.d(O,{E:()=>C,V:()=>V});class C{constructor(W,k){this.x=W,this.y=k}clone(){return new C(this.x,this.y)}equals(W,k){return W===this.x&&k===this.y}isEqual(W){return W.x===this.x&&W.y===this.y}setCoords(W,k){this.x=W,this.y=k}normalize(){const W=this.x,k=this.y,N=Math.sqrt(W*W+k*k);this.x/=N,this.y/=N}rightPerpendicular(){const W=this.x;this.x=this.y,this.y=-W}move(W,k){this.x+=W,this.y+=k}assign(W){this.x=W.x,this.y=W.y}assignAdd(W,k){this.x=W.x+k.x,this.y=W.y+k.y}assignSub(W,k){this.x=W.x-k.x,this.y=W.y-k.y}rotate(W,k){const N=this.x,P=this.y;this.x=N*W-P*k,this.y=N*k+P*W}scale(W){this.x*=W,this.y*=W}length(){const W=this.x,k=this.y;return Math.sqrt(W*W+k*k)}static distance(W,k){const N=k.x-W.x,P=k.y-W.y;return Math.sqrt(N*N+P*P)}static add(W,k){return new C(W.x+k.x,W.y+k.y)}static sub(W,k){return new C(W.x-k.x,W.y-k.y)}}var V,j;(j=V||(V={}))[j.Unknown=0]="Unknown",j[j.Point=1]="Point",j[j.LineString=2]="LineString",j[j.Polygon=3]="Polygon"},28460:(q,O,I)=>{I.r(O),I.d(O,{default:()=>xr});var C=I(15861),V=I(17626),j=I(986),W=I(26584),N=(I(8314),I(63290)),P=I(62208),J=I(10699),ce=(I(90912),I(85931),I(82255),I(76898)),Xe=I(84682),Gi=I(65234),ue=I(99666),Ye=I(14517),Q=I(77712),tt=I(67831),je=I(71251);const fe=new Set,Jt=[],It=new Map,Qe=[0,0];let ut=class extends Ye.Z{constructor(l){super(l),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:l,process:r}=this;this._queue=new je.e({concurrency:l,process:(n,o)=>{const a=this._keyToItem.get(n);return r(a,{signal:o})},peeker:n=>n.values().next().value})}destroy(){this.clear(),this._queue.destroy(),this._queue=null}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(l){this._queue.abort("string"==typeof l?l:l.id)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(l){return this._keyToItem.has("string"==typeof l?l:l.id)}isOngoing(l){const r="string"==typeof l?l:l.id;return this.has(r)&&this._queue.isOngoing(r)}pause(){this._queue.pause()}push(l,r){const n=l.key.id+"-"+r;if(this.has(n))return this.get(n);const o=this._queue.push(n),a=()=>{this._keyToItem.delete(n),this.notifyChange("updating")};return this._keyToItem.set(n,l),o.then(a,a),this.notifyChange("updating"),o}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView;let n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;l.forEach(d=>{const _=this._keyToItem.get(d),m=this.tileInfoView.getTileScale(_.key);It.has(m)||(It.set(m,[]),n=Math.max(m,n),o=Math.min(m,o)),It.get(m).push(_.key),fe.add(m)});let a=this.state.scale;It.has(a)||(function Ki(l,r){l.length=0,r.forEach(n=>l.push(n))}(Jt,fe),Jt.sort((d,_)=>d-_),a=Jt.reduce((d,_)=>Math.abs(_-a)<Math.abs(d-a)?_:d,Jt[0])),a=Math.min(a,n),a=Math.max(a,o);const h=It.get(a),c=r.getClosestInfoForScale(a),u=c.getColumnForX(this.state.center[0]),f=c.getRowForY(this.state.center[1]);return h.sort((d,_)=>{const m=c.denormalizeCol(d.col,d.world),p=c.denormalizeCol(_.col,_.world);return Math.sqrt((u-m)*(u-m)+(f-d.row)*(f-d.row))-Math.sqrt((u-p)*(u-p)+(f-_.row)*(f-_.row))}),fe.clear(),It.clear(),h[0].id}_peekByCenterFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView,n=this.state.center;let o=Number.POSITIVE_INFINITY,a=null;return l.forEach(h=>{const c=this._keyToItem.get(h);r.getTileCoords(Qe,c.key);const u=(0,tt.j)(Qe,n);u<o&&(o=u,a=c.key)}),a.id}};(0,V._)([(0,Q.Cb)({constructOnly:!0})],ut.prototype,"concurrency",void 0),(0,V._)([(0,Q.Cb)({constructOnly:!0})],ut.prototype,"process",void 0),(0,V._)([(0,Q.Cb)()],ut.prototype,"state",void 0),(0,V._)([(0,Q.Cb)({constructOnly:!0})],ut.prototype,"strategy",void 0),(0,V._)([(0,Q.Cb)({constructOnly:!0})],ut.prototype,"tileInfoView",void 0),(0,V._)([(0,Q.Cb)({readOnly:!0})],ut.prototype,"updating",null),ut=(0,V._)([(0,ce.j)("esri.views.2d.tiling.PagedTileQueue")],ut),I(9598);var $e=I(58098);const de=new Set,Ht=[],Tt=new Map,qe=[0,0];let ft=class extends Ye.Z{constructor(l){super(l),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:l,process:r,strategy:n}=this;this._queue=new je.e({concurrency:l,process:(o,a)=>{const h=this._keyToItem.get(o);return r(h,{signal:a})},peeker:"scale-first"===n?o=>this._peekByScaleFirst(o):o=>this._peekByCenterFirst(o)})}destroy(){this.clear(),this._queue.destroy(),this._queue=null}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(l){this._queue.abort("string"==typeof l?l:l.id)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(l){return this._keyToItem.has("string"==typeof l?l:l.id)}isOngoing(l){const r="string"==typeof l?l:l.id;return this.has(r)&&this._queue.isOngoing(r)}pause(){this._queue.pause()}push(l){const r=l.key.id;if(this._queue.has(r))return this._queue.get(r);const n=this._queue.push(r),o=()=>{this._keyToItem.delete(r),this.notifyChange("updating")};return this._keyToItem.set(r,l),n.then(o,o),this.notifyChange("updating"),n}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView;let n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;l.forEach(d=>{const _=this._keyToItem.get(d),m=this.tileInfoView.getTileScale(_.key);Tt.has(m)||(Tt.set(m,[]),n=Math.max(m,n),o=Math.min(m,o)),Tt.get(m).push(_.key),de.add(m)});let a=this.state.scale;Tt.has(a)||(function Ni(l,r){l.length=0,r.forEach(n=>l.push(n))}(Ht,de),Ht.sort((d,_)=>d-_),a=Ht.reduce((d,_)=>Math.abs(_-a)<Math.abs(d-a)?_:d,Ht[0])),a=Math.min(a,n),a=Math.max(a,o);const h=Tt.get(a),c=r.getClosestInfoForScale(a),u=c.getColumnForX(this.state.center[0]),f=c.getRowForY(this.state.center[1]);return h.sort((d,_)=>{const m=c.denormalizeCol(d.col,d.world),p=c.denormalizeCol(_.col,_.world);return Math.sqrt((u-m)*(u-m)+(f-d.row)*(f-d.row))-Math.sqrt((u-p)*(u-p)+(f-_.row)*(f-_.row))}),de.clear(),Tt.clear(),h[0].id}_peekByCenterFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView,n=this.state.center;let o=Number.POSITIVE_INFINITY,a=null;return l.forEach(h=>{const c=this._keyToItem.get(h);r.getTileCoords(qe,c.key);const u=(0,tt.j)(qe,n);u<o&&(o=u,a=c.key)}),a.id}};(0,V._)([(0,Q.Cb)({constructOnly:!0})],ft.prototype,"concurrency",void 0),(0,V._)([(0,Q.Cb)({constructOnly:!0})],ft.prototype,"process",void 0),(0,V._)([(0,Q.Cb)()],ft.prototype,"state",void 0),(0,V._)([(0,Q.Cb)({constructOnly:!0})],ft.prototype,"strategy",void 0),(0,V._)([(0,Q.Cb)({constructOnly:!0})],ft.prototype,"tileInfoView",void 0),(0,V._)([(0,Q.Cb)({readOnly:!0})],ft.prototype,"updating",null),ft=(0,V._)([(0,ce.j)("esri.views.2d.tiling.TileQueue")],ft),I(65401),I(84378),new $e.Z(0,0,0,0);var T=I(39351),A=I(39406),kt=I(64288);const xt=new Map;xt.set(A.LW.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),xt.set(A.LW.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),xt.set(A.LW.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),xt.set(A.LW.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),xt.set(A.LW.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});class Yt{constructor(r,n){this._pos=0;const o=n?this._roundToNearest(n,r.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(o),this._buffer=new r(this._array),this._ctor=r,this._i16View=new Int16Array(this._array)}get length(){return this._pos}_roundToNearest(r,n){const o=Math.round(r);return o+(n-o%n)}_ensureSize(r){if(this._pos+r>=this._buffer.length){const n=this._roundToNearest(1.25*(this._array.byteLength+r*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),o=new ArrayBuffer(n),a=new this._ctor(o);a.set(this._buffer,0),this._array=o,this._buffer=a,this._i16View=new Int16Array(this._array)}}ensureSize(r){this._ensureSize(r)}writeF32(r){this._ensureSize(1);const n=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=r,this._pos++,n}push(r){this._ensureSize(1);const n=this._pos;return this._buffer[this._pos++]=r,n}writeFixed(r){this._buffer[this._pos++]=r}setValue(r,n){this._buffer[r]=n}i1616Add(r,n,o){this._i16View[2*r]+=n,this._i16View[2*r+1]+=o}getValue(r){return this._buffer[r]}incr(r){if(this._buffer.length<r)throw new Error("Increment index overflows the target buffer");this._buffer[r]++}decr(r){this._buffer[r]--}writeRegion(r){this._ensureSize(r.length);const n=this._pos;return this._buffer.set(r,this._pos),this._pos+=r.length,n}writeManyFrom(r,n,o){this._ensureSize(o-n);for(let a=n;a!==o;a++)this.writeFixed(r._buffer[a])}buffer(){const r=this._array.slice(0,4*this._pos);return this.destroy(),r}toArray(){const r=this._array,n=[];for(let o=0;o<r.byteLength/4;o++)n.push(r[o]);return n}seek(r){this._pos=r}destroy(){this._array=null,this._buffer=null}}class ei{constructor(r,n,o){this._start={index:0,vertex:0};const a=function Ji(l,r,n){const{indicesPerRecord:o,multiplier:a,verticesPerRecord:h}=xt.get(l);return{recordBytes:n*T.XJ*Uint32Array.BYTES_PER_ELEMENT,indexBytes:a*o*n*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:a*h*n*r}}(r,n,o),h=n/4;this.geometryType=r,this._records=new Yt(Int32Array,a.recordBytes),this._indices=new Yt(Uint32Array,a.indexBytes),this._vertices=new Yt(Uint32Array,a.vertexBytes),this._metrics=new Yt(Float32Array,0),this._strideInt=h}serialize(r){const n=this._records.buffer(),o=this._indices.buffer(),a=this._vertices.buffer(),h=this._metrics.length?this._metrics.buffer():null,c=4*this._strideInt;return r.push(n,o,a),{stride:c,records:n,indices:o,vertices:a,metrics:h}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/T.XJ}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(r){this._vertices.ensureSize(r)}indexEnsureSize(r){this._indices.ensureSize(r)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(r,n,o,a,h,c,u,f){this._records.push(r),this._records.push(n),this._records.push(o),this._records.push(a),this._records.push(h),this._records.push(c),this._records.push(u),this._records.writeF32(f)}writeIndex(r){this._indices.push(r)}writeVertex(r){this._vertices.push(r)}writeVertexF32(r){this._vertices.writeF32(r)}copyLastFrom(r,n,o){const a=r._records.length-T.XJ,h=r._records.getValue(a),c=r._records.getValue(a+1),u=r._records.getValue(a+2),f=r._records.getValue(a+4),d=r._records.getValue(a+6),_=r._records.getValue(a+7),m=this._vertices.length,p=(r._start.vertex-this._vertices.length)/this._strideInt,y=this._indices.length,g=this.vertexCount;for(let x=r._start.index;x!==r._indices.length;x++){const M=r._indices.getValue(x);this._indices.push(M-p)}for(let x=r._start.vertex;x!==r._vertices.length;x++){const M=r._vertices.getValue(x);this._vertices.push(M)}for(let x=m;x<=this._vertices.length;x+=this._strideInt)this._vertices.i1616Add(x,n,o);this._records.push(h),this._records.push(c),this._records.push(u),this._records.push(y),this._records.push(f),this._records.push(g),this._records.push(d),this._records.push(_)}}var Xi=I(55376);function ii(l){switch(l){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case 128:return 1}}function si(l){switch(l){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case 128:return 1}}class Yi{constructor(r,n,o,a,h,c=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=n,this.tileKey=r,this._hasAggregate=a,this._pixelBufferEnabled=h,this._version=c,this._symbologyType=o}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(r){const n=[];return n.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((o,a)=>{const h=1<<a,c=ii(h),u=si(h),f=(0,Xi.M)(new $e.Z(this.tileKey),c,u,r),d=this._serializeTileVertexData(this.tileKey,f.id,o.vertexData);d.message.bufferIds=o.displayIds,n.push(d)}),n}_serializeTileVertexData(r,n,o){var h,c,u,f,d;const a=new Array;return{message:{tileKeyOrigin:r,tileKey:n,data:{[A.LW.MARKER]:null==(h=o.get(A.LW.MARKER))?void 0:h.serialize(a),[A.LW.FILL]:null==(c=o.get(A.LW.FILL))?void 0:c.serialize(a),[A.LW.LINE]:null==(u=o.get(A.LW.LINE))?void 0:u.serialize(a),[A.LW.TEXT]:null==(f=o.get(A.LW.TEXT))?void 0:f.serialize(a),[A.LW.LABEL]:null==(d=o.get(A.LW.LABEL))?void 0:d.serialize(a)},version:this._version},transferList:a}}featureStart(r,n){this._current.insertAfter=r,this._current.sortKey=n}featureEnd(){}recordStart(r,n,o,a){this._current.writer=this._getVertexWriter(o),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=a,this._current.id=r,this._current.materialKey=n,this._current.geometryType=o,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(r){this._current.writer.vertexEnsureSize(r)}indexEnsureSize(r){this._current.writer.indexEnsureSize(r)}vertexBounds(r,n,o,a){this._current.bufferingEnabled&&this._addOverlap(r,n,o,a)}vertexWrite(r){this._current.writer.writeVertex(r)}vertexWriteF32(r){this._current.writer.writeVertexF32(r)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(r){this._current.writer.writeIndex(r)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(r,n,o,a,h,c,u,f){this._current.writer=this._getVertexWriter(A.LW.LABEL);const d=this._current.writer.metricWriter;d.push((0,ue.jL)(r)),d.push(n),d.push(o),d.push(a),d.push(h),d.push(c),d.push(u),d.push(f),d.push(255),this._current.metricBoxLenPointer=d.push(0)}metricEnd(){const r=this._current.writer.metricWriter;0===r.getValue(this._current.metricBoxLenPointer)&&r.seek(r.length-10)}metricBoxWrite(r,n,o,a){const h=this._current.writer.metricWriter;h.incr(this._current.metricBoxLenPointer),h.push(0),h.push(0),h.push(r),h.push(n),h.push(o),h.push(a)}recordEnd(){const r=this._current.vertStart,n=this._current.writer.vertexCount-r;if(!n)return!1;this.hasRecords=!0;const o=this._current.indexStart;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,o,this._current.writer.indexCount-o,r,n,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||0===this._current.overlaps||this._current.geometryType===A.LW.LABEL)return!0;const h=this._current.writer;for(let c=0;c<8;c++){const u=1<<c;if(this._current.overlaps&u){this._data.neighbors[c]||(this._data.neighbors[c]={vertexData:new Map,displayIds:new Set});const f=this._data.neighbors[c],d=this._current.geometryType;if(!f.vertexData.has(d)){const g=(0,kt.$_)(d,this._symbologyType).geometry,x=new ei(d,g,T.Ip);f.vertexData.set(d,x)}const _=f.vertexData.get(this._current.geometryType),m=8,p=512*-ii(u)*m,y=512*-si(u)*m;_.copyLastFrom(h,p,y),f.displayIds.add(this._current.id)}}return!0}_addOverlap(r,n,o,a){this._current.overlaps|=255^((r<0+o?148:r>=T.I_-o?41:189)|(n<0+a?224:n>=T.I_-a?7:231))}_getVertexWriter(r){if(!this._data.self.has(r)){const n=this._data.self,o=(0,kt.$_)(r,this._symbologyType).geometry;n.set(r,new ei(r,o,this.hint.records))}return this._data.self.get(r)}}var li=I(58774),hi=I(21286),w=I(23841),G=I(7547),ot=I(40028),B=I(81295),S=I(5254),U=I(18716);const it=100;function ci(l,r,n){return l[0]=r[0]-n[0],l[1]=r[1]-n[1],l}function ui(l,r){return Math.sqrt(l*l+r*r)}function fi(l){const r=ui(l[0],l[1]);l[0]/=r,l[1]/=r}function ji(l,r){return ui(l[0]-r[0],l[1]-r[1])}function R(l){return"function"==typeof l}function xe(l=2){return 1/Math.max(l,1)}function dt(l,r){return[!!l.minScale&&r.scaleToZoom(l.minScale)||0,!!l.maxScale&&r.scaleToZoom(l.maxScale)||it]}function di(l){return l.length-1}function $i(l,r,n=1){const[o,a]=function Qi(l,r){return l[r+1]}(l,r);return Math.sqrt(o*o+a*a)*n}class Ut{constructor(r,n,o,a,h){this._segments=r,this._index=n,this._distance=o,this._xStart=a,this._yStart=h,this._done=!1}static create(r){return new Ut(r,0,0,r[0][0],r[0][1])}clone(){return new Ut(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(r){return this._index===r._index||r._index===this._index-1&&(0===this._distance||1===r._distance)||r._index===this._index+1&&(1===this._distance||0===r._distance)}leq(r){return this._index<r._index||this._index===r._index&&this._distance<=r._distance}geq(r){return this._index>r._index||this._index===r._index&&this._distance>=r._distance}get _segment(){return this._segments[this._index+1]}get angle(){const r=this.dy;let o=Math.acos((0*r+-1*-this.dx)/(1*this.length));return r>0&&(o=2*Math.PI-o),o}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:r,dy:n}=this;return Math.sqrt(r*r+n*n)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<di(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(r,n){const o=this.backwardLength;if(r<=o)return this._distance=(o-r)/this.length,this;let a=this.backwardLength;for(;this.prev();){if(a+this.length>r)return this._seekBackwards(r-a);a+=this.length}return this._distance=0,n?this:null}seek(r,n=!1){if(r<0)return this._seekBackwards(Math.abs(r),n);if(r<=this.remainingLength)return this._distance=(this.backwardLength+r)/this.length,this;let o=this.remainingLength;for(;this.next();){if(o+this.length>r)return this.seek(r-o,n);o+=this.length}return this._distance=1,n?this:null}}function qi(l,r,n,o=!0){const a=function mi(l){let r=0;for(let n=0;n<di(l);n++)r+=$i(l,n);return r}(l),h=Ut.create(l),c=a/2;if(!o)return h.seek(c),void n(h.clone(),0,c+0*r,a);const u=Math.max((a-r)/2,0),f=Math.floor(u/r);h.seek(c-f*r);for(let _=-f;_<=f;_++)h.x<512&&h.x>=0&&h.y<512&&h.y>=0&&n(h.clone(),_,c+_*r,a),h.seek(r)}function es(l,r){if(r<=0)return;const o=l.length;if(o<3)return;const a=[];let h=0;a.push(0);for(let m=1;m<o;m++)h+=ji(l[m],l[m-1]),a.push(h);r=Math.min(r,.2*h);const c=[];c.push(l[0][0]),c.push(l[0][1]);const u=l[o-1][0],f=l[o-1][1],d=ci([0,0],l[0],l[1]);fi(d),l[0][0]+=r*d[0],l[0][1]+=r*d[1],ci(d,l[o-1],l[o-2]),fi(d),l[o-1][0]+=r*d[0],l[o-1][1]+=r*d[1];for(let m=1;m<o;m++)a[m]+=r;a[o-1]+=r;const _=.5*r;for(let m=1;m<o-1;m++){let p=0,y=0,g=0;for(let x=m-1;x>=0&&!(a[x+1]<a[m]-_);x--){const M=_+a[x+1]-a[m],v=a[x+1]-a[x],b=a[m]-a[x]<_?1:M/v;if(Math.abs(b)<1e-6)break;const L=b*b,z=b*M-.5*L*v,F=b*v/r,E=l[x+1],Z=l[x][0]-E[0],D=l[x][1]-E[1];p+=F/z*(E[0]*b*M+.5*L*(M*Z-v*E[0])-L*b*v*Z/3),y+=F/z*(E[1]*b*M+.5*L*(M*D-v*E[1])-L*b*v*D/3),g+=F}for(let x=m+1;x<o&&!(a[x-1]>a[m]+_);x++){const M=_-a[x-1]+a[m],v=a[x]-a[x-1],b=a[x]-a[m]<_?1:M/v;if(Math.abs(b)<1e-6)break;const L=b*b,z=b*M-.5*L*v,F=b*v/r,E=l[x-1],Z=l[x][0]-E[0],D=l[x][1]-E[1];p+=F/z*(E[0]*b*M+.5*L*(M*Z-v*E[0])-L*b*v*Z/3),y+=F/z*(E[1]*b*M+.5*L*(M*D-v*E[1])-L*b*v*D/3),g+=F}c.push(p/g),c.push(y/g)}c.push(u),c.push(f);for(let m=0,p=0;m<o;m++)l[m][0]=c[p++],l[m][1]=c[p++]}var wt=I(82054),is=I(72283),ss=I(11004);class _i{static getPlacement(r,n,o,a){const h=(0,ss.W)(n);if(!h)return null;const c=(0,is.GP)(r);return h.execute(c,n,o,a)}}var rs=I(25797);const yi=l=>class extends l{constructor(...r){super(...r),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=A.LW.TEXT,this._aux=(0,S.Jz)(0,0,this._referenceSize,this._bitset)}bindTextInfo(r,n){this._shapingInfo=r&&r.length?(0,P.yw)(r,o=>(0,rs.Nr)(o,n,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:T.xm*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM})):null}_write(r,n,o,a){const h=n.getDisplayId();this._writeGeometry(r,n,h,o,a)}_writeGeometry(r,n,o,a,h){const c=this._shapingInfo;if((0,P.Wi)(c))return;if((0,P.pC)(this._textPlacement)){const f=null!=h?h:n.readLegacyGeometryForDisplay();return this._writePlacedText(r,o,f,c,a)}const u=h?(0,wt.oB)((0,wt.GH)(h),2):"esriGeometryPolygon"===n.geometryType?n.readCentroid():n.readGeometryForDisplay();if(!(0,P.Wi)(u)){if(u.isPoint){const[f,d]=u.coords;return!r.hasAggregates&&r.hasPixelBufferEnabled&&(f<0||f>=512||d<0||d>=512)?void 0:this._writeGlyphs(r,o,{x:f,y:d},c)}u.forEachVertex((f,d)=>this._writeGlyphs(r,o,{x:f,y:d},c))}}_writePlacedText(r,n,o,a,h){const c=(0,P.Wg)(this._textPlacement),u=_i.getPlacement(o,c,(0,w.F2)(1),h.geometryEngine);if(!u)return;let f=u.next();for(;null!=f;){const d=-f.getAngle();a.setRotation(d);const _=f.tx,m=-f.ty;_<0||_>=512||m<0||m>=512||(this._writeGlyphs(r,n,{x:_,y:m},a),a.setRotation(-d)),f=u.next()}}_writeGlyphs(r,n,o,a){const h=U.m2.load(this._materialKey),c=(0,S.UJ)(Math.round(8*o.x),Math.round(8*o.y)),u=this._vertexBoundsScale,f=a.bounds,d=2*Math.max(f.width,f.height);for(const _ of a.glyphs)h.textureBinding=_.textureBinding,r.recordStart(n,h.data,this.geometryType,!0),r.vertexBounds(o.x+f.x+this._xOffset,o.y+f.y-this._yOffset,d*u,d*u),this._writeVertices(r,n,c,_),r.recordEnd()}_writeGlyph(r,n,o,a,h){const c=U.m2.load(this._materialKey),u=(0,S.UJ)(Math.round(8*o),Math.round(8*a));c.textureBinding=h.textureBinding,r.recordStart(n,c.data,this.geometryType,!0);const f=h.bounds,d=this._vertexBoundsScale;r.vertexBounds(o+f.x*d,a+f.y*d,f.width*d,f.height*d),this._writeVertices(r,n,u,h),r.recordEnd()}_writeVertices(r,n,o,a){const h=r.vertexCount();this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.upperLeft),r.vertexWrite(a.texcoords.upperLeft),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.upperRight),r.vertexWrite(a.texcoords.upperRight),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.lowerLeft),r.vertexWrite(a.texcoords.lowerLeft),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.lowerRight),r.vertexWrite(a.texcoords.lowerRight),r.vertexEnd(),r.indexWrite(h+0),r.indexWrite(h+1),r.indexWrite(h+2),r.indexWrite(h+1),r.indexWrite(h+3),r.indexWrite(h+2)}_writeVertexCommon(r,n,o,a){const h=this._color,c=this._haloColor,u=(0,S.Jz)(0,0,this._referenceSize,this._bitset),f=(0,S.Jz)(0,0,this._size,this._haloSize);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(h),r.vertexWrite(c),r.vertexWrite(f),r.vertexWrite(u),r.vertexWrite(this._minMaxZoom)}};var ve=I(73608);class Bt{bindFeature(r,n,o){}write(r,n,o,a){var u;if((0,P.Wi)(this._effects)||0===(null==(u=this._effects)?void 0:u.length))return this._write(r,n,a);const h=ve.j.executeEffects(this._effects,n.readLegacyGeometryForDisplay(),a.geometryEngine);let c=ve.j.next(h);for(;c;)this._write(r,n,a,c),c=ve.j.next(h)}_write(r,n,o,a){}}class Lt extends(yi(Bt)){constructor(r,n,o,a,h,c,u,f,d,_,m,p,y,g,x,M,v,b,L=!1,z,F){super(),this._xOffset=(0,w.F2)(y),this._yOffset=(0,w.F2)(g),this._decoration=_||"none",this._color=h,this._haloColor=c,this._haloSize=Math.min(Math.floor(5*(0,w.F2)((0,w.t_)(o))),127),this._size=Math.min(Math.round((0,w.F2)(n)),127);const E=Math.min(Math.round((0,w.F2)(a||n)),127);this._referenceSize=Math.round(Math.sqrt(256*E)),this._scale=this._size/T.Ex,this._angle=p,this._justify=(0,ot.Hd)(u||"center"),this._xAlignD=(0,ot.kH)(u||"center"),this._yAlignD=(0,ot.b7)(f||"baseline"),this._baseline="baseline"===(f||"baseline"),this._bitset=(d===G.v2.MAP?1:0)|(m?1:0)<<1;const Z=U.m2.load(r);Z.sdf=!0,this._materialKey=Z.data,this._lineWidth=(0,w.F2)(x)||512,this._lineHeight=M||1,this._textPlacement=v,this._effects=b,this._isCIM=L,this._minMaxZoom=(0,S.UJ)(Math.round(z*T.MI),Math.round(F*T.MI))}static fromText(r,n){const o=new Lt(r.materialKey,r.font.size,r.haloSize||0,r.font.size,r.color&&(0,B.aH)(r.color)||0,r.haloColor&&(0,B.aH)(r.haloColor)||0,r.horizontalAlignment,r.verticalAlignment,G.v2.SCREEN,r.font.decoration,!1,r.angle||0,r.xoffset,r.yoffset,r.lineWidth,r.lineHeight,null,null,!1,0,it),[,a]=(0,j.E)(r.text);return o.bindTextInfo(n,a),o._vertexBoundsScale=r.maxVVSize?r.maxVVSize/r.font.size:1,o}static fromCIMText(r,n,o){const a=r.scaleFactor||1,h=r.size*r.sizeRatio*a,[c,u]=dt(r.scaleInfo,o),f=new Lt(r.materialKey,h,r.outlineSize*r.sizeRatio,r.referenceSize,(0,B.t2)(r.color),(0,B.t2)(r.outlineColor),r.horizontalAlignment,r.verticalAlignment,r.alignment,r.decoration,r.colorLocked,r.angle,r.offsetX*r.sizeRatio*a,r.offsetY*r.sizeRatio*a,512,1,r.markerPlacement,r.effects,!0,c,u),[,d]=(0,j.E)(r.text);return f.bindTextInfo(n,d),f._vertexBoundsScale=r.maxVVSize?r.maxVVSize/h:1,f}}const os=N.Z.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),fs=function us(l){const r=new Map;return n=>(r.has(n)||r.set(n,l(n)),r.get(n))}(l=>{let r=0;if(0===l)return 1/0;for(;!(l%2);)r++,l/=2;return r}),ie=l=>Math.floor(127*l+127),Zt=l=>Math.floor(10*l),Wt=l=>Math.round(l*(254/360));class se extends Lt{constructor(r,n,o,a){var m,p,y;super(r,o.font.size,o.haloSize||0,o.font.size,o.color&&(0,B.aH)(o.color)||0,o.haloColor&&(0,B.aH)(o.haloColor)||0,o.horizontalAlignment,o.verticalAlignment,(0,ot.NS)(n.labelPlacement)?G.v2.MAP:G.v2.SCREEN,o.font.decoration,!1,o.angle||0,o.xoffset,o.yoffset,o.lineWidth,o.lineHeight,null,null,null,null,null),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=A.LW.LABEL,this._allowOverrun=null!=(m=n.allowOverrun)&&m,this._repeatLabel=null==(p=n.repeatLabel)||p,this._labelPosition=null!=(y=n.labelPosition)?y:"curved";const h=function hs(l,r){const n=!!l.minScale&&r.scaleToZoom(l.minScale)||0;return(0,hi.uZ)(n,0,25.5)}(n,a),c=function cs(l,r){const n=!!l.maxScale&&r.scaleToZoom(l.maxScale)||255;return(0,hi.uZ)(n,0,25.5)}(n,a),u=n.labelPlacement,[f,d]=(0,ot.qv)(u);this._xAlignD=f,this._yAlignD=d,this._minZoom=h,this._maxZoom=c,this._refPlacementPadding=(0,w.F2)(o.haloSize)+T.Iw,this._repeatLabelDistance=n.repeatLabelDistance?(0,w.F2)(n.repeatLabelDistance):128;const _=U.Gq.load(r);_.sdf=!0,this._materialKey=_.data}static fromLabelClass(r,n){if("esriServerLinePlacementCenterAlong"===r.labelPlacement){const o=r.symbol;o.xoffset=0,o.yoffset=0,o.angle=0,o.font.decoration="none"}return new se(r.materialKey,r,r.symbol,n)}get _shapedBox(){return(0,P.Wg)(this._shapingInfo).bounds}setZoomLevel(r){this._zoomLevel=r}bindReferenceTemplate(r){let n=(0,ot.g)(this._xAlignD),o=(0,ot.tf)(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,(0,P.Wi)(r))return void(this._refSymbolAndPlacementOffset=(0,S.Jz)(0,0,ie(n),ie(o)));if("circle"===r.boundsType&&(n||o)){const c=Math.sqrt(n*n+o*o);n/=c,o/=c}const a=Math.max(r.height,r.width);this._refSymbolAndPlacementOffset=(0,S.Jz)(4*this._refPlacementPadding,a,ie(n),ie(o)),this._referenceSize=a,this._refPlacementDirX=n,this._refPlacementDirY=o,this._refOffsetX=r.xOffset,this._refOffsetY=r.yOffset}_write(r,n){if((0,P.Wi)(this._shapingInfo))return;const o=this._shapingInfo,a=n.getDisplayId(),h="esriGeometryPolygon"===n.geometryType?n.readLegacyCentroid():n.readLegacyGeometry();if(h)switch(this.current={out:r,inId:a,inShaping:o,zoomLevel:this._zoomLevel},n.geometryType){case"esriGeometryPolyline":this._placeLineLabels(h);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(h);break;default:((l,r="mapview-labeling")=>{os.error(new W.Z(r,"mapview-labeling"))})(0,`Geometry of type ${n.geometryType} is not supported`)}}_isVisible(r,n){const o=Zt(this.current.zoomLevel);return Zt(r)<=o&&o<=Zt(n)}_placePointLabels(r){const{out:n,inId:o,inShaping:a}=this.current;this._writeGlyphs(n,o,r,a)}_placeLineLabels(r){const n=function ts(l,r){const n=r;for(let o=0;o<l.length;o++){let a=l[o];const h=[];h.push(a[0]);for(let u=1;u<a.length;u++){let[f,d]=h[u-1];f+=a[u][0],d+=a[u][1],h.push([f,d])}es(h,n);const c=[];c.push(h[0]);for(let u=1;u<h.length;u++){const[f,d]=h[u-1],[_,m]=h[u],p=Math.round(_-f),y=Math.round(m-d);c.push([p,y])}l[o]=c,a=c}return l}(r.paths,this.current.inShaping.bounds.width),o=this._placeSubdivGlyphs.bind(this),a=(this._shapedBox.width+this._repeatLabelDistance)/2;for(const h of n)qi(h,a,o,this._repeatLabel)}_placeSubdivGlyphs(r,n,o,a){const h=fs(n),c=this._shapedBox.width/2,u=Math.sqrt(this._repeatLabelDistance)/2,f=Math.min(o,a-o),d=this.current.inShaping.isMultiline?25:Math.log2(f/(u+c/2)),_=0===n?d:Math.min(h,d),m=Math.max(this._minZoom,this.current.zoomLevel+1-_),p=this.current.zoomLevel-m,y=this._shapedBox.width/2*2**p;this.current.inShaping.isMultiline?0===n&&this._placeStraight(r,m):this._allowOverrun&&p<0?this._placeStraightAlong(r,this._minZoom):"parallel"===this._labelPosition?this._placeStraightAlong(r,m):"curved"===this._labelPosition&&this._placeCurved(r,m,y)}_placeStraight(r,n){const{out:o,inId:a,inShaping:h}=this.current,c=Math.ceil(r.angle*(180/Math.PI)%360),u=Math.ceil((r.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=Wt(c),this._writeGlyphs(o,a,r,h,n),this._outLineLabelAngle=Wt(u),this._writeGlyphs(o,a,r,h,n)}_placeCurved(r,n,o){const{out:a,inId:h}=this.current;a.metricStart(h,n,r.x,r.y,0,0,0,0);const c=r.clone(),u=r.angle*(180/Math.PI)%360,f=(r.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Wt(u),this._placeFirst(c,n,1),this._placeBack(r,c,n,o,1),this._placeForward(r,c,n,o,1),this._outLineLabelAngle=Wt(f),this._placeFirst(c,n,0),this._placeBack(r,c,n,o,0),this._placeForward(r,c,n,o,0),a.metricEnd()}_placeStraightAlong(r,n){const{out:o,inId:a}=this.current;o.metricStart(a,n,r.x,r.y,0,0,0,0);const h=r.clone(),c=r.angle*(180/Math.PI)%360,u=(r.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=Wt(c),this._placeFirst(h,n,1,!0),this._outLineLabelAngle=Wt(u),this._placeFirst(h,n,0,!0),o.metricEnd()}_placeBack(r,n,o,a,h){const c=r.clone();let u=r.backwardLength+0;for(;c.prev()&&!(u>=a);)this._placeOnSegment(c,n,u,o,-1,h),u+=c.length+0}_placeForward(r,n,o,a,h){const c=r.clone();let u=r.remainingLength+0;for(;c.next()&&!(u>=a);)this._placeOnSegment(c,n,u,o,1,h),u+=c.length+0}_placeFirst(r,n,o,a=!1){const h=r,c=this.current.inShaping,u=c.glyphs,f=this.current.zoomLevel,{out:d,inId:_}=this.current;for(const m of u){const p=m.x>c.bounds.x?o:1-o,y=p*r.remainingLength+(1-p)*r.backwardLength,g=Math.abs(m.x+m.width/2-c.bounds.x),x=Math.max(0,f+Math.log2(g/(y+0))),M=Math.max(n,a?0:x);if(m.maxZoom=25,m.angle=r.angle+(1-o)*Math.PI,m.minZoom=M,this._writeGlyph(d,_,h.x,h.y,m),o&&this._isVisible(m.minZoom,m.maxZoom)){const v=m.bounds;d.metricBoxWrite(v.center[0],v.center[1],v.width,v.height)}}}_placeOnSegment(r,n,o,a,h,c){const u=this.current.inShaping.glyphs,{out:f,inId:d}=this.current,_=this.current.inShaping,m=this.current.zoomLevel,g={x:r.x+o*-h*(r.dx/r.length),y:r.y+o*-h*(r.dy/r.length)};for(const x of u){const M=x.x>_.bounds.x?c:1-c;if(!(M&&1===h||!M&&-1===h))continue;const v=Math.abs(x.x+x.width/2-_.bounds.x),b=Math.max(0,m+Math.log2(v/o)-.1),L=Math.max(a,m+Math.log2(v/(o+r.length+0)));if(0!==b&&(x.angle=r.angle+(1-c)*Math.PI,x.minZoom=L,x.maxZoom=b,this._writeGlyph(f,d,g.x,g.y,x),c&&this._isVisible(x.minZoom,x.maxZoom))){const z=x.bounds;f.metricBoxWrite(z.center[0]+(r.x-n.x),z.center[1]+(r.y-n.y),z.width,z.height)}}}_writeGlyphs(r,n,o,a,h=this._minZoom){if(o.x<0||o.x>=512||o.y<0||o.y>=512)return;const c=o.x+this._refOffsetX,u=o.y-this._refOffsetY;for(const m of a.glyphs)m.minZoom=h,m.maxZoom=this._maxZoom,this._writeGlyph(r,n,c,u,m);const _=a.boundsT;r.metricStart(n,h,c,u,this._refPlacementDirX,this._refPlacementDirY,this._referenceSize,this._materialKey),r.metricBoxWrite(_.center[0],_.center[1],_.width,_.height),r.metricEnd()}_writeVertexCommon(r,n,o,a){const h=this._color,c=this._haloColor,u=(0,S.Jz)(0,0,this._size,this._haloSize),f=Math.max(a.minZoom,this._minZoom),d=Math.min(a.maxZoom,this._maxZoom),_=(0,S.Jz)(Zt(f),Zt(d),this._outLineLabelAngle,0);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(h),r.vertexWrite(c),r.vertexWrite(u),r.vertexWrite(this._refSymbolAndPlacementOffset),r.vertexWrite(_)}}var Me=I(12225),re=I(9545),xi=I(31478);const gi=3.14159265359/180,Mi=l=>class extends l{constructor(...r){super(...r),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=A.LW.MARKER}_write(r,n,o,a){const h=n.getDisplayId();r.recordStart(h,this._materialKey,this.geometryType,!0),this._writeGeometry(r,n,h,o,a),r.recordEnd()}_writeGeometry(r,n,o,a,h){if((0,P.pC)(this._markerPlacement))return this._writePlacedMarkers(r,n,a,h);if(!h&&"esriGeometryPoint"===n.geometryType){const u=n.getX(),f=n.getY();return!r.hasAggregates&&r.hasPixelBufferEnabled&&(u<0||u>=513||f<0||f>=513)?void 0:this._writeVertices(r,o,this._getPos(u,f),u,f)}const c=h?(0,wt.oB)((0,wt.GH)(h),2):"esriGeometryPolygon"===n.geometryType?n.readCentroid():n.readGeometryForDisplay();if(!(0,P.Wi)(c)){if(c.isPoint){const[u,f]=c.coords;return!r.hasAggregates&&r.hasPixelBufferEnabled&&(u<0||u>=512||f<0||f>=512)?void 0:this._writeVertices(r,o,this._getPos(u,f),u,f)}c.forEachVertex((u,f)=>{const d=2*T.I_;u<-d||u>=d||f<-d||f>=d||this._writeVertices(r,o,this._getPos(u,f),u,f)})}}_writePlacedMarkers(r,n,o,a){const h=null!=a?a:n.readLegacyGeometryForDisplay(),c=_i.getPlacement(h,(0,P.Wg)(this._markerPlacement),(0,w.F2)(1),o.geometryEngine);if(!c)return;const u=n.getDisplayId(),f=(0,re.c)(),d=(0,Me.c)();let p=c.next();for(;null!=p;){const y=p.tx,g=-p.ty;y>=-128&&y<=640&&g>=-128&&g<=640&&(this._applyTransformation(d,f,-p.getAngle()/gi),this._writeVertices(r,u,this._getPos(y,g),y,g)),p=c.next()}}_writeVertices(r,n,o,a,h){const c=U.mE.load(this._materialKey);return c.symbologyType===A.mD.HEATMAP?this._writeHeatmapVertices(r,n,o,a,h):this._writeMarkerVertices(r,n,c,o,a,h)}_writeMarkerVertices(r,n,o,a,h,c){const u=o.vvRotation,f=r.vertexCount();let d=this._computedWidth*this._vertexBoundsScaleX,_=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const m=Math.max(d,_);d=m,_=m}if(u){const m=Math.max(this.xOffset,this.yOffset);d+=m,_+=m}r.vertexBounds(h+this.xOffset,c-this.yOffset,d,_),r.vertexWrite(a),r.vertexWrite(this._offsetUpperLeft),r.vertexWrite(this._texUpperLeft),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetUpperRight),r.vertexWrite(this._texUpperRight),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetBottomLeft),r.vertexWrite(this._texBottomLeft),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetBottomRight),r.vertexWrite(this._texBottomRight),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),this._writeIndices(r,f)}_writeHeatmapVertices(r,n,o,a,h){const c=r.vertexCount();r.vertexBounds(a+this.xOffset,h-this.yOffset,this.width,this.height),r.vertexWrite(o),r.vertexWrite(this._offsetUpperLeft),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetUpperRight),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetBottomLeft),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetBottomRight),r.vertexWrite(n),r.vertexEnd(),this._writeIndices(r,c)}_writeIndices(r,n){r.indexWrite(n+0),r.indexWrite(n+1),r.indexWrite(n+2),r.indexWrite(n+1),r.indexWrite(n+3),r.indexWrite(n+2)}_applyTransformation(r,n,o=0){(0,xi.a)(r,(0,re.f)(this.xOffset,-this.yOffset)),this.angle+o!==0&&(0,xi.r)(r,r,gi*(this.angle+o));const a=this._computedWidth,h=this._computedHeight,c=(this._anchorX-.5)*a,u=(this._anchorY-.5)*h;(0,tt.a)(n,c,u),(0,tt.t)(n,n,r),this._offsetUpperLeft=(0,S.UJ)(16*n[0],16*n[1]),this._offsets.xUpperLeft=n[0],this._offsets.yUpperLeft=n[1],(0,tt.a)(n,c+a,u),(0,tt.t)(n,n,r),this._offsetUpperRight=(0,S.UJ)(16*n[0],16*n[1]),this._offsets.xUpperRight=n[0],this._offsets.yUpperRight=n[1],(0,tt.a)(n,c,u+h),(0,tt.t)(n,n,r),this._offsetBottomLeft=(0,S.UJ)(16*n[0],16*n[1]),this._offsets.xBottomLeft=n[0],this._offsets.yBottomLeft=n[1],(0,tt.a)(n,c+a,u+h),(0,tt.t)(n,n,r),this._offsetBottomRight=(0,S.UJ)(16*n[0],16*n[1]),this._offsets.xBottomRight=n[0],this._offsets.yBottomRight=n[1]}_getPos(r,n){return(0,S.UJ)(Math.round(8*r),Math.round(8*n))}};class st extends(Mi(Bt)){constructor(r,n,o,a,h,c,u,f,d,_,m,p,y,g,x,M,v,b,L,z,F,E,Z){super(),this.angle=a,this.height=u,this.width=c,this.xOffset=n*L,this.yOffset=o*L,this._markerPlacement=z,this._effects=F,this._anchorX=.5-(.5+M)*x.width/x.width,this._anchorY=.5-(.5+v)*x.height/x.height,this._minMaxZoom=(0,S.UJ)(Math.round(E*T.MI),Math.round(Z*T.MI));const D=(g===G.v2.MAP?T.Tz:T.CQ)|(m?T.Uh:0)|(y?T.oK:0)|(p?T.e0:0),ct=x&&x.sdf,_t=U.mE.load(r);_t.sdf=ct,_t.pattern=!0,_t.textureBinding=x.textureBinding,this._materialKey=_t.data,this._fillColor=h,this._outlineColor=d,this._sizeOutlineWidth=(0,S.Jz)(Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*_),255)),Math.round(Math.min(Math.sqrt(128*f),255)));const yt=x.rect.x+T.fL,nt=x.rect.y+T.fL,Rt=yt+x.width,At=nt+x.height;this._offsets.xUpperLeft=yt,this._offsets.yUpperLeft=nt,this._offsets.xUpperRight=Rt,this._offsets.yUpperRight=nt,this._offsets.xBottomLeft=yt,this._offsets.yBottomLeft=At,this._offsets.xBottomRight=Rt,this._offsets.yBottomRight=At,_t.symbologyType===A.mD.PIE_CHART?(this._texUpperLeft=(0,S.UJ)(0,1),this._texUpperRight=(0,S.UJ)(1,1),this._texBottomLeft=(0,S.UJ)(0,0),this._texBottomRight=(0,S.UJ)(1,0)):(this._texUpperLeft=(0,S.UJ)(yt,nt),this._texUpperRight=(0,S.UJ)(Rt,nt),this._texBottomLeft=(0,S.UJ)(yt,At),this._texBottomRight=(0,S.UJ)(Rt,At)),c*=b,u*=b,c*=L,u*=L;const gr=Math.round(64*b);this._bitestAndDistRatio=(0,S.UJ)(D,gr),this._computedWidth=c,this._computedHeight=u;const vr=(0,re.c)(),Mr=(0,Me.c)();this._applyTransformation(Mr,vr)}static fromCIMMarker(r,n,o){const c=r.size,u=(n&&n.width||1)/(n&&n.height||1)*r.scaleX,f=r.scaleSymbolsProportionally&&r.frameHeight?c/r.frameHeight:1;let d=(0,B.t2)(r.color);const _=(0,B.t2)(r.outlineColor),m=(0,w.F2)(c),p=m*u,y=(0,w.F2)(r.offsetX||0),g=(0,w.F2)(r.offsetY||0),x=(0,w.F2)(r.outlineWidth||0)*f,M=r.alignment||G.v2.SCREEN,v=(0,w.F2)(r.referenceSize),[b,L]=dt(r.scaleInfo,o);n.sdf||0!==d||(d=-1);let z=r.rotation||0;r.rotateClockwise||(z=-z);let F=0,E=0;const Z=r.anchorPoint;Z&&(r.isAbsoluteAnchorPoint?c&&(F=-Z.x/(c*u),E=Z.y/c):(F=Z.x,E=Z.y));const D=new st(r.materialKey,y,g,z,d,p,m,v,_,x,r.colorLocked,r.scaleSymbolsProportionally,!1,M,n,F,E,r.sizeRatio,(0,P.Pt)(r.scaleFactor,1),r.markerPlacement,r.effects,b,L);return D._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/p:1,D._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/m:1,D}static fromPictureMarker(r,n){const o=Math.round((0,w.F2)(r.width)),a=Math.round((0,w.F2)(r.height)),h=T.ru,c=Math.round((0,w.F2)(r.xoffset||0)),u=Math.round((0,w.F2)(r.yoffset||0)),f=new st(r.materialKey,c,u,r.angle,h,o,a,a,0,0,!1,!1,!1,G.v2.SCREEN,n,0,0,1,1,null,null,0,it);return f._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/r.width:1,f._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/r.height:1,f}static fromSimpleMarker(r,n){const o=(0,B.aH)(r.color),a=Math.round((0,w.F2)(r.size)),h=a,c=Math.round((0,w.F2)(r.xoffset||0)),u=Math.round((0,w.F2)(r.yoffset||0)),f=r.style,d=r.outline,_=0|(d&&d.color&&(0,B.aH)(d.color)),m=0|(d&&d.width&&Math.round((0,w.F2)(d.width))),p=new st(r.materialKey,c,u,r.angle,o,a,h,h,_,m,!1,!1,"esriSMSCross"===f||"esriSMSX"===f,G.v2.SCREEN,n,0,0,126/64,1,null,null,0,it);return p.boundsType="esriSMSCircle"===f?"circle":"square",p._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/r.size:1,p._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/r.size:1,p}static fromLineSymbolMarker(r,n){const o=(0,B.aH)(r.color),h=Math.round((0,w.F2)(6*r.lineWidth)),c=h,u="cross"===r.style||"x"===r.style;let f;switch(r.placement){case"begin-end":f=G.Tx.Both;break;case"begin":f=G.Tx.JustBegin;break;case"end":f=G.Tx.JustEnd;break;default:f=G.Tx.None}const d={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:f,offsetAlongLine:0},_=new st(r.materialKey,0,0,0,o,h,c,c/6,o,u?Math.round((0,w.F2)(r.lineWidth)):0,!1,!1,u,G.v2.MAP,n,0,0,126/64,1,d,null,0,it);return _.boundsType="circle"===r.style?"circle":"square",_}}var Ct=I(24837),be=I(43289),ds=(I(11915),I(88071)),bi=I(97938),Ii=I(47018);function ms(l,r,n,o,a,h,c){Se=0;const u=(o-n)*h,f=a&&a.length,d=f?(a[0]-n)*h:u;let _,m,p,y,g,x=Ti(r,n,0,0,d,h,!0);if(x&&x.next!==x.prev){if(f&&(x=function xs(l,r,n,o,a,h){const c=new Array;for(let u=0,f=o.length;u<f;u++){const d=Ti(l,r,0,o[u]*h,u<f-1?o[u+1]*h:n*h,h,!1);d===d.next&&(d.steiner=!0),c.push(ps(d))}c.sort(Ts);for(const u of c)gs(u,a),a=Vt(a,a.next);return a}(r,n,o,a,x,h)),u>80*h){_=p=r[0+n*h],m=y=r[1+n*h];for(let M=h;M<d;M+=h){const v=r[M+n*h],b=r[M+1+n*h];_=Math.min(_,v),m=Math.min(m,b),p=Math.max(p,v),y=Math.max(y,b)}g=Math.max(p-_,y-m),g=0!==g?1/g:0}Dt(x,l,h,_,m,g,c,0)}}function Ti(l,r,n,o,a,h,c){let u;if(c===function Is(l,r,n,o,a,h){let c=0;for(let u=o,f=a-h;u<a;u+=h)c+=(l[f+r*h]-l[u+r*h])*(l[u+1+r*h]+l[f+1+r*h]),f=u;return c}(l,r,0,o,a,h)>0)for(let f=o;f<a;f+=h)u=Si(f+r*h,l[f+r*h],l[f+1+r*h],u);else for(let f=a-h;f>=o;f-=h)u=Si(f+r*h,l[f+r*h],l[f+1+r*h],u);return u&&gt(u,u.next)&&(Ot(u),u=u.next),u}function Vt(l,r=l){if(!l)return l;let n,o=l;do{if(n=!1,o.steiner||!gt(o,o.next)&&0!==K(o.prev,o,o.next))o=o.next;else{if(Ot(o),o=r=o.prev,o===o.next)break;n=!0}}while(n||o!==r);return r}function Dt(l,r,n,o,a,h,c,u){if(!l)return;!u&&h&&(l=wi(l,o,a,h));let f=l;for(;l.prev!==l.next;){const d=l.prev,_=l.next;if(h?ys(l,o,a,h):_s(l))r.push(d.index/n+c),r.push(l.index/n+c),r.push(_.index/n+c),Ot(l),l=_.next,f=_.next;else if((l=_)===f){u?1===u?Dt(l=Ss(l,r,n,c),r,n,o,a,h,c,2):2===u&&ws(l,r,n,o,a,h,c):Dt(Vt(l),r,n,o,a,h,c,1);break}}}function _s(l){const r=l.prev,n=l,o=l.next;if(K(r,n,o)>=0)return!1;let a=l.next.next;const h=a;let c=0;for(;a!==l.prev&&(0===c||a!==h);){if(c++,zt(r.x,r.y,n.x,n.y,o.x,o.y,a.x,a.y)&&K(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function ys(l,r,n,o){const a=l.prev,h=l,c=l.next;if(K(a,h,c)>=0)return!1;const d=a.x>h.x?a.x>c.x?a.x:c.x:h.x>c.x?h.x:c.x,_=a.y>h.y?a.y>c.y?a.y:c.y:h.y>c.y?h.y:c.y,m=Ie(a.x<h.x?a.x<c.x?a.x:c.x:h.x<c.x?h.x:c.x,a.y<h.y?a.y<c.y?a.y:c.y:h.y<c.y?h.y:c.y,r,n,o),p=Ie(d,_,r,n,o);let y=l.prevZ,g=l.nextZ;for(;y&&y.z>=m&&g&&g.z<=p;){if(y!==l.prev&&y!==l.next&&zt(a.x,a.y,h.x,h.y,c.x,c.y,y.x,y.y)&&K(y.prev,y,y.next)>=0||(y=y.prevZ,g!==l.prev&&g!==l.next&&zt(a.x,a.y,h.x,h.y,c.x,c.y,g.x,g.y)&&K(g.prev,g,g.next)>=0))return!1;g=g.nextZ}for(;y&&y.z>=m;){if(y!==l.prev&&y!==l.next&&zt(a.x,a.y,h.x,h.y,c.x,c.y,y.x,y.y)&&K(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;g&&g.z<=p;){if(g!==l.prev&&g!==l.next&&zt(a.x,a.y,h.x,h.y,c.x,c.y,g.x,g.y)&&K(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function Si(l,r,n,o){const a=Ft.create(l,r,n);return o?(a.next=o.next,a.prev=o,o.next.prev=a,o.next=a):(a.prev=a,a.next=a),a}function Ot(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function ps(l){let r=l,n=l;do{(r.x<n.x||r.x===n.x&&r.y<n.y)&&(n=r),r=r.next}while(r!==l);return n}function gs(l,r){if(r=function vs(l,r){let n=r;const o=l.x,a=l.y;let h,c=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){const p=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(p<=o&&p>c){if(c=p,p===o){if(a===n.y)return n;if(a===n.next.y)return n.next}h=n.x<n.next.x?n:n.next}}n=n.next}while(n!==r);if(!h)return null;if(o===c)return h.prev;const u=h,f=h.x,d=h.y;let _,m=1/0;for(n=h.next;n!==u;)o>=n.x&&n.x>=f&&o!==n.x&&zt(a<d?o:c,a,f,d,a<d?c:o,a,n.x,n.y)&&(_=Math.abs(a-n.y)/(o-n.x),(_<m||_===m&&n.x>h.x)&&Gt(n,l)&&(h=n,m=_)),n=n.next;return h}(l,r)){const n=Pi(r,l);Vt(n,n.next)}}function wi(l,r,n,o){for(let a;a!==l;a=a.next){if(a=a||l,null===a.z&&(a.z=Ie(a.x,a.y,r,n,o)),a.prev.next!==a||a.next.prev!==a)return a.prev.next=a,a.next.prev=a,wi(l,r,n,o);a.prevZ=a.prev,a.nextZ=a.next}return l.prevZ.nextZ=null,l.prevZ=null,function Ms(l){let r,n=1;for(;;){let o,a=l;l=null,r=null;let h=0;for(;a;){h++,o=a;let c=0;for(;c<n&&o;c++)o=o.nextZ;let u=n;for(;c>0||u>0&&o;){let f;0===c?(f=o,o=o.nextZ,u--):0!==u&&o?a.z<=o.z?(f=a,a=a.nextZ,c--):(f=o,o=o.nextZ,u--):(f=a,a=a.nextZ,c--),r?r.nextZ=f:l=f,f.prevZ=r,r=f}a=o}if(r.nextZ=null,n*=2,h<2)return l}}(l)}function K(l,r,n){return(r.y-l.y)*(n.x-r.x)-(r.x-l.x)*(n.y-r.y)}function Li(l,r,n,o){return!!(gt(l,r)&&gt(n,o)||gt(l,o)&&gt(n,r))||K(l,r,n)>0!=K(l,r,o)>0&&K(n,o,l)>0!=K(n,o,r)>0}function zt(l,r,n,o,a,h,c,u){return(a-c)*(r-u)-(l-c)*(h-u)>=0&&(l-c)*(o-u)-(n-c)*(r-u)>=0&&(n-c)*(h-u)-(a-c)*(o-u)>=0}function Gt(l,r){return K(l.prev,l,l.next)<0?K(l,r,l.next)>=0&&K(l,l.prev,r)>=0:K(l,r,l.prev)<0||K(l,l.next,r)<0}function Ie(l,r,n,o,a){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-n)*a)|l<<8))|l<<4))|l<<2))|l<<1))|(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-o)*a)|r<<8))|r<<4))|r<<2))|r<<1))<<1}function gt(l,r){return l.x===r.x&&l.y===r.y}function Ts(l,r){return l.x-r.x}function Ss(l,r,n,o){let a=l;do{const h=a.prev,c=a.next.next;!gt(h,c)&&Li(h,a,a.next,c)&&Gt(h,c)&&Gt(c,h)&&(r.push(h.index/n+o),r.push(a.index/n+o),r.push(c.index/n+o),Ot(a),Ot(a.next),a=l=c),a=a.next}while(a!==l);return a}function ws(l,r,n,o,a,h,c){let u=l;do{let f=u.next.next;for(;f!==u.prev;){if(u.index!==f.index&&Ls(u,f)){let d=Pi(u,f);return u=Vt(u,u.next),d=Vt(d,d.next),Dt(u,r,n,o,a,h,c,0),void Dt(d,r,n,o,a,h,c,0)}f=f.next}u=u.next}while(u!==l)}function Ls(l,r){return l.next.index!==r.index&&l.prev.index!==r.index&&!function bs(l,r){let n=l;do{if(n.index!==l.index&&n.next.index!==l.index&&n.index!==r.index&&n.next.index!==r.index&&Li(n,n.next,l,r))return!0;n=n.next}while(n!==l);return!1}(l,r)&&Gt(l,r)&&Gt(r,l)&&function Ps(l,r){let n=l,o=!1;const a=(l.x+r.x)/2,h=(l.y+r.y)/2;do{n.y>h!=n.next.y>h&&n.next.y!==n.y&&a<(n.next.x-n.x)*(h-n.y)/(n.next.y-n.y)+n.x&&(o=!o),n=n.next}while(n!==l);return o}(l,r)}function Pi(l,r){const n=Ft.create(l.index,l.x,l.y),o=Ft.create(r.index,r.x,r.y),a=l.next,h=r.prev;return l.next=r,r.prev=l,n.next=a,a.prev=n,o.next=n,n.prev=o,h.next=o,o.prev=h,o}class Ft{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(r,n,o){const a=Se<Te.length?Te[Se++]:new Ft;return a.index=r,a.x=n,a.y=o,a.prev=null,a.next=null,a.z=null,a.prevZ=null,a.nextZ=null,a.steiner=!1,a}}const Te=new Array;let Se=0;for(let l=0;l<8096;l++)Te.push(new Ft);const vt=new Ii.b(0,0,0,1,0),we=new Ii.b(0,0,0,1,0);function Le(l,r,n){let o=0;for(let a=1;a<n;a++)o+=(l[2*(r+a)]-l[2*(r+a-1)])*(l[2*(r+a)+1]+l[2*(r+a-1)+1]);return o}function zs(l,r,n,o,a){let h=0;for(let u=n;u<o;u+=3){const f=2*(l[u]-a),d=2*(l[u+1]-a),_=2*(l[u+2]-a);h+=Math.abs((r[f]-r[_])*(r[d+1]-r[f+1])-(r[f]-r[d])*(r[_+1]-r[f+1]))}return h}vt.setExtent(T.I_),we.setExtent(T.I_);var Us=I(46519);const H=16,Ci=l=>class extends l{constructor(...r){super(...r),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=A.LW.LINE}writeGeometry(r,n,o,a){this._writeGeometry(r,n,o,a)}_initializeTessellator(r){const n=U.a.load(this._materialKey),o=U.dk.load(this._materialKey),a=this._tessellationOptions,c=this.tessellationProperties._halfWidth<T.tQ&&!r&&!(n.vvSizeFieldStops||n.vvSizeMinMaxValue||n.vvSizeScaleStops||n.vvSizeUnitValue);this.tessellationProperties.minMaxZoom=this._minMaxZoom,a.wrapDistance=65535,a.textured=this._isDashed||this._hasPattern,a.offset=this.tessellationProperties.offset,a.halfWidth=this.tessellationProperties._halfWidth;const u=c?0:1,f=(0,U.CA)(o)?Zs:Bs;this._lineTessellator=new Us.z(f(this.tessellationProperties,u,u),Vs(this.tessellationProperties),c)}_write(r,n,o,a){const h="esriGeometryPoint"===n.geometryType;r.recordStart(n.getDisplayId(),this._materialKey,this.geometryType,h),this._writeGeometry(r,n,a,h),r.recordEnd()}_writeGeometry(r,n,o,a){const h=null!=o?o:n.readLegacyGeometryForDisplay(),c=this._getLines(h,a);(0,P.Wi)(c)||this._writeVertices(r,n,c)}_getLines(r,n){if((0,P.Wi)(r))return null;const o=r.paths||r.rings;return(0,P.Wi)(o)?null:function ks(l,r){we.setPixelMargin(r);const n=we,o=-r,a=T.I_+r;let h=[],c=!1,u=0;for(;u<l.length;){const f=[],d=l[u];if(!d)return null;n.reset(bi.V.LineString);let[_,m]=d[0];if(c)n.moveTo(_,m);else{if(_<o||_>a||m<o||m>a){c=!0;continue}f.push({x:_,y:m})}let p=!1;const y=d.length;for(let g=1;g<y;++g)if(_+=d[g][0],m+=d[g][1],c)n.lineTo(_,m);else{if(_<o||_>a||m<o||m>a){p=!0;break}f.push({x:_,y:m})}if(p)c=!0;else{if(c){const g=n.resultWithStarts();if(g)for(const x of g)h.push(x)}else h.push({line:f,start:0});u++,c=!1}}return h=h.filter(f=>f.line.length>1),0===h.length?null:h}(o,n?256:16)}_writeVertices(r,n,o){const a=n.getDisplayId(),h=r.vertexCount(),c=this.tessellationProperties,u=this._tessellationOptions;c.out=r,c.id=a,c.indexCount=0,c.vertexCount=0,c.offset=h,u.capType=this._capType,u.joinType=this._joinType;const f=U.dk.load(this._materialKey);this.tessellationProperties.key=(0,U.CA)(f)?f:U.a.load(this._materialKey);for(const{line:d,start:_}of o)u.initialDistance=_%65535,this._lineTessellator.tessellate(d,u)}},Bs=(l,r,n)=>(o,a,h,c,u,f,d,_,m,p,y)=>{const g=(0,S.UJ)(y,Math.ceil(H*l._halfWidth)),x=(0,S.Jz)(Math.round(H*d),Math.round(H*_),Math.round(H*m),Math.round(H*p)),M=(0,S.Jz)(H*u,H*f,0,l._bitset),v=l.out;return v.vertexBounds(o,a,r,n),v.vertexWrite((0,S.UJ)(8*o,8*a)),v.vertexWrite(l.id),v.vertexWrite(l._fillColor),v.vertexWrite(x),v.vertexWrite(g),v.vertexWrite(l._tl),v.vertexWrite(l._br),v.vertexWrite(M),v.vertexWrite((0,S.UJ)(Math.ceil(H*l._halfReferenceWidth),0)),v.vertexWrite(l.minMaxZoom),v.vertexEnd(),l.offset+l.vertexCount++},Zs=(l,r,n)=>(o,a,h,c,u,f,d,_,m,p,y)=>{const g=(0,S.UJ)(H*l._halfWidth,H*l._halfReferenceWidth),x=(0,S.Jz)(H*d+128,H*_+128,H*m+128,H*p+128),M=l.out,v=l._bitset<<24|l.id;M.vertexBounds(o,a,r,n),M.vertexWrite((0,S.UJ)(8*o,8*a)),M.vertexWrite(v),M.vertexWrite(l._fillColor);const b=(0,U.Xp)(l.key);return b||(M.vertexWrite(0),M.vertexWrite(0)),M.vertexWrite(0),M.vertexWrite(g),M.vertexWrite(x),b||M.vertexWrite(l.minMaxZoom),M.vertexEnd(),l.offset+l.vertexCount++},Vs=l=>(r,n,o)=>{const a=l.out;a.indexWrite(r),a.indexWrite(n),a.indexWrite(o),l.indexCount+=3},Ds=N.Z.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate");class at extends(Ci(Bt)){constructor(r,n,o,a,h,c,u,f,d,_,m,p,y,g,x,M,v,b,L,z){super();const F=U.a.load(r);n&&(F.sdf=n.sdf,F.pattern=!0,F.textureBinding=n.textureBinding),this._capType=a,this._joinType=h,this._miterLimitCosine=xe(c),this.tessellationProperties._fillColor=u,this.tessellationProperties._tl=f,this.tessellationProperties._br=d,this._hasPattern=_,this._isDashed=m,this._zOrder=v,this._effects=b,this._minMaxZoom=(0,S.UJ)(Math.round(L*T.MI),Math.round(z*T.MI)),this._materialKey=F.data,this.tessellationProperties._bitset=(y?T.Uh:0)|(g?T.SD:0)|(p?T._6:0)|(x?T.Iv:0),this.tessellationProperties._halfWidth=.5*o,this.tessellationProperties._halfReferenceWidth=.5*M,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(r,n,o){const a=r.color,h=r.scaleFactor||1,c=!!r.dashTemplate;let u=r.cap;c&&u===G.RL.ROUND&&(u=G.RL.SQUARE);const f=r.join,d=(0,w.F2)(r.width)*h,_=(0,w.F2)(r.referenceWidth),m=(0,w.F2)(r.miterLimit),p=a&&(0,B.t2)(a)||0,[y,g]=dt(r.scaleInfo,o);if(!n)return new at(r.materialKey,n,d,u,f,m,p,0,0,!1,c,r.scaleDash,r.colorLocked,!1,r.sampleAlphaOnly,_,r.zOrder,r.effects,y,g);const{rect:M,width:v,height:b}=n,L=M.x+T.fL,z=M.y+T.fL,F=L+v,E=z+b,Z=(0,S.UJ)(L,z),D=(0,S.UJ)(F,E);return new at(r.materialKey,n,d,u,f,m,p,Z,D,!0,c,r.scaleDash,r.colorLocked,!1,r.sampleAlphaOnly,_,r.zOrder,r.effects,y,g)}static fromFillOutline(r){var o;const n=U.dk.load(r.materialKey);return(0,U.CA)(n)&&r.outline&&"esriSLSSolid"===(null==(o=r.outline)?void 0:o.style)?at.fromSimpleLine(bt({hash:"",materialKey:r.materialKey},r.outline),null,!0):null}static fromSimpleLine(r,n,o=!1){const{color:a}=r,h="esriSLSSolid"!==r.style&&"esriSLSNull"!==r.style,c=(0,kt.ws)(r.cap||"round"),u=(0,kt.xV)(r.join||"round");let f=a&&"esriSLSNull"!==r.style&&(0,B.aH)(a)||0;"esriSLSNull"===r.style&&(f=0);const d=(0,w.F2)(r.width),_=r.miterLimit;if(!n)return new at(r.materialKey,n,d,c,u,_,f,0,0,!1,h,!0,!1,o,!1,d,0,null,0,it);const{rect:m,width:p,height:y}=n,g=m.x+T.fL,x=m.y+T.fL,M=g+p,v=x+y,b=(0,S.UJ)(g,x),L=(0,S.UJ)(M,v);return new at(r.materialKey,n,d,c,u,_,f,b,L,!0,h,!0,!1,o,!1,d,0,null,0,it)}static fromPictureLineSymbol(r,n,o,a){return Ds.error("PictureLineSymbol support does not exist!"),null}}const Fi=l=>class extends l{constructor(...r){super(...r),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=A.LW.FILL}_maybeAddLineTemplate(r){this._lineTemplate=at.fromFillOutline(r)}_write(r,n,o,a){const h="esriGeometryPoint"===n.geometryType,c=U.dk.load(this._materialKey);r.recordStart(n.getDisplayId(),this._materialKey,this.geometryType,h),this._writeGeometry(r,n,c,a,h),(0,U.CA)(c)&&(0,P.pC)(this._lineTemplate)&&this._lineTemplate.writeGeometry(r,n,a,h),r.recordEnd()}_writeGeometry(r,n,o,a,h){const c=this._getGeometry(n,a,h);if((0,P.Wi)(c))return;const u=[];if(!(c.maxLength>100)&&!this.forceLibtess&&function Fs(l,r){const{coords:n,lengths:o,hasIndeterminateRingOrder:a}=r,c=l;if(a)return!1;let u=0;for(let f=0;f<o.length;){let d=f,_=o[f],m=Le(n,u,_);const p=[];for(;++d<o.length;){const M=o[d],v=Le(n,u+_,M);if(!(v>0))break;m+=v,p.push(u+_),_+=M}const y=c.length;ms(c,n,u,u+_,p,2,0);const g=zs(c,n,y,c.length,0),x=Math.abs(m);if(Math.abs((g-x)/Math.max(1e-7,x))>1e-5)return c.length=0,!1;f=d,u+=_}return!0}(u,c))return void(u.length&&this._writeVertices(r,n,c.coords,c.lengths,o,u));const f=function Es(l){const{coords:r,lengths:n}=l,{buffer:o}=(0,li.b)(r,n);return o}(c);this._writeVertices(r,n,f,[f.length/2],o)}_writeVertex(r,n,o,a,h,c){const u=(0,S.UJ)(1*a,1*h);if(r.vertexBounds(a,h,0,0),r.vertexWrite(u),r.vertexWrite(n),o.symbologyType===A.mD.DOT_DENSITY)r.vertexWriteF32(1/Math.abs(c.readGeometryArea()));else{r.vertexWrite(this.fillColor);const f=(0,U.Xp)(o);f||(r.vertexWrite(this.tl),r.vertexWrite(this.br)),r.vertexWrite(this.aux2_1),r.vertexWrite(this.aux2_2),r.vertexWrite(this.aux3),f||r.vertexWrite(this._minMaxZoom)}}_writeVertices(r,n,o,a,h,c){const u=n.getDisplayId(),f=this._bitset<<24|u,d=a.reduce((y,g)=>y+g),_=(0,kt.$_)(h.geometryType,h.symbologyType).geometry/4,m=r.vertexCount();r.vertexEnsureSize(_*d);let p=0;if(c)for(const y of c)this._writeVertex(r,f,h,o[2*y],o[2*y+1],n),p++;else for(let y=0;y<o.length;y+=2){const g=Math.round(o[y]),x=Math.round(o[y+1]);this._writeVertex(r,f,h,g,x,n),p++}r.indexEnsureSize(p);for(let y=0;y<p;y++)r.indexWrite(y+m)}_getGeometry(r,n,o){const a=n?(0,wt.oB)((0,wt.GH)(n),2):r.readGeometryForDisplay();return a?function As(l,r){if((0,P.Wi)(l))return null;if(!function Rs(l,r,n){let o=0;for(let a=0;a<l.lengths.length;a++){const h=l.lengths[a];for(let c=0;c<h;c++){const u=l.coords[2*(c+o)],f=l.coords[2*(c+o)+1];if(u<r||u>n||f<r||f>n)return!0}o+=h}return!1}(l,-128,T.I_+128))return l;vt.setPixelMargin(r),vt.reset(bi.V.Polygon);let n=0;for(let c=0;c<l.lengths.length;c++){const u=l.lengths[c];let f=l.coords[2*(0+n)],d=l.coords[2*(0+n)+1];vt.moveTo(f,d);for(let _=1;_<u;_++)f=l.coords[2*(_+n)],d=l.coords[2*(_+n)+1],vt.lineTo(f,d);vt.close(),n+=u}const o=vt.result(!1);if(!o)return null;const a=[],h=[];for(const c of o){let u=0;for(const f of c)h.push(f.x),h.push(f.y),u++;a.push(u)}return new ds.Z(a,h)}(a,o?256:8):null}};var Ei=I(53141),oe=I(80991);const Ri=N.Z.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class ae extends Bt{constructor(r){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=r}analyze(r,n,o,a,h){if(h&&0===h.length)return null;const c=h&&h.length>0,u=n.readLegacyFeature(),f=n.getObjectId(),d=this._materialCache,_=this._cimLayer.materialHash;if(!_)return Ri.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const m="function"==typeof _?_(u,o,a,f):_;if(d.has(m)){const L=d.get(m);return Promise.resolve(L)}const p=this._ongoingMaterialRequestMap.get(m);if(p)return p;const y=this._cimLayer,g=(0,Ei.S)(y.cim,this._cimLayer.materialOverrides);g.mosaicHash=m;const{type:x,url:M}=y,v={cim:g,type:x,mosaicHash:m,url:M,size:null,dashTemplate:null,text:null,fontName:null,objectId:f,animatedSymbolProperties:null};switch(x){case"marker":v.size=(0,oe.hf)(y.size,u,o,a),v.animatedSymbolProperties=(0,oe.hf)(y.animatedSymbolProperties,u,o,a);break;case"line":v.dashTemplate=y.dashTemplate;break;case"text":v.text=(0,oe.hf)(y.text,u,o,a),v.fontName=(0,oe.hf)(y.fontName,u,o,a)}const b=r.getMosaicItem(v,h).then(L=>(c||(this._ongoingMaterialRequestMap.delete(m),d.set(m,L)),L)).catch(L=>(this._ongoingMaterialRequestMap.delete(m),Ri.error(".analyze()",L.message),null));return c||this._ongoingMaterialRequestMap.set(m,b),b}}function Y(l,r){if(l&&"name"in l){const n=l;return r&&r.error(new W.Z(n.name,n.message,n.details)),!1}return!0}class Pe extends(Fi(ae)){constructor(r,n,o){var _;if(super(r),this._minMaxZoom=(0,S.UJ)(Math.round(n*T.MI),Math.round(o*T.MI)),R(r.color))this._dynamicPropertyMap.set("fillColor",(p,y,g)=>{const x=r.color(p,y,g);return x&&(0,B.t2)(x)||0});else{const m=r.color;this.fillColor=m&&(0,B.t2)(m)||0}const a="CIMMarkerPlacementInsidePolygon"===(null==(_=r.cim.placement)?void 0:_.type)&&r.cim.placement.shiftOddRows?2:1,h=r.height;R(h)?this._dynamicPropertyMap.set("_height",(p,y,g)=>h(p,y,g)*a):this._height=(h||0)*a;const c=r.offsetX;R(c)?this._dynamicPropertyMap.set("_offsetX",(p,y,g)=>(0,w.F2)(c(p,y,g))):this._offsetX=(0,w.F2)(c||0);const u=r.offsetY;R(u)?this._dynamicPropertyMap.set("_offsetY",(p,y,g)=>(0,w.F2)(-u(p,y,g))):this._offsetY=(0,w.F2)(-u||0);const f=r.scaleX;R(f)?this._dynamicPropertyMap.set("_scaleX",f):this._scaleX=f||1;const d=r.angle;if(R(d)?this._dynamicPropertyMap.set("_angle",(p,y,g)=>(0,be.Or)(d(p,y,g))):this._angle=(0,be.Or)(d)||0,(0,P.pC)(r.effects)){const m=r.effects;R(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}this._cimFillLayer=r,this._bitset=(r.colorLocked?T.Uh:0)|(r.applyRandomOffset?T.jk:0)|(r.sampleAlphaOnly?T.Iv:0),this._fillMaterialKey=U.dk.load(r.materialKey)}static fromCIMFill(r,n){const[o,a]=dt(r.scaleInfo,n);return new Pe(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature();this._dynamicPropertyMap.forEach((_,m)=>{this[m]=_(a,n,o)});const h=this._fillMaterialKey,c=this._materialCache,u=(0,this._cimFillLayer.materialHash)(a,n,o),f=c.get(u);let d=null;if(f&&Y(f.spriteMosaicItem)&&(d=f.spriteMosaicItem),d){const{rect:_,width:m,height:p}=d,y=_.x+T.fL,g=_.y+T.fL,x=y+m,M=g+p;let v=Math.round((0,w.F2)(this._height));v<=0&&(v=M-g);let b=Math.round((0,w.F2)(this._height/p*m||0));b<=0&&(b=x-y);const L=this._scaleX,z=1;this.tl=(0,S.UJ)(y,g),this.br=(0,S.UJ)(x,M),this.aux2_1=(0,S.UJ)(b,v),this.aux2_2=(0,S.UJ)(this._offsetX,this._offsetY),this.aux3=(0,S.Jz)(L,z,this._angle,0),h.sdf=d.sdf,h.pattern=!0,h.textureBinding=d.textureBinding}else this.tl=0,this.br=0,this.aux2_1=0,this.aux2_2=0,this.aux3=0,h.sdf=!1,h.pattern=!1,h.textureBinding=0;this._materialKey=h.data}}class We extends(Ci(ae)){constructor(r,n,o){super(r),this._minMaxZoom=(0,S.UJ)(Math.round(n*T.MI),Math.round(o*T.MI)),this._cimLineLayer=r;let a=0;R(r.width)||(a=.5*(0,w.F2)(r.width)),this._dynamicPropertyMap.set("_halfWidth",(m,p,y)=>R(r.width)?.5*(0,w.F2)(r.width(m,p,y)):a),R(r.cap)?this._dynamicPropertyMap.set("_capType",r.cap):this._capType=r.cap,R(r.join)?this._dynamicPropertyMap.set("_joinType",r.join):this._joinType=r.join;const c=r.color;R(c)?this._dynamicPropertyMap.set("_fillColor",(p,y,g)=>(0,B.t2)(c(p,y,g))):this._fillColor=c&&(0,B.t2)(c)||0;const u=r.miterLimit;if(R(u)?this._dynamicPropertyMap.set("_miterLimitCosine",(p,y,g)=>xe(u(p,y,g))):this._miterLimitCosine=xe(u),(0,P.pC)(r.effects)){const m=r.effects;R(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}this._scaleFactor=r.scaleFactor||1,this._isDashed=null!=r.dashTemplate,this.tessellationProperties._bitset=(r.colorLocked?T.Uh:0)|(r.scaleDash?T._6:0)|(r.sampleAlphaOnly?T.Iv:0),this._materialKey=r.materialKey,this._initializeTessellator(!0)}static fromCIMLine(r,n){const[o,a]=dt(r.scaleInfo,n);return new We(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature();this._dynamicPropertyMap.forEach((_,m)=>{this[m]=_(a,n,o)}),this._halfWidth*=this._scaleFactor;const h=this._materialCache,c=(0,this._cimLineLayer.materialHash)(a,n,o),u=h.get(c);let f=null;if(u&&Y(u.spriteMosaicItem)&&(f=u.spriteMosaicItem),f){this._hasPattern=!0;const{rect:_,width:m,height:p}=f,y=_.x+T.fL,g=_.y+T.fL,x=y+m,M=g+p;this.tessellationProperties._tl=(0,S.UJ)(y,g),this.tessellationProperties._br=(0,S.UJ)(x,M)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const d=U.a.load(this._materialKey);f&&(d.sdf=f.sdf,d.pattern=!0,d.textureBinding=f.textureBinding),this._materialKey=d.data}}const Gs=(0,re.c)(),Ks=(0,Me.c)(),Ns=N.Z.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate");class Ce extends(Mi(ae)){constructor(r,n,o){super(r),this._cimMarkerLayer=r,this._minMaxZoom=(0,S.UJ)(Math.round(n*T.MI),Math.round(o*T.MI));const a=r.color;R(a)?this._dynamicPropertyMap.set("_fillColor",(y,g,x)=>(0,B.t2)(a(y,g,x))):this._fillColor=(0,B.t2)(a);const h=r.outlineColor;R(h)?this._dynamicPropertyMap.set("_outlineColor",(y,g,x)=>(0,B.t2)(h(y,g,x))):this._outlineColor=(0,B.t2)(h);const c=r.size;R(c)?this._dynamicPropertyMap.set("_size",(y,g,x)=>(0,w.F2)(c(y,g,x))):this._size=(0,w.F2)(c)||0;const u=r.scaleX;R(u)?this._dynamicPropertyMap.set("_scaleX",u):this._scaleX=u||1;const f=r.offsetX;R(f)?this._dynamicPropertyMap.set("xOffset",(y,g,x)=>(0,w.F2)(f(y,g,x))):this.xOffset=(0,w.F2)(f)||0;const d=r.offsetY;R(d)?this._dynamicPropertyMap.set("yOffset",(y,g,x)=>(0,w.F2)(d(y,g,x))):this.yOffset=(0,w.F2)(d)||0;const _=r.outlineWidth;R(_)?this._dynamicPropertyMap.set("_outlineWidth",(y,g,x)=>(0,w.F2)(_(y,g,x))):this._outlineWidth=(0,w.F2)(_)||0;const m=r.rotation;if(R(m)?this._dynamicPropertyMap.set("_angle",m):this._angle=m||0,(0,P.pC)(r.effects)){const p=r.effects;R(p)?this._dynamicPropertyMap.set("_effects",p):this._effects=p}if((0,P.pC)(r.markerPlacement)){const p=r.markerPlacement;R(p)?this._dynamicPropertyMap.set("_markerPlacement",p):this._markerPlacement=p}this._scaleFactor=(0,P.Pt)(r.scaleFactor,1),this._bitSet=(r.alignment===G.v2.MAP?1:0)|(r.colorLocked?1:0)<<1|(r.scaleSymbolsProportionally?1:0)<<3,this._materialKey=r.materialKey}static fromCIMMarker(r,n){const[o,a]=dt(r.scaleInfo,n);return new Ce(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature(),h=r.getObjectId();this._dynamicPropertyMap.forEach((Rt,At)=>{this[At]=Rt(a,n,o)});const c=this._cimMarkerLayer.materialHash,u="function"==typeof c?c(a,n,o,h):c,f=this._materialCache.get(u);if(!f||!Y(f.spriteMosaicItem)||!f.spriteMosaicItem)return void Ns.error(new W.Z("mapview-cim","Encountered an error when binding feature"));const d=f.spriteMosaicItem,_=this._cimMarkerLayer.sizeRatio,m=d.width/d.height*this._scaleX,p=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let y=this._size,g=y*m;const x=this.xOffset,M=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const v=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/(0,w.F2)(this._cimMarkerLayer.frameHeight):1,b=this._outlineWidth*v,L=(0,w.F2)(this._cimMarkerLayer.referenceSize);let z=0,F=0;const E=this._cimMarkerLayer.anchorPoint;E&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(z=-E.x/(this._size*m),F=E.y/this._size):(z=E.x,F=E.y)),this._sizeOutlineWidth=(0,S.Jz)(Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*b),255)),Math.round(Math.min(Math.sqrt(128*L),255))),this.angle=p;const Z=Math.round(64*_);this._bitestAndDistRatio=(0,S.UJ)(this._bitSet,Z);const D=d.rect.x+T.fL,ct=d.rect.y+T.fL,_t=D+d.width,yt=ct+d.height;this._texUpperLeft=(0,S.UJ)(D,ct),this._texUpperRight=(0,S.UJ)(_t,ct),this._texBottomLeft=(0,S.UJ)(D,yt),this._texBottomRight=(0,S.UJ)(_t,yt);const nt=U.mE.load(this._materialKey);nt.sdf=d.sdf,nt.pattern=!0,nt.textureBinding=d.textureBinding,this._materialKey=nt.data,this._anchorX=.5-(.5+z)*d.width/d.width,this._anchorY=.5-(.5+F)*d.height/d.height,g*=_,y*=_,g*=this._scaleFactor,y*=this._scaleFactor,g*=d.rect.width/d.width,y*=d.rect.height/d.height,this._computedWidth=g,this._computedHeight=y,this._applyTransformation(Ks,Gs),this.xOffset=x,this.yOffset=M}}function ze(l){const r=new Array(l.length);for(let n=0;n<l.length;n++)r[n]=l.charCodeAt(n);return r}class Fe extends(yi(ae)){constructor(r,n,o){super(r),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=(0,S.UJ)(Math.round(n*T.MI),Math.round(o*T.MI));const a=r.scaleFactor||1;this._cimTextLayer=r;const h=r.color;R(h)?this._dynamicPropertyMap.set("_color",(M,v,b)=>(0,B.t2)(h(M,v,b))):this._color=(0,B.t2)(h);const c=r.outlineColor;let u,d,m;if(R(c)?this._dynamicPropertyMap.set("_haloColor",(M,v,b)=>(0,B.t2)(c(M,v,b))):this._haloColor=(0,B.t2)(c),R(r.size)||(u=Math.min(Math.round((0,w.F2)(r.size*r.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",(x,M,v)=>R(r.size)?Math.min(Math.round((0,w.F2)(r.size(x,M,v)*r.sizeRatio)),127):u),R(r.outlineSize)?this._dynamicPropertyMap.set("_haloSize",(M,v,b)=>Math.min(Math.floor(5*(0,w.F2)(r.outlineSize(M,v,b)*r.sizeRatio)),127)):this._haloSize=Math.min(Math.floor(5*(0,w.F2)(r.outlineSize*r.sizeRatio)),127),R(r.offsetX)||(d=Math.round((0,w.F2)(r.offsetX*r.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",(x,M,v)=>R(r.offsetX)?Math.round((0,w.F2)(r.offsetX(x,M,v)*r.sizeRatio)):d),R(r.offsetY)||(m=Math.round((0,w.F2)(r.offsetY*r.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",(x,M,v)=>R(r.offsetY)?Math.round((0,w.F2)(r.offsetY(x,M,v)*r.sizeRatio)):m),R(r.angle)?this._dynamicPropertyMap.set("_angle",r.angle):this._angle=r.angle,R(r.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",r.horizontalAlignment):this._horizontalAlignment=r.horizontalAlignment,R(r.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",r.verticalAlignment):this._verticalAlignment=r.verticalAlignment,(0,P.pC)(r.effects)){const x=r.effects;R(x)?this._dynamicPropertyMap.set("_effects",x):this._effects=x}if((0,P.pC)(r.markerPlacement)){const x=r.markerPlacement;R(x)?this._dynamicPropertyMap.set("_markerPlacement",x):this._textPlacement=x}R(r.text)?this._dynamicPropertyMap.set("_text",r.text):this._text=r.text,this._scaleFactor=a;const y=Math.min(Math.round((0,w.F2)(r.referenceSize*r.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*y)),this._materialKey=r.materialKey;const g=U.qr.load(this._materialKey);g.sdf=!0,this._bitset=(r.alignment===G.v2.MAP?1:0)|(r.colorLocked?1:0)<<1,this._materialKey=g.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(r,n){const[o,a]=dt(r.scaleInfo,n);return new Fe(r,o,a)}analyze(r,n,o,a){var h=()=>super.analyze,c=this;return(0,C.Z)(function*(){const u=n.readLegacyFeature(),f=function Js(l,r,n,o){return"string"==typeof l.text?l.text:"function"==typeof l.text?l.text(r,n,o):""}(c._cimTextLayer,u,o,a),d=yield h().call(c,r,n,o,a,ze(f));return d&&d.glyphMosaicItems&&c._textToGlyphs.set(f,d.glyphMosaicItems),d})()}bindFeature(r,n,o){const a=r.readLegacyFeature();if(this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(a,n,o)}),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/T.Ex,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=(0,ot.kH)((0,P.Pt)(this._horizontalAlignment,"center")),this._yAlignD=(0,ot.b7)((0,P.Pt)(this._verticalAlignment,"baseline"));const h=this._textToGlyphs.get(this._text);this.bindTextInfo(h,!1)}}class lt extends(Fi(Bt)){constructor(r,n,o,a,h,c,u,f,d,_,m,p,y,g,x,M){super(),this._effects=g;const v=U.dk.load(r);n&&(v.sdf=n.sdf,v.pattern=!0,v.textureBinding=n.textureBinding),this.fillColor=o,this.tl=a,this.br=h,this.aux2_1=(0,S.UJ)(c,u),this.aux2_2=(0,S.UJ)(f,d),this.aux3=(0,S.Jz)(_,m,p,0),this._bitset=y,this._minMaxZoom=(0,S.UJ)(Math.round(x*T.MI),Math.round(M*T.MI)),this._materialKey=v.data}static fromCIMFill(r,n,o){const a=r.color,h=a&&(0,B.t2)(a)||0,c=r.materialKey,[u,f]=dt(r.scaleInfo,o),d=(r.colorLocked?T.Uh:0)|(r.applyRandomOffset?T.jk:0)|(r.sampleAlphaOnly?T.Iv:0);if(!n)return new lt(c,null,h,0,0,0,0,0,0,0,0,0,d,r.effects,u,f);const{rect:_,width:m,height:p}=n,g=_.x+T.fL,x=_.y+T.fL,M=g+m,v=x+p,b=r.height,L=(r.scaleX||1)*b;let z=Math.round(b);z<=0&&(z=v-x);let F=Math.round(L);F<=0&&(F=M-g);const E=(0,w.F2)(r.offsetX||0),Z=(0,w.F2)(-r.offsetY||0),D=(0,S.UJ)(g,x),ct=(0,S.UJ)(M,v);return new lt(c,n,h,D,ct,F,z,E,Z,128,128,(0,be.s5)(r.angle),d,r.effects,u,f)}static fromSimpleFill(r,n,o=!1){const{color:a}=r,h=a&&"esriSFSNull"!==r.style&&(0,B.aH)(a)||0,c=o?T.Uh:0,u=r.materialKey;let f;if(n){const{rect:d,width:_,height:m}=n,p=d.x+T.fL,y=d.y+T.fL,g=p+_,x=y+m,M=(0,S.UJ)(p,y),v=(0,S.UJ)(g,x);f=new lt(u,n,h,M,v,_,m,0,0,128,128,0,c,null,0,it)}else f=new lt(u,null,h,0,0,0,0,0,0,0,0,0,c,null,0,it);return f._maybeAddLineTemplate(r),f}static fromPictureFill(r,n,o=!1){const a=T.ru,{rect:h,width:c,height:u}=n,f=h.x+T.fL,d=h.y+T.fL,_=f+c,m=d+u,p=(0,S.UJ)(f,d),y=(0,S.UJ)(_,m),g=Math.round((0,w.F2)(r.width)),x=Math.round((0,w.F2)(r.height)),M=(0,w.F2)(r.xoffset),v=(0,w.F2)(-r.yoffset),z=new lt(r.materialKey,n,a,p,y,g,x,M,v,128*r.xscale,128*r.yscale,0,o?T.Uh:0,null,0,it);return z._maybeAddLineTemplate(r),z}}class Hs{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){var r=this;return(0,C.Z)(function*(){r._resolver?(yield r._resolver.promise,yield r.acquire()):r._resolver=(0,J.hh)()})()}release(){const r=this._resolver;this._resolver=null,r.resolve()}}function Ee(){return(Ee=(0,C.Z)(function*(l,r,n){try{yield l.acquire(),yield r(n),l.release()}catch(o){throw l.release(),o}})).apply(this,arguments)}const Ys={marker:A.LW.MARKER,fill:A.LW.FILL,line:A.LW.LINE,text:A.LW.TEXT};class js{constructor(r,n,o,a){const h={minScale:null==n?void 0:n.minScale,maxScale:null==n?void 0:n.maxScale},c=function Qs(l){return l.minScale||l.maxScale?l.minScale+"-"+l.maxScale:""}(h);this.layers=r,this.data=n,this.hash=this._createHash()+c,this.rendererKey=o;const u={isOutline:!1,placement:null,symbologyType:A.mD.DEFAULT,vvFlags:o};for(const f of r){const d=Ys[f.type];u.isOutline="line"===f.type&&f.isOutline,f.materialKey=(0,U.jj)(d,u),f.maxVVSize=a,f.scaleInfo=h,f.templateHash+=c}}get type(){return"expanded-cim"}_createHash(){let r="";for(const n of this.layers)r+=n.templateHash;return r}}var ki=I(83100),$s=I(21726),qs=I(84687),tr=I(29840),Mt=I(71937);function er(l,r,n){return Re.apply(this,arguments)}function Re(){return(Re=(0,C.Z)(function*(l,r,n){if(!l.name)throw new W.Z("style-symbol-reference-name-missing","Missing name in style symbol reference");if(l.styleName&&"Esri2DPointSymbolsStyle"===l.styleName)return ir(l,n);try{return sr(yield(0,Mt.n2)(l,r,n),l.name,r,n)}catch(o){return(0,J.k_)(o),null}})).apply(this,arguments)}function ir(l,r){return Ae.apply(this,arguments)}function Ae(){return(Ae=(0,C.Z)(function*(l,r){const n=Mt.wm.replace(/\{SymbolName\}/gi,l.name);try{const o=yield(0,Mt.EJ)(n,r);return(0,Mt.KV)(o.data)}catch(o){return(0,J.k_)(o),null}})).apply(this,arguments)}function sr(l,r,n,o){return ke.apply(this,arguments)}function ke(){return(ke=(0,C.Z)(function*(l,r,n,o){const a=l.data,h={portal:n&&(0,P.pC)(n.portal)?n.portal:qs.Z.getDefault(),url:(0,$s.mN)(l.baseUrl),origin:"portal-item"},c=a.items.find(f=>f.name===r);if(!c)throw new W.Z("symbolstyleutils:symbol-name-not-found",`The symbol name '${r}' could not be found`,{symbolName:r});let u=(0,tr.f)((0,Mt.v9)(c,"cimRef"),h);(0,ki.XO)()&&(u=(0,ki.pJ)(u));try{const f=yield(0,Mt.EJ)(u,o);return(0,Mt.KV)(f.data)}catch(f){return(0,J.k_)(f),null}})).apply(this,arguments)}const Ui=function(){var l=(0,C.Z)(function*(r,n,o){return new js(yield(0,Ei.c)(r.data,n,o),r.data,r.rendererKey,r.maxVVSize)});return function(n,o,a){return l.apply(this,arguments)}}(),rt=function(){var l=(0,C.Z)(function*(r,n,o,a){if(!r)return null;if("cim"===r.type)return Ui(r,n,o);if("web-style"===r.type){const h={type:"cim",data:yield er(r,null,a),rendererKey:r.rendererKey,maxVVSize:r.maxVVSize};return Ui(h,n,o)}return r});return function(n,o,a,h){return l.apply(this,arguments)}}();function le(l){if(!l)return null;const{type:r,cim:n,url:o,materialHash:a}=l,h={cim:n,type:r,mosaicHash:a,url:o,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null};switch(r){case"marker":h.size=l.size,h.path=l.path,h.animatedSymbolProperties=l.animatedSymbolProperties;break;case"line":h.dashTemplate=l.dashTemplate;break;case"text":h.text=l.text,h.fontName=l.fontName}return h}const X=N.Z.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),Bi=new Array,Ue={isOutline:!1,placement:null,symbologyType:A.mD.DEFAULT,vvFlags:0},rr=Nt(bt({},Ct.eG),{hash:JSON.stringify(Ct.eG),materialKey:(0,U.jj)(A.LW.MARKER,Ue)}),nr=Nt(bt({},Ct.wW),{hash:JSON.stringify(Ct.wW),materialKey:(0,U.jj)(A.LW.LINE,Ue)}),or=Nt(bt({},Ct.lj),{hash:JSON.stringify(Ct.lj),materialKey:(0,U.jj)(A.LW.FILL,Ue)});function ht(l,r){const n=l.length;return l.push(null),r.then(o=>l[n]=o),l}function Kt(l){return!!(1&l)}class lr{constructor(r,n){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new Hs,this._fetchResource=r,this._tileInfo=n}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(r,n){this._initErrorTemplates();const o=r.hash;if(this._symbolToTemplate.has(o))return this._symbolToTemplate.get(o);const a=new Array;n&&this._createMeshTemplates(a,n,!0),this._createMeshTemplates(a,r,!1);const h=this._createGroupId("expanded-cim"===r.type&&hr(r));return this._idToTemplateGroup.set(h,a),this._symbolToTemplate.set(o,h),h}getTemplateGroup(r){return this._idToTemplateGroup.has(r)?this._idToTemplateGroup.get(r):Bi}getDynamicTemplateGroup(r){return this._idToTemplateGroup.has(r)?(Kt(r)||X.error("mapview-template-store",`Id ${r} does not refer to a dynamic template`),this._idToTemplateGroup.get(r)):Bi}getMosaicItem(r,n){const o=this._createTemplateId(),a=new Promise(h=>this._idToResolver.set(o,h));return this._fetchQueue.push({symbol:r,id:o,glyphIds:n}),a}finalize(r){return this._fetchQueue.length||this._lock.isHeld()?function Xs(l,r,n){return Ee.apply(this,arguments)}(this._lock,this._fetchAllQueuedResources.bind(this),r):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],or,!1),marker:this._createMeshTemplates([],rr,!1),line:this._createMeshTemplates([],nr,!1)})}_fetchAllQueuedResources(r){if(!this._fetchQueue.length)return Promise.resolve();const n=this._fetchQueue,o=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(o).then(()=>this._fetchResource(n,r).then(a=>{for(const{id:h,mosaicItem:c}of a)this._idToResolver.get(h)(c),this._idToResolver.delete(h)})).catch(a=>{(0,J.D_)(a)?this._fetchQueue=this._fetchQueue.concat(n):function ar(l){return"worker:port-closed"===l.name}(a)||X.error(new W.Z("mapview-template-store","Unable to fetch requested texture resources",a))})}_createGroupId(r){return this._idCounter++<<1|(r?1:0)}_createTemplateId(){return this._templateIdCounter++}_createSMS(r){var n=this;return(0,C.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return Y(o,X)?st.fromSimpleMarker(r,o):n._markerError})()}_createPMS(r){var n=this;return(0,C.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return Y(o,X)?st.fromPictureMarker(r,o):n._markerError})()}_createSFS(r,n){var o=this;return(0,C.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return Y(a,X)?lt.fromSimpleFill(r,a,n):o._fillError})()}_createPFS(r,n){var o=this;return(0,C.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return Y(a,X)?lt.fromPictureFill(r,a,n):o._fillError})()}_createSLS(r,n){var o=this;return(0,C.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return Y(a,X)?at.fromSimpleLine(r,a):o._lineError})()}_createLMS(r){var n=this;return(0,C.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return Y(o,X)?st.fromLineSymbolMarker(r,o):n._markerError})()}_createTS(r){var n=this;return(0,C.Z)(function*(){const{glyphMosaicItems:o}=yield n.getMosaicItem(r);return Lt.fromText(r,o)})()}_createCIMText(r){var n=this;return(0,C.Z)(function*(){const{glyphMosaicItems:o}=yield n.getMosaicItem(le(r),ze(r.text));return Y(o,X)?Lt.fromCIMText(r,o,n._tileInfo):n._textError})()}_createCIMFill(r){var n=this;return(0,C.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(le(r));return Y(o,X)?lt.fromCIMFill(r,o,n._tileInfo):n._fillError})()}_createCIMLine(r){var n=this;return(0,C.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(le(r));return Y(o,X)?at.fromCIMLine(r,o,n._tileInfo):n._lineError})()}_createCIMMarker(r){var n=this;return(0,C.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(le(r));return Y(o,X)?st.fromCIMMarker(r,o,n._tileInfo):n._markerError})()}_createCIM(r){var n=this;return(0,C.Z)(function*(){const o=r.templateHash;if(n._cimTemplateCache.has(o))return n._cimTemplateCache.get(o);let a;switch(r.type){case"marker":a=yield n._createCIMMarker(r);break;case"line":a=yield n._createCIMLine(r);break;case"fill":a=yield n._createCIMFill(r);break;case"text":a=yield n._createCIMText(r)}return n._cimTemplateCache.set(o,a),a})()}_createDynamicCIM(r){var n=this;return(0,C.Z)(function*(){const o=r.templateHash;if(n._cimTemplateCache.has(o))return n._cimTemplateCache.get(o);let a;switch(r.type){case"marker":a=Ce.fromCIMMarker(r,n._tileInfo);break;case"line":a=We.fromCIMLine(r,n._tileInfo);break;case"fill":a=Pe.fromCIMFill(r,n._tileInfo);break;case"text":a=Fe.fromCIMText(r,n._tileInfo)}return n._cimTemplateCache.set(o,a),a})()}_createPrimitiveMeshTemplates(r,n,o){switch(n.type){case"esriSMS":return ht(r,this._createSMS(n));case"esriPMS":return ht(r,this._createPMS(n));case"esriSFS":return ht(r,this._createSFS(n,o));case"line-marker":return ht(r,this._createLMS(n));case"esriPFS":return ht(r,this._createPFS(n,o));case"esriSLS":return ht(r,this._createSLS(n,!1));case"esriTS":return ht(r,this._createTS(n));default:return X.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),r}}_createMeshTemplates(r,n,o){if(n.type.includes("3d"))return X.error("3D symbols are not supported with MapView"),r;if("expanded-cim"===n.type){for(const a of n.layers)ht(r,"function"==typeof a.materialHash?this._createDynamicCIM(a):this._createCIM(a));return r}if("composite-symbol"===n.type){for(const a of n.layers)this._createPrimitiveMeshTemplates(r,a,o);return r}return"cim"===n.type||"label"===n.type||"web-style"===n.type?r:this._createPrimitiveMeshTemplates(r,n,o)}}const hr=l=>{if(!l.layers)return!1;for(const r of l.layers)if("function"==typeof r.materialHash)return!0;return!1};class cr{constructor(r,n,o){this._loadPromise=(0,li.j)(),this._geometryType=r,this._idField=n,this._templateStore=o}update(r,n){(0,P.pC)(r.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(r.mesh.labels,n)),this._schema=r}_createLabelTemplates(r,n){const o=new Map;if("simple"===r.type){for(const a of r.classes){const h=se.fromLabelClass(a,n);o.set(a.index,h)}return o}for(const a in r.classes){const h=r.classes[a];for(const c of h){const u=se.fromLabelClass(c,n);o.set(c.index,u)}}return o}get templates(){return this._templateStore}analyze(r,n,o,a,h,c,u){var f=this;return(0,C.Z)(function*(){if((0,J.Hc)(u))return;let d;"dictionary"===o.type&&(d=yield o.analyze(f._idField,r.copy(),n,h,c,u));let _=0;for(;r.next();){let m;if(m=d?d[_++]:(0,P.pC)(a)&&(0,ue.nE)(r.getDisplayId())&&1!==r.readAttribute("cluster_count")?a.match(f._idField,r,f._geometryType,h,c):o.match(f._idField,r,f._geometryType,h,c),r.setGroupId(m),Kt(m)){const p=f._templateStore.getDynamicTemplateGroup(m);for(const y of p)y&&y.analyze&&y.analyze(f._templateStore,r,h,c)}}return yield f._loadPromise,f._templateStore.finalize(u)})()}analyzeGraphics(r,n,o,a,h,c){var u=this;return(0,C.Z)(function*(){if((0,J.Hc)(c))return;const f=r.getCursor();for(o&&(yield o.analyze(u._idField,f.copy(),n,a,h,c));f.next();){let d=f.getGroupId();if(null!=d&&-1!==d||(d=o.match(u._idField,f,f.geometryType,a,h),f.setGroupId(d)),Kt(d)){const _=u._templateStore.getDynamicTemplateGroup(d);for(const m of _)m&&m.analyze&&m.analyze(u._templateStore,f,a,h)}f.setGroupId(d)}return yield u._loadPromise,u._templateStore.finalize(c)})()}writeGraphic(r,n,o,a){const h=n.getGroupId(),c=n.getDisplayId(),u=this._templateStore.getTemplateGroup(h);if(r.featureStart(n.insertAfter,0),null!=c){if(Kt(h))for(const f of u)f&&f.bindFeature(n,null,null);if(u){for(const f of u)f&&f.write(r,n,o,a);r.featureEnd()}}}writeCursor(r,n,o,a,h,c,u){const f=n.getGroupId(),d=n.getDisplayId(),_=this._templateStore.getTemplateGroup(f),m=this._schema.mesh.sortKey;let p=0;if((0,P.pC)(m)&&(p=null!=m.fieldIndex?n.getComputedNumericAtIndex(m.fieldIndex):n.readAttribute(null!=m.field?m.field:this._idField),p*="asc"===m.order?1:-1),r.featureStart(0,null==p||isNaN(p)?0:p),null!=d&&_){if(Kt(f))for(const y of _)y.bindFeature(n,o,a);for(const y of _)y.write(r,n,h,u);if((0,P.pC)(c)&&r.hasRecords){const y=c&&this._findLabelRef(_);this._writeLabels(r,n,c,y,h,u)}r.featureEnd()}}_findLabelRef(r){for(const n of r)if(n instanceof st)return n;return null}_writeLabels(r,n,o,a,h,c){for(const u of o)if((0,P.pC)(u)&&u){const{glyphs:f,rtl:d,index:_}=u,m=this._labelTemplates.get(_);m.setZoomLevel(h),m.bindReferenceTemplate(a),m.bindTextInfo(f,d),m.write(r,n,null,c)}}}var ur=I(93961),fr=I(46679),dr=I(39236);const Be=N.Z.getLogger("esri/views/2d/engine/webgl/util/Matcher");function Ze(l,r,n,o){return Ve.apply(this,arguments)}function Ve(){return(Ve=(0,C.Z)(function*(l,r,n,o){switch(l.type){case"simple":case"heatmap":return mt.fromBasicRenderer(l,r,n,o);case"map":return Oe.fromUVRenderer(l,r,n,o);case"interval":return De.fromCBRenderer(l,r,n,o);case"dictionary":return Je.fromDictionaryRenderer(l,r,n,o);case"pie-chart":return he.fromPieChartRenderer(l,r,n,o);case"subtype":return he.fromSubtypes(l,r,n,o)}})).apply(this,arguments)}class mt{constructor(){this.type="feature",this._defaultResult=null}static fromBasicRenderer(r,n,o,a){return(0,C.Z)(function*(){const h=new mt;if(r.symbol){const c=yield rt(r.symbol,o,a),u=n.createTemplateGroup(c,null);h.setDefault(u)}return h})()}static fromPieChartRenderer(r,n,o,a){return(0,C.Z)(function*(){const h=new mt;if(r.markerSymbol){const c=yield rt(r.markerSymbol,o,a);let u;r.fillSymbol&&(u=yield rt(r.fillSymbol,o,a));const f=n.createTemplateGroup(c,u);h.setDefault(f)}return h})()}size(){return 1}getDefault(){return this._defaultResult}setDefault(r){this._defaultResult=r}match(r,n,o,a,h){return this.getDefault()}analyze(r,n,o,a,h,c){return(0,C.Z)(function*(){return null})()}}class he extends mt{constructor(r,n){super(),this._subMatchers=r,this._subtypeField=n}static fromSubtypes(r,n,o,a){return(0,C.Z)(function*(){const h=new Map,c=[];for(const u in r.renderers){const f=parseInt(u,10),d=Ze(r.renderers[u],n,o,a).then(_=>h.set(f,_));c.push(d)}return yield Promise.all(c),new he(h,r.subtypeField)})()}match(r,n,o,a,h){const c=n.readAttribute(this._subtypeField),u=this._subMatchers.get(c);return u?u.match(r,n,o,a,h):null}}class De extends mt{constructor(r,n,o,a){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=n,this._fieldIndex=a,this._field=r,this._normalizationInfo=o}static fromCBRenderer(r,n,o,a){return(0,C.Z)(function*(){const{isMaxInclusive:h,normalizationField:c,normalizationTotal:u,normalizationType:f}=r,_=new De(r.field,h,{normalizationField:c,normalizationTotal:u,normalizationType:f},r.fieldIndex),m=yield rt(r.backgroundFillSymbol,o,a);yield Promise.all(r.intervals.map(function(){var y=(0,C.Z)(function*(g){const x=yield rt(g.symbol,o,a),M=yield n.createTemplateGroup(x,m);_.add({min:g.min,max:g.max},M)});return function(g){return y.apply(this,arguments)}}()));const p=yield rt(r.defaultSymbol,o,a);if(p){const y=yield n.createTemplateGroup(p,m);_.setDefault(y)}return _})()}add(r,n){this._intervals.push({interval:r,result:n}),this._intervals.sort((o,a)=>o.interval.min-a.interval.min)}size(){return super.size()+this._intervals.length}match(r,n,o,a,h){if(null==this._fieldIndex&&!this._field)return this.getDefault();const c=null!=this._fieldIndex?n.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(n);if(!c&&(null==c||isNaN(c)))return this.getDefault();for(let u=0;u<this._intervals.length;u++){const{interval:f,result:d}=this._intervals[u],m=this._isMaxInclusive?c<=f.max:c<f.max;if(c>=f.min&&m)return d}return this.getDefault()}_needsNormalization(){const r=this._normalizationInfo;return r&&(r.normalizationField||r.normalizationTotal||r.normalizationType)}_getValueFromField(r){const n=r.readAttribute(this._field);if(!this._needsNormalization()||null==n)return n;const{normalizationField:o,normalizationTotal:a,normalizationType:h}=this._normalizationInfo,c=!!o&&r.readAttribute(o);if(h)switch(h){case"esriNormalizeByField":return c?n/c:void 0;case"esriNormalizeByLog":return Math.log(n)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return n/a*100;default:return void Be.error(`Found unknown normalization type: ${h}`)}else Be.error("Normalization is required, but no type was set!")}}class Oe extends mt{constructor(r,n,o){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fieldsIndex=o,this._fields=r,this._seperator=n||""}static fromUVRenderer(r,n,o,a){return(0,C.Z)(function*(){const h=r.fieldDelimiter,c=[r.field];r.field2&&c.push(r.field2),r.field3&&c.push(r.field3);const u=yield rt(r.backgroundFillSymbol,o,a),f=new Oe(c,h,r.fieldIndex);yield Promise.all(r.map.map(function(){var _=(0,C.Z)(function*(m){const p=yield rt(m.symbol,o,a),y=yield n.createTemplateGroup(p,u);"<Null>"===m.value?f.setNullResult(y):f.add(m.value,y)});return function(m){return _.apply(this,arguments)}}()));const d=yield rt(r.defaultSymbol,o,a);if(d){const _=yield n.createTemplateGroup(d,u);f.setDefault(_)}return f})()}setNullResult(r){this._nullResult=r}add(r,n){this._resultsMap.set(r.toString(),n)}size(){return super.size()+this._resultsMap.size}match(r,n,o,a,h){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const c=null!=this._fieldsIndex?n.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(n);if(null!==this._nullResult&&(null==c||""===c||"<Null>"===c))return this._nullResult;if(!c&&null==c)return this.getDefault();const u=c.toString();return this._resultsMap.has(u)?this._resultsMap.get(u):this.getDefault()}_getValueFromFields(r){const n=[];for(const o of this._fields){const a=r.readAttribute(o);n.push(null==a||""===a?"<Null>":a)}return n.join(this._seperator)}}function Ge(){return(Ge=(0,C.Z)(function*(l,r){const n=l||1;if("number"==typeof n)return(a,h,c)=>n;const o=yield(0,fr.Yi)(n,r.spatialReference,r.fields);return(a,h,c)=>(0,dr.Z)(o,a,{$view:c},r.geometryType,h)||1})).apply(this,arguments)}let Ke;function _r(){return Ne.apply(this,arguments)}function Ne(){return(Ne=(0,C.Z)(function*(){return Ke||(Ke=I.e(3250).then(I.bind(I,3250))),Ke})).apply(this,arguments)}class Je extends mt{constructor(r,n,o,a,h,c){super(),this.type="dictionary",this._groupIdCache=new ur.Z(100),this._loader=r,this._fieldMap=r.fieldMap,this._symbolFields=r.getSymbolFields(),this._templates=n,this._info=o,this._scaleFn=a,this._schemaUtilsModule=h,this._symbolOptions=c}static fromDictionaryRenderer(r,n,o,a){return(0,C.Z)(function*(){const[{DictionaryLoader:h},c]=yield Promise.all([Promise.resolve().then(I.bind(I,29996)),_r()]),u=new h(r.url,r.config,r.fieldMap);yield u.fetchResources({spatialReference:o.spatialReference,fields:o.fields});const f=yield function mr(l,r){return Ge.apply(this,arguments)}(r.scaleExpression,o);return new Je(u,n,o,f,c,r.symbolOptions)})()}_analyzeFeature(r,n,o,a,h){var c=this;return(0,C.Z)(function*(){const u=r.readLegacyFeature(),f=c._scaleFn(u,o,a),d=c._attributeHash(u)+"-"+f,_=c._groupIdCache.get(d);if(_)return _;const m=Nt(bt({},a),{spatialReference:c._info.spatialReference,abortOptions:h,fields:c._info.fields}),p=yield c._loader.getSymbolAsync(u,m),y=c._schemaUtilsModule.createSymbolSchema(p,c._symbolOptions),g=rt(y,c._info,n,h).then(x=>{if("expanded-cim"!==x.type)return Be.error(new W.Z("mapview-bad-type",`Found unexpected type ${x.type} in dictionary response`)),null;x.hash+="-"+f;for(const M of x.layers)M.scaleFactor=f,M.templateHash+="-"+f;return c._templates.createTemplateGroup(x,null)});return c._groupIdCache.put(d,g,1),g})()}analyze(r,n,o,a,h,c){var u=this;return(0,C.Z)(function*(){const f=n.getCursor(),d=[];for(;f.next();)d.push(u._analyzeFeature(f,o,a,h,c));return Promise.all(d)})()}match(r,n,o,a,h){return null}_attributeHash(r){let n="";for(const o of this._symbolFields){const a=this._fieldMap[o];a&&(n+=r.attributes[a]+"-")}return n}}var yr=I(13112);class pr{constructor(r){this._remoteClient=r,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null}destroy(){}fetchResource(r,n){var o=this;return(0,C.Z)(function*(){const a=o._resourceMap,h=a.get(r);if(h)return h;let c=o._inFlightResourceMap.get(r);if(c)return c;try{c=o._remoteClient.invoke("tileRenderer.fetchResource",{url:r},bt({},n)),o._inFlightResourceMap.set(r,c),c.then(u=>(o._inFlightResourceMap.delete(r),a.set(r,u),u))}catch(u){return(0,J.D_)(u)?null:{width:0,height:0}}return c})()}getResource(r){var n;return null!=(n=this._resourceMap.get(r))?n:null}}function Zi(l,r){return(!l.minScale||l.minScale>=r)&&(!l.maxScale||l.maxScale<=r)}function Vi(l){const r=l.message,n={message:{data:{},tileKey:r.tileKey,tileKeyOrigin:r.tileKeyOrigin,version:r.version},transferList:new Array};for(const o in r.data){const a=r.data[o];if(n.message.data[o]=null,(0,P.pC)(a)){const h=a.stride,c=a.indices.slice(0),u=a.vertices.slice(0),f=a.records.slice(0),d={stride:h,indices:c,vertices:u,records:f,metrics:(0,P.yw)(a.metrics,_=>_.slice(0))};n.transferList.push(c,u,f),n.message.data[o]=d}}return n}N.Z.getLogger("esri.views.2d.layers.features.processors.SymbolProcessor");let He=class extends yr.Z{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new pr(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(l){this._bufferIds.forEach(r=>{r.forEach(l)})}update(l,r){var n=this;return(0,C.Z)(function*(){const o=r.schema.processors[0];if("symbol"!==o.type)return;const a=(0,Xe.Hg)(n._schema,o);(0,Xe.uD)(a,"mesh")&&(l.mesh=!0,l.why.mesh.push("Symbology changed"),n._schema=o,n._factory=n._createFactory(o),n._factory.update(o,n.tileStore.tileScheme.tileInfo))})()}onTileMessage(l,r,n,o){return(0,J.k_)(o),this._onTileData(l,r,n,o)}onTileClear(l){return this._bufferData.delete(l.key.id),this._bufferIds.delete(l.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{clear:!0}})}onTileError(l,r,n){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:l.id,error:r},{signal:n.signal})}onTileUpdate(l){for(const r of l.removed)this._bufferData.has(r.key.id)&&this._bufferData.delete(r.key.id),this._bufferIds.has(r.key.id)&&this._bufferIds.delete(r.key.id);for(const r of l.added)this._bufferData.forEach(n=>{for(const o of n)o.message.tileKey===r.id&&this._updateTileMesh("append",r,Vi(o),[],!1,!1,null)})}_addBufferData(l,r){this._bufferData.has(l)||this._bufferData.set(l,[]),this._bufferData.get(l).push(Vi(r))}_createFactory(l){const{geometryType:r,objectIdField:n,fields:o}=this.service,h={geometryType:r,fields:o,spatialReference:Gi.Z.fromJSON(this.spatialReference)},c=new lr((d,_)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",d,_),this.tileStore.tileScheme.tileInfo),{matcher:u,aggregateMatcher:f}=l.mesh;return this._store=c,this._matchers.feature=Ze(u,c,h,this._resourceManagerProxy),this._matchers.aggregate=(0,P.yw)(f,d=>Ze(d,c,h,this._resourceManagerProxy)),new cr(r,n,c)}_onTileData(l,r,n,o){var a=this;return(0,C.Z)(function*(){(0,J.k_)(o);const{type:h,addOrUpdate:c,remove:u,clear:f,end:d}=r,_=!!a._schema.mesh.sortKey;if(!c)return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{type:h,addOrUpdate:null,remove:u,clear:f,end:d,sort:_}},o);const m=a._processFeatures(l,c,n,o,r.status.version);try{const p=yield m;if((0,P.Wi)(p))return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{type:h,addOrUpdate:null,remove:u,clear:f,end:d,sort:_}},o);const y=[];for(const g of p){let x=!1;const M=g.message.bufferIds,v=l.key.id,b=g.message.tileKey;if(v!==b&&(0,P.pC)(M)){if(!a.tileStore.get(b)){a._addBufferData(v,g),y.push(g);continue}let L=a._bufferIds.get(b);L||(L=new Set,a._bufferIds.set(b,L));const z=Array.from(M);for(const F of z){if(L.has(F)){x=!0;break}L.add(F)}}x||(a._addBufferData(v,g),y.push(g))}yield Promise.all(y.map(g=>{const x=l.key.id===g.message.tileKey;return a._updateTileMesh(h,l,g,x?r.remove:[],x&&r.end,r.clear,o.signal)}))}catch(p){a._handleError(l,p,o)}})()}_updateTileMesh(l,r,n,o,a,h,c){var u=this;return(0,C.Z)(function*(){const f=l,d=n.message.tileKey,_=!!u._schema.mesh.sortKey;d!==r.key.id&&(a=!1);const m=(0,P.yw)(n,x=>x.message),p=(0,P.yw)(n,x=>x.transferList)||[],y={type:f,addOrUpdate:m,remove:o,clear:h,end:a,sort:_},g={transferList:(0,P.Wg)(p)||[],signal:c};return(0,J.k_)(g),u.remoteClient.invoke("tileRenderer.onTileData",{tileKey:d,data:y},g)})()}_processFeatures(l,r,n,o,a){var h=this;return(0,C.Z)(function*(){if((0,P.Wi)(r)||!r.hasFeatures)return null;const c={transform:l.transform,hasZ:!1,hasM:!1},u=h._factory,f={viewingMode:"",scale:l.scale},d=yield h._matchers.feature,_=yield h._matchers.aggregate;(0,J.k_)(o);const m=h._getLabelInfos(l,r);return yield u.analyze(r.getCursor(),h._resourceManagerProxy,d,_,c,f),(0,J.k_)(o),h._writeFeatureSet(l,r,c,m,u,n,a)})()}_writeFeatureSet(l,r,n,o,a,h,c){const u=r.getSize(),f=new Yi(l.key.id,{features:u,records:u,metrics:0},this._schema.mesh.matcher.symbologyType,h,!0,c),d={viewingMode:"",scale:l.scale},_=r.getCursor();for(;_.next();)try{const p=_.getDisplayId(),y=(0,P.pC)(o)?o.get(p):null;a.writeCursor(f,_,n,d,l.level,y,this._resourceManagerProxy)}catch(p){}return f.serialize(l.tileInfoView.tileInfo.isWrappable)}_handleError(l,r,n){if(!(0,J.D_)(r))return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:l.id,error:r.message},{signal:n.signal})}_getLabelingSchemaForScale(l){const r=this._schema.mesh.labels;if((0,P.Wi)(r))return null;if("subtype"===r.type){const o={type:"subtype",classes:{}};let a=!1;for(const h in r.classes){const c=r.classes[h].filter(u=>Zi(u,l.scale));a=a||!!c.length,o.classes[h]=c}return a?o:null}const n=r.classes.filter(o=>Zi(o,l.scale));return n.length?{type:"simple",classes:n}:null}_getLabels(l,r){var n;if("subtype"===r.type){const a=(0,P.s3)(this.service.subtypeField,"Expected to find subtype Field"),h=l.readAttribute(a);return null==h?[]:null!=(n=r.classes[h])?n:[]}return r.classes}_getLabelInfos(l,r){const n=this._getLabelingSchemaForScale(l);if((0,P.Wi)(n))return null;const o=new Map,a=r.getCursor();for(;a.next();){const h=a.getDisplayId(),c=[],u=(0,ue.nE)(h),f=u&&1!==a.readAttribute("cluster_count")?"aggregate":"feature",d=this._getLabels(a,n);for(const _ of d){if(_.target!==f)continue;const p=a.getStorage().getComputedStringAtIndex(u&&"feature"===f?a.readAttribute("referenceId"):h,_.fieldIndex);if(!p)continue;const y=(0,j.E)(p.toString()),x=y[1];this._store.getMosaicItem(_.symbol,ze(y[0])).then(M=>{c[_.index]={glyphs:M.glyphMosaicItems,rtl:x,index:_.index}})}o.set(h,c)}return o}};He=(0,V._)([(0,ce.j)("esri.views.2d.layers.features.processors.SymbolProcessor")],He);const xr=He}}]);
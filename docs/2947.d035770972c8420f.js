"use strict";var nt=Object.defineProperty,Ge=Object.getOwnPropertySymbols,ot=Object.prototype.hasOwnProperty,lt=Object.prototype.propertyIsEnumerable,He=(k,G,s)=>G in k?nt(k,G,{enumerable:!0,configurable:!0,writable:!0,value:s}):k[G]=s,ie=(k,G)=>{for(var s in G||(G={}))ot.call(G,s)&&He(k,s,G[s]);if(Ge)for(var s of Ge(G))lt.call(G,s)&&He(k,s,G[s]);return k};(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[2947],{88034:(k,G,s)=>{s.d(G,{H:()=>W,b:()=>g});var N=s(98071),a=s(49480),j=s(65787),T=s(17625),I=s(22355),d=s(35387);function g(){const w=new I.kG;return w.include(N.k),w.include(a.f),w.fragment.uniforms.add([new d.A("densityMap",v=>v.densityMap),new d.A("tex",v=>v.colorRamp),new j.p("densityNormalizer",v=>1/(v.maxDensity-v.minDensity)),new j.p("minDensity",v=>v.minDensity)]),w.fragment.uniforms.add(new j.p("densityMultiplier",v=>3/(v.searchRadius*v.searchRadius*Math.PI))),w.fragment.code.add(T.H`void main() {
float density = texture2D(densityMap, uv).r * densityMultiplier;
float densityRatio = (density - minDensity) * densityNormalizer;
vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));
discardOrAdjustAlpha(color);
gl_FragColor = color;
}`),w}const W=Object.freeze(Object.defineProperty({__proto__:null,build:g},Symbol.toStringTag,{value:"Module"}))},81768:(k,G,s)=>{s.d(G,{H:()=>g,b:()=>d});var N=s(2166),a=s(65787),j=s(17625),T=s(22355),I=s(16396);function d(W){const w=new T.kG;(0,N.S)(w,W);const{isAttributeDriven:v}=W;return w.attributes.add(I.T.POSITION,"vec3"),w.attributes.add(I.T.UV0,"vec2"),v&&(w.attributes.add(I.T.FEATUREATTRIBUTE,"float"),w.varyings.add("attributeValue","float")),w.varyings.add("unitCirclePos","vec2"),w.vertex.uniforms.add(new a.p("radius",({resolutionForScale:f,searchRadius:E},{camera:b,screenToWorldRatio:V})=>2*E*(0===f?1:f/V)*b.pixelRatio/b.fullViewport[2])),w.vertex.code.add(j.H`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${I.T.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${v?j.H`attributeValue = ${I.T.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),w.fragment.code.add(j.H`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${v?j.H` * attributeValue`:""};
      gl_FragColor = vec4(density);
    }
  `),w}const g=Object.freeze(Object.defineProperty({__proto__:null,build:d},Symbol.toStringTag,{value:"Module"}))},23010:(k,G,s)=>{s.d(G,{g:()=>B});var N=s(15861),a=s(17626),j=s(14517),T=s(59213),I=s(46160),g=(s(8314),s(26584)),W=s(72392),w=s(58817),v=s(63290),f=s(62208),E=s(60330),b=s(10699),V=s(32917),U=s(77712),J=(s(90912),s(76898)),pe=s(17760),me=s(38305),fe=s(35082),ye=s(60776),_e=s(54984),le=s(88879),Q=s(37118),se=s(9260),he=s(69852),ae=s(89673),ne=s(21716),Fe=s(23461);const O=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class Ee{constructor(l,y,P){this.loadingGraphics=new Map,this.loadedGraphics=new Map,this.pendingGraphics=new Map,this._enabled=!0,this.tileFetcher=l,this.view=P,this.tilingScheme=new Fe.t(y),this.loadedSymbols=O.map(S=>new ae.Z(new se.Z({material:{color:[S[0],S[1],S[2],.6]},outline:{color:"black",size:1}}))),this.loadingSymbols=[new ae.Z(new se.Z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this.pendingSymbols=[new ae.Z(new se.Z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this.dataExtentSymbol=new ae.Z(new se.Z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(l){this._enabled=l,this.update()}update(){this._enabled?(this._synchronizeMaps(this.loadingGraphics,{filter:l=>l.isFetching,symbols:this.loadingSymbols}),this._synchronizeMaps(this.loadedGraphics,{filter:l=>!l.isFetching,symbols:this.loadedSymbols}),this._synchronizeMaps(this.pendingGraphics,{filter:l=>!l.isFetching,symbols:this.pendingSymbols}),this.showDataExtent(this.tileFetcher.filterExtent)):(this.loadingGraphics.forEach(l=>{this.view.graphics.removeMany(l)}),this.loadingGraphics.clear(),this.loadedGraphics.forEach(l=>{this.view.graphics.removeMany(l)}),this.loadedGraphics.clear(),this.pendingGraphics.forEach(l=>{this.view.graphics.removeMany(l)}),this.pendingGraphics.clear(),this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null))}showDataExtent(l){if(this.dataExtentGraphic&&(this.view.graphics.remove(this.dataExtentGraphic),this.dataExtentGraphic=null),!l)return;const y=Q.Z.fromExtent(l);this.dataExtentGraphic=new le.Z({geometry:y,symbol:this.dataExtentSymbol}),this.view.graphics.add(this.dataExtentGraphic)}_synchronizeMaps(l,y){const P=[];l.forEach((S,_)=>{const H=this.tileFetcher.test.getFeatureTileById(_);H&&y.filter(H)||(this.view.graphics.removeMany(S),P.push(_))}),P.forEach(S=>l.delete(S)),this.tileFetcher.test.forEachFeatureTile(S=>{if(y.filter(S)&&!l.has(S.id)){const[_,H,ee]=S.descriptor.lij;this.tilingScheme.ensureMaxLod(_);const e=this.tilingScheme.getExtentGeometry(_,H,ee),t=[new le.Z({geometry:e,symbol:y.symbols[_%y.symbols.length]}),new le.Z({geometry:e.center,symbol:new he.Z({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new ne.Z({text:`${_}/${H}/${ee}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];l.set(S.id,t),this.view.graphics.addMany(t)}})}}var ge=s(93605);const ue=v.Z.getLogger("esri.layers.graphics.controllers.FeatureTileController3D");let B=class extends((0,E.v)(j.Z)){constructor(u){super(u),this.type="feature-tile-3d",this.watchUpdatingTracking=new pe.t,this.serviceDataExtent=null,this.serviceDataCount=K.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this.suspended=!1,this.tileFetcher=null,this.handles=new W.Z,this.fetchDataInfoPromise=null,this.fetchDataInfoAbortController=null,this.lifeCycleAbortController=new AbortController}set extent(u){if(u&&!u.spatialReference.equals(this.layerView.view.spatialReference))return void ue.error("#extent=","extent needs to be in the same spatial reference as the view");const l=this._get("extent");if(l===u||l&&u&&l.equals(u))return;const y=u?u.clone():null;this._set("extent",y)}get updating(){return!!((0,f.pC)(this.tileFetcher)&&this.tileFetcher.updating||null!=this.fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this.watchUpdatingTracking&&this.watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&(0,f.pC)(this.tileFetcher)?this.tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&(0,f.pC)(this.tileFetcher)?this.tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&(0,f.pC)(this.tileFetcher)?this.tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return(0,f.pC)(this.tileFetcher)?this.tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!(0,f.pC)(this.tileFetcher)||!this.tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return(0,f.pC)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(u){u!==this.maximumNumberOfFeatures&&(null==u?this._clearOverride("maximumNumberOfFeatures"):this._override("maximumNumberOfFeatures",u))}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){var S,_;const u=this.layerView.layer;if("feature"===u.type&&(0,f.pC)(u.infoFor3D))return"snapshot";if(!1===(null==(_=null==(S=this.layerView.view.qualitySettings)?void 0:S.graphics3D)?void 0:_.snapshotAvailable)||this.serviceDataCount===K.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const l=this.layerView.view,y=l&&l.featureTiles,P=y&&y.tilingScheme;if(u&&u.minScale&&this.serviceDataExtent&&P){const H=this._approximateExtentSizeAtScale(u.minScale,P);if((this.serviceDataExtent.width/H+this.serviceDataExtent.height/H)/2>K.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const u=this._get("maxTotalSnapshotVertices")||0,l="snapshot"===this.mode&&(0,f.pC)(this.tileFetcher)&&this.tileFetcher.totalVertices||0;return Math.max(u,l)}_approximateExtentSizeAtScale(u,l){const y=this.layerView.view,P=Math.ceil((y.width/l.pixelSize+y.height/l.pixelSize)/2),S=l.levels[0];return P*((S.tileSize[0]/(S.scale/u)+S.tileSize[1]/(S.scale/u))/2)}get tileDescriptors(){return"snapshot"===this.mode?new I.Z([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new I.Z}get test(){return{fetchDataInfoPromise:this.fetchDataInfoPromise,tileFetcher:this.tileFetcher}}initialize(){this.watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal))),this.watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),V.nn),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const u=this.layerView.layer;if(!u.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==u.type)throw new g.Z("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:u})}destroy(){this._cancelFetchServiceDataInfo(),this.tileFetcher=(0,f.SC)(this.tileFetcher),this.handles=(0,f.SC)(this.handles),this.tilesHandle=(0,f.hw)(this.tilesHandle),this.lifeCycleAbortController&&(this.lifeCycleAbortController.abort(),this.lifeCycleAbortController=null),this.watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this.suspended||(this.suspended=!0,(0,f.pC)(this.tileFetcher)&&this.tileFetcher.suspend())}resume(){this.suspended&&(this.suspended=!1,(0,f.pC)(this.tileFetcher)&&this.tileFetcher.resume())}restart(){const u=()=>{(0,f.pC)(this.tileFetcher)&&this.tileFetcher.restart()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(u,u))}refetch(){const u=()=>{(0,f.pC)(this.tileFetcher)&&this.tileFetcher.refetch()};this.watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(u,u))}_initializeTileFetcher(){const u=this.layerView.view;if(!u)return;const l=(0,V.N1)(()=>{var y;return null==(y=u.featureTiles)?void 0:y.tilingScheme},this.lifeCycleAbortController.signal);this.watchUpdatingTracking.addPromise(l),l.then(()=>{const{layerView:y,tileDescriptors:P}=this,S=y.layer,_=new _e.j({context:this.context,filterExtent:this.extent,tileDescriptors:P,features:this.graphics});this.tileFetcher=_,this.suspended?this.tileFetcher.suspend():this.tileFetcher.resume();const H=this.layerView.view.resourceController;H&&this.handles.add((0,V.YP)(()=>H.memoryController.memoryFactor,i=>_.memoryFactor=i,V.tX));const ee="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;ee&&this.handles.add((0,V.YP)(()=>{var i,r,c;return null==(c=null==(r=null==(i=this.layerView.view)?void 0:i.qualitySettings)?void 0:r.graphics3D)?void 0:c[ee]},i=>_.lodFactor=i||1,V.nn)),"ogc-feature"!==S.type&&this.watchUpdatingTracking.add(()=>S.createQueryVersion,()=>this._dataFilterChanged()),this.watchUpdatingTracking.add(()=>y.availableFields,(i,r)=>this._availableFieldsChanged(r,i)),this.watchUpdatingTracking.add(()=>y.requiredFields,(i,r)=>this._requiredFieldsChanged(r,i)),this.handles.add([S.on("apply-edits",i=>this._applyEdits(i)),(0,V.YP)(()=>this.extent,i=>_.filterExtent=i,V.Z_),(0,V.YP)(()=>this.tileDescriptors,i=>_.tileDescriptors=i,V.Z_),(0,V.YP)(()=>this.maximumNumberOfFeatures,i=>{_.maximumNumberOfFeatures=i,_.useTileCount=this.serviceDataCount>i},V.tX),(0,V.YP)(()=>this.serviceDataCount,i=>_.useTileCount=i>this.maximumNumberOfFeatures,V.tX),(0,V.YP)(()=>ge.Z.FEATURE_TILE_FETCH_SHOW_TILES,i=>{i&&_&&!_.debugger?(_.debugger=new Ee(_,u.featureTiles.tilingScheme.toTileInfo(),u),_.debugger.update()):!i&&this.tileFetcher&&_.debugger&&(_.debugger.destroy(),_.debugger=null)},V.tX)]),this.supportsExceedsLimitQuery||this.watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this.watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this.lifeCycleAbortController.signal)))}).catch(()=>{})}_modeChanged(){switch(this.mode){case"tiles":this.tilesHandle||(this.tilesHandle=this.layerView.view.featureTiles.addClient());break;default:ue.warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,f.pC)(this.tilesHandle)&&(this.tilesHandle.remove(),this.tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}_applyEdits(u){(0,f.Wi)(this.tileFetcher)||this.tileFetcher.applyEdits(u).then(l=>{l&&(l.deletedFeatures.length||l.updatedFeatures.length||l.addedFeatures.length)&&this.watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this.lifeCycleAbortController.signal))}).catch(l=>{if(!(0,b.D_)(l))throw l})}_availableFieldsChanged(u,l){(0,f.pC)(this.tileFetcher)&&ve(this.tileFetcher.availableFields,l)&&this.refetch()}_requiredFieldsChanged(u,l){(0,f.pC)(this.tileFetcher)&&ve(this.tileFetcher.availableFields,l)&&this.restart()}_createVertexLimitExceededQuery(u){const l=this.layerView.layer,y=l.createQuery();return y.outStatistics=[new ye.Z({statisticType:"exceedslimit",maxVertexCount:u,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],l.capabilities.query.supportsCacheHint&&(y.cacheHint=!0),y}_createDataInfoQuery(){const u=this.layerView.layer,l=u.createQuery();return l.outSpatialReference=this.layerView.view.spatialReference,u.capabilities.query.supportsCacheHint&&(l.cacheHint=!0),l}_fullExtentIsAccurate(){const u=this.layerView.layer;if(u.definitionExpression)return!1;switch(u.type){case"feature":return(0,me.M8)(u.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}_updateServiceDataExtent(u){var l=this;return(0,N.Z)(function*(){try{yield l._tryUpdateServiceDataExtent(u)}catch(y){(0,b.D_)(y)||l._set("serviceDataExtent",(0,w.d9)(l.layerView.fullExtentInLocalViewSpatialReference))}})()}_tryUpdateServiceDataExtent(u){var l=this;return(0,N.Z)(function*(){const y=l.layerView,P=y.layer,S=P.capabilities.query.supportsExtent,_=(0,w.d9)(y.fullExtentInLocalViewSpatialReference),H=P.fullExtent,ee=l._fullExtentIsAccurate();if(S&&l.serviceDataCount<=K.MAX_FEATURE_COUNT_FOR_EXTENT&&(!_||!ee)&&"queryExtent"in P){const t=l._createDataInfoQuery(),i=yield P.queryExtent(t,{timeout:K.QUERY_EXTENT_TIMEOUT,signal:u});l._set("serviceDataExtent",i.extent)}else if(_)l._set("serviceDataExtent",_);else if((0,f.pC)(H)){const t="portalItem"in P?P.portalItem:null,i=yield(0,fe.projectGeometry)(H,y.view.spatialReference,t,u);l._set("serviceDataExtent",i)}else l._set("serviceDataExtent",null)})()}_updateServiceDataCount(u){var l=this;return(0,N.Z)(function*(){const y=l.layerView.layer;if(!("queryFeatureCount"in y))return void l._set("serviceDataCount",K.NO_SERVICE_DATA_COUNT);const P=yield(0,T.q6)(y.queryFeatureCount(l._createDataInfoQuery(),{timeout:K.QUERY_STATISTICS_TIMEOUT,signal:u}));if(!0===P.ok)l._set("serviceDataCount",P.value);else{if((0,b.D_)(P.error))throw P.error;l._set("serviceDataCount",K.NO_SERVICE_DATA_COUNT)}})()}get vertexLimitInfo(){if((0,f.Wi)(this.displayFeatureLimit)||(0,f.Wi)(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:u,maximumTotalNumberOfPrimitives:l}=this.displayFeatureLimit,{primitivesPerCoordinate:y,primitivesPerFeature:P}=u,S=this._get("vertexLimitInfo");return(0,f.Wi)(S)||S.maximumTotalNumberOfPrimitives!==l||S.primitivesPerCoordinate!==y||S.primitivesPerFeature!==P?{primitivesPerCoordinate:y,primitivesPerFeature:P,maximumTotalNumberOfPrimitives:l}:S}get supportsExceedsLimitQuery(){const u=this.layerView.layer;return u.capabilities&&u.capabilities.operations&&u.capabilities.operations.supportsExceedsLimitStatistics}get minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}_updateVertexLimitExceeded(u,l){var y=this;return(0,N.Z)(function*(){const P=y.vertexLimitInfo;if((0,f.Wi)(P))return void y._set("vertexLimitExceeded",!1);const _=y.minimumNumberOfVerticesForGeometry>1;if(!(P.primitivesPerFeature<=0||_))return void y._set("vertexLimitExceeded",!1);const{primitivesPerFeature:H,primitivesPerCoordinate:ee,maximumTotalNumberOfPrimitives:e}=P;let t;0!==H&&(0,f.pC)(u)&&(yield u);const i=y.serviceDataCount,r=i!==K.NO_SERVICE_DATA_COUNT;if(t=Math.ceil(r?(e-i*H)/(ee||1):e/(ee||1)),_&&(t=Math.min(t,Ce)),r&&y.minimumNumberOfVerticesForGeometry*i>t)return void y._set("vertexLimitExceeded",!0);if(!y.supportsExceedsLimitQuery)return void y._set("vertexLimitExceeded",y.maxTotalSnapshotVertices>t);const c=yield(0,T.q6)(y.layerView.layer.queryFeatures(y._createVertexLimitExceededQuery(t),{timeout:K.QUERY_STATISTICS_TIMEOUT,signal:l}));if(!1===c.ok){if((0,b.D_)(c.error))throw c.error;return void y._set("vertexLimitExceeded",!1)}const m=c.value.features[0];y._set("vertexLimitExceeded",!(!m||!m.attributes||!m.attributes.exceedslimit))})()}_fetchServiceDataInfo(){var u=this;return(0,N.Z)(function*(){u._cancelFetchServiceDataInfo();let l=new AbortController;const y=l.signal,P=u._updateServiceDataCount(y),S=(0,b.as)([P,u._updateVertexLimitExceeded(P,y)]),_=S.then(()=>u._updateServiceDataExtent(y)).catch(H=>{(0,b.D_)(H)||ue.error("#fetchServiceDataInfo()",H)}).then(()=>{_===u.fetchDataInfoPromise&&(u.fetchDataInfoPromise=null,u.fetchDataInfoAbortController=null),l=null});return l&&(u.fetchDataInfoPromise=_),u.fetchDataInfoAbortController=l,S.then(()=>{},()=>{})})()}_cancelFetchServiceDataInfo(){const u=this.fetchDataInfoAbortController;u&&(this.fetchDataInfoAbortController=null,this.fetchDataInfoPromise=null,u.abort())}get debug(){return{storedFeatures:(0,f.pC)(this.tileFetcher)?this.tileFetcher.storedFeatures:0,totalFeatures:(0,f.pC)(this.tileFetcher)?this.tileFetcher.totalFeatures:0,totalVertices:(0,f.pC)(this.tileFetcher)?this.tileFetcher.totalVertices:0}}};(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"type",void 0),(0,a._)([(0,U.Cb)({constructOnly:!0})],B.prototype,"graphics",void 0),(0,a._)([(0,U.Cb)({constructOnly:!0})],B.prototype,"layerView",void 0),(0,a._)([(0,U.Cb)({constructOnly:!0})],B.prototype,"context",void 0),(0,a._)([(0,U.Cb)()],B.prototype,"extent",null),(0,a._)([(0,U.Cb)()],B.prototype,"updating",null),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"watchUpdatingTracking",void 0),(0,a._)([(0,U.Cb)()],B.prototype,"updatingTotal",null),(0,a._)([(0,U.Cb)()],B.prototype,"updatingRemaining",null),(0,a._)([(0,U.Cb)()],B.prototype,"expectedFeatureDiff",null),(0,a._)([(0,U.Cb)()],B.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,U.Cb)()],B.prototype,"maximumNumberOfFeaturesExceeded",null),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"serviceDataExtent",void 0),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"serviceDataCount",void 0),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"vertexLimitExceeded",void 0),(0,a._)([(0,U.Cb)()],B.prototype,"displayFeatureLimit",void 0),(0,a._)([(0,U.Cb)({type:Number})],B.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"mode",null),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"maxTotalSnapshotVertices",null),(0,a._)([(0,U.Cb)({readOnly:!0,dependsOn:["mode"]})],B.prototype,"tileDescriptors",null),(0,a._)([(0,U.Cb)()],B.prototype,"tileFetcher",void 0),(0,a._)([(0,U.Cb)()],B.prototype,"fetchDataInfoPromise",void 0),(0,a._)([(0,U.Cb)({readOnly:!0})],B.prototype,"vertexLimitInfo",null),B=(0,a._)([(0,J.j)("esri.layers.graphics.controllers.FeatureTileController3D")],B);const Ce=5e6;function ve(u,l){if(!l)return!1;for(const y of l)if(!u.has(y))return!0;return!1}var K,u;(u=K||(K={})).NO_SERVICE_DATA_COUNT=1/0,u.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,u.reset=function l(){u.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,u.QUERY_STATISTICS_TIMEOUT=12e3,u.QUERY_EXTENT_TIMEOUT=1e4},K.reset()},61256:(k,G,s)=>{s.d(G,{H:()=>W});var N=s(8314),a=s(36592),j=s(65401);const I={minX:0,minY:0,maxX:0,maxY:0};class W{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.Q(9,(0,N.Z)("esri-csp-restrictions")?v=>({minX:v[0],minY:v[1],maxX:v[2],maxY:v[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const v=new Array(this._idByBounds.size);let f=0;this._idByBounds.forEach((E,b)=>{v[f++]=b}),this._indexInvalid=!1,this._index.clear(),this._index.load(v)}else this._boundsToLoad.length&&(this._index.load(this._boundsToLoad.filter(v=>this._idByBounds.has(v))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const v=(0,j.cS)();for(const f of this._boundsById.values())f&&(v[0]=Math.min(f[0],v[0]),v[1]=Math.min(f[1],v[1]),v[2]=Math.max(f[2],v[2]),v[3]=Math.max(f[3],v[3]));return v}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(v){const f=this._boundsById.get(v);this._boundsById.delete(v),f&&(this._idByBounds.delete(f),this._indexInvalid||this._index.remove(f))}forEachInBounds(v,f){this._loadIndex(),function g(w,v,f){(function d(w){I.minX=w[0],I.minY=w[1],I.maxX=w[2],I.maxY=w[3]})(v),w.search(I,f)}(this._index,v,E=>f(this._idByBounds.get(E)))}get(v){return this._boundsById.get(v)}has(v){return this._boundsById.has(v)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(v,f){if(!this._indexInvalid){const E=this._boundsById.get(v);E&&(this._index.remove(E),this._idByBounds.delete(E))}this._boundsById.set(v,f),f&&(this._idByBounds.set(f,v),this._indexInvalid||(this._boundsToLoad.push(f),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},3579:(k,G,s)=>{s.d(G,{Z:()=>v});var N=s(26584),a=s(61885),j=s(63290),T=s(62208),I=s(5548),d=s(65401),g=s(82054),W=s(61256),w=s(92794);class v{constructor(E){this.geometryInfo=E,this._boundsStore=new W.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new a.Z,this.featureAdapter=w.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let E=0;return this._featuresById.forEach(b=>{(0,T.pC)(b.geometry)&&b.geometry.coords&&(E+=b.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:E/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}add(E){this._add(E),this._emitChanged()}addMany(E){for(const b of E)this._add(b);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(E){const b=this._featuresById.get(E);return b?(this._remove(b),this._emitChanged(),b):null}removeManyById(E){this._boundsStore.invalidateIndex();for(const b of E){const V=this._featuresById.get(b);V&&this._remove(V)}this._emitChanged()}forEachBounds(E,b,V){for(const U of E){const Z=this._boundsStore.get(U.objectId);Z&&b((0,I.JR)(V,Z))}}getFeature(E){return this._featuresById.get(E)}has(E){return this._featuresById.has(E)}toArray(){return Array.from(this._featuresById.values())}forEach(E){this._featuresById.forEach(b=>E(b))}forEachInBounds(E,b){this._boundsStore.forEachInBounds(E,V=>{b(this._featuresById.get(V))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let E=!1;this._featuresById.forEach((b,V)=>{this._markedIds.has(V)||(E=!0,this._remove(b))}),this._markedIds.clear(),E&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(E){if(!E)return;const b=E.objectId;if(null==b)return void j.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new N.Z("featurestore:invalid-feature","feature id is missing",{feature:E}));const V=this._featuresById.get(b);let U;if(this._markedIds.add(b),V?(E.displayId=V.displayId,U=this._boundsStore.get(b),this._boundsStore.delete(b)):(0,T.pC)(this.onFeatureAdd)&&this.onFeatureAdd(E),(0,T.Wi)(E.geometry)||!E.geometry.coords||!E.geometry.coords.length)return this._boundsStore.set(b,null),void this._featuresById.set(b,E);U=(0,g.$)((0,T.pC)(U)?U:(0,d.Ue)(),E.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),(0,T.pC)(U)&&this._boundsStore.set(b,U),this._featuresById.set(b,E)}_remove(E){return(0,T.pC)(this.onFeatureRemove)&&this.onFeatureRemove(E),this._markedIds.delete(E.objectId),this._boundsStore.delete(E.objectId),this._featuresById.delete(E.objectId),E}}},79216:(k,G,s)=>{s.d(G,{R:()=>tt});var N=s(15861),a=s(17626),j=s(26584),T=s(62208),I=s(32917),d=s(77712),v=(s(85931),s(8314),s(90912),s(76898)),f=s(84786),E=s(23010),b=s(84952),V=s(79650),U=s(34675),Z=s(27306),J=s(80542),pe=s(54024),me=s(63290),fe=s(23841),ye=s(84161),_e=s(28093),le=s(55915),Q=s(83137),se=s(38114),he=s(82054),ae=s(66385),ne=s(88071),Fe=s(3579),O=s(36630),Ee=s(36859),ge=s(62600),ue=s(64835),B=s(42743),de=s(59617),z=s(87601),ce=s(19597),Ce=s(14411),ve=s(17625),K=s(651),u=s(91056),l=s(39114),y=s(88569),P=s(12407),S=s(88034),_=s(67969),H=s(2078);class ee extends ve.K{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class e extends u.A{constructor(p,n){super(p,n,()=>this.destroy())}initializeProgram(p){const n=e.shader.get().build();return new P.$(p.rctx,n,l.i)}initializePipeline(){return(0,H.sm)({blending:y.wu,colorWrite:H.BK,depthTest:null,depthWrite:null})}get primitiveType(){return _.MX.TRIANGLE_STRIP}}e.shader=new K.J(S.H,()=>s.e(4194).then(s.bind(s,74194)));var t=s(85775),i=s(55086),r=s(26906);let c=class extends Ce.S{constructor(o){super(o),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new ee}initialize(){const o={colorTarget:_.Lm.TEXTURE,depthStencilTarget:_.OU.NONE,width:0,height:0},{capabilities:p}=this.rctx,{R32F:n}=p.colorBufferFloat,{textureFloatLinear:h}=p.textureFloat,F=null!=n;this._densityMap=new t.X(this.rctx,o,{target:_.No.TEXTURE_2D,pixelFormat:F?_.VI.RED:_.VI.RGBA,internalFormat:F?_.lP.R32F:_.VI.RGBA,dataType:_.Br.FLOAT,samplingMode:h?_.cw.LINEAR:_.cw.NEAREST,wrapMode:_.e8.CLAMP_TO_EDGE,width:0,height:0}),this._quad=(0,ce.ow)(this.rctx);const R=this._colorRampData;this._colorRamp=new i.x(this.rctx,{target:_.No.TEXTURE_2D,pixelFormat:_.VI.RGBA,dataType:_.Br.UNSIGNED_BYTE,samplingMode:_.cw.LINEAR,wrapMode:_.e8.CLAMP_TO_EDGE,width:R.length/4,height:1},R),this._technique=new e({rctx:this.rctx,viewingMode:de.JY.Local},new z.m),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.own((0,I.YP)(()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius],()=>this.rendererContext.notifyContentChanged()))}destroy(){this._technique=(0,T.RY)(this._technique),this._densityMap=(0,T.O3)(this._densityMap),this._quad=(0,T.O3)(this._quad),this._colorRamp=(0,T.O3)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(o){o!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=o,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(o){o!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=o,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(o){o!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=o,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(o){this._heatmapParameters.fieldTotal=o,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(o){const{colorRamp:p}=this._heatmapParameters;if((0,T.pC)(p)&&o!==this._colorRampData){const h=o.length/4;h!==p.descriptor.width&&p.resize(h,1),p.setData(o)}this._colorRampData=o}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(o){this._heatmapParameters.colorRamp=o}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}render(o,p){const n=this._sortedMaterialRenderers,h=n.length;if(h<1)return;const F=this.rctx.getBoundFramebufferObject(),x=this.rctx.getViewport(),{pixelRatio:R}=this,M=Math.ceil(x.width*R),Y=Math.ceil(x.height*R);this._densityMap.resize(M,Y),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,M,Y),this.rctx.clear(_.lk.COLOR_BUFFER_BIT);let $=!1;for(let re=0;re<h;re++){const De=n.getItemAt(re);De.material.shouldRender(o)&&($=$||De.materialRenderer.render(o.pass,p))}this.rctx.bindFramebuffer(F),this.rctx.setViewport(x.x,x.y,x.width,x.height),$&&(this.rctx.bindVAO(this._quad),this.rctx.useProgram(this._technique.program),this._technique.bindPipelineState(this.rctx),this._technique.bindPass(this._heatmapParameters,o.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,r._V)(this._quad,"geometry")))}};(0,a._)([(0,d.Cb)()],c.prototype,"searchRadius",null),(0,a._)([(0,d.Cb)()],c.prototype,"minDensity",null),(0,a._)([(0,d.Cb)()],c.prototype,"maxDensity",null),(0,a._)([(0,d.Cb)()],c.prototype,"fieldTotal",null),(0,a._)([(0,d.Cb)()],c.prototype,"pixelRatio",void 0),(0,a._)([(0,d.Cb)()],c.prototype,"colorRampData",null),(0,a._)([(0,d.Cb)()],c.prototype,"_colorRampData",void 0),c=(0,a._)([(0,v.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],c);var we,o,m=s(52107),C=s(54840),A=s(53855),L=s(16396),q=s(67831),X=s(99770),te=s(75957),oe=s(19625),Te=s(60881),xe=s(40723),je=s(91263),We=s(5894),Oe=s(42037),ze=s(41528),Ze=s(81768);(o=we||(we={}))[o.Screen=0]="Screen",o[o.World=1]="World";class Qe extends xe.Mt{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class Re extends u.A{initializeProgram(p){const n=Re.shader.get().build(this.configuration);return new P.$(p.rctx,n,l.i)}initializePipeline(){return(0,H.sm)({blending:(0,H.if)(_.zi.ONE,_.zi.ONE,_.db.ADD),colorWrite:H.BK,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}Re.shader=new K.J(Ze.H,()=>s.e(5795).then(s.bind(s,15795)));class Ue extends ze.W{constructor(){super(...arguments),this.isAttributeDriven=!1}}(0,a._)([(0,z.o)()],Ue.prototype,"isAttributeDriven",void 0);class Ke extends Qe{constructor(){super(...arguments),this.isAttributeDriven=!1}}class Se extends xe.F5{constructor(p){super(p,new Ke),this._techniqueConfig=new Ue}requiresSlot(p,n){return p===We.r.DRAPED_MATERIAL&&n===je.C.MATERIAL}getConfiguration(){return this._techniqueConfig.isAttributeDriven=this.parameters.isAttributeDriven,this._techniqueConfig}createGLMaterial(p){return new Ye(p)}intersect(p,n,h,F,x,R,M,Y,$){if((0,T.Wi)($)||!(0,te.lM)(R))return;const re=p.vertexAttributes.get(L.T.POSITION),{parameters:De}=this,{searchRadius:it}=De,{screenToWorldRatio:Ne}=p,Ve=it*Ne+2*Ne,st=Ve*Ve,rt=re.data.length/re.size;for(let Ie=0;Ie<rt;Ie++){const Be=Ie*re.size,at=(0,q.a)(qe,re.data[Be],re.data[Be+1]);(0,q.s)(at,R)<st&&M($.dist,$.normal,-1,!1)}}createBufferWriter(){return new $e(this.parameters.isAttributeDriven?Je:Ae)}}class Ye extends Te.Z{beginSlot(p){return this.ensureTechnique(Re,p)}}class $e{constructor(p){this.vertexBufferLayout=p}allocate(p){return this.vertexBufferLayout.createBuffer(p)}elementCount(p){return p.indices.get(L.T.POSITION).length*Pe}write(p,n,h,F){(0,Oe.ho)(n.indices.get(L.T.POSITION),n.vertexAttributes.get(L.T.POSITION).data,p.transformation,h.position,F,Pe);const x=n.indices.get(L.T.POSITION).length,R=h.uv0;let M=F;for(let $=0;$<x;++$)R.setValues(M++,-1,-1),R.setValues(M++,1,-1),R.setValues(M++,1,1),R.setValues(M++,1,1),R.setValues(M++,-1,1),R.setValues(M++,-1,-1);const Y="featureAttribute"in h?h.featureAttribute:null;Y&&(0,Oe.XW)(n.indices.get(L.T.FEATUREATTRIBUTE),n.vertexAttributes.get(L.T.FEATUREATTRIBUTE).data,Y,F,Pe)}}const Ae=(0,oe.U$)().vec3f(L.T.POSITION).vec2f(L.T.UV0),Je=Ae.clone().f32(L.T.FEATUREATTRIBUTE),Pe=6,qe=(0,X.a)(),Me=me.Z.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor");let D=class extends J.r{constructor(o){super(o),this.type="heatmap",this.filterVisibility={filterChanged(){},dirty:!1},this.preferredUpdatePolicy=B.jq.ASYNC,this.dataExtent=null,this.drapeSourceType=ge.L.Features,this._renderGeometries=new Map,this._material=new Se({}),this._materialWithField=new Se({isAttributeDriven:!0}),this._fieldTotal=0,this._drapeSourceRenderer=null}initialize(){this._featureStore=new Fe.Z({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{colorBufferFloat:o,textureFloat:p}=this._renderView.capabilities,{floatBufferBlendWorking:n}=this._renderView.renderingContext.driverTest;if(null==p||!p.textureFloat)throw new j.Z("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float.");if(null==o||!o.textureFloat)throw new j.Z("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL2 extension EXT_color_buffer_float or the WebGL1 extension WEBGL_color_buffer_float.");if(null==o||!o.floatBlend)throw new j.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend.");if(!n)throw new j.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend. This device claims support for it, but does not actually support it.");this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,c,this._rendererParameters),this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,h=>this._onLoadedFeaturesChange(h),I.nn),this.updatingHandles.addWhen(()=>this._materialParameters,h=>this._forEachMaterial(F=>F.setParameters(h)),I.nn),this.updatingHandles.add(()=>this._rendererParameters,h=>this._drapeSourceRenderer.set(h)),this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},I.Z_),this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:h,numeric:F})=>{if((0,T.pC)(h)&&F){let x=0;this._featureStore.forEach(R=>{var M;return x+=null!=(M=R.attributes[h])?M:0}),this._fieldTotal=x}else this._fieldTotal=this._featureStore.numFeatures},I.nn),this.handles.add([(0,I.YP)(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:h,field:F})=>{var x;h&&!F&&Me.warn(`Heatmap renderer field '${h}' for layer '${null!=(x=this.layer.title)?x:this.layer.id}' not found`)}),(0,I.YP)(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:h,numeric:F})=>{var x;(0,T.pC)(h)&&!F&&Me.warn(`Heatmap renderer field '${h.name}' for layer '${null!=(x=this.layer.title)?x:this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),(0,pe.kB)(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=(0,T.O3)(this._material),this._materialWithField=(0,T.O3)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this.updatingHandles.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get displayFeatureLimit(){var h,F,x,R,M,Y,$;const o=null!=(M=null==(R=null==(x=null==(F=null==(h=this.owner)?void 0:h.view)?void 0:F.resourceController)?void 0:x.memoryController)?void 0:R.memoryFactor)?M:1,p=null==($=null==(Y=this.owner)?void 0:Y.view)?void 0:$.qualitySettings,n=p?Math.ceil(p.heatmap.maxTotalNumberOfFeatures*o):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:n,maximumTotalNumberOfPrimitives:2*n,maximumNumberOfFeatures:n}}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){return!1}get usedMemory(){var x,R,M,Y,$;const o=this.usedMemoryPerFeature*this._featureStore.numFeatures,{R32F:p}=null==(R=null==(x=this._renderView)?void 0:x.capabilities)?void 0:R.colorBufferFloat,n=null!=p?1:4,F=null!=($=Math.ceil((null==(Y=null==(M=this._overlayRenderer)?void 0:M.overlays[0])?void 0:Y.resolution)*this._densityMapPixelRatio))?$:0;return F*F*n*4+o+((0,T.pC)(this._heatmapRenderer)?(0,fe.F2)(Math.min(this._heatmapRenderer.radius,112)):0)*n*4}get usedMemoryPerFeature(){if(0===this._featureStore.numFeatures)return 0;let o=0;this._featureStore.forEach(h=>o+=(0,Z.f2)(h.attributes)),o/=this._featureStore.numFeatures;const p=(0,Z.G3)();return 6*(0,Z.do)([0,0,0],p)+6*(0,Z.do)([0,0],p)+(this._heatmapRendererFieldIsNumeric?6*p:0)+o}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return{core:{visible:this._featureStore.numFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return(0,T.Wg)(this._overlayRenderer.spatialReference)}get _rendererParameters(){return ie(ie(ie(ie({},this._radiusParameter),this._densityParameters),this._colorRampParameter),this._pixelRatioParameter)}get _materialParameters(){return ie(ie({},this._radiusParameter),this._resolutionForScaleParameter)}get _densityParameters(){const o=this._heatmapRenderer;if((0,T.Wi)(o))return null;const{minDensity:p,maxDensity:n}=o;return{minDensity:p,maxDensity:n,fieldTotal:this._fieldTotal}}get _radiusParameter(){return(0,T.yw)(this._heatmapRenderer,({radius:o})=>({searchRadius:(0,fe.F2)(this._clampSearchRadius(o))}))}get _resolutionForScaleParameter(){return(0,T.yw)(this._heatmapRenderer,({referenceScale:o})=>({resolutionForScale:0===o?0:(0,Q.dp)(o,this.view.spatialReference)}))}get _colorRampParameter(){return(0,T.yw)(this._heatmapRenderer,o=>({colorRampData:(0,Ee.uI)(o.colorStops)}))}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){var p,n,h,F,x,R,M,Y;const o=null!=(x=null==(F=null==(h=null==(n=null==(p=this.owner)?void 0:p.view)?void 0:n.resourceController)?void 0:h.memoryController)?void 0:F.memoryFactor)?x:1;return(null!=(Y=null==(M=null==(R=this.owner)?void 0:R.view)?void 0:M.qualitySettings.heatmap.pixelRatio)?Y:1)*Math.sqrt(o)}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const o=this.layer.renderer;return"heatmap"===(null==o?void 0:o.type)?o:null}get _heatmapRendererFieldName(){return(0,T.yw)(this._heatmapRenderer,o=>o.field)}get _heatmapRendererField(){return(0,T.yw)(this._heatmapRendererFieldName,o=>this.layer.fieldsIndex.get(o))}get _heatmapRendererFieldIsNumeric(){const o=this._heatmapRendererField;return!(0,T.Wi)(o)&&(0,O.H7)(o)}whenGraphicBounds(){return(0,N.Z)(function*(){return null})()}computeAttachmentOrigin(){return null}highlight(){return Le}maskOccludee(){return Le}setObjectIdVisibility(){}setup(){return(0,N.Z)(function*(){})()}_onLoadedFeaturesChange(o){if(!this._featuresArePoints)return;const{objectIdField:p}=this.layer;this._featureStore.removeManyById(o.removed.map(R=>(0,se.MS)(R,p))),this._featureStore.addMany(o.added.map(R=>new ae.u_((0,he.dd)(new ne.Z,R.geometry),R.attributes,(0,T.yw)(R.centroid,M=>(0,he.dd)(new ne.Z,M)),(0,se.MS)(R,p))));const n=o.added,h=o.removed;this._fieldTotal+=this._computeFieldTotalChange(n,h);const F=(0,T.e8)(h,({uid:R})=>{const M=this._renderGeometries.get(R);return this._renderGeometries.delete(R),M}),x=n.map(R=>{const M=this._pointGraphicToRenderGeometry(R);return this._renderGeometries.set(R.uid,M),M});F.length>0&&this._drapeSourceRenderer.removeGeometries(F,C.$.Geometry.REMOVE),x.length>0&&this._drapeSourceRenderer.addGeometries(x,C.$.Geometry.ADD),(x.length>0||F.length>0)&&this._renderView.requestRender()}_recreate(){if(!this._loadedPointGraphics)return;const o=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:o,removed:o})}_pointGraphicToRenderGeometry(o){var M;const p=this._heatmapRendererFieldName,n=(0,T.pC)(p)?this._materialWithField:this._material,h=(0,_e.c)();(0,le.KC)(o.geometry,h,this._overlaySpatialReference),h[2]=ue.Rn;const F=[[L.T.POSITION,{data:h,size:h.length}]],x=this._heatmapRendererFieldIsNumeric;(0,T.pC)(p)&&F.push([L.T.FEATUREATTRIBUTE,{data:[x&&null!=(M=o.attributes[p])?M:0],size:1}]);const R=new A.z(new m.Z(F,null,B.MX.Point),n,{layerUid:this.layer.uid,graphicUid:o.uid});return(0,ye.c)(R.boundingSphere,h),R}_forEachMaterial(o){o(this._material),o(this._materialWithField)}_computeFieldTotalChange(o,p){if((0,T.Wi)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return o.length-p.length;const n=this._heatmapRendererFieldName,h=(F,x)=>{var R;return F+(null!=(R=x.attributes[n])?R:0)};return o.reduce(h,0)-p.reduce(h,0)}_clampSearchRadius(o){return o>112&&Me.warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(o,112)}};(0,a._)([(0,d.Cb)()],D.prototype,"type",void 0),(0,a._)([(0,d.Cb)({constructOnly:!0})],D.prototype,"owner",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"layer",null),(0,a._)([(0,d.Cb)()],D.prototype,"featureStore",null),(0,a._)([(0,d.Cb)()],D.prototype,"updating",null),(0,a._)([(0,d.Cb)()],D.prototype,"updatingRemaining",null),(0,a._)([(0,d.Cb)()],D.prototype,"suspendInfo",null),(0,a._)([(0,d.Cb)()],D.prototype,"legendEnabled",null),(0,a._)([(0,d.Cb)()],D.prototype,"filterVisibility",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"displayFeatureLimit",null),(0,a._)([(0,d.Cb)()],D.prototype,"preferredUpdatePolicy",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"hasZ",null),(0,a._)([(0,d.Cb)()],D.prototype,"hasM",null),(0,a._)([(0,d.Cb)()],D.prototype,"dataExtent",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"view",null),(0,a._)([(0,d.Cb)()],D.prototype,"fullOpacity",null),(0,a._)([(0,d.Cb)()],D.prototype,"updatePolicy",null),(0,a._)([(0,d.Cb)()],D.prototype,"drapeSourceType",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"_featureStore",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"_overlayRenderer",null),(0,a._)([(0,d.Cb)()],D.prototype,"_overlaySpatialReference",null),(0,a._)([(0,d.Cb)()],D.prototype,"_rendererParameters",null),(0,a._)([(0,d.Cb)()],D.prototype,"_materialParameters",null),(0,a._)([(0,d.Cb)()],D.prototype,"_densityParameters",null),(0,a._)([(0,d.Cb)()],D.prototype,"_radiusParameter",null),(0,a._)([(0,d.Cb)()],D.prototype,"_resolutionForScaleParameter",null),(0,a._)([(0,d.Cb)()],D.prototype,"_colorRampParameter",null),(0,a._)([(0,d.Cb)()],D.prototype,"_pixelRatioParameter",null),(0,a._)([(0,d.Cb)()],D.prototype,"_densityMapPixelRatio",null),(0,a._)([(0,d.Cb)()],D.prototype,"_renderGeometries",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"_material",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"_materialWithField",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"_renderView",null),(0,a._)([(0,d.Cb)()],D.prototype,"_featuresArePoints",null),(0,a._)([(0,d.Cb)()],D.prototype,"_loadedPointGraphics",null),(0,a._)([(0,d.Cb)()],D.prototype,"_heatmapRenderer",null),(0,a._)([(0,d.Cb)()],D.prototype,"_heatmapRendererFieldName",null),(0,a._)([(0,d.Cb)()],D.prototype,"_heatmapRendererField",null),(0,a._)([(0,d.Cb)()],D.prototype,"_heatmapRendererFieldIsNumeric",null),(0,a._)([(0,d.Cb)()],D.prototype,"_fieldTotal",void 0),(0,a._)([(0,d.Cb)()],D.prototype,"_drapeSourceRenderer",void 0),D=(0,a._)([(0,v.j)("esri.views.3d.layers.support.HeatmapFeatureProcessor")],D);const Le=(0,pe.kB)();var ke=s(89765),et=s(87091);const tt=o=>{let p=class extends o{constructor(){super(...arguments),this.controller=null,this.updatePolicy=B.jq.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.clippingExtent=null,this.supportsHeightUnitConversion=!0,this.pendingController=null,this.queryEngine=null}initialize(){var n=this;const h=this.layer;"isTable"in h&&h.isTable?this.addResolvingPromise(Promise.reject(new j.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:h}))):(this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add(()=>this.layer.renderer,F=>this._recreateProcessor(F),I.nn),this.addResolvingPromise((0,N.Z)(function*(){const F=yield(0,ke.E)(n);n.fullExtentInLocalViewSpatialReference=F,yield n._initializeController()})()),this.updatingHandles.add(()=>this.updatePolicy,F=>this.processor.preferredUpdatePolicy=F),this.queryEngine=new U.q({layerView:this,priority:et.T8.FEATURE_QUERY_ENGINE}),this.notifyChange("updating"))}destroy(){this._destroyPendingController(),this.controller=(0,T.SC)(this.controller),this._set("processor",(0,T.SC)(this.processor)),this.queryEngine=(0,T.SC)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this.pendingController=(0,T.SC)(this.pendingController)}get legendEnabled(){var n;return this.canResume()&&(null==(n=this.processor)?void 0:n.legendEnabled)}get graphics3DProcessor(){var n;return"graphics-3d"===(null==(n=this.processor)?void 0:n.type)?this.processor:null}get heatmapProcessor(){var n;return"heatmap"===(null==(n=this.processor)?void 0:n.type)?this.processor:null}getHit(n){var F;let h=null;return null==(F=this.loadedGraphics)||F.forEach(x=>{x.uid===n&&(h=(0,f.mW)(x,this.layer))}),h?{type:"graphic",graphic:h,layer:h.layer}:null}whenGraphicBounds(n,h){var F;return null==(F=this.processor)?void 0:F.whenGraphicBounds(n,h)}computeAttachmentOrigin(n,h){var F;return null==(F=this.processor)?void 0:F.computeAttachmentOrigin(n,h)}queryFeatures(n,h){return this.queryEngine.executeQuery(this._ensureQuery(n),(0,T.U2)(h,"signal"))}queryObjectIds(n,h){return this.queryEngine.executeQueryForIds(this._ensureQuery(n),(0,T.U2)(h,"signal"))}queryFeatureCount(n,h){return this.queryEngine.executeQueryForCount(this._ensureQuery(n),(0,T.U2)(h,"signal"))}queryExtent(n,h){return this.queryEngine.executeQueryForExtent(this._ensureQuery(n),(0,T.U2)(h,"signal"))}_ensureQuery(n){return(0,T.Wi)(n)?this.createQuery():b.Z.from(n)}highlight(n){return this.processor.highlight(n,this.layer.objectIdField)}maskOccludee(n){return this.processor.maskOccludee(n)}canResume(){var n;return super.canResume()&&!(null!=(n=this.processor)&&n.scaleVisibilitySuspended)}getSuspendInfo(){const n=super.getSuspendInfo();return this.processor?ie(ie({},n),this.processor.suspendInfo):n}isUpdating(){var n,h,F;return!(!this.processor||this.processor.destroyed||this._controllerCreated&&(null==(n=this.controller)||!n.updating)&&(null==(F=null==(h=this.view)?void 0:h.basemapTerrain)?void 0:F.ready)&&!this.processor.updating)}_initializeController(){var n=this;return(0,N.Z)(function*(){const h=n.createController();n.pendingController=h,yield h.when(),n._setControllerWhenInitialized(h)})()}_setControllerWhenInitialized(n){var h=this;return(0,N.Z)(function*(){try{yield h.when()}catch(F){}h._controllerCreated=!0,h.notifyChange("updating"),h.isResolved()&&!h.destroyed?(yield(0,I.N1)(()=>{var F,x;return null==(x=null==(F=h.view)?void 0:F.basemapTerrain)?void 0:x.ready}),h.beforeSetController(n),h.pendingController=null,h.controller=n,h.loadedGraphics=n.graphics,h.notifyChange("updating")):h._destroyPendingController()})()}_updateClippingExtent(n){if(this.clippingExtent=n,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=n,!0}}_validateGeometryType(){var n=this;return(0,N.Z)(function*(){switch(n.layer.geometryType){case"multipatch":case"multipoint":throw new j.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:n.layer.geometryType})}})()}_recreateProcessor(n){var M,Y;const h="heatmap"===(null==n?void 0:n.type),F="heatmap"===(null==(M=this.processor)?void 0:M.type),x=this.processor;if(x&&h===F)return;const R=h?new D({owner:this}):new V.Z({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:$=>this._updateClippingExtent($)});this._set("processor",R),null==x||x.destroy(),null==(Y=this.queryEngine)||Y.clear(),this.addResolvingPromise(R.setup())}_getResourceInfo(){var h,F;const n=this.controller instanceof E.g?this.controller:null;return ie({displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:null!=(h=null==n?void 0:n.maximumNumberOfFeatures)?h:-1,totalNumberOfFeatures:null!=(F=null==n?void 0:n.serviceDataCount)?F:-1,nodes:0},this.processor.performanceInfo)}get performanceInfo(){return this._getResourceInfo()}};return(0,a._)([(0,d.Cb)()],p.prototype,"loadedGraphics",void 0),(0,a._)([(0,d.Cb)()],p.prototype,"suspended",void 0),(0,a._)([(0,d.Cb)({readOnly:!0})],p.prototype,"legendEnabled",null),(0,a._)([(0,d.Cb)()],p.prototype,"updating",void 0),(0,a._)([(0,d.Cb)()],p.prototype,"controller",void 0),(0,a._)([(0,d.Cb)()],p.prototype,"processor",void 0),(0,a._)([(0,d.Cb)({readOnly:!0})],p.prototype,"updatePolicy",void 0),(0,a._)([(0,d.Cb)({readOnly:!0})],p.prototype,"suspendResumeExtentMode",void 0),(0,a._)([(0,d.Cb)({type:Boolean})],p.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,d.Cb)({readOnly:!0})],p.prototype,"suspendInfo",void 0),(0,a._)([(0,d.Cb)()],p.prototype,"graphics3DProcessor",null),(0,a._)([(0,d.Cb)()],p.prototype,"heatmapProcessor",null),p=(0,a._)([(0,v.j)("esri.views.3d.layers.FeatureLikeLayerView3D")],p),p}},54984:(k,G,s)=>{s.d(G,{j:()=>z,A:()=>ve});var N=s(15861),a=s(17626),j=s(14517),T=s(72392),I=s(63290),d=s(88159),g=s(62208),W=s(10699),w=s(32917),v=s(50618),f=s(77712),E=s(85931),U=(s(8314),s(90912),s(76898)),Z=s(65401),J=s(38114),pe=s(89621),me=s(84952),fe=s(59617),ye=s(53639);class _e{constructor(t,i){this.highestResolutionVersion=null,this.versions=[],this.ref(t,i)}get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}ref(t,i){const r=this.feature;Q.oldVersion=r,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0});for(const m of this.versions)if(m.resolution===i){m.refCount++;const C=this.highestResolutionVersion===m&&!(0,ye.f)(t,m.feature);return(C||this.highestResolutionVersion!==m)&&(m.feature=t),Q.newVersion=C?t:r,Q}const c={feature:t,resolution:i,refCount:1};return this.versions.push(c),!this.highestResolutionVersion||i<this.highestResolutionVersion.resolution?(Q.newVersion=t,this.highestResolutionVersion=c):Q.newVersion=r,Q}unref(t){for(let i=0;i<this.versions.length;i++){const r=this.versions[i];if(r.resolution===t)return r.refCount--,Q.oldVersion=this.feature,0===r.refCount&&(this.versions[i]=this.versions[this.versions.length-1],this.versions.length--,this.highestResolutionVersion===r&&(this._recalculateHighestResolutionVersion(),Q.oldVersion=r.feature)),Q.newVersion=this.feature,Q}return null}get feature(){return this.highestResolutionVersion?this.highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this.highestResolutionVersion=null);let t=this.versions[0];for(let i=1;i<this.versions.length;i++){const r=this.versions[i];r.resolution<t.resolution&&(t=r)}this.highestResolutionVersion=t}}class le{constructor(t){this._feature=t,this.refCount=1}get isReferenced(){return 0!==this.refCount}get isSingle(){return 1===this.refCount}ref(t){return++this.refCount,Q.oldVersion=this._feature,this.feature&&Object.defineProperty(t,"uid",{value:this.feature.uid,configurable:!0}),(0,ye.f)(this._feature,t)||(this._feature=t),Q.newVersion=this._feature,Q}unref(){return Q.oldVersion=this._feature,this.refCount>0&&(this.refCount--,!this.isReferenced)?(Q.newVersion=null,Q):(Q.newVersion=this._feature,Q)}get feature(){return this._feature}}const Q={oldVersion:null,newVersion:null},he=new Set;class ae{constructor(t){this.descriptor=t,this.fetchStatus=O.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=ne,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=he,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(t){this._displayingFeatures=t,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(t){this._featureLimit!==t&&(this._featureLimit=t,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(t,i,r){this._availableFields=(0,g.Pt)(r,he),this._features=t,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,t&&t.length>0?(this._emptyFeatureRatio=i/(t.length+i),this._numVertices=t.reduce((c,m)=>c+(0,J.R3)(m.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(t){this._numFeatures=t}get hasPreciseFeatureCount(){return this._numFeatures>ne}get needsFeatureCount(){return this._numFeatures===ne}get numVertices(){return this._numVertices}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let t=0;t<this._features.length;++t){const i=(0,J.Xw)(this._features[t]);this._estimatedSize+=i,t>=this.featureLimit&&(this._estimatedUnusedSize+=i)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let t=this.featureLimit;t<this._features.length;++t)this._estimatedUnusedSize+=(0,J.Xw)(this._features[t]);return!0}return!1}get isFetching(){return this.fetchStatus===O.FETCHING||this.fetchStatus===O.REFETCHING}get isRefetching(){return this.fetchStatus===O.REFETCHING}get needsFetching(){return this.fetchStatus===O.FETCH_NEEDED||this.fetchStatus===O.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===O.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===O.DONE||this.fetchStatus===O.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===O.REFETCHING?O.REFETCH_NEEDED:O.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function Ee(e,t,i){if((0,g.Wi)(t)||(0,g.Wi)(e)||i!==t.length||i>e.length)return!1;for(let r=0;r<i;++r)if(e[r]!==t[r])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(t){return!t||!this.descriptor.extent||((0,Z.oJ)(t,ge),(0,Z.kK)(this.descriptor.extent,ge))}intersectionIncludingBorrowed(t,i){const r=(0,g.pC)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return t||r?(t?((0,Z.oJ)(t,i),(0,Z.jV)(i,r,i)):(0,Z.JG)(i,r),i):((0,Z.JG)(i,Z.bd),i)}_shuffle(t){this._features.sort((i,r)=>(0,J.MS)(i,t)-(0,J.MS)(r,t)),(0,E.TV)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(t,i,r){if(t<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let c=!1;this.featureLimit=Math.ceil(this.numFeatures*t),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===O.DONE&&this._features.length>0&&(this.fetchStatus=O.REFETCH_NEEDED,c=!0)),!this._shuffled&&t<1&&this._shuffle(r);const m=Math.max(this.featureLimit,Math.ceil(i*this.numFeatures));return this._features.length>m&&(this._features.length=m,this.featuresMissing=!0,this.fetchStatus===O.FULL&&(this.fetchStatus=O.DONE)),c}get cache(){return{availableFields:this._availableFields,features:this.features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(t){this.requestController=null,this._availableFields=t.availableFields,this._features=t.features,this._numFeatures=t.numFeatures,this._emptyFeatureRatio=t.emptyFeatureRatio,this.fetchStatus=t.fetchStatus,this.featuresMissing=t.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const ne=-1;var O,e;(e=O||(O={}))[e.FETCH_NEEDED=0]="FETCH_NEEDED",e[e.REFETCH_NEEDED=1]="REFETCH_NEEDED",e[e.FETCHING=2]="FETCHING",e[e.REFETCHING=3]="REFETCHING",e[e.DONE=4]="DONE",e[e.FULL=5]="FULL";const ge=(0,Z.Ue)();var ue=s(15076),B=s(87091);const de=I.Z.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");let z=class extends j.Z{constructor(e){super(e),this._useTileCount=!1,this.updating=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this.changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this.handles=new T.Z,this._frameTask=B.sq,this._dirty=!1,this.featureTiles=new Map,this.displayingFeatureReferences=new Map,this.numDisplayingFeatureReferences=0,this.suspended=!0,this.pendingEdits=null}set maximumNumberOfFeatures(e){e=e||1/0;const t=this._get("maximumNumberOfFeatures");e===t||e<1||(this._set("maximumNumberOfFeatures",e),this._maximumFeaturesUpdated(t,e))}set memoryFactor(e){this.memoryFactor!==e&&(this._set("memoryFactor",e),this._setDirty())}set lodFactor(e){this.lodFactor!==e&&(this._set("lodFactor",e),this.supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&(0,g.pC)(this.context.query.queryFeatureCount)}set useTileCount(e){this._useTileCount=e,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.estimatedUnusedSize),e}get totalVertices(){let e=0;return this.featureTiles.forEach(t=>e+=t.numVertices),e}get totalFeatures(){let e=0;return this.featureTiles.forEach(t=>e+=t.numFeatures),e}set filterExtent(e){if(e&&this.context.tilingScheme&&!e.spatialReference.equals(this.context.tilingScheme.spatialReference))return void de.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const t=this._get("filterExtent");if(t===e||t&&e&&t.equals(e))return;const i=e?e.clone():null;this._set("filterExtent",i),this._reclip(i,t)}initialize(){this.handles.add((0,w.on)(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()})),this.objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?_e:le;const e=this.context.scheduler;(0,g.pC)(e)&&(this._frameTask=e.registerTask(B.T8.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this.handles=(0,g.SC)(this.handles),this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._removeTile(e)}),this.featureTiles.clear(),this.displayingFeatureReferences.clear(),this.pendingEdits&&(this.pendingEdits.controller.abort(),this.pendingEdits=null)}get paused(){return this.suspended||!!this.pendingEdits}restart(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._clearTile(e),this._resetFetchTile(e)}),(0,g.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this.featureTiles.forEach(e=>{this._cancelFetchTile(e),this._resetFetchTile(e)}),(0,g.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this.suspended||(this.suspended=!0,this._pause(),this._setDirty())}resume(){this.suspended&&(this.suspended=!1,this._unpause())}_pause(){this.paused&&(this.featureTiles.forEach(e=>this._cancelFetchTile(e)),this._updated())}_unpause(){this.paused||(this._setDirty(),this._updated())}get availableFields(){let e=null;return this.featureTiles.forEach(t=>{(0,g.Wi)(t.displayingFeatures)||0===t.displayingFeatures.length||((0,g.Wi)(e)?e=new Set(t.availableFields):e.forEach(i=>{t.availableFields.has(i)||(0,g.Wg)(e).delete(i)}))}),(0,g.pC)(e)?e:new Set}applyEdits(e){this.pendingEdits||(this.pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const t=this.pendingEdits;t.count++;const i=t.edits.then(()=>e.result.catch(r=>{if((0,W.D_)(r))throw r;return null}).then(r=>r&&(this._applyEditsDeleteFeatures(r.deletedFeatures),this._applyEditsAddUpdateFeatures(r.addedFeatures,r.updatedFeatures,t.controller.signal).then(()=>r))).then(r=>(0==--t.count&&(this.pendingEdits===t&&(this.pendingEdits=null),(0,g.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated()),r)));return t.edits=i,this._updated(),i}_applyEditsDeleteFeatures(e){if(0===e.length)return;const t=this.context.globalIdField,i=t&&this.availableFields.has(t),r=new Set,c=this.objectIdField;e.forEach(({objectId:m,globalId:C})=>{if((!m||m<0)&&t){i||de.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected in the view`);const A=this.features.find(L=>L.attributes&&L.attributes[t]===C);A&&r.add((0,J.MS)(A,c))}else r.add(m)}),this.featureTiles.forEach(m=>{if(!m.features)return;const C=m.features.filter(A=>!r.has((0,J.MS)(A,this.objectIdField)));C.length!==m.features.length&&(m.setFeatures(C,0,m.availableFields),this._invalidateCounts())})}_applyEditsAddUpdateFeatures(e,t,i){var r=this;return(0,N.Z)(function*(){const c=[],m=new Set;if(e.forEach(A=>c.push(A.objectId)),t.forEach(A=>{c.push(A.objectId),m.add(A.objectId)}),0===c.length)return;const C=[];r.featureTiles.forEach(A=>{const L=r._applyEditsAddUpdateTile(A,c,m,i);L&&C.push(L)}),yield(0,W.as)(C)})()}_applyEditsAddUpdateTile(e,t,i,r){var c=this;return(0,N.Z)(function*(){if(!e.features)return;const m=c._createQuery(e);m.resultType=void 0,m.cacheHint=!1,m.objectIds=t;const C=yield c._queryFeatures(m,r);let A=null;if(i.size>0){const L=e.features.filter(q=>!i.has((0,J.MS)(q,c.objectIdField)));L.length!==e.features.length&&(A=L)}if(C.features.length>0){A||(A=e.features.slice());for(const L of C.features)A.push(L)}A&&(e.hasPreciseFeatureCount&&(e.numFeatures=Math.max(e.numFeatures,A.length)),e.setFeatures(A,0,y(e.availableFields,C.fields)),c._invalidateCounts())})()}_queryFeatures(e,t){return this.context.query.queryFeaturesDehydrated(e,{signal:t,timeout:H})}_setDirty(){this._dirty=!0,this._updated()}get running(){return this.updating}runTask(e){if(this._frameTask.processQueue(e),!this._dirty||!this.constructed)return;this._dirty=!1;const t=this._getListOfTiles();if(this._markTilesNotAlive(t),!e.run(()=>this._addTiles(t,e))||!e.run(()=>this._filterExtentTiles(t,e))||!e.run(()=>this._removeTiles(t,e))||e.done)return void this._setDirty();const i=this._sortTiles(t);e.run(()=>this._displayTiles(i,e))&&e.run(()=>this._fetchTiles(i,e))&&e.run(()=>this._updateMemoryEstimates(i,e))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(e){for(const t of e)t.alive=!1}_addTiles(e,t){return!this.suspended&&(this.tileDescriptors.forEach(i=>{const r=this.featureTiles.get(i.id);r?r.alive=!0:t.done||(e.push(this._addTile(i)),t.madeProgress())}),t.hasProgressed)}_filterExtentTiles(e,t){for(const i of e){if(t.done)break;i.alive&&(i.filtered=!i.intersects(this.filterExtent),i.filtered&&(this._clearTile(i),t.madeProgress()))}return t.hasProgressed}_removeTiles(e,t){for(let i=e.length-1;i>=0&&!t.done;i--){const r=e[i];r.alive||(this._removeTile(r),i!==e.length-1&&(e[i]=e[e.length-1]),e.pop(),t.madeProgress())}return t.hasProgressed}_sortTiles(e){return e.sort((t,i)=>t.descriptor.loadPriority-i.descriptor.loadPriority),e}_displayTiles(e,t){const i=this._updateRatio(e),r=c=>{const m=this._fullRatio<1?i(c)*this._farRatio:1;return c.reduceFeatures(m,this.memoryFactor,this.objectIdField)&&this._setDirty(),this._showTile(c)};for(const c of e)if(!t.run(()=>r(c))){this._setDirty();break}return t.hasProgressed}_fetchTiles(e,t){if(this.paused)return!1;let i=!1;for(const r of e){if(!r.needsFetching)continue;const c=(0,g.pC)(this.context.memoryCache)?this.context.memoryCache.pop(r.id):null;if((0,g.pC)(c))r.cache=c,this._setDirty(),this._scheduleUpdated(),t.madeProgress();else{if(this._needsNumFeatures(r)){const m=new AbortController,C=this._fetchTileCount(r,m.signal);this._handleRequest(r,C,m,()=>r.numFeatures=-2),i=!0,t.madeProgress()}if(t.done)return!0}}if(i)return t.hasProgressed;for(const r of e)if(r.needsFetching){const c=new AbortController,m=this._fetchTile(r,c.signal);if(this._handleRequest(r,m,c,C=>{r.setFeatures([],0,null),this._invalidateCounts(),r.featuresMissing=!1,this.context.logFetchError(de,C)}),t.madeProgress(),t.done)return!0}return t.hasProgressed}_updateMemoryEstimates(e,t){return e.some(i=>!t.run(()=>i.updateMemoryEstimates())&&(this._setDirty(),!0)),t.hasProgressed}_reclip(e,t){if(!this.constructed)return;const i=new Array;this.featureTiles.forEach(r=>{(0,g.Wi)(r.displayingFeatures)||0===r.displayingFeatures.length||(r.intersectionIncludingBorrowed(t,S),r.intersectionIncludingBorrowed(e,_),(0,Z.fS)(S,_)||i.push(r))}),this._refreshDisplayingFeatures(i),this._updated()}_refreshDisplayingFeatures(e){const t=new Set,i=this.changes.updates;for(const r of e)if(!(0,g.Wi)(r.displayingFeatures))for(const c of r.displayingFeatures){const m=(0,J.MS)(c,this.objectIdField);if(t.has(m))continue;t.add(m);const{feature:C}=this.displayingFeatureReferences.get(m);i.removes.push(C),i.adds.push(C)}this._applyChanges()}_updated(){let e=0;this.paused||this.featureTiles.forEach(i=>i.isFetching?++e:0);const t=this._dirty||e>0||!!this.pendingEdits;if(this._set("updating",t),t){let i=0,r=0,c=0,m=0,C=0;const A=this.displayingFeatureReferences.size/this.numDisplayingFeatureReferences;this.featureTiles.forEach(X=>{if(++r,X.isFetching&&X.hasPreciseFeatureCount){const te=this._maximumFeaturesForTile(X)*(1-X.emptyFeatureRatio),oe=(0,g.pC)(X.displayingFeatures)?X.displayingFeatures.length*A:0;C+=te-oe}X.needsFetching?++m:X.numFeatures>0&&(++c,i+=X.numFeatures)}),m+=e;let L=0,q=0;i?(q=i,L=Math.min(m*i/c,i)):(q=r,L=m),C=Math.min(this.maximumNumberOfFeatures-this.features.length,C),this._set("updatingTotal",q),this._set("updatingRemaining",L),this._set("expectedFeatureDiff",C)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const e=(0,d.oE)(this.featureTiles,t=>t.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",e)}_updateRatio(e){const t=function Ce(e){let t=0;for(const i of e)i.features&&i.features.length>0&&i.alive&&(t=Math.max(t,i.descriptor.lij[0]));return t}(e),i=m=>1/(1<<Math.max(0,t-m.descriptor.lij[0]));let r=0,c=0;for(const m of e){const C=m.numFeatures;r+=C,c+=C*i(m)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/r),this._farRatio=this.maximumNumberOfFeatures/c,this._scheduleUpdated(),i}_maximumFeaturesUpdated(e,t){e!==t&&(t>e&&this.featureTiles.forEach(i=>{if(!i.featuresMissing)return;const r=this._maximumFeaturesForTile(i);i.features&&(i.features.length>=r||i.fetchStatus===O.FULL)||(this._cancelFetchTile(i),this._resetFetchTile(i))}),this._setDirty())}_addTile(e){const t=new ae(e);return this.featureTiles.set(t.id,t),this._resetFetchTile(t),this._referenceDisplayingFeaturesFromRelatedTiles(t),t}_referenceDisplayingFeaturesFromRelatedTiles(e){const t=e.descriptor.resolution;this.featureTiles.forEach(i=>{if(!((0,g.Wi)(i.displayingFeatures)||e===i||e.descriptor.lij&&i.descriptor.lij&&!(0,ue.E9)(e.descriptor.lij,i.descriptor.lij))){(0,g.Wi)(e.displayingFeatures)&&(e.displayingFeatures=[]),e.descriptor.extent&&i.descriptor.extent&&((0,g.Wi)(e.extentIncludingBorrowedFeatures)&&(e.extentIncludingBorrowedFeatures=(0,Z.d9)(e.descriptor.extent)),(0,Z.jn)(e.extentIncludingBorrowedFeatures,i.descriptor.extent,e.extentIncludingBorrowedFeatures));for(const r of i.displayingFeatures){e.displayingFeatures.push(r);const c=this.displayingFeatureReferences.get((0,J.MS)(r,this.objectIdField));c.ref(c.feature,t),this.numDisplayingFeatureReferences++}}}),e.featureLimit=(0,g.pC)(e.displayingFeatures)?e.displayingFeatures.length:0}_removeTile(e){this._clearTile(e),this.featureTiles.delete(e.id)}_resetFetchTile(e){e.filtered=!e.intersects(this.filterExtent),e.filtered?e.needsFetching&&(e.fetchStatus=O.DONE):e.fetchStatus=O.FETCH_NEEDED}_cancelFetchTile(e){const t=e.requestController;(0,g.pC)(t)&&(e.requestController=null,e.resetFetching(),t.abort())}_fetchTileCount(e,t){var i=this;return(0,N.Z)(function*(){return e.numFeatures=yield i._fetchCount(e,t),i._updateRatio(i._getListOfTiles()),e.fetchStatus===O.REFETCHING?O.REFETCH_NEEDED:O.FETCH_NEEDED})()}_fetchTile(e,t){var i=this;return(0,N.Z)(function*(){const r=i._maximumFeaturesForTile(e);if(r<=0)return function u(e){return e.setFeatures([],0,null),e.featuresMissing=!1,O.DONE}(e);const c=i._getMaxRecordCount(e),m=Math.ceil(r/c);if(ce(e)||!i.context.capabilities.supportsMaxRecordCountFactor||e.numFeatures<=r&&m>me.Z.MAX_MAX_RECORD_COUNT_FACTOR)return i._fetchPagedTile(e,t);const C=i._createQuery(e);if(C.maxRecordCountFactor=Math.ceil(r/c),e.isRefetching&&e.features&&e.features.length>0){const te=Math.ceil(e.features.length/(1-e.emptyFeatureRatio)/c);C.maxRecordCountFactor=Math.max(te+1,C.maxRecordCountFactor)}const{features:A,exceededTransferLimit:L,fields:q}=yield i._queryFeatures(C,t),X=L?C.maxRecordCountFactor>=me.Z.MAX_MAX_RECORD_COUNT_FACTOR?O.FULL:O.DONE:O.FULL;return yield i._frameTask.schedule(()=>{e.featuresMissing=A.length<e.numFeatures||L;const te=i._removeEmptyFeatures(A);e.setFeatures(A,te,l(q))},t),(0,W.k_)(t),i._invalidateCounts(),X})()}_fetchCount(e,t){var i=this;return(0,N.Z)(function*(){return i.context.query.queryFeatureCount(i._createFeatureCountQuery(e),{signal:t})})()}_fetchPagedTile(e,t){var i=this;return(0,N.Z)(function*(){let r,c=0,m=0,C=0,A=i._maximumFeaturesForTile(e)-C;const L=i._getMaxRecordCount(e);let q=null;for(;;){const X=i._createQuery(e),te=i._setPagingParameters(X,c,A,L),{features:oe,exceededTransferLimit:Te,fields:xe}=yield i._queryFeatures(X,t);if(yield i._frameTask.schedule(()=>{te&&(c+=(0,g.Wg)(X.num)),C+=oe.length,m+=i._removeEmptyFeatures(oe),e.featuresMissing=c<e.numFeatures||Te,r=r?r.concat(oe):oe,q=y(q,xe),e.setFeatures(r,m,q)},t),(0,W.k_)(t),i._invalidateCounts(),i._setDirty(),A=i._maximumFeaturesForTile(e)-C,!te||!Te||A<=0)return Te?O.DONE:O.FULL}})()}_createFeatureCountQuery(e){const t=this._createQuery(e);return this.context.capabilities.supportsCacheHint&&(t.resultType=void 0,t.cacheHint=!0),t}_createQuery(e){const t=this.context.createQuery(),i=e.descriptor.extent;return i&&(t.geometry=(0,Z.HH)(i,this.context.tilingScheme.spatialReference)),this._setResolutionParams(t,e),this._useTileQuery(e)?t.resultType="tile":this.context.capabilities.supportsCacheHint&&(t.cacheHint=!0),t}_setPagingParameters(e,t,i,r){return!!this.context.capabilities.supportsPagination&&(e.start=t,i>0&&this.context.capabilities.supportsMaxRecordCountFactor?(e.maxRecordCountFactor=Math.ceil(i/r),e.num=Math.min(e.maxRecordCountFactor*r,i)):e.num=Math.min(r),!0)}_getEffectiveTileResolution(e){if(null==e.descriptor.resolution)return null;const t=this.context.viewingMode===fe.JY.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(e.descriptor.resolution,t)/this.lodFactor}get supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(e,t){if(!this.supportsResolution)return;const i=this._getEffectiveTileResolution(t);null!=i&&(this.context.capabilities.supportsQuantization?e.quantizationParameters=new pe.Z({mode:"view",originPosition:"upper-left",tolerance:i,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(e.maxAllowableOffset=i))}_removeEmptyFeatures(e){const t=e.length;for(let i=0;i<e.length;)(0,J.dF)(e[i].geometry)?++i:(e[i]=e[e.length-1],--e.length);return t-e.length}_needsNumFeatures(e){return this.useTileCount&&e.needsFeatureCount&&!ce(e)}_getMaxRecordCount(e){const{tileMaxRecordCount:t,maxRecordCount:i}=this.context;return this._useTileQuery(e)&&(0,g.pC)(t)&&t>0&&this.context.capabilities.supportsResultType?t:(0,g.pC)(i)&&i>0?i:P}_useTileQuery(e){return(!ce(e)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(e,t,i,r){e.fetchStatus=e.needsRefetching?O.REFETCHING:O.FETCHING,e.requestController=i;let c=!1;t.then(m=>{e.requestController=null,e.fetchStatus=m}).catch(m=>{e.requestController===i&&(e.requestController=null,e.fetchStatus=O.DONE),(0,W.D_)(m)?c=!0:r(m)}).then(()=>{c||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this.handles&&!this.handles.has("scheduleUpdated")&&this.handles.add((0,v.Os)(()=>{this.handles.remove("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(e){if((0,g.pC)(e.displayingFeatures)&&!e.needsDisplayUpdate)return!1;const t=e.features;if(0===e.featureLimit||!t){const C=(0,g.pC)(e.displayingFeatures)&&e.displayingFeatures.length>0;return this._hideTileFeatures(e),e.displayingFeatures=[],C}const i=e.descriptor.resolution,r=this.changes.updates,c=this.changes.adds,m=Math.min(e.featureLimit,t.length);e.featureLimit=m;for(let C=0;C<m;++C){const A=t[C],L=(0,J.MS)(A,this.objectIdField),q=this.displayingFeatureReferences.get(L);if(q){const X=q.ref(A,i);X.oldVersion!==X.newVersion&&(r.removes.push(X.oldVersion),r.adds.push(X.newVersion))}else this.displayingFeatureReferences.set(L,new this.FeatureReferenceClass(A,i)),c.push(A);this.numDisplayingFeatureReferences++}return this._hideTileFeatures(e),this._applyChanges(),e.displayingFeatures=t.slice(0,m),!0}_hideTile(e){this._cancelFetchTile(e),this._hideTileFeatures(e)}_hideTileFeatures(e){if((0,g.Wi)(e.displayingFeatures))return;const t=this.changes.updates,i=this.changes.removes;for(const r of e.displayingFeatures){const c=(0,J.MS)(r,this.objectIdField),m=this.displayingFeatureReferences.get(c);if(!m)continue;const C=m.unref(e.descriptor.resolution);this.numDisplayingFeatureReferences--,C?C.oldVersion!==C.newVersion&&(null==C.newVersion?(this.displayingFeatureReferences.delete(c),i.push(C.oldVersion)):(t.adds.push(C.newVersion),t.removes.push(C.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),e.displayingFeatures=null}_applyChanges(){const e=this.changes.updates;e.removes.length>0&&(this.features.removeMany(e.removes),e.removes.length=0),e.adds.length>0&&(this.features.addMany(e.adds),e.adds.length=0);const t=this.changes.adds,i=this.changes.removes,r=Math.min(t.length,i.length);let c=0;for(;c<r;){const m=Math.min(c+ee,r);this.features.addMany(t.slice(c,m)),this.features.removeMany(i.slice(c,m)),c=m}t.length>r&&this.features.addMany(0===c?t:t.slice(c)),i.length>r&&this.features.removeMany(0===c?i:i.slice(c)),t.length=0,i.length=0}_clearTile(e){this._hideTile(e),e.features&&(0,g.pC)(this.context.memoryCache)&&this.context.memoryCache.put(e.id,e.cache,16+e.estimatedSize),e.setFeatures(null,0,null),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this.featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((e,t)=>e+(t.features?t.features.length:0),0)}_maximumFeaturesForTile(e){const t=e.hasPreciseFeatureCount?e.numFeatures:1/0;return Math.min(Math.ceil((e.hasPreciseFeatureCount?t:this.maximumNumberOfFeatures)*(this._fullRatio<1?this._farRatio:1)/(1-e.emptyFeatureRatio)),t)}get test(){return{process:e=>this.runTask(e),getFeatureTileById:e=>this.featureTiles.get(e),forEachFeatureTile:e=>this.featureTiles.forEach(e)}}};function ce(e){return"dummy-tile-full-extent"===e.id}function ve(e){const t=e.capabilities.query;return{supportsMultipleResolutions:K(e),supportsPagination:!(!t||!t.supportsPagination),supportsResultType:!(!t||!t.supportsResultType),supportsCacheHint:!(!t||!t.supportsCacheHint),supportsQuantization:!(!t||!t.supportsQuantization),supportsQuantizationEditMode:!(!t||!t.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!t||!t.supportsMaxRecordCountFactor),supportsFormatPBF:!(!t||!t.supportsFormatPBF)}}function K(e){switch(e.geometryType){case"polyline":return!0;case"polygon":return e.capabilities&&e.capabilities.query&&e.capabilities.query.supportsQuantization;default:return!1}}function l(e){return(0,g.Wi)(e)?new Set:new Set(e.map(t=>t.name))}function y(e,t){if((0,g.Wi)(e)||(0,g.Wi)(t))return l(t);const i=new Set;for(const{name:r}of t)e.has(r)&&i.add(r);return i}(0,a._)([(0,f.Cb)({constructOnly:!0})],z.prototype,"features",void 0),(0,a._)([(0,f.Cb)()],z.prototype,"tileDescriptors",void 0),(0,a._)([(0,f.Cb)({value:1/0})],z.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,f.Cb)({value:1})],z.prototype,"memoryFactor",null),(0,a._)([(0,f.Cb)({value:1})],z.prototype,"lodFactor",null),(0,a._)([(0,f.Cb)()],z.prototype,"useTileCount",null),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"updating",void 0),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"updatingTotal",void 0),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"updatingRemaining",void 0),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"expectedFeatureDiff",void 0),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,a._)([(0,f.Cb)({constructOnly:!0})],z.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"totalVertices",null),(0,a._)([(0,f.Cb)({readOnly:!0})],z.prototype,"totalFeatures",null),(0,a._)([(0,f.Cb)()],z.prototype,"filterExtent",null),(0,a._)([(0,f.Cb)({constructOnly:!0})],z.prototype,"context",void 0),z=(0,a._)([(0,U.j)("esri.views.3d.layers.support.FeatureTileFetcher3D")],z);const P=2e3,S=(0,Z.Ue)(),_=(0,Z.Ue)(),H=6e5,ee=200},89765:(k,G,s)=>{s.d(G,{E:()=>T});var N=s(62208),a=s(46367),j=s(35082);function T(I){const d=I.view.spatialReference,g=I.layer.fullExtent,W=(0,N.pC)(g)&&g.spatialReference;if((0,N.Wi)(g)||!W)return Promise.resolve(null);if(W.equals(d))return Promise.resolve(g.clone());const w=(0,a.iV)(g,d);return(0,N.pC)(w)?Promise.resolve(w):I.view.state.isLocal?(0,j.projectGeometry)(g,d,I.layer.portalItem).then(v=>!I.destroyed&&v?v:void 0).catch(()=>null):Promise.resolve(null)}},36967:(k,G,s)=>{s.d(G,{g:()=>T});var N=s(61885),a=s(73234),j=s(28862);class T extends N.Z{constructor(){super(...arguments),this._set=new Set}clear(){if(this._set.size>0){const d=this.toArray();this._set.clear(),this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:d})}}get length(){return this._set.size}addMany(d){if(0!==d.length){for(const g of d)this._set.add(g);this.emit("after-changes",{type:a.y.ADD}),this.emit("change",{added:d,removed:[]})}}remove(d){this._set.delete(d)&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:[d]}))}removeMany(d){const g=[];for(const W of d)this._set.delete(W)&&g.push(W);g.length>0&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:g}))}toArray(){return[...this._set]}find(d){let g;return(0,j.f)(this._set,W=>!!d(W)&&(g=W,!0)),g}forEach(d){this._set.forEach(g=>d(g))}}}}]);
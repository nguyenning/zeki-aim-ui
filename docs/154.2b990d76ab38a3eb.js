"use strict";(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[154],{1956:(ve,Z,r)=>{r.d(Z,{P:()=>Pe,a:()=>ye,b:()=>be,c:()=>Ie,g:()=>ue});var f=r(21286),g=r(28347),j=r(43703),K=r(67831),F=r(99770),h=r(84161),b=r(28093),P=r(5548),O=r(52382),w=r(13934),H=r(78925),E=r(62952),S=r(19278),C=r(32181),p=r(95285),u=r(77739),I=r(17625),X=r(47205),N=r(63123),Y=r(22355),k=r(16396);class Pe extends I.K{constructor(){super(...arguments),this.clipBox=(0,P.Ue)(P.bd),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class ye extends H.UT{constructor(L,ae,ne){super(L),this.origin=L,this.isLeaf=ae,this.splatSize=ne}}function Ie(U){const L=new Y.kG,ae=U.output===w.H.Color,ne=U.output===w.H.Depth,Ce=U.output===w.H.Highlight,{vertex:$,fragment:xe}=L;return L.extensions.add("GL_OES_standard_derivatives"),L.include(H.f5,U),L.attributes.add(k.T.POSITION,"vec3"),L.attributes.add(k.T.COLOR,"vec3"),$.uniforms.add([new X.K("modelView",(A,x)=>(0,g.m)(Me,x.camera.viewMatrix,(0,g.f)(Me,A.origin))),new N.g("proj",(A,x)=>x.camera.projectionMatrix),new C.q("screenMinMaxSize",(A,x,W)=>(0,K.s)(Se,W.useFixedSizes?0:W.minSizePx*x.camera.pixelRatio,ue(A.isLeaf)*x.camera.pixelRatio))]),$.uniforms.add(U.useFixedSizes?new p.A("pointScale",(A,x)=>(0,K.s)(Se,A.fixedSize*x.camera.pixelRatio,x.camera.fullHeight)):new C.q("pointScale",(A,x,W)=>(0,K.s)(Se,A.splatSize*W.scaleFactor*x.camera.pixelRatio,x.camera.fullHeight/x.camera.pixelRatio))),U.clippingEnabled?$.uniforms.add([new u.B("clipMin",(A,x,W)=>(0,h.s)(Oe,W.clipBox[0]-A.origin[0],W.clipBox[1]-A.origin[1],W.clipBox[2]-A.origin[2])),new u.B("clipMax",(A,x,W)=>(0,h.s)(Oe,W.clipBox[3]-A.origin[0],W.clipBox[4]-A.origin[1],W.clipBox[5]-A.origin[2]))]):($.constants.add("clipMin","vec3",[-f._3,-f._3,-f._3]),$.constants.add("clipMax","vec3",[f._3,f._3,f._3])),ne?((0,O.Zu)(L),(0,O.bA)(L),L.varyings.add("depth","float")):U.output!==w.H.Highlight&&L.varyings.add("vColor","vec3"),$.code.add(I.H`
    void main(void) {
      // Move clipped points outside of clipspace
      if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
        position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      if (rejectBySlice(position)) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      // Position in camera space
      vec4 camera = modelView * vec4(position, 1.0);

      float pointSize = pointScale.x;
      vec4 position = proj * camera;
     ${U.drawScreenSize?I.H`
      float clampedScreenSize = pointSize;`:I.H`
      float pointRadius = 0.5 * pointSize;
      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
      vec4 positionOffset = proj * cameraOffset;
      float radius = abs(positionOffset.y - position.y);
      float viewHeight = pointScale.y;
      // screen diameter = (2 * r / w) * (h / 2)
      float screenPointSize = (radius / position.w) * viewHeight;
      float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
      // Shift towards camera, to move rendered point out of terrain i.e. to
      // the camera-facing end of the virtual point when considering it as a
      // 3D sphere.
      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
      position = proj * camera;`}

     gl_PointSize = clampedScreenSize;
     gl_Position = position;

     ${ne?I.H`depth = calculateLinearDepth(nearFar, camera.z);`:""}
     ${ae?I.H`vColor = color;`:""}
    }
  `),xe.include(S.n,U),Ce&&L.include(E.bA,U),xe.code.add(I.H`
    void main(void) {
      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
      float r2 = dot(vOffset, vOffset);

      if (r2 > 0.25) {
        discard;
      }
      ${ne?I.H`gl_FragColor = float2rgba(depth);`:""}
      ${Ce?I.H`outputHighlight();`:""}
      ${ae?I.H`gl_FragColor = vec4(vColor, 1.0);`:""}
    }
  `),L}function ue(U){return U?256:64}const Me=(0,j.c)(),Oe=(0,b.c)(),Se=(0,F.a)(),be=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:ye,PointRendererPassParameters:Pe,build:Ie,getMaxPointSizeScreenspace:ue},Symbol.toStringTag,{value:"Module"}))},19702:(ve,Z,r)=>{r.d(Z,{A:()=>H});var f=r(15861),g=r(17626),j=r(54024),K=r(10699),F=r(32917),h=r(77712),O=(r(90912),r(85931),r(76898)),w=r(36947);const H=E=>{let S=class extends E{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(C){super.postscript(C),(0,w.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var C=this;return(0,f.Z)(function*(){const p=new AbortController,u=p.signal;C.handles.add((0,j.kB)(()=>p.abort())),yield(0,F.N1)(()=>{var X;return null==(X=C.view.defaultsFromMap)?void 0:X.heightModelInfoReady},u),(0,K.k_)(u);const I=(0,w.Wt)(C.layer,C.view.heightModelInfo,C.supportsHeightUnitConversion);if(I)throw I})()}canResume(){const C=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!C||!C.minScale||!C.maxScale||C.minScale>=C.maxScale)}getSuspendInfo(){const C=super.getSuspendInfo(),p=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return p&&p.minScale&&p.maxScale&&p.minScale<p.maxScale&&(C.outsideScaleRange=!0),C}};return(0,g._)([(0,h.Cb)()],S.prototype,"view",void 0),(0,g._)([(0,h.Cb)()],S.prototype,"slicePlaneEnabled",void 0),S=(0,g._)([(0,O.j)("esri.views.3d.layers.LayerView3D")],S),S}},61525:(ve,Z,r)=>{r.r(Z),r.d(Z,{default:()=>Kt});var f=r(15861),g=r(17626),j=r(59213),K=r(46160),F=r(63290),h=r(62208),b=r(10699),P=r(32917),O=r(23841),w=r(55713),H=r(16730),E=r(77712),p=(r(90912),r(85931),r(76898)),u=r(84161),I=r(14658),X=r(55915),N=r(5548),Y=r(65401),k=r(90014),Pe=r(38114),ye=r(86219),ue=(r(8314),r(26036)),be=(r(50028),r(90336),r(68155),r(36630)),U=r(41291),L=r(29505),ae=r(19702),ne=r(42930);class Ce extends ne.q{constructor(e){super("PointCloudWorker","transform",{transform:i=>this._getTransferList(i)},e)}_getTransferList(e){const i=[e.geometryBuffer];if((0,h.pC)(e.primaryAttributeData)&&e.primaryAttributeData.buffer&&i.push(e.primaryAttributeData.buffer),(0,h.pC)(e.modulationAttributeData)&&e.modulationAttributeData.buffer&&i.push(e.modulationAttributeData.buffer),(0,h.pC)(e.filterAttributesData))for(const s of e.filterAttributesData)(0,h.pC)(s)&&s.buffer&&i.push(s.buffer);for(const s of e.userAttributesData)s.buffer&&i.push(s.buffer);return i}}var $=r(42964);const A=[!1],x=[null],W=[!1],q=[null];function Ve(t,e,i){let s=t;for(;s>0;){const n=e.indexOf(s);if(n>=0)return n;s=i.getParentId(s)}return e.indexOf(s)}function ot(t,e,i){const s=[e.remove[0]],n=[];for(;1===s.length;){const o=s.pop();n.length=0;for(let a=0;a<e.load.length;a++){let l=e.load[a],d=i.getParentId(l);for(;d!==o;)l=d,d=i.getParentId(l);let c=s.indexOf(l);c<0&&(c=s.length,s.push(l),n.push([])),n[c].push(e.load[a])}}e.load=s;for(let o=0;o<s.length;o++)n[o].length>1?t.push({remove:[s[o]],load:n[o]}):s[o]=n[o][0]}var ee=r(93394);class at{constructor(e,i,s){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=i,this.pageSize=s}addPage(e,i,s=0){for(;this._pages.length<e;)this._pages.push(null);const n=function dt(t,e,i,s){const n=new ee.JF(t.length);for(let o=0;o<t.length;o++)(0,$.jv)(t[o].obb,e,n.obbs[o],i,s);return n.obbs}(i,this._nodeSR,this._renderSR,s);this._pages[e]={nodes:i,renderObbs:n,parents:new Uint32Array(this.pageSize)},function ht(t,e){const i=[0];for(;i.length;){const s=i.pop(),n=t[Q(s,e)].nodes[le(s,e)];for(let o=0;o<n.childCount;o++){const a=n.firstChild+o;null!=t[Q(a,e)]&&(t[Q(a,e)].parents[le(a,e)]=s,i.push(a))}}}(this._pages,this.pageSize)}hasPage(e){return!!this._pages[e]}getNode(e){const i=this.pageSize;return this._pages[Q(e,i)].nodes[le(e,i)]}getRenderObb(e){const i=this.pageSize;return this._pages[Q(e,i)].renderObbs[le(e,i)]}getRenderCenter(e){return this.getRenderObb(e).center}setRenderObb(e,i){const s=this.pageSize;(0,ee.t8)(i,this._pages[Q(e,s)].renderObbs[le(e,s)])}getParentId(e){const i=this.pageSize;return this._pages[Q(e,i)].parents[le(e,i)]}hasNodes(e,i){const s=Q(e,this.pageSize),n=Q(e+i-1,this.pageSize);for(let o=s;o<=n;o++)if(null==this._pages[o])return!1;return!0}forEachNodeId(e){for(let i=0;i<this._pages.length;i++){const s=this._pages[i];if(s)for(let n=0;n<s.nodes.length;n++)e(i*this.pageSize+n)}}createVisibilityTraverse(){const e={index:this,queue:[],masks:[],tempAabb:(0,N.Ue)()};return(i,s)=>function lt(t,e,i){const s=t.index;if(!s.hasNodes(0,1))return;const n=t.queue;n.length=0,n.push(0);const o=t.masks;for(o.length=0,o.push(0);n.length>0;){const a=n.pop();let l=o.pop();const d=s.getNode(a),c=s.getRenderObb(a);let _=!0;if(null!=e.clippingBox){const y=1<<e.frustum.length;if(0==(l&y)){const M=(0,ee.mr)(c,t.tempAabb);(0,N.r3)(e.clippingBox,M)?l|=y:(0,N.kK)(e.clippingBox,M)||(_=!1)}}for(let y=0;y<e.frustum.length&&_;y++){const M=1<<y;if(0==(l&M)){const v=(0,ee.hZ)(c,e.frustum[y]);v>0?_=!1:v<0&&(l|=M)}}if(i.predicate(a,d,_)){const y=d.firstChild,M=d.childCount;let v=!1;const R=Q(y,s.pageSize),V=Q(y+M-1,s.pageSize);for(let D=R;D<=V;D++)if(!s.hasPage(D)){i.pageMiss(a,D),v=!0;break}if(!v)for(let D=0;D<M;D++)n.push(y+D),o.push(l)}}}(e,i,s)}}function Q(t,e){return t/e|0}function le(t,e){return t%e}function je(t){var d;const e=t.renderer,i=null==e?void 0:e.type,s=null!=(d=null==e?void 0:e.toJSON())?d:null;let n=null,o=!1;const a=t.attributeStorageInfo;"point-cloud-unique-value"===i||"point-cloud-stretch"===i||"point-cloud-class-breaks"===i?n=ce(a,e.field):"point-cloud-rgb"===i?(n=Ge(a,e.field),o=null!=n):(n=Ge(a,"RGB"),o=null!=n);let l=null;return null!=e&&e.colorModulation&&(l=ce(a,e.colorModulation.field)),{rendererJSON:s,isRGBRenderer:o,primaryAttribute:n,modulationAttribute:l}}function Ke(t){const e=t.filters;return e?e.map(i=>({filterJSON:i.toJSON(),attributeInfo:ce(t.attributeStorageInfo,i.field)})):[]}function Qe(t){const e=null==t?void 0:t.pointSizeAlgorithm;return e&&"fixed-size"===e.type?e:null}function Ge(t,e){for(const i of null!=t?t:[])if(i.name===e&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{name:e,storageInfo:i,useElevation:!1};return null}function ce(t,e){for(const i of null!=t?t:[])if(i.name===e){const s="embedded-elevation"===i.encoding;return{name:e,storageInfo:s?null:i,useElevation:s}}return"elevation"===(null==e?void 0:e.toLowerCase())?{name:e,storageInfo:null,useElevation:!0}:null}var Ae=r(14471),pt=r(88879);let pe=class extends pt.Z{constructor(t){super(t)}};(0,g._)([(0,E.Cb)({constructOnly:!0,clonable:"reference"})],pe.prototype,"pointCloudMetadata",void 0),pe=(0,g._)([(0,p.j)("esri.views.3d.layers.i3s.PointGraphic")],pe);var gt=r(77029),ge=r(28093),_t=r(993),ft=r(70562),mt=r(77926),vt=r(54024),Pt=r(42743),yt=r(7167);class St{constructor(e){this._context=e,this._highlights=new Set}get hasHighlights(){return this._highlights.size>0}destroy(){this._highlights=null}add(e){const i=new bt(e);return this._highlights.add(i),this._enableSet(i),(0,vt.kB)(()=>this._removeSet(i))}_removeSet(e){this._disableSet(e),this._highlights.delete(e)}_enableSet(e){e.enabled||(e.enabled=!0,this._context.forEachNode(i=>this._enableSetForNode(e,i)))}_enableSetForNode(e,i){if(!e.enabled)return;const s=e.ids.get(i.id);s&&s.forEach(n=>this._context.addHighlight(i,n,e.id))}_disableSet(e){e.enabled&&(e.enabled=!1,this._context.forEachNode(i=>this._disableSetForNode(e,i)))}_disableSetForNode(e,i){e.enabled||this._context.removeHighlight(i,e.id)}nodeAdded(e){this._highlights.forEach(i=>this._enableSetForNode(i,e))}nodeRemoved(e){this._highlights.forEach(i=>this._disableSetForNode(i,e))}removeAll(){this._highlights.forEach(e=>this._disableSet(e))}}class bt{constructor(e){this.id=new yt.O(Pt.V_.Highlight),this.ids=new Map,this.enabled=!1;for(const i of e)(0,h.pC)(i)&&this._add(i.nodeId,i.pointId)}_add(e,i){const s=this.ids.get(e);s?s.add(i):this.ids.set(e,new Set([i]))}}var G=r(13934),Ze=r(39114),Ct=r(62483),_e=r(67857),xt=r(15197),$e=r(16396),Ee=r(1956),Et=r(651),Rt=r(91056),It=r(12407),Je=r(64127),te=r(67969),De=r(2078);class Re extends Rt.A{constructor(e,i,s){super(e,i,s)}initializeProgram(e){return new It.$(e.rctx,Re.shader.get().build(this.configuration),Ze.i)}initializePipeline(){return(0,De.sm)({depthTest:{func:te.wb.LESS},depthWrite:De.LZ,colorWrite:De.BK,stencilWrite:this.configuration.hasOccludees?Je.s3:null,stencilTest:this.configuration.hasOccludees?Je.RY:null})}}Re.shader=new Et.J(Ee.b,()=>r.e(9298).then(r.bind(r,99298)));var re=r(87601),Mt=r(41528);class ie extends Mt.W{constructor(){super(...arguments),this.output=G.H.Color,this.hasSlicePlane=!1,this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1}}(0,g._)([(0,re.o)({count:G.H.COUNT})],ie.prototype,"output",void 0),(0,g._)([(0,re.o)()],ie.prototype,"hasSlicePlane",void 0),(0,g._)([(0,re.o)()],ie.prototype,"drawScreenSize",void 0),(0,g._)([(0,re.o)()],ie.prototype,"useFixedSizes",void 0),(0,g._)([(0,re.o)()],ie.prototype,"hasOccludees",void 0),(0,g._)([(0,re.o)()],ie.prototype,"clippingEnabled",void 0),(0,g._)([(0,re.o)({constValue:!0})],ie.prototype,"hasSliceInVertexProgram",void 0);var Xe=r(83994),Ye=r(40852);const Ot={positions:[new Ye.G($e.T.POSITION,3,te.g.FLOAT,0,12)],colors:[new Ye.G($e.T.COLOR,3,te.g.UNSIGNED_BYTE,0,3,!0)]};class At{get needsHighlight(){return this._highlights.hasHighlights}constructor(e){this._params=e,this.type=_e.q7.PCL,this.isGround=!1,this._passParameters=new Ee.P,this._highlights=new St({forEachNode:i=>this.forEachNode(i),addHighlight:(i,s,n)=>this._addHighlight(i,s,n),removeHighlight:(i,s)=>this._removeHighlight(i,s)}),this.canRender=!0,this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new ie,this._nodes=new gt.Z}initializeRenderContext(e){this._context=e,this._techniqueRepository=this._context.techniqueRepository,e.requestRender()}uninitializeRenderContext(){}intersect(e,i,s,n){const o=(0,ge.c)(),a=(0,ge.c)(),l=(0,ge.c)(),d=(0,ge.c)(),c=(0,k.Ue)(),_=e.camera.perScreenPixelRatio/2,y=e.camera.near;(0,u.b)(a,n,s);const M=1/(0,u.l)(a);(0,u.g)(a,a,M),(0,u.o)(l,a),(0,_t.s)(c,a[0],a[1],a[2],-(0,u.e)(a,s));const v=new Ue,R=new Ue,V=new Array,D=(0,N.Ue)(),de=(0,N.Ue)(this._passParameters.clipBox);(0,N.cv)(de,-s[0],-s[1],-s[2],de),this._nodes.forAll(m=>{const T=m.splatSize*this._passParameters.scaleFactor;let B=(0,ee.JH)(m.obb,c),se=(0,ee.n3)(m.obb,c);if(B-=ze(T,B+y,this._passParameters,_,m.isLeaf),se-=ze(T,se+y,this._passParameters,_,m.isLeaf),se<0||null!=v.dist&&null!=R.dist&&v.dist<B*M&&R.dist>se*M)return;const we=Ne(T,se+y,this._passParameters,_,m.isLeaf);if(!(0,ee.fn)(m.obb,s,a,we))return;const $t=we*we;(0,ee.mr)(m.obb,D),(0,N.cv)(D,-s[0],-s[1],-s[2],D);const Jt=!(0,N.r3)(de,D);(0,u.b)(d,m.origin,s);const Xt=m.coordinates.length/3;for(let oe=0;oe<Xt;oe++){if(o[0]=d[0]+m.coordinates[3*oe],o[1]=d[1]+m.coordinates[3*oe+1],o[2]=d[2]+m.coordinates[3*oe+2],Jt&&!(0,N.BD)(de,o))continue;const me=(0,u.e)(o,a),it=(0,u.p)(o)-me*me;if(it>$t)continue;let Be=me+y;const Fe=ze(T,Be,this._passParameters,_,m.isLeaf);if(me-Fe<0)continue;Be-=Fe;const st=Ne(T,Be,this._passParameters,_,m.isLeaf);if(it>st*st)continue;const he=(me-Fe)*M,He=J=>(J.point=zt(m,oe,J.point),J.dist=he,J.normal=l,J.node=m,J.pointId=oe,J.layerUid=this.layerUid,J);if((null==v.dist||he<v.dist)&&(null==i||i(s,n,he))&&He(v),e.options.store!==_e.eC.MIN&&(null==R.dist||he>R.dist)&&(null==i||i(s,n,he))&&He(R),e.options.store===_e.eC.ALL&&(null==i||i(s,n,he))){const J=new Ue;V.push(He(J))}}});const Te=m=>{const{layerUid:T,node:B,pointId:se}=m;return new mt.AK(m.point,T,se,()=>this._params.createGraphic(B,se,m.point))},fe=(m,T)=>{const B=Te(T);m.set(this.type,B,T.dist,T.normal)};if(qe(v)){const m=e.results.min;(null==m.dist||v.dist<m.dist)&&fe(m,v)}if(qe(R)&&e.options.store!==_e.eC.MIN){const m=e.results.max;(null==m.dist||R.dist>m.dist)&&fe(m,R)}if(e.options.store===_e.eC.ALL){const m=(0,ft.zk)(s,n);for(const T of V){const B=(0,Ct.LP)(m);fe(B,T),e.results.all.push(B)}}}prepareTechnique(e){return 0===this._nodes.length||e.output!==G.H.Color&&e.output!==G.H.Depth&&e.output!==G.H.Highlight?null:(this._nodes.forAll(i=>{null==i.vao&&this._initNode(e,i)}),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output===G.H.Depth?G.H.Depth:e.output===G.H.Highlight?G.H.Highlight:G.H.Color,this._techniqueRepository.releaseAndAcquire(Re,this._techniqueConfig,this._technique))}render(e,i){const s=e.rctx,n=s.bindTechnique(i,this._passParameters,e.bindParameters),o=e.output===G.H.Highlight;this._nodes.forAll(a=>{0===a.coordinates.length||o&&!a.highlights||(n.bindDraw(a,e.bindParameters,this._passParameters),s.bindVAO(a.vao),o?this._renderHighlightFragments(s,a):s.drawArrays(te.MX.POINTS,0,a.coordinates.length/3))})}_renderHighlightFragments(e,i){const s=i.highlights;if((0,h.Wi)(s))return;let n=(0,h.Wg)(s[0].component),o=n+1;for(let l=1;l<s.length;l++){const d=(0,h.Wg)(s[l].component);if(d!==o){const c=o-n;c>0&&e.drawArrays(te.MX.POINTS,n,c),n=d}o=d+1}const a=o-n;a>0&&e.drawArrays(te.MX.POINTS,n,a)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){(0,N.t8)(this._passParameters.clipBox,e||N.bd)}get _clippingEnabled(){return!(0,N.fS)(this._passParameters.clipBox,N.bd,(e,i)=>e===i)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let i=null;return this._nodes.filterInPlace(s=>s.id!==e||(i=s,s.vao=(0,h.M2)(s.vao),this._highlights.nodeRemoved(s),!1)),this._requestRender(),i}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll(e=>e.vao=(0,h.M2)(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}_addHighlight(e,i,s){e.highlights=function Ut(t,e,i){(0,h.Wi)(t)&&(t=[]);const s={component:e,id:i};t.push(s);const n=ke(s);let o=t.length-1;for(;o>0&&n<ke(t[o-1]);)[t[o-1],t[o]]=[t[o],t[o-1]],--o;return t}(e.highlights,i,s),this._requestRender()}_removeHighlight(e,i){e.highlights=function Lt(t,e){if((0,h.Wi)(t))return t;const i=t.filter(s=>s.id!==e);return 0===i.length?null:i}(e.highlights,i),this._requestRender()}_initNode(e,i){const s=e.rctx;i.vao=new xt.U(s,Ze.i,Ot,{positions:Xe.f.createVertex(s,te.l1.STATIC_DRAW,i.coordinates),colors:Xe.f.createVertex(s,te.l1.STATIC_DRAW,i.rgb)})}_requestRender(){this._context&&this._context.requestRender()}}class Dt extends Ee.a{constructor(e,i,s,n,o,a,l,d,c=null,_=null){super(s,o,i),this.id=e,this.obb=n,this.coordinates=a,this.rgb=l,this.attributes=d,this.pointIdFilterMap=c,this.highlights=_}}function Ne(t,e,i,s,n){if(i.drawScreenSpace)return i.fixedSize*e*s;const o=(0,Ee.g)(n)*e*s;return i.useFixedSizes?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*e*s,t/2),o):Math.min(t/2,o)}function ze(t,e,i,s,n){return i.drawScreenSpace?0:Ne(t,e,i,s,n)}function zt(t,e,i){return(0,h.Wi)(i)&&(i=(0,ge.c)()),i[0]=t.origin[0]+t.coordinates[3*e],i[1]=t.origin[1]+t.coordinates[3*e+1],i[2]=t.origin[2]+t.coordinates[3*e+2],i}function ke(t){return(0,h.pC)(t.component)?t.component:-1}class Ue{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function qe(t){return(0,h.pC)(t.dist)&&(0,h.pC)(t.point)&&(0,h.pC)(t.pointId)&&(0,h.pC)(t.node)}var Wt=r(40465),Tt=r(55745),et=r(39135),wt=r(41632),Bt=r(5894),Ft=r(45611),Le=r(93579),Ht=r(87091);const jt=(0,k.Ue)();let z=class extends((0,Wt.i)((0,ae.A)(Ft.Z))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new U.b,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[]}get baseUrl(){return this.layer.parsedUrl.path}get pointScale(){const t=function ut(t){const e=null==t?void 0:t.pointSizeAlgorithm;return e&&"splat"===e.type?e:null}(this.layer&&this.layer.renderer);return t&&null!=t.scaleFactor?t.scaleFactor:1}get useRealWorldSymbolSizes(){const t=Qe(this.layer&&this.layer.renderer);return!(!t||null==t.useRealWorldSymbolSizes)&&t.useRealWorldSymbolSizes}get pointSize(){const t=Qe(this.layer&&this.layer.renderer);return t&&null!=t.size?t.size:0}get inverseDensity(){return this.layer&&this.layer.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const t=je(this.layer),e=new Set;t.primaryAttribute&&e.add(t.primaryAttribute.name),t.modulationAttribute&&e.add(t.modulationAttribute.name);const i=Ke(this.layer);if(i)for(const s of i)s.attributeInfo&&e.add(s.attributeInfo.name);if(this.layer.outFields)for(const s of(0,be.Lk)(this.layer.fieldsIndex,this.layer.outFields))e.add(s);return Array.from(e)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const t=(0,N.Ue)();return(0,Tt.O)(this.view.clippingArea,t,this.view.renderSpatialReference)?t:null}get _elevationOffset(){const t=this.layer&&this.layer.elevationInfo;if(t&&"absolute-height"===t.mode){const e=(0,H._R)(this.layer.spatialReference),i=(0,L.Z7)(t.unit);return(0,h.Pt)(t.offset,0)*i/e}return 0}initialize(){const t=this.view.resourceController;this._worker=new Ce(s=>t.immediate.schedule(s)),this.addResolvingPromise(this._worker.promise),this._tmpPoint=(0,Pe.Tx)(0,0,0,this.layer.spatialReference),(0,$.zW)(this.layer),(0,$.yS)(this.layer,this.view),this._indexRequester=t.createStreamDataRequester(et.Bh.I3S_INDEX),this._dataRequester=t.createStreamDataRequester(et.Bh.I3S_DATA),this._initRenderer();const e=this._initNodePages(),i=this.view.resourceController.memoryController;this._memCache=i.newCache(this.layer.uid),this.updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),P.nn),this.updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),P.nn),this.updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),P.nn),this.updatingHandles.add(()=>this.layer.filters,()=>this._reload(),P.nn),this.updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),P.nn),this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this.updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.handles.add([this.view.basemapTerrain.on("scale-change",s=>this._scaleUpdateHandler(s)),(0,P.YP)(()=>i.memoryFactor,()=>this._setUpdateViewNeeded(),P.Z_)]),this.addResolvingPromise(e),this.when(()=>{this.handles.add([t.scheduler.registerTask(Ht.T8.POINT_CLOUD_LAYER,this),t.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this.updatingHandles.add(()=>this.suspended,s=>{s?this._clearNodeState():this._setUpdateViewNeeded()},P.nn)])},()=>{this.updatingHandles.removeAll(),this.handles.removeAll()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=(0,h.SC)(this._worker),this._destroyRenderer(),this._memCache=(0,h.SC)(this._memCache),this._codedDomainPopulationAbortController=(0,h.IM)(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new At({createGraphic:(t,e,i)=>this._createGraphic(t,e,i)}),this._renderer.layerUid=this.layer.uid,this.updatingHandles.add(()=>this._clippingBox,t=>this._renderer.clippingBox=t,P.nn),this.updatingHandles.add(()=>this.suspended,t=>this._setPointsVisible(!t),P.nn),this.updatingHandles.add(()=>this.pointScale,t=>this._renderer.scaleFactor=t,P.nn),this._renderer.minSizePx=Math.sqrt(2),this.updatingHandles.add(()=>this.useRealWorldSymbolSizes,t=>this._renderer.useRealWorldSymbolSizes=t,P.nn),this.updatingHandles.add(()=>this.pointSize,t=>{const e=(0,O.F2)(t);this._renderer.size=t,this._renderer.sizePx=e},P.nn),this.updatingHandles.add(()=>this.slicePlaneEnabled,t=>this._renderer.slicePlaneEnabled=t,P.nn),this.updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),P.nn),this.updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),P.nn),this.updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,t=>{this._lodFactor=t,this._setUpdateViewNeeded()},P.nn)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(t,e,i){const s=(0,h.pC)(t.pointIdFilterMap)?t.pointIdFilterMap[e]:e,n=this.view.computeMapPointFromVec3d(i),o=this._createGraphicAttributes(t,s);return new pe({pointCloudMetadata:{nodeId:t.id,pointIndexInNode:e,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:n,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(t,e){const i={};for(const s of t.attributes)this._encodeGraphicAttribute(s.attributeInfo,s.values,e,i);return i}_encodeGraphicAttribute(t,e,i,s){var a,l;const n=null==(a=t.storageInfo)?void 0:a.attributeValues,o=null!=(l=null==n?void 0:n.valuesPerElement)?l:1;if(1===o)s[t.name]=e[i];else if("UInt8"===(null==n?void 0:n.valueType)&&o<=4){let d=0;const c=i*o;for(let _=c;_<c+o;_++)d=(d<<8)+e[_];s[t.name]=d}else s[t.name]=void 0}_setPointsVisible(t){t&&!this._rendererAdded?(this.view._stage.addRenderPlugin([Bt.r.OPAQUE_MATERIAL],this._renderer),this._rendererAdded=!0):!t&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=function ct(t){const e=null==t?void 0:t.pointSizeAlgorithm;return!(!e||!e.type)&&"fixed-size"===e.type}(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(t){const e=this.layer.effectiveScaleRange;(0,Le.Av)(e.minScale,e.maxScale)?(0,X.dH)(t.extent,t.spatialReference,tt,this.layer.spatialReference)&&(this._nodeScales.forEach((i,s)=>{if(!this._renderedNodes.has(s))return void this._nodeScales.delete(s);const n=this._index.getNode(s);(0,Y.BD)(tt,n.obb.center)&&this._nodeScales.set(s,t.scale)}),this._setUpdateViewNeeded()):this._nodeScales.clear()}_displayNodes(t){this._workQueue=function xe(t,e,i){for(let n=0;n<e.length;n++)W[n]=!1,q[n]=null;for(let n=0;n<t.length;n++)A[n]=!1,x[n]=null;for(let n=0;n<e.length;n++){const o=Ve(e[n],t,i);o>=0&&(W[n]=!0,null!=x[o]?x[o].push(e[n]):x[o]=[e[n]])}for(let n=0;n<t.length;n++){const o=Ve(t[n],e,i);o>=0&&(A[n]=!0,null!=q[o]?q[o].push(t[n]):q[o]=[t[n]])}const s=[];for(let n=0;n<t.length;n++)null!=x[n]||A[n]||s.push({load:[],remove:[t[n]]});for(let n=0;n<e.length;n++)null!=q[n]||W[n]||s.push({load:[e[n]],remove:[]});for(let n=0;n<e.length;n++)null!=q[n]&&(q[n].length>1||q[n][0]!==e[n])&&s.push({load:[e[n]],remove:q[n]});for(let n=0;n<t.length;n++)null!=x[n]&&(x[n].length>1||x[n][0]!==t[n])&&s.push({load:x[n],remove:[t[n]]});return s}([...this._renderedNodes],t,this._index),function nt(t,e,i){t.sort((s,n)=>{if(0===s.load.length&&0===n.load.length)return 0;if(0===s.load.length)return-1;if(0===n.load.length)return 1;if(0===s.remove.length&&0===n.remove.length){const o=i.getRenderCenter(s.load[0]),a=i.getRenderCenter(n.load[0]);return(0,u.e)(o,e)-(0,u.e)(a,e)}if(0===s.remove.length)return-1;if(0===n.remove.length)return 1;if(1===s.load.length&&1===n.load.length){const o=i.getRenderCenter(s.load[0]),a=i.getRenderCenter(n.load[0]);return(0,u.e)(o,e)-(0,u.e)(a,e)}if(1===s.load.length)return-1;if(1===n.load.length)return 1;{const o=i.getRenderCenter(s.remove[0]),a=i.getRenderCenter(n.remove[0]);return(0,u.e)(o,e)-(0,u.e)(a,e)}})}(this._workQueue,this.view.state.contentCamera.viewForward,this._index),function rt(t,e,i){for(let s=0;s<t.length;++s){const n=t[s];n.load.length>e&&1===n.remove.length&&ot(t,n,i)}}(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=t.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const t=new Array;this._loadingNodes.forEach(({abortController:e})=>t.push(e)),this._loadingNodes.clear();for(const e of t)e.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const t=new Set;this._workQueue.forEach(s=>s.load.forEach(n=>t.add(n)));const e=new Array,i=new Map;this._loadingNodes.forEach((s,n)=>{t.has(n)?i.set(n,s):e.push(s)}),this._loadingNodes=i;for(const{abortController:s}of e)s.abort();this._workQueue=this._workQueue.filter(s=>{for(const n of s.load)if(this._loadingNodes.has(n))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:t})=>t.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(t=>this._removeFromRenderer(t)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(t){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const e=this._isRootNodeVisible();e!==this._layerIsVisible&&(this._layerIsVisible=e,this.notifyChange("suspended")),this._updateLoading()}}else{for(t.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&t.run(()=>this._processIndexQueue()););this._processWorkQueue(t),this._idleQueue.runTask(t)}}_processIndexQueue(){const t=this._indexQueue.shift(),e=this._loadNodePage(t);return this._indexPagesLoading.set(t,e),e.promise.then(i=>{this._index.addPage(t,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(t)},()=>{this._indexPagesLoading.delete(t)}),!0}_processWorkQueue(t){for(;!t.done;){const e=this._scheduleWorkEntry();if((0,h.Wi)(e))return;this._processWorkEntry(e),t.madeProgress()}}_scheduleWorkEntry(){let t=this._workQueue.length;for(;t--;){const e=this._workQueue.shift();if(!e.remove.find(i=>!this._renderedNodes.has(i)))return e;this._workQueue.push(e)}return null}_processWorkEntry(t){if(0!==t.load.length)Promise.all(t.load.map(e=>{const i=new AbortController,s=this._memCache.pop(e.toString());return(0,h.pC)(s)?this._loadingNodes.set(e,{abortController:i,promise:Promise.resolve(s)}):this._loadingNodes.has(e)||this._loadingNodes.set(e,{abortController:i,promise:this._loadNode(e,i.signal)}),this._loadingNodes.get(e).promise})).then(e=>{for(let i=0;i<t.load.length;i++)if(e[i]){const s=this._setupRendererData(t.load[i],e[i]);this._addToRenderer(s)}for(const i of t.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(const e of t.load)this._loadingNodes.delete(e);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const e of t.remove)this._removeFromRenderer(e)}_populateClassCodeCodedDomain(t,e){var i=this;return(0,f.Z)(function*(){const s="CLASS_CODE",n=i.layer.fieldsIndex.get(s);if(!n||n.domain||!t.includes(n.name))return;const o=yield(0,j.q6)(i.layer.queryCachedStatistics(s,{signal:e}));if(!1===o.ok)return;const a=o.value,l=a&&a.labels&&a.labels.labels;l&&Array.isArray(l)&&(n.domain=new ue.Z({name:"CLASS_CODE",codedValues:l.map(d=>new ye.u({code:d.value,name:d.label}))}))})()}prepareFetchPopupFeatures(t){var e=this;return(0,f.Z)(function*(){return e._codedDomainPopulationPromise||(e._codedDomainPopulationAbortController=new AbortController,e._codedDomainPopulationPromise=e._populateClassCodeCodedDomain(t,e._codedDomainPopulationAbortController.signal).then(()=>{e._codedDomainPopulationAbortController=null})),e._codedDomainPopulationPromise})()}whenGraphicAttributes(t,e){var i=this;return(0,f.Z)(function*(){const s=i._splitGraphicsPerNode(t),n=i.layer.attributeStorageInfo,o=e.map(d=>ce(n,d)).filter(h.pC),a=function(){var d=(0,f.Z)(function*(c,_){const y=i._index.getNode(_);yield(0,j.Ed)(o,function(){var M=(0,f.Z)(function*(v){const R=v.useElevation?yield i._loadElevationAttributeFromGeometry(y.resourceId):yield i._loadAndParseAttribute(y,v);if(R)for(const V of c)i._isValidPointGraphic(V)&&i._encodeGraphicAttribute(v,R,V.pointCloudMetadata.attributePointIndexInNode,V.attributes)});return function(v){return M.apply(this,arguments)}}())});return function(_,y){return d.apply(this,arguments)}}(),l=[];return s.forEach((d,c)=>{l.push(a(d,c))}),yield(0,b.as)(l),t})()}_isValidPointGraphic(t){return t instanceof pe&&t.pointCloudMetadata&&t.pointCloudMetadata.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(t){const e=new Map;for(const i of t){if(!this._isValidPointGraphic(i))continue;const s=i.pointCloudMetadata,n=e.get(s.nodeId);n?n.push(i):e.set(s.nodeId,[i])}return e}_loadAndParseAttribute(t,e){var i=this;return(0,f.Z)(function*(){const s=yield i._loadAttribute(t.resourceId,e,null);return(0,h.pC)(s)?(0,Ae.dH)({attributeInfo:e,buffer:s},null,t.vertexCount):null})()}_loadElevationAttributeFromGeometry(t){var e=this;return(0,f.Z)(function*(){const s=(0,Ae.Ym)(e.layer.store.defaultGeometrySchema,yield e._loadGeometry(t,null));return(0,Ae.et)(s,s.length/3)})()}highlight(t){if(!t)return{remove(){}};const e=K.Z.isCollection(t)?t.toArray():Array.isArray(t)?t:[t];return this._renderer.highlight(e.map(i=>this._graphicToPointDefinition(i)))}_graphicToPointDefinition(t){if(!this._isValidPointGraphic(t))return null;const{nodeId:e,pointIndexInNode:i}=t.pointCloudMetadata;return null!=e&&null!=i?{nodeId:e,pointId:i}:null}_computeWork(){let t=0;for(const e of this._workQueue)t+=e.load.length+e.remove.length;return t+=this._loadingNodes.size,t+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,t+=this._loadingInitNodePage?100:0,t+=this._updateViewNeeded?100:0,t}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const t=this._computeWork();return 1-Math.min(this._totalWork,t)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const t=this.layer.store.index;return this._index=new at(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,t.nodesPerPage||t.nodePerIndexBlock),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).promise.then(i=>{this._index.addPage(0,i,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(t){const e=new AbortController;return{promise:this._requestNodePage(`${this.baseUrl}/nodepages/${t*this._pageMultiplier}`,e.signal).then(s=>s.nodes.map((n,o)=>{var a,l;return{resourceId:null!=n.resourceId?n.resourceId:t*this._index.pageSize+o,obb:n.obb,firstChild:n.firstChild,childCount:n.childCount,vertexCount:null!=(a=n.vertexCount)?a:n.pointCount,lodThreshold:null!=(l=n.lodThreshold)?l:n.effectiveArea}})),abortController:e}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;let t=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor();const e=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor();let i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(s/(.75*e));for(;s>e;)t*=n,i=this._computeNodesForMinimumDensity(t),s=this._computePointCount(i),n=Math.sqrt(2);return this._displayNodes(i),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(t){let e=0;for(let i=0;i<t.length;i++){const s=this._index.getNode(t[i]);s&&(e+=s.vertexCount)}return e}_getLodMemoryFactor(){return this.view.resourceController.memoryController.memoryFactor}_isRootNodeVisible(){let t=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(e,i,s)=>(t=s,!1),pageMiss:()=>{}}),t}_computeNodesForMinimumDensity(t){const e=this.view.state.contentCamera,i=e.frustum,s=this._clippingBox,n=e.viewForward,o=(0,u.e)(n,e.eye),a=(0,k.Oy)(n,-o,jt),l=e.perScreenPixelRatio/2,d=t*t,c=this._nodeIdArray;c.length=0;const{minScale:_,maxScale:y}=(0,Le.lu)(this.layer),M=0===_&&0===y?v=>c.push(v):v=>{const R=this._getScale(v);(0,Le.rs)(R,_,y)&&c.push(v)};return this._traverseVisible({frustum:i,clippingBox:s},{predicate:(v,R,V)=>{if(!V)return!1;if(0===R.childCount)return M(v),!1;const D=this._index.getRenderObb(v);return!(this._computeAveragePixelArea(D,R.lodThreshold,R.vertexCount,a,l)<=d&&(M(v),1))},pageMiss:(v,R)=>{M(v),this._indexQueue.includes(R)||this._indexQueue.push(R)}}),c}_getScale(t){let e=this._nodeScales.get(t);if(null==e){const i=this._index.getNode(t).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],e=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(t,e)}return e}_computeAveragePixelArea(t,e,i,s,n){const a=Math.max(1e-7,(0,ee.JH)(t,s));return e/(a*a)/(4*n*n)/i}_loadNode(t,e){try{return this._loadNodeAsync(t,e)}catch(i){throw(0,b.D_)(i)||F.Z.getLogger(this.declaredClass).error(i),i}}_loadAdditionalUserAttributes(t,e,i){var s=this;return(0,f.Z)(function*(){const n=s.layer.outFields;if(!n)return[];const o=(0,be.Lk)(s.layer.fieldsIndex,n),a=new Set(t.map(_=>(0,h.pC)(_)?_.name:null)),l=s.layer.attributeStorageInfo,d=[];for(const _ of o){if(a.has(_))continue;const y=ce(l,_);y&&d.push(e(y))}const c=yield(0,b.WW)(d);return(0,b.k_)(i),(0,h.e8)(c,_=>_)})()}_loadNodeAsync(t,e){var i=this;return(0,f.Z)(function*(){const s=i._index.getNode(t),n=je(i.layer),o=Ke(i.layer),a=s.resourceId,l=function(){var d=(0,f.Z)(function*(c){if((0,h.Wi)(c))return null;if(c.useElevation)return{attributeInfo:c,buffer:null};const _=yield i._loadAttribute(a,c,e);return(0,h.pC)(_)?{attributeInfo:c,buffer:_}:null});return function(_){return d.apply(this,arguments)}}();return i._idleQueue.push((0,f.Z)(function*(){const d=i._loadGeometry(a,e),{primaryAttribute:c,modulationAttribute:_}=n,y=l(c),M=l(_),v=o.map(B=>B.attributeInfo),R=v.map(B=>l(B)),V=i._loadAdditionalUserAttributes([c,_,...v],l,e),[D,de,Te,fe,m]=yield Promise.all([d,y,M,Promise.all(R),V]);(0,b.k_)(e);const T={geometryBuffer:D,primaryAttributeData:de,modulationAttributeData:Te,filterAttributesData:fe,userAttributesData:m,schema:i.layer.store.defaultGeometrySchema,rendererInfo:n,filterInfo:o,obb:i._index.getRenderObb(t),elevationOffset:i._elevationOffset,inSR:i.layer.spatialReference.toJSON(),outSR:i.view.renderCoordsHelper.spatialReference.toJSON()};return i._worker.invoke(T,e)}),e)})()}_loadGeometry(t,e){var i=this;return(0,f.Z)(function*(){return i._requestData(`${i.baseUrl}/nodes/${t}/geometries/0`,e)})()}_loadAttribute(t,e,i){var s=this;return(0,f.Z)(function*(){return(0,h.Wi)(e)||!e.storageInfo?null:s._requestData(`${s.baseUrl}/nodes/${t}/attributes/${e.storageInfo.key}`,i)})()}_requestNodePage(t,e){return this._indexRequester.request(t,"json",{query:{f:"json",token:this.layer.apiKey},signal:e})}_requestData(t,e){return this._dataRequester.request(t,"binary",{query:{token:this.layer.apiKey},signal:e})}_removeFromRenderer(t){if(this._renderedNodes.has(t)){const e=this._renderer.removeNode(t);this._renderedNodes.delete(t),this._nodeScales.delete(t),this._memCache.put(e.id.toString(),e,function Qt(t){return 5*t.coordinates.length+128}(e))}}_addToRenderer(t){this._renderedNodes.has(t.id)||(this._renderedNodes.add(t.id),this._renderer.addNode(t))}_setupRendererData(t,e){const i=this._index.getNode(t),s=Math.sqrt(i.lodThreshold/i.vertexCount),n=this._index.getRenderObb(t);if(function Nt(t){return t.hasOwnProperty("splatSize")}(e))return e.splatSize=s,e.obb=n,(0,u.c)(e.origin,e.obb.center),e;const o=.01*Math.max(n.halfSize[0],n.halfSize[1],n.halfSize[2]);if(e.obb.halfSize[0]>n.halfSize[0]+o||e.obb.halfSize[1]>n.halfSize[1]+o||e.obb.halfSize[2]>n.halfSize[2]+o){if(this._maxLoggedBoxWarnings>0){const a=l=>`[${l.halfSize[0]}, ${l.halfSize[1]}, ${l.halfSize[2]}]`;F.Z.getLogger(this.declaredClass).warn(`Node ${t} reported bounding box too small. got ${a(n)} but points cover ${a(e.obb)}`),0==--this._maxLoggedBoxWarnings&&F.Z.getLogger(this.declaredClass).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(t,e.obb)}return new Dt(t,s,(0,I.b)(n.center),n,0===i.childCount,e.points,e.rgb,e.attributes,e.pointIdFilterMap)}getUsedMemory(){let t=0;return this._renderer.forEachNode(e=>{t+=We,t+=(0,w.Xw)(e.coordinates);for(const i of e.attributes){const s=i.values;(0,w.eP)(s.buffer)&&(t+=(0,w.Xw)(s))}}),t}getUnloadedMemory(){const t=this._renderedNodes.size;if(t<4)return 0;const e=[...this._renderedNodes].reduce((s,n)=>s+this._index.getNode(n).vertexCount);let i=this._loadingNodes.size;for(let s=0;s<this._workQueue.length;s++)i+=this._workQueue[s].load.length,i-=this._workQueue[s].remove.length;return i<0?0:i*e/t*((this.getUsedMemory()-t*We)/e)+i*We}ignoresMemoryFactor(){return!1}get performanceInfo(){return{nodes:this._renderedNodes.size,displayedNumberOfFeatures:[...this._renderedNodes].reduce((t,e)=>t+this._index.getNode(e).vertexCount,0),maximumNumberOfFeatures:this.maximumPointCount,totalNumberOfFeatures:-1,core:null,"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length}}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};(0,g._)([(0,E.Cb)()],z.prototype,"layer",void 0),(0,g._)([(0,E.Cb)()],z.prototype,"baseUrl",null),(0,g._)([(0,E.Cb)()],z.prototype,"pointScale",null),(0,g._)([(0,E.Cb)()],z.prototype,"useRealWorldSymbolSizes",null),(0,g._)([(0,E.Cb)()],z.prototype,"pointSize",null),(0,g._)([(0,E.Cb)()],z.prototype,"inverseDensity",null),(0,g._)([(0,E.Cb)()],z.prototype,"maximumPointCount",void 0),(0,g._)([(0,E.Cb)({readOnly:!0})],z.prototype,"availableFields",null),(0,g._)([(0,E.Cb)({readOnly:!0})],z.prototype,"_clippingBox",null),(0,g._)([(0,E.Cb)({readOnly:!0})],z.prototype,"_elevationOffset",null),(0,g._)([(0,E.Cb)({type:Boolean})],z.prototype,"slicePlaneEnabled",void 0),(0,g._)([(0,E.Cb)()],z.prototype,"updating",void 0),(0,g._)([(0,E.Cb)(wt.q)],z.prototype,"updatingProgress",void 0),(0,g._)([(0,E.Cb)({readOnly:!0})],z.prototype,"updatingProgressValue",null),z=(0,g._)([(0,p.j)("esri.views.3d.layers.PointCloudLayerView3D")],z);const Kt=z,tt=(0,Y.Ue)(),We=160},45611:(ve,Z,r)=>{r.d(Z,{Z:()=>C});var f=r(17626),g=r(14517),j=r(61885),K=r(80542),F=r(61996),h=r(63290),b=r(62208),P=r(60330),O=r(77712),E=(r(90912),r(85931),r(76898));let S=class extends((0,K.p)((0,F.IG)((0,P.v)(j.Z.EventedMixin(g.Z))))){constructor(p){super(p),this.layer=null,this.parent=null}initialize(){this.when().catch(p=>{if("layerview:create-error"!==p.name){const u=this.layer&&this.layer.id||"no id",I=this.layer&&this.layer.title||"no title";h.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${I}', id: '${u}')`,p)}})}get fullOpacity(){return(0,b.Pt)(this.get("layer.opacity"),1)*(0,b.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){var p;return!this.suspended&&!0===(null==(p=this.layer)?void 0:p.legendEnabled)}get updating(){var p;return!!(null!=(p=this.updatingHandles)&&p.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var p;return!0===(null==(p=this.layer)?void 0:p.visible)}set visible(p){this._overrideIfSome("visible",p)}canResume(){var p,u,I;return this.visible&&(null==(p=this.layer)?void 0:p.loaded)&&!(null!=(u=this.parent)&&u.suspended)&&(null==(I=this.view)?void 0:I.ready)||!1}getSuspendInfo(){const p=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(p.viewNotReady=!0),this.layer&&this.layer.loaded||(p.layerNotLoaded=!0),this.visible||(p.layerInvisible=!0),p}isUpdating(){return!1}};(0,f._)([(0,O.Cb)()],S.prototype,"fullOpacity",null),(0,f._)([(0,O.Cb)()],S.prototype,"layer",void 0),(0,f._)([(0,O.Cb)()],S.prototype,"parent",void 0),(0,f._)([(0,O.Cb)({readOnly:!0})],S.prototype,"suspended",null),(0,f._)([(0,O.Cb)({readOnly:!0})],S.prototype,"suspendInfo",null),(0,f._)([(0,O.Cb)({readOnly:!0})],S.prototype,"legendEnabled",null),(0,f._)([(0,O.Cb)({type:Boolean,readOnly:!0})],S.prototype,"updating",null),(0,f._)([(0,O.Cb)({readOnly:!0})],S.prototype,"updatingProgress",null),(0,f._)([(0,O.Cb)()],S.prototype,"visible",null),(0,f._)([(0,O.Cb)()],S.prototype,"view",void 0),S=(0,f._)([(0,E.j)("esri.views.layers.LayerView")],S);const C=S},10023:(ve,Z,r)=>{r.d(Z,{V:()=>h,e:()=>K});var f=r(15861),g=r(62208),j=r(36630);function K(b){return F.apply(this,arguments)}function F(){return(F=(0,f.Z)(function*(b,P=b.popupTemplate){var I,X;if((0,g.Wi)(P))return[];const O=yield P.getRequiredFields(b.fieldsIndex),{lastEditInfoEnabled:w}=P,{objectIdField:H,typeIdField:E,globalIdField:S,relationships:C}=b;if(O.includes("*"))return["*"];const p=w?yield(0,j.CH)(b):[],u=(0,j.Q0)(b.fieldsIndex,[...O,...p]);return E&&u.push(E),u&&H&&(null==(I=b.fieldsIndex)?void 0:I.has(H))&&!u.includes(H)&&u.push(H),u&&S&&(null==(X=b.fieldsIndex)?void 0:X.has(S))&&!u.includes(S)&&u.push(S),C&&C.forEach(N=>{var k;const{keyField:Y}=N;u&&Y&&(null==(k=b.fieldsIndex)?void 0:k.has(Y))&&!u.includes(Y)&&u.push(Y)}),u})).apply(this,arguments)}function h(b,P){return b.popupTemplate?b.popupTemplate:(0,g.pC)(P)&&P.defaultPopupTemplateEnabled&&(0,g.pC)(b.defaultPopupTemplate)?b.defaultPopupTemplate:null}}}]);
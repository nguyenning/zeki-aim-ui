"use strict";var Br=Object.defineProperty,Pr=Object.defineProperties,Ur=Object.getOwnPropertyDescriptors,Cs=Object.getOwnPropertySymbols,Or=Object.prototype.hasOwnProperty,Lr=Object.prototype.propertyIsEnumerable,Fs=(Se,he,M)=>he in Se?Br(Se,he,{enumerable:!0,configurable:!0,writable:!0,value:M}):Se[he]=M,Ie=(Se,he)=>{for(var M in he||(he={}))Or.call(he,M)&&Fs(Se,M,he[M]);if(Cs)for(var M of Cs(he))Lr.call(he,M)&&Fs(Se,M,he[M]);return Se},Re=(Se,he)=>Pr(Se,Ur(he));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[2541],{76279:(Se,he,M)=>{M.d(he,{r:()=>ee});var U=M(14259);function ee(_,m){if(!(this instanceof ee))return new ee(_,m);this._maxEntries=Math.max(4,_||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),m&&("function"==typeof m?this.toBBox=m:this._initFormat(m)),this.clear()}function W(_,m,x){if(!x)return m.indexOf(_);for(var C=0;C<m.length;C++)if(x(_,m[C]))return C;return-1}function F(_,m){Z(_,0,_.children.length,m,_)}function Z(_,m,x,C,A){A||(A=w(null)),A.minX=1/0,A.minY=1/0,A.maxX=-1/0,A.maxY=-1/0;for(var z,R=m;R<x;R++)z=_.children[R],q(A,_.leaf?C(z):z);return A}function q(_,m){return _.minX=Math.min(_.minX,m.minX),_.minY=Math.min(_.minY,m.minY),_.maxX=Math.max(_.maxX,m.maxX),_.maxY=Math.max(_.maxY,m.maxY),_}function ue(_,m){return _.minX-m.minX}function N(_,m){return _.minY-m.minY}function K(_){return(_.maxX-_.minX)*(_.maxY-_.minY)}function se(_){return _.maxX-_.minX+(_.maxY-_.minY)}function Y(_,m){return(Math.max(m.maxX,_.maxX)-Math.min(m.minX,_.minX))*(Math.max(m.maxY,_.maxY)-Math.min(m.minY,_.minY))}function J(_,m){var x=Math.max(_.minX,m.minX),C=Math.max(_.minY,m.minY),A=Math.min(_.maxX,m.maxX),z=Math.min(_.maxY,m.maxY);return Math.max(0,A-x)*Math.max(0,z-C)}function b(_,m){return _.minX<=m.minX&&_.minY<=m.minY&&m.maxX<=_.maxX&&m.maxY<=_.maxY}function G(_,m){return m.minX<=_.maxX&&m.minY<=_.maxY&&m.maxX>=_.minX&&m.maxY>=_.minY}function w(_){return{children:_,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function L(_,m,x,C,A){for(var z,R=[m,x];R.length;)(x=R.pop())-(m=R.pop())<=C||(z=m+Math.ceil((x-m)/C/2)*C,(0,U.q)(_,z,m,x,A),R.push(m,z,z,x))}ee.prototype={all:function(){return this._all(this.data,[])},search:function(_){var m=this.data,x=[],C=this.toBBox;if(!G(_,m))return x;for(var A,z,R,Q,H=[];m;){for(A=0,z=m.children.length;A<z;A++)R=m.children[A],G(_,Q=m.leaf?C(R):R)&&(m.leaf?x.push(R):b(_,Q)?this._all(R,x):H.push(R));m=H.pop()}return x},collides:function(_){var m=this.data,x=this.toBBox;if(!G(_,m))return!1;for(var C,A,z,R,Q=[];m;){for(C=0,A=m.children.length;C<A;C++)if(z=m.children[C],G(_,R=m.leaf?x(z):z)){if(m.leaf||b(_,R))return!0;Q.push(z)}m=Q.pop()}return!1},load:function(_){if(!_||!_.length)return this;if(_.length<this._minEntries){for(var m=0,x=_.length;m<x;m++)this.insert(_[m]);return this}var C=this._build(_.slice(),0,_.length-1,0);if(this.data.children.length)if(this.data.height===C.height)this._splitRoot(this.data,C);else{if(this.data.height<C.height){var A=this.data;this.data=C,C=A}this._insert(C,this.data.height-C.height-1,!0)}else this.data=C;return this},insert:function(_){return _&&this._insert(_,this.data.height-1),this},clear:function(){return this.data=w([]),this},remove:function(_,m){if(!_)return this;for(var x,C,A,z,R=this.data,Q=this.toBBox(_),H=[],E=[];R||H.length;){if(R||(R=H.pop(),C=H[H.length-1],x=E.pop(),z=!0),R.leaf&&-1!==(A=W(_,R.children,m)))return R.children.splice(A,1),H.push(R),this._condense(H),this;z||R.leaf||!b(R,Q)?C?(x++,R=C.children[x],z=!1):R=null:(H.push(R),E.push(x),x=0,C=R,R=R.children[0])}return this},toBBox:function(_){return _},compareMinX:ue,compareMinY:N,toJSON:function(){return this.data},fromJSON:function(_){return this.data=_,this},_all:function(_,m){for(var x=[];_;)_.leaf?m.push.apply(m,_.children):x.push.apply(x,_.children),_=x.pop();return m},_build:function(_,m,x,C){var A,z=x-m+1,R=this._maxEntries;if(z<=R)return F(A=w(_.slice(m,x+1)),this.toBBox),A;C||(C=Math.ceil(Math.log(z)/Math.log(R)),R=Math.ceil(z/Math.pow(R,C-1))),(A=w([])).leaf=!1,A.height=C;var Q,H,E,k,te=Math.ceil(z/R),de=te*Math.ceil(Math.sqrt(R));for(L(_,m,x,de,this.compareMinX),Q=m;Q<=x;Q+=de)for(L(_,Q,E=Math.min(Q+de-1,x),te,this.compareMinY),H=Q;H<=E;H+=te)k=Math.min(H+te-1,E),A.children.push(this._build(_,H,k,C-1));return F(A,this.toBBox),A},_chooseSubtree:function(_,m,x,C){for(var A,z,R,Q,H,E,k,te;C.push(m),!m.leaf&&C.length-1!==x;){for(k=te=1/0,A=0,z=m.children.length;A<z;A++)H=K(R=m.children[A]),(E=Y(_,R)-H)<te?(te=E,k=H<k?H:k,Q=R):E===te&&H<k&&(k=H,Q=R);m=Q||m.children[0]}return m},_insert:function(_,m,x){var A=x?_:(0,this.toBBox)(_),z=[],R=this._chooseSubtree(A,this.data,m,z);for(R.children.push(_),q(R,A);m>=0&&z[m].children.length>this._maxEntries;)this._split(z,m),m--;this._adjustParentBBoxes(A,z,m)},_split:function(_,m){var x=_[m],C=x.children.length,A=this._minEntries;this._chooseSplitAxis(x,A,C);var z=this._chooseSplitIndex(x,A,C),R=w(x.children.splice(z,x.children.length-z));R.height=x.height,R.leaf=x.leaf,F(x,this.toBBox),F(R,this.toBBox),m?_[m-1].children.push(R):this._splitRoot(x,R)},_splitRoot:function(_,m){this.data=w([_,m]),this.data.height=_.height+1,this.data.leaf=!1,F(this.data,this.toBBox)},_chooseSplitIndex:function(_,m,x){var C,A,z,R,Q,H,E,k;for(H=E=1/0,C=m;C<=x-m;C++)R=J(A=Z(_,0,C,this.toBBox),z=Z(_,C,x,this.toBBox)),Q=K(A)+K(z),R<H?(H=R,k=C,E=Q<E?Q:E):R===H&&Q<E&&(E=Q,k=C);return k},_chooseSplitAxis:function(_,m,x){var C=_.leaf?this.compareMinX:ue,A=_.leaf?this.compareMinY:N;this._allDistMargin(_,m,x,C)<this._allDistMargin(_,m,x,A)&&_.children.sort(C)},_allDistMargin:function(_,m,x,C){_.children.sort(C);var A,z,R=this.toBBox,Q=Z(_,0,m,R),H=Z(_,x-m,x,R),E=se(Q)+se(H);for(A=m;A<x-m;A++)z=_.children[A],q(Q,_.leaf?R(z):z),E+=se(Q);for(A=x-m-1;A>=m;A--)z=_.children[A],q(H,_.leaf?R(z):z),E+=se(H);return E},_adjustParentBBoxes:function(_,m,x){for(var C=x;C>=0;C--)q(m[C],_)},_condense:function(_){for(var m,x=_.length-1;x>=0;x--)0===_[x].children.length?x>0?(m=_[x-1].children).splice(m.indexOf(_[x]),1):this.clear():F(_[x],this.toBBox)},_initFormat:function(_){var m=["return a"," - b",";"];this.compareMinX=new Function("a","b",m.join(_[0])),this.compareMinY=new Function("a","b",m.join(_[1])),this.toBBox=new Function("a","return {minX: a"+_[0]+", minY: a"+_[1]+", maxX: a"+_[2]+", maxY: a"+_[3]+"};")}}},58775:(Se,he,M)=>{M.d(he,{O3:()=>te,lG:()=>oe,my:()=>de,q9:()=>q});var U=M(26584),ee=M(66385),W=M(88071),F=M(36630);const Z={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function q(D){return Z[D]}function*ue(D){switch(D.type){case"Feature":yield D;break;case"FeatureCollection":for(const P of D.features)P&&(yield P)}}function*N(D){if(!D)return null;switch(D.type){case"Point":yield D.coordinates;break;case"LineString":case"MultiPoint":yield*D.coordinates;break;case"MultiLineString":case"Polygon":for(const P of D.coordinates)yield*P;break;case"MultiPolygon":for(const P of D.coordinates)for(const X of P)yield*X}}function se(D){for(const P of D)if(P.length>2)return!0;return!1}function b(D){let P=0;for(let X=0;X<D.length;X++){const le=D[X],xe=D[(X+1)%D.length];P+=le[0]*xe[1]-xe[0]*le[1]}return P<=0}function G(D){const P=D[0],X=D[D.length-1];return P[0]===X[0]&&P[1]===X[1]&&P[2]===X[2]||D.push(P),D}function w(D,P,X){switch(P.type){case"LineString":return function L(D,P,X){return Q(D,P.coordinates,X),D}(D,P,X);case"MultiLineString":return function _(D,P,X){for(const le of P.coordinates)Q(D,le,X);return D}(D,P,X);case"MultiPoint":return function m(D,P,X){return Q(D,P.coordinates,X),D}(D,P,X);case"MultiPolygon":return function x(D,P,X){for(const le of P.coordinates){z(D,le[0],X);for(let xe=1;xe<le.length;xe++)R(D,le[xe],X)}return D}(D,P,X);case"Point":return function C(D,P,X){return E(D,P.coordinates,X),D}(D,P,X);case"Polygon":return function A(D,P,X){const le=P.coordinates;z(D,le[0],X);for(let xe=1;xe<le.length;xe++)R(D,le[xe],X);return D}(D,P,X)}}function z(D,P,X){const le=G(P);!function Y(D){return!b(D)}(le)?Q(D,le,X):H(D,le,X)}function R(D,P,X){const le=G(P);!function J(D){return b(D)}(le)?Q(D,le,X):H(D,le,X)}function Q(D,P,X){for(const le of P)E(D,le,X);D.lengths.push(P.length)}function H(D,P,X){for(let le=P.length-1;le>=0;le--)E(D,P[le],X);D.lengths.push(P.length)}function E(D,P,X){const[le,xe,je]=P;D.coords.push(le,xe),X.hasZ&&D.coords.push(je||0)}function k(D){switch(typeof D){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function te(D){if(!D)throw new U.Z("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==D.type&&"FeatureCollection"!==D.type)throw new U.Z("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:D});const{crs:P}=D;if(!P)return;const X="string"==typeof P?P:"name"===P.type?P.properties.name:"EPSG"===P.type?P.properties.code:null,le=new RegExp(".*(CRS84H?|4326)$","i");if(!X||!le.test(X))throw new U.Z("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:P})}function de(D,P={}){const X=[],le=new Set,xe=new Set;let je,Le=!1,Me=null,We=!1,{geometryType:Oe=null}=P,ke=!1;for(const Qe of ue(D)){const{geometry:Ze,properties:ze,id:Ne}=Qe;if((!Ze||(Oe||(Oe=q(Ze.type)),q(Ze.type)===Oe))&&(Le||(Le=se(N(Ze))),We||(We=null!=Ne,We&&(je=typeof Ne,Me=Object.keys(ze).filter(Ye=>ze[Ye]===Ne))),We&&null!=Ne&&(Me.length>1?Me=Me.filter(Ye=>ze[Ye]===Ne):1===Me.length&&(Me=ze[Me[0]]===Ne?Me:[])),!ke&&ze)){let Ye=!0;for(const Ge in ze){if(le.has(Ge))continue;const it=ze[Ge];if(null==it){Ye=!1,xe.add(Ge);continue}const tt=k(it);"unknown"!==tt?(xe.delete(Ge),le.add(Ge),X.push({name:Ge,alias:Ge,type:tt})):xe.add(Ge)}ke=Ye}}const Ve=Me&&1===Me.length&&Me[0]||null;if(Ve)for(const Qe of X)if(Qe.name===Ve&&(0,F.H7)(Qe)){Qe.type="esriFieldTypeOID";break}return{fields:X,geometryType:Oe,hasZ:Le,objectIdFieldName:Ve,objectIdFieldType:je,unknownFields:Array.from(xe)}}function oe(D,P){return Array.from(function*K(D,P={}){var xe;const{geometryType:X,objectIdField:le}=P;for(const je of D){const{geometry:Le,properties:Me,id:We}=je;if(Le&&q(Le.type)!==X)continue;const Oe=Me||{};let ke=null!=(xe=Oe[le])?xe:null;le&&null!=We&&!Oe[le]&&(Oe[le]=ke=We),yield new ee.u_(Le?w(new W.Z,Le,P):null,Oe,null,ke)}}(ue(D),P))}},7547:(Se,he,M)=>{var U,ee,W,F,Z,q,ue,N,K,se,Y,J,b,G,w,L,_,m,x,C,A,z,R,Q,H,E,k,te,de,oe,D,P,X,le,xe,je,Le,Me,We,Oe,ke,Ve,Qe,Ze,ze,Ne,Ye,Ge,it,tt,ct,st,rt,yt,Ft,gt,ft,nt,It,Mt,vt,g;M.d(he,{$y:()=>z,AH:()=>ee,CS:()=>Ye,DD:()=>N,Dd:()=>de,Em:()=>A,JS:()=>ze,Ky:()=>K,Lh:()=>Ge,Qb:()=>ft,RL:()=>U,RS:()=>It,TF:()=>C,Tx:()=>Z,UR:()=>_,UX:()=>gt,bj:()=>Ne,eZ:()=>ue,id:()=>H,kP:()=>je,r4:()=>Oe,sj:()=>Le,v2:()=>W,zQ:()=>te,zV:()=>L}),(g=U||(U={}))[g.BUTT=0]="BUTT",g[g.ROUND=1]="ROUND",g[g.SQUARE=2]="SQUARE",g[g.UNKNOWN=4]="UNKNOWN",function(g){g[g.BEVEL=0]="BEVEL",g[g.ROUND=1]="ROUND",g[g.MITER=2]="MITER",g[g.UNKNOWN=4]="UNKNOWN"}(ee||(ee={})),function(g){g[g.SCREEN=0]="SCREEN",g[g.MAP=1]="MAP"}(W||(W={})),function(g){g[g.Tint=0]="Tint",g[g.Ignore=1]="Ignore",g[g.Multiply=99]="Multiply"}(F||(F={})),function(g){g.Both="Both",g.JustBegin="JustBegin",g.JustEnd="JustEnd",g.None="None"}(Z||(Z={})),function(g){g[g.Mosaic=0]="Mosaic",g[g.Centered=1]="Centered"}(q||(q={})),function(g){g[g.Normal=0]="Normal",g[g.Superscript=1]="Superscript",g[g.Subscript=2]="Subscript"}(ue||(ue={})),function(g){g[g.MSSymbol=0]="MSSymbol",g[g.Unicode=1]="Unicode"}(N||(N={})),function(g){g[g.Unspecified=0]="Unspecified",g[g.TrueType=1]="TrueType",g[g.PSOpenType=2]="PSOpenType",g[g.TTOpenType=3]="TTOpenType",g[g.Type1=4]="Type1"}(K||(K={})),function(g){g[g.Display=0]="Display",g[g.Map=1]="Map"}(se||(se={})),function(g){g.None="None",g.Loop="Loop",g.Oscillate="Oscillate"}(Y||(Y={})),function(g){g[g.Z=0]="Z",g[g.X=1]="X",g[g.Y=2]="Y"}(J||(J={})),function(g){g[g.XYZ=0]="XYZ",g[g.ZXY=1]="ZXY",g[g.YXZ=2]="YXZ"}(b||(b={})),function(g){g[g.Rectangle=0]="Rectangle",g[g.RoundedRectangle=1]="RoundedRectangle",g[g.Oval=2]="Oval"}(G||(G={})),function(g){g[g.None=0]="None",g[g.Alpha=1]="Alpha",g[g.Screen=2]="Screen",g[g.Multiply=3]="Multiply",g[g.Add=4]="Add"}(w||(w={})),function(g){g[g.TTB=0]="TTB",g[g.RTL=1]="RTL",g[g.BTT=2]="BTT"}(L||(L={})),function(g){g[g.None=0]="None",g[g.SignPost=1]="SignPost",g[g.FaceNearPlane=2]="FaceNearPlane"}(_||(_={})),function(g){g[g.Float=0]="Float",g[g.String=1]="String",g[g.Boolean=2]="Boolean"}(m||(m={})),function(g){g[g.Intersect=0]="Intersect",g[g.Subtract=1]="Subtract"}(x||(x={})),function(g){g.OpenEnded="OpenEnded",g.Block="Block",g.Crossed="Crossed"}(C||(C={})),function(g){g.FullGeometry="FullGeometry",g.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",g.ReversedFirstSegment="ReversedFirstSegment",g.PerpendicularToSecondSegment="PerpendicularToSecondSegment",g.SecondSegmentWithTicks="SecondSegmentWithTicks",g.DoublePerpendicular="DoublePerpendicular",g.OppositeToFirstSegment="OppositeToFirstSegment",g.TriplePerpendicular="TriplePerpendicular",g.HalfCircleFirstSegment="HalfCircleFirstSegment",g.HalfCircleSecondSegment="HalfCircleSecondSegment",g.HalfCircleExtended="HalfCircleExtended",g.OpenCircle="OpenCircle",g.CoverageEdgesWithTicks="CoverageEdgesWithTicks",g.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",g.GapExtentMidline="GapExtentMidline",g.Chevron="Chevron",g.PerpendicularWithArc="PerpendicularWithArc",g.ClosedHalfCircle="ClosedHalfCircle",g.TripleParallelExtended="TripleParallelExtended",g.ParallelWithTicks="ParallelWithTicks",g.Parallel="Parallel",g.PerpendicularToFirstSegment="PerpendicularToFirstSegment",g.ParallelOffset="ParallelOffset",g.OffsetOpposite="OffsetOpposite",g.OffsetSame="OffsetSame",g.CircleWithArc="CircleWithArc",g.DoubleJog="DoubleJog",g.PerpendicularOffset="PerpendicularOffset",g.LineExcludingLastSegment="LineExcludingLastSegment",g.MultivertexArrow="MultivertexArrow",g.CrossedArrow="CrossedArrow",g.ChevronArrow="ChevronArrow",g.ChevronArrowOffset="ChevronArrowOffset",g.PartialFirstSegment="PartialFirstSegment",g.Arch="Arch",g.CurvedParallelTicks="CurvedParallelTicks",g.Arc90Degrees="Arc90Degrees"}(A||(A={})),function(g){g.Mitered="Mitered",g.Bevelled="Bevelled",g.Rounded="Rounded",g.Square="Square",g.TrueBuffer="TrueBuffer"}(z||(z={})),function(g){g.ClosePath="ClosePath",g.ConvexHull="ConvexHull",g.RectangularBox="RectangularBox"}(R||(R={})),function(g){g.BeginningOfLine="BeginningOfLine",g.EndOfLine="EndOfLine"}(Q||(Q={})),function(g){g.Mitered="Mitered",g.Bevelled="Bevelled",g.Rounded="Rounded",g.Square="Square"}(H||(H={})),function(g){g.Fast="Fast",g.Accurate="Accurate"}(E||(E={})),function(g){g.BeginningOfLine="BeginningOfLine",g.EndOfLine="EndOfLine"}(k||(k={})),function(g){g.Sinus="Sinus",g.Square="Square",g.Triangle="Triangle",g.Random="Random"}(te||(te={})),function(g){g[g.None=0]="None",g[g.Default=1]="Default",g[g.Force=2]="Force"}(de||(de={})),function(g){g[g.Buffered=0]="Buffered",g[g.Left=1]="Left",g[g.Right=2]="Right",g[g.AlongLine=3]="AlongLine"}(oe||(oe={})),function(g){g[g.Linear=0]="Linear",g[g.Rectangular=1]="Rectangular",g[g.Circular=2]="Circular",g[g.Buffered=3]="Buffered"}(D||(D={})),function(g){g[g.Discrete=0]="Discrete",g[g.Continuous=1]="Continuous"}(P||(P={})),function(g){g[g.AcrossLine=0]="AcrossLine",g[g.AloneLine=1]="AloneLine"}(X||(X={})),function(g){g[g.Left=0]="Left",g[g.Right=1]="Right",g[g.Center=2]="Center",g[g.Justify=3]="Justify"}(le||(le={})),function(g){g[g.Base=0]="Base",g[g.MidPoint=1]="MidPoint",g[g.ThreePoint=2]="ThreePoint",g[g.FourPoint=3]="FourPoint",g[g.Underline=4]="Underline",g[g.CircularCW=5]="CircularCW",g[g.CircularCCW=6]="CircularCCW"}(xe||(xe={})),function(g){g.Butt="Butt",g.Round="Round",g.Square="Square"}(je||(je={})),function(g){g.NoConstraint="NoConstraint",g.HalfPattern="HalfPattern",g.HalfGap="HalfGap",g.FullPattern="FullPattern",g.FullGap="FullGap",g.Custom="Custom"}(Le||(Le={})),function(g){g[g.None=-1]="None",g[g.Custom=0]="Custom",g[g.Circle=1]="Circle",g[g.OpenArrow=2]="OpenArrow",g[g.ClosedArrow=3]="ClosedArrow",g[g.Diamond=4]="Diamond"}(Me||(Me={})),function(g){g[g.ExtraLeading=0]="ExtraLeading",g[g.Multiple=1]="Multiple",g[g.Exact=2]="Exact"}(We||(We={})),function(g){g.Bevel="Bevel",g.Round="Round",g.Miter="Miter"}(Oe||(Oe={})),function(g){g[g.Default=0]="Default",g[g.String=1]="String",g[g.Numeric=2]="Numeric"}(ke||(ke={})),function(g){g[g.InsidePolygon=0]="InsidePolygon",g[g.PolygonCenter=1]="PolygonCenter",g[g.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(Ve||(Ve={})),function(g){g[g.Tint=0]="Tint",g[g.Replace=1]="Replace",g[g.Multiply=2]="Multiply"}(Qe||(Qe={})),function(g){g[g.ClipAtBoundary=0]="ClipAtBoundary",g[g.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",g[g.DoNotTouchBoundary=2]="DoNotTouchBoundary",g[g.DoNotClip=3]="DoNotClip"}(Ze||(Ze={})),function(g){g.NoConstraint="NoConstraint",g.WithMarkers="WithMarkers",g.WithFullGap="WithFullGap",g.WithHalfGap="WithHalfGap",g.Custom="Custom"}(ze||(ze={})),function(g){g.Fixed="Fixed",g.Random="Random",g.RandomFixedQuantity="RandomFixedQuantity"}(Ne||(Ne={})),function(g){g.LineMiddle="LineMiddle",g.LineBeginning="LineBeginning",g.LineEnd="LineEnd",g.SegmentMidpoint="SegmentMidpoint"}(Ye||(Ye={})),function(g){g.OnPolygon="OnPolygon",g.CenterOfMass="CenterOfMass",g.BoundingBoxCenter="BoundingBoxCenter"}(Ge||(Ge={})),function(g){g[g.Low=0]="Low",g[g.Medium=1]="Medium",g[g.High=2]="High"}(it||(it={})),function(g){g[g.MarkerCenter=0]="MarkerCenter",g[g.MarkerBounds=1]="MarkerBounds"}(tt||(tt={})),function(g){g[g.None=0]="None",g[g.PropUniform=1]="PropUniform",g[g.PropNonuniform=2]="PropNonuniform",g[g.DifUniform=3]="DifUniform",g[g.DifNonuniform=4]="DifNonuniform"}(ct||(ct={})),function(g){g.Tube="Tube",g.Strip="Strip",g.Wall="Wall"}(st||(st={})),function(g){g[g.Random=0]="Random",g[g.Increasing=1]="Increasing",g[g.Decreasing=2]="Decreasing",g[g.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(rt||(rt={})),function(g){g[g.Relative=0]="Relative",g[g.Absolute=1]="Absolute"}(yt||(yt={})),function(g){g[g.Normal=0]="Normal",g[g.LowerCase=1]="LowerCase",g[g.Allcaps=2]="Allcaps"}(Ft||(Ft={})),function(g){g[g.LTR=0]="LTR",g[g.RTL=1]="RTL"}(gt||(gt={})),function(g){g.Draft="Draft",g.Picture="Picture",g.Text="Text"}(ft||(ft={})),function(g){g[g.Top=0]="Top",g[g.Center=1]="Center",g[g.Baseline=2]="Baseline",g[g.Bottom=3]="Bottom"}(nt||(nt={})),function(g){g[g.Right=0]="Right",g[g.Upright=1]="Upright"}(It||(It={})),function(g){g[g.Small=0]="Small",g[g.Medium=1]="Medium",g[g.Large=2]="Large"}(Mt||(Mt={})),function(g){g[g.Calm=0]="Calm",g[g.Rippled=1]="Rippled",g[g.Slight=2]="Slight",g[g.Moderate=3]="Moderate"}(vt||(vt={}))},99666:(Se,he,M)=>{M.d(he,{KS:()=>K,PX:()=>Z,QS:()=>Y,_I:()=>U,jL:()=>N,nE:()=>se,vs:()=>ue,xp:()=>q});const U=8388607,Z=0,q=1,ue=J=>(8388608&J)>>>23,N=J=>J&U,K=J=>ue(J)===q?254:255;function se(J){return ue(J)===q}function Y(J,b){return((b?8388608:0)|J)>>>0}},39351:(Se,he,M)=>{M.d(he,{$0:()=>Y,AI:()=>W,By:()=>P,C1:()=>g,CQ:()=>Tt,CU:()=>rt,Ex:()=>A,I_:()=>q,Ic:()=>k,Ij:()=>oe,Ip:()=>nt,Iv:()=>Te,Iw:()=>z,MI:()=>vt,SD:()=>Zt,Tz:()=>qe,Uh:()=>Ot,V4:()=>st,XJ:()=>ft,_6:()=>zt,a:()=>yt,aK:()=>Ve,e0:()=>Et,eV:()=>J,f2:()=>D,fL:()=>gt,iJ:()=>te,jk:()=>wt,kF:()=>Le,m4:()=>ze,mx:()=>X,nM:()=>de,oK:()=>Lt,pU:()=>ke,ru:()=>Z,tQ:()=>tt,uG:()=>Ne,xl:()=>Oe,xm:()=>b,yP:()=>Me});const W=1e-30,Z=4294967295,q=512,Y=8,J=10,b=29,A=24,z=8,k=0,te=1,de=2,oe=3,D=4,P=5,X=6,Le=5,Me=6,Oe=1,ke=2,Ve=3,ze=2,Ne=1,tt=1.05,st=5,rt=6,yt=1.15,gt=2,ft=8,nt=500,vt=10,g=1024,Ot=2,Tt=0,qe=1,Lt=4,Et=8,Te=16,zt=4,Zt=1,wt=4},5254:(Se,he,M)=>{M.d(he,{Au:()=>J,Jz:()=>w,UJ:()=>G});const U=new Float32Array(1);function J(m){return[255&m,(65280&m)>>>8,(16711680&m)>>>16,(4278190080&m)>>>24]}function G(m,x){return 65535&m|x<<16}function w(m,x,C,A){return 255&m|(255&x)<<8|(255&C)<<16|A<<24}new Uint32Array(U.buffer)},55746:(Se,he,M)=>{M.d(he,{k:()=>J,p:()=>b});var U=M(65389),ee=M(61885),F=(M(8314),M(62208)),Z=M(76279),q=M(5548),ue=M(16669),N=M(52397);function K(G,w){return G<<16|w}function se(G){return(4294901760&G)>>>16}function Y(G){return 65535&G}const J={getObjectId:G=>G.getObjectId(),getAttributes:G=>G.readAttributes(),getAttribute:(G,w)=>G.readAttribute(w),cloneWithGeometry:(G,w)=>G,getGeometry:G=>G.readHydratedGeometry(),getCentroid:(G,w)=>G.readCentroid()};class b extends ue.J{constructor(w,L,_){super(w,L),this.featureAdapter=J,this.events=new ee.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new U.Z(50),this._index=(0,Z.r)(9,m=>({minX:this._storage.getXMin(m),minY:this._storage.getYMin(m),maxX:this._storage.getXMax(m),maxY:this._storage.getYMax(m)})),this.mode=_}get storeStatistics(){let w=0,L=0,_=0;return this.forEach(m=>{const x=m.readGeometry();x&&(L+=x.isPoint?1:x.lengths.reduce((C,A)=>C+A,0),_+=x.isPoint?1:x.lengths.length,w+=1)}),{featureCount:w,vertexCount:L,ringCount:_}}hasInstance(w){return this._featureSetsByInstance.has(w)}onTileData(w,L){if((0,F.Wi)(L.addOrUpdate))return L;if(L.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const m=L.addOrUpdate.getCursor();for(;m.next();){const x=m.getDisplayId();this.setComputedAttributes(this._storage,m,x,w.scale)}return L}this._featureSetsByInstance.set(L.addOrUpdate.instance,L.addOrUpdate);const _=L.addOrUpdate.getCursor();for(;_.next();)this._insertFeature(_,w.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),L}search(w){this._rebuildIndex();const L=w.id,_=this._indexSearchCache.find(A=>A.tileId===L);if((0,F.pC)(_))return _.readers;const m=new Map,x=this._searchIndex(w.bounds),C=[];for(const A of x){const z=this._storage.getInstanceId(A),R=se(z),Q=Y(z);m.has(R)||m.set(R,[]),m.get(R).push(Q)}return m.forEach((A,z)=>{const R=this._featureSetsByInstance.get(z);C.push(N.t.from(R,A))}),this._indexSearchCache.enqueue({tileId:L,readers:C}),C}insert(w){var m;const L=w.getCursor(),_=this._storage;for(;L.next();){const x=K(L.instance,L.getIndex()),C=L.getObjectId(),A=null!=(m=this._objectIdToDisplayId.get(C))?m:this._storage.createDisplayId();L.setDisplayId(A),_.setInstanceId(A,x),this._objectIdToDisplayId.set(C,A)}this._featureSetsByInstance.set(w.instance,w),this._spatialIndexInvalid=!0}remove(w){const L=this._objectIdToDisplayId.get(w);if(!L)return;const _=this._storage.getInstanceId(L),m=Y(_),x=se(_),C=this._featureSetsByInstance.get(x);this._objectIdToDisplayId.delete(w),this._storage.releaseDisplayId(L),C.removeAtIndex(m),C.isEmpty&&this._featureSetsByInstance.delete(x),this._spatialIndexInvalid=!0}toArray(){const w=new Array;return this.forEach(L=>w.push(L)),w}forEach(w){this._objectIdToDisplayId.forEach(L=>{const _=this._storage.getInstanceId(L),m=this._lookupFeature(_);w(m)})}forEachUnsafe(w){this._objectIdToDisplayId.forEach(L=>{const _=this._storage.getInstanceId(L),m=se(_),x=Y(_),C=this._getFeatureSet(m);C.setIndex(x),w(C)})}forEachInBounds(w,L){const _=this._searchIndex(w);for(const m of _){const x=this.lookupFeatureByDisplayId(m,this._storage);L((0,F.Wg)(x))}}forEachBounds(w,L,_){this._rebuildIndex();const m=[0,0,0,0];for(const x of w){if(!x.readGeometry())continue;const C=x.getDisplayId();m[0]=this._storage.getXMin(C),m[1]=this._storage.getYMin(C),m[2]=this._storage.getXMax(C),m[3]=this._storage.getYMax(C),L((0,q.JR)(_,m))}}sweepFeatures(w,L,_){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((m,x)=>{w.has(m)||(L.releaseDisplayId(m),_&&_.unsetAttributeData(m),this._objectIdToDisplayId.delete(x))}),this.events.emit("changed")}sweepFeatureSets(w){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((L,_)=>{w.has(_)||this._featureSetsByInstance.delete(_)})}lookupObjectId(w,L){const _=this.lookupFeatureByDisplayId(w,L);return(0,F.Wi)(_)?null:_.getObjectId()}lookupDisplayId(w){return this._objectIdToDisplayId.get(w)}lookupFeatureByDisplayId(w,L){const _=L.getInstanceId(w);return this._lookupFeature(_)}lookupByDisplayIdUnsafe(w){const L=this._storage.getInstanceId(w),_=se(L),m=Y(L),x=this._getFeatureSet(_);return x?(x.setIndex(m),x):null}_insertFeature(w,L){const _=this._storage,m=w.getObjectId(),x=K(w.instance,w.getIndex());_.getInstanceId(w.getDisplayId());let C=this._objectIdToDisplayId.get(m);C||(C=_.createDisplayId(),this._objectIdToDisplayId.set(m,C),this._spatialIndexInvalid=!0),w.setDisplayId(C),_.setInstanceId(C,x),this.setComputedAttributes(_,w,C,L)}_searchIndex(w){return this._rebuildIndex(),this._index.search({minX:w[0],minY:w[1],maxX:w[2],maxY:w[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const w=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(L=>{const _=L.getCursor();for(;_.next();){const m=_.getDisplayId();this._storage.setBounds(m,_)&&w.push(m)}}):this._objectIdToDisplayId.forEach(L=>{const _=this._storage.getInstanceId(L);this._storage.setBounds(L,this._lookupFeature(_))&&w.push(L)}),this._index.clear(),this._index.load(w),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(w){const L=se(w),_=this._getFeatureSet(L);if(!_)return null;const m=_.getCursor(),x=Y(w);return m.setIndex(x),m}_getFeatureSet(w){return this._featureSetsByInstance.get(w)}}},11288:(Se,he,M)=>{M.r(he),M.d(he,{default:()=>Rr});var U=M(15861),ee=M(17626),W=M(80542),F=M(8314),Z=M(32917),q=M(77712),K=(M(85931),M(90912),M(76898)),se=M(37053),Y=M(2584),b=M(62208),G=M(10699),w=M(82054),L=M(58175),_=M(60466),m=M(55746),x=M(38305),C=M(84792),A=M(26584),z=M(63290),R=M(93662),Q=M(7848),H=M(89628),E=M(20477),k=M(66385),te=M(25208);class oe extends te.s{constructor(a,u,h){super(a,h),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=null==h?void 0:h.geometryType,this._features=u}static fromFeatures(a,u){const{objectIdField:h,geometryType:d}=u,f=(0,w.Yn)([],a,d,!1,!1,h);for(let p=0;p<f.length;p++)f[p].displayId=a[p].displayId;return oe.fromOptimizedFeatures(f,u)}static fromFeatureSet(a,u){const h=(0,w.h_)(a,u.objectIdField);return oe.fromOptimizedFeatureSet(h,u)}static fromOptimizedFeatureSet(a,u){const{features:h}=a,d=oe.fromOptimizedFeatures(h,u);d._exceededTransferLimit=a.exceededTransferLimit,d._transform=a.transform;for(const f of a.fields)"esriFieldTypeDate"===f.type&&d._dateFields.add(f.name);return d}static fromOptimizedFeatures(a,u,h){const d=te.s.createInstance(),f=new oe(d,a,u);return f._transform=h,f}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const u=new Set(a);this._features=this._features.filter(h=>!u.has(h.objectId))}append(a){for(const u of a)this._features.push(u)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const u in this._current.attributes)a+=this._current.attributes[u];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new oe(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,w.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,w.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,b.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,k.S6)(this._current)?(0,w.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const u=a.clone();return function de({coords:c,lengths:a}){let u=0;for(const h of a){for(let d=1;d<h;d++)c[2*(u+d)]+=c[2*(u+d)-2],c[2*(u+d)+1]+=c[2*(u+d)-1];u+=h}}(u),u}readHydratedGeometry(){const a=this._current.geometry;if((0,b.Wi)(a))return null;const u=a.clone();return(0,b.pC)(this._transform)&&(0,w.$g)(u,u,this.hasZ,this.hasM,this._transform),u}getXHydrated(){if(!(0,k.S6)(this._current))return 0;const a=this._current.geometry.coords[0],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:a*u.scale[0]+u.translate[0]}getYHydrated(){if(!(0,k.S6)(this._current))return 0;const a=this._current.geometry.coords[1],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:u.translate[1]-a*u.scale[1]}getX(){return(0,k.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,k.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,k.S6)(this._current))return null;const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let u=0;for(const h of a.lengths)a.coords[2*u]=a.coords[2*u]*this._sx+this._tx,a.coords[2*u+1]=a.coords[2*u+1]*this._sy+this._ty,u+=h;return a}readCentroid(){if(!(0,k.S6)(this._current))return null;if((0,b.Wi)(this._current.centroid)){const u=this._computeCentroid();if((0,b.Wi)(u))return null;u.coords[0]=(u.coords[0]-this._tx)/this._sx,u.coords[1]=(u.coords[1]-this._ty)/this._sy,this._current.centroid=u}const a=this._current.centroid.clone();return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sx+this._ty,a}hasField(a){return a in this._current.attributes||this.getFieldNames().map(u=>u.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,u){const h=this._current.attributes[a];if(void 0!==h)return null!=h&&u&&this._dateFields.has(a)?new Date(h):h;const d=this.readAttributes(),f=a.toLocaleLowerCase().trim();for(const p in d)if(p.toLocaleLowerCase().trim()===f){const y=this._current.attributes[p];return null!=y&&u&&this._dateFields.has(p)?new Date(y):y}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var D=M(24192),P=M(88071),X=M(71260);const le=268435455;class xe{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){var u;return null==(u=this.fieldMap.get(a))?void 0:u.isDate}getFieldIndex(a){var u;return null==(u=this.fieldMap.get(a))?void 0:u.index}}function je(c){const h=c.getLength(),d=c.pos()+h,f={name:"",isDate:!1};for(;c.pos()<d&&c.next();)switch(c.tag()){case 1:f.name=c.getString();break;case 2:"esriFieldTypeDate"===(0,X.O7)(c.getEnum())&&(f.isDate=!0);break;default:c.skip()}return f}function Le(c){return c.toLowerCase().trim()}const We=z.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),ke=268435455,Ze={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function ze(c){return c<=Ze.small.delta.length?Ze.small:(c<=Ze.large.delta.length||(Ze.large.delta=new Int32Array(Math.round(1.25*c)),Ze.large.decoded=new Int32Array(Math.round(1.25*c))),Ze.large)}function Ne(c){return c.toLowerCase().trim()}function Ge(c){for(;c.next();){if(1===c.tag())return c.getMessage();c.skip()}return null}function tt(c,a,u,h,d,f){return.5*Math.abs(c*h+u*f+d*a-c*f-u*a-d*h)}function ct(c,a,u,h){return c*h-u*a==0&&c*u+a*h>0}class st extends te.s{constructor(a,u,h,d){super(a,d),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=d.geometryType,this._reader=u,this._header=h,this._hasNext=h.hasFeatures,this._isPoints="esriGeometryPoint"===d.geometryType}static fromBuffer(a,u,h=!1){const d=u.geometryType,f=function Ye(c){try{const u=new D.Z(new Uint8Array(c),new DataView(c));for(;u.next();){if(2===u.tag())return Ge(u.getMessage());u.skip()}}catch(a){const u=new A.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});We.error(u)}return null}(a),p=function Me(c,a,u=!1){const v=c.pos(),S=new xe;let T=0,O=0,$=null,ae=null,ie=null,ce=!1;for(;c.next();)switch(c.tag()){case 1:$=c.getString();break;case 3:ae=c.getString();break;case 12:ie=c.processMessage(X.G$);break;case 9:if(S.exceededTransferLimit=c.getBool(),S.exceededTransferLimit){S.offsets.geometry=u?new Float64Array(8e3):new Int32Array(8e3),S.centroid=u?new Float64Array(16e3):new Int32Array(16e3);for(let re=0;re<S.centroid.length;re++)S.centroid[re]=le}break;case 13:{const re=je(c),_e=re.name,be=Le(re.name),fe={fieldName:_e,index:T++,isDate:re.isDate};S.fields.push(fe),S.fieldMap.set(re.name,fe),S.fieldMap.set(be,fe);break}case 15:{const re=c.getLength(),_e=c.pos()+re;if(!S.exceededTransferLimit){const ye=S.centroid;S.offsets.geometry.push(0),ye.push(le),ye.push(le)}!ce&&S.exceededTransferLimit&&(ce=!0,S.offsets.attributes=u?new Float64Array(8e3*T):new Uint32Array(8e3*T));let be=O*T;for(;c.pos()<_e&&c.next();)switch(c.tag()){case 1:{ce?S.offsets.attributes[be++]=c.pos():S.offsets.attributes.push(c.pos());const fe=c.getLength();c.skipLen(fe);break}case 2:if(a){const fe=c.getLength(),ye=c.pos()+fe;for(;c.pos()<ye&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const me=c.getSInt64(),Pe=c.getSInt64();S.centroid[2*O]=me,S.centroid[2*O+1]=Pe;break}default:c.skip()}}else{S.offsets.geometry[O]=c.pos();const fe=c.getLength();S.vertexCount+=fe,c.skipLen(fe)}break;case 4:{const fe=c.getLength(),ye=c.pos()+fe;for(;c.pos()<ye&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const me=c.getSInt64(),Pe=c.getSInt64();S.centroid[2*O]=me,S.centroid[2*O+1]=Pe;break}default:c.skip()}break}default:c.skip()}O++,S.hasFeatures=!0;break}default:c.skip()}const ge=$||ae;if(!ge)throw new A.Z("FeatureSet has no objectId or globalId field name");return S.featureCount=O,S.fieldCount=T,S.objectIdFieldIndex=S.getFieldIndex(ge),S.transform=ie,S.displayIds=new Uint32Array(S.featureCount),S.groupIds=new Uint16Array(S.featureCount),c.move(v),S}(f,"esriGeometryPoint"===d,h),y=te.s.createInstance();return new st(y,f,p,u)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(Ne(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:u})=>{a+=this._readAttributeAtIndex(u)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){var a;if(void 0===this._cache.legacyFeature){const u=this.readCentroid(),h={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(a=u&&{x:u.coords[0],y:u.coords[1]})?a:null};return this._cache.legacyFeature=h,h}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new k.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:a*u.scale[0]+u.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],u=this.getQuantizationTransform();return(0,b.Wi)(u)?a:u.translate[1]-a*u.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const u=this.readGeometry(a);return(0,w.di)(u,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[u,h]=a.coords;return{x:u,y:h}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const u=this.readGeometry(a);if(!u)return this._cache.unquantGeometry=null,null;const h=ze(u.coords.length).decoded,d=u.clone(h),f=d.coords;let p=0;for(const y of d.lengths){for(let I=1;I<y;I++){const v=2*(p+I),S=2*(p+I-1);f[v]+=f[S],f[v+1]+=f[S+1]}p+=y}return this._cache.unquantGeometry=d,d}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===ke)return null;const d=this.getXHydrated(),f=this.getYHydrated();return new P.Z([],[d,f])}const a=this.readGeometry();if(!a)return null;const u=a.clone(),h=this.getQuantizationTransform();return(0,b.pC)(h)&&(0,w.$g)(u,u,this.hasZ,this.hasM,h),u}readGeometry(a=!1){if(void 0===this._cache.geometry){let u=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===ke)return null;const h=this.getX(),d=this.getY();u=new P.Z([],[h,d])}else{const h=this._header.offsets.geometry[this._featureIndex],d=this._reader;if(0===h)return null;d.move(h);try{u=a?this._parseGeometryForDisplay(d):this._parseGeometry(d)}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=u,u}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a=null;const u=this._header.centroid[2*this._featureIndex]+this._tx,h=this._header.centroid[2*this._featureIndex+1]+this._ty;return u===ke?(a=this._computeCentroid(),a&&(this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=a.coords[1]-this._ty)):a=new P.Z([],[u,h]),this._cache.centroid=a,a}return this._cache.centroid}copy(){const a=this._reader.clone(),u=new st(this.instance,a,this._header,this.fullSchema());return this.copyInto(u),u}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(a,u){const h=this._header.hasField(a)?a:Ne(a),d=this._header.getFieldIndex(h);if(null==d)return;const f=this._readAttributeAtIndex(d);return u&&null!=f&&this._header.isDateField(h)?new Date(f):f}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:u,index:h})=>{a[u]=this._readAttributeAtIndex(h)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const h=this._reader;return h.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function it(c){const S=c.getLength(),T=c.pos()+S;for(;c.pos()<T&&c.next();)switch(c.tag()){case 1:return c.getString();case 2:return c.getFloat();case 3:return c.getDouble();case 4:return c.getSInt32();case 5:return c.getUInt32();case 6:return c.getInt64();case 7:return c.getUInt64();case 8:return c.getSInt64();case 9:return c.getBool();default:return c.skip(),null}return null}(h)}_parseGeometry(a){const d=a.getLength(),f=a.pos()+d,p=[],y=[];for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:{const I=a.getUInt32(),v=a.pos()+I;for(;a.pos()<v;)y.push(a.getUInt32());break}case 3:{const I=a.getUInt32(),v=a.pos()+I;for(p.push(a.getSInt32()+this._tx),p.push(a.getSInt32()+this._ty),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();a.pos()<v;)p.push(a.getSInt32()),p.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break}default:a.skip()}return new P.Z(y,p)}_parseGeometryForDisplay(a){const d=a.getLength(),f=a.pos()+d,p=[],y=[];let I=0,v=0,S=null,T=0;const O="esriGeometryPolygon"===this.geometryType;for(;a.pos()<f&&a.next();)switch(a.tag()){case 2:{const B=a.getUInt32(),j=a.pos()+B;for(;a.pos()<j;){const V=a.getUInt32();p.push(V),I+=V}S=ze(2*I).delta;break}case 3:{a.getUInt32();const B=2+(this.hasZ?1:0)+(this.hasM?1:0);for(const j of p)if(v+B*j>S.length)for(let V=0;V<j;V++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(O){const V=this.getAreaSimplificationThreshold(j,this._header.vertexCount);let ne=2,$=1;const ae=!1;let ie=a.getSInt32(),ce=a.getSInt32();S[v++]=ie,S[v++]=ce,this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();let ge=a.getSInt32(),re=a.getSInt32();for(this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();ne<j;){let _e=a.getSInt32(),be=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();const fe=ie+ge,ye=ce+re;tt(ie,ce,fe,ye,fe+_e,ye+be)>=V?(T+=-.5*(fe-ie)*(ye+ce),$>1&&ct(S[v-2],S[v-1],ge,re)?(S[v-2]+=ge,S[v-1]+=re):(S[v++]=ge,S[v++]=re,$++),ie=fe,ce=ye):(_e+=ge,be+=re),ge=_e,re=be,ne++}$<3||ae?v-=2*$:(T+=-.5*(ie+ge-ie)*(ce+re+ce),ct(S[v-2],S[v-1],ge,re)?(S[v-2]+=ge,S[v-1]+=re,y.push($)):(S[v++]=ge,S[v++]=re,y.push(++$)))}else{let V=0,ne=a.getSInt32(),$=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),S[v++]=ne,S[v++]=$,V+=1;for(let ae=1;ae<j;ae++){const ie=a.getSInt32(),ce=a.getSInt32(),ge=ne+ie,re=$+ce;T+=-.5*(ge-ne)*(re+$),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),ae>2&&ct(S[v-2],S[v-1],ie,ce)?(S[v-2]+=ie,S[v-1]+=ce):(S[v++]=ie,S[v++]=ce,V+=1),ne=ge,$=re}y.push(V)}break}default:a.skip()}if(this._cache.area=T,!y.length)return null;if(this._tx||this._ty){let B=0;for(const j of y)S[2*B]+=this._tx,S[2*B+1]+=this._ty,B+=j}return new P.Z(y,S)}}class rt{constructor(a){this.service=a}destroy(){}}function nt(){return(nt=(0,U.Z)(function*(c){const a=new R.Z;return yield a.open(c,{}),a})).apply(this,arguments)}class It extends rt{constructor(a){super(a),this._portsOpen=function ft(c){return nt.apply(this,arguments)}(a.source).then(u=>this.client=u)}destroy(){this.client.close(),this.client=null}executeQuery(a,u){var h=this;return(0,U.Z)(function*(){yield h._portsOpen;const d=yield h.client.invoke("queryFeatures",a.toJSON(),u);return oe.fromFeatureSet(d,h.service)})()}}class Mt extends rt{executeQuery(a,u){var h=this;return(0,U.Z)(function*(){const{data:d}=yield(0,E.executeQueryPBFBuffer)(h.service.source,a,u);return st.fromBuffer(d,h.service,!a.quantizationParameters)})()}}class vt extends rt{executeQuery(a,u){var h=this;return(0,U.Z)(function*(){var S;const{source:d,capabilities:f,spatialReference:p,objectIdField:y,geometryType:I}=h.service;if((0,b.pC)(a.quantizationParameters)&&!f.query.supportsQuantization){const T=a.clone(),O=(0,Q.vY)((0,b.Wg)(T.quantizationParameters));T.quantizationParameters=null;const{data:B}=yield(0,E.executeQuery)(d,T,p,u),j=(0,w.h_)(B,y);return(0,w.RZ)(O,j),oe.fromOptimizedFeatureSet(j,h.service)}const{data:v}=yield(0,E.executeQuery)(d,a,h.service.spatialReference,u);return"esriGeometryPoint"===I&&(v.features=null==(S=v.features)?void 0:S.filter(T=>{if((0,b.pC)(T.geometry)){const O=T.geometry;return Number.isFinite(O.x)&&Number.isFinite(O.y)}return!0})),oe.fromFeatureSet(v,h.service)})()}}class g extends rt{executeQuery(a,u){var h=this;return(0,U.Z)(function*(){const{capabilities:d}=h.service;if(a.quantizationParameters&&!d.query.supportsQuantization){const p=a.clone(),y=(0,Q.vY)((0,b.Wg)(p.quantizationParameters));p.quantizationParameters=null;const I=yield(0,H.WW)(h.service.source,a,u);return(0,w.RZ)(y,I),oe.fromOptimizedFeatureSet(I,h.service)}const f=yield(0,H.WW)(h.service.source,a,u);return oe.fromOptimizedFeatureSet(f,h.service)})()}}var Ot=M(97478),Tt=M(61885),qe=M(84682),Lt=M(84952),Et=M(65389);class Te{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const u=new Te;for(const h in a){const d=a[h];if("object"==typeof d)for(const f in d)u[h][f]=d[f];u[h]=d}return u}static empty(){return Te.create({})}static all(){return Te.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,u="";if(this.mesh){a+=20,u+="-> (20) Mesh needs update\n";for(const d of this.why.mesh)u+=`    + ${d}\n`}if(this.source){a+=10,u+="-> (10) The source needs update\n";for(const d of this.why.source)u+=`    + ${d}\n`}this.targets.feature&&(a+=5,u+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,u+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,u+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,u+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(u)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class zt{constructor(a,u){this.requests={done:new Array,stream:new Et.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=u}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(u=>u.message.status.unset(a)),this._version=a.version,(0,b.pC)(this._edits)&&this._edits.status.unset(a)}add(a){var u;a.message.status=null!=(u=a.message.status)?u:Te.empty(),a.message.status.version=this._version,(0,F.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(h=>{(0,b.pC)(h.message)&&h.message.end&&(h.message.end=!1)}),this.requests.done.push(a)}edit(a,u){const h=a.getQuantizationTransform(),d=a.fullSchema(),f=Array.from(a.features()),p=[...u,...f.map(y=>y.objectId)];this.removeIds(p),this._invalidate(),(0,b.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:oe.fromOptimizedFeatures(f,d,(0,b.Wg)(h)),id:this.tile.id,status:Te.empty(),end:!0}:(this.requests.done.forEach(y=>y.message.end=!1),(0,b.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,b.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,b.pC)(this._edits)&&(0,b.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=Te.empty();(0,b.pC)(this._edits)&&(this._edits.status=Te.empty())}removeIds(a){this._invalidate();for(const{message:u}of this.requests.done){const h=u.addOrUpdate;(0,b.pC)(h)&&(h.removeIds(a),h.isEmpty&&(u.addOrUpdate=null))}(0,b.pC)(this._edits)&&(0,b.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(u=>u.message.addOrUpdate||u.message.end)}abort(){this._abortController.abort()}}class wt{constructor(a){this.events=new Tt.Z,this._resolver=(0,G.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}destroy(){}_onMessage(a){var u=this;return(0,U.Z)(function*(){var f,p;const h=u._subscriptions.get(a.id);if(!h)return;const d=Re(Ie({},a),{remove:null!=(f=a.remove)?f:[],status:null!=(p=a.status)?p:Te.empty()});return(0,G.R8)(u._onTileUpdateMessage(d,h.options))})()}update(a,u){var I;const h=u.fields.length;u.outFields=function Zt(c,a){const u=new Set;return c&&c.forEach(h=>u.add(h)),a&&a.forEach(h=>u.add(h)),u.has("*")?["*"]:Array.from(u)}(null==(I=this._schema)?void 0:I.outFields,u.outFields),u.outFields=u.outFields.length>=.75*h?["*"]:u.outFields,u.outFields.sort();const d=(0,qe.Hg)(this._schema,u);if(!d)return;(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",d);const f="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",p={returnCentroid:(0,F.Z)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:u.outFields,outSpatialReference:this._outSR,orderByFields:[f],where:u.definitionExpression||"1=1",gdbVersion:u.gdbVersion,historicMoment:u.historicMoment,timeExtent:Ot.Z.fromJSON(u.timeExtent)},y=this._schema&&(0,qe.uD)(d,"outFields");this._schema&&(0,qe.V7)(d,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),y&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,qe.Hg)(p,this._queryInfo)&&(this._queryInfo=p),this._schema=u,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var u=this;return(0,U.Z)(function*(){if(a.queryFilter||a.source&&u._didEdit)return u.refresh(a.version),void(u._didEdit=!1);u._subscriptions.forEach(h=>h.applyUpdate(a)),yield u.resend()})()}refresh(a){for(const u of this._tiles())this.unsubscribe(u),this.subscribe(u,a)}subscribe(a,u){const h=new zt(a,u);this._subscriptions.set(a.id,h)}unsubscribe(a){const u=this.get(a.id);(0,b.pC)(u)&&u.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const u=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new Lt.Z(Ie(Re(Ie({},this._queryInfo),{historicMoment:u}),a))}get(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,U.Z)(function*(){throw new Error("Service does not support query type")})()}query(a){return(0,U.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const u of a)yield u.tile}edit(a,u){var h=this;return(0,U.Z)(function*(){const d=Array.from(h._subscriptions.values()),f=d.map(({tile:p})=>p);for(const p of d)p.removeIds(u);if(a.length){const p=f.map(I=>{const v=h.createTileQuery(I);return v.objectIds=a,{tile:I,query:v}}).map(function(){var I=(0,U.Z)(function*({tile:v,query:S}){return{tile:v,result:yield h.query(S),query:S}});return function(v){return I.apply(this,arguments)}}()),y=(yield(0,G.WW)(p)).map(function(){var I=(0,U.Z)(function*({tile:v,result:S}){if(!S.hasFeatures&&!u.length&&!a.length)return;const T=h._subscriptions.get(v.key.id);T&&T.edit(S,a)});return function(v){return I.apply(this,arguments)}}());yield(0,G.as)(y)}h._didEdit=!0})()}}var Nt=M(71251);const Ms=z.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class Gt extends wt{constructor(a){var u,h;super(a),u=this,this.type="feature",this.mode="on-demand",this._adapter=function gt(c){const{capabilities:a}=c;return function Ft(c){return c&&c.capabilities&&c.collection&&c.layerDefinition}(c.source)?new g(c):function yt(c){return Array.isArray(c.source)}(c)?new It(c):a.query.supportsFormatPBF&&(0,F.Z)("featurelayer-pbf")?new Mt(c):new vt(c)}(a.serviceInfo),this._queue=new Nt.e({concurrency:8,process:(h=(0,U.Z)(function*(d){if((0,G.k_)(d),(0,b.pC)(d.tile)){const f=d.tile.key.id,{signal:p}=d,y=(0,F.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:d.depth}:void 0,I=yield u._adapter.executeQuery(d.query,{signal:p,query:Ie(Ie({},y),u._schema.customParameters)});return I.level=d.tile.key.level,I}return u._adapter.executeQuery(d.query,Re(Ie({},d),{query:u._schema.customParameters}))}),function(f){return h.apply(this,arguments)})}),this._patchQueue=new Nt.e({concurrency:8,process:function(){var h=(0,U.Z)(function*(d){if((0,G.k_)(d),(0,b.pC)(d.tile)){const f=d.tile.key.id,{signal:p}=d,y=(0,F.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:d.depth}:void 0,I=yield u._adapter.executeQuery(d.query,{signal:p,query:Ie(Ie({},y),u._schema.customParameters)});return I.level=d.tile.key.level,I}return u._adapter.executeQuery(d.query,Re(Ie({},d),{query:u._schema.customParameters}))});return function(f){return h.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){var u;const{query:a}=this._serviceInfo.capabilities;return(null!=(u=a.maxRecordCount)?u:8e3)*(0,b.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,u){}subscribe(a,u){super.subscribe(a,u);const h=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(d=>{(0,G.D_)(d)||Ms.error(new A.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:d}))}).then(()=>h.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a){var u=this;return(0,U.Z)(function*(){return u._adapter.executeQuery(a,{query:u._schema.customParameters})})()}queryLastEditDate(){var a=this;return(0,U.Z)(function*(){const u=a._serviceInfo.source,h=Re(Ie({},u.query),{f:"json"});return(yield(0,C.default)(u.path,{query:h,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,u={}){var p;const h=this._serviceInfo.geometryType,d=this.createQuery(u);d.quantizationParameters=null!=(p=u.quantizationParameters)?p:a.getQuantizationParameters(),d.resultType="tile",d.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===h&&(d.maxAllowableOffset=a.resolution*(0,F.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==h&&"esriGeometryPolygon"!==h||(d.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===h&&(d.maxAllowableOffset*=(0,F.Z)("feature-polyline-generalization-factor")));const f=this._serviceInfo.capabilities.query;return d.defaultSpatialReferenceEnabled=f.supportsDefaultSpatialReference,d.compactGeometryEnabled=f.supportsCompactGeometry,d}_executePatchQuery(a,u,h,d){var f=this;return(0,U.Z)(function*(){const p=u.clone();p.outFields=[f._serviceInfo.objectIdField,...h],p.returnCentroid=!1,p.returnGeometry=!1;const y=(0,b.pC)(p.start)?p.start/8e3:0;return f._patchQueue.push({tile:a,query:p,signal:d.signal,depth:y})})()}_resend(a,u){var h=this;return(0,U.Z)(function*(){const{query:d,message:f}=a,p=(0,b.pC)(d.outFields)?d.outFields:[],y=h._queryInfo.outFields,I=y.filter(v=>!p.includes(v));if((0,b.Wi)(f.addOrUpdate))h._onMessage(Re(Ie({},f),{type:"append"}));else if(I.length)try{const v=h._subscriptions.get(f.id).tile,S=yield h._executePatchQuery(v,d,I,u);(0,G.k_)(u),d.outFields=y,f.addOrUpdate.joinAttributes(S),h._onMessage(Re(Ie({},f),{end:f.end,type:"append"}))}catch(v){}else h._onMessage(Re(Ie({},f),{type:"append"}))})()}_resendSubscription(a){var u=this;return(0,U.Z)(function*(){if((0,F.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return u._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const h=a.signal;for(const d of a.requests.done)yield u._resend(d,{signal:h});return(0,b.pC)(a.edits)?u._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,U.Z)(function*(){const u=Array.from(a._subscriptions.values());yield Promise.all(u.map(h=>a._resendSubscription(h)))})()}}const Jt=(0,F.Z)("esri-mobile"),$t={maxDrillLevel:Jt?1:4,maxRecordCountFactor:Jt?1:3};class As extends Gt{constructor(a){super(a)}_fetchDataTile(a){var u=this;return(0,U.Z)(function*(){const h=u._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,d=u._subscriptions.get(a.key.id),f=d.signal,p=a.getQuantizationParameters();let y=0;const I=function(){var v=(0,U.Z)(function*(S,T){const O=u._queryInfo,B=u.createTileQuery(S,{maxRecordCountFactor:h?$t.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:p});y++;try{const j=yield u._queue.push({tile:a,query:B,signal:f,depth:T});if(y--,(0,G.k_)(f),!j)return;if(O!==u._queryInfo)return void I(S,T);if(j.exceededTransferLimit&&T<$t.maxDrillLevel){for(const ne of S.createChildTiles())I(ne,T+1);return}const V={id:a.id,addOrUpdate:j,end:0===y,type:"append"};d.add({query:B,message:V}),u._onMessage(V)}catch(j){(0,G.D_)(j)||u._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(T,O){return v.apply(this,arguments)}}();I(a,0)})()}}var es=M(76279),Es=M(5075),ws=M(16147);function Ds(c,a){const u=c.weakClone();if((0,b.pC)(c.geometry)){const h=(0,w.Jd)(a,c.geometry.coords[0]),d=(0,w.IN)(a,c.geometry.coords[1]);u.geometry=new P.Z([],[h,d])}return u}class Ls{constructor(a,u){this.onUpdate=a,this._geometryType=u,this._objectIdToFeature=new Map}get _features(){const a=[];return this._objectIdToFeature.forEach(u=>a.push(u)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function Us(c,a){const u=(0,es.r)(9,function Ps(c){return"esriGeometryPoint"===c?a=>(0,b.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let u=1/0,h=1/0,d=-1/0,f=-1/0;return(0,b.pC)(a.geometry)&&a.geometry.forEachVertex((p,y)=>{u=Math.min(u,p),h=Math.min(h,y),d=Math.max(d,p),f=Math.max(f,y)}),{minX:u,minY:h,maxX:d,maxY:f}}}(a));return u.load(c),u}(this._features,this._geometryType)),function Os(c,a){return c.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}removeById(a){const u=this._objectIdToFeature.get(a);return u?(this._objectIdToFeature.delete(a),this._index=null,u):null}update(a,u){this.onUpdate(a,u)}get size(){return this._objectIdToFeature.size}}class zs extends wt{constructor(a){super(a),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:u}=a,{geometryType:h,objectIdField:d,timeInfo:f,purgeOptions:p,source:y,spatialReference:I,serviceFilter:v,maxReconnectionAttempts:S,maxReconnectionInterval:T,updateInterval:O,enableDataReceived:B,customParameters:j}=a.serviceInfo,V=new Ls(this._onUpdate.bind(this),h),ne=new Es.Qo(V,d,f,p),$=(0,ws.I)(y,I,u,h,v,S,T,j);this._store=V,this._manager=ne,this._connection=$,this._quantize=function Bs(c){return"esriGeometryPoint"===c?Ds:(a,u)=>{const h=a.weakClone(),d=new P.Z,y=(0,w.Nh)(d,a.geometry,!1,!1,c,u,!1,!1);return h.geometry=y,h}}(h),this._dataReceiveEventEnabled=B,this._handles=[this._connection.on("feature",ae=>this._onFeature(ae)),(0,Z.YP)(()=>$.connectionStatus,ae=>this.events.emit("connectionStatus",ae)),(0,Z.YP)(()=>$.errorString,ae=>this.events.emit("errorString",ae))],this._initUpdateInterval=()=>{let ae=performance.now();this._updateIntervalId=setInterval(()=>{const ie=performance.now(),ce=ie-ae;if(ce>2500){ae=ie;const ge=Math.round(this._updateInfo.client/(ce/1e3)),re=Math.round(this._updateInfo.websocket/(ce/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:ge,websocket:re})}a.canAcceptRequest()&&this._manager.checkForUpdates()},O)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(a=>a.remove()),this._connection.destroy()}_fetchDataTile(){}pauseStream(){this._clearUpdateInterval()}resumeStream(){this._initUpdateInterval()}enableEvent(a,u){"data-received"===a&&(this._dataReceiveEventEnabled=u)}get updating(){return!1}subscribe(a,u){super.subscribe(a,u);const h=this._subscriptions.get(a.id);this._level=a.level;const d=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:d,end:!0}),h.didSend=!0}unsubscribe(a){super.unsubscribe(a)}*readers(a){const u=this._subscriptions.get(a),{tile:h}=u;yield this._getTileFeatures(h);for(const d of u.requests.stream.entries)(0,b.pC)(d)&&(0,b.pC)(d.addOrUpdate)&&(yield d.addOrUpdate)}createTileQuery(a){throw new Error("Service does not support tile  queries")}resend(){var a=this;return(0,U.Z)(function*(){a._subscriptions.forEach(u=>{const{tile:h}=u,d={type:"append",id:h.id,addOrUpdate:a._getTileFeatures(h),end:!0};a._onMessage(d)})})()}_getTileFeatures(a){const u=this._store.search(a).map(h=>this._quantize(h,a.transform));return oe.fromOptimizedFeatures(u,this._serviceInfo,a.transform)}_onFeature(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const u=(0,w.XA)(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(u)}catch(u){}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(a,u){(0,b.pC)(a)&&(this._updateInfo.client+=a.length),this._subscriptions.forEach((h,d)=>{h.didSend&&h.tile.level===this._level&&this._onMessage({type:"append",id:d,addOrUpdate:null,clear:!0,end:!1})}),this._subscriptions.forEach((h,d)=>{if(!h.didSend||h.tile.level!==this._level)return;const p={type:"append",id:d,addOrUpdate:this._getTileFeatures(h.tile),remove:[],end:!0,status:Te.empty()};h.requests.stream.enqueue(p),this._onMessage(p)})}}const Zs=z.Z.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class Ns extends Gt{constructor(a){super(a)}_fetchDataTile(a){var u=this;return(0,U.Z)(function*(){const f=u._subscriptions.get(a.key.id);let p=!1,y=0,I=0;const v=(O,B)=>{I--,(0,G.k_)(f);const j=a.id,V=O.reader,ne=O.query;if(!V.exceededTransferLimit){if(p=!0,0!==B&&!V.hasFeatures){const ie={id:j,addOrUpdate:V,end:0===I,type:"append"};return f.add({message:ie,query:ne}),void u._onMessage(ie)}const ae={id:j,addOrUpdate:V,end:0===I,type:"append"};return f.add({message:ae,query:ne}),void u._onMessage(ae)}const $={id:j,addOrUpdate:V,end:p&&0===I,type:"append"};f.add({message:$,query:ne}),u._onMessage($)};let S=0,T=0;for(;!p&&T++<20;){let O;for(let B=0;B<S+1;B++){const j=y++;I++,O=u._fetchDataTilePage(a,j,f).then(V=>V&&v(V,j)).catch(V=>{p=!0,(0,G.D_)(V)||(Zs.error(new A.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:V})),u._onMessage({id:a.id,addOrUpdate:null,end:p,type:"append"}))})}yield O,(0,G.k_)(f),S=Math.min(S+2,6)}})()}_fetchDataTilePage(a,u,h){var d=this;return(0,U.Z)(function*(){(0,G.k_)(h);const f=d._queryInfo,p={start:d.pageSize*u,num:d.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,b.pC)(d.maxRecordCountFactor)&&(p.maxRecordCountFactor=d.maxRecordCountFactor);const y=d.createTileQuery(a,p);try{const I=h.signal,v=yield d._queue.push({tile:a,query:y,signal:I,depth:u});return(0,G.k_)(h),v?f!==d._queryInfo?d._fetchDataTilePage(a,u,h):{reader:v,query:y}:null}catch(I){return(0,G.H9)(I),null}})()}}var Gs=M(4619),ks=M(52397);const js=z.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function Ws(c,a,u){const h=c.getXHydrated(),d=c.getYHydrated(),f=a.getColumnForX(h),p=Math.floor(a.normalizeCol(f));return`${u}/${Math.floor(a.getRowForY(d))}/${p}`}function kt(c,a){if((0,b.Wi)(c))return null;const u=a.transform,h=c.getQuantizationTransform();if((0,b.Wi)(h)){const[ne,$]=u.scale,[ae,ie]=u.translate;return c.transform(-ae/ne,ie/$,1/ne,1/-$)}const[d,f]=h.scale,[p,y]=h.translate,[I,v]=u.scale,[S,T]=u.translate;return c.transform((p-S)/I,(-y+T)/v,d/I,f/v)}class Ys extends Gt{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new Gs.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,u){super.update(a,u),this._hasAggregates=a.targets.aggregate}resend(a=!1){var u=this;return(0,U.Z)(function*(){if(yield u._downloadPromise,u._invalidated||a){const d=(0,b.s3)(u._schema.featureCount,"Expected featureCount to be defined");return u._invalidated=!1,u._subscriptions.forEach(f=>f.clear()),u._downloadPromise=u._download(d),void(yield u._downloadPromise)}const h=u._queries.map(({query:d,reader:f})=>u._sendPatchQuery(d,f));yield Promise.all(h),u._subscriptions.forEach(d=>{d.requests.done.forEach(f=>u._onMessage(f.message))})})()}refresh(){var a=this;return(0,U.Z)(function*(){yield a.resend(!0)})()}_sendPatchQuery(a,u){var h=this;return(0,U.Z)(function*(){const d=(0,b.pC)(a.outFields)?a.outFields:[],f=h._queryInfo.outFields,p=f.filter(S=>!d.includes(S));if(!p.length)return;const y=a.clone(),I=h._signal;y.returnGeometry=!1,y.returnCentroid=!1,y.outFields=p,a.outFields=f;const v=yield h._queue.push({query:y,depth:0,signal:I});(0,G.k_)({signal:I}),u.joinAttributes(v)})()}_fetchDataTile(a){var u=this;return(0,U.Z)(function*(){if(!u._downloadPromise){const v=(0,b.s3)(u._schema.featureCount,"Expected featureCount to be defined");u._downloadPromise=u._download(v)}const h=u._store.search(a),d=u._subscriptions.get(a.key.id),f=h.length-1;for(let v=0;v<f;v++){const S=kt(h[v],a),T={type:"append",id:a.id,addOrUpdate:S,end:!1,status:Te.empty()};d.add({query:null,message:T}),u._hasAggregates||(yield(0,G.e4)(1)),u._onMessage(T)}const p=kt(f>=0?h[f]:null,a),I={type:"append",id:a.id,addOrUpdate:p,end:u._didSendEnd,status:Te.empty()};d.add({query:null,message:I}),u._onMessage(I)})()}_download(a){var u=this;return(0,U.Z)(function*(){try{yield u.whenInitialized();const h=u._store.storage.getBitset(u._markedIdsBufId),d=new Set;h.clear();const f=Math.ceil(a/u.pageSize),p=Array.from({length:f},(y,I)=>I).sort((y,I)=>u._random.getInt()-u._random.getInt()).map(y=>u._downloadPage(y,h,d));yield Promise.all(p),u._store.sweepFeatures(h,u._store.storage),u._store.sweepFeatureSets(d)}catch(h){js.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",h)}u._sendEnd(),u._loading=!1})()}_downloadPage(a,u,h){var d=this;return(0,U.Z)(function*(){const f=d.pageSize,p={start:a*f,num:f,cacheHint:!0};(0,b.pC)(d.maxRecordCountFactor)&&(p.maxRecordCountFactor=d.maxRecordCountFactor);const y=d.createQuery(p),I=d._signal,v=yield d._queue.push({query:y,depth:a,signal:I});(0,G.k_)({signal:I}),d._queries.push({query:y,reader:v}),d._store.insert(v),h.add(v.instance);const S=v.getCursor();for(;S.next();)u.set(S.getDisplayId());d._send(v)})()}_send(a){if(!this._subscriptions.size)return;let u=null;const h=new Map,d=new Set,f=new Map;this._subscriptions.forEach(p=>{var O;const y=p.tile;h.set(y.key.id,null),u=y.tileInfoView,d.add(y.level);const{row:I,col:v}=y.key,S=`${y.level}/${I}/${v}`,T=null!=(O=f.get(S))?O:[];T.push(p),f.set(S,T)});for(const p of d){const y=u.getLODInfoAt(p),I=a.getCursor();for(;I.next();){const v=Ws(I,y,p),S=I.getIndex();if(f.has(v))for(const T of f.get(v)){const O=T.tile.id;let B=h.get(O);(0,b.Wi)(B)&&(B=[],h.set(O,B)),B.push(S)}}}h.forEach((p,y)=>{if((0,b.pC)(p)){const I=this._subscriptions.get(y),v={type:"append",id:y,addOrUpdate:kt(ks.t.from(a,p),I.tile),end:!1,status:Te.empty()};I.add({query:null,message:v}),this._onMessage(v)}})}_sendEnd(){this._subscriptions.forEach(a=>{const u={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:Te.empty()};a.add({query:null,message:u}),this._onMessage(u)}),this._didSendEnd=!0}}var Qs=M(21286),De=M(39351),pe=M(99666),qs=M(64288);M(81295),M(39406),z.Z.getLogger("esri.views.2d.engine.webgl");var pt=M(67969);const xt=z.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Rt=(xt,()=>null),At={sharedArrayBuffer:(0,F.Z)("esri-shared-array-buffer"),atomics:(0,F.Z)("esri-atomics")};function is(c,a){return u=>a(c(u))}class rr{constructor(a,u,h,d){this.size=0,this.texelSize=4;const{pixelType:f,layout:p,textureOnly:y}=d;this.textureOnly=y||!1,this.pixelType=f,this._ctype=u,this.layout=p,this._resetRange(),this._shared=a,this.size=h,y||(this.data=this._initData(f,h,a,u))}get buffer(){return(0,b.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,u){const h=(0,b.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)h[d*this.texelSize+a]&=~u;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,u){const h=(0,b.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)h[d*this.texelSize+a]|=255&u;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,u,h){const d=(0,b.Wg)(this.data);for(const f of h)d[f*this.texelSize+a]|=u,this.dirtyStart=Math.min(this.dirtyStart,f),this.dirtyEnd=Math.max(this.dirtyEnd,f)}setComponentTexel(a,u,h){(0,b.Wg)(this.data)[h*this.texelSize+a]|=u,this.dirtyStart=Math.min(this.dirtyStart,h),this.dirtyEnd=Math.max(this.dirtyEnd,h)}unsetComponentTexel(a,u,h){(0,b.Wg)(this.data)[h*this.texelSize+a]&=~u,this.dirtyStart=Math.min(this.dirtyStart,h),this.dirtyEnd=Math.max(this.dirtyEnd,h)}getData(a,u){const h=(0,pe.jL)(a);return(0,b.Wg)(this.data)[h*this.texelSize+u]}setData(a,u,h){const d=(0,pe.jL)(a);0!=(this.layout&1<<u)?(this.data[d*this.texelSize+u]=h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)):xt.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===pt.Br.UNSIGNED_BYTE&&this._shared&&At.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===pt.Br.UNSIGNED_BYTE&&this._shared&&At.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const u=this._initData(this.pixelType,a,this._shared,this._ctype),h=(0,b.Wg)(this.data);u.set(h),this.data=u}}toMessage(){const a=this.dirtyStart,u=this.dirtyEnd,h=this.texelSize;if(a>u)return null;this._resetRange();const d=!(this._shared||"local"===this._ctype),f=this.pixelType,p=this.layout,y=(0,b.Wg)(this.data);return{start:a,end:u,data:d&&y.slice(a*h,(u+1)*h)||null,pixelType:f,layout:p}}_initData(a,u,h,d){const f=h&&"local"!==d?SharedArrayBuffer:ArrayBuffer,p=(0,qs.UK)(a),y=new p(new f(u*u*4*p.BYTES_PER_ELEMENT));for(let I=0;I<y.length;I+=4)y[I+1]=255;return y}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class ir{constructor(a,u,h=(()=>{})){this._client=a,this.config=u,this._notifyChange=h,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(De.m4),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const d=u.supportsTextureFloat?pt.Br.FLOAT:pt.Br.UNSIGNED_BYTE;Rt(`Creating AttributeStore ${At.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:pt.Br.UNSIGNED_BYTE,layout:1},{pixelType:pt.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:pt.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,u){this.config=u;const h=u.schema.processors[0].storage,d=(0,qe.Hg)(this._schema,h);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),d&&((0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",d),a.storage.data=!0,this._schema=h,this._attributeComputeMap.clear(),!(0,b.Wi)(h))){switch(h.target){case"feature":this._targetType=pe.PX;break;case"aggregate":this._targetType=pe.xp}if("subtype"===h.type)for(const f in h.mapping){const p=h.mapping[f];if((0,b.pC)(p)&&(0,b.pC)(p.vvMapping))for(const y of p.vvMapping)this._bindAttribute(y)}else{if((0,b.pC)(h.vvMapping))for(const f of h.vvMapping)this._bindAttribute(f);if((0,b.pC)(h.attributeMapping))for(const f of h.attributeMapping)this._bindAttribute(f)}}}onTileData(a,u){if((0,b.Wi)(u.addOrUpdate))return;const h=u.addOrUpdate.getCursor();for(;h.next();){const d=h.getDisplayId();this.setAttributeData(d,h)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}setHighlight(a,u){var h=this;return(0,U.Z)(function*(){const f=h._getBlock(0),p=u.map(y=>(0,pe.jL)(y));f.lock(),f.unsetComponentAllTexels(0,1),f.setComponent(0,1,p),f.unlock(),h._idsToHighlight.clear();for(const y of a)h._idsToHighlight.add(y);yield h.sendUpdates()})()}updateFilters(a,u,h){var d=this;return(0,U.Z)(function*(){const{service:f,spatialReference:p}=h,{filters:y}=u,I=y.map((v,S)=>d._updateFilter(v,S,f,p));(yield Promise.all(I)).some(v=>v)&&(a.storage.filters=!0,(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,u,h,d){const f=(0,pe.jL)(a);this._ensureSizeForTexel(f),this._getBlock(u).setData(a,h,d)}getData(a,u,h){return this._getBlock(u).getData(a,h)}getHighlightFlag(a){return this._idsToHighlight.has(a)?De.uG:0}unsetAttributeData(a){const u=(0,pe.jL)(a);this._getBlock(0).setData(u,0,0)}setAttributeData(a,u){const h=(0,pe.jL)(a);if(this._ensureSizeForTexel(h),this._getBlock(0).setData(h,0,this.getFilterFlags(u)),this._targetType!==(0,pe.vs)(a))return;const d=this._attributeComputeMap,f=this.config.supportsTextureFloat?1:2;d.size&&d.forEach((y,I)=>{const v=I*f%4,S=Math.floor(I*f/4),T=this._getBlock(S+De.aK),O=y(u);if(this.config.supportsTextureFloat)T.setData(h,v,O);else if(O===De.AI)T.setData(h,v,255),T.setData(h,v+1,255);else{const B=(0,Qs.uZ)(Math.round(O),-32767,32766)+32768,V=(65280&B)>>8;T.setData(h,v,255&B),T.setData(h,v+1,V)}})}sendUpdates(){if((0,F.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,G.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(u=>(0,b.pC)(u)?u.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const u=()=>{if(this._currUpdate=null,this._nextUpdate){const d=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>d.resolve())}else(0,F.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,F.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const h=this._client.update(a,this._signal).then(u).catch(u);return this._client.render(this._signal),h}).catch(u=>{if((0,G.D_)(u))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),xt.error(new A.Z("mapview-attribute-store","Encountered an error during client update",u))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a){let d;if(null!=a.fieldIndex)d=function h(){return a.normalizationField&&xt.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),p=>p.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;d=function u(){return a.normalizationField?p=>{const y=p.readAttribute(a.normalizationField);return y?p.readAttribute(a.field)/y:null}:p=>p.readAttribute(a.field)}()}a.valueRepresentation&&(d=is(d,p=>function $s(c,a){if(!c||!a)return c;switch(a){case"radius":case"distance":return 2*c;case"diameter":case"width":return c;case"area":return Math.sqrt(c)}return c}(p,a.valueRepresentation))),this._attributeComputeMap.set(a.binding,is(d,p=>null===p||isNaN(p)||p===1/0?De.AI:p))}_createResources(){if((0,b.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(De.xl),this._getBlock(De.pU),Rt("Initializing AttributeStore");const a={shared:At.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,b.Fd)(this._blocks,h=>({textureOnly:h.textureOnly,buffer:h.buffer,pixelType:h.pixelType}))},u=this._client.initialize(a,this._signal).catch(h=>{(0,G.D_)(h)?this._createResourcesPromise=null:xt.error(new A.Z("mapview-attribute-store","Encountered an error during client initialization",h))});return this._createResourcesPromise=u,u.then(()=>(0,b.Wi)(this._createResourcesPromise)?this._createResources():void 0),u}_getBlock(a){const u=this._blocks[a];if((0,b.pC)(u))return u;Rt(`Initializing AttributeBlock at index ${a}`);const f=new rr(At.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=f,this._createResourcesPromise=null,f}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return Rt("Expanding block size to",a,this._blocks),(0,b.JR)(this._blocks,u=>u.expand(a)),this._createResourcesPromise=null,this._size=a,0}return xt.error(new A.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,u,h,d){var f=this;return(0,U.Z)(function*(){const p=f._filters[u],y=(0,b.pC)(p)&&p.hash;if(!p&&!a||y===JSON.stringify(a))return!1;if((0,b.Wi)(a)){if(!p)return!1;const v=1<<u+1,S=f._getBlock(0);return f._filters[u]=null,S.setComponentAllTexels(0,v),f.sendUpdates(),!0}return yield(yield f._getFilter(u,h)).update(a,d),!0})()}_getFilter(a,u){var h=this;return(0,U.Z)(function*(){const d=h._filters[a];if((0,b.pC)(d))return d;const{default:f}=yield M.e(8967).then(M.bind(M,8967)),p=new f({geometryType:u.geometryType,hasM:!1,hasZ:!1,timeInfo:u.timeInfo,fieldsIndex:new _.Z(u.fields)});return h._filters[a]=p,p})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let u=0;const h=(0,pe.KS)(a.getDisplayId());for(let f=0;f<this._filters.length;f++){const y=this._filters[f];u|=(h&1<<f&&!(0,b.Wi)(y)&&!y.check(a)?0:1)<<f}let d=0;if(this._idsToHighlight.size){const f=a.getObjectId();d=this.getHighlightFlag(f)}return u<<1|d}}function Yt(c,a,u,h){h%2&&(h+=1);let d=0,f=0,p=-90,y=90,I=-180,v=180;for(let S=0;S<h/2;S++){for(let T=0;T<5;T++){const O=(I+v)/2,B=u>O?1:0;d|=B<<29-(T+5*S),I=(1-B)*I+B*O,v=(1-B)*O+B*v}for(let T=0;T<5;T++){const O=(p+y)/2,B=a>O?1:0;f|=B<<29-(T+5*S),p=(1-B)*p+B*O,y=(1-B)*O+B*y}}c.geohashX=d,c.geohashY=f}function Pt(c,a,u,h,d){d%2&&(d+=1);let f=0,p=0,y=-90,I=90,v=-180,S=180;for(let T=0;T<d/2;T++){for(let O=0;O<5;O++){const B=(v+S)/2,j=h>B?1:0;f|=j<<29-(O+5*T),v=(1-j)*v+j*B,S=(1-j)*B+j*S}for(let O=0;O<5;O++){const B=(y+I)/2,j=u>B?1:0;p|=j<<29-(O+5*T),y=(1-j)*y+j*B,I=(1-j)*B+j*I}}c[2*a]=f,c[2*a+1]=p}M(29132),new Float64Array(2),new Float64Array(2);var at=M(65234),ut=M(82959);class ps{constructor(a=[],u,h=8096){this.onRelease=d=>{},this._nodes=0,this._root=new Vt(this,0,0,0),this._statisticFields=a,this._pool=h?new Et.Z(8096):null,this._serviceInfo=u}destroy(){this.clear()}_acquire(a,u,h){this._nodes++;let d=null;return(0,b.pC)(this._pool)&&(d=this._pool.dequeue()),(0,b.pC)(d)?d.realloc(a,u,h):d=new Vt(this,a,u,h),d}_release(a){this.onRelease(a),this._nodes--,(0,b.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,b.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(u=>a=Math.max(a,u.depth)),a}dropLevels(a){this.forEach(u=>{if(u.depth>=a)for(let h=0;h<u.children.length;h++){const d=u.children[h];d&&this._release(d)}}),this.forEach(u=>{if(u.depth>=a)for(let h=0;h<u.children.length;h++)u.children[h]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new Vt(this,0,0,0)}insert(a,u,h=0){const d=oe.fromOptimizedFeatures([a],this._serviceInfo).getCursor();d.next();const f=d.readGeometry();if(!f)return;const[p,y]=f.coords;this.insertCursor(d,a.displayId,p,y,a.geohashX,a.geohashY,u,h)}insertCursor(a,u,h,d,f,p,y,I=0){let v=this._root,S=0,T=0,O=0;for(;null!==v;){if(v.depth>=I&&(v.count+=1,v.xTotal+=h,v.yTotal+=d,v.xGeohashTotal+=f,v.yGeohashTotal+=p,v.referenceId=u,this._updateStatisticsCursor(a,v,1)),S>=y)return void v.add(u);const B=Math.ceil((S+1)/2),j=Math.floor((S+1)/2),V=1-S%2,ne=30-(3*B+2*j),$=30-(2*B+3*j),ae=(f&7*V+3*(1-V)<<ne)>>ne,ie=(p&3*V+7*(1-V)<<$)>>$,ce=ae+ie*(8*V+4*(1-V));T=T<<3*V+2*(1-V)|ae,O=O<<2*V+3*(1-V)|ie,null==v.children[ce]&&(v.children[ce]=this._acquire(T,O,S+1)),S+=1,v=v.children[ce]}}remove(a,u){const h=oe.fromOptimizedFeatures([a],this._serviceInfo).getCursor();h.next();const d=h.readGeometry();if(!d)return;const[f,p]=d.coords;this.removeCursor(h,f,p,a.geohashX,a.geohashY,u)}removeCursor(a,u,h,d,f,p){let y=this._root,I=0;for(;null!==y;){if(y.count-=1,y.xTotal-=u,y.yTotal-=h,y.xGeohashTotal-=d,y.yGeohashTotal-=f,this._updateStatisticsCursor(a,y,-1),I>=p)return void y.remove(a.getDisplayId());const v=Math.ceil((I+1)/2),S=Math.floor((I+1)/2),T=1-I%2,O=30-(3*v+2*S),B=30-(2*v+3*S),j=((d&7*T+3*(1-T)<<O)>>O)+((f&3*T+7*(1-T)<<B)>>B)*(8*T+4*(1-T)),V=y.children[j];1===V.count&&(this._release(V),y.children[j]=null),I+=1,y=V}}forEach(a){let u=this._root;for(;null!==u;){const h=this._linkChildren(u)||u.next;a(u),u=h}}find(a,u,h){return this._root.find(a,u,h,0,0,0)}findIf(a){let u=null;return this.forEach(h=>{a(h)&&(u=h)}),u}findAllIf(a){const u=[];return this.forEach(h=>{a(h)&&u.push(h)}),u}findSingleOccupancyNode(a,u,h,d,f){let p=this._root;for(;null!==p;){const y=p.depth,I=p.xNode,v=p.yNode,S=1-y%2,T=p.xGeohashTotal/p.count,O=p.yGeohashTotal/p.count;if(1===p.count&&a<T&&T<=h&&u<O&&O<=d)return p;if(y>=f){p=p.next;continue}const B=Math.ceil((y+1)/2),j=Math.floor((y+1)/2),V=30-(3*B+2*j),ne=30-(2*B+3*j),$=~((1<<V)-1),ae=~((1<<ne)-1),ce=(u&ae)>>ne,ge=(h&$)>>V,re=(d&ae)>>ne,_e=I<<3*S+2*(1-S),be=v<<2*S+3*(1-S),fe=_e+8*S+4*(1-S),ye=be+4*S+8*(1-S),me=Math.max(_e,(a&$)>>V),Pe=Math.max(be,ce),Be=Math.min(fe,ge),Ae=Math.min(ye,re);let Ce=null,Ee=null;for(let we=Pe;we<=Ae;we++)for(let Fe=me;Fe<=Be;Fe++){const Ue=p.children[Fe-_e+(we-be)*(8*S+4*(1-S))];Ue&&(Ce||(Ce=Ue,Ce.next=p.next),Ee&&(Ee.next=Ue),Ee=Ue,Ue.next=p.next)}p=Ce||p.next}return null}getRegionDisplayIds(a,u,h,d,f){let p=this._root;const y=[];for(;null!==p;){const I=p.depth,v=p.xNode,S=p.yNode;if(I>=f){const Ee=p.xGeohashTotal/p.count,we=p.yGeohashTotal/p.count;a<=Ee&&Ee<=h&&u<=we&&we<=d&&p.displayIds.forEach(Fe=>y.push(Fe)),p=p.next;continue}const T=Math.ceil((I+1)/2),O=Math.floor((I+1)/2),B=1-I%2,j=30-(3*T+2*O),V=30-(2*T+3*O),ne=~((1<<j)-1),$=~((1<<V)-1),ie=(u&$)>>V,ce=(h&ne)>>j,ge=(d&$)>>V,re=v<<3*B+2*(1-B),_e=S<<2*B+3*(1-B),be=re+8*B+4*(1-B),fe=_e+4*B+8*(1-B),ye=Math.max(re,(a&ne)>>j),me=Math.max(_e,ie),Pe=Math.min(be,ce),Be=Math.min(fe,ge);let Ae=null,Ce=null;for(let Ee=me;Ee<=Be;Ee++)for(let we=ye;we<=Pe;we++){const ve=p.children[we-re+(Ee-_e)*(8*B+4*(1-B))];ve&&(Ae||(Ae=ve,Ae.next=p.next),Ce&&(Ce.next=ve),Ce=ve,ve.next=p.next)}p=Ae||p.next}return y}getRegionStatistics(a,u,h,d,f){let p=this._root,y=0,I=0,v=0;const S={};let T=0;for(;null!==p;){const O=p.depth,B=p.xNode,j=p.yNode;if(O>=f){const Ue=p.xGeohashTotal/p.count,dt=p.yGeohashTotal/p.count;a<Ue&&Ue<=h&&u<dt&&dt<=d&&(y+=p.count,I+=p.xTotal,v+=p.yTotal,1===p.count&&(T=p.referenceId),this._aggregateStatistics(S,p.statistics)),p=p.next;continue}const V=Math.ceil((O+1)/2),ne=Math.floor((O+1)/2),$=1-O%2,ae=30-(3*V+2*ne),ie=30-(2*V+3*ne),ce=~((1<<ae)-1),ge=~((1<<ie)-1),_e=(u&ge)>>ie,be=(h&ce)>>ae,fe=(d&ge)>>ie,ye=B<<3*$+2*(1-$),me=j<<2*$+3*(1-$),Pe=ye+8*$+4*(1-$),Be=me+4*$+8*(1-$),Ae=Math.max(ye,(a&ce)>>ae),Ce=Math.max(me,_e),Ee=Math.min(Pe,be),we=Math.min(Be,fe);let Fe=null,ve=null;for(let Ue=Ce;Ue<=we;Ue++)for(let dt=Ae;dt<=Ee;dt++){const Xe=p.children[dt-ye+(Ue-me)*(8*$+4*(1-$))];if(Xe){if(Ue!==Ce&&Ue!==we&&dt!==Ae&&dt!==Ee){const Ss=Xe.xGeohashTotal/Xe.count,bs=Xe.yGeohashTotal/Xe.count;a<Ss&&Ss<=h&&u<bs&&bs<=d&&(y+=Xe.count,I+=Xe.xTotal,v+=Xe.yTotal,1===p.count&&(T=p.referenceId),this._aggregateStatistics(S,Xe.statistics));continue}Fe||(Fe=Xe,Fe.next=p.next),ve&&(ve.next=Xe),ve=Xe,Xe.next=p.next}}p=Fe||p.next}return{count:y,attributes:this.normalizeStatistics(S,y),xTotal:I,yTotal:v,referenceId:T}}getBins(a,u,h,d,f){const p=[];let y=this._root;for(;null!==y;){const I=y.depth,v=y.xNode,S=y.yNode;if(I>=f){p.push(y),y=y.next;continue}const T=Math.ceil((I+1)/2),O=Math.floor((I+1)/2),B=1-I%2,j=30-(3*T+2*O),V=30-(2*T+3*O),ne=~((1<<j)-1),$=~((1<<V)-1),ie=(u&$)>>V,ce=(h&ne)>>j,ge=(d&$)>>V,re=v<<3*B+2*(1-B),_e=S<<2*B+3*(1-B),be=re+8*B+4*(1-B),fe=_e+4*B+8*(1-B),ye=Math.max(re,(a&ne)>>j),me=Math.max(_e,ie),Pe=Math.min(be,ce),Be=Math.min(fe,ge);let Ae=null,Ce=null;for(let Ee=me;Ee<=Be;Ee++)for(let we=ye;we<=Pe;we++){const ve=y.children[we-re+(Ee-_e)*(8*B+4*(1-B))];ve&&(Ae||(Ae=ve,Ae.next=y.next),Ce&&(Ce.next=ve),Ce=ve,ve.next=y.next)}y=Ae||y.next}return p}_linkChildren(a){let u=null,h=null;for(let d=0;d<=a.children.length;d++){const f=a.children[d];f&&(u||(u=f,u.next=a.next),h&&(h.next=f),h=f,f.next=a.next)}return u}_updateStatisticsCursor(a,u,h){for(const d of this._statisticFields){const f=d.name,p=d.inField?a.readAttribute(d.inField):a.getComputedNumericAtIndex(d.inFieldIndex);switch(d.statisticType){case"norm":{u.statistics[f]||(u.statistics[f]={});const I=a.readAttribute(d.inNormalizationField),v=u.statistics[f].onStatisticField||0,S=u.statistics[f].onStatisticNormalizationField||0;null==p||isNaN(p)||null==I||0===I||isNaN(I)||(u.statistics[f].onStatisticField=v+h*p,u.statistics[f].onStatisticNormalizationField=S+h*I);break}case"sum":case"avg":{u.statistics[f]||(u.statistics[f]={value:0,nanCount:0});const y=u.statistics[f].value,I=u.statistics[f].nanCount;null==p||isNaN(p)?u.statistics[f].nanCount=I+h:u.statistics[f].value=y+h*p;break}case"avg_angle":{u.statistics[f]||(u.statistics[f]={x:0,y:0,nanCount:0});const y=u.statistics[f].x,I=u.statistics[f].y,v=u.statistics[f].nanCount,S=Math.PI/180;null==p||isNaN(p)?u.statistics[f].nanCount=v+h:(u.statistics[f].x=y+h*Math.cos(p*S),u.statistics[f].y=I+h*Math.sin(p*S));break}case"mode":u.statistics[f]||(u.statistics[f]={}),u.statistics[f][p]=(u.statistics[f][p]||0)+h}}}_aggregateStatistics(a,u){for(const h of this._statisticFields){const d=h.name;switch(h.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":a[d]||(a[d]={});for(const f in u[d])a[d][f]=(a[d][f]||0)+u[d][f]}}}normalizeStatistics(a,u){const h={};for(const d of this._statisticFields){const f=d.name;switch(d.statisticType){case"norm":{const p=a[f];if(u&&null==p.onStatisticNormalizationField)break;if(u&&p.onStatisticNormalizationField){h[f]=p.onStatisticField/p.onStatisticNormalizationField;break}h[f]=0;break}case"sum":{if(!u)break;const{value:p,nanCount:y}=a[f];if(!(u-y))break;h[f]=p;break}case"avg":{if(!u)break;const{value:p,nanCount:y}=a[f];if(!(u-y))break;h[f]=p/(u-y);break}case"avg_angle":{if(!u)break;const{x:p,y,nanCount:I}=a[f];if(!(u-I))break;const T=180/Math.PI,O=Math.atan2(y/(u-I),p/(u-I))*T;h[f]=O;break}case"mode":{const p=a[f];let y=0,I=null;for(const v in p){const S=p[v];S>y&&(y=S,I=v)}h[f]="null"===I?null:I;break}}}return h}}class Vt{constructor(a,u,h,d){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=u,this.yNode=h,this.depth=d}realloc(a,u,h){for(let d=0;d<this.children.length;d++)this.children[d]=null;return this.xNode=a,this.yNode=u,this.depth=h,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,u){const h=this.getLngLatBounds(),[d,f,p,y]=h,I=(0,ut.iV)({rings:[[[d,f],[d,y],[p,y],[p,f],[d,f]]]},at.Z.WGS84,a),v=(0,w.Uy)(new P.Z,I,!1,!1);return(0,b.pC)(u)?(0,w.Nh)(new P.Z,v,!1,!1,"esriGeometryPolygon",u,!1,!1):v}getLngLatBounds(){const a=this.depth,u=Math.ceil(a/2),h=Math.floor(a/2);return function ar(c,a){let u=-90,h=90,d=-180,f=180;for(let p=0;p<a;p++){const y=Math.ceil((p+1)/2),I=Math.floor((p+1)/2),v=1-p%2,S=30-(3*y+2*I),T=30-(2*y+3*I),B=2*v+3*(1-v),V=(7*v+3*(1-v)<<S&c.geohashX)>>S,ne=(3*v+7*(1-v)<<T&c.geohashY)>>T;for(let $=3*v+2*(1-v)-1;$>=0;$--){const ae=(d+f)/2,ie=V&1<<$?1:0;d=(1-ie)*d+ie*ae,f=(1-ie)*ae+ie*f}for(let $=B-1;$>=0;$--){const ae=(u+h)/2,ie=ne&1<<$?1:0;u=(1-ie)*u+ie*ae,h=(1-ie)*ae+ie*h}}return[d,u,f,h]}({geohashX:this.xNode<<30-(3*u+2*h),geohashY:this.yNode<<30-(2*u+3*h)},this.depth)}find(a,u,h,d,f,p){if(d>=h)return this;const y=1-d%2,I=3*y+2*(1-y),v=2*y+3*(1-y),S=30-f-I,T=30-p-v,B=this.children[((a&7*y+3*(1-y)<<S)>>S)+((u&3*y+7*(1-y)<<T)>>T)*(8*y+4*(1-y))];return null==B?null:B.find(a,u,h,d+1,f+I,p+v)}}var lt=M(94425),_s=M(16669),dr=M(37118),cr=M(2004);const Qt=z.Z.getLogger("esri.view.2d.layers.features.support.BinStore");function ys(c){return 57.29577951308232*c}class pr extends _s.J{constructor(a,u,h,d){super(a,h),this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=u,this._projectionSupportCheck=(0,ut._W)(u,at.Z.WGS84),this._bitsets.geohash=h.getBitset(h.createBitset()),this._bitsets.inserted=h.getBitset(h.createBitset())}destroy(){this._tree&&this._tree.destroy()}updateSchema(a,u){var h=()=>super.updateSchema,d=this;return(0,U.Z)(function*(){const f=d._schema;try{yield h().call(d,a,u),yield d._projectionSupportCheck}catch(y){}const p=(0,qe.Hg)(f,u);u&&(!(0,b.Wi)(p)||a.source||a.storage.filters)?(((0,qe.uD)(p,"params.fields")||(0,qe.uD)(p,"params")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new ps(d._statisticFields,d._serviceInfo),d._tree.onRelease=y=>y.displayId&&d._storage.releaseDisplayId(y.displayId),d._geohashLevel=d._schema.params.fixedBinLevel,d._rebuildTree(),(0,F.Z)("esri-2d-update-debug")&&Qt.info("Aggregate mesh needs update due to tree changing")),(0,F.Z)("esri-2d-update-debug")&&Qt.info("Aggregate mesh needs update due to tree changing"),a.targets[u.name]=!0,a.mesh=!1):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,u){this._bitsets.inserted.forEachSet(h=>{if(!a.has(h)){const d=u.lookupByDisplayIdUnsafe(h);this._remove(d)}})}sweepAggregates(a,u,h){}onTileData(a,u,h,d,f=!0){if(!this._schema||(0,b.Wi)(u.addOrUpdate))return u;const p=this._getTransforms(a,this._spatialReference);{const I=u.addOrUpdate.getCursor();for(;I.next();)this._update(I,d)}if(u.status.mesh||!f)return u;const y=new Array;this._getBinsForTile(y,a,p,h),u.addOrUpdate=oe.fromOptimizedFeatures(y,Re(Ie({},this._serviceInfo),{geometryType:"esriGeometryPolygon"})),u.addOrUpdate.attachStorage(h),u.clear=!0,u.end=!0;{const I=u.addOrUpdate.getCursor();for(;I.next();){const v=I.getDisplayId();this._bitsets.computed.unset(v),this.setComputedAttributes(h,I,v,a.scale)}}return u}forEach(a){this._tree.forEach(a)}onTileUpdate(a){}getAggregate(a){const u=(0,pe.QS)(a,!0),h=this._tree.findIf(d=>d.displayId===u);return(0,b.yw)(h,d=>this._toAggregateGraphic(d))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toAggregateGraphic.bind(this))}getDisplayId(a){const u=this._tree.findIf(h=>h.id===a);return(0,b.yw)(u,h=>h.displayId)}getFeatureDisplayIdsForAggregate(a){const u=this._tree.findIf(h=>h.id===a);return(0,b.R2)(u,[],h=>Array.from(h.displayIds))}getDisplayIdForReferenceId(a){const u=this._tree.findIf(h=>1===h.displayIds.size&&h.displayIds.has(a));return(0,b.yw)(u,h=>h.displayId)}_toAggregateGraphic(a){const u=this._spatialReference;return{referenceId:null,objectId:a.id,displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,w.di)(a.getGeometry(u),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const u=a.getDisplayId(),h=a.getXHydrated(),d=a.getYHydrated(),f=this._geohashBuf[2*u],p=this._geohashBuf[2*u+1];this._bitsets.inserted.has(u)&&(this._bitsets.inserted.unset(u),this._tree.removeCursor(a,h,d,f,p,this._geohashLevel))}_update(a,u){const h=a.getDisplayId(),d=this._bitsets.inserted,f=u.isVisible(h);if(f===d.has(h))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),y=a.getYHydrated();this._setGeohash(h,p,y)&&(this._tree.insertCursor(a,h,p,y,this._geohashBuf[2*h],this._geohashBuf[2*h+1],this._geohashLevel),d.set(h))}_setGeohash(a,u,h){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=ys(u/lt.sv.radius),p=f-360*Math.floor((f+180)/360);Pt(d,a,ys(Math.PI/2-2*Math.atan(Math.exp(-h/lt.sv.radius))),p,12)}else{const f=(0,ut.iV)({x:u,y:h},this._spatialReference,at.Z.WGS84);if(!f)return!1;Pt(d,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,u,h,d){try{const{xLL:f,yLL:p,xTR:y,yTR:I,level:v}=this._getGeohashBounds(u),S=this._tree.getBins(f,p,y,I,v);for(const T of S){T.displayId||(T.displayId=d.createDisplayId(!0));const O=T.getGeometry(this._spatialReference,h.tile),B=new k.u_(O,T.getAttributes());B.objectId=T.id,B.displayId=T.displayId,a.push(B)}}catch(f){return void Qt.error("Unable to get bins for tile",u.key.id)}}_getGeohash(a,u,h){const d={geohashX:0,geohashY:0};return Yt(d,u,a,h),d}_getGeohashBounds(a){const u=this._getGeohashLevel(a.key.level),d=dr.Z.fromExtent(cr.Z.fromBounds([a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],this._spatialReference)),f=(0,ut.iV)(d,this._spatialReference,at.Z.WGS84,{densificationStep:64*a.resolution}),p=(0,w.Uy)(new P.Z,f,!1,!1),y=p.coords.filter((V,ne)=>!(ne%2)),I=p.coords.filter((V,ne)=>ne%2),v=Math.min(...y),S=Math.min(...I),T=Math.max(...y),O=Math.max(...I),B=this._getGeohash(v,S,u),j=this._getGeohash(T,O,u);return{xLL:B.geohashX,yLL:B.geohashY,xTR:j.geohashX,yTR:j.geohashY,level:u}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,u){const h={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,se.C5)(u);if(!d)return{tile:h,left:null,right:null};const[f,p]=d.valid;return{tile:h,left:Re(Ie({},h),{translate:[p,a.bounds[3]]}),right:Re(Ie({},h),{translate:[f-p+a.bounds[0],a.bounds[3]]})}}}class Ht extends k.nd{constructor(a,u,h,d,f){super(new P.Z([],[u,h]),d,null,a),this.geohashBoundsInfo=f}get count(){return this.attributes.cluster_count}static create(a,u,h,d,f,p,y,I){const v=new Ht(u,h,d,p,y);return v.displayId=a.createDisplayId(!0),v.referenceId=I,v.tileLevel=f,v}update(a,u,h,d,f,p){return this.geometry.coords[0]=a,this.geometry.coords[1]=u,this.tileLevel=h,this.attributes=d,this.geohashBoundsInfo=f,this.referenceId=null,this.referenceId=p,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:Re(Ie({},this.attributes),{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function Ct(c){return 57.29577951308232*c}class _r extends _s.J{constructor(a,u,h,d){super(a,h),this.events=new Tt.Z,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=u,this._projectionSupportCheck=(0,ut._W)(u,at.Z.WGS84),this._bitsets.geohash=h.getBitset(h.createBitset()),this._bitsets.inserted=h.getBitset(h.createBitset())}destroy(){this._tree.destroy()}updateSchema(a,u){var h=()=>super.updateSchema,d=this;return(0,U.Z)(function*(){const f=d._schema;try{yield h().call(d,a,u),yield d._projectionSupportCheck}catch(y){}const p=(0,qe.Hg)(f,u);u&&(!(0,b.Wi)(p)||a.source||a.storage.filters)?(((0,qe.uD)(p,"params.fields")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new ps(d._statisticFields,d._serviceInfo),d._rebuildTree(),(0,F.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",p),a.targets[u.name]=!0,a.mesh=!1,d._aggregateValueRanges={}):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,u){this._bitsets.inserted.forEachSet(h=>{if(!a.has(h)){const d=u.lookupByDisplayIdUnsafe(h);this._remove(d)}})}sweepAggregates(a,u,h){this._clusters.forEach((d,f)=>{d&&d.tileLevel!==h&&(a.releaseDisplayId(d.displayId),u.unsetAttributeData(d.displayId),this._clusters.delete(f))})}onTileData(a,u,h,d,f=!0){if(!this._schema||(0,b.Wi)(u.addOrUpdate))return u;const p=this._getTransforms(a,this._spatialReference);{const v=u.addOrUpdate.getCursor();for(;v.next();)this._update(v,d)}if(u.status.mesh||!f)return u;const y=new Array;this._getClustersForTile(y,a,this._schema.params.clusterRadius,h,p),u.addOrUpdate=oe.fromOptimizedFeatures(y,this._serviceInfo),u.addOrUpdate.attachStorage(h),u.clear=!0,u.end=!0;{const v=u.addOrUpdate.getCursor();for(;v.next();){const S=v.getDisplayId();this._bitsets.computed.unset(S),this.setComputedAttributes(h,v,S,a.scale)}}return this._aggregateValueRangesChanged&&u.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),u}onTileUpdate({added:a,removed:u}){if(a.length){const d=a[0].level;this._tileLevel=d,this._setGeohashLevel(d)}if(!this._schema)return;const h=this._schema.params.clusterRadius;u.forEach(d=>{this._tiles.delete(d.key.id),this._markTileClustersForDeletion(d,h)})}getAggregate(a){for(const u of this._clusters.values())if(((null==u?void 0:u.displayId)&pe._I)==(a&pe._I))return u.toJSON();return null}getAggregates(){const a=[];for(const u of this._clusters.values())(null==u?void 0:u.tileLevel)===this._tileLevel&&a.push(u.toJSON());return a}getDisplayId(a){const u=this._clusters.get(a);return u?u.displayId:null}getFeatureDisplayIdsForAggregate(a){const u=this._clusters.get(a);if(!u)return[];const h=u.geohashBoundsInfo;return this._tree.getRegionDisplayIds(h.xLL,h.yLL,h.xTR,h.yTR,h.level)}getDisplayIdForReferenceId(a){for(const u of this._clusters.values())if((null==u?void 0:u.referenceId)===a)return u.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){for(const[u,h]of this._clusters)h&&a(h,u)}size(){let a=0;return this.forEach(u=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const u=a.getDisplayId(),h=a.getXHydrated(),d=a.getYHydrated(),f=this._geohashBuf[2*u],p=this._geohashBuf[2*u+1];this._bitsets.inserted.has(u)&&(this._bitsets.inserted.unset(u),this._tree.removeCursor(a,h,d,f,p,this._geohashLevel))}_update(a,u){const h=a.getDisplayId(),d=this._bitsets.inserted,f=u.isVisible(h);if(f===d.has(h))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),y=a.getYHydrated();this._setGeohash(h,p,y)&&(this._tree.insertCursor(a,h,p,y,this._geohashBuf[2*h],this._geohashBuf[2*h+1],this._geohashLevel),d.set(h))}_setGeohash(a,u,h){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=Ct(u/lt.sv.radius),p=f-360*Math.floor((f+180)/360);Pt(d,a,Ct(Math.PI/2-2*Math.atan(Math.exp(-h/lt.sv.radius))),p,12)}else{const f=(0,ut.iV)({x:u,y:h},this._spatialReference,at.Z.WGS84);if(!f)return!1;Pt(d,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,u,h,d,f,p=!0){const y=this._schema.params.clusterPixelBuffer,I=2*h,v=this._getGeohashLevel(u.key.level),S=Math.ceil(2**u.key.level*De.I_/I),T=Math.ceil(y/I)+0,O=Math.ceil(De.I_/I),{row:B,col:j}=u.key,ne=B*De.I_,$=Math.floor(j*De.I_/I)-T,ae=Math.floor(ne/I)-T,ie=$+O+2*T,ce=ae+O+2*T,ge=u.tileInfoView.getLODInfoAt(u.key.level);for(let re=$;re<=ie;re++)for(let _e=ae;_e<=ce;_e++){let be=re;ge.wrap&&(be=re<0?re+S:re%S);const fe=ge.wrap&&re<0,ye=ge.wrap&&re%S!==re,me=this._lookupCluster(d,ge,u.key.level,be,_e,v);if((0,b.pC)(me)){const Pe=(0,b.yw)(f,Be=>fe?Be.left:ye?Be.right:Be.tile);if(p&&(0,b.Wi)(Pe)||!me.count)continue;if((0,b.pC)(Pe)&&p){const Be=me.geometry.clone();let Ae=me.attributes;Be.coords[0]=(0,w.Jd)(Pe,Be.coords[0]),Be.coords[1]=(0,w.IN)(Pe,Be.coords[1]),1===me.count&&(0,b.pC)(me.referenceId)&&(Ae=Re(Ie({},me.attributes),{referenceId:me.referenceId}));const Ce=new k.u_(Be,Ae);Ce.displayId=me.displayId,a.push(Ce)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const u=this._getGeohashLevel(a),h=1*(Math.floor(u/1)+1)-1;if(this._geohashLevel!==h)return this._geohashLevel=h,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,u){const h={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,se.C5)(u);if(!d)return{tile:h,left:null,right:null};const[f,p]=d.valid;return{tile:h,left:Re(Ie({},h),{translate:[p,a.bounds[3]]}),right:Re(Ie({},h),{translate:[f-p+a.bounds[0],a.bounds[3]]})}}_getClusterId(a,u,h){return(15&a)<<28|(16383&u)<<14|16383&h}_markForDeletion(a,u,h){const d=this._getClusterId(a,u,h);this._clusters.delete(d)}_getClusterBounds(a,u,h){const d=this._schema.params.clusterRadius,f=2*d;let p=h%2?u*f:u*f-d;const y=h*f;let I=p+f;const S=2**a.level*De.I_;a.wrap&&p<0&&(p=0),a.wrap&&I>S&&(I=S);const O=y/De.I_,B=I/De.I_,j=(y-f)/De.I_;return[a.getXForColumn(p/De.I_),a.getYForRow(O),a.getXForColumn(B),a.getYForRow(j)]}_lookupCluster(a,u,h,d,f,p){const y=this._getClusterId(h,d,f),I=this._clusters.get(y),[v,S,T,O]=this._getClusterBounds(u,d,f),B={x:v,y:S},j={x:T,y:O};let V=0,ne=0,$=0,ae=0;if(this._spatialReference.isWebMercator){{const ve=Ct(B.x/lt.sv.radius);V=ve-360*Math.floor((ve+180)/360),ne=Ct(Math.PI/2-2*Math.atan(Math.exp(-B.y/lt.sv.radius)))}{const ve=Ct(j.x/lt.sv.radius);$=ve-360*Math.floor((ve+180)/360),ae=Ct(Math.PI/2-2*Math.atan(Math.exp(-j.y/lt.sv.radius)))}}else{const ve=(0,ut.iV)(B,this._spatialReference,at.Z.WGS84),Ue=(0,ut.iV)(j,this._spatialReference,at.Z.WGS84);if(!ve||!Ue)return null;V=ve.x,ne=ve.y,$=Ue.x,ae=Ue.y}const ie={geohashX:0,geohashY:0},ce={geohashX:0,geohashY:0};Yt(ie,ne,V,p),Yt(ce,ae,$,p);const ge=ie.geohashX,re=ie.geohashY,_e=ce.geohashX,be=ce.geohashY,fe={xLL:ge,yLL:re,xTR:_e,yTR:be,level:p},ye=this._tree.getRegionStatistics(ge,re,_e,be,p),{count:me,xTotal:Pe,yTotal:Be,referenceId:Ae}=ye,Ce=me?Pe/me:0,Ee=me?Be/me:0;if(0===me)return this._clusters.set(y,null),null;const we=Ie({cluster_count:me},ye.attributes),Fe=(0,b.pC)(I)?I.update(Ce,Ee,h,we,fe,Ae):Ht.create(a,y,Ce,Ee,h,we,fe,Ae);return 0===me&&(Fe.geometry.coords[0]=(v+T)/2,Fe.geometry.coords[1]=(S+O)/2),this._clusters.set(y,Fe),this._updateAggregateValueRangeForCluster(Fe,Fe.tileLevel),Fe}_updateAggregateValueRangeForCluster(a,u){const h=this._aggregateValueRanges[u]||{minValue:1/0,maxValue:0},d=h.minValue,f=h.maxValue;h.minValue=Math.min(d,a.count),h.maxValue=Math.max(f,a.count),this._aggregateValueRanges[u]=h,d===h.minValue&&f===h.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,u){const h=2*u,d=Math.ceil(De.I_/h),{row:f,col:p}=a.key,I=f*De.I_,v=Math.floor(p*De.I_/h),S=Math.floor(I/h);for(let T=v;T<v+d;T++)for(let O=S;O<S+d;O++)this._markForDeletion(a.key.level,T,O)}}class mr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,pe.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var yr=M(42797);function Ut(c,a,u){if(!(c.length>a))for(;c.length<=a;)c.push(u)}class Ir{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new mr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(yr.p.create(this._allocatedSize,pe._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,u){this._numerics[a]||(this._numerics[a]=[]),Ut(this._numerics[a],u,0)}_ensureInstanceId(a){Ut(this._instanceIds,a,0)}_ensureString(a,u){this._strings[a]||(this._strings[a]=[]),Ut(this._strings[a],u,null)}createDisplayId(a=!1){const u=this._idGenerator.createId();return u>this._allocatedSize&&this._expand(),(0,pe.QS)(u,a)}releaseDisplayId(a){for(const u of this._bitsets)u.unset(a);return this._idGenerator.releaseId(a&pe._I)}getComputedNumeric(a,u){return this.getComputedNumericAtIndex(a&pe._I,0)}setComputedNumeric(a,u,h){return this.setComputedNumericAtIndex(a&pe._I,h,0)}getComputedString(a,u){return this.getComputedStringAtIndex(a&pe._I,0)}setComputedString(a,u,h){return this.setComputedStringAtIndex(a&pe._I,0,h)}getComputedNumericAtIndex(a,u){const h=a&pe._I;return this._ensureNumeric(u,h),this._numerics[u][h]}setComputedNumericAtIndex(a,u,h){const d=a&pe._I;this._ensureNumeric(u,d),this._numerics[u][d]=h}getInstanceId(a){const u=a&pe._I;return this._ensureInstanceId(u),this._instanceIds[u]}setInstanceId(a,u){const h=a&pe._I;this._ensureInstanceId(h),this._instanceIds[h]=u}getComputedStringAtIndex(a,u){const h=a&pe._I;return this._ensureString(u,h),this._strings[u][h]}setComputedStringAtIndex(a,u,h){const d=a&pe._I;this._ensureString(u,d),this._strings[u][d]=h}getXMin(a){return this._bounds[4*(a&pe._I)]}getYMin(a){return this._bounds[4*(a&pe._I)+1]}getXMax(a){return this._bounds[4*(a&pe._I)+2]}getYMax(a){return this._bounds[4*(a&pe._I)+3]}setBounds(a,u){const h=u.readHydratedGeometry();if(!h||!h.coords.length)return!1;let d=1/0,f=1/0,p=-1/0,y=-1/0;h.forEachVertex((v,S)=>{d=Math.min(d,v),f=Math.min(f,S),p=Math.max(p,v),y=Math.max(y,S)});const I=a&pe._I;return Ut(this._bounds,4*I+4,0),this._bounds[4*I]=d,this._bounds[4*I+1]=f,this._bounds[4*I+2]=p,this._bounds[4*I+3]=y,!0}}function ht(c){if(!(0,G.D_)(c)&&!function Cr(c){return"worker:port-closed"===c.name}(c))throw c}function vs(c){return"feature"===c.type&&"snapshot"===c.mode}let Ke=class extends W.r{constructor(){super(...arguments),this._storage=new Ir,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new Nt.e({concurrency:"geoevent"===this._source.type?1:4,process:(c,a)=>this._onTileMessage(c,{signal:a})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,Z.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function Xs(c,a,u,h,d,f){const p=function Vs(c,a,u,h,d,f){switch(c.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,b.Pt)(c.featureCount,0),serviceInfo:c,onMessage:h,outSR:a,tileInfoView:u,canAcceptRequest:d,store:f};case"stream":return{type:"geoevent",serviceInfo:c,onMessage:h,outSR:a,canAcceptRequest:d};case"memory":case"on-demand":return{type:"feature",serviceInfo:c,onMessage:h,outSR:a,origin:function p(y){return Array.isArray(y)?"local":"path"in y&&(0,x.M8)(y.path)?"hosted":"unknown"}(c.source),tileInfoView:u,canAcceptRequest:d}}}(c,a,u,h,d,f);switch(p.type){case"feature":switch(p.origin){case"hosted":case"local":return new Ns(p);case"snapshot":return new Ys(p);case"unknown":return new As(p)}case"geoevent":return new zs(p)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(h,d)=>(this._invalidated=!0,this._patchTile(h,d)),()=>this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const c=this._source.events;this.handles.add([c.on("connectionStatus",a=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:a}).catch(ht)),c.on("errorString",a=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:a}).catch(ht)),c.on("feature",a=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry}}).catch(ht)),c.on("updateRate",a=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:Ie({},a)}).catch(ht))])}}_initAttributeStore(c){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new ir({type:"remote",initialize:(a,u)=>(0,G.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:u}).catch(ht)),update:(a,u)=>(0,G.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:u}).catch(ht)),render:a=>(0,G.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(ht))},c,()=>this.notifyChange("updating"))}_initStores(){this.featureStore=new m.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(c){var u;const a=this;null==(u=this.queryEngine)||u.destroy(),this.queryEngine=new L.q({definitionExpression:c.schema.source.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:h=>(0,b.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(h).map(d=>a.getObjectId(d))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();for(const c of this.tileStore.tiles)this._source.unsubscribe(c);clearInterval(this._checkUpdating)}get fieldsIndex(){return new _.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const c=this._source.updating,a=!!this._updateQueue.length,u=!this.attributeStore||this.attributeStore.isUpdating(),h=c||a||u;return(0,F.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${h}\n  -> updatingSource ${c}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${u}\n`),h}enableEvent(c){this._source.enableEvent(c.name,c.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"geoevent"===this._source.type&&this._source.pauseStream()}resumeStream(){"geoevent"===this._source.type&&this._source.resumeStream()}_initAggregateStore(c){var d,f;const a={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},u=null==(f=null==(d=c.schema.targets)?void 0:d.aggregate)?void 0:f.type;if((0,b.yw)(this.config,p=>{var y,I;return null==(I=null==(y=p.schema.targets)?void 0:y.aggregate)?void 0:I.type})!==u&&((0,b.pC)(this.aggregateStore)&&(this.handles.remove("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),u)){switch(u){case"cluster":this.aggregateStore=new _r(a,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",p=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:p.valueRanges}}).catch(ht)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new pr(a,this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(c,a){var u=this;return(0,U.Z)(function*(){u._updateVersion++,u._initQueryEngine(a),u._initAttributeStore(a),u.pause(),yield Promise.all([u._source.update(c,a.schema.source),u.featureStore.updateSchema(c,a.schema.targets.feature),u.attributeStore.update(c,a),u.attributeStore.updateFilters(c,a,u)]),u._initAggregateStore(a),(0,b.pC)(u.aggregateStore)&&(yield u.aggregateStore.updateSchema(c,a.schema.targets.aggregate)),(0,F.Z)("esri-2d-update-debug")&&c.describe(),u._set("config",a)})()}applyUpdate(c){var a=this;return(0,U.Z)(function*(){c.version=a._updateVersion,(0,F.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${c.version}`),c.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(c),a.notifyChange("updating"),yield(0,Z.N1)(()=>!a.updating),(0,b.pC)(a.aggregateStore)&&(yield(0,G.e4)(10),yield(0,Z.N1)(()=>!a.updating))})()}onEdits({edits:c}){var a=this;return(0,U.Z)(function*(){(0,F.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",c),a._didEdit=!0;try{const u=c.removed.map(d=>d.objectId&&-1!==d.objectId?d.objectId:a._lookupObjectIdByGlobalId(d.globalId)),h=c.addOrModified.map(({objectId:d})=>d);a.featureStore.invalidate(),yield a._source.edit(h,u),a.clearTiles(),a.notifyChange("updating"),(0,b.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,Z.N1)(()=>!a.updating)}catch(u){}})()}refresh(c){var a=this;return(0,U.Z)(function*(){if(!c){const u=Te.empty();return u.storage.filters=!0,a.applyUpdate(u)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,Z.N1)(()=>!a.updating)})()}clearTiles(){for(const c of this.tileStore.tiles)this.processor.onTileClear(c)}onTileUpdate(c){(0,b.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(c);for(const a of c.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of c.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var c=this;return(0,U.Z)(function*(){c._invalidated&&(c._invalidated=!1,((0,b.pC)(c.aggregateStore)||"heatmap"===c.processor.type)&&(yield c._repushCurrentLevelTiles())),c._markAndSweep()})()}querySummaryStatistics({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForSummaryStatistics(c,a)})()}queryUniqueValues({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForUniqueValues(c,a)})()}queryClassBreaks({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForClassBreaks(c,a)})()}queryHistogram({query:c,params:a}){var u=this;return(0,U.Z)(function*(){return u.queryEngine.executeQueryForHistogram(c,a)})()}queryExtent(c){return this.queryEngine.executeQueryForExtent(c)}queryFeatures(c){return this.queryEngine.executeQuery(c)}queryVisibleFeatures(c){var a=this;return(0,U.Z)(function*(){const u=yield a.queryEngine.executeQuery(c),h=u.objectIdFieldName;return u.features=u.features.filter(d=>{const p=a.getDisplayId(d.attributes[h]);return(0,b.yw)(p,y=>a.attributeStore.isVisible(y))}),u})()}queryFeatureCount(c){return this.queryEngine.executeQueryForCount(c)}queryLatestObservations(c){return this.queryEngine.executeQueryForLatestObservations(c)}queryObjectIds(c){return this.queryEngine.executeQueryForIds(c)}queryStatistics(){var c=this;return(0,U.Z)(function*(){return c.featureStore.storeStatistics})()}getObjectId(c){return this.featureStore.lookupObjectId(c,this._storage)}getDisplayId(c){if((0,b.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(c);if((0,b.Wi)(a)){const u=this.featureStore.lookupDisplayId(c);return this.aggregateStore.getDisplayIdForReferenceId(u)}return a}return this.featureStore.lookupDisplayId(c)}getFeatures(c){const a=[],u=[];for(const h of c){const d=(0,b.pC)(this.aggregateStore)?this.getAggregate(h):null;if((0,b.pC)(d))if((0,b.pC)(d.referenceId)){const f=this.getFeature(d.referenceId);(0,b.pC)(f)&&a.push(f)}else u.push(d);else{const f=this.getFeature(h);(0,b.pC)(f)&&a.push(f)}}return{features:a,aggregates:u}}getFeature(c){const a=this.featureStore.lookupFeatureByDisplayId(c,this._storage);if((0,b.Wi)(a))return null;const u=a.readHydratedGeometry(),h=(0,w.di)(u,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:h}}getAggregate(c){return(0,b.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(c)}getAggregates(){return(0,b.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(c){var a=this;return(0,U.Z)(function*(){const u=(0,b.lV)(c.map(h=>a.getDisplayId(h)));return a.attributeStore.setHighlight(c,u)})()}_lookupObjectIdByGlobalId(c){const a=this.service.globalIdField;if((0,b.Wi)(a))throw new Error("Expected globalIdField to be defined");let u=null;if(this.featureStore.forEach(h=>{c===h.readAttribute(a)&&(u=h.getObjectId())}),(0,b.Wi)(u))throw new Error(`Expected to find a feature with globalId ${c}`);return u}_repushCurrentLevelTiles(){var c=this;return(0,U.Z)(function*(){const a=c.tileStore.tiles.filter(u=>u.level===c._level).map(function(){var u=(0,U.Z)(function*(h){return c._patchTile({type:"append",id:h.key.id,addOrUpdate:oe.fromOptimizedFeatures([],c.service),remove:[],end:!0,status:Te.empty()})});return function(h){return u.apply(this,arguments)}}());yield Promise.all(a)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(c,a){const u=this._updateQueue.push(c,a).then(()=>{this.notifyChange("updating")}).catch(h=>{this.notifyChange("updating")});return this.notifyChange("updating"),u}_onTileMessage(c,a){var u=this;return(0,U.Z)(function*(){(0,G.k_)(a);const h=u.tileStore.get(c.id);if(!h)return;if(c.clear)return u.processor.onTileClear(h);const d=c.status;u._cleanupNeeded=!0;const f=[];for(const p of c.remove){const y=u.featureStore.lookupDisplayId(p);y&&f.push(y)}c.remove=f;try{if((0,b.Wi)(c.addOrUpdate))return void u.processor.onTileMessage(h,Re(Ie({},c),{addOrUpdate:null}),(0,b.pC)(u.aggregateStore),a).catch(G.H9);if(c.addOrUpdate.setArcadeSpatialReference(u.spatialReference),u.featureStore.hasInstance(c.addOrUpdate.instance)&&d.targets.feature||(d.targets.feature=!0,u.featureStore.onTileData(h,c)),(!d.storage.data||!d.storage.filters)&&(d.storage.data=!0,d.storage.filters=!0,u.attributeStore.onTileData(h,c),"geoevent"===u._source.type||u._didEdit?(yield u.attributeStore.sendUpdates(),(0,G.k_)(a)):u.attributeStore.sendUpdates()),(0,b.pC)(u.aggregateStore)&&!d.targets.aggregate){d.targets.aggregate=!0;const p=vs(u._source)&&u._source.loading,y=!vs(u._source)||p||c.end;if(u.aggregateStore.onTileData(h,c,u._storage,u.attributeStore,y),!y)return;d.mesh||(u.attributeStore.onTileData(h,c),yield u.attributeStore.sendUpdates())}d.mesh||(d.mesh=!0,yield u.processor.onTileMessage(h,c,(0,b.pC)(u.aggregateStore),a),(0,G.k_)(a)),u._maybeForceCleanup()}catch(p){(0,G.H9)(p)}})()}_mark(c,a,u){const h=(4294901760&this._storage.getInstanceId(c))>>>16;c&&(a.add(h),u.set(c))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const c=this._storage.getBitset(this._markedIdsBufId),a=new Set;c.clear();for(const u of this.tileStore.tiles)for(const h of this._source.readers(u.id)){const d=h.getCursor();for(;d.next();){let f=d.getDisplayId();if(!f){const p=d.getObjectId();f=this.featureStore.lookupDisplayId(p)}this._mark(f,a,c)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(u=>{this._mark(u,a,c)}),this._updateQueue.forEach(u=>{for(const h of u.remove){const d=this.featureStore.lookupDisplayId(h);this._mark(d,a,c)}}),(0,b.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(c,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(c,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,ee._)([(0,q.Cb)({constructOnly:!0})],Ke.prototype,"tileStore",void 0),(0,ee._)([(0,q.Cb)()],Ke.prototype,"config",void 0),(0,ee._)([(0,q.Cb)({readOnly:!0})],Ke.prototype,"fieldsIndex",null),(0,ee._)([(0,q.Cb)()],Ke.prototype,"processor",void 0),(0,ee._)([(0,q.Cb)({constructOnly:!0})],Ke.prototype,"remoteClient",void 0),(0,ee._)([(0,q.Cb)({constructOnly:!0})],Ke.prototype,"service",void 0),(0,ee._)([(0,q.Cb)()],Ke.prototype,"spatialReference",null),(0,ee._)([(0,q.Cb)()],Ke.prototype,"updating",null),Ke=(0,ee._)([(0,K.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],Ke);const Fr=Ke;var xs=M(81340),Mr=M(84378),Tr=M(58098);const _t={added:[],removed:[]},Kt=new Set,Ar=new Tr.Z(0,0,0,0);class Er extends Tt.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,es.r)(9,(0,F.Z)("esri-csp-restrictions")?u=>({minX:u.bounds[0],minY:u.bounds[1],maxX:u.bounds[2],maxY:u.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const u={added:[],removed:[]};for(const h of a.added)if(!this.has(h)){const d=new xs.n(this.tileScheme,h);this._tiles.set(h,d),this._index.insert(d),u.added.push(d)}for(const h of a.removed)if(this.has(h)){const d=this.get(h);this._tiles.delete(h),this._index.remove(d),u.removed.push(d)}this.tiles.length=0,this._tiles.forEach(h=>this.tiles.push(h)),(u.added.length||u.removed.length)&&this.emit("update",u)}setViewState(a){const u=this.tileScheme.getTileCoverage(a,0);if(!u)return;const{spans:h,lodInfo:d}=u,{level:f}=d;if(h.length>0)for(const{row:p,colFrom:y,colTo:I}of h)for(let v=y;v<=I;v++){const S=Ar.set(f,p,d.normalizeCol(v),d.getWorldForColumn(v)).id;if(Kt.add(S),!this.has(S)){const T=new xs.n(this.tileScheme,S);this._tiles.set(S,T),this._index.insert(T),this.tiles.push(T),_t.added.push(T)}}for(let p=this.tiles.length-1;p>=0;p--){const y=this.tiles[p];Kt.has(y.id)||(this._tiles.delete(y.id),this.tiles.splice(p,1),this._index.remove(y),_t.removed.push(y))}(_t.added.length||_t.removed.length)&&this.emit("update",_t),Mr.Z.pool.release(u),Kt.clear(),_t.added.length=0,_t.removed.length=0}}var wr=M(9598);let mt=class extends W.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,Z.YP)(()=>this.updating,c=>{this.remoteClient.invoke("setUpdating",c).catch(a=>{})}))}destroy(){var c,a;this.stop(),null==(c=this.controller)||c.destroy(),null==(a=this.processor)||a.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){var c,a,u;this._paused=!0,Array.isArray(null==(c=this.service)?void 0:c.source)&&(this.service.source.forEach(h=>h.close()),this.service.source.length=0),null==(a=this.tileStore)||a.updateTiles({added:[],removed:this.tileStore.tiles.map(h=>h.id)}),null==(u=this.tileStore)||u.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:c,config:a,tileInfo:u,tiles:h}){var d=this;return(0,U.Z)(function*(){var f,p,y;if(d._paused=!0,Array.isArray(null==(f=d.service)?void 0:f.source)&&(d.service.source.forEach(I=>I.close()),d.service.source.length=0),d.service=c,!d.tileStore||!(0,se.fS)(d.tileStore.tileScheme.spatialReference,u.spatialReference)){const I=new wr.Z(Y.Z.fromJSON(u));h.added.length=h.removed.length=0,null==(p=d.tileStore)||p.updateTiles({added:[],removed:d.tileStore.tiles.map(v=>v.id)}),null==(y=d.tileStore)||y.destroy(),d.tileStore=new Er(I),d._pendingTileUpdates.length=0}for(yield d._createProcessorAndController(a),yield d.update({config:a}),d.controller.resume(),d.tileStore.clear(),d.tileStore.updateTiles(h),d._paused=!1;d._pendingTileUpdates.length;)d.tileStore.updateTiles(d._pendingTileUpdates.pop())})()}updateTiles(c){var a=this;return(0,U.Z)(function*(){a._paused?a._pendingTileUpdates.push(c):a.tileStore.updateTiles(c)})()}update({config:c}){var a=this;return(0,U.Z)(function*(){const u=Te.empty();return yield Promise.all([a.processor.update(u,c),a.controller.update(u,c)]),u.toJSON()})()}applyUpdate(c){var a=this;return(0,U.Z)(function*(){return a.controller.applyUpdate(Te.create(c))})()}_createProcessorAndController(c){var a=this;return(0,U.Z)(function*(){yield Promise.all([a._handleControllerConfig(c),a._handleProcessorConfig(c)]),a.controller.processor=a.processor})()}_handleControllerConfig(c){var a=this;return(0,U.Z)(function*(){return a._createController(a.service,c)})()}_handleProcessorConfig(c){var a=this;return(0,U.Z)(function*(){return a._createProcessor(a.service,c)})()}_createController(c,a){var u=this;return(0,U.Z)(function*(){u.controller&&u.controller.destroy();const{tileStore:h,remoteClient:d}=u,f=new Fr({service:c,tileStore:h,remoteClient:d});return u.controller=f,f})()}_createProcessor(c,a){var u=this;return(0,U.Z)(function*(){const h=a.schema.processors[0].type,d=(yield function J(c){return"heatmap"===c?Promise.all([M.e(8592),M.e(7434)]).then(M.bind(M,67434)):Promise.all([M.e(3751),M.e(4654),M.e(3141),M.e(4522),M.e(8592),M.e(8460)]).then(M.bind(M,28460))}(h)).default,{remoteClient:f,tileStore:p}=u,y=new d({service:c,config:a,tileStore:p,remoteClient:f});return u.processor&&u.processor.destroy(),u.processor=y,y})()}};(0,ee._)([(0,q.Cb)()],mt.prototype,"controller",void 0),(0,ee._)([(0,q.Cb)()],mt.prototype,"processor",void 0),(0,ee._)([(0,q.Cb)()],mt.prototype,"updating",null),(0,ee._)([(0,q.Cb)()],mt.prototype,"viewState",void 0),mt=(0,ee._)([(0,K.j)("esri.views.2d.layers.features.Pipeline")],mt);const Rr=mt},16669:(Se,he,M)=>{M.d(he,{J:()=>K});var U=M(15861),ee=M(8314),W=M(62208),F=M(84682),Z=M(46679),q=M(63290);const N=Promise.resolve().then(M.bind(M,22445));class K{constructor(Y,J){this._canCacheExpressionValue=!1,this._sourceInfo=Y,this._storage=J,this._bitsets={computed:J.getBitset(J.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema(Y,J){var b=this;return(0,U.Z)(function*(){const G=(0,F.Hg)(b._schema,J);if(b._schema=J,!J||(0,W.Wi)(G)||!(0,F.uD)(G,"attributes"))return;(0,ee.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",G),b._bitsets.computed.clear(),Y.targets[J.name]=!0;const w=J.attributes,L=[],_=[];for(const m in w){const x=w[m];switch(x.type){case"field":break;case"expression":L.push(b._createArcadeComputedField(x));break;case"label-expression":L.push(b._createLabelArcadeComputedField(x));break;case"statistic":_.push(x)}}b._computedFields=yield Promise.all(L),b._canCacheExpressionValue=!b._computedFields.some(m=>"expression"===m.type&&m.expression.referencesScale()),b._statisticFields=_})()}setComputedAttributes(Y,J,b,G){const w=this._bitsets.computed;if(!this._canCacheExpressionValue||!w.has(b)){w.set(b);for(const L of this._computedFields){const _=this._evaluateField(J,L,G);switch(L.resultType){case"numeric":Y.setComputedNumericAtIndex(b,L.fieldIndex,_);break;case"string":Y.setComputedStringAtIndex(b,L.fieldIndex,_)}}}}_createArcadeComputedField(Y){var J=this;return(0,U.Z)(function*(){const b=J._sourceInfo.spatialReference,G=J._sourceInfo.fieldsIndex;return Re(Ie({},Y),{expression:yield(0,Z.Yi)(Y.valueExpression,b,G)})})()}_createLabelArcadeComputedField(Y){var J=this;return(0,U.Z)(function*(){const b=J._sourceInfo.spatialReference,G=J._sourceInfo.fieldsIndex,{createLabelFunction:w}=yield N,L=yield w(Y.label,G,b);return Re(Ie({},Y),{builder:L})})()}_evaluateField(Y,J,b){switch(J.type){case"label-expression":{const G=Y.readArcadeFeature();return J.builder.evaluate(G)||""}case"expression":{const{expression:G}=J;return function ue(se,Y,J){se.referencesGeometry();const b=Y.readArcadeFeature();try{return se.evaluate(Re(Ie({},J),{$feature:b}))}catch(G){return q.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",G),null}}(G,Y,{$view:{scale:b}})}}}}},25208:(Se,he,M)=>{var z,R,Q;M.d(he,{s:()=>A}),M(29132);var ee=M(8314),W=M(62208),F=M(77044),Z=M(82054),q=M(88071),ue=M(42797),N=M(91179);let K=0;const se=null!=(z=(0,ee.Z)("featurelayer-simplify-thresholds"))?z:[.5,.5,.5,.5],Y=se[0],J=se[1],b=se[2],G=se[3],w=null!=(R=(0,ee.Z)("featurelayer-simplify-payload-size-factors"))?R:[1,2,4],L=w[0],_=w[1],m=w[2],x=null!=(Q=(0,ee.Z)("featurelayer-simplify-mobile-factor"))?Q:2,C=(0,ee.Z)("esri-mobile");class A{constructor(E,k){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=E,this._layerSchema=k}static createInstance(){return K++,K=K>65535?0:K,K}get isEmpty(){return(0,W.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(E){this._level=E}getAreaSimplificationThreshold(E,k){let te=1;const de=C?x:1;k>4e6?te=m*de:k>1e6?te=_*de:k>5e5?te=L*de:k>1e5&&(te=de);let oe=0;E>4e3?oe=G*te:E>2e3?oe=b*te:E>100?oe=J:E>15&&(oe=Y);let D=8;return this._level<4?D=1:this._level<5?D=2:this._level<6&&(D=4),oe*D}setArcadeSpatialReference(E){this._arcadeSpatialReference=E}attachStorage(E){this._storage=E}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(E){return this.getComputedNumericAtIndex(0)}setComputedNumeric(E,k){return this.setComputedNumericAtIndex(k,0)}getComputedString(E){return this.getComputedStringAtIndex(0)}setComputedString(E,k){return this.setComputedStringAtIndex(0,k)}getComputedNumericAtIndex(E){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),E)}setComputedNumericAtIndex(E,k){this._storage.setComputedNumericAtIndex(this.getDisplayId(),E,k)}getComputedStringAtIndex(E){return this._storage.getComputedStringAtIndex(this.getDisplayId(),E)}setComputedStringAtIndex(E,k){return this._storage.setComputedStringAtIndex(this.getDisplayId(),E,k)}transform(E,k,te,de){const oe=this.copy();return oe._tx+=E,oe._ty+=k,oe._sx*=te,oe._sy*=de,oe}readAttribute(E,k=!1){const te=this._readAttribute(E,k);if(void 0!==te)return te;for(const de of this._joined){de.setIndex(this.getIndex());const oe=de._readAttribute(E,k);if(void 0!==oe)return oe}}readAttributes(){const E=this._readAttributes();for(const k of this._joined){k.setIndex(this.getIndex());const te=k._readAttributes();for(const de of Object.keys(te))E[de]=te[de]}return E}joinAttributes(E){this._joined.push(E)}readArcadeFeature(){return this}geometry(){const E=this.readHydratedGeometry(),k=(0,Z.di)(E,this.geometryType,this.hasZ,this.hasM),te=(0,N.im)(k);return te&&(te.spatialReference=this._arcadeSpatialReference),te}field(E){if(this.hasField(E))return this.readAttribute(E,!0);for(const k of this._joined)if(k.setIndex(this.getIndex()),k.hasField(E))return k._readAttribute(E,!0);throw new Error(`Field ${E} does not exist`)}setField(E,k){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(){return JSON.stringify(this.readLegacyFeature())}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(E=null){return{attributes:this._readAttributes(),geometry:!0===(null==E?void 0:E.keepGeometryType)?this.geometry():this.geometry().toJSON()}}castAsJsonAsync(E=null,k=null){return Promise.resolve(this.castAsJson(k))}removeIds(E){if((0,W.Wi)(this._objectIdToIndex)){const te=new Map,de=this.getCursor();for(;de.next();)te.set(de.getObjectId(),de.getIndex());this._objectIdToIndex=te}const k=this._objectIdToIndex;for(const te of E)k.has(te)&&this.removeAtIndex(k.get(te))}removeAtIndex(E){(0,W.Wi)(this._deleted)&&(this._deleted=ue.p.create(this.getSize())),this._deleted.set(E)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const E=this.getCursor();for(;E.next();)yield E.readOptimizedFeature()}_getExists(){return(0,W.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const E=this.readUnquantizedGeometry();if(!E||E.hasIndeterminateRingOrder)return null;const k=(0,W.Pt)(this.getQuantizationTransform(),null);return(0,F.Y)(new q.Z,E,this.hasM,this.hasZ,k)}copyInto(E){E.seen=this.seen,E._storage=this._storage,E._arcadeSpatialReference=this._arcadeSpatialReference,E._joined=this._joined,E._tx=this._tx,E._ty=this._ty,E._sx=this._sx,E._sy=this._sy,E._deleted=this._deleted,E._objectIdToIndex=this._objectIdToIndex}}},52397:(Se,he,M)=>{M.d(he,{t:()=>ee});var U=M(25208);class ee extends U.s{constructor(F,Z){super(U.s.createInstance(),F.fullSchema()),this._currentIndex=-1,this._reader=F,this._indices=Z}static from(F,Z){return new ee(F.copy(),Z)}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const F=new ee(this._reader.copy(),this._indices);return F._currentIndex=this._currentIndex,F}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(F){this._reader.setArcadeSpatialReference(F)}attachStorage(F){this._reader.attachStorage(F)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(F){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(F,Z){return this._reader.setComputedNumericAtIndex(Z,0)}getComputedString(F){return this._reader.getComputedStringAtIndex(0)}setComputedString(F,Z){return this._reader.setComputedStringAtIndex(0,Z)}getComputedNumericAtIndex(F){return this._reader.getComputedNumericAtIndex(F)}setComputedNumericAtIndex(F,Z){this._reader.setComputedNumericAtIndex(F,Z)}getComputedStringAtIndex(F){return this._reader.getComputedStringAtIndex(F)}setComputedStringAtIndex(F,Z){return this._reader.setComputedStringAtIndex(F,Z)}transform(F,Z,q,ue){const N=this.copy();return N._reader=this._reader.transform(F,Z,q,ue),N}readAttribute(F,Z=!1){return this._reader.readAttribute(F,Z)}readAttributes(){return this._reader.readAttributes()}joinAttributes(F){return this._reader.joinAttributes(F)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(F){return this.readAttribute(F,!0)}hasField(F){return this._reader.hasField(F)}setField(F,Z){return this._reader.setField(F,Z)}keys(){return this._reader.keys()}castToText(){return this._reader.castToText()}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(F){return this._reader.setDisplayId(F)}getGroupId(){return this._reader.getGroupId()}setGroupId(F){return this._reader.setGroupId(F)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(F){return this._reader.setIndex(F)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(F,Z){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(Se,he,M)=>{M.d(he,{p:()=>U});class U{constructor(W,F){this._mask=0,this._buf=W,this._mask=F}static fromBuffer(W,F){return new U(W,F)}static create(W,F=4294967295){const Z=new Uint32Array(Math.ceil(W/32));return new U(Z,F)}_getIndex(W){return Math.floor(W/32)}has(W){const F=this._mask&W;return!!(this._buf[this._getIndex(F)]&1<<F%32)}hasRange(W,F){let Z=W,q=F;for(;Z%32&&Z!==q;){if(this.has(Z))return!0;Z++}for(;q%32&&Z!==q;){if(this.has(Z))return!0;q--}if(Z===q)return!1;for(let ue=Z/32;ue!==q/32;ue++)if(this._buf[ue])return!0;return!1}set(W){const F=this._mask&W,Z=this._getIndex(F);this._buf[Z]|=1<<F%32}setRange(W,F){let Z=W,q=F;for(;Z%32&&Z!==q;)this.set(Z++);for(;q%32&&Z!==q;)this.set(q--);if(Z!==q)for(let ue=Z/32;ue!==q/32;ue++)this._buf[ue]=4294967295}unset(W){const F=this._mask&W,Z=this._getIndex(F);this._buf[Z]&=4294967295^1<<F%32}resize(W){const F=this._buf,Z=new Uint32Array(Math.ceil(W/32));Z.set(F),this._buf=Z}or(W){for(let F=0;F<this._buf.length;F++)this._buf[F]|=W._buf[F];return this}and(W){for(let F=0;F<this._buf.length;F++)this._buf[F]&=W._buf[F];return this}xor(W){for(let F=0;F<this._buf.length;F++)this._buf[F]^=W._buf[F];return this}ior(W){for(let F=0;F<this._buf.length;F++)this._buf[F]|=~W._buf[F];return this}iand(W){for(let F=0;F<this._buf.length;F++)this._buf[F]&=~W._buf[F];return this}ixor(W){for(let F=0;F<this._buf.length;F++)this._buf[F]^=~W._buf[F];return this}any(){for(let W=0;W<this._buf.length;W++)if(this._buf[W])return!0;return!1}copy(W){for(let F=0;F<this._buf.length;F++)this._buf[F]=W._buf[F];return this}clone(){return new U(this._buf.slice(),this._mask)}clear(){for(let W=0;W<this._buf.length;W++)this._buf[W]=0}forEachSet(W){for(let F=0;F<this._buf.length;F++){let Z=this._buf[F],q=32*F;if(Z)for(;Z;)1&Z&&W(q),Z>>>=1,q++}}countSet(){let W=0;return this.forEachSet(F=>{W++}),W}}},81340:(Se,he,M)=>{M.d(he,{n:()=>q});var U=M(35575),ee=M(2004),W=M(65401),F=M(89621),Z=M(58098);class q{constructor(N,K){this.key=new Z.Z(0,0,0,0),this.bounds=(0,W.Ue)(),this.objectIds=new Set,this.key.set(K);const se=N.getLODInfoAt(this.key);this.tileInfoView=N,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=se.resolution,this.scale=se.scale,this.level=se.level}get id(){return this.key.id}get extent(){return ee.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const N=this.key.getChildKeys(),K=U.Z.acquire();for(let se=0;se<N.length;se++)K[se]=new q(this.tileInfoView,N[se]);return K}getQuantizationParameters(){return F.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}},84378:(Se,he,M)=>{M.d(he,{Z:()=>ee});var U=M(27899);class ee{constructor(){this.spans=[]}acquire(F){this.lodInfo=F}release(){this.lodInfo=null,this.spans.length=0}forEach(F,Z){const{spans:q,lodInfo:ue}=this,{level:N}=ue;if(0!==q.length)for(const{row:K,colFrom:se,colTo:Y}of q)for(let J=se;J<=Y;J++)F.call(Z,N,K,ue.normalizeCol(J),ue.getWorldForColumn(J))}}ee.pool=new U.Z(ee)},9598:(Se,he,M)=>{M.d(he,{Z:()=>w});var U=M(37053),ee=M(62208),W=M(58098);function F(L,_){return[L,_]}function Z(L,_,m){return L[0]=_,L[1]=m,L}const ue=new W.Z("0/0/0/0");class N{constructor(_,m,x,C,A,z,R,Q,H,E,k,te){this.level=_,this.resolution=m,this.scale=x,this.origin=C,this.first=A,this.last=z,this.size=R,this.norm=Q,this.worldStart=H,this.worldEnd=E,this.worldSize=k,this.wrap=te}static create(_,m,x=null){const C=(0,U.C5)(_.spatialReference),A=m.origin||F(_.origin.x,_.origin.y),z=F(_.size[0]*m.resolution,_.size[1]*m.resolution),R=F(-1/0,-1/0),Q=F(1/0,1/0),H=F(1/0,1/0);(0,ee.pC)(x)&&(Z(R,Math.max(0,Math.floor((x.xmin-A[0])/z[0])),Math.max(0,Math.floor((A[1]-x.ymax)/z[1]))),Z(Q,Math.max(0,Math.floor((x.xmax-A[0])/z[0])),Math.max(0,Math.floor((A[1]-x.ymin)/z[1]))),Z(H,Q[0]-R[0]+1,Q[1]-R[1]+1));const{cols:E,rows:k}=m;let te,de,oe,D;return!x&&E&&k&&(Z(R,E[0],k[0]),Z(Q,E[1],k[1]),Z(H,E[1]-E[0]+1,k[1]-k[0]+1)),_.isWrappable?(te=F(Math.ceil(Math.round((C.valid[1]-C.valid[0])/m.resolution)/_.size[0]),H[1]),de=F(Math.floor((C.origin[0]-A[0])/z[0]),R[1]),oe=F(te[0]+de[0]-1,Q[1]),D=!0):(de=R,oe=Q,te=H,D=!1),new N(m.level,m.resolution,m.scale,A,R,Q,H,z,de,oe,te,D)}normalizeCol(_){if(!this.wrap)return _;const m=this.worldSize[0];return _<0?m-1-Math.abs((_+1)%m):_%m}denormalizeCol(_,m){return this.wrap?this.worldSize[0]*m+_:_}getWorldForColumn(_){return this.wrap?Math.floor(_/this.worldSize[0]):0}getFirstColumnForWorld(_){return _*this.worldSize[0]+this.first[0]}getLastColumnForWorld(_){return _*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(_){return(_-this.origin[0])/this.norm[0]}getXForColumn(_){return this.origin[0]+_*this.norm[0]}getRowForY(_){return(this.origin[1]-_)/this.norm[1]}getYForRow(_){return this.origin[1]-_*this.norm[1]}getTileBounds(_,m,x=!1){ue.set(m);const C=x?ue.col:this.denormalizeCol(ue.col,ue.world),A=ue.row;return function q(L,_,m,x,C){L[0]=_,L[1]=m,L[2]=x,L[3]=C}(_,this.getXForColumn(C),this.getYForRow(A+1),this.getXForColumn(C+1),this.getYForRow(A)),_}getTileCoords(_,m,x=!1){ue.set(m);const C=x?ue.col:this.denormalizeCol(ue.col,ue.world);return Array.isArray(_)?Z(_,this.getXForColumn(C),this.getYForRow(ue.row)):(_.x=this.getXForColumn(C),_.y=this.getYForRow(ue.row)),_}}var K=M(84378);class se{constructor(_,m,x){this.row=_,this.colFrom=m,this.colTo=x}}const Y=new W.Z("0/0/0/0");class J{constructor(_,m,x,C,A,z,R,Q){this.x=_,this.ymin=m,this.ymax=x,this.invM=C,this.leftAdjust=A,this.rightAdjust=z,this.leftBound=R,this.rightBound=Q}static create(_,m){_[1]>m[1]&&([_,m]=[m,_]);const[x,C]=_,[A,z]=m,R=A-x,Q=z-C,H=0!==Q?R/Q:0,E=(Math.ceil(C)-C)*H,k=(Math.floor(C)-C)*H;return new J(x,Math.floor(C),Math.ceil(z),H,R<0?E:k,R<0?k:E,R<0?A:x,R<0?x:A)}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const b=[[0,0],[0,0],[0,0],[0,0]];class w{constructor(_,m=null){this.tileInfo=_,this.fullExtent=m,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const x=_.lods.slice();x.sort((A,z)=>z.scale-A.scale);const C=this._lodInfos=x.map(A=>N.create(_,A,m));x.forEach((A,z)=>{this._infoByLevel[A.level]=C[z],this._infoByScale[A.scale]=C[z],this.scales[z]=A.scale},this),this._wrap=_.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(_){return this._infoByLevel["number"==typeof _?_:_.level]}getTileBounds(_,m,x=!1){Y.set(m);const C=this._infoByLevel[Y.level];return C?C.getTileBounds(_,Y,x):_}getTileCoords(_,m,x=!1){Y.set(m);const C=this._infoByLevel[Y.level];return C?C.getTileCoords(_,Y,x):_}getTileCoverage(_,m=192,x="closest"){const C="closest"===x?this.getClosestInfoForScale(_.scale):this.getSmallestInfoForScale(_.scale),A=K.Z.pool.acquire(C),z=this._wrap;let R,Q,H,E=1/0,k=-1/0;const te=A.spans;b[0][0]=b[0][1]=b[1][1]=b[3][0]=-m,b[1][0]=b[2][0]=_.size[0]+m,b[2][1]=b[3][1]=_.size[1]+m;for(const P of b)_.toMap(P,P),P[0]=C.getColumnForX(P[0]),P[1]=C.getRowForY(P[1]);const de=[];let oe=3;for(let P=0;P<4;P++){if(b[P][1]===b[oe][1]){oe=P;continue}const X=J.create(b[P],b[oe]);E=Math.min(X.ymin,E),k=Math.max(X.ymax,k),void 0===de[X.ymin]&&(de[X.ymin]=[]),de[X.ymin].push(X),oe=P}if(null==E||null==k||k-E>100)return null;let D=[];for(R=E;R<k;){null!=de[R]&&(D=D.concat(de[R])),Q=1/0,H=-1/0;for(let P=D.length-1;P>=0;P--){const X=D[P];Q=Math.min(Q,X.getLeftCol()),H=Math.max(H,X.getRightCol())}if(Q=Math.floor(Q),H=Math.floor(H),R>=C.first[1]&&R<=C.last[1])if(z)if(C.size[0]<C.worldSize[0]){const P=Math.floor(H/C.worldSize[0]);for(let X=Math.floor(Q/C.worldSize[0]);X<=P;X++)te.push(new se(R,Math.max(C.getFirstColumnForWorld(X),Q),Math.min(C.getLastColumnForWorld(X),H)))}else te.push(new se(R,Q,H));else Q>C.last[0]||H<C.first[0]||(Q=Math.max(Q,C.first[0]),H=Math.min(H,C.last[0]),te.push(new se(R,Q,H)));R+=1;for(let P=D.length-1;P>=0;P--){const X=D[P];X.ymax>=R?X.incrRow():D.splice(P,1)}}return A}getTileParentId(_){Y.set(_);const x=this._lodInfos.indexOf(this._infoByLevel[Y.level])-1;return x<0?null:(this._getTileIdAtLOD(Y,this._lodInfos[x],Y),Y.id)}getTileResolution(_){const m=this._infoByLevel["object"==typeof _?_.level:_];return m?m.resolution:-1}getTileScale(_){const m=this._infoByLevel[_.level];return m?m.scale:-1}intersects(_,m){Y.set(m);const x=this._infoByLevel[Y.level],C=_.lodInfo;if(C.resolution>x.resolution){this._getTileIdAtLOD(Y,C,Y);const z=C.denormalizeCol(Y.col,Y.world);for(const R of _.spans)if(R.row===Y.row&&R.colFrom<=z&&R.colTo>=z)return!0}if(C.resolution<x.resolution){const[z,R,Q,H]=_.spans.reduce((D,P)=>(D[0]=Math.min(D[0],P.row),D[1]=Math.max(D[1],P.row),D[2]=Math.min(D[2],P.colFrom),D[3]=Math.max(D[3],P.colTo),D),[1/0,-1/0,1/0,-1/0]),E=x.denormalizeCol(Y.col,Y.world),k=C.getColumnForX(x.getXForColumn(E)),te=C.getRowForY(x.getYForRow(Y.row)),de=C.getColumnForX(x.getXForColumn(E+1))-1,oe=C.getRowForY(x.getYForRow(Y.row+1))-1;return!(k>H||de<Q||te>R||oe<z)}const A=C.denormalizeCol(Y.col,Y.world);return _.spans.some(z=>z.row===Y.row&&z.colFrom<=A&&z.colTo>=A)}normalizeBounds(_,m,x){if(_[0]=m[0],_[1]=m[1],_[2]=m[2],_[3]=m[3],this._wrap){const C=(0,U.C5)(this.tileInfo.spatialReference),A=-x*(C.valid[1]-C.valid[0]);_[0]+=A,_[2]+=A}return _}getSmallestInfoForScale(_){const m=this.scales;if(this._infoByScale[_])return this._infoByScale[_];if(_>m[0])return this._infoByScale[m[0]];for(let x=1;x<m.length-1;x++)if(_>m[x]+1e-6)return this._infoByScale[m[x-1]];return this._infoByScale[m[m.length-1]]}getClosestInfoForScale(_){const m=this.scales;return this._infoByScale[_]||(_=m.reduce((x,C)=>Math.abs(C-_)<Math.abs(x-_)?C:x,m[0])),this._infoByScale[_]}scaleToLevel(_){const m=this.scales;if(this._infoByScale[_])return this._infoByScale[_].level;for(let x=m.length-1;x>=0;x--)if(_<m[x])return x===m.length-1?this._infoByScale[m[m.length-1]].level:this._infoByScale[m[x]].level+(m[x]-_)/(m[x]-m[x+1]);return this._infoByScale[m[0]].level}scaleToZoom(_){return this.tileInfo.scaleToZoom(_)}_getTileIdAtLOD(_,m,x){const C=this._infoByLevel[x.level];return _.set(x),m.resolution<C.resolution?null:(m.resolution===C.resolution||(_.level=m.level,_.col=Math.floor(x.col*C.resolution/m.resolution+.01),_.row=Math.floor(x.row*C.resolution/m.resolution+.01)),_)}}},71251:(Se,he,M)=>{M.d(he,{e:()=>q});var U=M(62208),ee=M(10699),W=M(35133),F=M(50618);class Z{constructor(N,K){this.item=N,this.controller=K,this.promise=null}}class q{constructor(N){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,N.concurrency&&(this.concurrency=N.concurrency),this._queue=new W.Z(N.peeker),this.process=N.process;const K=N.scheduler;N.priority&&(0,U.pC)(K)&&(this._task=K.registerTask(N.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(N){const K=this._controllers.get(N);K&&K.abort()}clear(){this._queue.clear();const N=[];this._controllers.forEach(K=>N.push(K)),this._controllers.clear(),N.forEach(K=>K.abort()),this._processingItems.clear(),this._cancelNext()}forEach(N){this._deferreds.forEach((K,se)=>N(se))}get(N){const K=this._deferreds.get(N);return K?K.promise:void 0}isOngoing(N){return this._processingItems.has(N)}has(N){return this._deferreds.has(N)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(N,K){const se=this.get(N);if(se)return se;const Y=new AbortController;let J=null;K&&(J=(0,ee.fu)(K,()=>Y.abort()));const G=()=>{w.remove(),(0,U.pC)(J)&&J.remove(),this._deferreds.delete(N),this._controllers.delete(N),this._queue.remove(N),this._processingItems.delete(N),this._scheduleNext()},w=(0,ee.$F)(Y.signal,()=>{const _=this._processingItems.get(N);_&&_.controller.abort(),G(),L.reject((0,ee.zE)())}),L=(0,ee.dD)();return this._deferreds.set(N,L),this._controllers.set(N,Y),L.promise.then(G,G),this._queue.push(N),this._scheduleNext(),L.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const N=[];this._processingItems.forEach(K=>N.push(K)),this._processingItems.clear();for(const K of N)this._queue.push(K.item),K.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const N=[];for(;this._queue.length;)N.push(this._queue.pop());return this.clear(),N}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(N){for(;!N.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),N.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,F.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(N,K){this._canProcessFulfillment(N)&&(this._scheduleNext(),this._deferreds.get(N.item).resolve(K))}_processError(N,K){this._canProcessFulfillment(N)&&(this._scheduleNext(),this._deferreds.get(N.item).reject(K))}_canProcessFulfillment(N){return!!this._deferreds.get(N.item)&&this._processingItems.get(N.item)===N}_process(N){if((0,U.Wi)(N))return;let K;const se=new AbortController,Y=new Z(N,se);this._processingItems.set(N,Y);try{K=this.process(N,se.signal)}catch(J){this._processError(Y,J)}(0,ee.y8)(K)?(Y.promise=K,K.then(J=>this._processResult(Y,J),J=>this._processError(Y,J))):this._processResult(Y,K)}get test(){return{update:N=>this.runTask(N)}}}}}]);
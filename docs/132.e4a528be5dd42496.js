"use strict";var $=Object.defineProperty,N=Object.getOwnPropertySymbols,K=Object.prototype.hasOwnProperty,q=Object.prototype.propertyIsEnumerable,U=(I,p,o)=>p in I?$(I,p,{enumerable:!0,configurable:!0,writable:!0,value:o}):I[p]=o,P=(I,p)=>{for(var o in p||(p={}))K.call(p,o)&&U(I,o,p[o]);if(N)for(var o of N(p))q.call(p,o)&&U(I,o,p[o]);return I};(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[132,901],{65389:(I,p,o)=>{o.d(p,{Z:()=>S});var y=o(62208);class S{constructor(v){this.size=0,this._start=0,this.maxSize=v,this._buffer=new Array(v)}get entries(){return this._buffer}enqueue(v){if(this.size===this.maxSize){const c=this._buffer[this._start];return this._buffer[this._start]=v,this._start=(this._start+1)%this.maxSize,c}return this._buffer[(this._start+this.size++)%this.maxSize]=v,null}dequeue(){if(0===this.size)return null;const v=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,v}peek(){return 0===this.size?null:this._buffer[this._start]}find(v){if(0===this.size)return null;for(const c of this._buffer)if((0,y.pC)(c)&&v(c))return c;return null}clear(v){let c=this.dequeue();for(;(0,y.pC)(c);)v&&v(c),c=this.dequeue()}}},5075:(I,p,o)=>{o.d(p,{Qo:()=>f});var y=o(65389),S=o(21286),w=o(62208);const c="__esri_timestamp__";class f{constructor(n,a,u,l,b=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=u,this._purgeOptions=l,this.store=n,this.objectIdField=a,this.purgeInterval=b,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}removeById(n){this._removed.push(n)}removeByTrackId(n){const a=this._trackIdToObservations.get(n);if(a)for(const u of a.entries)this._removed.push(u)}add(n){var b;if(this._useGeneratedIds){const m=this._nextId();n.attributes[this.objectIdField]=m,n.objectId=m}else n.objectId=n.attributes[this.objectIdField];const a=n.objectId;if(this._addOrUpdated.set(a,n),this._maxAge=Math.max(this._maxAge,n.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,w.Wi)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new y.Z(1e5)),void this._trackIdLessObservations.enqueue(a);const u=n.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(u)){const m=(0,w.pC)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,O=(0,S.uZ)(m,0,1e3);this._trackIdToObservations.set(u,new y.Z(O))}const l=null==(b=this._trackIdToObservations.get(u))?void 0:b.enqueue(a);(0,w.pC)(l)&&(this._addOrUpdated.has(l)?this._addOrUpdated.delete(l):this._removed.push(l))}checkForUpdates(){const n=this._getToAdd(),a=this._getToRemove(),u=performance.now();u-this._lastPurge>=this.purgeInterval&&(this._purge(u),this._lastPurge=u);const l=[];if((0,w.pC)(a))for(const m of a){const O=this.store.removeById(m);(0,w.pC)(O)&&l.push(O)}const b=[];if((0,w.pC)(n)){const m=new Set((0,w.Pt)(a,[]));for(const O of n)m.has(O.objectId)||(O.attributes[c]=u,this.store.add(O),b.push(O))}(b.length||(null==l?void 0:l.length))&&this.store.update(b,l)}_getToAdd(){if(!this._addOrUpdated.size)return null;const n=new Array(this._addOrUpdated.size);let a=0;return this._addOrUpdated.forEach(u=>n[a++]=u),this._addOrUpdated.clear(),n}_getToRemove(){const n=this._removed;return this._removed.length?(this._removed=[],n):null}_nextId(){const n=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,n}_purge(n){const a=this._purgeOptions;(0,w.pC)(a)&&(this._purgeSomeByDisplayCount(a),this._purgeByAge(a),this._purgeByAgeReceived(n,a),this._purgeTracks())}_purgeSomeByDisplayCount(n){if(!n.displayCount)return;let a=this.store.size;if(a>n.displayCount){if(this._timeInfo.trackIdField)for(const u of this._trackIdToObservations.values())if(a>n.displayCount&&u.size){const l=(0,w.Wg)(u.dequeue());this._removed.push(l),a--}if((0,w.pC)(this._trackIdLessObservations)){let u=a-n.displayCount;for(;u-- >0;){const l=this._trackIdLessObservations.dequeue();(0,w.pC)(l)&&this._removed.push(l)}}}}_purgeByAge(n){var b;const a=null==(b=this._timeInfo)?void 0:b.startTimeField;if(!n.age||!a)return;const l=this._maxAge-60*n.age*1e3;this.store.forEach(m=>{m.attributes[a]<l&&this._removed.push(m.objectId)})}_purgeByAgeReceived(n,a){if(!a.ageReceived)return;const u=n-60*a.ageReceived*1e3;this.store.forEach(l=>{l.attributes[c]<u&&this._removed.push(l.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((n,a)=>{0===n.size&&this._trackIdToObservations.delete(a)})}}},20901:(I,p,o)=>{o.r(p),o.d(p,{createConnection:()=>H});var y=o(15861),S=o(17626),v=(o(29132),o(84792)),c=o(26584),h=o(63290),f=o(62208),E=o(10699),n=o(21726),b=(o(90912),o(85931),o(8314),o(76898)),m=o(77712),O=o(33696),A=o(61885);let x=class extends A.Z.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new c.Z("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,S._)([(0,m.Cb)({readOnly:!0})],x.prototype,"connectionError",null),x=(0,S._)([(0,b.j)("esri.layers.support.StreamConnection")],x);const W=x;var F,e;(e=F||(F={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let R=class extends W{constructor(e){super(),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:s}=e;this._config=e,this._featureZScaler=(0,O.k)(t,s,r),this._open()}_open(){var e=this;return(0,y.Z)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){super.destroy(),(0,f.pC)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if((0,f.Wi)(this._websocket))return"disconnected";switch(this._websocket.readyState){case F.CONNECTING:case F.OPEN:return"connected";case F.CLOSING:case F.CLOSED:return"disconnected"}}sendMessageToSocket(e){(0,f.Wi)(this._websocket)?this._outstandingMessages.push(e):this._websocket.send(JSON.stringify(e))}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,(0,f.pC)(this._websocket)&&this._websocket.close()}_tryCreateWebSocket(e=this._config.source.path,t=1e3,r=0){var s=this;return(0,y.Z)(function*(){var i;try{if(s.destroyed)return;const d=(0,n.fl)(e,null!=(i=s._config.customParameters)?i:{});s._websocket=yield s._createWebSocket(d),s.notifyChange("connectionStatus")}catch(d){const g=t/1e3;return s._config.maxReconnectionAttempts&&r>=s._config.maxReconnectionAttempts?(h.Z.getLogger(s.declaredClass).error(new c.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void s.destroy()):(h.Z.getLogger(s.declaredClass).error(new c.Z("websocket-connection",`Failed to connect. Attempting to reconnect in ${g}s`,d)),yield(0,E.e4)(t),s._tryCreateWebSocket(e,Math.min(1.5*t,1e3*s._config.maxReconnectionInterval),r+1))}})()}_setWebSocketJSONParseHandler(e){e.onmessage=t=>{try{const r=JSON.parse(t.data);this._onMessage(r)}catch(r){return void h.Z.getLogger(this.declaredClass).error(new c.Z("websocket-connection","Failed to parse message, invalid JSON",{error:r}))}}}_createWebSocket(e){return new Promise((t,r)=>{const s=new WebSocket(e);s.onopen=()=>{if(s.onopen=null,this.destroyed)return s.onclose=null,void s.close();s.onclose=i=>this._onClose(i),s.onerror=i=>this._onError(i),this._setWebSocketJSONParseHandler(s),t(s)},s.onclose=i=>{s.onopen=s.onclose=null,r(i)}})}_handshake(e=1e4){var t=this;return(0,y.Z)(function*(){const r=t._websocket;if((0,f.Wi)(r))return;const s=(0,E.hh)(),i=r.onmessage,{filter:d,outFields:g,spatialReference:C}=t._config;return s.timeout(e),r.onmessage=k=>{var _;let Z=null;try{Z=JSON.parse(k.data)}catch(L){}Z&&"object"==typeof Z||(h.Z.getLogger(t.declaredClass).error(new c.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",k.data)),s.reject(),t.destroy()),(null==(_=Z.spatialReference)?void 0:_.wkid)!==(null==C?void 0:C.wkid)&&(h.Z.getLogger(t.declaredClass).error(new c.Z("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${C.wkid}`,k.data)),s.reject(),t.destroy()),"json"!==Z.format&&(h.Z.getLogger(t.declaredClass).error(new c.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",k.data)),s.reject(),t.destroy()),d&&Z.filter!==d&&h.Z.getLogger(t.declaredClass).error(new c.Z("websocket-connection","Tried to set filter, but server doesn't support it")),g&&Z.outFields!==g&&h.Z.getLogger(t.declaredClass).error(new c.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=i;for(const L of t._outstandingMessages)r.send(JSON.stringify(L));t._outstandingMessages=[],s.resolve()},r.send(JSON.stringify({filter:d,outFields:g,format:"json",spatialReference:{wkid:C.wkid}})),s.promise})()}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)(0,f.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),h.Z.getLogger(this.declaredClass).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&h.Z.getLogger(this.declaredClass).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,S._)([(0,m.Cb)()],R.prototype,"connectionStatus",null),(0,S._)([(0,m.Cb)()],R.prototype,"errorString",void 0),R=(0,S._)([(0,b.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],R);var M=o(20477),D=o(96854),z=o(91179),B=o(65234);const G={maxQueryDepth:5,maxRecordCountFactor:3};let j=class extends R{constructor(e){super(P(P({},G),e)),this._buddyServicesQuery=null,this._relatedFeatures=null}_open(){var e=this;return(0,y.Z)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||h.Z.getLogger(e.declaredClass).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const r=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(r);const{filter:s,outFields:i}=e._config;e.destroyed||e._setFilter(s,i)})()}_onMessage(e){if("attributes"in e){let t;try{t=this._enrich(e),(0,f.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(r){return void h.Z.getLogger(this.declaredClass).error(new c.Z("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}else this.onMessage(e)}_fetchServiceDefinition(e){var t=this;return(0,y.Z)(function*(){const r=P({f:"json"},t._config.customParameters),s=(0,v.default)(e.path,{query:r,responseType:"json"}),i=(yield s).data;return t._serviceDefinition=i,i})()}_fetchWebSocketUrl(e,t){const r=e[0],{urls:s,token:i}=r,d=this._inferWebSocketBaseUrl(s);return(0,n.fl)(`${d}/subscribe`,{outSR:""+t.wkid,token:i})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return h.Z.getLogger(this.declaredClass).error(new c.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var r=this;return(0,y.Z)(function*(){const s=r._websocket;if((0,f.Wi)(s)||(0,f.Wi)(e)&&(0,f.Wi)(t))return;const i=JSON.stringify({filter:r._serializeFilter(e,t)});let d=!1;const g=(0,E.hh)();return s.onmessage=Z=>{const _=JSON.parse(Z.data);_.filter&&(_.error&&(h.Z.getLogger(r.declaredClass).error(new c.Z("geoevent-connection","Failed to set service filter",_.error)),r._set("errorString",`Could not set service filter - ${_.error}`),g.reject(_.error)),r._setWebSocketJSONParseHandler(s),d=!0,g.resolve())},s.send(i),setTimeout(()=>{d||(r.destroyed||r._websocket!==s||h.Z.getLogger(r.declaredClass).error(new c.Z("geoevent-connection","Server timed out when setting filter")),g.reject())},1e4),g.promise})()}_serializeFilter(e,t){const r={};if((0,f.Wi)(e)&&(0,f.Wi)(t))return r;if((0,f.pC)(e)&&e.geometry)try{const s=(0,z.im)(e.geometry);if("extent"!==s.type)throw new c.Z(`Expected extent but found type ${s.type}`);r.geometry=JSON.stringify(s.shiftCentralMeridian())}catch(s){h.Z.getLogger(this.declaredClass).error(new c.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",s))}return(0,f.pC)(e)&&e.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(r.where=e.where),(0,f.pC)(t)&&(r.outFields=t.join(",")),r}_enrich(e){if(!this._relatedFeatures)return e;const s=this._relatedFeatures.get(e.attributes[this._serviceDefinition.relatedFeatures.joinField]);if(!s)return h.Z.getLogger(this.declaredClass).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:i,geometry:d}=s;for(const g in i)e.attributes[g]=i[g];return d&&(e.geometry=d),e.geometry||e.centroid||h.Z.getLogger(this.declaredClass).error(new c.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,y.Z)(function*(){try{const{relatedFeatures:t,keepLatestArchive:r}=e._serviceDefinition,s=e._queryRelatedFeatures(t),i=e._queryArchive(r);yield s;const d=yield i;if(!d)return;for(const g of d.features)e.onFeature(e._enrich(g))}catch(t){h.Z.getLogger(e.declaredClass).error(new c.Z("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,y.Z)(function*(){if(!e)return;const r=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(r)})()}_queryArchive(e){var t=this;return(0,y.Z)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,y.Z)(function*(){const r=new((yield Promise.resolve().then(o.bind(o,80415))).default)({url:e}),{capabilities:s}=yield r.load(),i=s.query.supportsMaxRecordCountFactor,d=s.query.supportsPagination,g=s.query.supportsCentroid,C=t._config.maxRecordCountFactor,k=r.capabilities.query.maxRecordCount,Z=i?k*C:k,_=new D.Z;if(_.outFields=(0,f.Pt)(t._config.outFields,["*"]),_.where=(0,f.Pt)((0,f.U2)(t._config.filter,"where"),"1=1"),_.returnGeometry=!0,_.returnExceededLimitFeatures=!0,_.outSpatialReference=B.Z.fromJSON(t._config.spatialReference),g&&(_.returnCentroid=!0),i&&(_.maxRecordCountFactor=C),d)return _.num=Z,r.destroy(),t._queryPages(e,_);const L=yield(0,M.JT)(e,_,t._config.sourceSpatialReference);return r.destroy(),L.data})()}_queryPages(e,t,r=[],s=0){var i=this;return(0,y.Z)(function*(){var g;t.start=(0,f.pC)(t.num)?s*t.num:null;const{data:d}=yield(0,M.JT)(e,t,i._config.sourceSpatialReference);return d.exceededTransferLimit&&s<(null!=(g=i._config.maxQueryDepth)?g:0)?(d.features.forEach(C=>r.push(C)),i._queryPages(e,t,r,s+1)):(r.forEach(C=>d.features.push(C)),d)})()}_addRelatedFeatures(e){const t=new Map,r=e.features,s=this._serviceDefinition.relatedFeatures.joinField;for(const i of r)t.set(i.attributes[s],i);this._relatedFeatures=t}};j=(0,S._)([(0,b.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],j);const Q=j;let T=class extends W{constructor(e){super(),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:s}=e;this._featureZScaler=(0,O.k)(t,s,r)}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)(0,f.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function H(e,t,r,s,i,d,g,C){const k={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:s,filter:i,maxReconnectionAttempts:d,maxReconnectionInterval:g,customParameters:C};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new R(k):new Q(k):new T(k)}(0,S._)([(0,m.Cb)()],T.prototype,"connectionStatus",void 0),(0,S._)([(0,m.Cb)()],T.prototype,"errorString",void 0),T=(0,S._)([(0,b.j)("esri.layers.support.ClientSideConnection")],T)}}]);
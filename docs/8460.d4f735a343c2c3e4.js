"use strict";var Us=Object.defineProperty,Os=Object.defineProperties,Ds=Object.getOwnPropertyDescriptors,or=Object.getOwnPropertySymbols,Zs=Object.prototype.hasOwnProperty,Gs=Object.prototype.propertyIsEnumerable,ar=(ae,N,L)=>N in ae?Us(ae,N,{enumerable:!0,configurable:!0,writable:!0,value:L}):ae[N]=L,se=(ae,N)=>{for(var L in N||(N={}))Zs.call(N,L)&&ar(ae,L,N[L]);if(or)for(var L of or(N))Gs.call(N,L)&&ar(ae,L,N[L]);return ae},de=(ae,N)=>Os(ae,Ds(N));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[8460],{18716:(ae,N,L)=>{L.d(N,{CA:()=>gi,Gq:()=>we,Xp:()=>fe,a:()=>Ke,dk:()=>Q,hF:()=>_t,jj:()=>xi,jy:()=>Ze,m2:()=>le,mE:()=>Ge,qr:()=>Ne});var B=L(26584),J=L(40028),E=L(39406);const De=Object.keys(E.mD).filter(R=>"number"==typeof E.mD[R]).reduce((R,S)=>de(se({},R),{[S]:E.mD[S]}),{});function Ze(R){return R===E.mD.OUTLINE_FILL||R===E.mD.OUTLINE_FILL_SIMPLE}function fe(R){return function Ie(R){return R===E.mD.SIMPLE||R===E.mD.OUTLINE_FILL_SIMPLE}(R.symbologyType)}function gi(R){return Ze(R.symbologyType)}function xi(R,S){switch(R){case E.LW.FILL:return Q.from(S);case E.LW.LINE:return Ke.from(S);case E.LW.MARKER:return Ge.from(S);case E.LW.TEXT:return Ne.from(S);case E.LW.LABEL:return we.from(S);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${R}`)}}function _t(R){switch(le.load(R).geometryType){case E.LW.MARKER:return new Ge(R);case E.LW.FILL:return new Q(R);case E.LW.LINE:return new Ke(R);case E.LW.TEXT:return new Ne(R);case E.LW.LABEL:return new we(R)}}class le{static load(S){const I=this.shared;return I.data=S,I}constructor(S){this._data=0,this._data=S}set data(S){this._data=null!=S?S:0}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(S){this.setBits(S,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(S){this.setBit(20,S)}get sdf(){return!!this.bit(11)}set sdf(S){this.setBit(11,null!=S&&S)}get pattern(){return!!this.bit(12)}set pattern(S){this.setBit(12,S)}get textureBinding(){return this.bits(0,8)}set textureBinding(S){this.setBits(S,0,8)}get symbologyType(){return this.bits(21,26)}set symbologyType(S){this.setBits(S,21,26)}get geometryTypeString(){switch(this.geometryType){case E.LW.FILL:return"fill";case E.LW.MARKER:return"marker";case E.LW.LINE:return"line";case E.LW.TEXT:return"text";case E.LW.LABEL:return"label";default:throw new B.Z(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(S,I){const D=1<<S;I?this._data|=D:this._data&=~D}bit(S){return(this._data&1<<S)>>S}setBits(S,I,D){for(let Z=I,Je=0;Z<D;Z++,Je++)this.setBit(Z,0!=(S&1<<Je))}bits(S,I){let D=0;for(let Z=S,Je=0;Z<I;Z++,Je++)D|=this.bit(Z)<<Je;return D}hasVV(){return!1}setVV(S,I){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf,symbologyType:{value:E.mD[this.symbologyType],options:De,namespace:"SYMBOLOGY_TYPE"}}}getVariationHash(){return this._data&~(7&this.textureBinding)}}le.shared=new le(0);const ve=R=>class extends R{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(S){this.setBit(16,S)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(S){this.setBit(17,S)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(S){this.setBit(18,S)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(S){this.setBit(19,S)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(S,I){super.setVV(S,I);const D=function ge(R,S,I){const D=E.X.SIZE_FIELD_STOPS|E.X.SIZE_MINMAX_VALUE|E.X.SIZE_SCALE_STOPS|E.X.SIZE_UNIT_VALUE,Z=(S&(E.mf.FIELD_TARGETS_OUTLINE|E.mf.MINMAX_TARGETS_OUTLINE|E.mf.SCALE_TARGETS_OUTLINE|E.mf.UNIT_TARGETS_OUTLINE))>>>4;return R===E.LW.LINE&&I.isOutline||R===E.LW.FILL&&Ze(I.symbologyType)?D&Z:D&~Z}(this.geometryType,S,I)&S;this.vvSizeMinMaxValue=!!(D&E.X.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(D&E.X.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(D&E.X.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(D&E.X.SIZE_SCALE_STOPS)}},Pe=R=>class extends R{get vvRotation(){return 0!==this.bit(15)}set vvRotation(S){this.setBit(15,S)}hasVV(){return super.hasVV()||this.vvRotation}setVV(S,I){super.setVV(S,I),this.vvRotation=!I.isOutline&&!!(S&E.X.ROTATION)}},he=R=>class extends R{get vvColor(){return 0!==this.bit(13)}set vvColor(S){this.setBit(13,S)}hasVV(){return super.hasVV()||this.vvColor}setVV(S,I){super.setVV(S,I),this.vvColor=!I.isOutline&&!!(S&E.X.COLOR)}},Ee=R=>class extends R{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(S){this.setBit(14,S)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(S,I){super.setVV(S,I),this.vvOpacity=!I.isOutline&&!!(S&E.X.OPACITY)}};class Q extends(he(Ee(ve(le)))){static load(S){const I=this.shared;return I.data=S,I}static from(S){const{symbologyType:I,vvFlags:D}=S,Z=this.load(0);return Z.geometryType=E.LW.FILL,Z.symbologyType=I,I!==E.mD.DOT_DENSITY&&Z.setVV(D,S),Z.data}getVariation(){return de(se({},super.getVariation()),{vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}Q.shared=new Q(0);class Ge extends(he(Ee(Pe(ve(le))))){static load(S){const I=this.shared;return I.data=S,I}static from(S){const{symbologyType:I,vvFlags:D}=S,Z=this.load(0);return Z.geometryType=E.LW.MARKER,Z.symbologyType=I,I!==E.mD.HEATMAP&&Z.setVV(D,S),Z.data}getVariation(){return de(se({},super.getVariation()),{vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}Ge.shared=new Ge(0);class Ke extends(he(Ee(ve(le)))){static load(S){const I=this.shared;return I.data=S,I}static from(S){const I=this.load(0);return I.geometryType=E.LW.LINE,I.symbologyType=S.symbologyType,I.setVV(S.vvFlags,S),I.data}getVariation(){return de(se({},super.getVariation()),{vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}Ke.shared=new Ke(0);class Ne extends(he(Ee(Pe(ve(le))))){static load(S){const I=this.shared;return I.data=S,I}static from(S){const I=this.load(0);return I.geometryType=E.LW.TEXT,I.symbologyType=S.symbologyType,I.setVV(S.vvFlags,S),I.data}getVariation(){return de(se({},super.getVariation()),{vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}Ne.shared=new Ne(0);class we extends(ve(le)){static load(S){const I=this.shared;return I.data=S,I}static from(S){const I=this.load(0);return I.geometryType=E.LW.LABEL,I.symbologyType=S.symbologyType,I.setVV(S.vvFlags,S),I.mapAligned=(0,J.NS)(S.placement),I.data}getVariation(){return de(se({},super.getVariation()),{vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue})}}we.shared=new we(0)},28460:(ae,N,L)=>{L.r(N),L.d(N,{default:()=>Bs});var B=L(15861),J=L(17626),E=L(986),ge=L(26584),xe=(L(8314),L(63290)),P=L(62208),X=L(10699),Ae=(L(90912),L(85931),L(76898)),ke=L(84682),ft=L(65234),Ue=L(99666),k=L(39406),rt=L(14517),Y=L(77712),te=L(67831),st=L(71251);const Oe=new Set,De=[],Ie=new Map,Ze=[0,0];let fe=class extends rt.Z{constructor(l){super(l),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:l,process:r}=this;this._queue=new st.e({concurrency:l,process:(n,o)=>{const a=this._keyToItem.get(n);return r(a,{signal:o})},peeker:n=>n.values().next().value})}destroy(){this.clear(),this._queue=(0,P.SC)(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(l){this._queue.abort("string"==typeof l?l:l.id)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(l){return this._keyToItem.has("string"==typeof l?l:l.id)}isOngoing(l){const r="string"==typeof l?l:l.id;return this.has(r)&&this._queue.isOngoing(r)}pause(){this._queue.pause()}push(l,r){const n=l.key.id+"-"+r;if(this.has(n))return this.get(n);const o=this._queue.push(n),a=()=>{this._keyToItem.delete(n),this.notifyChange("updating")};return this._keyToItem.set(n,l),o.then(a,a),this.notifyChange("updating"),o}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView;let n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;l.forEach(f=>{const _=this._keyToItem.get(f),m=this.tileInfoView.getTileScale(_.key);Ie.has(m)||(Ie.set(m,[]),n=Math.max(m,n),o=Math.min(m,o)),Ie.get(m).push(_.key),Oe.add(m)});let a=this.state.scale;Ie.has(a)||(function mt(l,r){l.length=0,r.forEach(n=>l.push(n))}(De,Oe),De.sort((f,_)=>f-_),a=De.reduce((f,_)=>Math.abs(_-a)<Math.abs(f-a)?_:f,De[0])),a=Math.min(a,n),a=Math.max(a,o);const h=Ie.get(a),c=r.getClosestInfoForScale(a),u=c.getColumnForX(this.state.center[0]),d=c.getRowForY(this.state.center[1]);return h.sort((f,_)=>{const m=c.denormalizeCol(f.col,f.world),g=c.denormalizeCol(_.col,_.world);return Math.sqrt((u-m)*(u-m)+(d-f.row)*(d-f.row))-Math.sqrt((u-g)*(u-g)+(d-_.row)*(d-_.row))}),Oe.clear(),Ie.clear(),h[0].id}_peekByCenterFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView,n=this.state.center;let o,a=Number.POSITIVE_INFINITY;return l.forEach(h=>{const c=this._keyToItem.get(h);r.getTileCoords(Ze,c.key);const u=(0,te.d)(Ze,n);u<a&&(a=u,o=c.key)}),o.id}};(0,J._)([(0,Y.Cb)({constructOnly:!0})],fe.prototype,"concurrency",void 0),(0,J._)([(0,Y.Cb)({constructOnly:!0})],fe.prototype,"process",void 0),(0,J._)([(0,Y.Cb)()],fe.prototype,"state",void 0),(0,J._)([(0,Y.Cb)({constructOnly:!0})],fe.prototype,"strategy",void 0),(0,J._)([(0,Y.Cb)({constructOnly:!0})],fe.prototype,"tileInfoView",void 0),(0,J._)([(0,Y.Cb)({readOnly:!0})],fe.prototype,"updating",null),fe=(0,J._)([(0,Ae.j)("esri.views.2d.tiling.PagedTileQueue")],fe),L(9598);var _t=L(58098);const ve=new Set,Pe=[],he=new Map,Ee=[0,0];let Q=class extends rt.Z{constructor(l){super(l),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:l,process:r,strategy:n}=this;this._queue=new st.e({concurrency:l,process:(o,a)=>{const h=this._keyToItem.get(o);return r(h,{signal:a})},peeker:"scale-first"===n?o=>this._peekByScaleFirst(o):o=>this._peekByCenterFirst(o)})}destroy(){this.clear(),this._queue=(0,P.SC)(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(l){this._queue.abort("string"==typeof l?l:l.id)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(l){return this._keyToItem.has("string"==typeof l?l:l.id)}isOngoing(l){const r="string"==typeof l?l:l.id;return this.has(r)&&this._queue.isOngoing(r)}pause(){this._queue.pause()}push(l){const r=l.key.id;if(this._queue.has(r))return this._queue.get(r);const n=this._queue.push(r),o=()=>{this._keyToItem.delete(r),this.notifyChange("updating")};return this._keyToItem.set(r,l),n.then(o,o),this.notifyChange("updating"),n}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView;let n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;l.forEach(f=>{const _=this._keyToItem.get(f),m=this.tileInfoView.getTileScale(_.key);he.has(m)||(he.set(m,[]),n=Math.max(m,n),o=Math.min(m,o)),he.get(m).push(_.key),ve.add(m)});let a=this.state.scale;he.has(a)||(function le(l,r){l.length=0,r.forEach(n=>l.push(n))}(Pe,ve),Pe.sort((f,_)=>f-_),a=Pe.reduce((f,_)=>Math.abs(_-a)<Math.abs(f-a)?_:f,Pe[0])),a=Math.min(a,n),a=Math.max(a,o);const h=he.get(a),c=r.getClosestInfoForScale(a),u=c.getColumnForX(this.state.center[0]),d=c.getRowForY(this.state.center[1]);return h.sort((f,_)=>{const m=c.denormalizeCol(f.col,f.world),g=c.denormalizeCol(_.col,_.world);return Math.sqrt((u-m)*(u-m)+(d-f.row)*(d-f.row))-Math.sqrt((u-g)*(u-g)+(d-_.row)*(d-_.row))}),ve.clear(),he.clear(),h[0].id}_peekByCenterFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView,n=this.state.center;let o,a=Number.POSITIVE_INFINITY;return l.forEach(h=>{const c=this._keyToItem.get(h);r.getTileCoords(Ee,c.key);const u=(0,te.d)(Ee,n);u<a&&(a=u,o=c.key)}),o.id}};(0,J._)([(0,Y.Cb)({constructOnly:!0})],Q.prototype,"concurrency",void 0),(0,J._)([(0,Y.Cb)({constructOnly:!0})],Q.prototype,"process",void 0),(0,J._)([(0,Y.Cb)()],Q.prototype,"state",void 0),(0,J._)([(0,Y.Cb)({constructOnly:!0})],Q.prototype,"strategy",void 0),(0,J._)([(0,Y.Cb)({constructOnly:!0})],Q.prototype,"tileInfoView",void 0),(0,J._)([(0,Y.Cb)({readOnly:!0})],Q.prototype,"updating",null),Q=(0,J._)([(0,Ae.j)("esri.views.2d.tiling.TileQueue")],Q),L(65401),L(84378),new _t.Z(0,0,0,0);var w=L(39351),nt=L(87526);const Xe=new Map;Xe.set(k.LW.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),Xe.set(k.LW.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),Xe.set(k.LW.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),Xe.set(k.LW.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),Xe.set(k.LW.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});class pt{get length(){return this._pos}constructor(r,n){this._pos=0;const o=n?this._roundToNearest(n,r.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(o),this._buffer=new r(this._array),this._ctor=r,this._i16View=new Int16Array(this._array)}_roundToNearest(r,n){const o=Math.round(r);return o+(n-o%n)}_ensureSize(r){if(this._pos+r>=this._buffer.length){const n=this._roundToNearest(1.25*(this._array.byteLength+r*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),o=new ArrayBuffer(n),a=new this._ctor(o);a.set(this._buffer,0),this._array=o,this._buffer=a,this._i16View=new Int16Array(this._array)}}ensureSize(r){this._ensureSize(r)}writeF32(r){this._ensureSize(1);const n=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=r,this._pos++,n}push(r){this._ensureSize(1);const n=this._pos;return this._buffer[this._pos++]=r,n}writeFixed(r){this._buffer[this._pos++]=r}setValue(r,n){this._buffer[r]=n}i1616Add(r,n,o){this._i16View[2*r]+=n,this._i16View[2*r+1]+=o}getValue(r){return this._buffer[r]}incr(r){if(this._buffer.length<r)throw new Error("Increment index overflows the target buffer");this._buffer[r]++}decr(r){this._buffer[r]--}writeRegion(r){this._ensureSize(r.length);const n=this._pos;return this._buffer.set(r,this._pos),this._pos+=r.length,n}writeManyFrom(r,n,o){this._ensureSize(o-n);for(let a=n;a!==o;a++)this.writeFixed(r._buffer[a])}buffer(){const r=this._array.slice(0,4*this._pos);return this.destroy(),r}toArray(){const r=this._array,n=[];for(let o=0;o<r.byteLength/4;o++)n.push(r[o]);return n}seek(r){this._pos=r}destroy(){this._array=null,this._buffer=null}}class vi{constructor(r,n,o){this._start={index:0,vertex:0};const a=function lr(l,r,n){const{indicesPerRecord:o,multiplier:a,verticesPerRecord:h}=Xe.get(l);return{recordBytes:n*w.XJ*Uint32Array.BYTES_PER_ELEMENT,indexBytes:a*o*n*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:a*h*n*r}}(r,n,o),h=n/4;this.geometryType=r,this._records=new pt(Int32Array,a.recordBytes),this._indices=new pt(Uint32Array,a.indexBytes),this._vertices=new pt(Uint32Array,a.vertexBytes),this._metrics=new pt(Float32Array,0),this._strideInt=h}serialize(r){const n=this._records.buffer(),o=this._indices.buffer(),a=this._vertices.buffer(),h=this._metrics.length?this._metrics.buffer():null,c=4*this._strideInt;return r.push(n,o,a),{stride:c,records:n,indices:o,vertices:a,metrics:h}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/w.XJ}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(r){this._vertices.ensureSize(r)}indexEnsureSize(r){this._indices.ensureSize(r)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(r,n,o,a,h,c,u,d){this._records.push(r),this._records.push(null!=n?n:0),this._records.push(o),this._records.push(a),this._records.push(h),this._records.push(c),this._records.push(u),this._records.writeF32(d)}writeIndex(r){this._indices.push(r)}writeVertex(r){this._vertices.push(r)}writeVertexF32(r){this._vertices.writeF32(r)}copyLastFrom(r,n,o){const a=r._records.length-w.XJ,h=r._records.getValue(a),c=r._records.getValue(a+1),u=r._records.getValue(a+2),d=r._records.getValue(a+4),f=r._records.getValue(a+6),_=r._records.getValue(a+7),m=this._vertices.length,g=(r._start.vertex-this._vertices.length)/this._strideInt,p=this._indices.length,x=this.vertexCount;for(let y=r._start.index;y!==r._indices.length;y++){const M=r._indices.getValue(y);this._indices.push(M-g)}for(let y=r._start.vertex;y!==r._vertices.length;y++){const M=r._vertices.getValue(y);this._vertices.push(M)}for(let y=m;y<=this._vertices.length;y+=this._strideInt)this._vertices.i1616Add(y,n,o);this._records.push(h),this._records.push(c),this._records.push(u),this._records.push(p),this._records.push(d),this._records.push(x),this._records.push(f),this._records.push(_)}}var cr=L(55376);function Mi(l){switch(l){case 1:case 8:case 32:return-1;case 2:case 64:return 0;case 4:case 16:case 128:return 1}}function Si(l){switch(l){case 1:case 2:case 4:return-1;case 8:case 16:return 0;case 32:case 64:case 128:return 1}}class ur{constructor(r,n,o,a,h,c=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=n,this.tileKey=r,this._hasAggregate=a,this._pixelBufferEnabled=h,this._version=c,this._symbologyType=o}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(r){const n=[];return n.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((o,a)=>{const h=1<<a,c=Mi(h),u=Si(h),d=(0,cr.M)(new _t.Z(this.tileKey),c,u,r),f=this._serializeTileVertexData(this.tileKey,d.id,o.vertexData);f.message.bufferIds=o.displayIds,n.push(f)}),n}_serializeTileVertexData(r,n,o){var h,c,u,d,f;const a=new Array;return{message:{tileKeyOrigin:r,tileKey:n,data:{[k.LW.MARKER]:null==(h=o.get(k.LW.MARKER))?void 0:h.serialize(a),[k.LW.FILL]:null==(c=o.get(k.LW.FILL))?void 0:c.serialize(a),[k.LW.LINE]:null==(u=o.get(k.LW.LINE))?void 0:u.serialize(a),[k.LW.TEXT]:null==(d=o.get(k.LW.TEXT))?void 0:d.serialize(a),[k.LW.LABEL]:null==(f=o.get(k.LW.LABEL))?void 0:f.serialize(a)},version:this._version},transferList:a}}featureStart(r,n){this._current.insertAfter=r,this._current.sortKey=n}featureEnd(){}recordStart(r,n,o,a){this._current.writer=this._getVertexWriter(o),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=a,this._current.id=r,this._current.materialKey=n,this._current.geometryType=o,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(r){this._current.writer.vertexEnsureSize(r)}indexEnsureSize(r){this._current.writer.indexEnsureSize(r)}vertexBounds(r,n,o,a){this._current.bufferingEnabled&&this._addOverlap(r,n,o,a)}vertexWrite(r){this._current.writer.writeVertex(r)}vertexWriteF32(r){this._current.writer.writeVertexF32(r)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(r){this._current.writer.writeIndex(r)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(r,n,o,a,h,c,u,d){this._current.writer=this._getVertexWriter(k.LW.LABEL);const f=this._current.writer.metricWriter;f.push((0,Ue.jL)(r)),f.push(n),f.push(o),f.push(a),f.push(h),f.push(c),f.push(u),f.push(d),f.push(255),this._current.metricBoxLenPointer=f.push(0)}metricEnd(){const r=this._current.writer.metricWriter;0===r.getValue(this._current.metricBoxLenPointer)&&r.seek(r.length-10)}metricBoxWrite(r,n,o,a){const h=this._current.writer.metricWriter;h.incr(this._current.metricBoxLenPointer),h.push(0),h.push(0),h.push(r),h.push(n),h.push(o),h.push(a)}recordEnd(){const r=this._current.vertStart,n=this._current.writer.vertexCount-r;if(!n)return!1;this.hasRecords=!0;const o=this._current.indexStart;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,o,this._current.writer.indexCount-o,r,n,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||0===this._current.overlaps||this._current.geometryType===k.LW.LABEL)return!0;const h=this._current.writer;for(let c=0;c<8;c++){const u=1<<c;if(this._current.overlaps&u){this._data.neighbors[c]||(this._data.neighbors[c]={vertexData:new Map,displayIds:new Set});const d=this._data.neighbors[c],f=this._current.geometryType;if(!d.vertexData.has(f)){const x=(0,nt.$_)(f,this._symbologyType).geometry,y=new vi(f,x,w.Ip);d.vertexData.set(f,y)}const _=d.vertexData.get(this._current.geometryType),m=8,g=512*-Mi(u)*m,p=512*-Si(u)*m;null==_||_.copyLastFrom(h,g,p),d.displayIds.add(this._current.id)}}return!0}_addOverlap(r,n,o,a){this._current.overlaps|=255^((r<0+o?148:r>=w.I_-o?41:189)|(n<0+a?224:n>=w.I_-a?7:231))}_getVertexWriter(r){if(!this._data.self.has(r)){const n=this._data.self,o=(0,nt.$_)(r,this._symbologyType).geometry;n.set(r,new vi(r,o,this.hint.records))}return this._data.self.get(r)}}var wi=L(58774),Wi=L(21286),W=L(23841),Ot=L(31478),Mt=L(12225),H=L(7547),Me=L(40028),U=L(81295),T=L(5254),O=L(18716);const _e=100;function zi(l,r,n){return l[0]=r[0]-n[0],l[1]=r[1]-n[1],l}function Ci(l,r){return Math.sqrt(l*l+r*r)}function Pi(l){const r=Ci(l[0],l[1]);l[0]/=r,l[1]/=r}function dr(l,r){return Ci(l[0]-r[0],l[1]-r[1])}function A(l){return"function"==typeof l}function Dt(l=2){return 1/Math.max(l,1)}function We(l,r){return[!(null==l||!l.minScale)&&r.scaleToZoom(l.minScale)||0,!(null==l||!l.maxScale)&&r.scaleToZoom(l.maxScale)||_e]}function Ei(l){return l.length-1}function mr(l,r,n=1){const[o,a]=function fr(l,r){return l[r+1]}(l,r);return Math.sqrt(o*o+a*a)*n}class ot{constructor(r,n,o,a,h){this._segments=r,this._index=n,this._distance=o,this._xStart=a,this._yStart=h,this._done=!1}static create(r){return new ot(r,0,0,r[0][0],r[0][1])}clone(){return new ot(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(r){return this._index===r._index||r._index===this._index-1&&(0===this._distance||1===r._distance)||r._index===this._index+1&&(1===this._distance||0===r._distance)}leq(r){return this._index<r._index||this._index===r._index&&this._distance<=r._distance}geq(r){return this._index>r._index||this._index===r._index&&this._distance>=r._distance}get _segment(){return this._segments[this._index+1]}get angle(){const r=this.dy;let o=Math.acos((0*r+-1*-this.dx)/(1*this.length));return r>0&&(o=2*Math.PI-o),o}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:r,dy:n}=this;return Math.sqrt(r*r+n*n)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<Ei(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(r,n){const o=this.backwardLength;if(r<=o)return this._distance=(o-r)/this.length,this;let a=this.backwardLength;for(;this.prev();){if(a+this.length>r)return this._seekBackwards(r-a);a+=this.length}return this._distance=0,n?this:null}seek(r,n=!1){if(r<0)return this._seekBackwards(Math.abs(r),n);if(r<=this.remainingLength)return this._distance=(this.backwardLength+r)/this.length,this;let o=this.remainingLength;for(;this.next();){if(o+this.length>r)return this.seek(r-o,n);o+=this.length}return this._distance=1,n?this:null}}function _r(l,r,n,o=!0){const a=function Fi(l){let r=0;for(let n=0;n<Ei(l);n++)r+=mr(l,n);return r}(l),h=ot.create(l),c=a/2;if(!o)return h.seek(c),void n(h.clone(),0,c+0*r,a);const u=Math.max((a-r)/2,0),d=Math.floor(u/r);h.seek(c-d*r);for(let _=-d;_<=d;_++)h.x<512&&h.x>=0&&h.y<512&&h.y>=0&&n(h.clone(),_,c+_*r,a),h.seek(r)}function yr(l,r){if(r<=0)return;const o=l.length;if(o<3)return;const a=[];let h=0;a.push(0);for(let m=1;m<o;m++)h+=dr(l[m],l[m-1]),a.push(h);r=Math.min(r,.2*h);const c=[];c.push(l[0][0]),c.push(l[0][1]);const u=l[o-1][0],d=l[o-1][1],f=zi([0,0],l[0],l[1]);Pi(f),l[0][0]+=r*f[0],l[0][1]+=r*f[1],zi(f,l[o-1],l[o-2]),Pi(f),l[o-1][0]+=r*f[0],l[o-1][1]+=r*f[1];for(let m=1;m<o;m++)a[m]+=r;a[o-1]+=r;const _=.5*r;for(let m=1;m<o-1;m++){let g=0,p=0,x=0;for(let y=m-1;y>=0&&!(a[y+1]<a[m]-_);y--){const M=_+a[y+1]-a[m],v=a[y+1]-a[y],b=a[m]-a[y]<_?1:M/v;if(Math.abs(b)<1e-6)break;const C=b*b,z=b*M-.5*C*v,V=b*v/r,F=l[y+1],G=l[y][0]-F[0],K=l[y][1]-F[1];g+=V/z*(F[0]*b*M+.5*C*(M*G-v*F[0])-C*b*v*G/3),p+=V/z*(F[1]*b*M+.5*C*(M*K-v*F[1])-C*b*v*K/3),x+=V}for(let y=m+1;y<o&&!(a[y-1]>a[m]+_);y++){const M=_-a[y-1]+a[m],v=a[y]-a[y-1],b=a[y]-a[m]<_?1:M/v;if(Math.abs(b)<1e-6)break;const C=b*b,z=b*M-.5*C*v,V=b*v/r,F=l[y-1],G=l[y][0]-F[0],K=l[y][1]-F[1];g+=V/z*(F[0]*b*M+.5*C*(M*G-v*F[0])-C*b*v*G/3),p+=V/z*(F[1]*b*M+.5*C*(M*K-v*F[1])-C*b*v*K/3),x+=V}c.push(g/x),c.push(p/x)}c.push(u),c.push(d);for(let m=0,g=0;m<o;m++)l[m][0]=c[g++],l[m][1]=c[g++]}var He=L(82054),gr=L(72283),xr=L(95727);class Vi{static getPlacement(r,n,o,a,h){const c=(0,xr.W)(n);if(!c)return null;const u=(0,gr.GP)(r);return c.execute(u,n,o,a,h)}}var vr=L(25797);const ne=(0,T.UJ)(4,4),St=(0,T.UJ)(4,2),oe=(0,T.UJ)(4,6),Bi=[St,St,oe,oe],Ri=[St,oe,St,oe],Mr=[oe,oe,ne,ne],Sr=[ne,ne,oe,oe],br=[oe,ne,oe,ne],Lr=[ne,oe,ne,oe],Ai=l=>class extends l{constructor(...r){super(...r),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=k.LW.TEXT,this._aux=(0,T.Jz)(0,0,this._referenceSize,this._bitset)}bindTextInfo(r,n){this._shapingInfo=r&&r.length?(0,P.yw)(r,o=>(0,vr.Nr)(o,n,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:w.xm*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize})):null}_write(r,n,o,a){const h=n.getDisplayId();this._writeGeometry(r,n,h,o,a)}_writeGeometry(r,n,o,a,h){const c=this._shapingInfo;if((0,P.Wi)(c))return;if((0,P.pC)(this._textPlacement)){const d=null!=h?h:n.readLegacyGeometryForDisplay();return this._writePlacedText(r,o,d,c,a)}const u=h?(0,He.oB)((0,He.GH)(h),2):"esriGeometryPolygon"===n.geometryType?n.readCentroid():n.readGeometryForDisplay();if(!(0,P.Wi)(u)){if(u.isPoint){const[d,f]=u.coords;return!r.hasAggregates&&r.hasPixelBufferEnabled&&(d<0||d>=512||f<0||f>=512)?void 0:this._writeGlyphs(r,o,{x:d,y:f},c)}u.forEachVertex((d,f)=>this._writeGlyphs(r,o,{x:d,y:f},c))}}_writePlacedText(r,n,o,a,h){const c=(0,P.Wg)(this._textPlacement),u=Vi.getPlacement(o,c,(0,W.F2)(1),r.tileKey,h.geometryEngine);if(!u)return;let d=u.next();for(;null!=d;){const f=-d.getAngle();a.setRotation(f);const _=d.tx,m=-d.ty;_<0||_>=512||m<0||m>=512||(this._writeGlyphs(r,n,{x:_,y:m},a),a.setRotation(-f)),d=u.next()}}_writeGlyphs(r,n,o,a){const h=O.m2.load(this._materialKey),c=(0,T.UJ)(Math.round(8*o.x),Math.round(8*o.y)),u=this._vertexBoundsScale,{bounds:d,background:f,glyphs:_}=a;_.length>0&&(this._borderLineColor||this._backgroundColor)&&(h.textureBinding=_[0].textureBinding,r.recordStart(n,h.data,this.geometryType,!0),this._writeBackgroundGeometry(r,n,o,d,f),r.recordEnd());const m=2*Math.max(d.width,d.height);for(const g of a.glyphs)h.textureBinding=g.textureBinding,r.recordStart(n,h.data,this.geometryType,!0),r.vertexBounds(o.x+d.x+this._xOffset,o.y+d.y-this._yOffset,m*u,m*u),this._writeVertices(r,n,c,g),r.recordEnd()}_writeGlyph(r,n,o,a,h){const c=O.m2.load(this._materialKey),u=(0,T.UJ)(Math.round(8*o),Math.round(8*a));c.textureBinding=h.textureBinding,r.recordStart(n,c.data,this.geometryType,!0);const d=h.bounds,f=this._vertexBoundsScale;r.vertexBounds(o+d.x*f,a+d.y*f,d.width*f,d.height*f),this._writeVertices(r,n,u,h),r.recordEnd()}_writeVertices(r,n,o,a){const h=r.vertexCount();this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.upperLeft),r.vertexWrite(a.texcoords.upperLeft),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.upperRight),r.vertexWrite(a.texcoords.upperRight),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.lowerLeft),r.vertexWrite(a.texcoords.lowerLeft),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.lowerRight),r.vertexWrite(a.texcoords.lowerRight),r.vertexEnd(),r.indexWrite(h+0),r.indexWrite(h+1),r.indexWrite(h+2),r.indexWrite(h+1),r.indexWrite(h+3),r.indexWrite(h+2)}_writeVertexCommon(r,n,o,a){const h=this._color,c=this._haloColor,u=(0,T.Jz)(0,0,this._referenceSize,this._bitset),d=(0,T.Jz)(0,0,this._size,this._haloSize);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(h),r.vertexWrite(c),r.vertexWrite(d),r.vertexWrite(u),r.vertexWrite(this._minMaxZoom)}_writeBackgroundVertex(r,n,o,a,h,c){const u=(0,T.Jz)(0,1,this._referenceSize,this._bitset),d=(0,T.Jz)(0,0,this._size,this._haloSize),f=(0,T.Jz)(0,0,0,0);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(a),r.vertexWrite(f),r.vertexWrite(d),r.vertexWrite(u),r.vertexWrite(this._minMaxZoom),r.vertexWrite(h),r.vertexWrite(c),r.vertexEnd()}_writeBackgroundQuad(r,n,o,a,h,c){const u=r.vertexCount();this._writeBackgroundVertex(r,n,o,a,h.upperLeft,c[0]),this._writeBackgroundVertex(r,n,o,a,h.upperRight,c[1]),this._writeBackgroundVertex(r,n,o,a,h.lowerLeft,c[2]),this._writeBackgroundVertex(r,n,o,a,h.lowerRight,c[3]),r.indexWrite(u+0),r.indexWrite(u+1),r.indexWrite(u+2),r.indexWrite(u+1),r.indexWrite(u+3),r.indexWrite(u+2)}_writeBackgroundGeometry(r,n,o,a,h){const c=(0,T.UJ)(Math.round(8*o.x),Math.round(8*o.y)),{x:u,y:d,width:f,height:_}=a,m=2*Math.max(f,_);if(r.vertexBounds(o.x+u+this._xOffset,o.y+d-this._yOffset,m*this._vertexBoundsScale,m*this._vertexBoundsScale),this._backgroundColor&&this._writeBackgroundQuad(r,n,c,this._backgroundColor,h.main,[ne,ne,ne,ne]),this._borderLineColor||this._backgroundColor){const g=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[p,x,y,M,v]=g?[Bi,Bi,Ri,Ri,this._borderLineColor]:[Mr,Sr,br,Lr,this._backgroundColor];this._writeBackgroundQuad(r,n,c,v,h.top,p),this._writeBackgroundQuad(r,n,c,v,h.bot,x),this._writeBackgroundQuad(r,n,c,v,h.left,y),this._writeBackgroundQuad(r,n,c,v,h.right,M)}}};var Gt=L(73608);class at{constructor(){this._materialKey=null}bindFeature(r,n,o){}write(r,n,o,a){var u;if((0,P.Wi)(this._effects)||0===(null==(u=this._effects)?void 0:u.length))return this._write(r,n,a);const h=Gt.j.executeEffects(this._effects,n.readLegacyGeometryForDisplay(),r.tileKey,a.geometryEngine);let c=Gt.j.next(h);for(;c;)this._write(r,n,a,c),c=Gt.j.next(h)}_write(r,n,o,a){}}class Ye extends(Ai(at)){constructor(r,n,o,a,h,c,u,d,f,_,m,g,p,x,y,M,v,b,C,z,V,F,G,K){super(),this._xOffset=(0,W.F2)(p),this._yOffset=(0,W.F2)(x),this._decoration=_||"none",this._backgroundColor=F,this._borderLineColor=G,this._borderLineSize=K,this._color=h,this._haloColor=c,this._haloSize=Math.min(Math.floor(5*(0,W.F2)((0,W.t_)(o))),127),this._size=Math.min(Math.round((0,W.F2)(n)),127);const ce=Math.min(Math.round((0,W.F2)(a||n)),127);this._referenceSize=Math.round(Math.sqrt(256*ce)),this._scale=this._size/w.Ex,this._angle=g,this._justify=(0,Me.Hd)(u||"center"),this._xAlignD=(0,Me.kH)(u||"center"),this._yAlignD=(0,Me.b7)(d||"baseline"),this._baseline="baseline"===(d||"baseline"),this._bitset=(f===H.v2.MAP?1:0)|(m?1:0)<<1;const ee=O.m2.load(r);ee.sdf=!0,this._materialKey=ee.data,this._lineWidth=(0,W.F2)(y)||512,this._lineHeight=M||1,this._textPlacement=v,this._effects=b,this._isCIM=null!=C&&C,this._minMaxZoom=(0,T.UJ)(Math.round(z*w.MI),Math.round(V*w.MI))}static fromText(r,n){var c,u;const o=null==(c=r.font)?void 0:c.size,a=new Ye(r.materialKey,o,r.haloSize||0,o,r.color&&(0,U.aH)(r.color)||0,r.haloColor&&(0,U.aH)(r.haloColor)||0,r.horizontalAlignment,r.verticalAlignment,H.v2.SCREEN,null==(u=r.font)?void 0:u.decoration,!1,r.angle||0,r.xoffset||0,r.yoffset||0,r.lineWidth||0,r.lineHeight||0,null,null,!1,0,_e,r.backgroundColor&&(0,U.aH)(r.backgroundColor),r.borderLineColor&&(0,U.aH)(r.borderLineColor),r.borderLineSize),[,h]=(0,E.E)(r.text);return a.bindTextInfo(null!=n?n:[],h),a._vertexBoundsScale=r.maxVVSize&&o?r.maxVVSize/o:1,a}static fromCIMText(r,n,o){var _;const a=r.scaleFactor||1,h=r.size*r.sizeRatio*a,[c,u]=We(r.scaleInfo,o),d=new Ye(r.materialKey,h,r.outlineSize*r.sizeRatio,r.referenceSize,(0,U.t2)(r.color),(0,U.t2)(r.outlineColor),r.horizontalAlignment,r.verticalAlignment,r.alignment,r.decoration,null!=(_=r.colorLocked)&&_,r.angle,r.offsetX*r.sizeRatio*a,r.offsetY*r.sizeRatio*a,512,1,r.markerPlacement,r.effects,!0,c,u,r.backgroundColor?(0,U.t2)(r.backgroundColor):void 0,r.borderLineColor?(0,U.t2)(r.borderLineColor):void 0,r.borderLineWidth),[,f]=(0,E.E)(r.text);return d.bindTextInfo(n,f),d._vertexBoundsScale=r.maxVVSize?r.maxVVSize/h:1,d}}const ki=xe.Z.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),Pr=function Cr(l){const r=new Map;return n=>(r.has(n)||r.set(n,l(n)),r.get(n))}(l=>{let r=0;if(0===l)return 1/0;for(;!(l%2);)r++,l/=2;return r}),Lt=l=>Math.floor(127*l+127),Fe=l=>Math.floor(10*l),ze=l=>Math.round(l*(254/360));class Tt extends Ye{constructor(r,n,o,a){var m,g,p,x,y,M;super(r,null==(m=o.font)?void 0:m.size,o.haloSize||0,null==(g=o.font)?void 0:g.size,o.color&&(0,U.aH)(o.color)||0,o.haloColor&&(0,U.aH)(o.haloColor)||0,o.horizontalAlignment,o.verticalAlignment,(0,Me.NS)(n.labelPlacement)?H.v2.MAP:H.v2.SCREEN,null==(p=o.font)?void 0:p.decoration,!1,o.angle||0,o.xoffset,o.yoffset,o.lineWidth,o.lineHeight,null,null,!1,null,null,o.backgroundColor&&(0,U.aH)(o.backgroundColor),o.borderLineColor&&(0,U.aH)(o.borderLineColor),o.borderLineSize),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=k.LW.LABEL,this._allowOverrun=null!=(x=n.allowOverrun)&&x,this._repeatLabel=null==(y=n.repeatLabel)||y,this._labelPosition=null!=(M=n.labelPosition)?M:"curved";const h=function Wr(l,r){const n=!!l.minScale&&r.scaleToZoom(l.minScale)||0;return(0,Wi.uZ)(n,0,25.5)}(n,a),c=function zr(l,r){const n=!!l.maxScale&&r.scaleToZoom(l.maxScale)||255;return(0,Wi.uZ)(n,0,25.5)}(n,a),u=n.labelPlacement,[d,f]=(0,Me.qv)(u);this._xAlignD=d,this._yAlignD=f,this._minZoom=h,this._maxZoom=c,this._minBackgroundZoom=h,this._maxBackgroundZoom=c,this._refPlacementPadding=(0,W.F2)(o.haloSize)+w.Iw,this._repeatLabelDistance=n.repeatLabelDistance?(0,W.F2)(n.repeatLabelDistance):128;const _=O.Gq.load(r);_.sdf=!0,this._materialKey=_.data}static fromLabelClass(r,n){if("esriServerLinePlacementCenterAlong"===r.labelPlacement){const o=r.symbol;o.xoffset=0,o.yoffset=0,o.angle=0,o.font.decoration="none"}return new Tt(r.materialKey,r,r.symbol,n)}get _shapedBox(){return(0,P.Wg)(this._shapingInfo).bounds}setZoomLevel(r){this._zoomLevel=r}bindReferenceTemplate(r){let n=(0,Me.g)(this._xAlignD),o=(0,Me.tf)(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,(0,P.Wi)(r))return void(this._refSymbolAndPlacementOffset=(0,T.Jz)(0,0,Lt(n),Lt(o)));if("circle"===r.boundsType&&(n||o)){const c=Math.sqrt(n*n+o*o);n/=c,o/=c}const a=Math.max(r.height,r.width);this._refSymbolAndPlacementOffset=(0,T.Jz)(4*this._refPlacementPadding,a,Lt(n),Lt(o)),this._referenceSize=a,this._refPlacementDirX=n,this._refPlacementDirY=o,this._refOffsetX=r.xOffset,this._refOffsetY=r.yOffset}_write(r,n){if((0,P.Wi)(this._shapingInfo))return;const o=this._shapingInfo,a=n.getDisplayId(),h="esriGeometryPolygon"===n.geometryType?n.readLegacyCentroid():n.readLegacyGeometry();if(h)switch(this._current={out:r,inId:a,inShaping:o,zoomLevel:this._zoomLevel},"esriGeometryPolyline"===n.geometryType&&"curved"===this._labelPosition&&(this._borderLineColor||this._backgroundColor)&&ki.warnOnce("TextSymbol properties 'borderLineColor', 'borderLineSize', and 'backgroundColor' are not supported in curved labels"),n.geometryType){case"esriGeometryPolyline":this._placeLineLabels(h);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(h);break;default:((l,r="mapview-labeling")=>{ki.error(new ge.Z(r,l))})(`Geometry of type ${n.geometryType} is not supported`)}}_isVisible(r,n){const o=Fe(this._current.zoomLevel);return Fe(r)<=o&&o<=Fe(n)}_placePointLabels(r){const{out:n,inId:o,inShaping:a}=this._current;this._writeGlyphs(n,o,r,a)}_placeLineLabels(r){const n=function pr(l,r){const n=r;for(let o=0;o<l.length;o++){let a=l[o];const h=[];h.push(a[0]);for(let u=1;u<a.length;u++){let[d,f]=h[u-1];d+=a[u][0],f+=a[u][1],h.push([d,f])}yr(h,n);const c=[];c.push(h[0]);for(let u=1;u<h.length;u++){const[d,f]=h[u-1],[_,m]=h[u],g=Math.round(_-d),p=Math.round(m-f);c.push([g,p])}l[o]=c,a=c}return l}(r.paths,this._current.inShaping.bounds.width),o=this._placeSubdivGlyphs.bind(this),a=(this._shapedBox.width+this._repeatLabelDistance)/2;for(const h of n)_r(h,a,o,this._repeatLabel)}_placeSubdivGlyphs(r,n,o,a){const h=Pr(n),c=this._shapedBox.width/2,u=Math.sqrt(this._repeatLabelDistance)/2,d=Math.min(o,a-o),f=this._current.inShaping.isMultiline?25:Math.log2(d/(u+c/2)),_=0===n?f:Math.min(h,f),m=Math.max(this._minZoom,this._current.zoomLevel+1-_),g=this._current.zoomLevel-m,p=this._shapedBox.width/2*2**g;this._current.inShaping.isMultiline?0===n&&this._placeStraight(r,m):this._allowOverrun&&g<0?this._placeStraightAlong(r,this._minZoom):"parallel"===this._labelPosition?this._placeStraightAlong(r,m):"curved"===this._labelPosition&&this._placeCurved(r,m,p)}_placeStraight(r,n){const{out:o,inId:a,inShaping:h}=this._current,c=Math.ceil(r.angle*(180/Math.PI)%360),u=Math.ceil((r.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=ze(c),this._writeGlyphs(o,a,r,h,n),this._outLineLabelAngle=ze(u),this._writeGlyphs(o,a,r,h,n)}_placeCurved(r,n,o){const{out:a,inId:h}=this._current;a.metricStart(h,n,r.x,r.y,0,0,0,0);const c=r.clone(),u=r.angle*(180/Math.PI)%360,d=(r.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=ze(u),this._placeFirst(c,n,1),this._placeBack(r,c,n,o,1),this._placeForward(r,c,n,o,1),this._outLineLabelAngle=ze(d),this._placeFirst(c,n,0),this._placeBack(r,c,n,o,0),this._placeForward(r,c,n,o,0),a.metricEnd()}_placeStraightAlong(r,n){const{out:o,inId:a,inShaping:h}=this._current;o.metricStart(a,n,r.x,r.y,0,0,0,0);const c=r.clone(),u=r.angle*(180/Math.PI)%360,d=(r.angle*(180/Math.PI)+180)%360,f=h.glyphs.length>0&&(this._borderLineColor||this._backgroundColor);if(this._maxBackgroundZoom=25,this._minBackgroundZoom=Math.max(n,0),f){const _=O.Gq.load(this._materialKey);_.textureBinding=h.glyphs[0].textureBinding;const m=(0,Ot.b)((0,Mt.c)(),-r.angle),[g,p]=h.shapeBackground(m);this._outLineLabelAngle=ze(u),o.recordStart(a,_.data,this.geometryType,!0),this._writeBackgroundGeometry(o,a,r,g,p),o.recordEnd(),this._outLineLabelAngle=ze(d),o.recordStart(a,_.data,this.geometryType,!0),this._writeBackgroundGeometry(o,a,r,g,p),o.recordEnd()}this._outLineLabelAngle=ze(u),this._placeFirst(c,n,1,!0),this._outLineLabelAngle=ze(d),this._placeFirst(c,n,0,!0),o.metricEnd()}_placeBack(r,n,o,a,h){const c=r.clone();let u=r.backwardLength+0;for(;c.prev()&&!(u>=a);)this._placeOnSegment(c,n,u,o,-1,h),u+=c.length+0}_placeForward(r,n,o,a,h){const c=r.clone();let u=r.remainingLength+0;for(;c.next()&&!(u>=a);)this._placeOnSegment(c,n,u,o,1,h),u+=c.length+0}_placeFirst(r,n,o,a=!1){const h=r,c=this._current.inShaping,u=c.glyphs,d=this._current.zoomLevel,{out:f,inId:_}=this._current;for(const m of u){const g=m.x>c.bounds.x?o:1-o,p=g*r.remainingLength+(1-g)*r.backwardLength,x=Math.abs(m.x+m.width/2-c.bounds.x),y=Math.max(0,d+Math.log2(x/(p+0))),M=Math.max(n,a?0:y);if(m.maxZoom=25,m.angle=r.angle+(1-o)*Math.PI,m.minZoom=M,this._writeGlyph(f,_,h.x,h.y,m),o&&this._isVisible(m.minZoom,m.maxZoom)){const v=m.bounds;f.metricBoxWrite(v.center[0],v.center[1],v.width,v.height)}}}_placeOnSegment(r,n,o,a,h,c){const u=this._current.inShaping.glyphs,{out:d,inId:f}=this._current,_=this._current.inShaping,m=this._current.zoomLevel,x={x:r.x+o*-h*(r.dx/r.length),y:r.y+o*-h*(r.dy/r.length)};for(const y of u){const M=y.x>_.bounds.x?c:1-c;if(!(M&&1===h||!M&&-1===h))continue;const v=Math.abs(y.x+y.width/2-_.bounds.x),b=Math.max(0,m+Math.log2(v/o)-.1),C=Math.max(a,m+Math.log2(v/(o+r.length+0)));if(0!==b&&(y.angle=r.angle+(1-c)*Math.PI,y.minZoom=C,y.maxZoom=b,this._writeGlyph(d,f,x.x,x.y,y),c&&this._isVisible(y.minZoom,y.maxZoom))){const z=y.bounds;d.metricBoxWrite(z.center[0]+(r.x-n.x),z.center[1]+(r.y-n.y),z.width,z.height)}}}_writeGlyphs(r,n,o,a,h=this._minZoom){if(o.x<0||o.x>=512||o.y<0||o.y>=512)return;if(a.glyphs.length>0&&(this._borderLineColor||this._backgroundColor)){const m=O.Gq.load(this._materialKey);m.textureBinding=a.glyphs[0].textureBinding,r.recordStart(n,m.data,this.geometryType,!0),this._writeBackgroundGeometry(r,n,o,a.bounds,a.background),r.recordEnd()}const c=o.x+this._refOffsetX,u=o.y-this._refOffsetY;for(const m of a.glyphs)m.minZoom=h,m.maxZoom=this._maxZoom,this._writeGlyph(r,n,c,u,m);const _=a.boundsT;r.metricStart(n,h,c,u,this._refPlacementDirX,this._refPlacementDirY,this._referenceSize,this._materialKey),r.metricBoxWrite(_.center[0],_.center[1],_.width,_.height),r.metricEnd()}_writeVertexCommon(r,n,o,a){const h=this._color,c=this._haloColor,u=(0,T.Jz)(0,0,this._size,this._haloSize),d=Math.max(a.minZoom,this._minZoom),f=Math.min(a.maxZoom,this._maxZoom),_=(0,T.Jz)(Fe(d),Fe(f),this._outLineLabelAngle,0);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(h),r.vertexWrite(c),r.vertexWrite(u),r.vertexWrite(this._refSymbolAndPlacementOffset),r.vertexWrite(_)}_writeBackgroundVertex(r,n,o,a,h,c){const u=(0,T.Jz)(0,0,this._size,this._haloSize),d=(0,T.Jz)(0,0,0,0),f=(0,T.Jz)(Fe(this._minBackgroundZoom),Fe(this._maxBackgroundZoom),this._outLineLabelAngle,1);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(a),r.vertexWrite(d),r.vertexWrite(u),r.vertexWrite(this._refSymbolAndPlacementOffset),r.vertexWrite(f),r.vertexWrite(h),r.vertexWrite(c),r.vertexEnd()}}var It=L(9545);const Ui=3.14159265359/180,Di=l=>class extends l{constructor(...r){super(...r),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._allowBorrowing=!0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=k.LW.MARKER}_write(r,n,o,a){const h=n.getDisplayId();r.recordStart(h,this._materialKey,this.geometryType,!0),this._writeGeometry(r,n,h,o,a),r.recordEnd()}_writeGeometry(r,n,o,a,h){if((0,P.pC)(this._markerPlacement))return this._writePlacedMarkers(r,n,a,h);if(this._allowBorrowing=!0,!h&&"esriGeometryPoint"===n.geometryType){const u=n.getX(),d=n.getY();return!r.hasAggregates&&r.hasPixelBufferEnabled&&(u<0||u>=513||d<0||d>=513)?void 0:this._writeVertices(r,o,this._getPos(u,d),u,d)}const c=h?(0,He.oB)((0,He.GH)(h),2):"esriGeometryPolygon"===n.geometryType?n.readCentroid():n.readGeometryForDisplay();if(!(0,P.Wi)(c)){if(c.isPoint){const[u,d]=c.coords;return!r.hasAggregates&&r.hasPixelBufferEnabled&&(u<0||u>=512||d<0||d>=512)?void 0:this._writeVertices(r,o,this._getPos(u,d),u,d)}c.forEachVertex((u,d)=>{const f=2*w.I_;u<-f||u>=f||d<-f||d>=f||this._writeVertices(r,o,this._getPos(u,d),u,d)})}}_writePlacedMarkers(r,n,o,a){const h=null!=a?a:n.readLegacyGeometryForDisplay(),c=Vi.getPlacement(h,(0,P.Wg)(this._markerPlacement),(0,W.F2)(1),r.tileKey,o.geometryEngine);if(!c)return;this._allowBorrowing="esriGeometryPolygon"!==n.geometryType;const u=n.getDisplayId(),d=(0,It.c)(),f=(0,Mt.c)();let g=c.next();for(;null!=g;){const p=g.tx,x=-g.ty;p>=-128&&p<=640&&x>=-128&&x<=640&&(this._applyTransformation(f,d,-g.getAngle()/Ui),this._writeVertices(r,u,this._getPos(p,x),p,x)),g=c.next()}}_writeVertices(r,n,o,a,h){const c=O.mE.load(this._materialKey);return c.symbologyType===k.mD.HEATMAP?this._writeHeatmapVertices(r,n,o):this._writeMarkerVertices(r,n,c,o,a,h)}_writeMarkerVertices(r,n,o,a,h,c){const u=o.vvRotation,d=r.vertexCount();let f=this._computedWidth*this._vertexBoundsScaleX,_=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const m=Math.max(f,_);f=m,_=m}if(u){const m=Math.max(this.xOffset,this.yOffset);f+=m,_+=m}this._allowBorrowing&&r.vertexBounds(h+this.xOffset,c-this.yOffset,f,_),r.vertexWrite(a),r.vertexWrite(this._offsetUpperLeft),r.vertexWrite(this._texUpperLeft),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetUpperRight),r.vertexWrite(this._texUpperRight),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetBottomLeft),r.vertexWrite(this._texBottomLeft),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetBottomRight),r.vertexWrite(this._texBottomRight),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),this._writeIndices(r,d)}_writeHeatmapVertices(r,n,o){const a=r.vertexCount();r.vertexWrite(o),r.vertexWrite(this._offsetUpperLeft),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetUpperRight),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetBottomLeft),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetBottomRight),r.vertexWrite(n),r.vertexEnd(),this._writeIndices(r,a)}_writeIndices(r,n){r.indexWrite(n+0),r.indexWrite(n+1),r.indexWrite(n+2),r.indexWrite(n+1),r.indexWrite(n+3),r.indexWrite(n+2)}_applyTransformation(r,n,o=0){(0,Ot.a)(r,(0,It.f)(this.xOffset,-this.yOffset)),null!=this.angle&&this.angle+o!==0&&(0,Ot.r)(r,r,Ui*(this.angle+o));const a=this._computedWidth,h=this._computedHeight,c=-(.5+this._anchorX)*a,u=-(.5-this._anchorY)*h;(0,te.s)(n,c,u),(0,te.t)(n,n,r),this._offsetUpperLeft=(0,T.UJ)(16*n[0],16*n[1]),this._offsets.xUpperLeft=n[0],this._offsets.yUpperLeft=n[1],(0,te.s)(n,c+a,u),(0,te.t)(n,n,r),this._offsetUpperRight=(0,T.UJ)(16*n[0],16*n[1]),this._offsets.xUpperRight=n[0],this._offsets.yUpperRight=n[1],(0,te.s)(n,c,u+h),(0,te.t)(n,n,r),this._offsetBottomLeft=(0,T.UJ)(16*n[0],16*n[1]),this._offsets.xBottomLeft=n[0],this._offsets.yBottomLeft=n[1],(0,te.s)(n,c+a,u+h),(0,te.t)(n,n,r),this._offsetBottomRight=(0,T.UJ)(16*n[0],16*n[1]),this._offsets.xBottomRight=n[0],this._offsets.yBottomRight=n[1]}_getPos(r,n){return(0,T.UJ)(Math.round(8*r),Math.round(8*n))}};class pe extends(Di(at)){constructor(r,n,o,a,h,c,u,d,f,_,m,g,p,x,y,M,v,b,C,z,V,F,G){super(),this.angle=a,this.height=u,this.width=c,this.xOffset=n*C,this.yOffset=o*C,this._markerPlacement=z,this._effects=V,this._anchorX=M,this._anchorY=v,this._minMaxZoom=(0,T.UJ)(Math.round(F*w.MI),Math.round(G*w.MI));const K=(x===H.v2.MAP?w.Tz:w.CQ)|(m?w.Uh:0)|(p?w.oK:0)|(g?w.e0:0),ce=y&&y.sdf,ee=O.mE.load(r);ee.sdf=ce,ee.pattern=!0,ee.textureBinding=y.textureBinding,this._materialKey=ee.data,this._fillColor=h,this._outlineColor=f,this._sizeOutlineWidth=(0,T.Jz)(Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*_),255)),Math.round(Math.min(Math.sqrt(128*d),255)));const ue=y.rect.x+w.fL,re=y.rect.y+w.fL,Te=ue+y.width,it=re+y.height;this._offsets.xUpperLeft=ue,this._offsets.yUpperLeft=re,this._offsets.xUpperRight=Te,this._offsets.yUpperRight=re,this._offsets.xBottomLeft=ue,this._offsets.yBottomLeft=it,this._offsets.xBottomRight=Te,this._offsets.yBottomRight=it,ee.symbologyType===k.mD.PIE_CHART?(this._texUpperLeft=(0,T.UJ)(0,1),this._texUpperRight=(0,T.UJ)(1,1),this._texBottomLeft=(0,T.UJ)(0,0),this._texBottomRight=(0,T.UJ)(1,0)):(this._texUpperLeft=(0,T.UJ)(ue,re),this._texUpperRight=(0,T.UJ)(Te,re),this._texBottomLeft=(0,T.UJ)(ue,it),this._texBottomRight=(0,T.UJ)(Te,it)),c*=b,u*=b,c*=C,u*=C;const Rs=Math.round(64*b);this._bitestAndDistRatio=(0,T.UJ)(K,Rs),this._computedWidth=c,this._computedHeight=u;const As=(0,It.c)(),ks=(0,Mt.c)();this._applyTransformation(ks,As)}static fromCIMMarker(r,n,o){const c=r.size,u=(n&&n.width||1)/(n&&n.height||1)*r.scaleX,d=r.scaleSymbolsProportionally&&r.frameHeight?c/r.frameHeight:1,f=(0,U.t2)(r.color),_=(0,U.t2)(r.outlineColor),m=(0,W.F2)(c),g=m*u,p=(0,W.F2)(r.offsetX||0),x=(0,W.F2)(r.offsetY||0),y=(0,W.F2)(r.outlineWidth||0)*d,M=r.alignment||H.v2.SCREEN,v=(0,W.F2)(r.referenceSize),[b,C]=We(r.scaleInfo,o);let z=r.rotation||0;r.rotateClockwise||(z=-z);let V=0,F=0;const G=r.anchorPoint;G&&(r.isAbsoluteAnchorPoint?c&&(V=G.x/(c*u),F=G.y/c):(V=G.x,F=G.y));const K=new pe(r.materialKey,p,x,z,f,g,m,v,_,y,r.colorLocked,r.scaleSymbolsProportionally,!1,M,n,V,F,r.sizeRatio,(0,P.Pt)(r.scaleFactor,1),r.markerPlacement,r.effects,b,C);return K._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/g:1,K._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/m:1,K}static fromPictureMarker(r,n){const o=Math.round((0,W.F2)(r.width)),a=Math.round((0,W.F2)(r.height)),h=w.ru,c=Math.round((0,W.F2)(r.xoffset||0)),u=Math.round((0,W.F2)(r.yoffset||0)),d=new pe(r.materialKey,c,u,r.angle,h,o,a,a,0,0,!1,!1,!1,H.v2.SCREEN,n,0,0,1,1,null,null,0,_e);return d._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/r.width:1,d._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/r.height:1,d}static fromSimpleMarker(r,n){const o=(0,U.aH)(r.color),a=Math.round((0,W.F2)(r.size)),h=a,c=Math.round((0,W.F2)(r.xoffset||0)),u=Math.round((0,W.F2)(r.yoffset||0)),d=r.style,f=r.outline,_=0|((null==f?void 0:f.color)&&(0,U.aH)(f.color)),m=0|((null==f?void 0:f.width)&&Math.round((0,W.F2)(f.width))),g=new pe(r.materialKey,c,u,r.angle,o,a,h,h,_,m,!1,!1,"esriSMSCross"===d||"esriSMSX"===d,H.v2.SCREEN,n,0,0,126/64,1,null,null,0,_e);return g.boundsType="esriSMSCircle"===d?"circle":"square",g._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/r.size:1,g._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/r.size:1,g}static fromLineSymbolMarker(r,n){const o=(0,U.aH)(r.color),h=Math.round((0,W.F2)(6*r.lineWidth)),c=h,u="cross"===r.style||"x"===r.style;let d;switch(r.placement){case"begin-end":d=H.Tx.Both;break;case"begin":d=H.Tx.JustBegin;break;case"end":d=H.Tx.JustEnd;break;default:d=H.Tx.None}const f={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:d,offsetAlongLine:0},_=new pe(r.materialKey,0,0,0,o,h,c,c/6,o,u?Math.round((0,W.F2)(r.lineWidth)):0,!1,!1,u,H.v2.MAP,n,0,0,126/64,1,f,null,0,_e);return _.boundsType="circle"===r.style?"circle":"square",_}}var $e=L(24837),Nt=L(43289),wt=(L(11915),L(13160)),Er=L(88071);function Fr(l,r,n,o,a,h,c){Ht=0;const u=(o-n)*h,d=a&&a.length,f=d?(a[0]-n)*h:u;let _,m,g,p,x,y=Zi(r,n,0,0,f,h,!0);if(y&&y.next!==y.prev){if(d&&(y=function Ar(l,r,n,o,a,h){const c=new Array;for(let u=0,d=o.length;u<d;u++){const f=Zi(l,r,0,o[u]*h,u<d-1?o[u+1]*h:n*h,h,!1);f===f.next&&(f.steiner=!0),c.push(Rr(f))}c.sort(Gr);for(const u of c)a=kr(u,a);return a}(r,n,o,a,y,h)),u>80*h){_=g=r[0+n*h],m=p=r[1+n*h];for(let M=h;M<f;M+=h){const v=r[M+n*h],b=r[M+1+n*h];_=Math.min(_,v),m=Math.min(m,b),g=Math.max(g,v),p=Math.max(p,b)}x=Math.max(g-_,p-m),x=0!==x?1/x:0}ht(y,l,h,_,m,x,c,0)}}function Zi(l,r,n,o,a,h,c){let u;if(c===function Zr(l,r,n,o,a,h){let c=0;for(let u=o,d=a-h;u<a;u+=h)c+=(l[d+r*h]-l[u+r*h])*(l[u+1+r*h]+l[d+1+r*h]),d=u;return c}(l,r,0,o,a,h)>0)for(let d=o;d<a;d+=h)u=Gi(d+r*h,l[d+r*h],l[d+1+r*h],u);else for(let d=a-h;d>=o;d-=h)u=Gi(d+r*h,l[d+r*h],l[d+1+r*h],u);return u&&Ve(u,u.next)&&(ct(u),u=u.next),u}function lt(l,r=l){if(!l)return l;let n,o=l;do{if(n=!1,o.steiner||!Ve(o,o.next)&&0!==j(o.prev,o,o.next))o=o.next;else{if(ct(o),o=r=o.prev,o===o.next)break;n=!0}}while(n||o!==r);return r}function ht(l,r,n,o,a,h,c,u){if(!l)return;!u&&h&&(l=Ki(l,o,a,h));let d=l;for(;l.prev!==l.next;){const f=l.prev,_=l.next;if(h?Br(l,o,a,h):Vr(l))r.push(f.index/n+c),r.push(l.index/n+c),r.push(_.index/n+c),ct(l),l=_.next,d=_.next;else if((l=_)===d){u?1===u?ht(l=Kr(l,r,n,c),r,n,o,a,h,c,2):2===u&&Nr(l,r,n,o,a,h,c):ht(lt(l),r,n,o,a,h,c,1);break}}}function Vr(l){const r=l.prev,n=l,o=l.next;if(j(r,n,o)>=0)return!1;let a=l.next.next;const h=a;let c=0;for(;a!==l.prev&&(0===c||a!==h);){if(c++,qe(r.x,r.y,n.x,n.y,o.x,o.y,a.x,a.y)&&j(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function Br(l,r,n,o){const a=l.prev,h=l,c=l.next;if(j(a,h,c)>=0)return!1;const f=a.x>h.x?a.x>c.x?a.x:c.x:h.x>c.x?h.x:c.x,_=a.y>h.y?a.y>c.y?a.y:c.y:h.y>c.y?h.y:c.y,m=Jt(a.x<h.x?a.x<c.x?a.x:c.x:h.x<c.x?h.x:c.x,a.y<h.y?a.y<c.y?a.y:c.y:h.y<c.y?h.y:c.y,r,n,o),g=Jt(f,_,r,n,o);let p=l.prevZ,x=l.nextZ;for(;p&&p.z>=m&&x&&x.z<=g;){if(p!==l.prev&&p!==l.next&&qe(a.x,a.y,h.x,h.y,c.x,c.y,p.x,p.y)&&j(p.prev,p,p.next)>=0||(p=p.prevZ,x!==l.prev&&x!==l.next&&qe(a.x,a.y,h.x,h.y,c.x,c.y,x.x,x.y)&&j(x.prev,x,x.next)>=0))return!1;x=x.nextZ}for(;p&&p.z>=m;){if(p!==l.prev&&p!==l.next&&qe(a.x,a.y,h.x,h.y,c.x,c.y,p.x,p.y)&&j(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;x&&x.z<=g;){if(x!==l.prev&&x!==l.next&&qe(a.x,a.y,h.x,h.y,c.x,c.y,x.x,x.y)&&j(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function Gi(l,r,n,o){const a=et.create(l,r,n);return o?(a.next=o.next,a.prev=o,o.next.prev=a,o.next=a):(a.prev=a,a.next=a),a}function ct(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function Rr(l){let r=l,n=l;do{(r.x<n.x||r.x===n.x&&r.y<n.y)&&(n=r),r=r.next}while(r!==l);return n}function kr(l,r){const n=function Ur(l,r){let n=r;const o=l.x,a=l.y;let h,c=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){const g=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(g<=o&&g>c){if(c=g,g===o){if(a===n.y)return n;if(a===n.next.y)return n.next}h=n.x<n.next.x?n:n.next}}n=n.next}while(n!==r);if(!h)return null;if(o===c)return h.prev;const u=h,d=h.x,f=h.y;let _,m=1/0;for(n=h.next;n!==u;)o>=n.x&&n.x>=d&&o!==n.x&&qe(a<f?o:c,a,d,f,a<f?c:o,a,n.x,n.y)&&(_=Math.abs(a-n.y)/(o-n.x),(_<m||_===m&&n.x>h.x)&&ut(n,l)&&(h=n,m=_)),n=n.next;return h}(l,r);if(!n)return r;const o=Ji(n,l);return lt(o,o.next),lt(n,n.next)}function Ki(l,r,n,o){let a;for(;a!==l;a=a.next){if(a=a||l,null===a.z&&(a.z=Jt(a.x,a.y,r,n,o)),a.prev.next!==a||a.next.prev!==a)return a.prev.next=a,a.next.prev=a,Ki(l,r,n,o);a.prevZ=a.prev,a.nextZ=a.next}return l.prevZ.nextZ=null,l.prevZ=null,function Or(l){let r,n=1;for(;;){let o,a=l;l=null,r=null;let h=0;for(;a;){h++,o=a;let c=0;for(;c<n&&o;c++)o=o.nextZ;let u=n;for(;c>0||u>0&&o;){let d;0===c?(d=o,o=o.nextZ,u--):0!==u&&o?a.z<=o.z?(d=a,a=a.nextZ,c--):(d=o,o=o.nextZ,u--):(d=a,a=a.nextZ,c--),r?r.nextZ=d:l=d,d.prevZ=r,r=d}a=o}if(r.nextZ=null,n*=2,h<2)return l}}(l)}function j(l,r,n){return(r.y-l.y)*(n.x-r.x)-(r.x-l.x)*(n.y-r.y)}function Ni(l,r,n,o){return!!(Ve(l,r)&&Ve(n,o)||Ve(l,o)&&Ve(n,r))||j(l,r,n)>0!=j(l,r,o)>0&&j(n,o,l)>0!=j(n,o,r)>0}function qe(l,r,n,o,a,h,c,u){return(a-c)*(r-u)-(l-c)*(h-u)>=0&&(l-c)*(o-u)-(n-c)*(r-u)>=0&&(n-c)*(h-u)-(a-c)*(o-u)>=0}function ut(l,r){return j(l.prev,l,l.next)<0?j(l,r,l.next)>=0&&j(l,l.prev,r)>=0:j(l,r,l.prev)<0||j(l,l.next,r)<0}function Jt(l,r,n,o,a){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-n)*a)|l<<8))|l<<4))|l<<2))|l<<1))|(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-o)*a)|r<<8))|r<<4))|r<<2))|r<<1))<<1}function Ve(l,r){return l.x===r.x&&l.y===r.y}function Gr(l,r){return l.x-r.x}function Kr(l,r,n,o){let a=l;do{const h=a.prev,c=a.next.next;!Ve(h,c)&&Ni(h,a,a.next,c)&&ut(h,c)&&ut(c,h)&&(r.push(h.index/n+o),r.push(a.index/n+o),r.push(c.index/n+o),ct(a),ct(a.next),a=l=c),a=a.next}while(a!==l);return a}function Nr(l,r,n,o,a,h,c){let u=l;do{let d=u.next.next;for(;d!==u.prev;){if(u.index!==d.index&&Jr(u,d)){let f=Ji(u,d);return u=lt(u,u.next),f=lt(f,f.next),ht(u,r,n,o,a,h,c,0),void ht(f,r,n,o,a,h,c,0)}d=d.next}u=u.next}while(u!==l)}function Jr(l,r){return l.next.index!==r.index&&l.prev.index!==r.index&&!function Dr(l,r){let n=l;do{if(n.index!==l.index&&n.next.index!==l.index&&n.index!==r.index&&n.next.index!==r.index&&Ni(n,n.next,l,r))return!0;n=n.next}while(n!==l);return!1}(l,r)&&ut(l,r)&&ut(r,l)&&function Xr(l,r){let n=l,o=!1;const a=(l.x+r.x)/2,h=(l.y+r.y)/2;do{n.y>h!=n.next.y>h&&n.next.y!==n.y&&a<(n.next.x-n.x)*(h-n.y)/(n.next.y-n.y)+n.x&&(o=!o),n=n.next}while(n!==l);return o}(l,r)}function Ji(l,r){const n=et.create(l.index,l.x,l.y),o=et.create(r.index,r.x,r.y),a=l.next,h=r.prev;return l.next=r,r.prev=l,n.next=a,a.prev=n,o.next=n,n.prev=o,h.next=o,o.prev=h,o}class et{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(r,n,o){const a=Ht<Xt.length?Xt[Ht++]:new et;return a.index=r,a.x=n,a.y=o,a.prev=null,a.next=null,a.z=null,a.prevZ=null,a.nextZ=null,a.steiner=!1,a}}const Xt=new Array;let Ht=0;for(let l=0;l<8096;l++)Xt.push(new et);const Be=new wt.bN(0,0,0,1,0),jt=new wt.bN(0,0,0,1,0);function Yt(l,r,n){let o=0;for(let a=1;a<n;a++)o+=(l[2*(r+a)]-l[2*(r+a-1)])*(l[2*(r+a)+1]+l[2*(r+a-1)+1]);return o}function Yr(l,r,n,o,a){let h=0;for(let u=n;u<o;u+=3){const d=2*(l[u]-a),f=2*(l[u+1]-a),_=2*(l[u+2]-a);h+=Math.abs((r[d]-r[_])*(r[f+1]-r[d+1])-(r[d]-r[f])*(r[_+1]-r[d+1]))}return h}Be.setExtent(w.I_),jt.setExtent(w.I_);var is=L(46519);const $=16,Hi=l=>class extends l{constructor(...r){super(...r),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=k.LW.LINE}writeGeometry(r,n,o,a){this._writeGeometry(r,n,o,a)}_initializeTessellator(r){const n=O.a.load(this._materialKey),o=O.dk.load(this._materialKey),a=this._tessellationOptions,c=this.tessellationProperties._halfWidth<w.tQ&&!r&&!(n.vvSizeFieldStops||n.vvSizeMinMaxValue||n.vvSizeScaleStops||n.vvSizeUnitValue);this.tessellationProperties.minMaxZoom=this._minMaxZoom,a.wrapDistance=65535,a.textured=this._isDashed||this._hasPattern,a.offset=this.tessellationProperties.offset,a.halfWidth=this.tessellationProperties._halfWidth;const u=c?0:1,d=(0,O.CA)(o)?ss:rs;this._lineTessellator=new is.z(d(this.tessellationProperties,u,u),ns(this.tessellationProperties),c)}_write(r,n,o,a){const h="esriGeometryPoint"===n.geometryType;r.recordStart(n.getDisplayId(),this._materialKey,this.geometryType,h),this._writeGeometry(r,n,a,h),r.recordEnd()}_writeGeometry(r,n,o,a){const h=null!=o?o:n.readLegacyGeometryForDisplay(),c=this._getLines(h,a);(0,P.Wi)(c)||this._writeVertices(r,n,c)}_getLines(r,n){if((0,P.Wi)(r))return null;const o=r.paths||r.rings;return(0,P.Wi)(o)?null:function ts(l,r){jt.setPixelMargin(r);const n=jt,o=-r,a=w.I_+r;let h=[],c=!1,u=0;for(;u<l.length;){const d=[],f=l[u];if(!f)return null;n.reset(wt.Vl.LineString);let[_,m]=f[0];if(c)n.moveTo(_,m);else{if(_<o||_>a||m<o||m>a){c=!0;continue}d.push({x:_,y:m})}let g=!1;const p=f.length;for(let x=1;x<p;++x)if(_+=f[x][0],m+=f[x][1],c)n.lineTo(_,m);else{if(_<o||_>a||m<o||m>a){g=!0;break}d.push({x:_,y:m})}if(g)c=!0;else{if(c){const x=n.resultWithStarts();if(x)for(const y of x)h.push(y)}else h.push({line:d,start:0});u++,c=!1}}return h=h.filter(d=>d.line.length>1),0===h.length?null:h}(o,n?256:16)}_writeVertices(r,n,o){const a=n.getDisplayId(),h=r.vertexCount(),c=this.tessellationProperties,u=this._tessellationOptions;c.out=r,c.id=a,c.indexCount=0,c.vertexCount=0,c.offset=h,u.capType=this._capType,u.joinType=this._joinType;const d=O.dk.load(this._materialKey);this.tessellationProperties.key=(0,O.CA)(d)?d:O.a.load(this._materialKey);for(const{line:f,start:_}of o)u.initialDistance=_%65535,this._lineTessellator.tessellate(f,u)}},rs=(l,r,n)=>(o,a,h,c,u,d,f,_,m,g,p)=>{const x=(0,T.UJ)(p,Math.ceil($*l._halfWidth)),y=(0,T.Jz)(Math.round($*f),Math.round($*_),Math.round($*m),Math.round($*g)),M=(0,T.Jz)($*u,$*d,0,l._bitset),v=l.out;return v.vertexBounds(o,a,r,n),v.vertexWrite((0,T.UJ)(8*o,8*a)),v.vertexWrite(l.id),v.vertexWrite(l._fillColor),v.vertexWrite(y),v.vertexWrite(x),v.vertexWrite(l._tl),v.vertexWrite(l._br),v.vertexWrite(M),v.vertexWrite((0,T.UJ)(Math.ceil($*l._halfReferenceWidth),0)),v.vertexWrite(l.minMaxZoom),v.vertexEnd(),l.offset+l.vertexCount++},ss=(l,r,n)=>(o,a,h,c,u,d,f,_,m,g,p)=>{const x=(0,T.UJ)($*l._halfWidth,$*l._halfReferenceWidth),y=(0,T.Jz)($*f+128,$*_+128,$*m+128,$*g+128),M=l.out,v=l._bitset<<24|l.id;M.vertexBounds(o,a,r,n),M.vertexWrite((0,T.UJ)(8*o,8*a)),M.vertexWrite(v),M.vertexWrite(l._fillColor);const b=(0,O.Xp)(l.key);return b||(M.vertexWrite(0),M.vertexWrite(0)),M.vertexWrite(0),M.vertexWrite(x),M.vertexWrite(y),b||M.vertexWrite(l.minMaxZoom),M.vertexEnd(),l.offset+l.vertexCount++},ns=l=>(r,n,o)=>{const a=l.out;a.indexWrite(r),a.indexWrite(n),a.indexWrite(o),l.indexCount+=3};class Se extends(Hi(at)){constructor(r,n,o,a,h,c,u,d,f,_,m,g,p,x,y,M,v,b,C,z){super();const V=O.a.load(r);n&&(V.sdf=n.sdf,V.pattern=!0,V.textureBinding=n.textureBinding),this._capType=a,this._joinType=h,this._miterLimitCosine=Dt(c),this.tessellationProperties._fillColor=u,this.tessellationProperties._tl=d,this.tessellationProperties._br=f,this._hasPattern=_,this._isDashed=m,this._zOrder=v,this._effects=b,this._minMaxZoom=(0,T.UJ)(Math.round(C*w.MI),Math.round(z*w.MI)),this._materialKey=V.data,this.tessellationProperties._bitset=(p?w.Uh:0)|(x?w.SD:0)|(g?w._6:0)|(y?w.Iv:0),this.tessellationProperties._halfWidth=.5*o,this.tessellationProperties._halfReferenceWidth=.5*M,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(r,n,o){var ee,ue,re,Te;const a=r.color,h=r.scaleFactor||1,c=!!r.dashTemplate;let u=r.cap;c&&u===H.RL.ROUND&&(u=H.RL.SQUARE);const d=r.join,f=(0,W.F2)(r.width)*h,_=(0,W.F2)(r.referenceWidth),m=(0,W.F2)(r.miterLimit),g=a&&(0,U.t2)(a)||0,[p,x]=We(r.scaleInfo,o);if(!n)return new Se(r.materialKey,n,f,u,d,m,g,0,0,!1,c,null!=(ee=r.scaleDash)&&ee,null!=(ue=r.colorLocked)&&ue,!1,r.sampleAlphaOnly,_,r.zOrder,r.effects,p,x);const{rect:M,width:v,height:b}=n,C=M.x+w.fL,z=M.y+w.fL,V=C+v,F=z+b,G=(0,T.UJ)(C,z),K=(0,T.UJ)(V,F);return new Se(r.materialKey,n,f,u,d,m,g,G,K,!0,c,null!=(re=r.scaleDash)&&re,null!=(Te=r.colorLocked)&&Te,!1,r.sampleAlphaOnly,_,r.zOrder,r.effects,p,x)}static fromFillOutline(r){var o;const n=O.dk.load(r.materialKey);return(0,O.CA)(n)&&r.outline&&"esriSLSSolid"===(null==(o=r.outline)?void 0:o.style)?Se.fromSimpleLine(se({hash:"",materialKey:r.materialKey},r.outline),null,!0):null}static fromSimpleLine(r,n,o=!1){const{color:a}=r,h="esriSLSSolid"!==r.style&&"esriSLSNull"!==r.style,c=(0,nt.ws)(r.cap||"round"),u=(0,nt.xV)(r.join||"round");let d=a&&"esriSLSNull"!==r.style&&(0,U.aH)(a)||0;"esriSLSNull"===r.style&&(d=0);const f=(0,W.F2)(r.width),_=r.miterLimit;if(!n)return new Se(r.materialKey,n,f,c,u,_,d,0,0,!1,h,!0,!1,o,!1,f,0,null,0,_e);const{rect:m,width:g,height:p}=n,x=m.x+w.fL,y=m.y+w.fL,M=x+g,v=y+p,b=(0,T.UJ)(x,y),C=(0,T.UJ)(M,v);return new Se(r.materialKey,n,f,c,u,_,d,b,C,!0,h,!0,!1,o,!1,f,0,null,0,_e)}static fromPictureLineSymbol(r,n,o,a){return xe.Z.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const Yi=l=>class extends l{constructor(...r){super(...r),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=k.LW.FILL}_maybeAddLineTemplate(r){this._lineTemplate=Se.fromFillOutline(r)}_write(r,n,o,a){const h="esriGeometryPoint"===n.geometryType,c=O.dk.load(this._materialKey);r.recordStart(n.getDisplayId(),this._materialKey,this.geometryType,h),this._writeGeometry(r,n,c,a,h),(0,O.CA)(c)&&(0,P.pC)(this._lineTemplate)&&this._lineTemplate.writeGeometry(r,n,a,h),r.recordEnd()}_writeGeometry(r,n,o,a,h){const c=this._getGeometry(n,a,h);if((0,P.Wi)(c))return;const u=[];if(!(c.maxLength>100)&&!this.forceLibtess&&function Qr(l,r){const{coords:n,lengths:o,hasIndeterminateRingOrder:a}=r,c=l;if(a)return!1;let u=0;for(let d=0;d<o.length;){let f=d,_=o[d],m=Yt(n,u,_);const g=[];for(;++f<o.length;){const M=o[f],v=Yt(n,u+_,M);if(!(v>0))break;m+=v,g.push(u+_),_+=M}const p=c.length;Fr(c,n,u,u+_,g,2,0);const x=Yr(c,n,p,c.length,0),y=Math.abs(m);if(Math.abs((x-y)/Math.max(1e-7,y))>1e-5)return c.length=0,!1;d=f,u+=_}return!0}(u,c))return void(u.length&&this._writeVertices(r,n,c.coords,c.lengths,o,u));const d=function $r(l){const{coords:r,lengths:n}=l,{buffer:o}=(0,wi.b)(r,n);return o}(c);this._writeVertices(r,n,d,[d.length/2],o)}_writeVertex(r,n,o,a,h,c){const u=(0,T.UJ)(1*a,1*h);if(r.vertexBounds(a,h,0,0),r.vertexWrite(u),r.vertexWrite(n),o.symbologyType===k.mD.DOT_DENSITY)r.vertexWriteF32(1/Math.abs(c.readGeometryArea()));else{r.vertexWrite(this.fillColor);const d=(0,O.Xp)(o);d||(r.vertexWrite(this.tl),r.vertexWrite(this.br)),r.vertexWrite(this.aux21),r.vertexWrite(this.aux22),r.vertexWrite(this.aux3),d||r.vertexWrite(this._minMaxZoom)}}_writeVertices(r,n,o,a,h,c){const u=n.getDisplayId(),d=this._bitset<<24|u,f=a.reduce((p,x)=>p+x),_=(0,nt.$_)(h.geometryType,h.symbologyType).geometry/4,m=r.vertexCount();r.vertexEnsureSize(_*f);let g=0;if(c)for(const p of c)this._writeVertex(r,d,h,o[2*p],o[2*p+1],n),g++;else for(let p=0;p<o.length;p+=2){const x=Math.round(o[p]),y=Math.round(o[p+1]);this._writeVertex(r,d,h,x,y,n),g++}r.indexEnsureSize(g);for(let p=0;p<g;p++)r.indexWrite(p+m)}_getGeometry(r,n,o){const a=n?(0,He.oB)((0,He.GH)(n),2):r.readGeometryForDisplay();return a?function es(l,r){if((0,P.Wi)(l))return null;if(!function qr(l,r,n){let o=0;for(let a=0;a<l.lengths.length;a++){const h=l.lengths[a];for(let c=0;c<h;c++){const u=l.coords[2*(c+o)],d=l.coords[2*(c+o)+1];if(u<r||u>n||d<r||d>n)return!0}o+=h}return!1}(l,-128,w.I_+128))return l;Be.setPixelMargin(r),Be.reset(wt.Vl.Polygon);let n=0;for(let c=0;c<l.lengths.length;c++){const u=l.lengths[c];let d=l.coords[2*(0+n)],f=l.coords[2*(0+n)+1];Be.moveTo(d,f);for(let _=1;_<u;_++)d=l.coords[2*(_+n)],f=l.coords[2*(_+n)+1],Be.lineTo(d,f);Be.close(),n+=u}const o=Be.result(!1);if(!o)return null;const a=[],h=[];for(const c of o){let u=0;for(const d of c)h.push(d.x),h.push(d.y),u++;a.push(u)}return new Er.Z(a,h)}(a,o?256:8):null}};var Qi=L(93678),zt=L(80991);const $i=xe.Z.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class Ct extends at{constructor(r){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=r}analyze(r,n,o,a,h){if(h&&0===h.length)return null;const c=h&&h.length>0,u=n.readLegacyFeature(),d=n.getObjectId(),f=this._materialCache,_=this._cimLayer.materialHash;if(!_)return $i.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const m="function"==typeof _?_(u,o,a,d):_,g=f.get(m);if(null!=g)return Promise.resolve(g);const p=this._ongoingMaterialRequestMap.get(m);if(p)return p;const x=this._cimLayer,y=(0,Qi.S)(x.cim,this._cimLayer.materialOverrides);y.mosaicHash=m;const{type:M,url:v}=x,b={cim:y,type:M,mosaicHash:m,url:v,size:null,dashTemplate:null,text:null,fontName:null,objectId:d,animatedSymbolProperties:null};switch(M){case"marker":b.size=(0,zt.hf)(x.size,u,o,a),b.animatedSymbolProperties=(0,zt.hf)(x.animatedSymbolProperties,u,o,a);break;case"line":b.dashTemplate=x.dashTemplate;break;case"text":b.text=(0,zt.hf)(x.text,u,o,a),b.fontName=(0,zt.hf)(x.fontName,u,o,a)}const C=r.getMosaicItem(b,h).then(z=>(c||(this._ongoingMaterialRequestMap.delete(m),f.set(m,z)),z)).catch(z=>(this._ongoingMaterialRequestMap.delete(m),$i.error(".analyze()",z.message),null));return c||this._ongoingMaterialRequestMap.set(m,C),C}}function ie(l,r){if(l&&"name"in l){const n=l;return r&&r.error(new ge.Z(n.name,n.message,n.details)),!1}return!0}class Qt extends(Yi(Ct)){constructor(r,n,o){var _;if(super(r),this._minMaxZoom=(0,T.UJ)(Math.round(n*w.MI),Math.round(o*w.MI)),A(r.color))this._dynamicPropertyMap.set("fillColor",(g,p,x)=>{const y=r.color(g,p,x);return y&&(0,U.t2)(y)||0});else{const m=r.color;this.fillColor=m&&(0,U.t2)(m)||0}const a="CIMMarkerPlacementInsidePolygon"===(null==(_=r.cim.placement)?void 0:_.type)&&r.cim.placement.shiftOddRows?2:1,h=r.height;A(h)?this._dynamicPropertyMap.set("_height",(g,p,x)=>h(g,p,x)*a):this._height=(h||0)*a;const c=r.offsetX;A(c)?this._dynamicPropertyMap.set("_offsetX",(g,p,x)=>(0,W.F2)(c(g,p,x))):this._offsetX=(0,W.F2)(c||0);const u=r.offsetY;A(u)?this._dynamicPropertyMap.set("_offsetY",(g,p,x)=>(0,W.F2)(-u(g,p,x))):this._offsetY=(0,W.F2)(-u||0);const d=r.scaleX;A(d)?this._dynamicPropertyMap.set("_scaleX",d):this._scaleX=d||1;const f=r.angle;if(A(f)?this._dynamicPropertyMap.set("_angle",(g,p,x)=>(0,Nt.s5)(f(g,p,x))):this._angle=(0,Nt.s5)(f)||0,(0,P.pC)(r.effects)){const m=r.effects;A(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}this._cimFillLayer=r,this._bitset=(r.colorLocked?w.Uh:0)|(r.applyRandomOffset?w.jk:0)|(r.sampleAlphaOnly?w.Iv:0)|(r.hasUnresolvedReplacementColor?w.vw:0),this._fillMaterialKey=r.materialKey}static fromCIMFill(r,n){const[o,a]=We(r.scaleInfo,n);return new Qt(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature();this._dynamicPropertyMap.forEach((_,m)=>{this[m]=_(a,n,o)});const h=O.dk.load(this._fillMaterialKey),c=this._materialCache,u=(0,this._cimFillLayer.materialHash)(a,n,o),d=c.get(u);let f=null;if(d&&ie(d.spriteMosaicItem)&&(f=d.spriteMosaicItem),f){const{rect:_,width:m,height:g}=f,p=_.x+w.fL,x=_.y+w.fL,y=p+m,M=x+g;let v=Math.round((0,W.F2)(this._height));v<=0&&(v=M-x);let b=Math.round((0,W.F2)(this._height/g*m||0));b<=0&&(b=y-p);const C=this._scaleX,z=1;this.tl=(0,T.UJ)(p,x),this.br=(0,T.UJ)(y,M),this.aux21=(0,T.UJ)(b,v),this.aux22=(0,T.UJ)(this._offsetX,this._offsetY),this.aux3=(0,T.Jz)(128*C,128*z,this._angle,0),h.sdf=f.sdf,h.pattern=!0,h.textureBinding=f.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,h.sdf=!1,h.pattern=!1,h.textureBinding=0;this._materialKey=h.data}}class $t extends(Hi(Ct)){constructor(r,n,o){super(r),this._minMaxZoom=(0,T.UJ)(Math.round(n*w.MI),Math.round(o*w.MI)),this._cimLineLayer=r;let a=0;A(r.width)||(a=.5*(0,W.F2)(r.width)),this._dynamicPropertyMap.set("_halfWidth",(m,g,p)=>A(r.width)?.5*(0,W.F2)(r.width(m,g,p)):a),A(r.cap)?this._dynamicPropertyMap.set("_capType",r.cap):this._capType=r.cap,A(r.join)?this._dynamicPropertyMap.set("_joinType",r.join):this._joinType=r.join;const c=r.color;A(c)?this._dynamicPropertyMap.set("_fillColor",(g,p,x)=>(0,U.t2)(c(g,p,x))):this._fillColor=c&&(0,U.t2)(c)||0;const u=r.miterLimit;if(A(u)?this._dynamicPropertyMap.set("_miterLimitCosine",(g,p,x)=>Dt(u(g,p,x))):this._miterLimitCosine=Dt(u),(0,P.pC)(r.effects)){const m=r.effects;A(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}this._scaleFactor=r.scaleFactor||1,this._isDashed=null!=r.dashTemplate,this.tessellationProperties._bitset=(r.colorLocked?w.Uh:0)|(r.scaleDash?w._6:0)|(r.sampleAlphaOnly?w.Iv:0),this._materialKey=r.materialKey,this._initializeTessellator(!0)}static fromCIMLine(r,n){const[o,a]=We(r.scaleInfo,n);return new $t(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature();this._dynamicPropertyMap.forEach((_,m)=>{this[m]=_(a,n,o)}),this._halfWidth*=this._scaleFactor;const h=this._materialCache,c=(0,this._cimLineLayer.materialHash)(a,n,o),u=h.get(c);let d=null;if(u&&ie(u.spriteMosaicItem)&&(d=u.spriteMosaicItem),d){this._hasPattern=!0;const{rect:_,width:m,height:g}=d,p=_.x+w.fL,x=_.y+w.fL,y=p+m,M=x+g;this.tessellationProperties._tl=(0,T.UJ)(p,x),this.tessellationProperties._br=(0,T.UJ)(y,M)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const f=O.a.load(this._materialKey);d&&(f.sdf=d.sdf,f.pattern=!0,f.textureBinding=d.textureBinding),this._materialKey=f.data}}const as=(0,It.c)(),ls=(0,Mt.c)();class qt extends(Di(Ct)){constructor(r,n,o){super(r),this._cimMarkerLayer=r,this._minMaxZoom=(0,T.UJ)(Math.round(n*w.MI),Math.round(o*w.MI));const a=r.color;A(a)?this._dynamicPropertyMap.set("_fillColor",(p,x,y)=>(0,U.t2)(a(p,x,y))):this._fillColor=(0,U.t2)(a);const h=r.outlineColor;A(h)?this._dynamicPropertyMap.set("_outlineColor",(p,x,y)=>(0,U.t2)(h(p,x,y))):this._outlineColor=(0,U.t2)(h);const c=r.size;A(c)?this._dynamicPropertyMap.set("_size",(p,x,y)=>(0,W.F2)(c(p,x,y))):this._size=(0,W.F2)(c)||0;const u=r.scaleX;A(u)?this._dynamicPropertyMap.set("_scaleX",u):this._scaleX=u;const d=r.offsetX;A(d)?this._dynamicPropertyMap.set("xOffset",(p,x,y)=>(0,W.F2)(d(p,x,y))):this.xOffset=(0,W.F2)(d)||0;const f=r.offsetY;A(f)?this._dynamicPropertyMap.set("yOffset",(p,x,y)=>(0,W.F2)(f(p,x,y))):this.yOffset=(0,W.F2)(f)||0;const _=r.outlineWidth;A(_)?this._dynamicPropertyMap.set("_outlineWidth",(p,x,y)=>(0,W.F2)(_(p,x,y))):this._outlineWidth=(0,W.F2)(_)||0;const m=r.rotation;if(A(m)?this._dynamicPropertyMap.set("_angle",m):this._angle=m||0,(0,P.pC)(r.effects)){const g=r.effects;A(g)?this._dynamicPropertyMap.set("_effects",g):this._effects=g}if((0,P.pC)(r.markerPlacement)){const g=r.markerPlacement;A(g)?this._dynamicPropertyMap.set("_markerPlacement",g):this._markerPlacement=g}this._scaleFactor=(0,P.Pt)(r.scaleFactor,1),this._bitSet=(r.alignment===H.v2.MAP?1:0)|(r.colorLocked?1:0)<<1|(r.scaleSymbolsProportionally?1:0)<<3,this._materialKey=r.materialKey}static fromCIMMarker(r,n){const[o,a]=We(r.scaleInfo,n);return new qt(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature(),h=r.getObjectId();this._dynamicPropertyMap.forEach((Te,it)=>{this[it]=Te(a,n,o)});const c=this._cimMarkerLayer.materialHash,u="function"==typeof c?c(a,n,o,h):c,d=this._materialCache.get(u);if(!d||!ie(d.spriteMosaicItem)||!d.spriteMosaicItem)return void xe.Z.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new ge.Z("mapview-cim","Encountered an error when binding feature"));const f=d.spriteMosaicItem,_=this._cimMarkerLayer.sizeRatio,m=f.width/f.height*this._scaleX,g=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let p=this._size,x=p*m;const y=this.xOffset,M=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const v=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/(0,W.F2)(this._cimMarkerLayer.frameHeight):1,b=this._outlineWidth*v,C=(0,W.F2)(this._cimMarkerLayer.referenceSize);let z=0,V=0;const F=this._cimMarkerLayer.anchorPoint;F&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(z=(0,W.F2)(F.x)/(this._size*m),V=(0,W.F2)(F.y)/this._size):(z=F.x,V=F.y)),this._anchorX=z,this._anchorY=V,this._sizeOutlineWidth=(0,T.Jz)(Math.round(Math.min(Math.sqrt(128*x),255)),Math.round(Math.min(Math.sqrt(128*p),255)),Math.round(Math.min(Math.sqrt(128*b),255)),Math.round(Math.min(Math.sqrt(128*C),255))),this.angle=g;const G=Math.round(64*_);this._bitestAndDistRatio=(0,T.UJ)(this._bitSet,G);const K=f.rect.x+w.fL,ce=f.rect.y+w.fL,ee=K+f.width,ue=ce+f.height;this._texUpperLeft=(0,T.UJ)(K,ce),this._texUpperRight=(0,T.UJ)(ee,ce),this._texBottomLeft=(0,T.UJ)(K,ue),this._texBottomRight=(0,T.UJ)(ee,ue);const re=O.mE.load(this._materialKey);re.sdf=f.sdf,re.pattern=!0,re.textureBinding=f.textureBinding,this._materialKey=re.data,x*=_,p*=_,x*=this._scaleFactor,p*=this._scaleFactor,x*=f.rect.width/f.width,p*=f.rect.height/f.height,this._computedWidth=x,this._computedHeight=p,this._applyTransformation(ls,as),this.xOffset=y,this.yOffset=M}}function ei(l){if(null==l)return[];const r=new Array(l.length);for(let n=0;n<l.length;n++)r[n]=l.charCodeAt(n);return r}class ti extends(Ai(Ct)){constructor(r,n,o){super(r),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=(0,T.UJ)(Math.round(n*w.MI),Math.round(o*w.MI));const a=r.scaleFactor||1;this._cimTextLayer=r;const h=r.color;A(h)?this._dynamicPropertyMap.set("_color",(M,v,b)=>(0,U.t2)(h(M,v,b))):this._color=(0,U.t2)(h);const c=r.outlineColor;let u,f,m;if(A(c)?this._dynamicPropertyMap.set("_haloColor",(M,v,b)=>(0,U.t2)(c(M,v,b))):this._haloColor=(0,U.t2)(c),A(r.size)||(u=Math.min(Math.round((0,W.F2)(r.size*r.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",(y,M,v)=>A(r.size)?Math.min(Math.round((0,W.F2)(r.size(y,M,v)*r.sizeRatio)),127):u),A(r.outlineSize)?this._dynamicPropertyMap.set("_haloSize",(M,v,b)=>Math.min(Math.floor(5*(0,W.F2)(r.outlineSize(M,v,b)*r.sizeRatio)),127)):this._haloSize=Math.min(Math.floor(5*(0,W.F2)(r.outlineSize*r.sizeRatio)),127),A(r.offsetX)||(f=Math.round((0,W.F2)(r.offsetX*r.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",(y,M,v)=>A(r.offsetX)?Math.round((0,W.F2)(r.offsetX(y,M,v)*r.sizeRatio)):f),A(r.offsetY)||(m=Math.round((0,W.F2)(r.offsetY*r.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",(y,M,v)=>A(r.offsetY)?Math.round((0,W.F2)(r.offsetY(y,M,v)*r.sizeRatio)):m),A(r.angle)?this._dynamicPropertyMap.set("_angle",r.angle):this._angle=r.angle,A(r.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",r.horizontalAlignment):this._horizontalAlignment=r.horizontalAlignment,A(r.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",r.verticalAlignment):this._verticalAlignment=r.verticalAlignment,(0,P.pC)(r.effects)){const y=r.effects;A(y)?this._dynamicPropertyMap.set("_effects",y):this._effects=y}if((0,P.pC)(r.markerPlacement)){const y=r.markerPlacement;A(y)?this._dynamicPropertyMap.set("_markerPlacement",y):this._textPlacement=y}A(r.text)?this._dynamicPropertyMap.set("_text",r.text):this._text=r.text,this._backgroundColor=r.backgroundColor&&(0,U.t2)(r.backgroundColor),this._borderLineColor=r.borderLineColor&&(0,U.t2)(r.borderLineColor),this._borderLineSize=r.borderLineWidth,this._scaleFactor=a;const p=Math.min(Math.round((0,W.F2)(r.referenceSize*r.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*p)),this._materialKey=r.materialKey;const x=O.qr.load(this._materialKey);x.sdf=!0,this._bitset=(r.alignment===H.v2.MAP?1:0)|(r.colorLocked?1:0)<<1,this._materialKey=x.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(r,n){const[o,a]=We(r.scaleInfo,n);return new ti(r,o,a)}analyze(r,n,o,a){var h=()=>super.analyze,c=this;return(0,B.Z)(function*(){const u=n.readLegacyFeature(),d=function hs(l,r,n,o){var a;return"string"==typeof l.text?l.text:"function"==typeof l.text&&null!=(a=l.text(r,n,o))?a:""}(c._cimTextLayer,u,o,a),f=yield h().call(c,r,n,o,a,ei(d));return f&&f.glyphMosaicItems&&c._textToGlyphs.set(d,f.glyphMosaicItems),f})()}bindFeature(r,n,o){var c;const a=r.readLegacyFeature();if(this._dynamicPropertyMap.forEach((u,d)=>{this[d]=u(a,n,o)}),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/w.Ex,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=(0,Me.kH)((0,P.Pt)(this._horizontalAlignment,"center")),this._yAlignD=(0,Me.b7)((0,P.Pt)(this._verticalAlignment,"baseline"));const h=null!=(c=this._textToGlyphs.get(this._text))?c:[];this.bindTextInfo(h,!1)}}class be extends(Yi(at)){constructor(r,n,o,a,h,c,u,d,f,_,m,g,p,x,y,M){super(),this._effects=x;const v=O.dk.load(r);n&&(v.sdf=n.sdf,v.pattern=!0,v.textureBinding=n.textureBinding),this.fillColor=o,this.tl=a,this.br=h,this.aux21=(0,T.UJ)(c,u),this.aux22=(0,T.UJ)(d,f),this.aux3=(0,T.Jz)(_,m,g,0),this._bitset=p,this._minMaxZoom=(0,T.UJ)(Math.round(y*w.MI),Math.round(M*w.MI)),this._materialKey=v.data}static fromCIMFill(r,n,o){const a=r.color,h=a&&(0,U.t2)(a)||0,c=r.materialKey,[u,d]=We(r.scaleInfo,o),f=(r.colorLocked?w.Uh:0)|(r.applyRandomOffset?w.jk:0)|(r.sampleAlphaOnly?w.Iv:0)|(r.hasUnresolvedReplacementColor?w.vw:0);if(!n)return new be(c,null,h,0,0,0,0,0,0,0,0,0,f,r.effects,u,d);const{rect:_,width:m,height:g}=n,p=r.scaleX||1,x=_.x+w.fL,y=_.y+w.fL,M=x+m,v=y+g,b=(0,W.F2)(r.height);let C=p*b;"CIMHatchFill"===r.cim.type&&(C*=m/g);let z=Math.round(b);z<=0&&(z=v-y);let V=Math.round(C);V<=0&&(V=M-x);const F=(0,W.F2)(r.offsetX||0),G=(0,W.F2)(-r.offsetY||0),K=(0,T.UJ)(x,y),ce=(0,T.UJ)(M,v);return new be(c,n,h,K,ce,V,z,F,G,128,128,(0,Nt.s5)(r.angle),f,r.effects,u,d)}static fromSimpleFill(r,n,o=!1){const{color:a}=r,h=a&&"esriSFSNull"!==r.style&&(0,U.aH)(a)||0,c=o?w.Uh:0,u=r.materialKey;let d;if(n){const{rect:f,width:_,height:m,pixelRatio:g}=n,p=f.x+w.fL,x=f.y+w.fL,y=p+_,M=x+m,v=(0,T.UJ)(p,x),b=(0,T.UJ)(y,M);d=new be(u,n,h,v,b,_/g,m/g,0,0,128,128,0,c,null,0,_e)}else d=new be(u,null,h,0,0,0,0,0,0,0,0,0,c,null,0,_e);return d._maybeAddLineTemplate(r),d}static fromPictureFill(r,n,o=!1){const a=w.ru,{rect:h,width:c,height:u}=n,d=h.x+w.fL,f=h.y+w.fL,_=d+c,m=f+u,g=(0,T.UJ)(d,f),p=(0,T.UJ)(_,m),x=Math.round((0,W.F2)(r.width)),y=Math.round((0,W.F2)(r.height)),M=(0,W.F2)(r.xoffset),v=(0,W.F2)(-r.yoffset),z=new be(r.materialKey,n,a,g,p,x,y,M,v,128*r.xscale,128*r.yscale,0,o?w.Uh:0,null,0,_e);return z._maybeAddLineTemplate(r),z}}class cs{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){var r=this;return(0,B.Z)(function*(){r._resolver?(yield r._resolver.promise,yield r.acquire()):r._resolver=(0,X.hh)()})()}release(){const r=this._resolver;this._resolver=null,null==r||r.resolve()}}function ii(){return(ii=(0,B.Z)(function*(l,r,n){try{yield l.acquire(),yield r(n),l.release()}catch(o){throw l.release(),o}})).apply(this,arguments)}const ds={marker:k.LW.MARKER,fill:k.LW.FILL,line:k.LW.LINE,text:k.LW.TEXT};class fs{constructor(r,n,o,a){const h={minScale:null==n?void 0:n.minScale,maxScale:null==n?void 0:n.maxScale},c=function ms(l){return l.minScale||l.maxScale?l.minScale+"-"+l.maxScale:""}(h);this.layers=r,this.data=n,this.hash=this._createHash()+c,this.rendererKey=o;const u={isOutline:!1,placement:null,symbologyType:k.mD.DEFAULT,vvFlags:o};for(const d of r){const f=ds[d.type];u.isOutline="line"===d.type&&d.isOutline,d.materialKey=(0,O.jj)(f,u),d.maxVVSize=a,d.scaleInfo=h,d.templateHash+=c}}get type(){return"expanded-cim"}_createHash(){let r="";for(const n of this.layers)r+=n.templateHash;return r}}var tr=L(83100),_s=L(21726),ps=L(84687),ys=L(29840),Re=L(71937);function gs(l,r,n){return ri.apply(this,arguments)}function ri(){return(ri=(0,B.Z)(function*(l,r,n){if(!l.name)throw new ge.Z("style-symbol-reference-name-missing","Missing name in style symbol reference");if(l.styleName&&"Esri2DPointSymbolsStyle"===l.styleName)return xs(l,n);try{return vs(yield(0,Re.n2)(l,r,n),l.name,r,n)}catch(o){return(0,X.k_)(o),null}})).apply(this,arguments)}function xs(l,r){return si.apply(this,arguments)}function si(){return(si=(0,B.Z)(function*(l,r){const n=Re.wm.replace(/\{SymbolName\}/gi,l.name);try{const o=yield(0,Re.EJ)(n,r);return(0,Re.KV)(o.data)}catch(o){return(0,X.k_)(o),null}})).apply(this,arguments)}function vs(l,r,n,o){return ni.apply(this,arguments)}function ni(){return(ni=(0,B.Z)(function*(l,r,n,o){const a=l.data,h={portal:n&&(0,P.pC)(n.portal)?n.portal:ps.Z.getDefault(),url:(0,_s.mN)(l.baseUrl),origin:"portal-item"},c=a.items.find(d=>d.name===r);if(!c)throw new ge.Z("symbolstyleutils:symbol-name-not-found",`The symbol name '${r}' could not be found`,{symbolName:r});let u=(0,ys.f)((0,Re.v9)(c,"cimRef"),h);(0,tr.XO)()&&(u=(0,tr.pJ)(u));try{const d=yield(0,Re.EJ)(u,o);return(0,Re.KV)(d.data)}catch(d){return(0,X.k_)(d),null}})).apply(this,arguments)}const ir=function(){var l=(0,B.Z)(function*(r,n,o){return new fs(yield(0,Qi.c)(r.data,n,o),r.data,r.rendererKey,r.maxVVSize)});return function(n,o,a){return l.apply(this,arguments)}}();function ye(l,r,n,o){return oi.apply(this,arguments)}function oi(){return(oi=(0,B.Z)(function*(l,r,n,o){var a;if(!l)return null;if("cim"===l.type)return ir(l,r,n);if("web-style"===l.type){const h={type:"cim",data:null!=(a=yield gs(l,null,o))?a:void 0,rendererKey:l.rendererKey,maxVVSize:l.maxVVSize};return ir(h,r,n)}return l})).apply(this,arguments)}function Pt(l){if(!l)return null;const{avoidSDFRasterization:r,type:n,cim:o,url:a,materialHash:h}=l,c={cim:o,type:n,mosaicHash:h,url:a,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:r};switch(n){case"marker":c.size=l.size,c.path=l.path,c.animatedSymbolProperties=l.animatedSymbolProperties;break;case"line":c.dashTemplate=l.dashTemplate;break;case"text":c.text=l.text,c.fontName=l.fontName}return c}const q=xe.Z.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),rr={sortKey:null,templates:new Array},ai={isOutline:!1,placement:null,symbologyType:k.mD.DEFAULT,vvFlags:0},Ms=de(se({},$e.eG),{hash:JSON.stringify($e.eG),materialKey:(0,O.jj)(k.LW.MARKER,ai)}),Ss=de(se({},$e.wW),{hash:JSON.stringify($e.wW),materialKey:(0,O.jj)(k.LW.LINE,ai)}),bs=de(se({},$e.lj),{hash:JSON.stringify($e.lj),materialKey:(0,O.jj)(k.LW.FILL,ai)});function Le(l,r){const n=l.length;return l.push(null),r.then(o=>l[n]=o),l}function dt(l){return null!=l&&!!(1&l)}class Ts{constructor(r,n){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new cs,this._fetchResource=r,this._tileInfo=n}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(r,n,o=null){this._initErrorTemplates();const a=r.hash,h=this._symbolToTemplate.get(a);if(null!=h)return h;const c=new Array,u={sortKey:o,templates:c};n&&this._createMeshTemplates(c,n,!0),this._createMeshTemplates(c,r,!1);const d=this._createGroupId("expanded-cim"===r.type&&Is(r));return this._idToTemplateGroup.set(d,u),this._symbolToTemplate.set(a,d),d}getTemplateGroup(r){var n;return null!=(n=this._idToTemplateGroup.get(r))?n:rr}getDynamicTemplateGroup(r){return this._idToTemplateGroup.has(r)?(dt(r)||q.error("mapview-template-store",`Id ${r} does not refer to a dynamic template`),this._idToTemplateGroup.get(r)):rr}getMosaicItem(r,n){const o=this._createTemplateId(),a=new Promise(h=>this._idToResolver.set(o,h));return this._fetchQueue.push({symbol:r,id:o,glyphIds:n}),a}finalize(r){return this._fetchQueue.length||this._lock.isHeld()?function us(l,r,n){return ii.apply(this,arguments)}(this._lock,this._fetchAllQueuedResources.bind(this),r):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],bs,!1),marker:this._createMeshTemplates([],Ms,!1),line:this._createMeshTemplates([],Ss,!1)})}_fetchAllQueuedResources(r){if(!this._fetchQueue.length)return Promise.resolve();const n=this._fetchQueue,o=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(o).then(()=>this._fetchResource(n,r).then(a=>{for(const{id:h,mosaicItem:c}of a)this._idToResolver.get(h)(c),this._idToResolver.delete(h)})).catch(a=>{(0,X.D_)(a)?this._fetchQueue=this._fetchQueue.concat(n):function Ls(l){return"worker:port-closed"===l.name}(a)||q.error(new ge.Z("mapview-template-store","Unable to fetch requested texture resources",a))})}_createGroupId(r){return this._idCounter++<<1|(r?1:0)}_createTemplateId(){return this._templateIdCounter++}_createSMS(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return ie(o,q)?pe.fromSimpleMarker(r,o):n._markerError})()}_createPMS(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return ie(o,q)?pe.fromPictureMarker(r,o):n._markerError})()}_createSFS(r,n){var o=this;return(0,B.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return ie(a,q)?be.fromSimpleFill(r,a,n):o._fillError})()}_createPFS(r,n){var o=this;return(0,B.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return ie(a,q)?be.fromPictureFill(r,a,n):o._fillError})()}_createSLS(r,n){var o=this;return(0,B.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return ie(a,q)?Se.fromSimpleLine(r,a):o._lineError})()}_createLMS(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return ie(o,q)?pe.fromLineSymbolMarker(r,o):n._markerError})()}_createTS(r){var n=this;return(0,B.Z)(function*(){const{glyphMosaicItems:o}=yield n.getMosaicItem(r);return Ye.fromText(r,null!=o?o:[])})()}_createCIMText(r){var n=this;return(0,B.Z)(function*(){const{glyphMosaicItems:o}=yield n.getMosaicItem(Pt(r),ei(r.text));return ie(o,q)?Ye.fromCIMText(r,o,n._tileInfo):n._textError})()}_createCIMFill(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(Pt(r));return ie(o,q)?be.fromCIMFill(r,o,n._tileInfo):n._fillError})()}_createCIMLine(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(Pt(r));return ie(o,q)?Se.fromCIMLine(r,o,n._tileInfo):n._lineError})()}_createCIMMarker(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(Pt(r));return ie(o,q)?pe.fromCIMMarker(r,o,n._tileInfo):n._markerError})()}_createCIM(r){var n=this;return(0,B.Z)(function*(){const o=r.templateHash;let a=n._cimTemplateCache.get(o);if(null!=a)return a;switch(r.type){case"marker":a=yield n._createCIMMarker(r);break;case"line":a=yield n._createCIMLine(r);break;case"fill":a=yield n._createCIMFill(r);break;case"text":a=yield n._createCIMText(r)}return n._cimTemplateCache.set(o,a),a})()}_createDynamicCIM(r){var n=this;return(0,B.Z)(function*(){const o=r.templateHash;let a=n._cimTemplateCache.get(o);if(null!=a)return a;switch(r.type){case"marker":a=qt.fromCIMMarker(r,n._tileInfo);break;case"line":a=$t.fromCIMLine(r,n._tileInfo);break;case"fill":a=Qt.fromCIMFill(r,n._tileInfo);break;case"text":a=ti.fromCIMText(r,n._tileInfo)}return n._cimTemplateCache.set(o,a),a})()}_createPrimitiveMeshTemplates(r,n,o){switch(n.type){case"esriSMS":return Le(r,this._createSMS(n));case"esriPMS":return Le(r,this._createPMS(n));case"esriSFS":return Le(r,this._createSFS(n,o));case"line-marker":return Le(r,this._createLMS(n));case"esriPFS":return Le(r,this._createPFS(n,o));case"esriSLS":return Le(r,this._createSLS(n,!1));case"esriTS":return Le(r,this._createTS(n));default:return q.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),r}}_createMeshTemplates(r,n,o){if(n.type.includes("3d"))return q.error("3D symbols are not supported with MapView"),r;if("expanded-cim"===n.type){for(const a of n.layers)Le(r,"function"==typeof a.materialHash?this._createDynamicCIM(a):this._createCIM(a));return r}if("composite-symbol"===n.type){for(const a of n.layers)this._createPrimitiveMeshTemplates(r,a,o);return r}return"cim"===n.type||"label"===n.type||"web-style"===n.type?r:this._createPrimitiveMeshTemplates(r,n,o)}}const Is=l=>{if(!l.layers)return!1;for(const r of l.layers)if("function"==typeof r.materialHash)return!0;return!1};class ws{constructor(r,n,o){this._loadPromise=(0,wi.j)(),this._geometryType=r,this._idField=n,this._templateStore=o}update(r,n){(0,P.pC)(r.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(r.mesh.labels,n)),this._schema=r}_createLabelTemplates(r,n){const o=new Map;if("simple"===r.type){for(const a of r.classes){const h=Tt.fromLabelClass(a,n);o.set(a.index,h)}return o}for(const a in r.classes){const h=r.classes[a];for(const c of h){const u=Tt.fromLabelClass(c,n);o.set(c.index,u)}}return o}get templates(){return this._templateStore}analyze(r,n,o,a,h,c,u){var d=this;return(0,B.Z)(function*(){if((0,X.Hc)(u))return;let f;"dictionary"===(null==o?void 0:o.type)&&(f=yield o.analyze(d._idField,r.copy(),n,h,c,u));let _=0;for(;r.next();){let m=null;if(m=f?f[_++]:(0,P.pC)(a)&&(0,Ue.nE)(r.getDisplayId())&&1!==r.readAttribute("cluster_count")?a.match(d._idField,r,d._geometryType,h,c):o.match(d._idField,r,d._geometryType,h,c),r.setGroupId(m),dt(m)){const g=d._templateStore.getDynamicTemplateGroup(m).templates;for(const p of g)p&&p.analyze&&p.analyze(d._templateStore,r,h,c)}}return yield d._loadPromise,d._templateStore.finalize(u)})()}analyzeGraphics(r,n,o,a,h,c){var u=this;return(0,B.Z)(function*(){if((0,X.Hc)(c))return;const d=r.getCursor();for(o&&(yield o.analyze(u._idField,d.copy(),n,a,h,c));d.next();){let f=d.getGroupId();if(null!=f&&-1!==f||(f=null==o?void 0:o.match(u._idField,d,d.geometryType,a,h),d.setGroupId(f)),dt(f)){const _=u._templateStore.getDynamicTemplateGroup(f).templates;for(const m of _)m&&m.analyze&&m.analyze(u._templateStore,d,a,h)}d.setGroupId(f)}return yield u._loadPromise,u._templateStore.finalize(c)})()}writeGraphic(r,n,o,a){const h=n.getGroupId(),c=n.getDisplayId(),u=this._templateStore.getTemplateGroup(h);if(r.featureStart(n.insertAfter,0),null!=c){if(dt(h))for(const d of u.templates)d&&d.bindFeature(n,null,null);if(u){for(const d of u.templates)d&&d.write(r,n,o,a);r.featureEnd()}}}writeCursor(r,n,o,a,h,c,u){const d=n.getGroupId(),f=n.getDisplayId(),_=this._templateStore.getTemplateGroup(d),m=_.templates,g=this._getSortKeyValue(n,_);if(r.featureStart(0,g),null!=f&&m){if(dt(d))for(const p of m)p.bindFeature(n,o,a);for(const p of m)p.write(r,n,h,u);if((0,P.pC)(c)&&r.hasRecords){const p=c&&this._findLabelRef(m);this._writeLabels(r,n,c,p,h,u)}r.featureEnd()}}_getSortKeyValue(r,n){const o=this._schema.mesh.sortKey;if((0,P.Wi)(o))return 0;let a=0;return a=!0===o.byRenderer&&null!=n.sortKey?n.sortKey:null!=o.fieldIndex?r.getComputedNumericAtIndex(o.fieldIndex):r.readAttribute(null!=o.field?o.field:this._idField),a*="asc"===o.order?1:-1,null==a||isNaN(a)?0:a}_findLabelRef(r){for(const n of r)if(n instanceof pe)return n;return null}_writeLabels(r,n,o,a,h,c){for(const u of o)if((0,P.pC)(u)&&u){const{glyphs:d,rtl:f,index:_}=u,m=this._labelTemplates.get(_);if(!m)continue;m.setZoomLevel(h),m.bindReferenceTemplate(a),m.bindTextInfo(d,f),m.write(r,n,null,c)}}}var Ws=L(93961),zs=L(46679),Cs=L(39236);const li=xe.Z.getLogger("esri/views/2d/engine/webgl/util/Matcher");function hi(l,r,n,o){return ci.apply(this,arguments)}function ci(){return(ci=(0,B.Z)(function*(l,r,n,o){switch(l.type){case"simple":case"heatmap":return Ce.fromBasicRenderer(l,r,n,o);case"map":return di.fromUVRenderer(l,r,n,o);case"interval":return ui.fromCBRenderer(l,r,n,o);case"dictionary":return pi.fromDictionaryRenderer(l,r,n,o);case"pie-chart":return Et.fromPieChartRenderer(l,r,n,o);case"subtype":return Et.fromSubtypes(l,r,n,o)}})).apply(this,arguments)}class Ce{constructor(){this.type="feature",this._defaultResult=null}static fromBasicRenderer(r,n,o,a){return(0,B.Z)(function*(){const h=new Ce;if(r.symbol){const c=yield ye(r.symbol,o,a),u=n.createTemplateGroup(c,null);h.setDefault(u)}return h})()}static fromPieChartRenderer(r,n,o,a){return(0,B.Z)(function*(){const h=new Ce;if(r.markerSymbol){const c=yield ye(r.markerSymbol,o,a);let u;r.fillSymbol&&(u=yield ye(r.fillSymbol,o,a));const d=n.createTemplateGroup(c,u);h.setDefault(d)}return h})()}size(){return 1}getDefault(){return this._defaultResult}setDefault(r){this._defaultResult=r}match(r,n,o,a,h){return this.getDefault()}analyze(r,n,o,a,h,c){return(0,B.Z)(function*(){return null})()}}class Et extends Ce{constructor(r,n){super(),this._subMatchers=r,this._subtypeField=n}static fromSubtypes(r,n,o,a){return(0,B.Z)(function*(){const h=new Map,c=[];for(const u in r.renderers){const d=parseInt(u,10),f=hi(r.renderers[u],n,o,a).then(_=>h.set(d,_));c.push(f)}return yield Promise.all(c),new Et(h,r.subtypeField)})()}match(r,n,o,a,h){const c=n.readAttribute(this._subtypeField),u=this._subMatchers.get(c);return u?u.match(r,n,o,a,h):null}}class ui extends Ce{constructor(r,n,o,a){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=n,this._fieldIndex=a,this._field=r,this._normalizationInfo=o}static fromCBRenderer(r,n,o,a){return(0,B.Z)(function*(){const{isMaxInclusive:h,normalizationField:c,normalizationTotal:u,normalizationType:d}=r,_=new ui(r.field,h,{normalizationField:c,normalizationTotal:u,normalizationType:d},r.fieldIndex),m=yield ye(r.backgroundFillSymbol,o,a);yield Promise.all(r.intervals.map(function(){var p=(0,B.Z)(function*(x){const y=yield ye(x.symbol,o,a),M=yield n.createTemplateGroup(y,m);_.add({min:x.min,max:x.max},M)});return function(x){return p.apply(this,arguments)}}()));const g=yield ye(r.defaultSymbol,o,a);if(g){const p=yield n.createTemplateGroup(g,m);_.setDefault(p)}return _})()}add(r,n){this._intervals.push({interval:r,result:n}),this._intervals.sort((o,a)=>o.interval.min-a.interval.min)}size(){return super.size()+this._intervals.length}match(r,n,o,a,h){if(null==this._fieldIndex&&!this._field)return this.getDefault();const c=null!=this._fieldIndex?n.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(n);if(null==c||isNaN(c)||c===1/0||c===-1/0)return this.getDefault();for(let u=0;u<this._intervals.length;u++){const{interval:d,result:f}=this._intervals[u],m=this._isMaxInclusive?c<=d.max:c<d.max;if(c>=d.min&&m)return f}return this.getDefault()}_needsNormalization(){const r=this._normalizationInfo;return r&&(r.normalizationField||r.normalizationTotal||r.normalizationType)}_getValueFromField(r){var u;const n=r.readAttribute(this._field);if(!this._needsNormalization()||null==n)return n;const{normalizationField:o,normalizationTotal:a,normalizationType:h}=this._normalizationInfo,c=null!=(u=r.readAttribute(o))?u:1;if(h)switch(h){case"esriNormalizeByField":return c?n/c:void 0;case"esriNormalizeByLog":return Math.log(n)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return n/a*100;default:return void li.error(`Found unknown normalization type: ${h}`)}else li.error("Normalization is required, but no type was set!")}}class di extends Ce{constructor(r,n,o){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fieldsIndex=o,this._fields=r,this._seperator=n||""}static fromUVRenderer(r,n,o,a){return(0,B.Z)(function*(){const h=r.fieldDelimiter,c=[r.field];r.field2&&c.push(r.field2),r.field3&&c.push(r.field3);const u=yield ye(r.backgroundFillSymbol,o,a),d=new di(c,h,r.fieldIndex);yield Promise.all(r.map.map(function(){var _=(0,B.Z)(function*(m,g){const p=yield ye(m.symbol,o,a),x=g+1,y=yield n.createTemplateGroup(p,u,x);"<Null>"===m.value?d.setNullResult(y):d.add(m.value,y)});return function(m,g){return _.apply(this,arguments)}}()));const f=yield ye(r.defaultSymbol,o,a);if(f){const _=Number.MAX_SAFE_INTEGER,m=yield n.createTemplateGroup(f,u,_);d.setDefault(m)}return d})()}setNullResult(r){this._nullResult=r}add(r,n){this._resultsMap.set(r.toString(),n)}size(){return super.size()+this._resultsMap.size}match(r,n,o,a,h){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const c=null!=this._fieldsIndex?n.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(n);if(null!==this._nullResult&&(null==c||""===c||"<Null>"===c))return this._nullResult;if(null==c)return this.getDefault();const u=c.toString();return this._resultsMap.has(u)?this._resultsMap.get(u):this.getDefault()}_getValueFromFields(r){const n=[];for(const o of this._fields){const a=r.readAttribute(o);n.push(null==a||""===a?"<Null>":a)}return n.join(this._seperator)}}function fi(){return(fi=(0,B.Z)(function*(l,r){const n=l||1;if("number"==typeof n)return(a,h,c)=>n;const o=yield(0,zs.Yi)(n,r.spatialReference,r.fields);return(a,h,c)=>(0,Cs.Z)(o,a,{$view:c},r.geometryType,h)||1})).apply(this,arguments)}let mi;function Es(){return _i.apply(this,arguments)}function _i(){return(_i=(0,B.Z)(function*(){return mi||(mi=L.e(3250).then(L.bind(L,3250))),mi})).apply(this,arguments)}class pi extends Ce{constructor(r,n,o,a,h,c){super(),this.type="dictionary",this._groupIdCache=new Ws.Z(100),this._loader=r,this._fieldMap=r.fieldMap,this._symbolFields=r.getSymbolFields(),this._templates=n,this._info=o,this._scaleFn=a,this._schemaUtilsModule=h,this._symbolOptions=c}static fromDictionaryRenderer(r,n,o,a){return(0,B.Z)(function*(){const[{DictionaryLoader:h},c]=yield Promise.all([Promise.resolve().then(L.bind(L,29996)),Es()]),u=new h(r.url,r.config,r.fieldMap);yield u.fetchResources({spatialReference:o.spatialReference,fields:o.fields});const d=yield function Ps(l,r){return fi.apply(this,arguments)}(r.scaleExpression,o);return new pi(u,n,o,d,c,r.symbolOptions)})()}_analyzeFeature(r,n,o,a,h){var c=this;return(0,B.Z)(function*(){const u=r.readLegacyFeature(),d=c._scaleFn(u,o,a),f=c._attributeHash(u)+"-"+d,_=c._groupIdCache.get(f);if(_)return _;const m=de(se({},a),{spatialReference:c._info.spatialReference,abortOptions:h,fields:c._info.fields}),g=yield c._loader.getSymbolAsync(u,m),x=ye(c._schemaUtilsModule.createSymbolSchema(g,c._symbolOptions),c._info,n,h).then(y=>{if("expanded-cim"!==(null==y?void 0:y.type))return li.error(new ge.Z("mapview-bad-type",`Found unexpected type ${null==y?void 0:y.type} in dictionary response`)),null;y.hash+="-"+d;for(const M of y.layers)M.scaleFactor=d,M.templateHash+="-"+d;return c._templates.createTemplateGroup(y,null)});return c._groupIdCache.put(f,x,1),x})()}analyze(r,n,o,a,h,c){var u=this;return(0,B.Z)(function*(){const d=n.getCursor(),f=[];for(;d.next();)f.push(u._analyzeFeature(d,o,a,h,c));return Promise.all(f).then(_=>_.filter(P.pC))})()}match(r,n,o,a,h){return null}_attributeHash(r){var o;let n="";for(const a of this._symbolFields){const h=null==(o=this._fieldMap)?void 0:o[a];h&&(n+=r.attributes[h]+"-")}return n}}var Fs=L(13112);class Vs{constructor(r){this._remoteClient=r,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}fetchResource(r,n){var o=this;return(0,B.Z)(function*(){const a=o._resourceMap,h=a.get(r);if(h)return h;let c=o._inFlightResourceMap.get(r);if(c)return c;try{c=o._remoteClient.invoke("tileRenderer.fetchResource",{url:r},se({},n)),o._inFlightResourceMap.set(r,c),c.then(u=>(o._inFlightResourceMap.delete(r),a.set(r,u),u))}catch(u){return(0,X.D_)(u)?null:{width:0,height:0}}return c})()}getResource(r){var n;return null!=(n=this._resourceMap.get(r))?n:null}}function sr(l,r){return(!l.minScale||l.minScale>=r)&&(!l.maxScale||l.maxScale<=r)}function nr(l){const r=l.message,n={message:{data:{},tileKey:r.tileKey,tileKeyOrigin:r.tileKeyOrigin,version:r.version},transferList:new Array};for(const o in r.data){const a=r.data[o];if(n.message.data[o]=null,(0,P.pC)(a)){const h=a.stride,c=a.indices.slice(0),u=a.vertices.slice(0),d=a.records.slice(0),f={stride:h,indices:c,vertices:u,records:d,metrics:(0,P.yw)(a.metrics,_=>_.slice(0))};n.transferList.push(c,u,d),n.message.data[o]=f}}return n}let yi=class extends Fs.Z{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new Vs(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(l){this._bufferIds.forEach(r=>{r.forEach(l)})}update(l,r){var n=this;return(0,B.Z)(function*(){var h;const o=r.schema.processors[0];if("symbol"!==o.type)return;const a=(0,ke.Hg)(n._schema,o);((0,ke.uD)(a,"mesh")||(0,ke.uD)(a,"target"))&&(l.mesh=!0,null==(h=l.why)||h.mesh.push("Symbology changed"),n._schema=o,n._factory=n._createFactory(o),n._factory.update(o,n.tileStore.tileScheme.tileInfo))})()}onTileMessage(l,r,n,o){return(0,X.k_)(o),this._onTileData(l,r,n,o)}onTileClear(l){return this._bufferData.delete(l.key.id),this._bufferIds.delete(l.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{clear:!0}})}onTileError(l,r,n){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:l.id,error:r},{signal:n.signal})}onTileUpdate(l){for(const r of l.removed)this._bufferData.has(r.key.id)&&this._bufferData.delete(r.key.id),this._bufferIds.has(r.key.id)&&this._bufferIds.delete(r.key.id);for(const r of l.added)this._bufferData.forEach(n=>{for(const o of n)o.message.tileKey===r.id&&this._updateTileMesh("append",r,nr(o),[],!1,!1,null)})}_addBufferData(l,r){var n;this._bufferData.has(l)||this._bufferData.set(l,[]),null==(n=this._bufferData.get(l))||n.push(nr(r))}_createFactory(l){const{geometryType:r,objectIdField:n,fields:o}=this.service,h={geometryType:r,fields:o,spatialReference:ft.Z.fromJSON(this.spatialReference)},c=new Ts((f,_)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",f,_),this.tileStore.tileScheme.tileInfo),{matcher:u,aggregateMatcher:d}=l.mesh;return this._store=c,this._matchers.feature=hi(u,c,h,this._resourceManagerProxy),this._matchers.aggregate=(0,P.yw)(d,f=>hi(f,c,h,this._resourceManagerProxy)),new ws(r,n,c)}_onTileData(l,r,n,o){var a=this;return(0,B.Z)(function*(){var g;(0,X.k_)(o);const{type:h,addOrUpdate:c,remove:u,clear:d,end:f}=r,_=!!a._schema.mesh.sortKey;if(!c)return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{type:h,addOrUpdate:null,remove:u,clear:d,end:f,sort:_}},o);const m=a._processFeatures(l,c,n,o,null==(g=r.status)?void 0:g.version);try{const p=yield m;if((0,P.Wi)(p))return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{type:h,addOrUpdate:null,remove:u,clear:d,end:f,sort:_}},o);const x=[];for(const y of p){let M=!1;const v=y.message.bufferIds,b=l.key.id,C=y.message.tileKey;if(b!==C&&(0,P.pC)(v)){if(!a.tileStore.get(C)){a._addBufferData(b,y),x.push(y);continue}let z=a._bufferIds.get(C);z||(z=new Set,a._bufferIds.set(C,z));const V=Array.from(v);for(const F of V){if(z.has(F)){M=!0;break}z.add(F)}}M||(a._addBufferData(b,y),x.push(y))}yield Promise.all(x.map(y=>{const M=l.key.id===y.message.tileKey;return a._updateTileMesh(h,l,y,M?r.remove:[],M&&r.end,!!r.clear,o.signal)}))}catch(p){a._handleError(l,p,o)}})()}_updateTileMesh(l,r,n,o,a,h,c){var u=this;return(0,B.Z)(function*(){const d=l,f=n.message.tileKey,_=!!u._schema.mesh.sortKey;f!==r.key.id&&(a=!1);const m=(0,P.yw)(n,y=>y.message),g=(0,P.yw)(n,y=>y.transferList)||[],p={type:d,addOrUpdate:m,remove:o,clear:h,end:a,sort:_},x={transferList:(0,P.Wg)(g)||[],signal:c};return(0,X.k_)(x),u.remoteClient.invoke("tileRenderer.onTileData",{tileKey:f,data:p},x)})()}_processFeatures(l,r,n,o,a){var h=this;return(0,B.Z)(function*(){if((0,P.Wi)(r)||!r.hasFeatures)return null;const c={transform:l.transform,hasZ:!1,hasM:!1},u=h._factory,d={viewingMode:"",scale:l.scale},f=yield h._matchers.feature,_=yield h._matchers.aggregate;(0,X.k_)(o);const m=h._getLabelInfos(l,r);return yield u.analyze(r.getCursor(),h._resourceManagerProxy,f,_,c,d),(0,X.k_)(o),h._writeFeatureSet(l,r,c,m,u,n,a)})()}_writeFeatureSet(l,r,n,o,a,h,c){const u=r.getSize(),d=this._schema.mesh.matcher.symbologyType,f=new ur(l.key.id,{features:u,records:u,metrics:0},d,h,d!==k.mD.HEATMAP,c),_={viewingMode:"",scale:l.scale},m=r.getCursor();for(;m.next();)try{const p=m.getDisplayId(),x=(0,P.pC)(o)?o.get(p):null;a.writeCursor(f,m,n,_,l.level,x,this._resourceManagerProxy)}catch(p){}return f.serialize(l.tileInfoView.tileInfo.isWrappable)}_handleError(l,r,n){return(0,X.D_)(r)?Promise.resolve():this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:l.id,error:r.message},{signal:n.signal})}_getLabelingSchemaForScale(l){const r=this._schema.mesh.labels;if((0,P.Wi)(r))return null;if("subtype"===r.type){const o={type:"subtype",classes:{}};let a=!1;for(const h in r.classes){const c=r.classes[h].filter(u=>sr(u,l.scale));a=a||!!c.length,o.classes[h]=c}return a?o:null}const n=r.classes.filter(o=>sr(o,l.scale));return n.length?{type:"simple",classes:n}:null}_getLabels(l,r){var n;if("subtype"===r.type){const a=(0,P.s3)(this.service.subtypeField,"Expected to find subtype Field"),h=l.readAttribute(a);return null==h?[]:null!=(n=r.classes[h])?n:[]}return r.classes}_getLabelInfos(l,r){const n=this._getLabelingSchemaForScale(l);if((0,P.Wi)(n))return null;const o=new Map,a=r.getCursor();for(;a.next();){const h=a.getDisplayId(),c=[],u=(0,Ue.nE)(h),d=u&&1!==a.readAttribute("cluster_count")?"aggregate":"feature",f=this._getLabels(a,n);for(const _ of f){if(_.target!==d)continue;const g=a.getStorage().getComputedStringAtIndex(u&&"feature"===d?a.readAttribute("referenceId"):h,_.fieldIndex);if(!g)continue;const p=(0,E.E)(g.toString()),y=p[1];this._store.getMosaicItem(_.symbol,ei(p[0])).then(M=>{var v;c[_.index]={glyphs:null!=(v=M.glyphMosaicItems)?v:[],rtl:y,index:_.index}})}o.set(h,c)}return o}};yi=(0,J._)([(0,Ae.j)("esri.views.2d.layers.features.processors.SymbolProcessor")],yi);const Bs=yi}}]);
"use strict";var Rr=Object.defineProperty,Br=Object.defineProperties,Pr=Object.getOwnPropertyDescriptors,Cs=Object.getOwnPropertySymbols,Or=Object.prototype.hasOwnProperty,zr=Object.prototype.propertyIsEnumerable,Fs=(xe,he,F)=>he in xe?Rr(xe,he,{enumerable:!0,configurable:!0,writable:!0,value:F}):xe[he]=F,ye=(xe,he)=>{for(var F in he||(he={}))Or.call(he,F)&&Fs(xe,F,he[F]);if(Cs)for(var F of Cs(he))zr.call(he,F)&&Fs(xe,F,he[F]);return xe},we=(xe,he)=>Br(xe,Pr(he));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[5122],{76279:(xe,he,F)=>{F.d(he,{r:()=>$});var P=F(14259);function $(p,_){if(!(this instanceof $))return new $(p,_);this._maxEntries=Math.max(4,p||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),_&&("function"==typeof _?this.toBBox=_:this._initFormat(_)),this.clear()}function N(p,_,x){if(!x)return _.indexOf(p);for(var S=0;S<_.length;S++)if(x(p,_[S]))return S;return-1}function C(p,_){L(p,0,p.children.length,_,p)}function L(p,_,x,S,T){T||(T=w(null)),T.minX=1/0,T.minY=1/0,T.maxX=-1/0,T.maxY=-1/0;for(var z,E=_;E<x;E++)z=p.children[E],Q(T,p.leaf?S(z):z);return T}function Q(p,_){return p.minX=Math.min(p.minX,_.minX),p.minY=Math.min(p.minY,_.minY),p.maxX=Math.max(p.maxX,_.maxX),p.maxY=Math.max(p.maxY,_.maxY),p}function ae(p,_){return p.minX-_.minX}function Z(p,_){return p.minY-_.minY}function K(p){return(p.maxX-p.minX)*(p.maxY-p.minY)}function re(p){return p.maxX-p.minX+(p.maxY-p.minY)}function W(p,_){return(Math.max(_.maxX,p.maxX)-Math.min(_.minX,p.minX))*(Math.max(_.maxY,p.maxY)-Math.min(_.minY,p.minY))}function q(p,_){var x=Math.max(p.minX,_.minX),S=Math.max(p.minY,_.minY),T=Math.min(p.maxX,_.maxX),z=Math.min(p.maxY,_.maxY);return Math.max(0,T-x)*Math.max(0,z-S)}function b(p,_){return p.minX<=_.minX&&p.minY<=_.minY&&_.maxX<=p.maxX&&_.maxY<=p.maxY}function j(p,_){return _.minX<=p.maxX&&_.minY<=p.maxY&&_.maxX>=p.minX&&_.maxY>=p.minY}function w(p){return{children:p,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function O(p,_,x,S,T){for(var z,E=[_,x];E.length;)(x=E.pop())-(_=E.pop())<=S||(z=_+Math.ceil((x-_)/S/2)*S,(0,P.q)(p,z,_,x,T),E.push(_,z,z,x))}$.prototype={all:function(){return this._all(this.data,[])},search:function(p){var _=this.data,x=[],S=this.toBBox;if(!j(p,_))return x;for(var T,z,E,V,H=[];_;){for(T=0,z=_.children.length;T<z;T++)E=_.children[T],j(p,V=_.leaf?S(E):E)&&(_.leaf?x.push(E):b(p,V)?this._all(E,x):H.push(E));_=H.pop()}return x},collides:function(p){var _=this.data,x=this.toBBox;if(!j(p,_))return!1;for(var S,T,z,E,V=[];_;){for(S=0,T=_.children.length;S<T;S++)if(z=_.children[S],j(p,E=_.leaf?x(z):z)){if(_.leaf||b(p,E))return!0;V.push(z)}_=V.pop()}return!1},load:function(p){if(!p||!p.length)return this;if(p.length<this._minEntries){for(var _=0,x=p.length;_<x;_++)this.insert(p[_]);return this}var S=this._build(p.slice(),0,p.length-1,0);if(this.data.children.length)if(this.data.height===S.height)this._splitRoot(this.data,S);else{if(this.data.height<S.height){var T=this.data;this.data=S,S=T}this._insert(S,this.data.height-S.height-1,!0)}else this.data=S;return this},insert:function(p){return p&&this._insert(p,this.data.height-1),this},clear:function(){return this.data=w([]),this},remove:function(p,_){if(!p)return this;for(var x,S,T,z,E=this.data,V=this.toBBox(p),H=[],A=[];E||H.length;){if(E||(E=H.pop(),S=H[H.length-1],x=A.pop(),z=!0),E.leaf&&-1!==(T=N(p,E.children,_)))return E.children.splice(T,1),H.push(E),this._condense(H),this;z||E.leaf||!b(E,V)?S?(x++,E=S.children[x],z=!1):E=null:(H.push(E),A.push(x),x=0,S=E,E=E.children[0])}return this},toBBox:function(p){return p},compareMinX:ae,compareMinY:Z,toJSON:function(){return this.data},fromJSON:function(p){return this.data=p,this},_all:function(p,_){for(var x=[];p;)p.leaf?_.push.apply(_,p.children):x.push.apply(x,p.children),p=x.pop();return _},_build:function(p,_,x,S){var T,z=x-_+1,E=this._maxEntries;if(z<=E)return C(T=w(p.slice(_,x+1)),this.toBBox),T;S||(S=Math.ceil(Math.log(z)/Math.log(E)),E=Math.ceil(z/Math.pow(E,S-1))),(T=w([])).leaf=!1,T.height=S;var V,H,A,k,ee=Math.ceil(z/E),de=ee*Math.ceil(Math.sqrt(E));for(O(p,_,x,de,this.compareMinX),V=_;V<=x;V+=de)for(O(p,V,A=Math.min(V+de-1,x),ee,this.compareMinY),H=V;H<=A;H+=ee)k=Math.min(H+ee-1,A),T.children.push(this._build(p,H,k,S-1));return C(T,this.toBBox),T},_chooseSubtree:function(p,_,x,S){for(var T,z,E,V,H,A,k,ee;S.push(_),!_.leaf&&S.length-1!==x;){for(k=ee=1/0,T=0,z=_.children.length;T<z;T++)H=K(E=_.children[T]),(A=W(p,E)-H)<ee?(ee=A,k=H<k?H:k,V=E):A===ee&&H<k&&(k=H,V=E);_=V||_.children[0]}return _},_insert:function(p,_,x){var T=x?p:(0,this.toBBox)(p),z=[],E=this._chooseSubtree(T,this.data,_,z);for(E.children.push(p),Q(E,T);_>=0&&z[_].children.length>this._maxEntries;)this._split(z,_),_--;this._adjustParentBBoxes(T,z,_)},_split:function(p,_){var x=p[_],S=x.children.length,T=this._minEntries;this._chooseSplitAxis(x,T,S);var z=this._chooseSplitIndex(x,T,S),E=w(x.children.splice(z,x.children.length-z));E.height=x.height,E.leaf=x.leaf,C(x,this.toBBox),C(E,this.toBBox),_?p[_-1].children.push(E):this._splitRoot(x,E)},_splitRoot:function(p,_){this.data=w([p,_]),this.data.height=p.height+1,this.data.leaf=!1,C(this.data,this.toBBox)},_chooseSplitIndex:function(p,_,x){var S,T,z,E,V,H,A,k;for(H=A=1/0,S=_;S<=x-_;S++)E=q(T=L(p,0,S,this.toBBox),z=L(p,S,x,this.toBBox)),V=K(T)+K(z),E<H?(H=E,k=S,A=V<A?V:A):E===H&&V<A&&(A=V,k=S);return k},_chooseSplitAxis:function(p,_,x){var S=p.leaf?this.compareMinX:ae,T=p.leaf?this.compareMinY:Z;this._allDistMargin(p,_,x,S)<this._allDistMargin(p,_,x,T)&&p.children.sort(S)},_allDistMargin:function(p,_,x,S){p.children.sort(S);var T,z,E=this.toBBox,V=L(p,0,_,E),H=L(p,x-_,x,E),A=re(V)+re(H);for(T=_;T<x-_;T++)z=p.children[T],Q(V,p.leaf?E(z):z),A+=re(V);for(T=x-_-1;T>=_;T--)z=p.children[T],Q(H,p.leaf?E(z):z),A+=re(H);return A},_adjustParentBBoxes:function(p,_,x){for(var S=x;S>=0;S--)Q(_[S],p)},_condense:function(p){for(var _,x=p.length-1;x>=0;x--)0===p[x].children.length?x>0?(_=p[x-1].children).splice(_.indexOf(p[x]),1):this.clear():C(p[x],this.toBBox)},_initFormat:function(p){var _=["return a"," - b",";"];this.compareMinX=new Function("a","b",_.join(p[0])),this.compareMinY=new Function("a","b",_.join(p[1])),this.toBBox=new Function("a","return {minX: a"+p[0]+", minY: a"+p[1]+", maxX: a"+p[2]+", maxY: a"+p[3]+"};")}}},58775:(xe,he,F)=>{F.d(he,{O3:()=>ee,lG:()=>oe,my:()=>de,q9:()=>Q});var P=F(26584),$=F(66385),N=F(88071),C=F(36630);const L={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function Q(D){return L[D]}function*ae(D){switch(D.type){case"Feature":yield D;break;case"FeatureCollection":for(const R of D.features)R&&(yield R)}}function*Z(D){if(!D)return null;switch(D.type){case"Point":yield D.coordinates;break;case"LineString":case"MultiPoint":yield*D.coordinates;break;case"MultiLineString":case"Polygon":for(const R of D.coordinates)yield*R;break;case"MultiPolygon":for(const R of D.coordinates)for(const X of R)yield*X}}function re(D){for(const R of D)if(R.length>2)return!0;return!1}function b(D){let R=0;for(let X=0;X<D.length;X++){const ue=D[X],be=D[(X+1)%D.length];R+=ue[0]*be[1]-be[0]*ue[1]}return R<=0}function j(D){const R=D[0],X=D[D.length-1];return R[0]===X[0]&&R[1]===X[1]&&R[2]===X[2]||D.push(R),D}function w(D,R,X){switch(R.type){case"LineString":return function O(D,R,X){return V(D,R.coordinates,X),D}(D,R,X);case"MultiLineString":return function p(D,R,X){for(const ue of R.coordinates)V(D,ue,X);return D}(D,R,X);case"MultiPoint":return function _(D,R,X){return V(D,R.coordinates,X),D}(D,R,X);case"MultiPolygon":return function x(D,R,X){for(const ue of R.coordinates){z(D,ue[0],X);for(let be=1;be<ue.length;be++)E(D,ue[be],X)}return D}(D,R,X);case"Point":return function S(D,R,X){return A(D,R.coordinates,X),D}(D,R,X);case"Polygon":return function T(D,R,X){const ue=R.coordinates;z(D,ue[0],X);for(let be=1;be<ue.length;be++)E(D,ue[be],X);return D}(D,R,X)}}function z(D,R,X){const ue=j(R);!function W(D){return!b(D)}(ue)?V(D,ue,X):H(D,ue,X)}function E(D,R,X){const ue=j(R);!function q(D){return b(D)}(ue)?V(D,ue,X):H(D,ue,X)}function V(D,R,X){for(const ue of R)A(D,ue,X);D.lengths.push(R.length)}function H(D,R,X){for(let ue=R.length-1;ue>=0;ue--)A(D,R[ue],X);D.lengths.push(R.length)}function A(D,R,X){const[ue,be,He]=R;D.coords.push(ue,be),X.hasZ&&D.coords.push(He||0)}function k(D){switch(typeof D){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function ee(D){if(!D)throw new P.Z("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==D.type&&"FeatureCollection"!==D.type)throw new P.Z("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:D});const{crs:R}=D;if(!R)return;const X="string"==typeof R?R:"name"===R.type?R.properties.name:"EPSG"===R.type?R.properties.code:null,ue=new RegExp(".*(CRS84H?|4326)$","i");if(!X||!ue.test(X))throw new P.Z("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:R})}function de(D,R={}){const X=[],ue=new Set,be=new Set;let He,ze=!1,Be=null,Xe=!1,{geometryType:Pe=null}=R,je=!1;for(const Je of ae(D)){const{geometry:Le,properties:Ze,id:ke}=Je;if((!Le||(Pe||(Pe=Q(Le.type)),Q(Le.type)===Pe))&&(ze||(ze=re(Z(Le))),Xe||(Xe=null!=ke,Xe&&(He=typeof ke,Be=Object.keys(Ze).filter($e=>Ze[$e]===ke))),Xe&&null!=ke&&(Be.length>1?Be=Be.filter($e=>Ze[$e]===ke):1===Be.length&&(Be=Ze[Be[0]]===ke?Be:[])),!je&&Ze)){let $e=!0;for(const Ne in Ze){if(ue.has(Ne))continue;const _t=Ze[Ne];if(null==_t){$e=!1,be.add(Ne);continue}const ut=k(_t);"unknown"!==ut?(be.delete(Ne),ue.add(Ne),X.push({name:Ne,alias:Ne,type:ut})):be.add(Ne)}je=$e}}const Ke=Be&&1===Be.length&&Be[0]||null;if(Ke)for(const Je of X)if(Je.name===Ke&&(0,C.H7)(Je)){Je.type="esriFieldTypeOID";break}return{fields:X,geometryType:Pe,hasZ:ze,objectIdFieldName:Ke,objectIdFieldType:He,unknownFields:Array.from(be)}}function oe(D,R){return Array.from(function*K(D,R={}){var be;const{geometryType:X,objectIdField:ue}=R;for(const He of D){const{geometry:ze,properties:Be,id:Xe}=He;if(ze&&Q(ze.type)!==X)continue;const Pe=Be||{};let je=null!=(be=Pe[ue])?be:null;ue&&null!=Xe&&!Pe[ue]&&(Pe[ue]=je=Xe),yield new $.u_(ze?w(new N.Z,ze,R):null,Pe,null,je)}}(ae(D),R))}},99666:(xe,he,F)=>{F.d(he,{KS:()=>K,PX:()=>L,QS:()=>W,_I:()=>P,jL:()=>Z,nE:()=>re,vs:()=>ae,xp:()=>Q});const P=8388607,$=8388608,L=0,Q=1,ae=q=>(q&$)>>>23,Z=q=>q&P,K=q=>ae(q)===Q?254:255;function re(q){return ae(q)===Q}function W(q,b){return((b?$:0)|q)>>>0}},39351:(xe,he,F)=>{F.d(he,{$0:()=>W,AI:()=>N,By:()=>R,C1:()=>Ut,CQ:()=>yt,CU:()=>dt,Ex:()=>T,I_:()=>Q,Ic:()=>k,Ij:()=>oe,Ip:()=>mt,Iv:()=>Fe,Iw:()=>z,MI:()=>Dt,SD:()=>Ot,Tz:()=>Ge,Uh:()=>Rt,V4:()=>lt,XJ:()=>Et,_6:()=>Pt,a:()=>At,aK:()=>Ke,e0:()=>xt,eV:()=>q,f2:()=>D,fL:()=>wt,iJ:()=>ee,jk:()=>bt,kF:()=>ze,m4:()=>Ze,mx:()=>X,nM:()=>de,oK:()=>Bt,pU:()=>je,ru:()=>L,tQ:()=>ut,uG:()=>ke,xl:()=>Pe,xm:()=>b,yP:()=>Be});const N=1e-30,L=4294967295,Q=512,W=8,q=10,b=29,T=24,z=8,k=0,ee=1,de=2,oe=3,D=4,R=5,X=6,ze=5,Be=6,Pe=1,je=2,Ke=3,Ze=2,ke=1,ut=1.05,lt=5,dt=6,At=1.15,wt=2,Et=8,mt=500,Dt=10,Ut=1024,Rt=2,yt=0,Ge=1,Bt=4,xt=8,Fe=16,Pt=4,Ot=1,bt=4},5254:(xe,he,F)=>{F.d(he,{Au:()=>q,Jz:()=>w,UJ:()=>j});const P=new Float32Array(1);function q(_){return[255&_,(65280&_)>>>8,(16711680&_)>>>16,(4278190080&_)>>>24]}function j(_,x){return 65535&_|x<<16}function w(_,x,S,T){return 255&_|(255&x)<<8|(255&S)<<16|T<<24}new Uint32Array(P.buffer)},55746:(xe,he,F)=>{F.d(he,{k:()=>q,p:()=>b});var P=F(65389),$=F(61885),C=(F(8314),F(62208)),L=F(76279),Q=F(5548),ae=F(16669),Z=F(52397);function K(j,w){return j<<16|w}function re(j){return(4294901760&j)>>>16}function W(j){return 65535&j}const q={getObjectId:j=>j.getObjectId(),getAttributes:j=>j.readAttributes(),getAttribute:(j,w)=>j.readAttribute(w),cloneWithGeometry:(j,w)=>j,getGeometry:j=>j.readHydratedGeometry(),getCentroid:(j,w)=>j.readCentroid()};class b extends ae.J{constructor(w,O,p){super(w,O),this.featureAdapter=q,this.events=new $.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new P.Z(50),this._index=(0,L.r)(9,_=>({minX:this._storage.getXMin(_),minY:this._storage.getYMin(_),maxX:this._storage.getXMax(_),maxY:this._storage.getYMax(_)})),this.mode=p}get storeStatistics(){let w=0,O=0,p=0;return this.forEach(_=>{const x=_.readGeometry();x&&(O+=x.isPoint?1:x.lengths.reduce((S,T)=>S+T,0),p+=x.isPoint?1:x.lengths.length,w+=1)}),{featureCount:w,vertexCount:O,ringCount:p}}hasInstance(w){return this._featureSetsByInstance.has(w)}onTileData(w,O){if((0,C.Wi)(O.addOrUpdate))return O;if(O.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const _=O.addOrUpdate.getCursor();for(;_.next();){const x=_.getDisplayId();this.setComputedAttributes(this._storage,_,x,w.scale)}return O}this._featureSetsByInstance.set(O.addOrUpdate.instance,O.addOrUpdate);const p=O.addOrUpdate.getCursor();for(;p.next();)this._insertFeature(p,w.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),O}search(w){this._rebuildIndex();const O=w.id,p=this._indexSearchCache.find(T=>T.tileId===O);if((0,C.pC)(p))return p.readers;const _=new Map,x=this._searchIndex(w.bounds),S=[];for(const T of x){const z=this._storage.getInstanceId(T),E=re(z),V=W(z);_.has(E)||_.set(E,[]),_.get(E).push(V)}return _.forEach((T,z)=>{const E=this._featureSetsByInstance.get(z);S.push(Z.t.from(E,T))}),this._indexSearchCache.enqueue({tileId:O,readers:S}),S}insert(w){var _;const O=w.getCursor(),p=this._storage;for(;O.next();){const x=K(O.instance,O.getIndex()),S=O.getObjectId(),T=null!=(_=this._objectIdToDisplayId.get(S))?_:this._storage.createDisplayId();O.setDisplayId(T),p.setInstanceId(T,x),this._objectIdToDisplayId.set(S,T)}this._featureSetsByInstance.set(w.instance,w),this._spatialIndexInvalid=!0}remove(w){const O=this._objectIdToDisplayId.get(w);if(!O)return;const p=this._storage.getInstanceId(O),_=W(p),x=re(p),S=this._featureSetsByInstance.get(x);this._objectIdToDisplayId.delete(w),this._storage.releaseDisplayId(O),S.removeAtIndex(_),S.isEmpty&&this._featureSetsByInstance.delete(x),this._spatialIndexInvalid=!0}toArray(){const w=new Array;return this.forEach(O=>w.push(O)),w}forEach(w){this._objectIdToDisplayId.forEach(O=>{const p=this._storage.getInstanceId(O),_=this._lookupFeature(p);w(_)})}forEachUnsafe(w){this._objectIdToDisplayId.forEach(O=>{const p=this._storage.getInstanceId(O),_=re(p),x=W(p),S=this._getFeatureSet(_);S.setIndex(x),w(S)})}forEachInBounds(w,O){const p=this._searchIndex(w);for(const _ of p){const x=this.lookupFeatureByDisplayId(_,this._storage);O((0,C.Wg)(x))}}forEachBounds(w,O,p){this._rebuildIndex();const _=[0,0,0,0];for(const x of w){if(!x.readGeometry())continue;const S=x.getDisplayId();_[0]=this._storage.getXMin(S),_[1]=this._storage.getYMin(S),_[2]=this._storage.getXMax(S),_[3]=this._storage.getYMax(S),O((0,Q.JR)(p,_))}}sweepFeatures(w,O,p){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((_,x)=>{w.has(_)||(O.releaseDisplayId(_),p&&p.unsetAttributeData(_),this._objectIdToDisplayId.delete(x))}),this.events.emit("changed")}sweepFeatureSets(w){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((O,p)=>{w.has(p)||this._featureSetsByInstance.delete(p)})}lookupObjectId(w,O){const p=this.lookupFeatureByDisplayId(w,O);return(0,C.Wi)(p)?null:p.getObjectId()}lookupDisplayId(w){return this._objectIdToDisplayId.get(w)}lookupFeatureByDisplayId(w,O){const p=O.getInstanceId(w);return this._lookupFeature(p)}lookupByDisplayIdUnsafe(w){const O=this._storage.getInstanceId(w),p=re(O),_=W(O),x=this._getFeatureSet(p);return x?(x.setIndex(_),x):null}_insertFeature(w,O){const p=this._storage,_=w.getObjectId(),x=K(w.instance,w.getIndex());p.getInstanceId(w.getDisplayId());let S=this._objectIdToDisplayId.get(_);S||(S=p.createDisplayId(),this._objectIdToDisplayId.set(_,S),this._spatialIndexInvalid=!0),w.setDisplayId(S),p.setInstanceId(S,x),this.setComputedAttributes(p,w,S,O)}_searchIndex(w){return this._rebuildIndex(),this._index.search({minX:w[0],minY:w[1],maxX:w[2],maxY:w[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const w=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(O=>{const p=O.getCursor();for(;p.next();){const _=p.getDisplayId();this._storage.setBounds(_,p)&&w.push(_)}}):this._objectIdToDisplayId.forEach(O=>{const p=this._storage.getInstanceId(O);this._storage.setBounds(O,this._lookupFeature(p))&&w.push(O)}),this._index.clear(),this._index.load(w),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(w){const O=re(w),p=this._getFeatureSet(O);if(!p)return null;const _=p.getCursor(),x=W(w);return _.setIndex(x),_}_getFeatureSet(w){return this._featureSetsByInstance.get(w)}}},11288:(xe,he,F)=>{F.r(he),F.d(he,{default:()=>Dr});var P=F(15861),$=F(17626),N=F(80542),C=F(8314),L=F(32917),Q=F(77712),K=(F(85931),F(90912),F(76898)),re=F(37053),W=F(2584),b=F(62208),j=F(10699),w=F(82054),O=F(58175),p=F(60466),_=F(55746),x=F(38305),S=F(84792),T=F(26584),z=F(63290),E=F(93662),V=F(7848),H=F(89628),A=F(20477),k=F(66385),ee=F(25208);class oe extends ee.s{constructor(a,h,u){super(a,u),this._featureIndex=-1,this._dateFields=new Set,this._geometryType=null==u?void 0:u.geometryType,this._features=h}static fromFeatures(a,h){const{objectIdField:u,geometryType:d}=h,g=(0,w.Yn)([],a,d,!1,!1,u);for(let f=0;f<g.length;f++)g[f].displayId=a[f].displayId;return oe.fromOptimizedFeatures(g,h)}static fromFeatureSet(a,h){const u=(0,w.h_)(a,h.objectIdField);return oe.fromOptimizedFeatureSet(u,h)}static fromOptimizedFeatureSet(a,h){const{features:u}=a,d=oe.fromOptimizedFeatures(u,h);d._exceededTransferLimit=a.exceededTransferLimit,d._transform=a.transform;for(const g of a.fields)"esriFieldTypeDate"===g.type&&d._dateFields.add(g.name);return d}static fromOptimizedFeatures(a,h,u){const d=ee.s.createInstance(),g=new oe(d,a,h);return g._transform=u,g}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const h=new Set(a);this._features=this._features.filter(u=>!h.has(u.objectId))}append(a){for(const h of a)this._features.push(h)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const h in this._current.attributes)a+=this._current.attributes[h];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){return this._current.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new oe(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,w.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,w.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,b.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,k.S6)(this._current)?(0,w.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const h=a.clone();return function de({coords:c,lengths:a}){let h=0;for(const u of a){for(let d=1;d<u;d++)c[2*(h+d)]+=c[2*(h+d)-2],c[2*(h+d)+1]+=c[2*(h+d)-1];h+=u}}(h),h}readHydratedGeometry(){const a=this._current.geometry;if((0,b.Wi)(a))return null;const h=a.clone();return(0,b.pC)(this._transform)&&(0,w.$g)(h,h,this.hasZ,this.hasM,this._transform),h}getXHydrated(){if(!(0,k.S6)(this._current))return 0;const a=this._current.geometry.coords[0],h=this.getQuantizationTransform();return(0,b.Wi)(h)?a:a*h.scale[0]+h.translate[0]}getYHydrated(){if(!(0,k.S6)(this._current))return 0;const a=this._current.geometry.coords[1],h=this.getQuantizationTransform();return(0,b.Wi)(h)?a:h.translate[1]-a*h.scale[1]}getX(){return(0,k.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,k.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,k.S6)(this._current))return null;const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let h=0;for(const u of a.lengths)a.coords[2*h]=a.coords[2*h]*this._sx+this._tx,a.coords[2*h+1]=a.coords[2*h+1]*this._sy+this._ty,h+=u;return a}readCentroid(){if(!(0,k.S6)(this._current))return null;if((0,b.Wi)(this._current.centroid)){const h=this._computeCentroid();if((0,b.Wi)(h))return null;h.coords[0]=(h.coords[0]-this._tx)/this._sx,h.coords[1]=(h.coords[1]-this._ty)/this._sy,this._current.centroid=h}const a=this._current.centroid.clone();return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sx+this._ty,a}hasField(a){return a in this._current.attributes||this.getFieldNames().map(h=>h.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,h){const u=this._current.attributes[a];if(void 0!==u)return null!=u&&h&&this._dateFields.has(a)?new Date(u):u;const d=this.readAttributes(),g=a.toLocaleLowerCase().trim();for(const f in d)if(f.toLocaleLowerCase().trim()===g){const m=this._current.attributes[f];return null!=m&&h&&this._dateFields.has(f)?new Date(m):m}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var D=F(24192),R=F(88071),X=F(71260);const ue=268435455;class be{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){var h;return null==(h=this.fieldMap.get(a))?void 0:h.isDate}getFieldIndex(a){var h;return null==(h=this.fieldMap.get(a))?void 0:h.index}}function He(c){const u=c.getLength(),d=c.pos()+u,g={name:"",isDate:!1};for(;c.pos()<d&&c.next();)switch(c.tag()){case 1:g.name=c.getString();break;case 2:"esriFieldTypeDate"===(0,X.O7)(c.getEnum())&&(g.isDate=!0);break;default:c.skip()}return g}function ze(c){return c.toLowerCase().trim()}const Xe=z.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),je=268435455,Le={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function Ze(c){return c<=Le.small.delta.length?Le.small:(c<=Le.large.delta.length||(Le.large.delta=new Int32Array(Math.round(1.25*c)),Le.large.decoded=new Int32Array(Math.round(1.25*c))),Le.large)}function ke(c){return c.toLowerCase().trim()}function Ne(c){for(;c.next();){if(1===c.tag())return c.getMessage();c.skip()}return null}function ut(c,a,h,u,d,g){return.5*Math.abs(c*u+h*g+d*a-c*g-h*a-d*u)}function vt(c,a,h,u){return c*u-h*a==0&&c*h+a*u>0}class lt extends ee.s{constructor(a,h,u,d){super(a,d),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=d.geometryType,this._reader=h,this._header=u,this._hasNext=u.hasFeatures,this._isPoints="esriGeometryPoint"===d.geometryType}static fromBuffer(a,h,u=!1){const d=h.geometryType,g=function $e(c){try{const h=new D.Z(new Uint8Array(c),new DataView(c));for(;h.next();){if(2===h.tag())return Ne(h.getMessage());h.skip()}}catch(a){const h=new T.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});Xe.error(h)}return null}(a),f=function Be(c,a,h=!1){const I=c.pos(),v=new be;let M=0,B=0,J=null,ne=null,se=null,le=!1;for(;c.next();)switch(c.tag()){case 1:J=c.getString();break;case 3:ne=c.getString();break;case 12:se=c.processMessage(X.G$);break;case 9:if(v.exceededTransferLimit=c.getBool(),v.exceededTransferLimit){v.offsets.geometry=h?new Float64Array(8e3):new Int32Array(8e3),v.centroid=h?new Float64Array(16e3):new Int32Array(16e3);for(let te=0;te<v.centroid.length;te++)v.centroid[te]=ue}break;case 13:{const te=He(c),pe=te.name,ve=ze(te.name),ge={fieldName:pe,index:M++,isDate:te.isDate};v.fields.push(ge),v.fieldMap.set(te.name,ge),v.fieldMap.set(ve,ge);break}case 15:{const te=c.getLength(),pe=c.pos()+te;if(!v.exceededTransferLimit){const me=v.centroid;v.offsets.geometry.push(0),me.push(ue),me.push(ue)}!le&&v.exceededTransferLimit&&(le=!0,v.offsets.attributes=h?new Float64Array(8e3*M):new Uint32Array(8e3*M));let ve=B*M;for(;c.pos()<pe&&c.next();)switch(c.tag()){case 1:{le?v.offsets.attributes[ve++]=c.pos():v.offsets.attributes.push(c.pos());const ge=c.getLength();c.skipLen(ge);break}case 2:if(a){const ge=c.getLength(),me=c.pos()+ge;for(;c.pos()<me&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const _e=c.getSInt64(),Ue=c.getSInt64();v.centroid[2*B]=_e,v.centroid[2*B+1]=Ue;break}default:c.skip()}}else{v.offsets.geometry[B]=c.pos();const ge=c.getLength();v.vertexCount+=ge,c.skipLen(ge)}break;case 4:{const ge=c.getLength(),me=c.pos()+ge;for(;c.pos()<me&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const _e=c.getSInt64(),Ue=c.getSInt64();v.centroid[2*B]=_e,v.centroid[2*B+1]=Ue;break}default:c.skip()}break}default:c.skip()}B++,v.hasFeatures=!0;break}default:c.skip()}const ce=J||ne;if(!ce)throw new T.Z("FeatureSet has no objectId or globalId field name");return v.featureCount=B,v.fieldCount=M,v.objectIdFieldIndex=v.getFieldIndex(ce),v.transform=se,v.displayIds=new Uint32Array(v.featureCount),v.groupIds=new Uint16Array(v.featureCount),c.move(I),v}(g,"esriGeometryPoint"===d,u),m=ee.s.createInstance();return new lt(m,g,f,h)}get geometryType(){return this._geometryType}get size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(ke(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this.size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:h})=>{a+=this._readAttributeAtIndex(h)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){var a;if(void 0===this._cache.legacyFeature){const h=this.readCentroid(),u={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(a=h&&{x:h.coords[0],y:h.coords[1]})?a:null};return this._cache.legacyFeature=u,u}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new k.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],h=this.getQuantizationTransform();return(0,b.Wi)(h)?a:a*h.scale[0]+h.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],h=this.getQuantizationTransform();return(0,b.Wi)(h)?a:h.translate[1]-a*h.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const h=this.readGeometry(a);return(0,w.di)(h,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[h,u]=a.coords;return{x:h,y:u}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const h=this.readGeometry(a);if(!h)return this._cache.unquantGeometry=null,null;const u=Ze(h.coords.length).decoded,d=h.clone(u),g=d.coords;let f=0;for(const m of d.lengths){for(let y=1;y<m;y++){const I=2*(f+y),v=2*(f+y-1);g[I]+=g[v],g[I+1]+=g[v+1]}f+=m}return this._cache.unquantGeometry=d,d}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===je)return null;const d=this.getXHydrated(),g=this.getYHydrated();return new R.Z([],[d,g])}const a=this.readGeometry();if(!a)return null;const h=a.clone(),u=this.getQuantizationTransform();return(0,b.pC)(u)&&(0,w.$g)(h,h,this.hasZ,this.hasM,u),h}readGeometry(a=!1){if(void 0===this._cache.geometry){let h=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===je)return null;const u=this.getX(),d=this.getY();h=new R.Z([],[u,d])}else{const u=this._header.offsets.geometry[this._featureIndex],d=this._reader;if(0===u)return null;d.move(u);try{h=a?this._parseGeometryForDisplay(d):this._parseGeometry(d)}catch(g){return console.error("Failed to parse geometry!",g),null}}return this._cache.geometry=h,h}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a=null;const h=this._header.centroid[2*this._featureIndex]+this._tx,u=this._header.centroid[2*this._featureIndex+1]+this._ty;return h===je?(a=this._computeCentroid(),a&&(this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=a.coords[1]-this._ty)):a=new R.Z([],[h,u]),this._cache.centroid=a,a}return this._cache.centroid}copy(){const a=this._reader.clone(),h=new lt(this.instance,a,this._header,this.fullSchema());return this.copyInto(h),h}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}_readAttribute(a,h){const u=this._header.hasField(a)?a:ke(a),d=this._header.getFieldIndex(u);if(null==d)return;const g=this._readAttributeAtIndex(d);return h&&null!=g&&this._header.isDateField(u)?new Date(g):g}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:h,index:u})=>{a[h]=this._readAttributeAtIndex(u)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const u=this._reader;return u.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function _t(c){const v=c.getLength(),M=c.pos()+v;for(;c.pos()<M&&c.next();)switch(c.tag()){case 1:return c.getString();case 2:return c.getFloat();case 3:return c.getDouble();case 4:return c.getSInt32();case 5:return c.getUInt32();case 6:return c.getInt64();case 7:return c.getUInt64();case 8:return c.getSInt64();case 9:return c.getBool();default:return c.skip(),null}return null}(u)}_parseGeometry(a){const d=a.getLength(),g=a.pos()+d,f=[],m=[];for(;a.pos()<g&&a.next();)switch(a.tag()){case 2:{const y=a.getUInt32(),I=a.pos()+y;for(;a.pos()<I;)m.push(a.getUInt32());break}case 3:{const y=a.getUInt32(),I=a.pos()+y;for(f.push(a.getSInt32()+this._tx),f.push(a.getSInt32()+this._ty),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();a.pos()<I;)f.push(a.getSInt32()),f.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break}default:a.skip()}return new R.Z(m,f)}_parseGeometryForDisplay(a){const d=a.getLength(),g=a.pos()+d,f=[],m=[];let y=0,I=0,v=null,M=0;const B="esriGeometryPolygon"===this.geometryType;for(;a.pos()<g&&a.next();)switch(a.tag()){case 2:{const U=a.getUInt32(),G=a.pos()+U;for(;a.pos()<G;){const Y=a.getUInt32();f.push(Y),y+=Y}v=Ze(2*y).delta;break}case 3:{a.getUInt32();const U=2+(this.hasZ?1:0)+(this.hasM?1:0);for(const G of f)if(I+U*G>v.length)for(let Y=0;Y<G;Y++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(B){const Y=this.getAreaSimplificationThreshold(G,this._header.vertexCount);let ie=2,J=1;const ne=!1;let se=a.getSInt32(),le=a.getSInt32();v[I++]=se,v[I++]=le,this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();let ce=a.getSInt32(),te=a.getSInt32();for(this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();ie<G;){let pe=a.getSInt32(),ve=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();const ge=se+ce,me=le+te;ut(se,le,ge,me,ge+pe,me+ve)>=Y?(M+=-.5*(ge-se)*(me+le),J>1&&vt(v[I-2],v[I-1],ce,te)?(v[I-2]+=ce,v[I-1]+=te):(v[I++]=ce,v[I++]=te,J++),se=ge,le=me):(pe+=ce,ve+=te),ce=pe,te=ve,ie++}J<3||ne?I-=2*J:(M+=-.5*(se+ce-se)*(le+te+le),vt(v[I-2],v[I-1],ce,te)?(v[I-2]+=ce,v[I-1]+=te,m.push(J)):(v[I++]=ce,v[I++]=te,m.push(++J)))}else{let Y=0,ie=a.getSInt32(),J=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),v[I++]=ie,v[I++]=J,Y+=1;for(let ne=1;ne<G;ne++){const se=a.getSInt32(),le=a.getSInt32(),ce=ie+se,te=J+le;M+=-.5*(ce-ie)*(te+J),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),ne>2&&vt(v[I-2],v[I-1],se,le)?(v[I-2]+=se,v[I-1]+=le):(v[I++]=se,v[I++]=le,Y+=1),ie=ce,J=te}m.push(Y)}break}default:a.skip()}if(this._cache.area=M,!m.length)return null;if(this._tx||this._ty){let U=0;for(const G of m)v[2*U]+=this._tx,v[2*U+1]+=this._ty,U+=G}return new R.Z(m,v)}}class dt{constructor(a){this.service=a}destroy(){}}function mt(){return(mt=(0,P.Z)(function*(c){const a=new E.Z;return yield a.open(c,{}),a})).apply(this,arguments)}class Ht extends dt{constructor(a){super(a),this._portsOpen=function Et(c){return mt.apply(this,arguments)}(a.source).then(h=>this.client=h)}destroy(){this.client.close(),this.client=null}executeQuery(a,h){var u=this;return(0,P.Z)(function*(){yield u._portsOpen;const d=yield u.client.invoke("queryFeatures",a.toJSON(),h);return oe.fromFeatureSet(d,u.service)})()}}class Kt extends dt{executeQuery(a,h){var u=this;return(0,P.Z)(function*(){const{data:d}=yield(0,A.executeQueryPBFBuffer)(u.service.source,a,h);return lt.fromBuffer(d,u.service,!a.quantizationParameters)})()}}class Dt extends dt{executeQuery(a,h){var u=this;return(0,P.Z)(function*(){var v;const{source:d,capabilities:g,spatialReference:f,objectIdField:m,geometryType:y}=u.service;if((0,b.pC)(a.quantizationParameters)&&!g.query.supportsQuantization){const M=a.clone(),B=(0,V.vY)((0,b.Wg)(M.quantizationParameters));M.quantizationParameters=null;const{data:U}=yield(0,A.executeQuery)(d,M,f,h),G=(0,w.h_)(U,m);return(0,w.RZ)(B,G),oe.fromOptimizedFeatureSet(G,u.service)}const{data:I}=yield(0,A.executeQuery)(d,a,u.service.spatialReference,h);return"esriGeometryPoint"===y&&(I.features=null==(v=I.features)?void 0:v.filter(M=>{if((0,b.pC)(M.geometry)){const B=M.geometry;return Number.isFinite(B.x)&&Number.isFinite(B.y)}return!0})),oe.fromFeatureSet(I,u.service)})()}}class Ut extends dt{executeQuery(a,h){var u=this;return(0,P.Z)(function*(){const{capabilities:d}=u.service;if(a.quantizationParameters&&!d.query.supportsQuantization){const f=a.clone(),m=(0,V.vY)((0,b.Wg)(f.quantizationParameters));f.quantizationParameters=null;const y=yield(0,H.WW)(u.service.source,a,h);return(0,w.RZ)(m,y),oe.fromOptimizedFeatureSet(y,u.service)}const g=yield(0,H.WW)(u.service.source,a,h);return oe.fromOptimizedFeatureSet(g,u.service)})()}}var Rt=F(97478),yt=F(61885),Ge=F(84682),Bt=F(84952),xt=F(65389);class Fe{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const h=new Fe;for(const u in a){const d=a[u];if("object"==typeof d)for(const g in d)h[u][g]=d[g];h[u]=d}return h}static empty(){return Fe.create({})}static all(){return Fe.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,h="";if(this.mesh){a+=20,h+="-> (20) Mesh needs update\n";for(const d of this.why.mesh)h+=`    + ${d}\n`}if(this.source){a+=10,h+="-> (10) The source needs update\n";for(const d of this.why.source)h+=`    + ${d}\n`}this.targets.feature&&(a+=5,h+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,h+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,h+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,h+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(h)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class Pt{constructor(a,h){this.requests={done:new Array,stream:new xt.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=h}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(h=>h.message.status.unset(a)),this._version=a.version,(0,b.pC)(this._edits)&&this._edits.status.unset(a)}add(a){var h;a.message.status=null!=(h=a.message.status)?h:Fe.empty(),a.message.status.version=this._version,(0,C.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(u=>{(0,b.pC)(u.message)&&u.message.end&&(u.message.end=!1)}),this.requests.done.push(a)}edit(a,h){const u=a.getQuantizationTransform(),d=a.fullSchema(),g=Array.from(a.features()),f=[...h,...g.map(m=>m.objectId)];this.removeIds(f),this._invalidate(),(0,b.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:oe.fromOptimizedFeatures(g,d,(0,b.Wg)(u)),id:this.tile.id,status:Fe.empty(),end:!0}:(this.requests.done.forEach(m=>m.message.end=!1),(0,b.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,b.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,b.pC)(this._edits)&&(0,b.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=Fe.empty();(0,b.pC)(this._edits)&&(this._edits.status=Fe.empty())}removeIds(a){this._invalidate();for(const{message:h}of this.requests.done){const u=h.addOrUpdate;(0,b.pC)(u)&&(u.removeIds(a),u.isEmpty&&(h.addOrUpdate=null))}(0,b.pC)(this._edits)&&(0,b.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(h=>h.message.addOrUpdate||h.message.end)}abort(){this._abortController.abort()}}class bt{constructor(a){this.events=new yt.Z,this._resolver=(0,j.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}destroy(){}_onMessage(a){var h=this;return(0,P.Z)(function*(){var g,f;const u=h._subscriptions.get(a.id);if(!u)return;const d=we(ye({},a),{remove:null!=(g=a.remove)?g:[],status:null!=(f=a.status)?f:Fe.empty()});return(0,j.R8)(h._onTileUpdateMessage(d,u.options))})()}update(a,h){var y;const u=h.fields.length;h.outFields=function Ot(c,a){const h=new Set;return c&&c.forEach(u=>h.add(u)),a&&a.forEach(u=>h.add(u)),h.has("*")?["*"]:Array.from(h)}(null==(y=this._schema)?void 0:y.outFields,h.outFields),h.outFields=h.outFields.length>=.75*u?["*"]:h.outFields,h.outFields.sort();const d=(0,Ge.Hg)(this._schema,h);if(!d)return;(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",d);const g="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",f={returnCentroid:(0,C.Z)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:h.outFields,outSpatialReference:this._outSR,orderByFields:[g],where:h.definitionExpression||"1=1",gdbVersion:h.gdbVersion,historicMoment:h.historicMoment,timeExtent:Rt.Z.fromJSON(h.timeExtent)},m=this._schema&&(0,Ge.uD)(d,"outFields");this._schema&&(0,Ge.V7)(d,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),m&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,Ge.Hg)(f,this._queryInfo)&&(this._queryInfo=f),this._schema=h,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var h=this;return(0,P.Z)(function*(){if(a.queryFilter||a.source&&h._didEdit)return h.refresh(a.version),void(h._didEdit=!1);h._subscriptions.forEach(u=>u.applyUpdate(a)),yield h.resend()})()}refresh(a){for(const h of this._tiles())this.unsubscribe(h),this.subscribe(h,a)}subscribe(a,h){const u=new Pt(a,h);this._subscriptions.set(a.id,u)}unsubscribe(a){const h=this.get(a.id);(0,b.pC)(h)&&h.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const h=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new Bt.Z(ye(we(ye({},this._queryInfo),{historicMoment:h}),a))}get(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,P.Z)(function*(){throw new Error("Service does not support query type")})()}query(a){return(0,P.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const h of a)yield h.tile}edit(a,h){var u=this;return(0,P.Z)(function*(){const d=Array.from(u._subscriptions.values()),g=d.map(({tile:f})=>f);for(const f of d)f.removeIds(h);if(a.length){const f=g.map(y=>{const I=u.createTileQuery(y);return I.objectIds=a,{tile:y,query:I}}).map(function(){var y=(0,P.Z)(function*({tile:I,query:v}){return{tile:I,result:yield u.query(v),query:v}});return function(I){return y.apply(this,arguments)}}()),m=(yield(0,j.WW)(f)).map(function(){var y=(0,P.Z)(function*({tile:I,result:v}){if(!v.hasFeatures&&!h.length&&!a.length)return;const M=u._subscriptions.get(I.key.id);M&&M.edit(v,a)});return function(I){return y.apply(this,arguments)}}());yield(0,j.as)(m)}u._didEdit=!0})()}}var zt=F(71251);const Ms=z.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");class Lt extends bt{constructor(a){var h,u;super(a),h=this,this.type="feature",this.mode="on-demand",this._adapter=function wt(c){const{capabilities:a}=c;return function qt(c){return c&&c.capabilities&&c.collection&&c.layerDefinition}(c.source)?new Ut(c):function At(c){return Array.isArray(c.source)}(c)?new Ht(c):a.query.supportsFormatPBF&&(0,C.Z)("featurelayer-pbf")?new Kt(c):new Dt(c)}(a.serviceInfo),this._queue=new zt.e({concurrency:8,process:(u=(0,P.Z)(function*(d){if((0,j.k_)(d),(0,b.pC)(d.tile)){const g=d.tile.key.id,{signal:f}=d,m=(0,C.Z)("esri-tiles-debug")?{tile:g.replace(/\//g,"."),depth:d.depth}:void 0,y=yield h._adapter.executeQuery(d.query,{signal:f,query:ye(ye({},m),h._schema.customParameters)});return y.level=d.tile.key.level,y}return h._adapter.executeQuery(d.query,we(ye({},d),{query:h._schema.customParameters}))}),function(g){return u.apply(this,arguments)})}),this._patchQueue=new zt.e({concurrency:8,process:function(){var u=(0,P.Z)(function*(d){if((0,j.k_)(d),(0,b.pC)(d.tile)){const g=d.tile.key.id,{signal:f}=d,m=(0,C.Z)("esri-tiles-debug")?{tile:g.replace(/\//g,"."),depth:d.depth}:void 0,y=yield h._adapter.executeQuery(d.query,{signal:f,query:ye(ye({},m),h._schema.customParameters)});return y.level=d.tile.key.level,y}return h._adapter.executeQuery(d.query,we(ye({},d),{query:h._schema.customParameters}))});return function(g){return u.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){var h;const{query:a}=this._serviceInfo.capabilities;return(null!=(h=a.maxRecordCount)?h:8e3)*(0,b.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,h){}subscribe(a,h){super.subscribe(a,h);const u=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(d=>{(0,j.D_)(d)||Ms.error(new T.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:d}))}).then(()=>u.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a){var h=this;return(0,P.Z)(function*(){return h._adapter.executeQuery(a,{query:h._schema.customParameters})})()}queryLastEditDate(){var a=this;return(0,P.Z)(function*(){const h=a._serviceInfo.source,u=we(ye({},h.query),{f:"json"});return(yield(0,S.default)(h.path,{query:u,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,h={}){var f;const u=this._serviceInfo.geometryType,d=this.createQuery(h);d.quantizationParameters=null!=(f=h.quantizationParameters)?f:a.getQuantizationParameters(),d.resultType="tile",d.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===u&&(d.maxAllowableOffset=a.resolution*(0,C.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==u&&"esriGeometryPolygon"!==u||(d.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===u&&(d.maxAllowableOffset*=(0,C.Z)("feature-polyline-generalization-factor")));const g=this._serviceInfo.capabilities.query;return d.defaultSpatialReferenceEnabled=g.supportsDefaultSpatialReference,d.compactGeometryEnabled=g.supportsCompactGeometry,d}_executePatchQuery(a,h,u,d){var g=this;return(0,P.Z)(function*(){const f=h.clone();f.outFields=[g._serviceInfo.objectIdField,...u],f.returnCentroid=!1,f.returnGeometry=!1;const m=(0,b.pC)(f.start)?f.start/8e3:0;return g._patchQueue.push({tile:a,query:f,signal:d.signal,depth:m})})()}_resend(a,h){var u=this;return(0,P.Z)(function*(){const{query:d,message:g}=a,f=(0,b.pC)(d.outFields)?d.outFields:[],m=u._queryInfo.outFields,y=m.filter(I=>!f.includes(I));if((0,b.Wi)(g.addOrUpdate))u._onMessage(we(ye({},g),{type:"append"}));else if(y.length)try{const I=u._subscriptions.get(g.id).tile,v=yield u._executePatchQuery(I,d,y,h);(0,j.k_)(h),d.outFields=m,g.addOrUpdate.joinAttributes(v),u._onMessage(we(ye({},g),{end:g.end,type:"append"}))}catch(I){}else u._onMessage(we(ye({},g),{type:"append"}))})()}_resendSubscription(a){var h=this;return(0,P.Z)(function*(){if((0,C.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return h._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const u=a.signal;for(const d of a.requests.done)yield h._resend(d,{signal:u});return(0,b.pC)(a.edits)?h._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,P.Z)(function*(){const h=Array.from(a._subscriptions.values());yield Promise.all(h.map(u=>a._resendSubscription(u)))})()}}const Jt=(0,C.Z)("esri-mobile"),$t={maxDrillLevel:Jt?1:4,maxRecordCountFactor:Jt?1:3};class As extends Lt{constructor(a){super(a)}_fetchDataTile(a){var h=this;return(0,P.Z)(function*(){const u=h._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,d=h._subscriptions.get(a.key.id),g=d.signal,f=a.getQuantizationParameters();let m=0;const y=function(){var I=(0,P.Z)(function*(v,M){const B=h._queryInfo,U=h.createTileQuery(v,{maxRecordCountFactor:u?$t.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:f});m++;try{const G=yield h._queue.push({tile:a,query:U,signal:g,depth:M});if(m--,(0,j.k_)(g),!G)return;if(B!==h._queryInfo)return void y(v,M);if(G.exceededTransferLimit&&M<$t.maxDrillLevel){for(const ie of v.createChildTiles())y(ie,M+1);return}const Y={id:a.id,addOrUpdate:G,end:0===m,type:"append"};d.add({query:U,message:Y}),h._onMessage(Y)}catch(G){(0,j.D_)(G)||h._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(M,B){return I.apply(this,arguments)}}();y(a,0)})()}}var es=F(76279),ws=F(5075),Es=F(16147);function Us(c,a){const h=c.weakClone();if((0,b.pC)(c.geometry)){const u=(0,w.Jd)(a,c.geometry.coords[0]),d=(0,w.IN)(a,c.geometry.coords[1]);h.geometry=new R.Z([],[u,d])}return h}class zs{constructor(a,h){this.onUpdate=a,this._geometryType=h,this._objectIdToFeature=new Map}get _features(){const a=[];return this._objectIdToFeature.forEach(h=>a.push(h)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function Ps(c,a){const h=(0,es.r)(9,function Bs(c){return"esriGeometryPoint"===c?a=>(0,b.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let h=1/0,u=1/0,d=-1/0,g=-1/0;return(0,b.pC)(a.geometry)&&a.geometry.forEachVertex((f,m)=>{h=Math.min(h,f),u=Math.min(u,m),d=Math.max(d,f),g=Math.max(g,m)}),{minX:h,minY:u,maxX:d,maxY:g}}}(a));return h.load(c),h}(this._features,this._geometryType)),function Os(c,a){return c.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}removeById(a){const h=this._objectIdToFeature.get(a);return h?(this._objectIdToFeature.delete(a),this._index=null,h):null}update(a,h){this.onUpdate(a,h)}get size(){return this._objectIdToFeature.size}}class Ls extends bt{constructor(a){super(a),this.type="geoevent",this._dataReceiveEventEnabled=!1,this._level=0,this._updateInfo={websocket:0,client:0};const{outSR:h}=a,{geometryType:u,objectIdField:d,timeInfo:g,purgeOptions:f,source:m,spatialReference:y,serviceFilter:I,maxReconnectionAttempts:v,maxReconnectionInterval:M,updateInterval:B,enableDataReceived:U,customParameters:G}=a.serviceInfo,Y=new zs(this._onUpdate.bind(this),u),ie=new ws.Qo(Y,d,g,f),J=(0,Es.I)(m,y,h,u,I,v,M,G);this._store=Y,this._manager=ie,this._connection=J,this._quantize=function Rs(c){return"esriGeometryPoint"===c?Us:(a,h)=>{const u=a.weakClone(),d=new R.Z,m=(0,w.Nh)(d,a.geometry,!1,!1,c,h,!1,!1);return u.geometry=m,u}}(u),this._dataReceiveEventEnabled=U,this._handles=[this._connection.on("feature",ne=>this._onFeature(ne)),(0,L.YP)(()=>J.connectionStatus,ne=>this.events.emit("connectionStatus",ne)),(0,L.YP)(()=>J.errorString,ne=>this.events.emit("errorString",ne))],this._initUpdateInterval=()=>{let ne=performance.now();this._updateIntervalId=setInterval(()=>{const se=performance.now(),le=se-ne;if(le>2500){ne=se;const ce=Math.round(this._updateInfo.client/(le/1e3)),te=Math.round(this._updateInfo.websocket/(le/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:ce,websocket:te})}a.canAcceptRequest()&&this._manager.checkForUpdates()},B)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(a=>a.remove()),this._connection.destroy()}_fetchDataTile(){}pauseStream(){this._clearUpdateInterval()}resumeStream(){this._initUpdateInterval()}enableEvent(a,h){"data-received"===a&&(this._dataReceiveEventEnabled=h)}get updating(){return!1}subscribe(a,h){super.subscribe(a,h);const u=this._subscriptions.get(a.id);this._level=a.level;const d=this._getTileFeatures(a);this._onMessage({type:"append",id:a.key.id,addOrUpdate:d,end:!0}),u.didSend=!0}unsubscribe(a){super.unsubscribe(a)}*readers(a){const h=this._subscriptions.get(a),{tile:u}=h;yield this._getTileFeatures(u);for(const d of h.requests.stream.entries)(0,b.pC)(d)&&(0,b.pC)(d.addOrUpdate)&&(yield d.addOrUpdate)}createTileQuery(a){throw new Error("Service does not support tile  queries")}resend(){var a=this;return(0,P.Z)(function*(){a._subscriptions.forEach(h=>{const{tile:u}=h,d={type:"append",id:u.id,addOrUpdate:a._getTileFeatures(u),end:!0};a._onMessage(d)})})()}_getTileFeatures(a){const h=this._store.search(a).map(u=>this._quantize(u,a.transform));return oe.fromOptimizedFeatures(h,this._serviceInfo,a.transform)}_onFeature(a){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",a);const h=(0,w.XA)(a,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(h)}catch(h){}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(a,h){(0,b.pC)(a)&&(this._updateInfo.client+=a.length),this._subscriptions.forEach((u,d)=>{u.didSend&&u.tile.level===this._level&&this._onMessage({type:"append",id:d,addOrUpdate:null,clear:!0,end:!1})}),this._subscriptions.forEach((u,d)=>{if(!u.didSend||u.tile.level!==this._level)return;const f={type:"append",id:d,addOrUpdate:this._getTileFeatures(u.tile),remove:[],end:!0,status:Fe.empty()};u.requests.stream.enqueue(f),this._onMessage(f)})}}const Zs=z.Z.getLogger("esri.views.2d.layers.features.sources.FeatureSource");class Gs extends Lt{constructor(a){super(a)}_fetchDataTile(a){var h=this;return(0,P.Z)(function*(){const g=h._subscriptions.get(a.key.id);let f=!1,m=0,y=0;const I=(B,U)=>{y--,(0,j.k_)(g);const G=a.id,Y=B.reader,ie=B.query;if(!Y.exceededTransferLimit){if(f=!0,0!==U&&!Y.hasFeatures){const se={id:G,addOrUpdate:Y,end:0===y,type:"append"};return g.add({message:se,query:ie}),void h._onMessage(se)}const ne={id:G,addOrUpdate:Y,end:0===y,type:"append"};return g.add({message:ne,query:ie}),void h._onMessage(ne)}const J={id:G,addOrUpdate:Y,end:f&&0===y,type:"append"};g.add({message:J,query:ie}),h._onMessage(J)};let v=0,M=0;for(;!f&&M++<20;){let B;for(let U=0;U<v+1;U++){const G=m++;y++,B=h._fetchDataTilePage(a,G,g).then(Y=>Y&&I(Y,G)).catch(Y=>{f=!0,(0,j.D_)(Y)||(Zs.error(new T.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:Y})),h._onMessage({id:a.id,addOrUpdate:null,end:f,type:"append"}))})}yield B,(0,j.k_)(g),v=Math.min(v+2,6)}})()}_fetchDataTilePage(a,h,u){var d=this;return(0,P.Z)(function*(){(0,j.k_)(u);const g=d._queryInfo,f={start:d.pageSize*h,num:d.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,b.pC)(d.maxRecordCountFactor)&&(f.maxRecordCountFactor=d.maxRecordCountFactor);const m=d.createTileQuery(a,f);try{const y=u.signal,I=yield d._queue.push({tile:a,query:m,signal:y,depth:h});return(0,j.k_)(u),I?g!==d._queryInfo?d._fetchDataTilePage(a,h,u):{reader:I,query:m}:null}catch(y){return(0,j.H9)(y),null}})()}}var js=F(4619),ks=F(52397);const Ns=z.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function Ys(c,a,h){const u=c.getXHydrated(),d=c.getYHydrated(),g=a.getColumnForX(u),f=Math.floor(a.normalizeCol(g));return`${h}/${Math.floor(a.getRowForY(d))}/${f}`}function Zt(c,a){if((0,b.Wi)(c))return null;const h=a.transform,u=c.getQuantizationTransform();if((0,b.Wi)(u)){const[ie,J]=h.scale,[ne,se]=h.translate;return c.transform(-ne/ie,se/J,1/ie,1/-J)}const[d,g]=u.scale,[f,m]=u.translate,[y,I]=h.scale,[v,M]=h.translate;return c.transform((f-v)/y,(-m+M)/I,d/y,g/I)}class Ws extends Lt{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new js.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,h){super.update(a,h),this._hasAggregates=a.targets.aggregate}resend(a=!1){var h=this;return(0,P.Z)(function*(){if(yield h._downloadPromise,h._invalidated||a){const d=(0,b.s3)(h._schema.featureCount,"Expected featureCount to be defined");return h._invalidated=!1,h._subscriptions.forEach(g=>g.clear()),h._downloadPromise=h._download(d),void(yield h._downloadPromise)}const u=h._queries.map(({query:d,reader:g})=>h._sendPatchQuery(d,g));yield Promise.all(u),h._subscriptions.forEach(d=>{d.requests.done.forEach(g=>h._onMessage(g.message))})})()}refresh(){var a=this;return(0,P.Z)(function*(){yield a.resend(!0)})()}_sendPatchQuery(a,h){var u=this;return(0,P.Z)(function*(){const d=(0,b.pC)(a.outFields)?a.outFields:[],g=u._queryInfo.outFields,f=g.filter(v=>!d.includes(v));if(!f.length)return;const m=a.clone(),y=u._signal;m.returnGeometry=!1,m.returnCentroid=!1,m.outFields=f,a.outFields=g;const I=yield u._queue.push({query:m,depth:0,signal:y});(0,j.k_)({signal:y}),h.joinAttributes(I)})()}_fetchDataTile(a){var h=this;return(0,P.Z)(function*(){if(!h._downloadPromise){const I=(0,b.s3)(h._schema.featureCount,"Expected featureCount to be defined");h._downloadPromise=h._download(I)}const u=h._store.search(a),d=h._subscriptions.get(a.key.id),g=u.length-1;for(let I=0;I<g;I++){const v=Zt(u[I],a),M={type:"append",id:a.id,addOrUpdate:v,end:!1,status:Fe.empty()};d.add({query:null,message:M}),h._hasAggregates||(yield(0,j.e4)(1)),h._onMessage(M)}const f=Zt(g>=0?u[g]:null,a),y={type:"append",id:a.id,addOrUpdate:f,end:h._didSendEnd,status:Fe.empty()};d.add({query:null,message:y}),h._onMessage(y)})()}_download(a){var h=this;return(0,P.Z)(function*(){try{yield h.whenInitialized();const u=h._store.storage.getBitset(h._markedIdsBufId),d=new Set;u.clear();const g=Math.ceil(a/h.pageSize),f=Array.from({length:g},(m,y)=>y).sort((m,y)=>h._random.getInt()-h._random.getInt()).map(m=>h._downloadPage(m,u,d));yield Promise.all(f),h._store.sweepFeatures(u,h._store.storage),h._store.sweepFeatureSets(d)}catch(u){Ns.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",u)}h._sendEnd(),h._loading=!1})()}_downloadPage(a,h,u){var d=this;return(0,P.Z)(function*(){const g=d.pageSize,f={start:a*g,num:g,cacheHint:!0};(0,b.pC)(d.maxRecordCountFactor)&&(f.maxRecordCountFactor=d.maxRecordCountFactor);const m=d.createQuery(f),y=d._signal,I=yield d._queue.push({query:m,depth:a,signal:y});(0,j.k_)({signal:y}),d._queries.push({query:m,reader:I}),d._store.insert(I),u.add(I.instance);const v=I.getCursor();for(;v.next();)h.set(v.getDisplayId());d._send(I)})()}_send(a){if(!this._subscriptions.size)return;let h=null;const u=new Map,d=new Set,g=new Map;this._subscriptions.forEach(f=>{var B;const m=f.tile;u.set(m.key.id,null),h=m.tileInfoView,d.add(m.level);const{row:y,col:I}=m.key,v=`${m.level}/${y}/${I}`,M=null!=(B=g.get(v))?B:[];M.push(f),g.set(v,M)});for(const f of d){const m=h.getLODInfoAt(f),y=a.getCursor();for(;y.next();){const I=Ys(y,m,f),v=y.getIndex();if(g.has(I))for(const M of g.get(I)){const B=M.tile.id;let U=u.get(B);(0,b.Wi)(U)&&(U=[],u.set(B,U)),U.push(v)}}}u.forEach((f,m)=>{if((0,b.pC)(f)){const y=this._subscriptions.get(m),I={type:"append",id:m,addOrUpdate:Zt(ks.t.from(a,f),y.tile),end:!1,status:Fe.empty()};y.add({query:null,message:I}),this._onMessage(I)}})}_sendEnd(){this._subscriptions.forEach(a=>{const h={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:Fe.empty()};a.add({query:null,message:h}),this._onMessage(h)}),this._didSendEnd=!0}}var Qs=F(21286),Ee=F(39351),fe=F(99666),qs=F(64288);F(81295),F(39406),z.Z.getLogger("esri.views.2d.engine.webgl");var ot=F(67969);const ct=z.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),St=(ct,()=>null),It={sharedArrayBuffer:(0,C.Z)("esri-shared-array-buffer"),atomics:(0,C.Z)("esri-atomics")};function is(c,a){return h=>a(c(h))}class rr{constructor(a,h,u,d){this.size=0,this.texelSize=4;const{pixelType:g,layout:f,textureOnly:m}=d;this.textureOnly=m||!1,this.pixelType=g,this._ctype=h,this.layout=f,this._resetRange(),this._shared=a,this.size=u,m||(this.data=this._initData(g,u,a,h))}get buffer(){return(0,b.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,h){const u=(0,b.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)u[d*this.texelSize+a]&=~h;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,h){const u=(0,b.Wg)(this.data);for(let d=0;d<this.size*this.size;d++)u[d*this.texelSize+a]|=255&h;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,h,u){const d=(0,b.Wg)(this.data);for(const g of u)d[g*this.texelSize+a]|=h,this.dirtyStart=Math.min(this.dirtyStart,g),this.dirtyEnd=Math.max(this.dirtyEnd,g)}setComponentTexel(a,h,u){(0,b.Wg)(this.data)[u*this.texelSize+a]|=h,this.dirtyStart=Math.min(this.dirtyStart,u),this.dirtyEnd=Math.max(this.dirtyEnd,u)}unsetComponentTexel(a,h,u){(0,b.Wg)(this.data)[u*this.texelSize+a]&=~h,this.dirtyStart=Math.min(this.dirtyStart,u),this.dirtyEnd=Math.max(this.dirtyEnd,u)}getData(a,h){const u=(0,fe.jL)(a);return(0,b.Wg)(this.data)[u*this.texelSize+h]}setData(a,h,u){const d=(0,fe.jL)(a);0!=(this.layout&1<<h)?(this.data[d*this.texelSize+h]=u,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)):ct.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===ot.Br.UNSIGNED_BYTE&&this._shared&&It.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===ot.Br.UNSIGNED_BYTE&&this._shared&&It.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const h=this._initData(this.pixelType,a,this._shared,this._ctype),u=(0,b.Wg)(this.data);h.set(u),this.data=h}}toMessage(){const a=this.dirtyStart,h=this.dirtyEnd,u=this.texelSize;if(a>h)return null;this._resetRange();const d=!(this._shared||"local"===this._ctype),g=this.pixelType,f=this.layout,m=(0,b.Wg)(this.data);return{start:a,end:h,data:d&&m.slice(a*u,(h+1)*u)||null,pixelType:g,layout:f}}_initData(a,h,u,d){const g=u&&"local"!==d?SharedArrayBuffer:ArrayBuffer,f=(0,qs.UK)(a),m=new f(new g(h*h*4*f.BYTES_PER_ELEMENT));for(let y=0;y<m.length;y+=4)m[y+1]=255;return m}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class ir{constructor(a,h,u=(()=>{})){this._client=a,this.config=h,this._notifyChange=u,this._attributeComputeMap=new Map,this._blocks=new Array,this._filters=new Array(Ee.m4),this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._idsToHighlight=new Set;const d=h.supportsTextureFloat?ot.Br.FLOAT:ot.Br.UNSIGNED_BYTE;St(`Creating AttributeStore ${It.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:ot.Br.UNSIGNED_BYTE,layout:1},{pixelType:ot.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:ot.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15},{pixelType:d,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,h){this.config=h;const u=h.schema.processors[0].storage,d=(0,Ge.Hg)(this._schema,u);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),d&&((0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",d),a.storage.data=!0,this._schema=u,this._attributeComputeMap.clear(),!(0,b.Wi)(u))){switch(u.target){case"feature":this._targetType=fe.PX;break;case"aggregate":this._targetType=fe.xp}if("subtype"===u.type)for(const g in u.mapping){const f=u.mapping[g];if((0,b.pC)(f)&&(0,b.pC)(f.vvMapping))for(const m of f.vvMapping)this._bindAttribute(m)}else{if((0,b.pC)(u.vvMapping))for(const g of u.vvMapping)this._bindAttribute(g);if((0,b.pC)(u.attributeMapping))for(const g of u.attributeMapping)this._bindAttribute(g)}}}onTileData(a,h){if((0,b.Wi)(h.addOrUpdate))return;const u=h.addOrUpdate.getCursor();for(;u.next();){const d=u.getDisplayId();this.setAttributeData(d,u)}}invalidateResources(){this._createResourcesPromise=null,this._abortController.abort(),this._abortController=new AbortController}setHighlight(a,h){var u=this;return(0,P.Z)(function*(){const g=u._getBlock(0),f=h.map(m=>(0,fe.jL)(m));g.lock(),g.unsetComponentAllTexels(0,1),g.setComponent(0,1,f),g.unlock(),u._idsToHighlight.clear();for(const m of a)u._idsToHighlight.add(m);yield u.sendUpdates()})()}updateFilters(a,h,u){var d=this;return(0,P.Z)(function*(){const{service:g,spatialReference:f}=u,{filters:m}=h,y=m.map((I,v)=>d._updateFilter(I,v,g,f));(yield Promise.all(y)).some(I=>I)&&(a.storage.filters=!0,(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,h,u,d){const g=(0,fe.jL)(a);this._ensureSizeForTexel(g),this._getBlock(h).setData(a,u,d)}getData(a,h,u){return this._getBlock(h).getData(a,u)}getHighlightFlag(a){return this._idsToHighlight.has(a)?Ee.uG:0}unsetAttributeData(a){const h=(0,fe.jL)(a);this._getBlock(0).setData(h,0,0)}setAttributeData(a,h){const u=(0,fe.jL)(a);if(this._ensureSizeForTexel(u),this._getBlock(0).setData(u,0,this.getFilterFlags(h)),this._targetType!==(0,fe.vs)(a))return;const d=this._attributeComputeMap,g=this.config.supportsTextureFloat?1:2;d.size&&d.forEach((m,y)=>{const I=y*g%4,v=Math.floor(y*g/4),M=this._getBlock(v+Ee.aK),B=m(h);if(this.config.supportsTextureFloat)M.setData(u,I,B);else if(B===Ee.AI)M.setData(u,I,255),M.setData(u,I+1,255);else{const U=(0,Qs.uZ)(Math.round(B),-32767,32766)+32768,Y=(65280&U)>>8;M.setData(u,I,255&U),M.setData(u,I+1,Y)}})}sendUpdates(){if((0,C.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,j.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(h=>(0,b.pC)(h)?h.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const h=()=>{if(this._currUpdate=null,this._nextUpdate){const d=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>d.resolve())}else(0,C.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,C.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const u=this._client.update(a,this._signal).then(h).catch(h);return this._client.render(this._signal),u}).catch(h=>{if((0,j.D_)(h))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),ct.error(new T.Z("mapview-attribute-store","Encountered an error during client update",h))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a){let d;if(null!=a.fieldIndex)d=function u(){return a.normalizationField&&ct.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),f=>f.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;d=function h(){return a.normalizationField?f=>{const m=f.readAttribute(a.normalizationField);return m?f.readAttribute(a.field)/m:null}:f=>f.readAttribute(a.field)}()}a.valueRepresentation&&(d=is(d,f=>function $s(c,a){if(!c||!a)return c;switch(a){case"radius":case"distance":return 2*c;case"diameter":case"width":return c;case"area":return Math.sqrt(c)}return c}(f,a.valueRepresentation))),this._attributeComputeMap.set(a.binding,is(d,f=>null===f||isNaN(f)||f===1/0?Ee.AI:f))}_createResources(){if((0,b.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(Ee.xl),this._getBlock(Ee.pU),St("Initializing AttributeStore");const a={shared:It.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,b.Fd)(this._blocks,u=>({textureOnly:u.textureOnly,buffer:u.buffer,pixelType:u.pixelType}))},h=this._client.initialize(a,this._signal).catch(u=>{(0,j.D_)(u)?this._createResourcesPromise=null:ct.error(new T.Z("mapview-attribute-store","Encountered an error during client initialization",u))});return this._createResourcesPromise=h,h.then(()=>(0,b.Wi)(this._createResourcesPromise)?this._createResources():void 0),h}_getBlock(a){const h=this._blocks[a];if((0,b.pC)(h))return h;St(`Initializing AttributeBlock at index ${a}`);const g=new rr(It.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=g,this._createResourcesPromise=null,g}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return St("Expanding block size to",a,this._blocks),(0,b.JR)(this._blocks,h=>h.expand(a)),this._createResourcesPromise=null,this._size=a,0}return ct.error(new T.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,h,u,d){var g=this;return(0,P.Z)(function*(){const f=g._filters[h],m=(0,b.pC)(f)&&f.hash;if(!f&&!a||m===JSON.stringify(a))return!1;if((0,b.Wi)(a)){if(!f)return!1;const I=1<<h+1,v=g._getBlock(0);return g._filters[h]=null,v.setComponentAllTexels(0,I),g.sendUpdates(),!0}return yield(yield g._getFilter(h,u)).update(a,d),!0})()}_getFilter(a,h){var u=this;return(0,P.Z)(function*(){const d=u._filters[a];if((0,b.pC)(d))return d;const{default:g}=yield F.e(8967).then(F.bind(F,8967)),f=new g({geometryType:h.geometryType,hasM:!1,hasZ:!1,timeInfo:h.timeInfo,fieldsIndex:new p.Z(h.fields)});return u._filters[a]=f,f})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let h=0;const u=(0,fe.KS)(a.getDisplayId());for(let g=0;g<this._filters.length;g++){const m=this._filters[g];h|=(u&1<<g&&!(0,b.Wi)(m)&&!m.check(a)?0:1)<<g}let d=0;if(this._idsToHighlight.size){const g=a.getObjectId();d=this.getHighlightFlag(g)}return h<<1|d}}function kt(c,a,h,u){u%2&&(u+=1);let d=0,g=0,f=-90,m=90,y=-180,I=180;for(let v=0;v<u/2;v++){for(let M=0;M<5;M++){const B=(y+I)/2,U=h>B?1:0;d|=U<<29-(M+5*v),y=(1-U)*y+U*B,I=(1-U)*B+U*I}for(let M=0;M<5;M++){const B=(f+m)/2,U=a>B?1:0;g|=U<<29-(M+5*v),f=(1-U)*f+U*B,m=(1-U)*B+U*m}}c.geohashX=d,c.geohashY=g}function Mt(c,a,h,u,d){d%2&&(d+=1);let g=0,f=0,m=-90,y=90,I=-180,v=180;for(let M=0;M<d/2;M++){for(let B=0;B<5;B++){const U=(I+v)/2,G=u>U?1:0;g|=G<<29-(B+5*M),I=(1-G)*I+G*U,v=(1-G)*U+G*v}for(let B=0;B<5;B++){const U=(m+y)/2,G=h>U?1:0;f|=G<<29-(B+5*M),m=(1-G)*m+G*U,y=(1-G)*U+G*y}}c[2*a]=g,c[2*a+1]=f}F(29132),new Float64Array(2),new Float64Array(2);var tt=F(65234),st=F(82959);class ps{constructor(a=[],h,u=8096){this.onRelease=d=>{},this._nodes=0,this._root=new Yt(this,0,0,0),this._statisticFields=a,this._pool=u?new xt.Z(8096):null,this._serviceInfo=h}destroy(){this.clear()}_acquire(a,h,u){this._nodes++;let d=null;return(0,b.pC)(this._pool)&&(d=this._pool.dequeue()),(0,b.pC)(d)?d.realloc(a,h,u):d=new Yt(this,a,h,u),d}_release(a){this.onRelease(a),this._nodes--,(0,b.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,b.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(h=>a=Math.max(a,h.depth)),a}dropLevels(a){this.forEach(h=>{if(h.depth>=a)for(let u=0;u<h.children.length;u++){const d=h.children[u];d&&this._release(d)}}),this.forEach(h=>{if(h.depth>=a)for(let u=0;u<h.children.length;u++)h.children[u]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new Yt(this,0,0,0)}insert(a,h,u=0){const d=oe.fromOptimizedFeatures([a],this._serviceInfo).getCursor();d.next();const g=d.readGeometry();if(!g)return;const[f,m]=g.coords;this.insertCursor(d,a.displayId,f,m,a.geohashX,a.geohashY,h,u)}insertCursor(a,h,u,d,g,f,m,y=0){let I=this._root,v=0,M=0,B=0;for(;null!==I;){if(I.depth>=y&&(I.count+=1,I.xTotal+=u,I.yTotal+=d,I.xGeohashTotal+=g,I.yGeohashTotal+=f,I.referenceId=h,this._updateStatisticsCursor(a,I,1)),v>=m)return void I.add(h);const U=Math.ceil((v+1)/2),G=Math.floor((v+1)/2),Y=1-v%2,ie=30-(3*U+2*G),J=30-(2*U+3*G),ne=(g&7*Y+3*(1-Y)<<ie)>>ie,se=(f&3*Y+7*(1-Y)<<J)>>J,le=ne+se*(8*Y+4*(1-Y));M=M<<3*Y+2*(1-Y)|ne,B=B<<2*Y+3*(1-Y)|se,null==I.children[le]&&(I.children[le]=this._acquire(M,B,v+1)),v+=1,I=I.children[le]}}remove(a,h){const u=oe.fromOptimizedFeatures([a],this._serviceInfo).getCursor();u.next();const d=u.readGeometry();if(!d)return;const[g,f]=d.coords;this.removeCursor(u,g,f,a.geohashX,a.geohashY,h)}removeCursor(a,h,u,d,g,f){let m=this._root,y=0;for(;null!==m;){if(m.count-=1,m.xTotal-=h,m.yTotal-=u,m.xGeohashTotal-=d,m.yGeohashTotal-=g,this._updateStatisticsCursor(a,m,-1),y>=f)return void m.remove(a.getDisplayId());const I=Math.ceil((y+1)/2),v=Math.floor((y+1)/2),M=1-y%2,B=30-(3*I+2*v),U=30-(2*I+3*v),G=((d&7*M+3*(1-M)<<B)>>B)+((g&3*M+7*(1-M)<<U)>>U)*(8*M+4*(1-M)),Y=m.children[G];1===Y.count&&(this._release(Y),m.children[G]=null),y+=1,m=Y}}forEach(a){let h=this._root;for(;null!==h;){const u=this._linkChildren(h)||h.next;a(h),h=u}}find(a,h,u){return this._root.find(a,h,u,0,0,0)}findIf(a){let h=null;return this.forEach(u=>{a(u)&&(h=u)}),h}findAllIf(a){const h=[];return this.forEach(u=>{a(u)&&h.push(u)}),h}findSingleOccupancyNode(a,h,u,d,g){let f=this._root;for(;null!==f;){const m=f.depth,y=f.xNode,I=f.yNode,v=1-m%2,M=f.xGeohashTotal/f.count,B=f.yGeohashTotal/f.count;if(1===f.count&&a<M&&M<=u&&h<B&&B<=d)return f;if(m>=g){f=f.next;continue}const U=Math.ceil((m+1)/2),G=Math.floor((m+1)/2),Y=30-(3*U+2*G),ie=30-(2*U+3*G),J=~((1<<Y)-1),ne=~((1<<ie)-1),le=(h&ne)>>ie,ce=(u&J)>>Y,te=(d&ne)>>ie,pe=y<<3*v+2*(1-v),ve=I<<2*v+3*(1-v),ge=pe+8*v+4*(1-v),me=ve+4*v+8*(1-v),_e=Math.max(pe,(a&J)>>Y),Ue=Math.max(ve,le),De=Math.min(ge,ce),Me=Math.min(me,te);let Se=null,Te=null;for(let Ae=Ue;Ae<=Me;Ae++)for(let Ce=_e;Ce<=De;Ce++){const Re=f.children[Ce-pe+(Ae-ve)*(8*v+4*(1-v))];Re&&(Se||(Se=Re,Se.next=f.next),Te&&(Te.next=Re),Te=Re,Re.next=f.next)}f=Se||f.next}return null}getRegionDisplayIds(a,h,u,d,g){let f=this._root;const m=[];for(;null!==f;){const y=f.depth,I=f.xNode,v=f.yNode;if(y>=g){const Te=f.xGeohashTotal/f.count,Ae=f.yGeohashTotal/f.count;a<=Te&&Te<=u&&h<=Ae&&Ae<=d&&f.displayIds.forEach(Ce=>m.push(Ce)),f=f.next;continue}const M=Math.ceil((y+1)/2),B=Math.floor((y+1)/2),U=1-y%2,G=30-(3*M+2*B),Y=30-(2*M+3*B),ie=~((1<<G)-1),J=~((1<<Y)-1),se=(h&J)>>Y,le=(u&ie)>>G,ce=(d&J)>>Y,te=I<<3*U+2*(1-U),pe=v<<2*U+3*(1-U),ve=te+8*U+4*(1-U),ge=pe+4*U+8*(1-U),me=Math.max(te,(a&ie)>>G),_e=Math.max(pe,se),Ue=Math.min(ve,le),De=Math.min(ge,ce);let Me=null,Se=null;for(let Te=_e;Te<=De;Te++)for(let Ae=me;Ae<=Ue;Ae++){const Ie=f.children[Ae-te+(Te-pe)*(8*U+4*(1-U))];Ie&&(Me||(Me=Ie,Me.next=f.next),Se&&(Se.next=Ie),Se=Ie,Ie.next=f.next)}f=Me||f.next}return m}getRegionStatistics(a,h,u,d,g){let f=this._root,m=0,y=0,I=0;const v={};let M=0;for(;null!==f;){const B=f.depth,U=f.xNode,G=f.yNode;if(B>=g){const Re=f.xGeohashTotal/f.count,nt=f.yGeohashTotal/f.count;a<Re&&Re<=u&&h<nt&&nt<=d&&(m+=f.count,y+=f.xTotal,I+=f.yTotal,1===f.count&&(M=f.referenceId),this._aggregateStatistics(v,f.statistics)),f=f.next;continue}const Y=Math.ceil((B+1)/2),ie=Math.floor((B+1)/2),J=1-B%2,ne=30-(3*Y+2*ie),se=30-(2*Y+3*ie),le=~((1<<ne)-1),ce=~((1<<se)-1),pe=(h&ce)>>se,ve=(u&le)>>ne,ge=(d&ce)>>se,me=U<<3*J+2*(1-J),_e=G<<2*J+3*(1-J),Ue=me+8*J+4*(1-J),De=_e+4*J+8*(1-J),Me=Math.max(me,(a&le)>>ne),Se=Math.max(_e,pe),Te=Math.min(Ue,ve),Ae=Math.min(De,ge);let Ce=null,Ie=null;for(let Re=Se;Re<=Ae;Re++)for(let nt=Me;nt<=Te;nt++){const Oe=f.children[nt-me+(Re-_e)*(8*J+4*(1-J))];if(Oe){if(Re!==Se&&Re!==Ae&&nt!==Me&&nt!==Te){const bs=Oe.xGeohashTotal/Oe.count,Ss=Oe.yGeohashTotal/Oe.count;a<bs&&bs<=u&&h<Ss&&Ss<=d&&(m+=Oe.count,y+=Oe.xTotal,I+=Oe.yTotal,1===f.count&&(M=f.referenceId),this._aggregateStatistics(v,Oe.statistics));continue}Ce||(Ce=Oe,Ce.next=f.next),Ie&&(Ie.next=Oe),Ie=Oe,Oe.next=f.next}}f=Ce||f.next}return{count:m,attributes:this.normalizeStatistics(v,m),xTotal:y,yTotal:I,referenceId:M}}getBins(a,h,u,d,g){const f=[];let m=this._root;for(;null!==m;){const y=m.depth,I=m.xNode,v=m.yNode;if(y>=g){f.push(m),m=m.next;continue}const M=Math.ceil((y+1)/2),B=Math.floor((y+1)/2),U=1-y%2,G=30-(3*M+2*B),Y=30-(2*M+3*B),ie=~((1<<G)-1),J=~((1<<Y)-1),se=(h&J)>>Y,le=(u&ie)>>G,ce=(d&J)>>Y,te=I<<3*U+2*(1-U),pe=v<<2*U+3*(1-U),ve=te+8*U+4*(1-U),ge=pe+4*U+8*(1-U),me=Math.max(te,(a&ie)>>G),_e=Math.max(pe,se),Ue=Math.min(ve,le),De=Math.min(ge,ce);let Me=null,Se=null;for(let Te=_e;Te<=De;Te++)for(let Ae=me;Ae<=Ue;Ae++){const Ie=m.children[Ae-te+(Te-pe)*(8*U+4*(1-U))];Ie&&(Me||(Me=Ie,Me.next=m.next),Se&&(Se.next=Ie),Se=Ie,Ie.next=m.next)}m=Me||m.next}return f}_linkChildren(a){let h=null,u=null;for(let d=0;d<=a.children.length;d++){const g=a.children[d];g&&(h||(h=g,h.next=a.next),u&&(u.next=g),u=g,g.next=a.next)}return h}_updateStatisticsCursor(a,h,u){for(const d of this._statisticFields){const g=d.name,f=d.inField?a.readAttribute(d.inField):a.getComputedNumericAtIndex(d.inFieldIndex);switch(d.statisticType){case"norm":{h.statistics[g]||(h.statistics[g]={});const y=a.readAttribute(d.inNormalizationField),I=h.statistics[g].onStatisticField||0,v=h.statistics[g].onStatisticNormalizationField||0;null==f||isNaN(f)||null==y||0===y||isNaN(y)||(h.statistics[g].onStatisticField=I+u*f,h.statistics[g].onStatisticNormalizationField=v+u*y);break}case"sum":case"avg":{h.statistics[g]||(h.statistics[g]={value:0,nanCount:0});const m=h.statistics[g].value,y=h.statistics[g].nanCount;null==f||isNaN(f)?h.statistics[g].nanCount=y+u:h.statistics[g].value=m+u*f;break}case"avg_angle":{h.statistics[g]||(h.statistics[g]={x:0,y:0,nanCount:0});const m=h.statistics[g].x,y=h.statistics[g].y,I=h.statistics[g].nanCount,v=Math.PI/180;null==f||isNaN(f)?h.statistics[g].nanCount=I+u:(h.statistics[g].x=m+u*Math.cos(f*v),h.statistics[g].y=y+u*Math.sin(f*v));break}case"mode":h.statistics[g]||(h.statistics[g]={}),h.statistics[g][f]=(h.statistics[g][f]||0)+u}}}_aggregateStatistics(a,h){for(const u of this._statisticFields){const d=u.name;switch(u.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":a[d]||(a[d]={});for(const g in h[d])a[d][g]=(a[d][g]||0)+h[d][g]}}}normalizeStatistics(a,h){const u={};for(const d of this._statisticFields){const g=d.name;switch(d.statisticType){case"norm":{const f=a[g];if(h&&null==f.onStatisticNormalizationField)break;if(h&&f.onStatisticNormalizationField){u[g]=f.onStatisticField/f.onStatisticNormalizationField;break}u[g]=0;break}case"sum":{if(!h)break;const{value:f,nanCount:m}=a[g];if(!(h-m))break;u[g]=f;break}case"avg":{if(!h)break;const{value:f,nanCount:m}=a[g];if(!(h-m))break;u[g]=f/(h-m);break}case"avg_angle":{if(!h)break;const{x:f,y:m,nanCount:y}=a[g];if(!(h-y))break;const M=180/Math.PI,B=Math.atan2(m/(h-y),f/(h-y))*M;u[g]=B;break}case"mode":{const f=a[g];let m=0,y=null;for(const I in f){const v=f[I];v>m&&(m=v,y=I)}u[g]="null"===y?null:y;break}}}return u}}class Yt{constructor(a,h,u,d){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let g=0;g<this.children.length;g++)this.children[g]=null;this.xNode=h,this.yNode=u,this.depth=d}realloc(a,h,u){for(let d=0;d<this.children.length;d++)this.children[d]=null;return this.xNode=a,this.yNode=h,this.depth=u,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,h){const u=this.getLngLatBounds(),[d,g,f,m]=u,y=(0,st.iV)({rings:[[[d,g],[d,m],[f,m],[f,g],[d,g]]]},tt.Z.WGS84,a),I=(0,w.Uy)(new R.Z,y,!1,!1);return(0,b.pC)(h)?(0,w.Nh)(new R.Z,I,!1,!1,"esriGeometryPolygon",h,!1,!1):I}getLngLatBounds(){const a=this.depth,h=Math.ceil(a/2),u=Math.floor(a/2);return function ar(c,a){let h=-90,u=90,d=-180,g=180;for(let f=0;f<a;f++){const m=Math.ceil((f+1)/2),y=Math.floor((f+1)/2),I=1-f%2,v=30-(3*m+2*y),M=30-(2*m+3*y),U=2*I+3*(1-I),Y=(7*I+3*(1-I)<<v&c.geohashX)>>v,ie=(3*I+7*(1-I)<<M&c.geohashY)>>M;for(let J=3*I+2*(1-I)-1;J>=0;J--){const ne=(d+g)/2,se=Y&1<<J?1:0;d=(1-se)*d+se*ne,g=(1-se)*ne+se*g}for(let J=U-1;J>=0;J--){const ne=(h+u)/2,se=ie&1<<J?1:0;h=(1-se)*h+se*ne,u=(1-se)*ne+se*u}}return[d,h,g,u]}({geohashX:this.xNode<<30-(3*h+2*u),geohashY:this.yNode<<30-(2*h+3*u)},this.depth)}find(a,h,u,d,g,f){if(d>=u)return this;const m=1-d%2,y=3*m+2*(1-m),I=2*m+3*(1-m),v=30-g-y,M=30-f-I,U=this.children[((a&7*m+3*(1-m)<<v)>>v)+((h&3*m+7*(1-m)<<M)>>M)*(8*m+4*(1-m))];return null==U?null:U.find(a,h,u,d+1,g+y,f+I)}}var rt=F(94425),_s=F(16669),dr=F(37118),cr=F(2004);const Wt=z.Z.getLogger("esri.view.2d.layers.features.support.BinStore");function ys(c){return 57.29577951308232*c}class pr extends _s.J{constructor(a,h,u,d){super(a,u),this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=h,this._projectionSupportCheck=(0,st._W)(h,tt.Z.WGS84),this._bitsets.geohash=u.getBitset(u.createBitset()),this._bitsets.inserted=u.getBitset(u.createBitset())}destroy(){this._tree&&this._tree.destroy()}updateSchema(a,h){var u=()=>super.updateSchema,d=this;return(0,P.Z)(function*(){const g=d._schema;try{yield u().call(d,a,h),yield d._projectionSupportCheck}catch(m){}const f=(0,Ge.Hg)(g,h);h&&(!(0,b.Wi)(f)||a.source||a.storage.filters)?(((0,Ge.uD)(f,"params.fields")||(0,Ge.uD)(f,"params")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new ps(d._statisticFields,d._serviceInfo),d._tree.onRelease=m=>m.displayId&&d._storage.releaseDisplayId(m.displayId),d._geohashLevel=d._schema.params.fixedBinLevel,d._rebuildTree(),(0,C.Z)("esri-2d-update-debug")&&Wt.info("Aggregate mesh needs update due to tree changing")),(0,C.Z)("esri-2d-update-debug")&&Wt.info("Aggregate mesh needs update due to tree changing"),a.targets[h.name]=!0,a.mesh=!1):g&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,h){this._bitsets.inserted.forEachSet(u=>{if(!a.has(u)){const d=h.lookupByDisplayIdUnsafe(u);this._remove(d)}})}sweepAggregates(a,h,u){}onTileData(a,h,u,d,g=!0){if(!this._schema||(0,b.Wi)(h.addOrUpdate))return h;const f=this._getTransforms(a,this._spatialReference);{const y=h.addOrUpdate.getCursor();for(;y.next();)this._update(y,d)}if(h.status.mesh||!g)return h;const m=new Array;this._getBinsForTile(m,a,f,u),h.addOrUpdate=oe.fromOptimizedFeatures(m,we(ye({},this._serviceInfo),{geometryType:"esriGeometryPolygon"})),h.addOrUpdate.attachStorage(u),h.clear=!0,h.end=!0;{const y=h.addOrUpdate.getCursor();for(;y.next();){const I=y.getDisplayId();this._bitsets.computed.unset(I),this.setComputedAttributes(u,y,I,a.scale)}}return h}forEach(a){this._tree.forEach(a)}onTileUpdate(a){}getAggregate(a){const h=(0,fe.QS)(a,!0),u=this._tree.findIf(d=>d.displayId===h);return(0,b.yw)(u,d=>this._toAggregateGraphic(d))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toAggregateGraphic.bind(this))}getDisplayId(a){const h=this._tree.findIf(u=>u.id===a);return(0,b.yw)(h,u=>u.displayId)}getFeatureDisplayIdsForAggregate(a){const h=this._tree.findIf(u=>u.id===a);return(0,b.R2)(h,[],u=>Array.from(u.displayIds))}getDisplayIdForReferenceId(a){const h=this._tree.findIf(u=>1===u.displayIds.size&&u.displayIds.has(a));return(0,b.yw)(h,u=>u.displayId)}_toAggregateGraphic(a){const h=this._spatialReference;return{referenceId:null,objectId:a.id,displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,w.di)(a.getGeometry(h),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const h=a.getDisplayId(),u=a.getXHydrated(),d=a.getYHydrated(),g=this._geohashBuf[2*h],f=this._geohashBuf[2*h+1];this._bitsets.inserted.has(h)&&(this._bitsets.inserted.unset(h),this._tree.removeCursor(a,u,d,g,f,this._geohashLevel))}_update(a,h){const u=a.getDisplayId(),d=this._bitsets.inserted,g=h.isVisible(u);if(g===d.has(u))return;if(!g)return void this._remove(a);const f=a.getXHydrated(),m=a.getYHydrated();this._setGeohash(u,f,m)&&(this._tree.insertCursor(a,u,f,m,this._geohashBuf[2*u],this._geohashBuf[2*u+1],this._geohashLevel),d.set(u))}_setGeohash(a,h,u){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const g=ys(h/rt.sv.radius),f=g-360*Math.floor((g+180)/360);Mt(d,a,ys(Math.PI/2-2*Math.atan(Math.exp(-u/rt.sv.radius))),f,12)}else{const g=(0,st.iV)({x:h,y:u},this._spatialReference,tt.Z.WGS84);if(!g)return!1;Mt(d,a,g.y,g.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,h,u,d){try{const{xLL:g,yLL:f,xTR:m,yTR:y,level:I}=this._getGeohashBounds(h),v=this._tree.getBins(g,f,m,y,I);for(const M of v){M.displayId||(M.displayId=d.createDisplayId(!0));const B=M.getGeometry(this._spatialReference,u.tile),U=new k.u_(B,M.getAttributes());U.objectId=M.id,U.displayId=M.displayId,a.push(U)}}catch(g){return void Wt.error("Unable to get bins for tile",h.key.id)}}_getGeohash(a,h,u){const d={geohashX:0,geohashY:0};return kt(d,h,a,u),d}_getGeohashBounds(a){const h=this._getGeohashLevel(a.key.level),d=dr.Z.fromExtent(cr.Z.fromBounds([a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],this._spatialReference)),g=(0,st.iV)(d,this._spatialReference,tt.Z.WGS84,{densificationStep:64*a.resolution}),f=(0,w.Uy)(new R.Z,g,!1,!1),m=f.coords.filter((Y,ie)=>!(ie%2)),y=f.coords.filter((Y,ie)=>ie%2),I=Math.min(...m),v=Math.min(...y),M=Math.max(...m),B=Math.max(...y),U=this._getGeohash(I,v,h),G=this._getGeohash(M,B,h);return{xLL:U.geohashX,yLL:U.geohashY,xTR:G.geohashX,yTR:G.geohashY,level:h}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,h){const u={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,re.C5)(h);if(!d)return{tile:u,left:null,right:null};const[g,f]=d.valid;return{tile:u,left:we(ye({},u),{translate:[f,a.bounds[3]]}),right:we(ye({},u),{translate:[g-f+a.bounds[0],a.bounds[3]]})}}}class Vt extends k.nd{constructor(a,h,u,d,g){super(new R.Z([],[h,u]),d,null,a),this.geohashBoundsInfo=g}get count(){return this.attributes.cluster_count}static create(a,h,u,d,g,f,m,y){const I=new Vt(h,u,d,f,m);return I.displayId=a.createDisplayId(!0),I.referenceId=y,I.tileLevel=g,I}update(a,h,u,d,g,f){return this.geometry.coords[0]=a,this.geometry.coords[1]=h,this.tileLevel=u,this.attributes=d,this.geohashBoundsInfo=g,this.referenceId=null,this.referenceId=f,this}toJSON(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:we(ye({},this.attributes),{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function pt(c){return 57.29577951308232*c}class _r extends _s.J{constructor(a,h,u,d){super(a,u),this.events=new yt.Z,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=d,this.geometryInfo=a.geometryInfo,this._spatialReference=h,this._projectionSupportCheck=(0,st._W)(h,tt.Z.WGS84),this._bitsets.geohash=u.getBitset(u.createBitset()),this._bitsets.inserted=u.getBitset(u.createBitset())}destroy(){this._tree.destroy()}updateSchema(a,h){var u=()=>super.updateSchema,d=this;return(0,P.Z)(function*(){const g=d._schema;try{yield u().call(d,a,h),yield d._projectionSupportCheck}catch(m){}const f=(0,Ge.Hg)(g,h);h&&(!(0,b.Wi)(f)||a.source||a.storage.filters)?(((0,Ge.uD)(f,"params.fields")||!d._tree||a.source)&&(d._tree&&d._tree.destroy(),d._tree=new ps(d._statisticFields,d._serviceInfo),d._rebuildTree(),(0,C.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",f),a.targets[h.name]=!0,a.mesh=!1,d._aggregateValueRanges={}):g&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,h){this._bitsets.inserted.forEachSet(u=>{if(!a.has(u)){const d=h.lookupByDisplayIdUnsafe(u);this._remove(d)}})}sweepAggregates(a,h,u){this._clusters.forEach((d,g)=>{d&&d.tileLevel!==u&&(a.releaseDisplayId(d.displayId),h.unsetAttributeData(d.displayId),this._clusters.delete(g))})}onTileData(a,h,u,d,g=!0){if(!this._schema||(0,b.Wi)(h.addOrUpdate))return h;const f=this._getTransforms(a,this._spatialReference);{const I=h.addOrUpdate.getCursor();for(;I.next();)this._update(I,d)}if(h.status.mesh||!g)return h;const m=new Array;this._getClustersForTile(m,a,this._schema.params.clusterRadius,u,f),h.addOrUpdate=oe.fromOptimizedFeatures(m,this._serviceInfo),h.addOrUpdate.attachStorage(u),h.clear=!0,h.end=!0;{const I=h.addOrUpdate.getCursor();for(;I.next();){const v=I.getDisplayId();this._bitsets.computed.unset(v),this.setComputedAttributes(u,I,v,a.scale)}}return this._aggregateValueRangesChanged&&h.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),h}onTileUpdate({added:a,removed:h}){if(a.length){const d=a[0].level;this._tileLevel=d,this._setGeohashLevel(d)}if(!this._schema)return;const u=this._schema.params.clusterRadius;h.forEach(d=>{this._tiles.delete(d.key.id),this._markTileClustersForDeletion(d,u)})}getAggregate(a){for(const h of this._clusters.values())if(((null==h?void 0:h.displayId)&fe._I)==(a&fe._I))return h.toJSON();return null}getAggregates(){const a=[];for(const h of this._clusters.values())(null==h?void 0:h.tileLevel)===this._tileLevel&&a.push(h.toJSON());return a}getDisplayId(a){const h=this._clusters.get(a);return h?h.displayId:null}getFeatureDisplayIdsForAggregate(a){const h=this._clusters.get(a);if(!h)return[];const u=h.geohashBoundsInfo;return this._tree.getRegionDisplayIds(u.xLL,u.yLL,u.xTR,u.yTR,u.level)}getDisplayIdForReferenceId(a){for(const h of this._clusters.values())if((null==h?void 0:h.referenceId)===a)return h.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){for(const[h,u]of this._clusters)u&&a(u,h)}size(){let a=0;return this.forEach(h=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const h=a.getDisplayId(),u=a.getXHydrated(),d=a.getYHydrated(),g=this._geohashBuf[2*h],f=this._geohashBuf[2*h+1];this._bitsets.inserted.has(h)&&(this._bitsets.inserted.unset(h),this._tree.removeCursor(a,u,d,g,f,this._geohashLevel))}_update(a,h){const u=a.getDisplayId(),d=this._bitsets.inserted,g=h.isVisible(u);if(g===d.has(u))return;if(!g)return void this._remove(a);const f=a.getXHydrated(),m=a.getYHydrated();this._setGeohash(u,f,m)&&(this._tree.insertCursor(a,u,f,m,this._geohashBuf[2*u],this._geohashBuf[2*u+1],this._geohashLevel),d.set(u))}_setGeohash(a,h,u){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator){const g=pt(h/rt.sv.radius),f=g-360*Math.floor((g+180)/360);Mt(d,a,pt(Math.PI/2-2*Math.atan(Math.exp(-u/rt.sv.radius))),f,12)}else{const g=(0,st.iV)({x:h,y:u},this._spatialReference,tt.Z.WGS84);if(!g)return!1;Mt(d,a,g.y,g.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,h,u,d,g,f=!0){const m=this._schema.params.clusterPixelBuffer,y=2*u,I=this._getGeohashLevel(h.key.level),v=Math.ceil(2**h.key.level*Ee.I_/y),M=Math.ceil(m/y)+0,B=Math.ceil(Ee.I_/y),{row:U,col:G}=h.key,ie=U*Ee.I_,J=Math.floor(G*Ee.I_/y)-M,ne=Math.floor(ie/y)-M,se=J+B+2*M,le=ne+B+2*M,ce=h.tileInfoView.getLODInfoAt(h.key.level);for(let te=J;te<=se;te++)for(let pe=ne;pe<=le;pe++){let ve=te;ce.wrap&&(ve=te<0?te+v:te%v);const ge=ce.wrap&&te<0,me=ce.wrap&&te%v!==te,_e=this._lookupCluster(d,ce,h.key.level,ve,pe,I);if((0,b.pC)(_e)){const Ue=(0,b.yw)(g,De=>ge?De.left:me?De.right:De.tile);if(f&&(0,b.Wi)(Ue)||!_e.count)continue;if((0,b.pC)(Ue)&&f){const De=_e.geometry.clone();let Me=_e.attributes;De.coords[0]=(0,w.Jd)(Ue,De.coords[0]),De.coords[1]=(0,w.IN)(Ue,De.coords[1]),1===_e.count&&(0,b.pC)(_e.referenceId)&&(Me=we(ye({},_e.attributes),{referenceId:_e.referenceId}));const Se=new k.u_(De,Me);Se.displayId=_e.displayId,a.push(Se)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const h=this._getGeohashLevel(a),u=1*(Math.floor(h/1)+1)-1;if(this._geohashLevel!==u)return this._geohashLevel=u,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,h){const u={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},d=(0,re.C5)(h);if(!d)return{tile:u,left:null,right:null};const[g,f]=d.valid;return{tile:u,left:we(ye({},u),{translate:[f,a.bounds[3]]}),right:we(ye({},u),{translate:[g-f+a.bounds[0],a.bounds[3]]})}}_getClusterId(a,h,u){return(15&a)<<28|(16383&h)<<14|16383&u}_markForDeletion(a,h,u){const d=this._getClusterId(a,h,u);this._clusters.delete(d)}_getClusterBounds(a,h,u){const d=this._schema.params.clusterRadius,g=2*d;let f=u%2?h*g:h*g-d;const m=u*g;let y=f+g;const v=2**a.level*Ee.I_;a.wrap&&f<0&&(f=0),a.wrap&&y>v&&(y=v);const B=m/Ee.I_,U=y/Ee.I_,G=(m-g)/Ee.I_;return[a.getXForColumn(f/Ee.I_),a.getYForRow(B),a.getXForColumn(U),a.getYForRow(G)]}_lookupCluster(a,h,u,d,g,f){const m=this._getClusterId(u,d,g),y=this._clusters.get(m),[I,v,M,B]=this._getClusterBounds(h,d,g),U={x:I,y:v},G={x:M,y:B};let Y=0,ie=0,J=0,ne=0;if(this._spatialReference.isWebMercator){{const Ie=pt(U.x/rt.sv.radius);Y=Ie-360*Math.floor((Ie+180)/360),ie=pt(Math.PI/2-2*Math.atan(Math.exp(-U.y/rt.sv.radius)))}{const Ie=pt(G.x/rt.sv.radius);J=Ie-360*Math.floor((Ie+180)/360),ne=pt(Math.PI/2-2*Math.atan(Math.exp(-G.y/rt.sv.radius)))}}else{const Ie=(0,st.iV)(U,this._spatialReference,tt.Z.WGS84),Re=(0,st.iV)(G,this._spatialReference,tt.Z.WGS84);if(!Ie||!Re)return null;Y=Ie.x,ie=Ie.y,J=Re.x,ne=Re.y}const se={geohashX:0,geohashY:0},le={geohashX:0,geohashY:0};kt(se,ie,Y,f),kt(le,ne,J,f);const ce=se.geohashX,te=se.geohashY,pe=le.geohashX,ve=le.geohashY,ge={xLL:ce,yLL:te,xTR:pe,yTR:ve,level:f},me=this._tree.getRegionStatistics(ce,te,pe,ve,f),{count:_e,xTotal:Ue,yTotal:De,referenceId:Me}=me,Se=_e?Ue/_e:0,Te=_e?De/_e:0;if(0===_e)return this._clusters.set(m,null),null;const Ae=ye({cluster_count:_e},me.attributes),Ce=(0,b.pC)(y)?y.update(Se,Te,u,Ae,ge,Me):Vt.create(a,m,Se,Te,u,Ae,ge,Me);return 0===_e&&(Ce.geometry.coords[0]=(I+M)/2,Ce.geometry.coords[1]=(v+B)/2),this._clusters.set(m,Ce),this._updateAggregateValueRangeForCluster(Ce,Ce.tileLevel),Ce}_updateAggregateValueRangeForCluster(a,h){const u=this._aggregateValueRanges[h]||{minValue:1/0,maxValue:0},d=u.minValue,g=u.maxValue;u.minValue=Math.min(d,a.count),u.maxValue=Math.max(g,a.count),this._aggregateValueRanges[h]=u,d===u.minValue&&g===u.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,h){const u=2*h,d=Math.ceil(Ee.I_/u),{row:g,col:f}=a.key,y=g*Ee.I_,I=Math.floor(f*Ee.I_/u),v=Math.floor(y/u);for(let M=I;M<I+d;M++)for(let B=v;B<v+d;B++)this._markForDeletion(a.key.level,M,B)}}class mr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,fe.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var yr=F(42797);function Tt(c,a,h){if(!(c.length>a))for(;c.length<=a;)c.push(h)}class Ir{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new mr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(yr.p.create(this._allocatedSize,fe._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,h){this._numerics[a]||(this._numerics[a]=[]),Tt(this._numerics[a],h,0)}_ensureInstanceId(a){Tt(this._instanceIds,a,0)}_ensureString(a,h){this._strings[a]||(this._strings[a]=[]),Tt(this._strings[a],h,null)}createDisplayId(a=!1){const h=this._idGenerator.createId();return h>this._allocatedSize&&this._expand(),(0,fe.QS)(h,a)}releaseDisplayId(a){for(const h of this._bitsets)h.unset(a);return this._idGenerator.releaseId(a&fe._I)}getComputedNumeric(a,h){return this.getComputedNumericAtIndex(a&fe._I,0)}setComputedNumeric(a,h,u){return this.setComputedNumericAtIndex(a&fe._I,u,0)}getComputedString(a,h){return this.getComputedStringAtIndex(a&fe._I,0)}setComputedString(a,h,u){return this.setComputedStringAtIndex(a&fe._I,0,u)}getComputedNumericAtIndex(a,h){const u=a&fe._I;return this._ensureNumeric(h,u),this._numerics[h][u]}setComputedNumericAtIndex(a,h,u){const d=a&fe._I;this._ensureNumeric(h,d),this._numerics[h][d]=u}getInstanceId(a){const h=a&fe._I;return this._ensureInstanceId(h),this._instanceIds[h]}setInstanceId(a,h){const u=a&fe._I;this._ensureInstanceId(u),this._instanceIds[u]=h}getComputedStringAtIndex(a,h){const u=a&fe._I;return this._ensureString(h,u),this._strings[h][u]}setComputedStringAtIndex(a,h,u){const d=a&fe._I;this._ensureString(h,d),this._strings[h][d]=u}getXMin(a){return this._bounds[4*(a&fe._I)]}getYMin(a){return this._bounds[4*(a&fe._I)+1]}getXMax(a){return this._bounds[4*(a&fe._I)+2]}getYMax(a){return this._bounds[4*(a&fe._I)+3]}setBounds(a,h){const u=h.readHydratedGeometry();if(!u||!u.coords.length)return!1;let d=1/0,g=1/0,f=-1/0,m=-1/0;u.forEachVertex((I,v)=>{d=Math.min(d,I),g=Math.min(g,v),f=Math.max(f,I),m=Math.max(m,v)});const y=a&fe._I;return Tt(this._bounds,4*y+4,0),this._bounds[4*y]=d,this._bounds[4*y+1]=g,this._bounds[4*y+2]=f,this._bounds[4*y+3]=m,!0}}function it(c){if(!(0,j.D_)(c)&&!function Cr(c){return"worker:port-closed"===c.name}(c))throw c}function vs(c){return"feature"===c.type&&"snapshot"===c.mode}let We=class extends N.r{constructor(){super(...arguments),this._storage=new Ir,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new zt.e({concurrency:"geoevent"===this._source.type?1:4,process:(c,a)=>this._onTileMessage(c,{signal:a})}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,L.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function Xs(c,a,h,u,d,g){const f=function Vs(c,a,h,u,d,g){switch(c.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,b.Pt)(c.featureCount,0),serviceInfo:c,onMessage:u,outSR:a,tileInfoView:h,canAcceptRequest:d,store:g};case"stream":return{type:"geoevent",serviceInfo:c,onMessage:u,outSR:a,canAcceptRequest:d};case"memory":case"on-demand":return{type:"feature",serviceInfo:c,onMessage:u,outSR:a,origin:function f(m){return Array.isArray(m)?"local":"path"in m&&(0,x.M8)(m.path)?"hosted":"unknown"}(c.source),tileInfoView:h,canAcceptRequest:d}}}(c,a,h,u,d,g);switch(f.type){case"feature":switch(f.origin){case"hosted":case"local":return new Gs(f);case"snapshot":return new Ws(f);case"unknown":return new As(f)}case"geoevent":return new Ls(f)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(u,d)=>(this._invalidated=!0,this._patchTile(u,d)),()=>this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("geoevent"===this._source.type){const c=this._source.events;this.handles.add([c.on("connectionStatus",a=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:a}).catch(it)),c.on("errorString",a=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:a}).catch(it)),c.on("feature",a=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry}}).catch(it)),c.on("updateRate",a=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:ye({},a)}).catch(it))])}}_initAttributeStore(c){this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new ir({type:"remote",initialize:(a,h)=>(0,j.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:h}).catch(it)),update:(a,h)=>(0,j.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:h}).catch(it)),render:a=>(0,j.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(it))},c,()=>this.notifyChange("updating"))}_initStores(){this.featureStore=new _.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(c){var h;const a=this;null==(h=this.queryEngine)||h.destroy(),this.queryEngine=new O.q({definitionExpression:c.schema.source.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:u=>(0,b.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(u).map(d=>a.getObjectId(d))},timeInfo:this.service.timeInfo})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();for(const c of this.tileStore.tiles)this._source.unsubscribe(c);clearInterval(this._checkUpdating)}get fieldsIndex(){return new p.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const c=this._source.updating,a=!!this._updateQueue.length,h=!this.attributeStore||this.attributeStore.isUpdating(),u=c||a||h;return(0,C.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${u}\n  -> updatingSource ${c}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${h}\n`),u}enableEvent(c){this._source.enableEvent(c.name,c.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"geoevent"===this._source.type&&this._source.pauseStream()}resumeStream(){"geoevent"===this._source.type&&this._source.resumeStream()}_initAggregateStore(c){var d,g;const a={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},h=null==(g=null==(d=c.schema.targets)?void 0:d.aggregate)?void 0:g.type;if((0,b.yw)(this.config,f=>{var m,y;return null==(y=null==(m=f.schema.targets)?void 0:m.aggregate)?void 0:y.type})!==h&&((0,b.pC)(this.aggregateStore)&&(this.handles.remove("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),h)){switch(h){case"cluster":this.aggregateStore=new _r(a,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",f=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:f.valueRanges}}).catch(it)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new pr(a,this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(c,a){var h=this;return(0,P.Z)(function*(){h._updateVersion++,h._initQueryEngine(a),h._initAttributeStore(a),h.pause(),yield Promise.all([h._source.update(c,a.schema.source),h.featureStore.updateSchema(c,a.schema.targets.feature),h.attributeStore.update(c,a),h.attributeStore.updateFilters(c,a,h)]),h._initAggregateStore(a),(0,b.pC)(h.aggregateStore)&&(yield h.aggregateStore.updateSchema(c,a.schema.targets.aggregate)),(0,C.Z)("esri-2d-update-debug")&&c.describe(),h._set("config",a)})()}applyUpdate(c){var a=this;return(0,P.Z)(function*(){c.version=a._updateVersion,(0,C.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${c.version}`),c.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(c),a.notifyChange("updating"),yield(0,L.N1)(()=>!a.updating),(0,b.pC)(a.aggregateStore)&&(yield(0,j.e4)(10),yield(0,L.N1)(()=>!a.updating))})()}onEdits({edits:c}){var a=this;return(0,P.Z)(function*(){(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",c),a._didEdit=!0;try{const h=c.removed.map(d=>d.objectId&&-1!==d.objectId?d.objectId:a._lookupObjectIdByGlobalId(d.globalId)),u=c.addOrModified.map(({objectId:d})=>d);a.featureStore.invalidate(),yield a._source.edit(u,h),a.clearTiles(),a.notifyChange("updating"),(0,b.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,L.N1)(()=>!a.updating)}catch(h){}})()}refresh(c){var a=this;return(0,P.Z)(function*(){if(!c){const h=Fe.empty();return h.storage.filters=!0,a.applyUpdate(h)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,L.N1)(()=>!a.updating)})()}clearTiles(){for(const c of this.tileStore.tiles)this.processor.onTileClear(c)}onTileUpdate(c){(0,b.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(c);for(const a of c.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of c.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var c=this;return(0,P.Z)(function*(){c._invalidated&&(c._invalidated=!1,((0,b.pC)(c.aggregateStore)||"heatmap"===c.processor.type)&&(yield c._repushCurrentLevelTiles())),c._markAndSweep()})()}querySummaryStatistics({query:c,params:a}){var h=this;return(0,P.Z)(function*(){return h.queryEngine.executeQueryForSummaryStatistics(c,a)})()}queryUniqueValues({query:c,params:a}){var h=this;return(0,P.Z)(function*(){return h.queryEngine.executeQueryForUniqueValues(c,a)})()}queryClassBreaks({query:c,params:a}){var h=this;return(0,P.Z)(function*(){return h.queryEngine.executeQueryForClassBreaks(c,a)})()}queryHistogram({query:c,params:a}){var h=this;return(0,P.Z)(function*(){return h.queryEngine.executeQueryForHistogram(c,a)})()}queryExtent(c){return this.queryEngine.executeQueryForExtent(c)}queryFeatures(c){return this.queryEngine.executeQuery(c)}queryVisibleFeatures(c){var a=this;return(0,P.Z)(function*(){const h=yield a.queryEngine.executeQuery(c),u=h.objectIdFieldName;return h.features=h.features.filter(d=>{const f=a.getDisplayId(d.attributes[u]);return(0,b.yw)(f,m=>a.attributeStore.isVisible(m))}),h})()}queryFeatureCount(c){return this.queryEngine.executeQueryForCount(c)}queryLatestObservations(c){return this.queryEngine.executeQueryForLatestObservations(c)}queryObjectIds(c){return this.queryEngine.executeQueryForIds(c)}queryStatistics(){var c=this;return(0,P.Z)(function*(){return c.featureStore.storeStatistics})()}getObjectId(c){return this.featureStore.lookupObjectId(c,this._storage)}getDisplayId(c){if((0,b.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(c);if((0,b.Wi)(a)){const h=this.featureStore.lookupDisplayId(c);return this.aggregateStore.getDisplayIdForReferenceId(h)}return a}return this.featureStore.lookupDisplayId(c)}getFeatures(c){const a=[],h=[];for(const u of c){const d=(0,b.pC)(this.aggregateStore)?this.getAggregate(u):null;if((0,b.pC)(d))if((0,b.pC)(d.referenceId)){const g=this.getFeature(d.referenceId);(0,b.pC)(g)&&a.push(g)}else h.push(d);else{const g=this.getFeature(u);(0,b.pC)(g)&&a.push(g)}}return{features:a,aggregates:h}}getFeature(c){const a=this.featureStore.lookupFeatureByDisplayId(c,this._storage);if((0,b.Wi)(a))return null;const h=a.readHydratedGeometry(),u=(0,w.di)(h,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:u}}getAggregate(c){return(0,b.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(c)}getAggregates(){return(0,b.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(c){var a=this;return(0,P.Z)(function*(){const h=(0,b.lV)(c.map(u=>a.getDisplayId(u)));return a.attributeStore.setHighlight(c,h)})()}_lookupObjectIdByGlobalId(c){const a=this.service.globalIdField;if((0,b.Wi)(a))throw new Error("Expected globalIdField to be defined");let h=null;if(this.featureStore.forEach(u=>{c===u.readAttribute(a)&&(h=u.getObjectId())}),(0,b.Wi)(h))throw new Error(`Expected to find a feature with globalId ${c}`);return h}_repushCurrentLevelTiles(){var c=this;return(0,P.Z)(function*(){const a=c.tileStore.tiles.filter(h=>h.level===c._level).map(function(){var h=(0,P.Z)(function*(u){return c._patchTile({type:"append",id:u.key.id,addOrUpdate:oe.fromOptimizedFeatures([],c.service),remove:[],end:!0,status:Fe.empty()})});return function(u){return h.apply(this,arguments)}}());yield Promise.all(a)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(c,a){const h=this._updateQueue.push(c,a).then(()=>{this.notifyChange("updating")}).catch(u=>{this.notifyChange("updating")});return this.notifyChange("updating"),h}_onTileMessage(c,a){var h=this;return(0,P.Z)(function*(){(0,j.k_)(a);const u=h.tileStore.get(c.id);if(!u)return;if(c.clear)return h.processor.onTileClear(u);const d=c.status;h._cleanupNeeded=!0;const g=[];for(const f of c.remove){const m=h.featureStore.lookupDisplayId(f);m&&g.push(m)}c.remove=g;try{if((0,b.Wi)(c.addOrUpdate))return void h.processor.onTileMessage(u,we(ye({},c),{addOrUpdate:null}),(0,b.pC)(h.aggregateStore),a).catch(j.H9);if(c.addOrUpdate.setArcadeSpatialReference(h.spatialReference),h.featureStore.hasInstance(c.addOrUpdate.instance)&&d.targets.feature||(d.targets.feature=!0,h.featureStore.onTileData(u,c)),(!d.storage.data||!d.storage.filters)&&(d.storage.data=!0,d.storage.filters=!0,h.attributeStore.onTileData(u,c),"geoevent"===h._source.type||h._didEdit?(yield h.attributeStore.sendUpdates(),(0,j.k_)(a)):h.attributeStore.sendUpdates()),(0,b.pC)(h.aggregateStore)&&!d.targets.aggregate){d.targets.aggregate=!0;const f=vs(h._source)&&h._source.loading,m=!vs(h._source)||f||c.end;if(h.aggregateStore.onTileData(u,c,h._storage,h.attributeStore,m),!m)return;d.mesh||(h.attributeStore.onTileData(u,c),yield h.attributeStore.sendUpdates())}d.mesh||(d.mesh=!0,yield h.processor.onTileMessage(u,c,(0,b.pC)(h.aggregateStore),a),(0,j.k_)(a)),h._maybeForceCleanup()}catch(f){(0,j.H9)(f)}})()}_mark(c,a,h){const u=(4294901760&this._storage.getInstanceId(c))>>>16;c&&(a.add(u),h.set(c))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const c=this._storage.getBitset(this._markedIdsBufId),a=new Set;c.clear();for(const h of this.tileStore.tiles)for(const u of this._source.readers(h.id)){const d=u.getCursor();for(;d.next();){let g=d.getDisplayId();if(!g){const f=d.getObjectId();g=this.featureStore.lookupDisplayId(f)}this._mark(g,a,c)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(h=>{this._mark(h,a,c)}),this._updateQueue.forEach(h=>{for(const u of h.remove){const d=this.featureStore.lookupDisplayId(u);this._mark(d,a,c)}}),(0,b.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(c,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(c,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,$._)([(0,Q.Cb)({constructOnly:!0})],We.prototype,"tileStore",void 0),(0,$._)([(0,Q.Cb)()],We.prototype,"config",void 0),(0,$._)([(0,Q.Cb)({readOnly:!0})],We.prototype,"fieldsIndex",null),(0,$._)([(0,Q.Cb)()],We.prototype,"processor",void 0),(0,$._)([(0,Q.Cb)({constructOnly:!0})],We.prototype,"remoteClient",void 0),(0,$._)([(0,Q.Cb)({constructOnly:!0})],We.prototype,"service",void 0),(0,$._)([(0,Q.Cb)()],We.prototype,"spatialReference",null),(0,$._)([(0,Q.Cb)()],We.prototype,"updating",null),We=(0,$._)([(0,K.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],We);const Fr=We;var xs=F(81340),Mr=F(84378),Tr=F(58098);const at={added:[],removed:[]},Qt=new Set,Ar=new Tr.Z(0,0,0,0);class wr extends yt.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,es.r)(9,(0,C.Z)("esri-csp-restrictions")?h=>({minX:h.bounds[0],minY:h.bounds[1],maxX:h.bounds[2],maxY:h.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const h={added:[],removed:[]};for(const u of a.added)if(!this.has(u)){const d=new xs.n(this.tileScheme,u);this._tiles.set(u,d),this._index.insert(d),h.added.push(d)}for(const u of a.removed)if(this.has(u)){const d=this.get(u);this._tiles.delete(u),this._index.remove(d),h.removed.push(d)}this.tiles.length=0,this._tiles.forEach(u=>this.tiles.push(u)),(h.added.length||h.removed.length)&&this.emit("update",h)}setViewState(a){const h=this.tileScheme.getTileCoverage(a,0);if(!h)return;const{spans:u,lodInfo:d}=h,{level:g}=d;if(u.length>0)for(const{row:f,colFrom:m,colTo:y}of u)for(let I=m;I<=y;I++){const v=Ar.set(g,f,d.normalizeCol(I),d.getWorldForColumn(I)).id;if(Qt.add(v),!this.has(v)){const M=new xs.n(this.tileScheme,v);this._tiles.set(v,M),this._index.insert(M),this.tiles.push(M),at.added.push(M)}}for(let f=this.tiles.length-1;f>=0;f--){const m=this.tiles[f];Qt.has(m.id)||(this._tiles.delete(m.id),this.tiles.splice(f,1),this._index.remove(m),at.removed.push(m))}(at.added.length||at.removed.length)&&this.emit("update",at),Mr.Z.pool.release(h),Qt.clear(),at.added.length=0,at.removed.length=0}}var Er=F(9598);let ht=class extends N.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,L.YP)(()=>this.updating,c=>{this.remoteClient.invoke("setUpdating",c).catch(a=>{})}))}destroy(){var c,a;this.stop(),null==(c=this.controller)||c.destroy(),null==(a=this.processor)||a.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){var c,a,h;this._paused=!0,Array.isArray(null==(c=this.service)?void 0:c.source)&&(this.service.source.forEach(u=>u.close()),this.service.source.length=0),null==(a=this.tileStore)||a.updateTiles({added:[],removed:this.tileStore.tiles.map(u=>u.id)}),null==(h=this.tileStore)||h.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:c,config:a,tileInfo:h,tiles:u}){var d=this;return(0,P.Z)(function*(){var g,f,m;if(d._paused=!0,Array.isArray(null==(g=d.service)?void 0:g.source)&&(d.service.source.forEach(y=>y.close()),d.service.source.length=0),d.service=c,!d.tileStore||!(0,re.fS)(d.tileStore.tileScheme.spatialReference,h.spatialReference)){const y=new Er.Z(W.Z.fromJSON(h));u.added.length=u.removed.length=0,null==(f=d.tileStore)||f.updateTiles({added:[],removed:d.tileStore.tiles.map(I=>I.id)}),null==(m=d.tileStore)||m.destroy(),d.tileStore=new wr(y),d._pendingTileUpdates.length=0}for(yield d._createProcessorAndController(a),yield d.update({config:a}),d.controller.resume(),d.tileStore.clear(),d.tileStore.updateTiles(u),d._paused=!1;d._pendingTileUpdates.length;)d.tileStore.updateTiles(d._pendingTileUpdates.pop())})()}updateTiles(c){var a=this;return(0,P.Z)(function*(){a._paused?a._pendingTileUpdates.push(c):a.tileStore.updateTiles(c)})()}update({config:c}){var a=this;return(0,P.Z)(function*(){const h=Fe.empty();return yield Promise.all([a.processor.update(h,c),a.controller.update(h,c)]),h.toJSON()})()}applyUpdate(c){var a=this;return(0,P.Z)(function*(){return a.controller.applyUpdate(Fe.create(c))})()}_createProcessorAndController(c){var a=this;return(0,P.Z)(function*(){yield Promise.all([a._handleControllerConfig(c),a._handleProcessorConfig(c)]),a.controller.processor=a.processor})()}_handleControllerConfig(c){var a=this;return(0,P.Z)(function*(){return a._createController(a.service,c)})()}_handleProcessorConfig(c){var a=this;return(0,P.Z)(function*(){return a._createProcessor(a.service,c)})()}_createController(c,a){var h=this;return(0,P.Z)(function*(){h.controller&&h.controller.destroy();const{tileStore:u,remoteClient:d}=h,g=new Fr({service:c,tileStore:u,remoteClient:d});return h.controller=g,g})()}_createProcessor(c,a){var h=this;return(0,P.Z)(function*(){const u=a.schema.processors[0].type,d=(yield function q(c){return"heatmap"===c?Promise.all([F.e(8592),F.e(7434)]).then(F.bind(F,67434)):Promise.all([F.e(3751),F.e(4654),F.e(3141),F.e(4522),F.e(8592),F.e(8460)]).then(F.bind(F,28460))}(u)).default,{remoteClient:g,tileStore:f}=h,m=new d({service:c,config:a,tileStore:f,remoteClient:g});return h.processor&&h.processor.destroy(),h.processor=m,m})()}};(0,$._)([(0,Q.Cb)()],ht.prototype,"controller",void 0),(0,$._)([(0,Q.Cb)()],ht.prototype,"processor",void 0),(0,$._)([(0,Q.Cb)()],ht.prototype,"updating",null),(0,$._)([(0,Q.Cb)()],ht.prototype,"viewState",void 0),ht=(0,$._)([(0,K.j)("esri.views.2d.layers.features.Pipeline")],ht);const Dr=ht},16669:(xe,he,F)=>{F.d(he,{J:()=>K});var P=F(15861),$=F(8314),N=F(62208),C=F(84682),L=F(46679),Q=F(63290);const Z=Promise.resolve().then(F.bind(F,22445));class K{constructor(W,q){this._canCacheExpressionValue=!1,this._sourceInfo=W,this._storage=q,this._bitsets={computed:q.getBitset(q.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema(W,q){var b=this;return(0,P.Z)(function*(){const j=(0,C.Hg)(b._schema,q);if(b._schema=q,!q||(0,N.Wi)(j)||!(0,C.uD)(j,"attributes"))return;(0,$.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",j),b._bitsets.computed.clear(),W.targets[q.name]=!0;const w=q.attributes,O=[],p=[];for(const _ in w){const x=w[_];switch(x.type){case"field":break;case"expression":O.push(b._createArcadeComputedField(x));break;case"label-expression":O.push(b._createLabelArcadeComputedField(x));break;case"statistic":p.push(x)}}b._computedFields=yield Promise.all(O),b._canCacheExpressionValue=!b._computedFields.some(_=>"expression"===_.type&&_.expression.referencesScale()),b._statisticFields=p})()}setComputedAttributes(W,q,b,j){const w=this._bitsets.computed;if(!this._canCacheExpressionValue||!w.has(b)){w.set(b);for(const O of this._computedFields){const p=this._evaluateField(q,O,j);switch(O.resultType){case"numeric":W.setComputedNumericAtIndex(b,O.fieldIndex,p);break;case"string":W.setComputedStringAtIndex(b,O.fieldIndex,p)}}}}_createArcadeComputedField(W){var q=this;return(0,P.Z)(function*(){const b=q._sourceInfo.spatialReference,j=q._sourceInfo.fieldsIndex;return we(ye({},W),{expression:yield(0,L.Yi)(W.valueExpression,b,j)})})()}_createLabelArcadeComputedField(W){var q=this;return(0,P.Z)(function*(){const b=q._sourceInfo.spatialReference,j=q._sourceInfo.fieldsIndex,{createLabelFunction:w}=yield Z,O=yield w(W.label,j,b);return we(ye({},W),{builder:O})})()}_evaluateField(W,q,b){switch(q.type){case"label-expression":{const j=W.readArcadeFeature();return q.builder.evaluate(j)||""}case"expression":{const{expression:j}=q;return function ae(re,W,q){re.referencesGeometry();const b=W.readArcadeFeature();try{return re.evaluate(we(ye({},q),{$feature:b}))}catch(j){return Q.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",j),null}}(j,W,{$view:{scale:b}})}}}}},25208:(xe,he,F)=>{var z,E,V;F.d(he,{s:()=>T}),F(29132);var $=F(8314),N=F(62208),C=F(77044),L=F(82054),Q=F(88071),ae=F(42797),Z=F(91179);let K=0;const re=null!=(z=(0,$.Z)("featurelayer-simplify-thresholds"))?z:[.5,.5,.5,.5],W=re[0],q=re[1],b=re[2],j=re[3],w=null!=(E=(0,$.Z)("featurelayer-simplify-payload-size-factors"))?E:[1,2,4],O=w[0],p=w[1],_=w[2],x=null!=(V=(0,$.Z)("featurelayer-simplify-mobile-factor"))?V:2,S=(0,$.Z)("esri-mobile");class T{constructor(A,k){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this.instance=A,this._layerSchema=k}static createInstance(){return K++,K=K>65535?0:K,K}get isEmpty(){return(0,N.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(A){this._level=A}getAreaSimplificationThreshold(A,k){let ee=1;const de=S?x:1;k>4e6?ee=_*de:k>1e6?ee=p*de:k>5e5?ee=O*de:k>1e5&&(ee=de);let oe=0;A>4e3?oe=j*ee:A>2e3?oe=b*ee:A>100?oe=q:A>15&&(oe=W);let D=8;return this._level<4?D=1:this._level<5?D=2:this._level<6&&(D=4),oe*D}setArcadeSpatialReference(A){this._arcadeSpatialReference=A}attachStorage(A){this._storage=A}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(A){return this.getComputedNumericAtIndex(0)}setComputedNumeric(A,k){return this.setComputedNumericAtIndex(k,0)}getComputedString(A){return this.getComputedStringAtIndex(0)}setComputedString(A,k){return this.setComputedStringAtIndex(0,k)}getComputedNumericAtIndex(A){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),A)}setComputedNumericAtIndex(A,k){this._storage.setComputedNumericAtIndex(this.getDisplayId(),A,k)}getComputedStringAtIndex(A){return this._storage.getComputedStringAtIndex(this.getDisplayId(),A)}setComputedStringAtIndex(A,k){return this._storage.setComputedStringAtIndex(this.getDisplayId(),A,k)}transform(A,k,ee,de){const oe=this.copy();return oe._tx+=A,oe._ty+=k,oe._sx*=ee,oe._sy*=de,oe}readAttribute(A,k=!1){const ee=this._readAttribute(A,k);if(void 0!==ee)return ee;for(const de of this._joined){de.setIndex(this.getIndex());const oe=de._readAttribute(A,k);if(void 0!==oe)return oe}}readAttributes(){const A=this._readAttributes();for(const k of this._joined){k.setIndex(this.getIndex());const ee=k._readAttributes();for(const de of Object.keys(ee))A[de]=ee[de]}return A}joinAttributes(A){this._joined.push(A)}readArcadeFeature(){return this}geometry(){const A=this.readHydratedGeometry(),k=(0,L.di)(A,this.geometryType,this.hasZ,this.hasM),ee=(0,Z.im)(k);return ee&&(ee.spatialReference=this._arcadeSpatialReference),ee}field(A){if(this.hasField(A))return this.readAttribute(A,!0);for(const k of this._joined)if(k.setIndex(this.getIndex()),k.hasField(A))return k._readAttribute(A,!0);throw new Error(`Field ${A} does not exist`)}setField(A,k){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(){return JSON.stringify(this.readLegacyFeature())}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(A=null){return{attributes:this._readAttributes(),geometry:!0===(null==A?void 0:A.keepGeometryType)?this.geometry():this.geometry().toJSON()}}castAsJsonAsync(A=null,k=null){return Promise.resolve(this.castAsJson(k))}removeIds(A){if((0,N.Wi)(this._objectIdToIndex)){const ee=new Map,de=this.getCursor();for(;de.next();)ee.set(de.getObjectId(),de.getIndex());this._objectIdToIndex=ee}const k=this._objectIdToIndex;for(const ee of A)k.has(ee)&&this.removeAtIndex(k.get(ee))}removeAtIndex(A){(0,N.Wi)(this._deleted)&&(this._deleted=ae.p.create(this.getSize())),this._deleted.set(A)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const A=this.getCursor();for(;A.next();)yield A.readOptimizedFeature()}_getExists(){return(0,N.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const A=this.readUnquantizedGeometry();if(!A||A.hasIndeterminateRingOrder)return null;const k=(0,N.Pt)(this.getQuantizationTransform(),null);return(0,C.Y)(new Q.Z,A,this.hasM,this.hasZ,k)}copyInto(A){A.seen=this.seen,A._storage=this._storage,A._arcadeSpatialReference=this._arcadeSpatialReference,A._joined=this._joined,A._tx=this._tx,A._ty=this._ty,A._sx=this._sx,A._sy=this._sy,A._deleted=this._deleted,A._objectIdToIndex=this._objectIdToIndex}}},52397:(xe,he,F)=>{F.d(he,{t:()=>$});var P=F(25208);class $ extends P.s{constructor(C,L){super(P.s.createInstance(),C.fullSchema()),this._currentIndex=-1,this._reader=C,this._indices=L}static from(C,L){return new $(C.copy(),L)}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const C=new $(this._reader.copy(),this._indices);return C._currentIndex=this._currentIndex,C}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(C){this._reader.setArcadeSpatialReference(C)}attachStorage(C){this._reader.attachStorage(C)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(C){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(C,L){return this._reader.setComputedNumericAtIndex(L,0)}getComputedString(C){return this._reader.getComputedStringAtIndex(0)}setComputedString(C,L){return this._reader.setComputedStringAtIndex(0,L)}getComputedNumericAtIndex(C){return this._reader.getComputedNumericAtIndex(C)}setComputedNumericAtIndex(C,L){this._reader.setComputedNumericAtIndex(C,L)}getComputedStringAtIndex(C){return this._reader.getComputedStringAtIndex(C)}setComputedStringAtIndex(C,L){return this._reader.setComputedStringAtIndex(C,L)}transform(C,L,Q,ae){const Z=this.copy();return Z._reader=this._reader.transform(C,L,Q,ae),Z}readAttribute(C,L=!1){return this._reader.readAttribute(C,L)}readAttributes(){return this._reader.readAttributes()}joinAttributes(C){return this._reader.joinAttributes(C)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(C){return this.readAttribute(C,!0)}hasField(C){return this._reader.hasField(C)}setField(C,L){return this._reader.setField(C,L)}keys(){return this._reader.keys()}castToText(){return this._reader.castToText()}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(C){return this._reader.setDisplayId(C)}getGroupId(){return this._reader.getGroupId()}setGroupId(C){return this._reader.setGroupId(C)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(C){return this._reader.setIndex(C)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(C,L){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(xe,he,F)=>{F.d(he,{p:()=>P});class P{constructor(N,C){this._mask=0,this._buf=N,this._mask=C}static fromBuffer(N,C){return new P(N,C)}static create(N,C=4294967295){const L=new Uint32Array(Math.ceil(N/32));return new P(L,C)}_getIndex(N){return Math.floor(N/32)}has(N){const C=this._mask&N;return!!(this._buf[this._getIndex(C)]&1<<C%32)}hasRange(N,C){let L=N,Q=C;for(;L%32&&L!==Q;){if(this.has(L))return!0;L++}for(;Q%32&&L!==Q;){if(this.has(L))return!0;Q--}if(L===Q)return!1;for(let ae=L/32;ae!==Q/32;ae++)if(this._buf[ae])return!0;return!1}set(N){const C=this._mask&N,L=this._getIndex(C);this._buf[L]|=1<<C%32}setRange(N,C){let L=N,Q=C;for(;L%32&&L!==Q;)this.set(L++);for(;Q%32&&L!==Q;)this.set(Q--);if(L!==Q)for(let ae=L/32;ae!==Q/32;ae++)this._buf[ae]=4294967295}unset(N){const C=this._mask&N,L=this._getIndex(C);this._buf[L]&=4294967295^1<<C%32}resize(N){const C=this._buf,L=new Uint32Array(Math.ceil(N/32));L.set(C),this._buf=L}or(N){for(let C=0;C<this._buf.length;C++)this._buf[C]|=N._buf[C];return this}and(N){for(let C=0;C<this._buf.length;C++)this._buf[C]&=N._buf[C];return this}xor(N){for(let C=0;C<this._buf.length;C++)this._buf[C]^=N._buf[C];return this}ior(N){for(let C=0;C<this._buf.length;C++)this._buf[C]|=~N._buf[C];return this}iand(N){for(let C=0;C<this._buf.length;C++)this._buf[C]&=~N._buf[C];return this}ixor(N){for(let C=0;C<this._buf.length;C++)this._buf[C]^=~N._buf[C];return this}any(){for(let N=0;N<this._buf.length;N++)if(this._buf[N])return!0;return!1}copy(N){for(let C=0;C<this._buf.length;C++)this._buf[C]=N._buf[C];return this}clone(){return new P(this._buf.slice(),this._mask)}clear(){for(let N=0;N<this._buf.length;N++)this._buf[N]=0}forEachSet(N){for(let C=0;C<this._buf.length;C++){let L=this._buf[C],Q=32*C;if(L)for(;L;)1&L&&N(Q),L>>>=1,Q++}}countSet(){let N=0;return this.forEachSet(C=>{N++}),N}}},81340:(xe,he,F)=>{F.d(he,{n:()=>Q});var P=F(35575),$=F(2004),N=F(65401),C=F(89621),L=F(58098);class Q{constructor(Z,K){this.key=new L.Z(0,0,0,0),this.bounds=(0,N.Ue)(),this.objectIds=new Set,this.key.set(K);const re=Z.getLODInfoAt(this.key);this.tileInfoView=Z,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=re.resolution,this.scale=re.scale,this.level=re.level}get id(){return this.key.id}get extent(){return $.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const Z=this.key.getChildKeys(),K=P.Z.acquire();for(let re=0;re<Z.length;re++)K[re]=new Q(this.tileInfoView,Z[re]);return K}getQuantizationParameters(){return C.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}},84378:(xe,he,F)=>{F.d(he,{Z:()=>$});var P=F(27899);class ${constructor(){this.spans=[]}acquire(C){this.lodInfo=C}release(){this.lodInfo=null,this.spans.length=0}forEach(C,L){const{spans:Q,lodInfo:ae}=this,{level:Z}=ae;if(0!==Q.length)for(const{row:K,colFrom:re,colTo:W}of Q)for(let q=re;q<=W;q++)C.call(L,Z,K,ae.normalizeCol(q),ae.getWorldForColumn(q))}}$.pool=new P.Z($)},9598:(xe,he,F)=>{F.d(he,{Z:()=>w});var P=F(37053),$=F(62208),N=F(58098);function C(O,p){return[O,p]}function L(O,p,_){return O[0]=p,O[1]=_,O}const ae=new N.Z("0/0/0/0");class Z{constructor(p,_,x,S,T,z,E,V,H,A,k,ee){this.level=p,this.resolution=_,this.scale=x,this.origin=S,this.first=T,this.last=z,this.size=E,this.norm=V,this.worldStart=H,this.worldEnd=A,this.worldSize=k,this.wrap=ee}static create(p,_,x=null){const S=(0,P.C5)(p.spatialReference),T=_.origin||C(p.origin.x,p.origin.y),z=C(p.size[0]*_.resolution,p.size[1]*_.resolution),E=C(-1/0,-1/0),V=C(1/0,1/0),H=C(1/0,1/0);(0,$.pC)(x)&&(L(E,Math.max(0,Math.floor((x.xmin-T[0])/z[0])),Math.max(0,Math.floor((T[1]-x.ymax)/z[1]))),L(V,Math.max(0,Math.floor((x.xmax-T[0])/z[0])),Math.max(0,Math.floor((T[1]-x.ymin)/z[1]))),L(H,V[0]-E[0]+1,V[1]-E[1]+1));const{cols:A,rows:k}=_;let ee,de,oe,D;return!x&&A&&k&&(L(E,A[0],k[0]),L(V,A[1],k[1]),L(H,A[1]-A[0]+1,k[1]-k[0]+1)),p.isWrappable?(ee=C(Math.ceil(Math.round((S.valid[1]-S.valid[0])/_.resolution)/p.size[0]),H[1]),de=C(Math.floor((S.origin[0]-T[0])/z[0]),E[1]),oe=C(ee[0]+de[0]-1,V[1]),D=!0):(de=E,oe=V,ee=H,D=!1),new Z(_.level,_.resolution,_.scale,T,E,V,H,z,de,oe,ee,D)}normalizeCol(p){if(!this.wrap)return p;const _=this.worldSize[0];return p<0?_-1-Math.abs((p+1)%_):p%_}denormalizeCol(p,_){return this.wrap?this.worldSize[0]*_+p:p}getWorldForColumn(p){return this.wrap?Math.floor(p/this.worldSize[0]):0}getFirstColumnForWorld(p){return p*this.worldSize[0]+this.first[0]}getLastColumnForWorld(p){return p*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(p){return(p-this.origin[0])/this.norm[0]}getXForColumn(p){return this.origin[0]+p*this.norm[0]}getRowForY(p){return(this.origin[1]-p)/this.norm[1]}getYForRow(p){return this.origin[1]-p*this.norm[1]}getTileBounds(p,_,x=!1){ae.set(_);const S=x?ae.col:this.denormalizeCol(ae.col,ae.world),T=ae.row;return function Q(O,p,_,x,S){O[0]=p,O[1]=_,O[2]=x,O[3]=S}(p,this.getXForColumn(S),this.getYForRow(T+1),this.getXForColumn(S+1),this.getYForRow(T)),p}getTileCoords(p,_,x=!1){ae.set(_);const S=x?ae.col:this.denormalizeCol(ae.col,ae.world);return Array.isArray(p)?L(p,this.getXForColumn(S),this.getYForRow(ae.row)):(p.x=this.getXForColumn(S),p.y=this.getYForRow(ae.row)),p}}var K=F(84378);class re{constructor(p,_,x){this.row=p,this.colFrom=_,this.colTo=x}}const W=new N.Z("0/0/0/0");class q{constructor(p,_,x,S,T,z,E,V){this.x=p,this.ymin=_,this.ymax=x,this.invM=S,this.leftAdjust=T,this.rightAdjust=z,this.leftBound=E,this.rightBound=V}static create(p,_){p[1]>_[1]&&([p,_]=[_,p]);const[x,S]=p,[T,z]=_,E=T-x,V=z-S,H=0!==V?E/V:0,A=(Math.ceil(S)-S)*H,k=(Math.floor(S)-S)*H;return new q(x,Math.floor(S),Math.ceil(z),H,E<0?A:k,E<0?k:A,E<0?T:x,E<0?x:T)}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}}const b=[[0,0],[0,0],[0,0],[0,0]];class w{constructor(p,_=null){this.tileInfo=p,this.fullExtent=_,this.scales=[],this._lodInfos=null,this._infoByScale={},this._infoByLevel={};const x=p.lods.slice();x.sort((T,z)=>z.scale-T.scale);const S=this._lodInfos=x.map(T=>Z.create(p,T,_));x.forEach((T,z)=>{this._infoByLevel[T.level]=S[z],this._infoByScale[T.scale]=S[z],this.scales[z]=T.scale},this),this._wrap=p.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(p){return this._infoByLevel["number"==typeof p?p:p.level]}getTileBounds(p,_,x=!1){W.set(_);const S=this._infoByLevel[W.level];return S?S.getTileBounds(p,W,x):p}getTileCoords(p,_,x=!1){W.set(_);const S=this._infoByLevel[W.level];return S?S.getTileCoords(p,W,x):p}getTileCoverage(p,_=192,x="closest"){const S="closest"===x?this.getClosestInfoForScale(p.scale):this.getSmallestInfoForScale(p.scale),T=K.Z.pool.acquire(S),z=this._wrap;let E,V,H,A=1/0,k=-1/0;const ee=T.spans;b[0][0]=b[0][1]=b[1][1]=b[3][0]=-_,b[1][0]=b[2][0]=p.size[0]+_,b[2][1]=b[3][1]=p.size[1]+_;for(const R of b)p.toMap(R,R),R[0]=S.getColumnForX(R[0]),R[1]=S.getRowForY(R[1]);const de=[];let oe=3;for(let R=0;R<4;R++){if(b[R][1]===b[oe][1]){oe=R;continue}const X=q.create(b[R],b[oe]);A=Math.min(X.ymin,A),k=Math.max(X.ymax,k),void 0===de[X.ymin]&&(de[X.ymin]=[]),de[X.ymin].push(X),oe=R}if(null==A||null==k||k-A>100)return null;let D=[];for(E=A;E<k;){null!=de[E]&&(D=D.concat(de[E])),V=1/0,H=-1/0;for(let R=D.length-1;R>=0;R--){const X=D[R];V=Math.min(V,X.getLeftCol()),H=Math.max(H,X.getRightCol())}if(V=Math.floor(V),H=Math.floor(H),E>=S.first[1]&&E<=S.last[1])if(z)if(S.size[0]<S.worldSize[0]){const R=Math.floor(H/S.worldSize[0]);for(let X=Math.floor(V/S.worldSize[0]);X<=R;X++)ee.push(new re(E,Math.max(S.getFirstColumnForWorld(X),V),Math.min(S.getLastColumnForWorld(X),H)))}else ee.push(new re(E,V,H));else V>S.last[0]||H<S.first[0]||(V=Math.max(V,S.first[0]),H=Math.min(H,S.last[0]),ee.push(new re(E,V,H)));E+=1;for(let R=D.length-1;R>=0;R--){const X=D[R];X.ymax>=E?X.incrRow():D.splice(R,1)}}return T}getTileParentId(p){W.set(p);const x=this._lodInfos.indexOf(this._infoByLevel[W.level])-1;return x<0?null:(this._getTileIdAtLOD(W,this._lodInfos[x],W),W.id)}getTileResolution(p){const _=this._infoByLevel["object"==typeof p?p.level:p];return _?_.resolution:-1}getTileScale(p){const _=this._infoByLevel[p.level];return _?_.scale:-1}intersects(p,_){W.set(_);const x=this._infoByLevel[W.level],S=p.lodInfo;if(S.resolution>x.resolution){this._getTileIdAtLOD(W,S,W);const z=S.denormalizeCol(W.col,W.world);for(const E of p.spans)if(E.row===W.row&&E.colFrom<=z&&E.colTo>=z)return!0}if(S.resolution<x.resolution){const[z,E,V,H]=p.spans.reduce((D,R)=>(D[0]=Math.min(D[0],R.row),D[1]=Math.max(D[1],R.row),D[2]=Math.min(D[2],R.colFrom),D[3]=Math.max(D[3],R.colTo),D),[1/0,-1/0,1/0,-1/0]),A=x.denormalizeCol(W.col,W.world),k=S.getColumnForX(x.getXForColumn(A)),ee=S.getRowForY(x.getYForRow(W.row)),de=S.getColumnForX(x.getXForColumn(A+1))-1,oe=S.getRowForY(x.getYForRow(W.row+1))-1;return!(k>H||de<V||ee>E||oe<z)}const T=S.denormalizeCol(W.col,W.world);return p.spans.some(z=>z.row===W.row&&z.colFrom<=T&&z.colTo>=T)}normalizeBounds(p,_,x){if(p[0]=_[0],p[1]=_[1],p[2]=_[2],p[3]=_[3],this._wrap){const S=(0,P.C5)(this.tileInfo.spatialReference),T=-x*(S.valid[1]-S.valid[0]);p[0]+=T,p[2]+=T}return p}getSmallestInfoForScale(p){const _=this.scales;if(this._infoByScale[p])return this._infoByScale[p];if(p>_[0])return this._infoByScale[_[0]];for(let x=1;x<_.length-1;x++)if(p>_[x]+1e-6)return this._infoByScale[_[x-1]];return this._infoByScale[_[_.length-1]]}getClosestInfoForScale(p){const _=this.scales;return this._infoByScale[p]||(p=_.reduce((x,S)=>Math.abs(S-p)<Math.abs(x-p)?S:x,_[0])),this._infoByScale[p]}scaleToLevel(p){const _=this.scales;if(this._infoByScale[p])return this._infoByScale[p].level;for(let x=_.length-1;x>=0;x--)if(p<_[x])return x===_.length-1?this._infoByScale[_[_.length-1]].level:this._infoByScale[_[x]].level+(_[x]-p)/(_[x]-_[x+1]);return this._infoByScale[_[0]].level}scaleToZoom(p){return this.tileInfo.scaleToZoom(p)}_getTileIdAtLOD(p,_,x){const S=this._infoByLevel[x.level];return p.set(x),_.resolution<S.resolution?null:(_.resolution===S.resolution||(p.level=_.level,p.col=Math.floor(x.col*S.resolution/_.resolution+.01),p.row=Math.floor(x.row*S.resolution/_.resolution+.01)),p)}}},71251:(xe,he,F)=>{F.d(he,{e:()=>Q});var P=F(62208),$=F(10699),N=F(35133),C=F(50618);class L{constructor(Z,K){this.item=Z,this.controller=K,this.promise=null}}class Q{constructor(Z){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,Z.concurrency&&(this.concurrency=Z.concurrency),this._queue=new N.Z(Z.peeker),this.process=Z.process;const K=Z.scheduler;Z.priority&&(0,P.pC)(K)&&(this._task=K.registerTask(Z.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(Z){const K=this._controllers.get(Z);K&&K.abort()}clear(){this._queue.clear();const Z=[];this._controllers.forEach(K=>Z.push(K)),this._controllers.clear(),Z.forEach(K=>K.abort()),this._processingItems.clear(),this._cancelNext()}forEach(Z){this._deferreds.forEach((K,re)=>Z(re))}get(Z){const K=this._deferreds.get(Z);return K?K.promise:void 0}isOngoing(Z){return this._processingItems.has(Z)}has(Z){return this._deferreds.has(Z)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(Z,K){const re=this.get(Z);if(re)return re;const W=new AbortController;let q=null;K&&(q=(0,$.fu)(K,()=>W.abort()));const j=()=>{w.remove(),(0,P.pC)(q)&&q.remove(),this._deferreds.delete(Z),this._controllers.delete(Z),this._queue.remove(Z),this._processingItems.delete(Z),this._scheduleNext()},w=(0,$.$F)(W.signal,()=>{const p=this._processingItems.get(Z);p&&p.controller.abort(),j(),O.reject((0,$.zE)())}),O=(0,$.dD)();return this._deferreds.set(Z,O),this._controllers.set(Z,W),O.promise.then(j,j),this._queue.push(Z),this._scheduleNext(),O.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const Z=[];this._processingItems.forEach(K=>Z.push(K)),this._processingItems.clear();for(const K of Z)this._queue.push(K.item),K.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const Z=[];for(;this._queue.length;)Z.push(this._queue.pop());return this.clear(),Z}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(Z){for(;!Z.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),Z.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,C.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(Z,K){this._canProcessFulfillment(Z)&&(this._scheduleNext(),this._deferreds.get(Z.item).resolve(K))}_processError(Z,K){this._canProcessFulfillment(Z)&&(this._scheduleNext(),this._deferreds.get(Z.item).reject(K))}_canProcessFulfillment(Z){return!!this._deferreds.get(Z.item)&&this._processingItems.get(Z.item)===Z}_process(Z){if((0,P.Wi)(Z))return;let K;const re=new AbortController,W=new L(Z,re);this._processingItems.set(Z,W);try{K=this.process(Z,re.signal)}catch(q){this._processError(W,q)}(0,$.y8)(K)?(W.promise=K,K.then(q=>this._processResult(W,q),q=>this._processError(W,q))):this._processResult(W,K)}get test(){return{update:Z=>this.runTask(Z)}}}}}]);
"use strict";var Br=Object.defineProperty,Lr=Object.defineProperties,Zr=Object.getOwnPropertyDescriptors,Ds=Object.getOwnPropertySymbols,zr=Object.prototype.hasOwnProperty,kr=Object.prototype.propertyIsEnumerable,Us=(Ce,pe,T)=>pe in Ce?Br(Ce,pe,{enumerable:!0,configurable:!0,writable:!0,value:T}):Ce[pe]=T,Ie=(Ce,pe)=>{for(var T in pe||(pe={}))zr.call(pe,T)&&Us(Ce,T,pe[T]);if(Ds)for(var T of Ds(pe))kr.call(pe,T)&&Us(Ce,T,pe[T]);return Ce},Ee=(Ce,pe)=>Lr(Ce,Zr(pe));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[3821],{76279:(Ce,pe,T)=>{T.d(pe,{r:()=>ee});var U=T(14259);function ee(v,I){if(!(this instanceof ee))return new ee(v,I);this._maxEntries=Math.max(4,v||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),I&&("function"==typeof I?this.toBBox=I:this._initFormat(I)),this.clear()}function j(v,I,F){if(!F)return I.indexOf(v);for(var R=0;R<I.length;R++)if(F(v,I[R]))return R;return-1}function S(v,I){Z(v,0,v.children.length,I,v)}function Z(v,I,F,R,B){B||(B=G(null)),B.minX=1/0,B.minY=1/0,B.maxX=-1/0,B.maxY=-1/0;for(var W,k=I;k<F;k++)W=v.children[k],O(B,v.leaf?R(W):W);return B}function O(v,I){return v.minX=Math.min(v.minX,I.minX),v.minY=Math.min(v.minY,I.minY),v.maxX=Math.max(v.maxX,I.maxX),v.maxY=Math.max(v.maxY,I.maxY),v}function K(v,I){return v.minX-I.minX}function P(v,I){return v.minY-I.minY}function H(v){return(v.maxX-v.minX)*(v.maxY-v.minY)}function ue(v){return v.maxX-v.minX+(v.maxY-v.minY)}function $(v,I){return(Math.max(I.maxX,v.maxX)-Math.min(I.minX,v.minX))*(Math.max(I.maxY,v.maxY)-Math.min(I.minY,v.minY))}function V(v,I){var F=Math.max(v.minX,I.minX),R=Math.max(v.minY,I.minY),B=Math.min(v.maxX,I.maxX),W=Math.min(v.maxY,I.maxY);return Math.max(0,B-F)*Math.max(0,W-R)}function he(v,I){return v.minX<=I.minX&&v.minY<=I.minY&&I.maxX<=v.maxX&&I.maxY<=v.maxY}function C(v,I){return I.minX<=v.maxX&&I.minY<=v.maxY&&I.maxX>=v.minX&&I.maxY>=v.minY}function G(v){return{children:v,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(v,I,F,R,B){for(var W,k=[I,F];k.length;)(F=k.pop())-(I=k.pop())<=R||(W=I+Math.ceil((F-I)/R/2)*R,(0,U.q)(v,W,I,F,B),k.push(I,W,W,F))}ee.prototype={all:function(){return this._all(this.data,[])},search:function(v){var I=this.data,F=[],R=this.toBBox;if(!C(v,I))return F;for(var B,W,k,ie,de=[];I;){for(B=0,W=I.children.length;B<W;B++)k=I.children[B],C(v,ie=I.leaf?R(k):k)&&(I.leaf?F.push(k):he(v,ie)?this._all(k,F):de.push(k));I=de.pop()}return F},collides:function(v){var I=this.data,F=this.toBBox;if(!C(v,I))return!1;for(var R,B,W,k,ie=[];I;){for(R=0,B=I.children.length;R<B;R++)if(W=I.children[R],C(v,k=I.leaf?F(W):W)){if(I.leaf||he(v,k))return!0;ie.push(W)}I=ie.pop()}return!1},load:function(v){if(!v||!v.length)return this;if(v.length<this._minEntries){for(var I=0,F=v.length;I<F;I++)this.insert(v[I]);return this}var R=this._build(v.slice(),0,v.length-1,0);if(this.data.children.length)if(this.data.height===R.height)this._splitRoot(this.data,R);else{if(this.data.height<R.height){var B=this.data;this.data=R,R=B}this._insert(R,this.data.height-R.height-1,!0)}else this.data=R;return this},insert:function(v){return v&&this._insert(v,this.data.height-1),this},clear:function(){return this.data=G([]),this},remove:function(v,I){if(!v)return this;for(var F,R,B,W,k=this.data,ie=this.toBBox(v),de=[],me=[];k||de.length;){if(k||(k=de.pop(),R=de[de.length-1],F=me.pop(),W=!0),k.leaf&&-1!==(B=j(v,k.children,I)))return k.children.splice(B,1),de.push(k),this._condense(de),this;W||k.leaf||!he(k,ie)?R?(F++,k=R.children[F],W=!1):k=null:(de.push(k),me.push(F),F=0,R=k,k=k.children[0])}return this},toBBox:function(v){return v},compareMinX:K,compareMinY:P,toJSON:function(){return this.data},fromJSON:function(v){return this.data=v,this},_all:function(v,I){for(var F=[];v;)v.leaf?I.push.apply(I,v.children):F.push.apply(F,v.children),v=F.pop();return I},_build:function(v,I,F,R){var B,W=F-I+1,k=this._maxEntries;if(W<=k)return S(B=G(v.slice(I,F+1)),this.toBBox),B;R||(R=Math.ceil(Math.log(W)/Math.log(k)),k=Math.ceil(W/Math.pow(k,R-1))),(B=G([])).leaf=!1,B.height=R;var ie,de,me,Te,D=Math.ceil(W/k),Y=D*Math.ceil(Math.sqrt(k));for(A(v,I,F,Y,this.compareMinX),ie=I;ie<=F;ie+=Y)for(A(v,ie,me=Math.min(ie+Y-1,F),D,this.compareMinY),de=ie;de<=me;de+=D)Te=Math.min(de+D-1,me),B.children.push(this._build(v,de,Te,R-1));return S(B,this.toBBox),B},_chooseSubtree:function(v,I,F,R){for(var B,W,k,ie,de,me,Te,D;R.push(I),!I.leaf&&R.length-1!==F;){for(Te=D=1/0,B=0,W=I.children.length;B<W;B++)de=H(k=I.children[B]),(me=$(v,k)-de)<D?(D=me,Te=de<Te?de:Te,ie=k):me===D&&de<Te&&(Te=de,ie=k);I=ie||I.children[0]}return I},_insert:function(v,I,F){var B=F?v:(0,this.toBBox)(v),W=[],k=this._chooseSubtree(B,this.data,I,W);for(k.children.push(v),O(k,B);I>=0&&W[I].children.length>this._maxEntries;)this._split(W,I),I--;this._adjustParentBBoxes(B,W,I)},_split:function(v,I){var F=v[I],R=F.children.length,B=this._minEntries;this._chooseSplitAxis(F,B,R);var W=this._chooseSplitIndex(F,B,R),k=G(F.children.splice(W,F.children.length-W));k.height=F.height,k.leaf=F.leaf,S(F,this.toBBox),S(k,this.toBBox),I?v[I-1].children.push(k):this._splitRoot(F,k)},_splitRoot:function(v,I){this.data=G([v,I]),this.data.height=v.height+1,this.data.leaf=!1,S(this.data,this.toBBox)},_chooseSplitIndex:function(v,I,F){var R,B,W,k,ie,de,me,Te;for(de=me=1/0,R=I;R<=F-I;R++)k=V(B=Z(v,0,R,this.toBBox),W=Z(v,R,F,this.toBBox)),ie=H(B)+H(W),k<de?(de=k,Te=R,me=ie<me?ie:me):k===de&&ie<me&&(me=ie,Te=R);return Te},_chooseSplitAxis:function(v,I,F){var R=v.leaf?this.compareMinX:K,B=v.leaf?this.compareMinY:P;this._allDistMargin(v,I,F,R)<this._allDistMargin(v,I,F,B)&&v.children.sort(R)},_allDistMargin:function(v,I,F,R){v.children.sort(R);var B,W,k=this.toBBox,ie=Z(v,0,I,k),de=Z(v,F-I,F,k),me=ue(ie)+ue(de);for(B=I;B<F-I;B++)W=v.children[B],O(ie,v.leaf?k(W):W),me+=ue(ie);for(B=F-I-1;B>=I;B--)W=v.children[B],O(de,v.leaf?k(W):W),me+=ue(de);return me},_adjustParentBBoxes:function(v,I,F){for(var R=F;R>=0;R--)O(I[R],v)},_condense:function(v){for(var I,F=v.length-1;F>=0;F--)0===v[F].children.length?F>0?(I=v[F-1].children).splice(I.indexOf(v[F]),1):this.clear():S(v[F],this.toBBox)},_initFormat:function(v){var I=["return a"," - b",";"];this.compareMinX=new Function("a","b",I.join(v[0])),this.compareMinY=new Function("a","b",I.join(v[1])),this.toBBox=new Function("a","return {minX: a"+v[0]+", minY: a"+v[1]+", maxX: a"+v[2]+", maxY: a"+v[3]+"};")}}},58775:(Ce,pe,T)=>{T.d(pe,{O3:()=>D,lG:()=>ae,my:()=>Y,q9:()=>O});var U=T(26584),ee=T(66385),j=T(88071),S=T(36630);const Z={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function O(E){return Z[E]}function*K(E){switch(E.type){case"Feature":yield E;break;case"FeatureCollection":for(const z of E.features)z&&(yield z)}}function*P(E){if(E)switch(E.type){case"Point":yield E.coordinates;break;case"LineString":case"MultiPoint":yield*E.coordinates;break;case"MultiLineString":case"Polygon":for(const z of E.coordinates)yield*z;break;case"MultiPolygon":for(const z of E.coordinates)for(const X of z)yield*X}}function ue(E){for(const z of E)if(z.length>2)return!0;return!1}function he(E){let z=0;for(let X=0;X<E.length;X++){const fe=E[X],be=E[(X+1)%E.length];z+=fe[0]*be[1]-be[0]*fe[1]}return z<=0}function C(E){const z=E[0],X=E[E.length-1];return z[0]===X[0]&&z[1]===X[1]&&z[2]===X[2]||E.push(z),E}function G(E,z,X){switch(z.type){case"LineString":return function A(E,z,X){return ie(E,z.coordinates,X),E}(E,z,X);case"MultiLineString":return function v(E,z,X){for(const fe of z.coordinates)ie(E,fe,X);return E}(E,z,X);case"MultiPoint":return function I(E,z,X){return ie(E,z.coordinates,X),E}(E,z,X);case"MultiPolygon":return function F(E,z,X){for(const fe of z.coordinates){W(E,fe[0],X);for(let be=1;be<fe.length;be++)k(E,fe[be],X)}return E}(E,z,X);case"Point":return function R(E,z,X){return me(E,z.coordinates,X),E}(E,z,X);case"Polygon":return function B(E,z,X){const fe=z.coordinates;W(E,fe[0],X);for(let be=1;be<fe.length;be++)k(E,fe[be],X);return E}(E,z,X)}}function W(E,z,X){const fe=C(z);!function $(E){return!he(E)}(fe)?ie(E,fe,X):de(E,fe,X)}function k(E,z,X){const fe=C(z);!function V(E){return he(E)}(fe)?ie(E,fe,X):de(E,fe,X)}function ie(E,z,X){for(const fe of z)me(E,fe,X);E.lengths.push(z.length)}function de(E,z,X){for(let fe=z.length-1;fe>=0;fe--)me(E,z[fe],X);E.lengths.push(z.length)}function me(E,z,X){const[fe,be,ke]=z;E.coords.push(fe,be),X.hasZ&&E.coords.push(ke||0)}function Te(E){switch(typeof E){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function D(E){if(!E)throw new U.Z("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==E.type&&"FeatureCollection"!==E.type)throw new U.Z("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:E});const{crs:z}=E;if(!z)return;const X="string"==typeof z?z:"name"===z.type?z.properties.name:"EPSG"===z.type?z.properties.code:null,fe=new RegExp(".*(CRS84H?|4326)$","i");if(!X||!fe.test(X))throw new U.Z("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:z})}function Y(E,z={}){var xt;const X=[],fe=new Set,be=new Set;let ke,et=!1,Ae=null,Ye=!1,{geometryType:Pe=null}=z,tt=!1;for(const Be of K(E)){const{geometry:qe,properties:Oe,id:He}=Be;if((!qe||(Pe||(Pe=O(qe.type)),O(qe.type)===Pe))&&(et||(et=ue(P(qe))),Ye||(Ye=null!=He,Ye&&(ke=typeof He,Oe&&(Ae=Object.keys(Oe).filter(Qe=>Oe[Qe]===He)))),Oe&&Ae&&Ye&&null!=He&&(Ae.length>1?Ae=Ae.filter(Qe=>Oe[Qe]===He):1===Ae.length&&(Ae=Oe[Ae[0]]===He?Ae:[])),!tt&&Oe)){let Qe=!0;for(const Xe in Oe){if(fe.has(Xe))continue;const bt=Oe[Xe];if(null==bt){Qe=!1,be.add(Xe);continue}const ct=Te(bt);if("unknown"===ct){be.add(Xe);continue}be.delete(Xe),fe.add(Xe);const rt=(0,S.q6)(Xe);rt&&X.push({name:rt,alias:Xe,type:ct})}tt=Qe}}const st=null!=(xt=(0,S.q6)(1===(null==Ae?void 0:Ae.length)&&Ae[0]||null))?xt:void 0;if(st)for(const Be of X)if(Be.name===st&&(0,S.H7)(Be)){Be.type="esriFieldTypeOID";break}return{fields:X,geometryType:Pe,hasZ:et,objectIdFieldName:st,objectIdFieldType:ke,unknownFields:Array.from(be)}}function ae(E,z){return Array.from(function*H(E,z={}){const{geometryType:X,objectIdField:fe}=z;for(const be of E){const{geometry:ke,properties:et,id:Ae}=be;if(ke&&O(ke.type)!==X)continue;const Ye=et||{};let Pe;fe&&(Pe=Ye[fe],null==Ae||Pe||(Ye[fe]=Pe=Ae)),yield new ee.u_(ke?G(new j.Z,ke,z):null,Ye,null,null!=Pe?Pe:void 0)}}(K(E),z))}},99666:(Ce,pe,T)=>{T.d(pe,{KS:()=>H,PX:()=>Z,QS:()=>$,_I:()=>U,jL:()=>P,nE:()=>ue,vs:()=>K,xp:()=>O});const U=8388607,Z=0,O=1,K=V=>(8388608&V)>>>23,P=V=>V&U,H=V=>K(V)===O?254:255;function ue(V){return K(V)===O}function $(V,he){return((he?8388608:0)|V)>>>0}},87526:(Ce,pe,T)=>{T.d(pe,{$_:()=>ie,UK:()=>Be,ws:()=>ke,xV:()=>et});var U=T(26584),ee=T(63290),j=T(7547),S=T(39406),Z=T(67969);const O=ee.Z.getLogger("esri.views.2d.engine.webgl.Utils"),K="geometry",P=[{name:K,strideInBytes:12}],H=[{name:K,strideInBytes:36}],ue=[{name:K,strideInBytes:24}],$=[{name:K,strideInBytes:12}],V=[{name:K,strideInBytes:40}],he=[{name:K,strideInBytes:36}],C=[{name:K,strideInBytes:36}];function G(M){const ce={};for(const ne of M)ce[ne.name]=ne.strideInBytes;return ce}const A=G([{name:K,strideInBytes:36}]),v=G(P),I=G(H),F=G(ue),R=G($),B=G(V),W=G(he),k=G(C);function ie(M,ce){switch(M){case S.LW.MARKER:return ce===S.mD.HEATMAP?v:A;case S.LW.FILL:switch(ce){case S.mD.DOT_DENSITY:return R;case S.mD.SIMPLE:case S.mD.OUTLINE_FILL_SIMPLE:return F;default:return I}case S.LW.LINE:return B;case S.LW.TEXT:return W;case S.LW.LABEL:return k}}function ke(M){switch(M){case"butt":return j.RL.BUTT;case"round":return j.RL.ROUND;case"square":return j.RL.SQUARE;default:return O.error(new U.Z("mapview-invalid-type",`Cap type ${M} is not a valid option. Defaulting to round`)),j.RL.ROUND}}function et(M){switch(M){case"miter":return j.AH.MITER;case"bevel":return j.AH.BEVEL;case"round":return j.AH.ROUND;default:return O.error(new U.Z("mapview-invalid-type",`Join type ${M} is not a valid option. Defaulting to round`)),j.AH.ROUND}}function Be(M){switch(M){case Z.Br.UNSIGNED_BYTE:return Uint8Array;case Z.Br.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case Z.Br.FLOAT:return Float32Array;default:return void O.error(new U.Z("webgl-utils",`Unable to handle type ${M}`))}}},81295:(Ce,pe,T)=>{T.d(pe,{aH:()=>S,t2:()=>j});var U=T(5254);function j(O){if(!O)return 0;const{r:K,g:P,b:H,a:ue}=O;return(0,U.Jz)(K*ue,P*ue,H*ue,255*ue)}function S(O){if(!O)return 0;const[K,P,H,ue]=O;return(0,U.Jz)(K*(ue/255),P*(ue/255),H*(ue/255),ue)}},39351:(Ce,pe,T)=>{T.d(pe,{AI:()=>j,C1:()=>Gt,CQ:()=>gt,CU:()=>St,Ex:()=>B,I_:()=>O,Ip:()=>wt,Iv:()=>ne,Iw:()=>W,MI:()=>kt,SD:()=>We,Tz:()=>Ge,Uh:()=>jt,V4:()=>rt,XJ:()=>zt,_6:()=>xe,a:()=>Et,aK:()=>st,e0:()=>ce,fL:()=>At,jk:()=>Le,m4:()=>qe,oK:()=>M,pU:()=>tt,ru:()=>Z,tQ:()=>bt,uG:()=>Oe,vw:()=>we,xl:()=>Pe,xm:()=>he});const j=1e-30,Z=4294967295,O=512,he=29,B=24,W=8,Pe=1,tt=2,st=3,qe=2,Oe=1,bt=1.05,rt=5,St=6,Et=1.15,At=2,zt=8,wt=500,kt=10,Gt=1024,jt=2,gt=0,Ge=1,M=4,ce=8,ne=16,xe=4,We=1,Le=4,we=8},5254:(Ce,pe,T)=>{T.d(pe,{Au:()=>V,Jz:()=>G,UJ:()=>C});const U=new Float32Array(1);function V(I){return[255&I,(65280&I)>>>8,(16711680&I)>>>16,(4278190080&I)>>>24]}function C(I,F){return 65535&I|F<<16}function G(I,F,R,B){return 255&I|(255&F)<<8|(255&R)<<16|B<<24}new Uint32Array(U.buffer)},55746:(Ce,pe,T)=>{T.d(pe,{k:()=>he,p:()=>C});var U=T(65389),ee=T(61885),S=(T(8314),T(62208)),Z=T(76279),O=T(5548),K=T(16669),P=T(52397);const H=(0,O.Ue)();function ue(G,A){return G<<16|A}function $(G){return(4294901760&G)>>>16}function V(G){return 65535&G}const he={getObjectId:G=>G.getObjectId(),getAttributes:G=>G.readAttributes(),getAttribute:(G,A)=>G.readAttribute(A),cloneWithGeometry:(G,A)=>G,getGeometry:G=>G.readHydratedGeometry(),getCentroid:(G,A)=>G.readCentroid()};class C extends K.J{constructor(A,v,I){super(A,v),this.featureAdapter=he,this.events=new ee.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new U.Z(50),this._index=(0,Z.r)(9,F=>({minX:this._storage.getXMin(F),minY:this._storage.getYMin(F),maxX:this._storage.getXMax(F),maxY:this._storage.getYMax(F)})),this.mode=I}get storeStatistics(){let A=0,v=0,I=0;return this.forEach(F=>{const R=F.readGeometry();R&&(v+=R.isPoint?1:R.lengths.reduce((B,W)=>B+W,0),I+=R.isPoint?1:R.lengths.length,A+=1)}),{featureCount:A,vertexCount:v,ringCount:I}}hasInstance(A){return this._featureSetsByInstance.has(A)}onTileData(A,v){if((0,S.Wi)(v.addOrUpdate))return v;if(v.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const F=v.addOrUpdate.getCursor();for(;F.next();){const R=F.getDisplayId();this.setComputedAttributes(this._storage,F,R,A.scale)}return v}this._featureSetsByInstance.set(v.addOrUpdate.instance,v.addOrUpdate);const I=v.addOrUpdate.getCursor();for(;I.next();)this._insertFeature(I,A.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),v}search(A){this._rebuildIndex();const v=A.id,I=this._indexSearchCache.find(W=>W.tileId===v);if((0,S.pC)(I))return I.readers;const F=new Map,R=this._searchIndex(A.bounds),B=[];for(const W of R){const k=this._storage.getInstanceId(W),ie=$(k),de=V(k);F.has(ie)||F.set(ie,[]),F.get(ie).push(de)}return F.forEach((W,k)=>{const ie=this._featureSetsByInstance.get(k);B.push(P.t.from(ie,W))}),this._indexSearchCache.enqueue({tileId:v,readers:B}),B}insert(A){var F;const v=A.getCursor(),I=this._storage;for(;v.next();){const R=ue(v.instance,v.getIndex()),B=v.getObjectId(),W=null!=(F=this._objectIdToDisplayId.get(B))?F:this._storage.createDisplayId();v.setDisplayId(W),I.setInstanceId(W,R),this._objectIdToDisplayId.set(B,W)}this._featureSetsByInstance.set(A.instance,A),this._spatialIndexInvalid=!0}remove(A){const v=this._objectIdToDisplayId.get(A);if(!v)return;const I=this._storage.getInstanceId(v),F=V(I),R=$(I),B=this._featureSetsByInstance.get(R);this._objectIdToDisplayId.delete(A),this._storage.releaseDisplayId(v),B.removeAtIndex(F),B.isEmpty&&this._featureSetsByInstance.delete(R),this._spatialIndexInvalid=!0}forEach(A){this._objectIdToDisplayId.forEach(v=>{const I=this._storage.getInstanceId(v),F=this._lookupFeature(I);A(F)})}forEachUnsafe(A){this._objectIdToDisplayId.forEach(v=>{const I=this._storage.getInstanceId(v),F=$(I),R=V(I),B=this._getFeatureSet(F);B.setIndex(R),A(B)})}forEachInBounds(A,v){const I=this._searchIndex(A);for(const F of I){const R=this.lookupFeatureByDisplayId(F,this._storage);v((0,S.Wg)(R))}}forEachBounds(A,v){this._rebuildIndex();for(const I of A){if(!I.readGeometry())continue;const F=I.getDisplayId();(0,O.bZ)(H,this._storage.getXMin(F),this._storage.getYMin(F),this._storage.getXMax(F),this._storage.getYMax(F)),v(H)}}sweepFeatures(A,v,I){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((F,R)=>{A.has(F)||(v.releaseDisplayId(F),I&&I.unsetAttributeData(F),this._objectIdToDisplayId.delete(R))}),this.events.emit("changed")}sweepFeatureSets(A){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((v,I)=>{A.has(I)||this._featureSetsByInstance.delete(I)})}lookupObjectId(A,v){const I=this.lookupFeatureByDisplayId(A,v);return(0,S.Wi)(I)?null:I.getObjectId()}lookupDisplayId(A){return this._objectIdToDisplayId.get(A)}lookupFeatureByDisplayId(A,v){const I=v.getInstanceId(A);return this._lookupFeature(I)}lookupByDisplayIdUnsafe(A){const v=this._storage.getInstanceId(A),I=$(v),F=V(v),R=this._getFeatureSet(I);return R?(R.setIndex(F),R):null}_insertFeature(A,v){const I=this._storage,F=A.getObjectId(),R=ue(A.instance,A.getIndex());I.getInstanceId(A.getDisplayId());let B=this._objectIdToDisplayId.get(F);B||(B=I.createDisplayId(),this._objectIdToDisplayId.set(F,B),this._spatialIndexInvalid=!0),A.setDisplayId(B),I.setInstanceId(B,R),this.setComputedAttributes(I,A,B,v)}_searchIndex(A){return this._rebuildIndex(),this._index.search({minX:A[0],minY:A[1],maxX:A[2],maxY:A[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const A=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(v=>{const I=v.getCursor();for(;I.next();){const F=I.getDisplayId();this._storage.setBounds(F,I)&&A.push(F)}}):this._objectIdToDisplayId.forEach(v=>{const I=this._storage.getInstanceId(v);this._storage.setBounds(v,this._lookupFeature(I))&&A.push(v)}),this._index.clear(),this._index.load(A),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(A){const v=$(A),I=this._getFeatureSet(v);if(!I)return;const F=I.getCursor(),R=V(A);return F.setIndex(R),F}_getFeatureSet(A){return this._featureSetsByInstance.get(A)}}},78633:(Ce,pe,T)=>{T.r(pe),T.d(pe,{default:()=>Pr});var U=T(15861),ee=T(17626),j=T(80542),S=T(8314),Z=T(32917),O=T(77712),H=(T(90912),T(85931),T(76898)),ue=T(37053),$=T(2584),he=T(14517),C=T(62208),G=T(10699),A=T(82054),v=T(58175),I=T(60466),F=T(55746),R=T(38305),B=T(84792),W=T(26584),k=T(63290),ie=T(93662),de=T(7848),me=T(89628),Te=T(20477),D=T(66385),Y=T(25208);class E extends Y.s{static fromFeatures(a,h){const{objectIdField:d,geometryType:c}=h,f=(0,A.Yn)([],a,c,!1,!1,d);for(let p=0;p<f.length;p++)f[p].displayId=a[p].displayId;return E.fromOptimizedFeatures(f,h)}static fromFeatureSet(a,h){const d=(0,A.h_)(a,h.objectIdField);return E.fromOptimizedFeatureSet(d,h)}static fromOptimizedFeatureSet(a,h){const{features:d}=a,c=E.fromOptimizedFeatures(d,h);c._exceededTransferLimit=a.exceededTransferLimit,c._transform=a.transform;for(const f of a.fields)"esriFieldTypeDate"===f.type&&c._dateFields.add(f.name);return c}static fromOptimizedFeatures(a,h,d){const c=Y.s.createInstance(),f=new E(c,a,h);return f._transform=d,f}constructor(a,h,d){super(a,d),this._exceededTransferLimit=!1,this._featureIndex=-1,this._dateFields=new Set,this._geometryType=null==d?void 0:d.geometryType,this._features=h}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const h=new Set(a);this._features=this._features.filter(d=>!(d.objectId&&h.has(d.objectId)))}append(a){for(const h of a)this._features.push(h)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const h in this._current.attributes)a+=this._current.attributes[h];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){var a;return null==(a=this._current)?void 0:a.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new E(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,A.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,A.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,C.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,D.S6)(this._current)?(0,A.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const h=a.clone();return function ae({coords:g,lengths:a}){let h=0;for(const d of a){for(let c=1;c<d;c++)g[2*(h+c)]+=g[2*(h+c)-2],g[2*(h+c)+1]+=g[2*(h+c)-1];h+=d}}(h),h}readHydratedGeometry(){const a=this._current.geometry;if((0,C.Wi)(a))return null;const h=a.clone();return(0,C.pC)(this._transform)&&(0,A.$g)(h,h,this.hasZ,this.hasM,this._transform),h}getXHydrated(){if(!(0,D.S6)(this._current))return 0;const a=this._current.geometry.coords[0],h=this.getQuantizationTransform();return(0,C.Wi)(h)?a:a*h.scale[0]+h.translate[0]}getYHydrated(){if(!(0,D.S6)(this._current))return 0;const a=this._current.geometry.coords[1],h=this.getQuantizationTransform();return(0,C.Wi)(h)?a:h.translate[1]-a*h.scale[1]}getX(){return(0,D.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,D.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,D.S6)(this._current)){if((0,C.pC)(this._current.centroid)){const[d,c]=this._current.centroid.coords;return this.createQuantizedExtrudedQuad(d,c)}return null}const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let h=0;for(const d of a.lengths)a.coords[2*h]=a.coords[2*h]*this._sx+this._tx,a.coords[2*h+1]=a.coords[2*h+1]*this._sy+this._ty,h+=d;return a}readCentroid(){return(0,D.S6)(this._current)?this._computeCentroid():this._current.centroid}hasField(a){return a in this._current.attributes||this.getFieldNames().map(h=>h.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,h){const d=this._current.attributes[a];if(void 0!==d)return null!=d&&h&&this._dateFields.has(a)?new Date(d):d;const c=this.readAttributes(),f=null==a?void 0:a.toLocaleLowerCase().trim();for(const p in c)if(p.toLocaleLowerCase().trim()===f){const _=this._current.attributes[p];return null!=_&&h&&this._dateFields.has(p)?new Date(_):_}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var z=T(24192),X=T(88071),fe=T(71260);const be=268435455;class ke{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){var h,d;return null!=(d=null!=a&&(null==(h=this.fieldMap.get(a))?void 0:h.isDate))&&d}getFieldIndex(a){var h;return null!=a?null==(h=this.fieldMap.get(a))?void 0:h.index:void 0}}function et(g){const d=g.asUnsafe(),c=d.getLength(),f=d.pos()+c,p={name:"",isDate:!1};for(;d.pos()<f&&d.next();)switch(d.tag()){case 1:p.name=d.getString();break;case 2:"esriFieldTypeDate"===(0,fe.O7)(d.getEnum())&&(p.isDate=!0);break;default:d.skip()}return p}function Ae(g){return g.toLowerCase().trim()}const tt=268435455,Be={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function qe(g){return g<=Be.small.delta.length?Be.small:(g<=Be.large.delta.length||(Be.large.delta=new Int32Array(Math.round(1.25*g)),Be.large.decoded=new Int32Array(Math.round(1.25*g))),Be.large)}function Oe(g){return g.toLowerCase().trim()}function Qe(g){for(;g.next();){if(1===g.tag())return g.getMessage();g.skip()}return null}function bt(g,a,h,d,c,f){return.5*Math.abs(g*d+h*f+c*a-g*f-h*a-c*d)}function ct(g,a,h,d){return g*d-h*a==0&&g*h+a*d>0}class rt extends Y.s{static fromBuffer(a,h,d=!1){const c=h.geometryType,f=function He(g){try{const h=new z.Z(new Uint8Array(g),new DataView(g));for(;h.next();){if(2===h.tag())return Qe(h.getMessage());h.skip()}}catch(a){const h=new W.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});k.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(h)}return null}(a),p=function Ye(g,a,h=!1){const m=g.asUnsafe(),x=m.pos(),b=new ke;let w=0,L=0,re=null,se=null,te=null,oe=!1;for(;m.next();)switch(m.tag()){case 1:re=m.getString();break;case 3:se=m.getString();break;case 12:te=m.processMessage(fe.G$);break;case 9:if(b.exceededTransferLimit=m.getBool(),b.exceededTransferLimit){b.offsets.geometry=h?new Float64Array(8e3):new Int32Array(8e3),b.centroid=h?new Float64Array(16e3):new Int32Array(16e3);for(let le=0;le<b.centroid.length;le++)b.centroid[le]=be}break;case 13:{const le=et(g),Fe=le.name,Me=Ae(le.name),ge={fieldName:Fe,index:w++,isDate:le.isDate};b.fields.push(ge),b.fieldMap.set(le.name,ge),b.fieldMap.set(Me,ge);break}case 15:{const le=m.getLength(),Fe=m.pos()+le;if(!b.exceededTransferLimit){const ve=b.centroid;b.offsets.geometry.push(0),ve.push(be),ve.push(be)}!oe&&b.exceededTransferLimit&&(oe=!0,b.offsets.attributes=h?new Float64Array(8e3*w):new Uint32Array(8e3*w));let Me=L*w;for(;m.pos()<Fe&&m.next();)switch(m.tag()){case 1:{oe?b.offsets.attributes[Me++]=m.pos():b.offsets.attributes.push(m.pos());const ge=m.getLength();m.skipLen(ge);break}case 2:if(a){const ge=m.getLength(),ve=m.pos()+ge;for(;m.pos()<ve&&m.next();)switch(m.tag()){case 3:{m.getUInt32();const Se=m.getSInt64(),Ue=m.getSInt64();b.centroid[2*L]=Se,b.centroid[2*L+1]=Ue;break}default:m.skip()}}else{b.offsets.geometry[L]=m.pos();const ge=m.getLength();b.vertexCount+=ge,m.skipLen(ge)}break;case 4:{const ge=m.getLength(),ve=m.pos()+ge;for(;m.pos()<ve&&m.next();)switch(m.tag()){case 3:{m.getUInt32();const Se=m.getSInt64(),Ue=m.getSInt64();b.centroid[2*L]=Se,b.centroid[2*L+1]=Ue;break}default:m.skip()}break}default:m.skip()}L++,b.hasFeatures=!0;break}default:m.skip()}const _e=re||se;if(!_e)throw new W.Z("FeatureSet has no objectId or globalId field name");return b.featureCount=L,b.fieldCount=w,b.objectIdFieldIndex=b.getFieldIndex(_e),b.transform=te,b.displayIds=new Uint32Array(b.featureCount),b.groupIds=new Uint16Array(b.featureCount),m.move(x),b}(f,"esriGeometryPoint"===c,d),_=Y.s.createInstance();return new rt(_,f,p,h)}constructor(a,h,d,c){super(a,c),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=c.geometryType,this._reader=h,this._header=d,this._hasNext=d.hasFeatures,this._isPoints="esriGeometryPoint"===c.geometryType}get geometryType(){return this._geometryType}get _size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(Oe(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this._size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:h})=>{a+=this._readAttributeAtIndex(h)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){var a;if(void 0===this._cache.legacyFeature){const h=this.readCentroid(),d={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(a=h&&{x:h.coords[0],y:h.coords[1]})?a:null};return this._cache.legacyFeature=d,d}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new D.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],h=this.getQuantizationTransform();return(0,C.Wi)(h)?a:a*h.scale[0]+h.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],h=this.getQuantizationTransform();return(0,C.Wi)(h)?a:h.translate[1]-a*h.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const h=this.readGeometry(a);return(0,A.di)(h,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[h,d]=a.coords;return{x:h,y:d}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const h=this.readGeometry(a);if(!h)return this._cache.unquantGeometry=void 0,null;const d=qe(h.coords.length).decoded,c=h.clone(d),f=c.coords;let p=0;for(const _ of c.lengths){for(let y=1;y<_;y++){const m=2*(p+y),x=2*(p+y-1);f[m]+=f[x],f[m+1]+=f[x+1]}p+=_}return this._cache.unquantGeometry=c,c}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===tt)return null;const c=this.getXHydrated(),f=this.getYHydrated();return new X.Z([],[c,f])}const a=this.readGeometry();if(!a)return null;const h=a.clone(),d=this.getQuantizationTransform();return(0,C.pC)(d)&&(0,A.$g)(h,h,this.hasZ,this.hasM,d),h}readGeometry(a=!1){if(void 0===this._cache.geometry){let h=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===tt)return null;const d=this.getX(),c=this.getY();h=new X.Z([],[d,c])}else{const d=this._header.offsets.geometry[this._featureIndex],c=this._reader;if(0===d){const f=this._readServerCentroid();if(!f)return null;const[p,_]=f.coords;return this.createQuantizedExtrudedQuad(p,_)}c.move(d);try{if(h=a?this._parseGeometryForDisplay(c):this._parseGeometry(c),null===h){const f=this._readServerCentroid();if(!f)return null;const[p,_]=f.coords;return this.createQuantizedExtrudedQuad(p,_)}}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=h,h}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a;return a=this._computeCentroid(),a||(a=this._readServerCentroid()),this._cache.centroid=null!=a?a:void 0,null!=a?a:null}return this._cache.centroid}copy(){const a=this._reader.clone(),h=new rt(this.instance,a,this._header,this.fullSchema());return this.copyInto(h),h}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readAttribute(a,h){const d=this._header.hasField(a)?a:Oe(a),c=this._header.getFieldIndex(d);if(null==c)return;const f=this._readAttributeAtIndex(c);return h&&null!=f&&this._header.isDateField(d)?new Date(f):f}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:h,index:d})=>{a[h]=this._readAttributeAtIndex(d)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const d=this._reader;return d.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function Xe(g){const x=g.getLength(),b=g.pos()+x;for(;g.pos()<b&&g.next();)switch(g.tag()){case 1:return g.getString();case 2:return g.getFloat();case 3:return g.getDouble();case 4:return g.getSInt32();case 5:return g.getUInt32();case 6:return g.getInt64();case 7:return g.getUInt64();case 8:return g.getSInt64();case 9:return g.getBool();default:return g.skip(),null}return null}(d)}_readServerCentroid(){const a=this._header.centroid[2*this._featureIndex]+this._tx;return a===tt?null:new X.Z([],[a,this._header.centroid[2*this._featureIndex+1]+this._ty])}_parseGeometry(a){const c=a.asUnsafe(),f=c.getLength(),p=c.pos()+f,_=[],y=[];for(;c.pos()<p&&c.next();)switch(c.tag()){case 2:{const m=c.getUInt32(),x=c.pos()+m;for(;c.pos()<x;)y.push(c.getUInt32());break}case 3:{const m=c.getUInt32(),x=c.pos()+m;for(_.push(c.getSInt32()+this._tx),_.push(c.getSInt32()+this._ty),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();c.pos()<x;)_.push(c.getSInt32()),_.push(c.getSInt32()),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();break}default:c.skip()}return new X.Z(y,_)}_parseGeometryForDisplay(a){const c=a.asUnsafe(),f=c.getLength(),p=c.pos()+f,_=[],y=[];let m=0,x=0,b=null,w=0;const L="esriGeometryPolygon"===this.geometryType;for(;c.pos()<p&&c.next();)switch(c.tag()){case 2:{const N=c.getUInt32(),Q=c.pos()+N;for(;c.pos()<Q;){const q=c.getUInt32();_.push(q),m+=q}b=qe(2*m).delta;break}case 3:{c.getUInt32();const N=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,C.O3)(b);for(const Q of _)if(x+N*Q>b.length)for(let q=0;q<Q;q++)c.getSInt32(),c.getSInt32(),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();else if(L){const q=this.getAreaSimplificationThreshold(Q,this._header.vertexCount);let J=2,re=1;const se=!1;let te=c.getSInt32(),oe=c.getSInt32();b[x++]=te,b[x++]=oe,this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();let _e=c.getSInt32(),le=c.getSInt32();for(this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();J<Q;){let Fe=c.getSInt32(),Me=c.getSInt32();this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();const ge=te+_e,ve=oe+le;bt(te,oe,ge,ve,ge+Fe,ve+Me)>=q?(w+=-.5*(ge-te)*(ve+oe),re>1&&ct(b[x-2],b[x-1],_e,le)?(b[x-2]+=_e,b[x-1]+=le):(b[x++]=_e,b[x++]=le,re++),te=ge,oe=ve):(Fe+=_e,Me+=le),_e=Fe,le=Me,J++}re<3||se?x-=2*re:(w+=-.5*(te+_e-te)*(oe+le+oe),ct(b[x-2],b[x-1],_e,le)?(b[x-2]+=_e,b[x-1]+=le,y.push(re)):(b[x++]=_e,b[x++]=le,y.push(++re)))}else{let q=0,J=c.getSInt32(),re=c.getSInt32();this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32(),b[x++]=J,b[x++]=re,q+=1;for(let se=1;se<Q;se++){const te=c.getSInt32(),oe=c.getSInt32(),_e=J+te,le=re+oe;w+=-.5*(_e-J)*(le+re),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32(),se>2&&ct(b[x-2],b[x-1],te,oe)?(b[x-2]+=te,b[x-1]+=oe):(b[x++]=te,b[x++]=oe,q+=1),J=_e,re=le}y.push(q)}break}default:c.skip()}if(this._cache.area=w,!y.length)return null;if(this._tx||this._ty){let N=0;(0,C.O3)(b);for(const Q of y)b[2*N]+=this._tx,b[2*N+1]+=this._ty,N+=Q}return new X.Z(y,b)}}class St{constructor(a){this.service=a}destroy(){}}function wt(){return(wt=(0,U.Z)(function*(g){const a=new ie.Z;return yield a.open(g,{}),a})).apply(this,arguments)}class $t extends St{constructor(a){super(a),this._portsOpen=function zt(g){return wt.apply(this,arguments)}(a.source).then(h=>this.client=h)}destroy(){this.client.close(),this.client=null}executeQuery(a,h){var d=this;return(0,U.Z)(function*(){yield d._portsOpen;const c=yield d.client.invoke("queryFeatures",a.toJSON(),h);return E.fromFeatureSet(c,d.service)})()}}class Jt extends St{executeQuery(a,h){var d=this;return(0,U.Z)(function*(){const{data:c}=yield(0,Te.n7)(d.service.source,a,h);return rt.fromBuffer(c,d.service,!a.quantizationParameters)})()}}class kt extends St{executeQuery(a,h){var d=this;return(0,U.Z)(function*(){var x;const{source:c,capabilities:f,spatialReference:p,objectIdField:_,geometryType:y}=d.service;if((0,C.pC)(a.quantizationParameters)&&!f.query.supportsQuantization){const b=a.clone(),w=(0,de.vY)((0,C.Wg)(b.quantizationParameters));b.quantizationParameters=null;const{data:L}=yield(0,Te.JT)(c,b,p,h),N=(0,A.h_)(L,_);return(0,A.RZ)(w,N),E.fromOptimizedFeatureSet(N,d.service)}const{data:m}=yield(0,Te.JT)(c,a,d.service.spatialReference,h);return"esriGeometryPoint"===y&&(m.features=null==(x=m.features)?void 0:x.filter(b=>{if((0,C.pC)(b.geometry)){const w=b.geometry;return Number.isFinite(w.x)&&Number.isFinite(w.y)}return!0})),E.fromFeatureSet(m,d.service)})()}}class Gt extends St{executeQuery(a,h){var d=this;return(0,U.Z)(function*(){const{capabilities:c}=d.service;if(a.quantizationParameters&&!c.query.supportsQuantization){const p=a.clone(),_=(0,de.vY)((0,C.Wg)(p.quantizationParameters));p.quantizationParameters=null;const y=yield(0,me.WW)(d.service.source,a,h);return(0,A.RZ)(_,y),E.fromOptimizedFeatureSet(y,d.service)}const f=yield(0,me.WW)(d.service.source,a,h);return E.fromOptimizedFeatureSet(f,d.service)})()}}var jt=T(97478),gt=T(61885),Ge=T(84682),M=T(96854),ce=T(65389);class ne{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const h=new ne;for(const d in a){const c=a[d];if("object"==typeof c)for(const f in c)h[d][f]=c[f];h[d]=c}return h}static empty(){return ne.create({})}static all(){return ne.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,h="";if(this.mesh){a+=20,h+="-> (20) Mesh needs update\n";for(const c of this.why.mesh)h+=`    + ${c}\n`}if(this.source){a+=10,h+="-> (10) The source needs update\n";for(const c of this.why.source)h+=`    + ${c}\n`}this.targets.feature&&(a+=5,h+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,h+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,h+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,h+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(h)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class xe{constructor(a,h){this.requests={done:new Array,stream:new ce.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=h}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length&&(0,C.Wi)(this.edits)}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(h=>h.message.status.unset(a)),this._version=a.version,(0,C.pC)(this._edits)&&this._edits.status.unset(a)}add(a){var h;a.message.status=null!=(h=a.message.status)?h:ne.empty(),a.message.status.version=this._version,(0,S.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(d=>{(0,C.pC)(d.message)&&d.message.end&&(d.message.end=!1)}),this.requests.done.push(a)}edit(a,h){const d=a.getQuantizationTransform(),c=a.fullSchema(),f=Array.from(a.features()).filter(C.pC),p=[...h,...f.map(_=>_.objectId)];this.removeIds(p),this._invalidate(),(0,C.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:E.fromOptimizedFeatures(f,c,(0,C.Wg)(d)),id:this.tile.id,status:ne.empty(),end:!0}:(this.requests.done.forEach(_=>_.message.end=!1),(0,C.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,C.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,C.pC)(this._edits)&&(0,C.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=ne.empty();(0,C.pC)(this._edits)&&(this._edits.status=ne.empty())}removeIds(a){this._invalidate();for(const{message:h}of this.requests.done){const d=h.addOrUpdate;(0,C.pC)(d)&&(d.removeIds(a),d.isEmpty&&((0,S.Z)("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),h.addOrUpdate=null))}(0,C.pC)(this._edits)&&(0,C.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(h=>h.message.addOrUpdate||h.message.end)}abort(){this._abortController.abort()}}class Le extends he.Z{constructor(a){super(),this.events=new gt.Z,this._resolver=(0,G.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}_onMessage(a){var h=this;return(0,U.Z)(function*(){var f,p;const d=h._subscriptions.get(a.id);if(!d)return;const c=Ee(Ie({},a),{remove:null!=(f=a.remove)?f:[],status:null!=(p=a.status)?p:ne.empty()});return(0,G.R8)(h._onTileUpdateMessage(c,d.options))})()}update(a,h){var y;const d=h.fields.length;h.outFields=function We(g,a){const h=new Set;return g&&g.forEach(d=>h.add(d)),a&&a.forEach(d=>h.add(d)),h.has("*")?["*"]:Array.from(h)}(null==(y=this._schema)?void 0:y.outFields,h.outFields),h.outFields=h.outFields.length>=.75*d?["*"]:h.outFields,h.outFields.sort();const c=(0,Ge.Hg)(this._schema,h);if(!c)return;(0,S.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",c);const p={returnCentroid:"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:h.outFields,outSpatialReference:this._outSR,orderByFields:["orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC"],where:h.definitionExpression||"1=1",gdbVersion:h.gdbVersion,historicMoment:h.historicMoment,timeExtent:h.timeExtent?jt.Z.fromJSON(h.timeExtent):null},_=this._schema&&(0,Ge.uD)(c,"outFields");this._schema&&(0,Ge.V7)(c,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),_&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,Ge.Hg)(p,this._queryInfo)&&(this._queryInfo=p),this._schema=h,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var h=this;return(0,U.Z)(function*(){if(a.queryFilter||a.source&&h._didEdit)return h.refresh(a.version),void(h._didEdit=!1);h._subscriptions.forEach(d=>d.applyUpdate(a)),yield h.resend()})()}refresh(a,h){for(const d of this._tiles())this.unsubscribe(d),this.subscribe(d,a)}subscribe(a,h){const d=new xe(a,h);this._subscriptions.set(a.id,d)}unsubscribe(a){const h=this.getSubscription(a.id);(0,C.pC)(h)&&h.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const h=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new M.Z(Ie(Ee(Ie({},this._queryInfo),{historicMoment:h}),a))}getSubscription(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,U.Z)(function*(){throw new Error("Service does not support query type")})()}query(a,h){return(0,U.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const h of a)yield h.tile}edit(a,h){var d=this;return(0,U.Z)(function*(){const c=Array.from(d._subscriptions.values()),f=c.map(({tile:p})=>p);for(const p of c)p.removeIds(h);if(a.length){const p=f.map(y=>{const m=d.createTileQuery(y);return m.objectIds=a,{tile:y,query:m}}).map(function(){var y=(0,U.Z)(function*({tile:m,query:x}){return{tile:m,result:yield d.query(x,{query:{tile:(0,S.Z)("esri-tiles-debug")?m.id.replace(/\//g,"."):void 0}}),query:x}});return function(m){return y.apply(this,arguments)}}()),_=(yield(0,G.WW)(p)).map(function(){var y=(0,U.Z)(function*({tile:m,result:x}){if(!x.hasFeatures&&!h.length&&!a.length)return;const b=d._subscriptions.get(m.key.id);b&&b.edit(x,a)});return function(m){return y.apply(this,arguments)}}());yield(0,G.as)(_)}d._didEdit=!0})()}}var we=T(71251);class je extends Le{constructor(a){var h,d;super(a),h=this,this.type="feature",this.mode="on-demand",this._adapter=function At(g){const{capabilities:a}=g;return function Kt(g){return"ogc-source"===(null==g?void 0:g.type)}(g.source)?new Gt(g):function Et(g){return Array.isArray(g.source)}(g)?new $t(g):a.query.supportsFormatPBF&&(0,S.Z)("featurelayer-pbf")?new Jt(g):new kt(g)}(a.serviceInfo),this._queue=new we.e({concurrency:8,process:(d=(0,U.Z)(function*(c){var f,p;if((0,G.k_)(c),(0,C.pC)(c.tile)){const _=c.tile.key.id,{signal:y}=c,m=(0,S.Z)("esri-tiles-debug")?{tile:_.replace(/\//g,"."),depth:c.depth}:void 0,x=yield h._adapter.executeQuery(c.query,{signal:y,query:Ie(Ie({},m),null==(f=h._schema)?void 0:f.customParameters)});return x.level=c.tile.key.level,x}return h._adapter.executeQuery(c.query,Ee(Ie({},c),{query:null==(p=h._schema)?void 0:p.customParameters}))}),function(f){return d.apply(this,arguments)})}),this._patchQueue=new we.e({concurrency:8,process:function(){var d=(0,U.Z)(function*(c){var f,p;if((0,G.k_)(c),(0,C.pC)(c.tile)){const _=c.tile.key.id,{signal:y}=c,m=(0,S.Z)("esri-tiles-debug")?{tile:_.replace(/\//g,"."),depth:c.depth}:void 0,x=yield h._adapter.executeQuery(c.query,{signal:y,query:Ie(Ie({},m),null==(f=h._schema)?void 0:f.customParameters)});return x.level=c.tile.key.level,x}return h._adapter.executeQuery(c.query,Ee(Ie({},c),{query:null==(p=h._schema)?void 0:p.customParameters}))});return function(f){return d.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){var h;const{query:a}=this._serviceInfo.capabilities;return(null!=(h=a.maxRecordCount)?h:8e3)*(0,C.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,h){}subscribe(a,h){super.subscribe(a,h);const d=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(c=>{(0,G.D_)(c)||k.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new W.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:c}))}).then(()=>d.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a,h={}){var d=this;return(0,U.Z)(function*(){var f,p;const c=null!=(f=h.query)?f:{};return d._adapter.executeQuery(a,Ee(Ie({},h),{query:Ie(Ie({},c),null==(p=d._schema)?void 0:p.customParameters)}))})()}queryLastEditDate(){var a=this;return(0,U.Z)(function*(){const h=a._serviceInfo.source,d=Ee(Ie({},h.query),{f:"json"});return(yield(0,B.default)(h.path,{query:d,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,h={}){var p;const d=this._serviceInfo.geometryType,c=this.createQuery(h);c.quantizationParameters=null!=(p=h.quantizationParameters)?p:a.getQuantizationParameters(),c.resultType="tile",c.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===d&&(c.maxAllowableOffset=a.resolution*(0,S.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==d&&"esriGeometryPolygon"!==d||(c.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===d&&(c.maxAllowableOffset*=(0,S.Z)("feature-polyline-generalization-factor")));const f=this._serviceInfo.capabilities.query;return c.defaultSpatialReferenceEnabled=f.supportsDefaultSpatialReference,c.compactGeometryEnabled=f.supportsCompactGeometry,c}_executePatchQuery(a,h,d,c){var f=this;return(0,U.Z)(function*(){const p=h.clone();p.outFields=[f._serviceInfo.objectIdField,...d],p.returnCentroid=!1,p.returnGeometry=!1;const _=(0,C.pC)(p.start)?p.start/8e3:0;return f._patchQueue.push({tile:a,query:p,signal:c.signal,depth:_})})()}_resend(a,h){var d=this;return(0,U.Z)(function*(){const{query:c,message:f}=a,p=(0,C.pC)(c.outFields)?c.outFields:[],_=d._queryInfo.outFields,y=_.filter(m=>!p.includes(m));if((0,C.Wi)(f.addOrUpdate))d._onMessage(Ee(Ie({},f),{type:"append"}));else if(y.length)try{const m=d._subscriptions.get(f.id).tile,x=yield d._executePatchQuery(m,c,y,h);(0,G.k_)(h),c.outFields=_,f.addOrUpdate.joinAttributes(x),d._onMessage(Ee(Ie({},f),{end:f.end,type:"append"}))}catch(m){}else d._onMessage(Ee(Ie({},f),{type:"append"}))})()}_resendSubscription(a){var h=this;return(0,U.Z)(function*(){if((0,S.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return h._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const d=a.signal;for(const c of a.requests.done)yield h._resend(c,{signal:d});return(0,C.pC)(a.edits)?h._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,U.Z)(function*(){const h=Array.from(a._subscriptions.values());yield Promise.all(h.map(d=>a._resendSubscription(d)))})()}}const Ct=(0,S.Z)("esri-mobile"),Lt={maxDrillLevel:Ct?1:4,maxRecordCountFactor:Ct?1:3};class Nt extends je{constructor(a){super(a)}_fetchDataTile(a){var h=this;return(0,U.Z)(function*(){const d=h._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,c=h._subscriptions.get(a.key.id),f=c.signal,p=a.getQuantizationParameters();let _=0;const y=function(){var m=(0,U.Z)(function*(x,b){const w=h._queryInfo,L=h.createTileQuery(x,{maxRecordCountFactor:d?Lt.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:p});_++;try{const N=yield h._queue.push({tile:a,query:L,signal:f,depth:b});if(_--,(0,G.k_)(f),!N)return;if(w!==h._queryInfo)return void y(x,b);if(N.exceededTransferLimit&&b<Lt.maxDrillLevel){for(const q of x.createChildTiles())y(q,b+1);return}const Q={id:a.id,addOrUpdate:N,end:0===_,type:"append"};c.add({query:L,message:Q}),h._onMessage(Q)}catch(N){(0,G.D_)(N)||h._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(b,w){return m.apply(this,arguments)}}();y(a,0)})()}}class es extends je{constructor(a){super(a)}_fetchDataTile(a){var h=this;return(0,U.Z)(function*(){const f=h._subscriptions.get(a.key.id);let p=!1,_=0,y=0;const m=(w,L)=>{y--,(0,G.k_)(f);const N=a.id,Q=w.reader,q=w.query;if(!Q.exceededTransferLimit){if(p=!0,0!==L&&!Q.hasFeatures){const se={id:N,addOrUpdate:Q,end:0===y,type:"append"};return f.add({message:se,query:q}),void h._onMessage(se)}const re={id:N,addOrUpdate:Q,end:0===y,type:"append"};return f.add({message:re,query:q}),void h._onMessage(re)}const J={id:N,addOrUpdate:Q,end:p&&0===y,type:"append"};f.add({message:J,query:q}),h._onMessage(J)};let x=0,b=0;for(;!p&&b++<20;){let w;for(let L=0;L<x+1;L++){const N=_++;y++,w=h._fetchDataTilePage(a,N,f).then(Q=>Q&&m(Q,N)).catch(Q=>{p=!0,(0,G.D_)(Q)||(k.Z.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new W.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:Q})),h._onMessage({id:a.id,addOrUpdate:null,end:p,type:"append"}))})}yield w,(0,G.k_)(f),x=Math.min(x+2,6)}})()}_fetchDataTilePage(a,h,d){var c=this;return(0,U.Z)(function*(){(0,G.k_)(d);const f=c._queryInfo,p={start:c.pageSize*h,num:c.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,C.pC)(c.maxRecordCountFactor)&&(p.maxRecordCountFactor=c.maxRecordCountFactor);const _=c.createTileQuery(a,p);try{const y=d.signal,m=yield c._queue.push({tile:a,query:_,signal:y,depth:h});return(0,G.k_)(d),m?f!==c._queryInfo?c._fetchDataTilePage(a,h,d):{reader:m,query:_}:null}catch(y){return(0,G.H9)(y),null}})()}}var ts=T(4619),ss=T(52397);function Dt(g,a,h){const d=g.getXHydrated(),c=g.getYHydrated(),f=a.getColumnForX(d),p=Math.floor(a.normalizeCol(f));return`${h}/${Math.floor(a.getRowForY(c))}/${p}`}function rs(g,a){if((0,C.Wi)(g))return null;const h=a.transform,d=g.getQuantizationTransform();if((0,C.Wi)(d)){const[q,J]=h.scale,[re,se]=h.translate;return g.transform(-re/q,se/J,1/q,1/-J)}const[c,f]=d.scale,[p,_]=d.translate,[y,m]=h.scale,[x,b]=h.translate;return g.transform((p-x)/y,(-_+b)/m,c/y,f/m)}class Rs extends je{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new ts.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,h){var d;super.update(a,h),null==this._featureCount&&(this._featureCount=h.initialFeatureCount),(0,C.pC)(h.changedFeatureCount)&&(this._featureCount=h.changedFeatureCount),this._hasAggregates=!(null==(d=a.targets)||!d.aggregate)}resend(a=!1){var h=this;return(0,U.Z)(function*(){if(yield h._downloadPromise,h._invalidated||a){const c=(0,C.s3)(h._featureCount,"Expected featureCount to be defined");return h._invalidated=!1,h._subscriptions.forEach(f=>f.clear()),h._downloadPromise=h._download(c),void(yield h._downloadPromise)}const d=h._queries.map(({query:c,reader:f})=>h._sendPatchQuery(c,f));yield Promise.all(d),h._subscriptions.forEach(c=>{c.requests.done.forEach(f=>h._onMessage(f.message))})})()}refresh(a,h){var d=this;return(0,U.Z)(function*(){h&&(d._featureCount=h.featureCount),yield d.resend(!0)})()}_sendPatchQuery(a,h){var d=this;return(0,U.Z)(function*(){const c=(0,C.pC)(a.outFields)?a.outFields:[],f=d._queryInfo.outFields,p=f.filter(x=>!c.includes(x));if(!p.length)return;const _=a.clone(),y=d._signal;_.returnGeometry=!1,_.returnCentroid=!1,_.outFields=p,a.outFields=f;const m=yield d._queue.push({query:_,depth:0,signal:y});(0,G.k_)({signal:y}),h.joinAttributes(m)})()}_fetchDataTile(a){var h=this;return(0,U.Z)(function*(){if(!h._downloadPromise){const m=(0,C.s3)(h._featureCount,"Expected featureCount to be defined");h._downloadPromise=h._download(m)}const d=h._store.search(a),c=h._subscriptions.get(a.key.id),f=d.length-1;for(let m=0;m<f;m++){const x=rs(d[m],a),b={type:"append",id:a.id,addOrUpdate:x,end:!1,status:ne.empty()};c.add({query:null,message:b}),h._hasAggregates||(yield(0,G.e4)(1)),h._onMessage(b)}const p=rs(f>=0?d[f]:null,a),y={type:"append",id:a.id,addOrUpdate:p,end:h._didSendEnd,status:ne.empty()};c.add({query:null,message:y}),h._onMessage(y)})()}_download(a){var h=this;return(0,U.Z)(function*(){try{yield h.whenInitialized();const d=h._store.storage.getBitset(h._markedIdsBufId),c=new Set;d.clear();const f=Math.ceil(a/h.pageSize),p=Array.from({length:f},(_,y)=>y).sort((_,y)=>h._random.getInt()-h._random.getInt()).map(_=>h._downloadPage(_,d,c));yield Promise.all(p),h._store.sweepFeatures(d,h._store.storage),h._store.sweepFeatureSets(c)}catch(d){k.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",d)}h._sendEnd(),h._loading=!1})()}_downloadPage(a,h,d){var c=this;return(0,U.Z)(function*(){const f=c.pageSize,p={start:a*f,num:f,cacheHint:!0};(0,C.pC)(c.maxRecordCountFactor)&&(p.maxRecordCountFactor=c.maxRecordCountFactor);const _=c.createQuery(p),y=c._signal,m=yield c._queue.push({query:_,depth:a,signal:y});(0,G.k_)({signal:y}),c._queries.push({query:_,reader:m}),c._store.insert(m),d.add(m.instance);const x=m.getCursor();for(;x.next();)h.set(x.getDisplayId());c._send(m)})()}_send(a){if(!this._subscriptions.size)return;let h=null;const d=new Map,c=new Set,f=new Map;this._subscriptions.forEach(p=>{var w;const _=p.tile;d.set(_.key.id,null),h=_.tileInfoView,c.add(_.level);const{row:y,col:m}=_.key,x=`${_.level}/${y}/${m}`,b=null!=(w=f.get(x))?w:[];b.push(p),f.set(x,b)});for(const p of c){const _=h.getLODInfoAt(p),y=a.getCursor();for(;y.next();){const m=Dt(y,_,p),x=y.getIndex();if(f.has(m))for(const b of f.get(m)){const w=b.tile.id;let L=d.get(w);(0,C.Wi)(L)&&(L=[],d.set(w,L)),L.push(x)}}}d.forEach((p,_)=>{if((0,C.pC)(p)){const y=this._subscriptions.get(_),m={type:"append",id:_,addOrUpdate:rs(ss.t.from(a,p),y.tile),end:!1,status:ne.empty()};y.add({query:null,message:m}),this._onMessage(m)}})}_sendEnd(){this._subscriptions.forEach(a=>{const h={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:ne.empty()};a.add({query:null,message:h}),this._onMessage(h)}),this._didSendEnd=!0}}var gs=T(76279),Ps=T(5075),Os=T(20901);function Ls(g,a){const h=g.weakClone();if((0,C.pC)(g.geometry)){const d=(0,A.Jd)(a,g.geometry.coords[0]),c=(0,A.IN)(a,g.geometry.coords[1]);h.geometry=new X.Z([],[d,c])}return h}class js{constructor(a,h){this.onUpdate=a,this._geometryType=h,this._objectIdToFeature=new Map,this._index=null}get _features(){const a=[];return this._objectIdToFeature.forEach(h=>a.push(h)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function ks(g,a){const h=(0,gs.r)(9,function zs(g){return"esriGeometryPoint"===g?a=>(0,C.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let h=1/0,d=1/0,c=-1/0,f=-1/0;return(0,C.pC)(a.geometry)&&a.geometry.forEachVertex((p,_)=>{h=Math.min(h,p),d=Math.min(d,_),c=Math.max(c,p),f=Math.max(f,_)}),{minX:h,minY:d,maxX:c,maxY:f}}}(a));return h.load(g),h}(this._features,this._geometryType)),function Gs(g,a){return g.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}clear(){this._index=null,this._objectIdToFeature.clear()}removeById(a){const h=this._objectIdToFeature.get(a);return h?(this._objectIdToFeature.delete(a),this._index=null,h):null}update(a,h){this.onUpdate(a,h)}get size(){return this._objectIdToFeature.size}}let Ut=class extends Le{constructor(g){super(g),this.type="stream",this._updateIntervalId=0,this._level=0,this._updateInfo={websocket:0,client:0},this._isPaused=!1,this._inUpdate=!1;const{outSR:a}=g,{geometryType:h,objectIdField:d,timeInfo:c,purgeOptions:f,source:p,spatialReference:_,serviceFilter:y,maxReconnectionAttempts:m,maxReconnectionInterval:x,updateInterval:b,customParameters:w,enabledEventTypes:L}=g.serviceInfo,N=new js(this._onUpdate.bind(this),h),Q=new Ps.Qo(N,d,c,f),q=(0,Os.createConnection)(p,_,a,h,y,m,x,null!=w?w:{});this._store=N,this._manager=Q,this._connection=q,this._quantize=function Zs(g){return"esriGeometryPoint"===g?Ls:(a,h)=>{const d=a.weakClone(),c=new X.Z,_=(0,A.Nh)(c,a.geometry,!1,!1,g,h,!1,!1);return d.geometry=_,d}}(h),this._enabledEventTypes=new Set(L),this._handles=[this._connection.on("data-received",J=>this._onFeature(J)),this._connection.on("message-received",J=>this._onWebSocketMessage(J))],this._initUpdateInterval=()=>{let J=performance.now();this._updateIntervalId=setInterval(()=>{const re=performance.now(),se=re-J;if(se>2500){J=re;const te=Math.round(this._updateInfo.client/(se/1e3)),oe=Math.round(this._updateInfo.websocket/(se/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:te,websocket:oe})}g.canAcceptRequest()&&!this._inUpdate&&this._manager.checkForUpdates()},b)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(g=>g.remove()),this._connection.destroy()}_fetchDataTile(){}get connectionStatus(){var g;return this._isPaused?"paused":null==(g=this._connection)?void 0:g.connectionStatus}get errorString(){var g;return null==(g=this._connection)?void 0:g.errorString}updateCustomParameters(g){this._connection.updateCustomParameters(g)}pauseStream(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())}resumeStream(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())}sendMessageToSocket(g){this._connection.sendMessageToSocket(g)}sendMessageToClient(g){this._connection.sendMessageToClient(g)}enableEvent(g,a){a?this._enabledEventTypes.add(g):this._enabledEventTypes.delete(g)}get updating(){return!1}subscribe(g,a){super.subscribe(g,a);const h=this._subscriptions.get(g.id);this._level=g.level;const d=this._getTileFeatures(g);this._onMessage({type:"append",id:g.key.id,addOrUpdate:d,end:!0}),h.didSend=!0}unsubscribe(g){super.unsubscribe(g)}*readers(g){const a=this._subscriptions.get(g),{tile:h}=a;yield this._getTileFeatures(h)}createTileQuery(g){throw new Error("Service does not support tile  queries")}resend(){var g=this;return(0,U.Z)(function*(){g._subscriptions.forEach(a=>{const{tile:h}=a,d={type:"append",id:h.id,addOrUpdate:g._getTileFeatures(h),end:!0};g._onMessage(d)})})()}_getTileFeatures(g){const a=this._store.search(g).map(h=>this._quantize(h,g.transform));return E.fromOptimizedFeatures(a,this._serviceInfo,g.transform)}_onWebSocketMessage(g){if(this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",g),"type"in g)switch(g.type){case"delete":if(g.objectIds)for(const a of g.objectIds)this._manager.removeById(a);if(g.trackIds)for(const a of g.trackIds)this._manager.removeByTrackId(a);break;case"clear":this._store.forEach(a=>this._manager.removeById(a.objectId))}}_onFeature(g){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",g);const a=(0,A.XA)(g,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(a)}catch(a){}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(g,a){var h=this;return(0,U.Z)(function*(){h._inUpdate=!0;try{(0,C.pC)(g)&&(h._updateInfo.client+=g.length),h._subscriptions.forEach((c,f)=>{c.didSend&&c.tile.level===h._level&&h._onMessage({type:"append",id:f,addOrUpdate:null,clear:!0,end:!1})});const d=[];h._subscriptions.forEach((c,f)=>{if(!c.didSend||c.tile.level!==h._level)return;const _={type:"append",id:f,addOrUpdate:h._getTileFeatures(c.tile),remove:[],end:!1,status:ne.empty()};c.requests.stream.enqueue(_),d.push(h._onMessage(_))}),yield Promise.all(d),h._subscriptions.forEach((c,f)=>{c.didSend&&c.tile.level===h._level&&h._onMessage({type:"append",id:f,addOrUpdate:null,end:!0})})}catch(d){}h._inUpdate=!1})()}};(0,ee._)([(0,O.Cb)()],Ut.prototype,"_isPaused",void 0),(0,ee._)([(0,O.Cb)()],Ut.prototype,"connectionStatus",null),(0,ee._)([(0,O.Cb)()],Ut.prototype,"errorString",null),Ut=(0,ee._)([(0,H.j)("esri.views.2d.layers.features.sources")],Ut);var Ws=T(21286),De=T(39351),ye=T(99666),Ys=T(87526);T(81295),T(39406);var Tt=T(67969);const Rt=k.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Qt=(Rt,()=>null),Zt={sharedArrayBuffer:(0,S.Z)("esri-shared-array-buffer"),atomics:(0,S.Z)("esri-atomics")};function ns(g,a){return h=>a(g(h))}class Js{constructor(a,h,d,c){this.size=0,this.texelSize=4,this.dirtyStart=0,this.dirtyEnd=0;const{pixelType:f,layout:p,textureOnly:_}=c;this.textureOnly=_||!1,this.pixelType=f,this._ctype=h,this.layout=p,this._resetRange(),this._shared=a,this.size=d,_||(this.data=this._initData(f,d,a,h))}get buffer(){return(0,C.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,h){const d=(0,C.Wg)(this.data);for(let c=0;c<this.size*this.size;c++)d[c*this.texelSize+a]&=~h;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,h){const d=(0,C.Wg)(this.data);for(let c=0;c<this.size*this.size;c++)d[c*this.texelSize+a]|=255&h;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,h,d){const c=(0,C.Wg)(this.data);for(const f of d)c[f*this.texelSize+a]|=h,this.dirtyStart=Math.min(this.dirtyStart,f),this.dirtyEnd=Math.max(this.dirtyEnd,f)}setComponentTexel(a,h,d){(0,C.Wg)(this.data)[d*this.texelSize+a]|=h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)}unsetComponentTexel(a,h,d){(0,C.Wg)(this.data)[d*this.texelSize+a]&=~h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)}getData(a,h){const d=(0,ye.jL)(a);return(0,C.Wg)(this.data)[d*this.texelSize+h]}setData(a,h,d){const c=(0,ye.jL)(a);0!=(this.layout&1<<h)?(0,C.Wi)(this.data)||(this.data[c*this.texelSize+h]=d,this.dirtyStart=Math.min(this.dirtyStart,c),this.dirtyEnd=Math.max(this.dirtyEnd,c)):Rt.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===Tt.Br.UNSIGNED_BYTE&&this._shared&&Zt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===Tt.Br.UNSIGNED_BYTE&&this._shared&&Zt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const h=this._initData(this.pixelType,a,this._shared,this._ctype),d=(0,C.Wg)(this.data);h.set(d),this.data=h}}toMessage(){const a=this.dirtyStart,h=this.dirtyEnd,d=this.texelSize;if(a>h)return null;this._resetRange();const c=!(this._shared||"local"===this._ctype),f=this.pixelType,p=this.layout,_=(0,C.Wg)(this.data);return{start:a,end:h,data:c&&_.slice(a*d,(h+1)*d)||null,pixelType:f,layout:p}}_initData(a,h,d,c){const f=d&&"local"!==c?SharedArrayBuffer:ArrayBuffer,p=(0,Ys.UK)(a),_=new p(new f(h*h*4*p.BYTES_PER_ELEMENT));for(let y=0;y<_.length;y+=4)_[y+1]=255;return _}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class er{constructor(a,h,d=(()=>{})){this._client=a,this.config=h,this._notifyChange=d,this._blocks=new Array,this._filters=new Array(De.m4),this._attributeComputeInfo=null,this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._nextUpdate=null,this._currUpdate=null,this._idsToHighlight=new Set;const c=h.supportsTextureFloat?Tt.Br.FLOAT:Tt.Br.UNSIGNED_BYTE;Qt(`Creating AttributeStore ${Zt.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:Tt.Br.UNSIGNED_BYTE,layout:1},{pixelType:Tt.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:Tt.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:c,layout:15},{pixelType:c,layout:15},{pixelType:c,layout:15},{pixelType:c,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,h){this.config=h;const d=h.schema.processors[0].storage,c=(0,Ge.Hg)(this._schema,d);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),c&&((0,S.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",c),a.storage.data=!0,this._schema=d,this._attributeComputeInfo=null,!(0,C.Wi)(d))){switch(d.target){case"feature":this._targetType=ye.PX;break;case"aggregate":this._targetType=ye.xp}if("subtype"===d.type){this._attributeComputeInfo={isSubtype:!0,subtypeField:d.subtypeField,map:new Map};for(const f in d.mapping){const p=d.mapping[f];if((0,C.pC)(p)&&(0,C.pC)(p.vvMapping))for(const _ of p.vvMapping)this._bindAttribute(_,parseInt(f,10))}}else{if(this._attributeComputeInfo={isSubtype:!1,map:new Map},(0,C.pC)(d.vvMapping))for(const f of d.vvMapping)this._bindAttribute(f);if((0,C.pC)(d.attributeMapping))for(const f of d.attributeMapping)this._bindAttribute(f)}}}onTileData(a,h){if((0,C.Wi)(h.addOrUpdate))return;const d=h.addOrUpdate.getCursor();for(;d.next();){const c=d.getDisplayId();this.setAttributeData(c,d)}}setHighlight(a,h){var d=this;return(0,U.Z)(function*(){const f=d._getBlock(0),p=h.map(_=>(0,ye.jL)(_));f.lock(),f.unsetComponentAllTexels(0,1),f.setComponent(0,1,p),f.unlock(),d._idsToHighlight.clear();for(const _ of a)d._idsToHighlight.add(_);yield d.sendUpdates()})()}updateFilters(a,h,d){var c=this;return(0,U.Z)(function*(){const{service:f,spatialReference:p}=d,{filters:_}=h,y=_.map((m,x)=>c._updateFilter(m,x,f,p));(yield Promise.all(y)).some(m=>m)&&(a.storage.filters=!0,(0,S.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,h,d,c){const f=(0,ye.jL)(a);this._ensureSizeForTexel(f),this._getBlock(h).setData(a,d,c)}getData(a,h,d){return this._getBlock(h).getData(a,d)}getHighlightFlag(a){return this._idsToHighlight.has(a)?De.uG:0}unsetAttributeData(a){const h=(0,ye.jL)(a);this._getBlock(0).setData(h,0,0)}setAttributeData(a,h){const d=(0,ye.jL)(a);if(this._ensureSizeForTexel(d),this._getBlock(0).setData(d,0,this.getFilterFlags(h)),this._targetType!==(0,ye.vs)(a))return;const c=this._attributeComputeInfo,f=this.config.supportsTextureFloat?1:2;let _=null;c&&(_=c.isSubtype?c.map.get(h.readAttribute(c.subtypeField)):c.map,_&&_.size&&_.forEach((y,m)=>{const x=m*f%4,b=Math.floor(m*f/4),w=this._getBlock(b+De.aK),L=y(h);if(this.config.supportsTextureFloat)w.setData(d,x,L);else if(L===De.AI)w.setData(d,x,255),w.setData(d,x+1,255);else{const N=(0,Ws.uZ)(Math.round(L),-32767,32766)+32768,q=(65280&N)>>8;w.setData(d,x,255&N),w.setData(d,x+1,q)}}))}sendUpdates(){if((0,S.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,G.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(h=>(0,C.pC)(h)?h.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const h=()=>{if(this._currUpdate=null,this._nextUpdate){const c=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>c.resolve())}else(0,S.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,S.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const d=this._client.update(a,this._signal).then(h).catch(h);return this._client.render(this._signal),d}).catch(h=>{if((0,G.D_)(h))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),Rt.error(new W.Z("mapview-attribute-store","Encountered an error during client update",h))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a,h){var m;let f;if(null!=a.fieldIndex)f=function c(){return a.normalizationField&&Rt.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),x=>x.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;f=function d(){const{normalizationField:x}=a;return x?b=>{const w=b.readAttribute(x);return w?b.readAttribute(a.field)/w:null}:b=>b.readAttribute(a.field)}()}const{valueRepresentation:p}=a;p&&(f=ns(f,x=>function qs(g,a){if(!g||!a)return g;switch(a){case"radius":case"distance":return 2*g;case"diameter":case"width":return g;case"area":return Math.sqrt(g)}return g}(x,p)));const _=x=>null===x||isNaN(x)||x===1/0||x===-1/0?De.AI:x,y=this._attributeComputeInfo;if(y.isSubtype){const x=null!=(m=y.map.get(h))?m:new Map;x.set(a.binding,ns(f,_)),y.map.set(h,x)}else y.map.set(a.binding,ns(f,_))}_createResources(){if((0,C.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(De.xl),this._getBlock(De.pU),Qt("Initializing AttributeStore");const a={shared:Zt.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,C.Fd)(this._blocks,d=>({textureOnly:d.textureOnly,buffer:d.buffer,pixelType:d.pixelType}))},h=this._client.initialize(a,this._signal).catch(d=>{(0,G.D_)(d)?this._createResourcesPromise=null:Rt.error(new W.Z("mapview-attribute-store","Encountered an error during client initialization",d))});return this._createResourcesPromise=h,h.then(()=>(0,C.Wi)(this._createResourcesPromise)?this._createResources():void 0),h}_getBlock(a){const h=this._blocks[a];if((0,C.pC)(h))return h;Qt(`Initializing AttributeBlock at index ${a}`);const f=new Js(Zt.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=f,this._createResourcesPromise=null,f}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return Qt("Expanding block size to",a,this._blocks),(0,C.JR)(this._blocks,h=>h.expand(a)),this._createResourcesPromise=null,this._size=a,0}return Rt.error(new W.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,h,d,c){var f=this;return(0,U.Z)(function*(){const p=f._filters[h],_=(0,C.pC)(p)&&p.hash;if(!p&&!a||_===JSON.stringify(a))return!1;if((0,C.Wi)(a)){if(!p)return!1;const m=1<<h+1,x=f._getBlock(0);return f._filters[h]=null,x.setComponentAllTexels(0,m),f.sendUpdates(),!0}return yield(yield f._getFilter(h,d)).update(a,c),!0})()}_getFilter(a,h){var d=this;return(0,U.Z)(function*(){const c=d._filters[a];if((0,C.pC)(c))return c;const{default:f}=yield T.e(8967).then(T.bind(T,8967)),p=new f({geometryType:h.geometryType,hasM:!1,hasZ:!1,timeInfo:h.timeInfo,fieldsIndex:new I.Z(h.fields)});return d._filters[a]=p,p})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let h=0;const d=(0,ye.KS)(a.getDisplayId());for(let f=0;f<this._filters.length;f++){const _=this._filters[f];h|=(d&1<<f&&!(0,C.Wi)(_)&&!_.check(a)?0:1)<<f}let c=0;if(this._idsToHighlight.size){const f=a.getObjectId();c=this.getHighlightFlag(f)}return h<<1|c}}function Xt(g,a,h,d){d%2&&(d+=1);let c=0,f=0,p=-90,_=90,y=-180,m=180;for(let x=0;x<d/2;x++){for(let b=0;b<5;b++){const w=(y+m)/2,L=h>w?1:0;c|=L<<29-(b+5*x),y=(1-L)*y+L*w,m=(1-L)*w+L*m}for(let b=0;b<5;b++){const w=(p+_)/2,L=a>w?1:0;f|=L<<29-(b+5*x),p=(1-L)*p+L*w,_=(1-L)*w+L*_}}g.geohashX=c,g.geohashY=f}function Vt(g,a,h,d,c){c%2&&(c+=1);let f=0,p=0,_=-90,y=90,m=-180,x=180;for(let b=0;b<c/2;b++){for(let w=0;w<5;w++){const L=(m+x)/2,N=d>L?1:0;f|=N<<29-(w+5*b),m=(1-N)*m+N*L,x=(1-N)*L+N*x}for(let w=0;w<5;w++){const L=(_+y)/2,N=h>L?1:0;p|=N<<29-(w+5*b),_=(1-N)*_+N*L,y=(1-N)*L+N*y}}g[2*a]=f,g[2*a+1]=p}T(29132),new Float64Array(2),new Float64Array(2);var pt=T(65234),_t=T(82959);class vs{constructor(a=[],h,d=8096){this.onRelease=c=>{},this._nodes=0,this._root=new os(this,0,0,0),this._statisticFields=a,this._pool=d?new ce.Z(8096):null,this._serviceInfo=h}destroy(){this.clear()}_acquire(a,h,d){this._nodes++;let c=null;return(0,C.pC)(this._pool)&&(c=this._pool.dequeue()),(0,C.pC)(c)?c.realloc(a,h,d):c=new os(this,a,h,d),c}_release(a){this.onRelease(a),this._nodes--,(0,C.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,C.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(h=>a=Math.max(a,h.depth)),a}dropLevels(a){this.forEach(h=>{if(h.depth>=a)for(let d=0;d<h.children.length;d++){const c=h.children[d];c&&this._release(c)}}),this.forEach(h=>{if(h.depth>=a)for(let d=0;d<h.children.length;d++)h.children[d]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new os(this,0,0,0)}insert(a,h,d=0){const c=E.fromOptimizedFeatures([a],this._serviceInfo).getCursor();c.next();const f=c.readGeometry();if(!f)return;const[p,_]=f.coords;this.insertCursor(c,a.displayId,p,_,a.geohashX,a.geohashY,h,d)}insertCursor(a,h,d,c,f,p,_,y=0){let m=this._root,x=0,b=0,w=0;for(;null!==m;){if(m.depth>=y&&(m.count+=1,m.xTotal+=d,m.yTotal+=c,m.xGeohashTotal+=f,m.yGeohashTotal+=p,m.referenceId=h,this._updateStatisticsCursor(a,m,1)),x>=_)return void m.add(h);const L=Math.ceil((x+1)/2),N=Math.floor((x+1)/2),Q=1-x%2,q=30-(3*L+2*N),J=30-(2*L+3*N),re=(f&7*Q+3*(1-Q)<<q)>>q,se=(p&3*Q+7*(1-Q)<<J)>>J,te=re+se*(8*Q+4*(1-Q));b=b<<3*Q+2*(1-Q)|re,w=w<<2*Q+3*(1-Q)|se,null==m.children[te]&&(m.children[te]=this._acquire(b,w,x+1)),x+=1,m=m.children[te]}}remove(a,h){const d=E.fromOptimizedFeatures([a],this._serviceInfo).getCursor();d.next();const c=d.readGeometry();if(!c)return;const[f,p]=c.coords;this.removeCursor(d,f,p,a.geohashX,a.geohashY,h)}removeCursor(a,h,d,c,f,p){let _=this._root,y=0;for(;null!==_;){if(_.count-=1,_.xTotal-=h,_.yTotal-=d,_.xGeohashTotal-=c,_.yGeohashTotal-=f,this._updateStatisticsCursor(a,_,-1),y>=p)return void _.remove(a.getDisplayId());const m=Math.ceil((y+1)/2),x=Math.floor((y+1)/2),b=1-y%2,w=30-(3*m+2*x),L=30-(2*m+3*x),N=((c&7*b+3*(1-b)<<w)>>w)+((f&3*b+7*(1-b)<<L)>>L)*(8*b+4*(1-b)),Q=_.children[N];1===(null==Q?void 0:Q.count)&&(this._release(Q),_.children[N]=null),y+=1,_=Q}}forEach(a){let h=this._root;for(;null!==h;){const d=this._linkChildren(h)||h.next;a(h),h=d}}find(a,h,d){return this._root.find(a,h,d,0,0,0)}findIf(a){let h=null;return this.forEach(d=>{a(d)&&(h=d)}),h}findAllIf(a){const h=[];return this.forEach(d=>{a(d)&&h.push(d)}),h}findSingleOccupancyNode(a,h,d,c,f){let p=this._root;for(;null!==p;){const _=p.depth,y=p.xNode,m=p.yNode,x=1-_%2,b=p.xGeohashTotal/p.count,w=p.yGeohashTotal/p.count;if(1===p.count&&a<b&&b<=d&&h<w&&w<=c)return p;if(_>=f){p=p.next;continue}const L=Math.ceil((_+1)/2),N=Math.floor((_+1)/2),Q=30-(3*L+2*N),q=30-(2*L+3*N),J=~((1<<Q)-1),re=~((1<<q)-1),te=(h&re)>>q,oe=(d&J)>>Q,_e=(c&re)>>q,le=y<<3*x+2*(1-x),Fe=m<<2*x+3*(1-x),Me=le+8*x+4*(1-x),ge=Fe+4*x+8*(1-x),ve=Math.max(le,(a&J)>>Q),Se=Math.max(Fe,te),Ue=Math.min(Me,oe),Ne=Math.min(ge,_e);let Ve=null,dt=null;for(let Re=Se;Re<=Ne;Re++)for(let ut=ve;ut<=Ue;ut++){const Ze=p.children[ut-le+(Re-Fe)*(8*x+4*(1-x))];Ze&&(Ve||(Ve=Ze,Ve.next=p.next),dt&&(dt.next=Ze),dt=Ze,Ze.next=p.next)}p=Ve||p.next}return null}getRegionDisplayIds(a){let h=this._root;const{bounds:d,geohashBounds:c,level:f}=a,[p,_,y,m]=d,x=[];for(;null!==h;){const b=h.depth,w=h.xNode,L=h.yNode;if(b>=f){const Je=h.xTotal/h.count,Ze=h.yTotal/h.count;Je>=p&&Je<=y&&Ze>=_&&Ze<=m&&h.displayIds.forEach(yt=>x.push(yt)),h=h.next;continue}const N=Math.ceil((b+1)/2),Q=Math.floor((b+1)/2),q=1-b%2,J=30-(3*N+2*Q),re=30-(2*N+3*Q),se=~((1<<J)-1),te=~((1<<re)-1),_e=(c.yLL&te)>>re,le=(c.xTR&se)>>J,Fe=(c.yTR&te)>>re,Me=w<<3*q+2*(1-q),ge=L<<2*q+3*(1-q),ve=Me+8*q+4*(1-q),Se=ge+4*q+8*(1-q),Ue=Math.max(Me,(c.xLL&se)>>J),Ne=Math.max(ge,_e),Ve=Math.min(ve,le),dt=Math.min(Se,Fe);let Re=null,ut=null;for(let Je=Ne;Je<=dt;Je++)for(let Ze=Ue;Ze<=Ve;Ze++){const lt=h.children[Ze-Me+(Je-ge)*(8*q+4*(1-q))];lt&&(Re||(Re=lt,Re.next=h.next),ut&&(ut.next=lt),ut=lt,lt.next=h.next)}h=Re||h.next}return x}getRegionStatistics(a){let h=this._root,d=0,c=0,f=0;const p={},{bounds:_,geohashBounds:y,level:m}=a,[x,b,w,L]=_;let N=0;for(;null!==h;){const Q=h.depth,q=h.xNode,J=h.yNode;if(Q>=m){const It=h.xTotal/h.count,vt=h.yTotal/h.count;It>x&&It<=w&&vt>b&&vt<=L&&(d+=h.count,c+=h.xTotal,f+=h.yTotal,1===h.count&&(N=h.referenceId),this._aggregateStatistics(p,h.statistics)),h=h.next;continue}const re=Math.ceil((Q+1)/2),se=Math.floor((Q+1)/2),te=1-Q%2,oe=30-(3*re+2*se),_e=30-(2*re+3*se),le=~((1<<oe)-1),Fe=~((1<<_e)-1),ge=(y.yLL&Fe)>>_e,ve=(y.xTR&le)>>oe,Se=(y.yTR&Fe)>>_e,Ue=q<<3*te+2*(1-te),Ne=J<<2*te+3*(1-te),Ve=Ue+8*te+4*(1-te),dt=Ne+4*te+8*(1-te),Re=Math.max(Ue,(y.xLL&le)>>oe),ut=Math.max(Ne,ge),Je=Math.min(Ve,ve),Ze=Math.min(dt,Se);let yt=null,lt=null;for(let It=ut;It<=Ze;It++)for(let vt=Re;vt<=Je;vt++){const ze=h.children[vt-Ue+(It-Ne)*(8*te+4*(1-te))];if(ze){if(It!==ut&&It!==Ze&&vt!==Re&&vt!==Je){const As=ze.xTotal/ze.count,ws=ze.yTotal/ze.count;As>x&&As<=w&&ws>b&&ws<=L&&(d+=ze.count,c+=ze.xTotal,f+=ze.yTotal,1===ze.count&&(N=ze.referenceId),this._aggregateStatistics(p,ze.statistics));continue}yt||(yt=ze,yt.next=h.next),lt&&(lt.next=ze),lt=ze,ze.next=h.next}}h=yt||h.next}return{count:d,attributes:this.normalizeStatistics(p,d),xTotal:c,yTotal:f,referenceId:N}}getBins(a){const h=[],{geohashBounds:d,level:c}=a;let f=this._root;for(;null!==f;){const p=f.depth,_=f.xNode,y=f.yNode;if(p>=c){h.push(f),f=f.next;continue}const m=Math.ceil((p+1)/2),x=Math.floor((p+1)/2),b=1-p%2,w=30-(3*m+2*x),L=30-(2*m+3*x),N=~((1<<w)-1),Q=~((1<<L)-1),J=(d.yLL&Q)>>L,re=(d.xTR&N)>>w,se=(d.yTR&Q)>>L,te=_<<3*b+2*(1-b),oe=y<<2*b+3*(1-b),_e=te+8*b+4*(1-b),le=oe+4*b+8*(1-b),Fe=Math.max(te,(d.xLL&N)>>w),Me=Math.max(oe,J),ge=Math.min(_e,re),ve=Math.min(le,se);let Se=null,Ue=null;for(let Ne=Me;Ne<=ve;Ne++)for(let Ve=Fe;Ve<=ge;Ve++){const Re=f.children[Ve-te+(Ne-oe)*(8*b+4*(1-b))];Re&&(Se||(Se=Re,Se.next=f.next),Ue&&(Ue.next=Re),Ue=Re,Re.next=f.next)}f=Se||f.next}return h}_linkChildren(a){let h=null,d=null;for(let c=0;c<=a.children.length;c++){const f=a.children[c];f&&(h||(h=f,h.next=a.next),d&&(d.next=f),d=f,f.next=a.next)}return h}_updateStatisticsCursor(a,h,d){var c,f;for(const p of this._statisticFields){const _=p.name,y=p.inField?a.readAttribute(p.inField):a.getComputedNumericAtIndex(p.inFieldIndex);switch(p.statisticType){case"min":if(isNaN(y))break;if(!h.statistics[_]){h.statistics[_]={value:y};break}h.statistics[_].value=Math.min(h.statistics[_].value,y);break;case"max":if(isNaN(y))break;if(!h.statistics[_]){h.statistics[_]={value:y};break}h.statistics[_].value=Math.max(h.statistics[_].value,y);break;case"count":break;case"sum":case"avg":{h.statistics[_]||(h.statistics[_]={value:0,nanCount:0});const m=h.statistics[_].value,x=null!=(c=h.statistics[_].nanCount)?c:0;null==y||isNaN(y)?h.statistics[_].nanCount=x+d:h.statistics[_].value=m+d*y;break}case"avg_angle":{h.statistics[_]||(h.statistics[_]={x:0,y:0,nanCount:0});const m=h.statistics[_].x,x=h.statistics[_].y,b=null!=(f=h.statistics[_].nanCount)?f:0,w=Math.PI/180;null==y||isNaN(y)?h.statistics[_].nanCount=b+d:(h.statistics[_].x=m+d*Math.cos(y*w),h.statistics[_].y=x+d*Math.sin(y*w));break}case"mode":h.statistics[_]||(h.statistics[_]={}),h.statistics[_][y]=(h.statistics[_][y]||0)+d}}}_aggregateStatistics(a,h){for(const d of this._statisticFields){const c=d.name;switch(d.statisticType){case"min":if(!a[c]){a[c]={value:h[c].value};break}a[c].value=Math.min(a[c].value,h[c].value);break;case"max":if(!a[c]){a[c]={value:h[c].value};break}a[c].value=Math.max(a[c].value,h[c].value);break;case"count":break;case"sum":case"avg":case"avg_angle":case"mode":a[c]||(a[c]={});for(const f in h[c])a[c][f]=(a[c][f]||0)+h[c][f]}}}normalizeStatistics(a,h){const d={};for(const c of this._statisticFields){const f=c.name;switch(c.statisticType){case"min":case"max":{const p=a[f];if(!h||!p)break;d[f]=p.value;break}case"count":if(!h)break;d[f]=h;break;case"sum":{if(!h)break;const{value:p,nanCount:_}=a[f];if(!(h-_))break;d[f]=p;break}case"avg":{if(!h)break;const{value:p,nanCount:_}=a[f];if(!(h-_))break;d[f]=p/(h-_);break}case"avg_angle":{if(!h)break;const{x:p,y:_,nanCount:y}=a[f];if(!(h-y))break;const b=180/Math.PI,w=Math.atan2(_/(h-y),p/(h-y))*b;d[f]=w;break}case"mode":{const p=a[f];let _=0,y=0,m=null;for(const x in p){const b=p[x];b===_?y+=1:b>_&&(_=b,y=1,m=x)}d[f]="null"===m||y>1?null:m;break}}}return d}}class os{constructor(a,h,d,c){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=h,this.yNode=d,this.depth=c}realloc(a,h,d){for(let c=0;c<this.children.length;c++)this.children[c]=null;return this.xNode=a,this.yNode=h,this.depth=d,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.referenceId=null,a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,h){const d=this.getLngLatBounds(),[c,f,p,_]=d,y=(0,_t.iV)({rings:[[[c,f],[c,_],[p,_],[p,f],[c,f]]]},pt.Z.WGS84,a),m=(0,A.Uy)(new X.Z,y,!1,!1);return(0,C.pC)(h)?(0,A.Nh)(new X.Z,m,!1,!1,"esriGeometryPolygon",h,!1,!1):m}getGeometryCentroid(a,h){const d=this.getLngLatBounds(),[c,f,p,_]=d,y=(0,_t.iV)({x:(c+p)/2,y:(f+_)/2},pt.Z.WGS84,a),m=(0,A.dd)(new X.Z,y);return(0,C.pC)(h)?(0,A.Nh)(new X.Z,m,!1,!1,"esriGeometryPoint",h,!1,!1):m}getLngLatBounds(){const a=this.depth,h=Math.ceil(a/2),d=Math.floor(a/2);return function ar(g,a){let h=-90,d=90,c=-180,f=180;for(let p=0;p<a;p++){const _=Math.ceil((p+1)/2),y=Math.floor((p+1)/2),m=1-p%2,x=30-(3*_+2*y),b=30-(2*_+3*y),L=2*m+3*(1-m),Q=(7*m+3*(1-m)<<x&g.geohashX)>>x,q=(3*m+7*(1-m)<<b&g.geohashY)>>b;for(let J=3*m+2*(1-m)-1;J>=0;J--){const re=(c+f)/2,se=Q&1<<J?1:0;c=(1-se)*c+se*re,f=(1-se)*re+se*f}for(let J=L-1;J>=0;J--){const re=(h+d)/2,se=q&1<<J?1:0;h=(1-se)*h+se*re,d=(1-se)*re+se*d}}return[c,h,f,d]}({geohashX:this.xNode<<30-(3*h+2*d),geohashY:this.yNode<<30-(2*h+3*d)},this.depth)}find(a,h,d,c,f,p){if(c>=d)return this;const _=1-c%2,y=3*_+2*(1-_),m=2*_+3*(1-_),x=30-f-y,b=30-p-m,L=this.children[((a&7*_+3*(1-_)<<x)>>x)+((h&3*_+7*(1-_)<<b)>>b)*(8*_+4*(1-_))];return null==L?null:L.find(a,h,d,c+1,f+y,p+m)}}var xs=T(5548),mt=T(94425),bs=T(16669),Ss=T(37118),us=T(2004);const hs=k.Z.getLogger("esri.view.2d.layers.features.support.BinStore"),cr=(0,xs.Ue)();function Ts(g){return 57.29577951308232*g}class fr extends bs.J{constructor(a,h,d,c){super(a,d),this.type="bin",this.events=new gt.Z,this.objectIdField="aggregateId",this.featureAdapter=F.k,this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=c,this.geometryInfo=a.geometryInfo,this._spatialReference=h,this._projectionSupportCheck=(0,_t._W)(h,pt.Z.WGS84),this._bitsets.geohash=d.getBitset(d.createBitset()),this._bitsets.inserted=d.getBitset(d.createBitset())}destroy(){this._tree&&this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(a,h){var d=()=>super.updateSchema,c=this;return(0,U.Z)(function*(){const f=c._schema;try{yield d().call(c,a,h),yield c._projectionSupportCheck}catch(_){}c._fields=c._schema.params.fields;const p=(0,Ge.Hg)(f,h);h&&(!(0,C.Wi)(p)||a.source||a.storage.filters)?(((0,Ge.uD)(p,"params.fields")||(0,Ge.uD)(p,"params")||!c._tree||a.source)&&(c._tree&&c._tree.destroy(),c._tree=new vs(c._statisticFields,c._serviceInfo),c._tree.onRelease=_=>_.displayId&&c._storage.releaseDisplayId(_.displayId),c._geohashLevel=c._schema.params.fixedBinLevel,c._rebuildTree(),(0,S.Z)("esri-2d-update-debug")&&hs.info("Aggregate mesh needs update due to tree changing")),(0,S.Z)("esri-2d-update-debug")&&hs.info("Aggregate mesh needs update due to tree changing"),a.targets[h.name]=!0,a.mesh=!1):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,h){this._bitsets.inserted.forEachSet(d=>{if(!a.has(d)){const c=h.lookupByDisplayIdUnsafe(d);this._remove(c)}})}sweepAggregates(a,h,d){}onTileData(a,h,d,c,f=!0){if(!this._schema||(0,C.Wi)(h.addOrUpdate))return h;this.events.emit("changed");const p=this._getTransforms(a,this._spatialReference);{const y=h.addOrUpdate.getCursor();for(;y.next();)this._update(y,c)}if(h.status.mesh||!f)return h;const _=new Array;this._getBinsForTile(_,a,p,d),h.addOrUpdate=E.fromOptimizedFeatures(_,Ee(Ie({},this._serviceInfo),{geometryType:"esriGeometryPolygon"})),h.addOrUpdate.attachStorage(d),h.end=!0,h.isRepush||(h.clear=!0);{const y=h.addOrUpdate.getCursor();for(;y.next();){const m=y.getDisplayId();this._bitsets.computed.unset(m),this.setComputedAttributes(d,y,m,a.scale)}}return h}forEachBin(a){this._tree.forEach(a)}forEach(a){this._tree.forEach(h=>{if(h.depth!==this._geohashLevel)return;const d=this._toFeatureJSON(h),c=E.fromFeatures([d],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();c.next(),a(c)})}forEachInBounds(a,h){}forEachBounds(a,h){const{hasM:d,hasZ:c}=this.geometryInfo;for(const f of a){const p=(0,A.$)(cr,f.readGeometry(),c,d);(0,C.Wi)(p)||h(p)}}onTileUpdate(a){}getAggregate(a){const h=(0,ye.QS)(a,!0),d=this._tree.findIf(c=>c.displayId===h);return(0,C.yw)(d,c=>this._toFeatureJSON(c))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toFeatureJSON.bind(this))}getDisplayId(a){const h=this._tree.findIf(d=>d.id===a);return(0,C.yw)(h,d=>d.displayId)}getFeatureDisplayIdsForAggregate(a){const h=this._tree.findIf(d=>d.id===a);return(0,C.R2)(h,[],d=>Array.from(d.displayIds))}getDisplayIdForReferenceId(a){const h=this._tree.findIf(d=>1===d.displayIds.size&&d.displayIds.has(a));return(0,C.yw)(h,d=>d.displayId)}_toFeatureJSON(a){const h=this._spatialReference;return{displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,A.di)(a.getGeometry(h),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const h=a.getDisplayId(),d=a.getXHydrated(),c=a.getYHydrated(),f=this._geohashBuf[2*h],p=this._geohashBuf[2*h+1];this._bitsets.inserted.has(h)&&(this._bitsets.inserted.unset(h),this._tree.removeCursor(a,d,c,f,p,this._geohashLevel))}_update(a,h){const d=a.getDisplayId(),c=this._bitsets.inserted,f=h.isVisible(d);if(f===c.has(d))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),_=a.getYHydrated();this._setGeohash(d,p,_)&&(this._tree.insertCursor(a,d,p,_,this._geohashBuf[2*d],this._geohashBuf[2*d+1],this._geohashLevel),c.set(d))}_setGeohash(a,h,d){if(this._bitsets.geohash.has(a))return!0;const c=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=Ts(h/mt.sv.radius),p=f-360*Math.floor((f+180)/360);Vt(c,a,Ts(Math.PI/2-2*Math.atan(Math.exp(-d/mt.sv.radius))),p,12)}else{const f=(0,_t.iV)({x:h,y:d},this._spatialReference,pt.Z.WGS84);if(!f)return!1;Vt(c,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,h,d,c){try{const f=this._getGeohashBounds(h),p=this._tree.getBins(f);for(const _ of p){_.displayId||(_.displayId=c.createDisplayId(!0));let y=null;const m=_.getGeometry(this._spatialReference,d.tile);m||(y=_.getGeometryCentroid(this._spatialReference,d.tile));const x=new D.u_(m,_.getAttributes(),y);x.objectId=_.id,x.displayId=_.displayId,a.push(x)}}catch(f){return void hs.error("Unable to get bins for tile",h.key.id)}}_getGeohash(a,h,d){const c={geohashX:0,geohashY:0};return Xt(c,h,a,d),c}_getGeohashBounds(a){const h=this._getGeohashLevel(a.key.level),d=[a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],c=Ss.Z.fromExtent(us.Z.fromBounds(d,this._spatialReference)),f=(0,_t.iV)(c,this._spatialReference,pt.Z.WGS84,{densificationStep:64*a.resolution}),p=(0,A.Uy)(new X.Z,f,!1,!1),_=p.coords.filter((Q,q)=>!(q%2)),y=p.coords.filter((Q,q)=>q%2),m=Math.min(..._),x=Math.min(...y),b=Math.max(..._),w=Math.max(...y),L=this._getGeohash(m,x,h),N=this._getGeohash(b,w,h);return{bounds:d,geohashBounds:{xLL:L.geohashX,yLL:L.geohashY,xTR:N.geohashX,yTR:N.geohashY},level:h}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,h){const d={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},c=(0,ue.C5)(h);if(!c)return{tile:d,left:null,right:null};const[f,p]=c.valid;return{tile:d,left:Ee(Ie({},d),{translate:[p,a.bounds[3]]}),right:Ee(Ie({},d),{translate:[f-p+a.bounds[0],a.bounds[3]]})}}}const _r=(0,xs.Ue)();class ls extends D.nd{constructor(a,h,d,c,f){super(new X.Z([],[h,d]),c,null,a),this.geohashBoundsInfo=f}get count(){return this.attributes.cluster_count}static create(a,h,d,c,f,p,_,y){const m=new ls(h,d,c,p,_);return m.displayId=a.createDisplayId(!0),m.referenceId=y,m.tileLevel=f,m}update(a,h,d,c,f,p){return this.geometry.coords[0]=a,this.geometry.coords[1]=h,this.tileLevel=d,this.attributes=c,this.geohashBoundsInfo=f,this.referenceId=null,this.referenceId=p,this}toJSON(){return{attributes:Ee(Ie({},this.attributes),{aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function Bt(g){return 57.29577951308232*g}class mr extends bs.J{constructor(a,h,d,c){super(a,d),this.type="cluster",this.events=new gt.Z,this.objectIdField="aggregateId",this.featureAdapter=F.k,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=c,this.geometryInfo=a.geometryInfo,this._spatialReference=h,this._projectionSupportCheck=(0,_t._W)(h,pt.Z.WGS84),this._bitsets.geohash=d.getBitset(d.createBitset()),this._bitsets.inserted=d.getBitset(d.createBitset())}destroy(){this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(a,h){var d=()=>super.updateSchema,c=this;return(0,U.Z)(function*(){const f=c._schema;try{yield d().call(c,a,h),yield c._projectionSupportCheck}catch(_){}c._fields=c._schema.params.fields;const p=(0,Ge.Hg)(f,h);h&&(!(0,C.Wi)(p)||a.source||a.storage.filters)?(((0,Ge.uD)(p,"params.fields")||!c._tree||a.source)&&(c._tree&&c._tree.destroy(),c._tree=new vs(c._statisticFields,c._serviceInfo),c._rebuildTree(),(0,S.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,S.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",p),a.targets[h.name]=!0,a.mesh=!1,c._aggregateValueRanges={}):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,h){this._bitsets.inserted.forEachSet(d=>{if(!a.has(d)){const c=h.lookupByDisplayIdUnsafe(d);this._remove(c)}})}sweepAggregates(a,h,d){this._clusters.forEach((c,f)=>{c&&c.tileLevel!==d&&(a.releaseDisplayId(c.displayId),h.unsetAttributeData(c.displayId),this._clusters.delete(f))})}onTileData(a,h,d,c,f=!0){if(!this._schema||(0,C.Wi)(h.addOrUpdate))return h;this.events.emit("changed");const p=this._getTransforms(a,this._spatialReference);{const m=h.addOrUpdate.getCursor();for(;m.next();)this._update(m,c)}if(h.status.mesh||!f)return h;const _=new Array;this._getClustersForTile(_,a,this._schema.params.clusterRadius,d,p),h.addOrUpdate=E.fromOptimizedFeatures(_,this._serviceInfo),h.addOrUpdate.attachStorage(d),h.clear=!0,h.end=!0;{const m=h.addOrUpdate.getCursor();for(;m.next();){const x=m.getDisplayId();this._bitsets.computed.unset(x),this.setComputedAttributes(d,m,x,a.scale)}}return this._aggregateValueRangesChanged&&h.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),h}onTileUpdate({added:a,removed:h}){if(a.length){const c=a[0].level;this._tileLevel=c,this._setGeohashLevel(c)}if(!this._schema)return;const d=this._schema.params.clusterRadius;h.forEach(c=>{this._tiles.delete(c.key.id),this._markTileClustersForDeletion(c,d)})}getAggregate(a){for(const h of this._clusters.values())if(((null==h?void 0:h.displayId)&ye._I)==(a&ye._I))return h.toJSON();return null}getAggregates(){const a=[];for(const h of this._clusters.values())(null==h?void 0:h.tileLevel)===this._tileLevel&&a.push(h.toJSON());return a}getDisplayId(a){const h=this._clusters.get(a);return h?h.displayId:null}getFeatureDisplayIdsForAggregate(a){const h=this._clusters.get(a);return h?this._tree.getRegionDisplayIds(h.geohashBoundsInfo):[]}getDisplayIdForReferenceId(a){for(const h of this._clusters.values())if((null==h?void 0:h.referenceId)===a)return h.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){this._clusters.forEach(h=>{if(!h)return;const d=h.toJSON(),c=E.fromFeatures([d],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();c.next(),a(c)})}forEachInBounds(a,h){}forEachBounds(a,h){const{hasM:d,hasZ:c}=this.geometryInfo;for(const f of a){const p=(0,A.$)(_r,f.readGeometry(),c,d);(0,C.Wi)(p)||h(p)}}size(){let a=0;return this.forEach(h=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const h=a.getDisplayId(),d=a.getXHydrated(),c=a.getYHydrated(),f=this._geohashBuf[2*h],p=this._geohashBuf[2*h+1];this._bitsets.inserted.has(h)&&(this._bitsets.inserted.unset(h),this._tree.removeCursor(a,d,c,f,p,this._geohashLevel))}_update(a,h){const d=a.getDisplayId(),c=this._bitsets.inserted,f=h.isVisible(d);if(f===c.has(d))return;if(!f)return void this._remove(a);const p=a.getXHydrated(),_=a.getYHydrated();this._setGeohash(d,p,_)&&(this._tree.insertCursor(a,d,p,_,this._geohashBuf[2*d],this._geohashBuf[2*d+1],this._geohashLevel),c.set(d))}_setGeohash(a,h,d){if(this._bitsets.geohash.has(a))return!0;const c=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=Bt(h/mt.sv.radius),p=f-360*Math.floor((f+180)/360);Vt(c,a,Bt(Math.PI/2-2*Math.atan(Math.exp(-d/mt.sv.radius))),p,12)}else{const f=(0,_t.iV)({x:h,y:d},this._spatialReference,pt.Z.WGS84);if(!f)return!1;Vt(c,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,h,d,c,f,p=!0){const _=this._schema.params.clusterPixelBuffer,y=2*d,m=Math.ceil(2**h.key.level*De.I_/y)+1,x=Math.ceil(_/y)+0,b=Math.ceil(De.I_/y),{row:w,col:L}=h.key,Q=w*De.I_,q=Math.floor(L*De.I_/y)-x,J=Math.floor(Q/y)-x,re=q+b+2*x,se=J+b+2*x,te=h.tileInfoView.getLODInfoAt(h.key.level);for(let oe=q;oe<=re;oe++)for(let _e=J;_e<=se;_e++){let le=oe;te.wrap&&(le=oe<0?oe+m:oe%m);const Fe=te.wrap&&oe<0,Me=te.wrap&&oe%m!==oe,ge=this._lookupCluster(c,te,h.key.level,le,_e,h);if((0,C.pC)(ge)){const ve=(0,C.yw)(f,Se=>Fe?Se.left:Me?Se.right:Se.tile);if(p&&(0,C.Wi)(ve)||!ge.count)continue;if((0,C.pC)(ve)&&p){const Se=ge.geometry.clone();let Ue=ge.attributes;Se.coords[0]=(0,A.Jd)(ve,Se.coords[0]),Se.coords[1]=(0,A.IN)(ve,Se.coords[1]),1===ge.count&&(0,C.pC)(ge.referenceId)&&(Ue=Ee(Ie({},ge.attributes),{referenceId:ge.referenceId}));const Ne=new D.u_(Se,Ue);Ne.displayId=ge.displayId,a.push(Ne)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const h=this._getGeohashLevel(a),d=1*(Math.floor(h/1)+1)-1;if(this._geohashLevel!==d)return this._geohashLevel=d,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,h){const d={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},c=(0,ue.C5)(h);if(!c)return{tile:d,left:null,right:null};const[f,p]=c.valid;return{tile:d,left:Ee(Ie({},d),{translate:[p,a.bounds[3]]}),right:Ee(Ie({},d),{translate:[f-p+a.bounds[0],a.bounds[3]]})}}_getClusterId(a,h,d){return(15&a)<<28|(16383&h)<<14|16383&d}_markForDeletion(a,h,d){const c=this._getClusterId(a,h,d);this._clusters.delete(c)}_getClusterBounds(a,h,d){const c=this._schema.params.clusterRadius,f=2*c;let p=d%2?h*f:h*f-c;const _=d*f;let y=p+f;const x=2**a.level*De.I_;a.wrap&&p<0&&(p=0),a.wrap&&y>x&&(y=x);const w=_/De.I_,L=y/De.I_,N=(_-f)/De.I_;return[a.getXForColumn(p/De.I_),a.getYForRow(w),a.getXForColumn(L),a.getYForRow(N)]}_getGeohash(a,h,d){const c={geohashX:0,geohashY:0};return Xt(c,h,a,d),c}_getGeohashBounds(a,h){const d=this._getGeohashLevel(a.key.level);if(this._spatialReference.isWebMercator){const[Q,q,J,re]=h,se={x:Q,y:q},te={x:J,y:re};let oe=0,_e=0,le=0,Fe=0;{const ve=Bt(se.x/mt.sv.radius);oe=ve-360*Math.floor((ve+180)/360),_e=Bt(Math.PI/2-2*Math.atan(Math.exp(-se.y/mt.sv.radius)))}{const ve=Bt(te.x/mt.sv.radius);le=ve-360*Math.floor((ve+180)/360),Fe=Bt(Math.PI/2-2*Math.atan(Math.exp(-te.y/mt.sv.radius)))}const Me={geohashX:0,geohashY:0},ge={geohashX:0,geohashY:0};return Xt(Me,_e,oe,d),Xt(ge,Fe,le,d),{bounds:[Q,q,J,re],geohashBounds:{xLL:Me.geohashX,yLL:Me.geohashY,xTR:ge.geohashX,yTR:ge.geohashY},level:d}}const c=Ss.Z.fromExtent(us.Z.fromBounds(h,this._spatialReference)),f=(0,_t.iV)(c,this._spatialReference,pt.Z.WGS84,{densificationStep:64*a.resolution});if(!f)return null;const p=(0,A.Uy)(new X.Z,f,!1,!1),_=p.coords.filter((Q,q)=>!(q%2)),y=p.coords.filter((Q,q)=>q%2),m=Math.min(..._),x=Math.min(...y),b=Math.max(..._),w=Math.max(...y),L=this._getGeohash(m,x,d),N=this._getGeohash(b,w,d);return{bounds:h,geohashBounds:{xLL:L.geohashX,yLL:L.geohashY,xTR:N.geohashX,yTR:N.geohashY},level:d}}_lookupCluster(a,h,d,c,f,p){const _=this._getClusterId(d,c,f),y=this._clusters.get(_),m=this._getClusterBounds(h,c,f),x=this._getGeohashBounds(p,m);if((0,C.Wi)(x))return null;const b=this._tree.getRegionStatistics(x),{count:w,xTotal:L,yTotal:N,referenceId:Q}=b,q=w?L/w:0,J=w?N/w:0;if(0===w)return this._clusters.set(_,null),null;const re=Ie({cluster_count:w},b.attributes),se=(0,C.pC)(y)?y.update(q,J,d,re,x,Q):ls.create(a,_,q,J,d,re,x,Q);if(0===w){const[te,oe,_e,le]=m;se.geometry.coords[0]=(te+_e)/2,se.geometry.coords[1]=(oe+le)/2}return this._clusters.set(_,se),this._updateAggregateValueRangeForCluster(se,se.tileLevel),se}_updateAggregateValueRangeForCluster(a,h){const d=this._aggregateValueRanges[h]||{minValue:1/0,maxValue:0},c=d.minValue,f=d.maxValue;d.minValue=Math.min(c,a.count),d.maxValue=Math.max(f,a.count),this._aggregateValueRanges[h]=d,c===d.minValue&&f===d.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,h){const d=2*h,c=Math.ceil(De.I_/d),{row:f,col:p}=a.key,y=f*De.I_,m=Math.floor(p*De.I_/d),x=Math.floor(y/d);for(let b=m;b<m+c;b++)for(let w=x;w<x+c;w++)this._markForDeletion(a.key.level,b,w)}}class yr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,ye.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var Ir=T(42797);function qt(g,a,h){if(!(g.length>a))for(;g.length<=a;)g.push(h)}class vr{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new yr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(Ir.p.create(this._allocatedSize,ye._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,h){this._numerics[a]||(this._numerics[a]=[]),qt(this._numerics[a],h,0)}_ensureInstanceId(a){qt(this._instanceIds,a,0)}_ensureString(a,h){this._strings[a]||(this._strings[a]=[]),qt(this._strings[a],h,null)}createDisplayId(a=!1){const h=this._idGenerator.createId();return h>this._allocatedSize&&this._expand(),(0,ye.QS)(h,a)}releaseDisplayId(a){for(const h of this._bitsets)h.unset(a);return this._idGenerator.releaseId(a&ye._I)}getComputedNumeric(a,h){return this.getComputedNumericAtIndex(a&ye._I,0)}setComputedNumeric(a,h,d){return this.setComputedNumericAtIndex(a&ye._I,d,0)}getComputedString(a,h){return this.getComputedStringAtIndex(a&ye._I,0)}setComputedString(a,h,d){return this.setComputedStringAtIndex(a&ye._I,0,d)}getComputedNumericAtIndex(a,h){const d=a&ye._I;return this._ensureNumeric(h,d),this._numerics[h][d]}setComputedNumericAtIndex(a,h,d){const c=a&ye._I;this._ensureNumeric(h,c),this._numerics[h][c]=d}getInstanceId(a){const h=a&ye._I;return this._ensureInstanceId(h),this._instanceIds[h]}setInstanceId(a,h){const d=a&ye._I;this._ensureInstanceId(d),this._instanceIds[d]=h}getComputedStringAtIndex(a,h){const d=a&ye._I;return this._ensureString(h,d),this._strings[h][d]}setComputedStringAtIndex(a,h,d){const c=a&ye._I;this._ensureString(h,c),this._strings[h][c]=d}getXMin(a){return this._bounds[4*(a&ye._I)]}getYMin(a){return this._bounds[4*(a&ye._I)+1]}getXMax(a){return this._bounds[4*(a&ye._I)+2]}getYMax(a){return this._bounds[4*(a&ye._I)+3]}setBounds(a,h){const d=h.readHydratedGeometry();if(!d||!d.coords.length)return!1;let c=1/0,f=1/0,p=-1/0,_=-1/0;d.forEachVertex((m,x)=>{c=Math.min(c,m),f=Math.min(f,x),p=Math.max(p,m),_=Math.max(_,x)});const y=a&ye._I;return qt(this._bounds,4*y+4,0),this._bounds[4*y]=c,this._bounds[4*y+1]=f,this._bounds[4*y+2]=p,this._bounds[4*y+3]=_,!0}}function ht(g){if(!(0,G.D_)(g)&&!function Tr(g){return"worker:port-closed"===g.name}(g))throw g}function Ms(g){return"feature"===g.type&&"snapshot"===g.mode}let $e=class extends he.Z{constructor(){super(...arguments),this._storage=new vr,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new we.e({concurrency:"stream"===this._source.type?1:4,process:(g,a)=>this._onTileMessage(g,{signal:a})}),this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,Z.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function Ns(g,a,h,d,c,f){const p=function Qs(g,a,h,d,c,f){switch(g.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,C.Pt)(g.featureCount,0),serviceInfo:g,onMessage:d,outSR:a,tileInfoView:h,canAcceptRequest:c,store:f};case"stream":return{type:"stream",serviceInfo:g,onMessage:d,outSR:a,canAcceptRequest:c};case"memory":case"on-demand":return{type:"feature",serviceInfo:g,onMessage:d,outSR:a,origin:function p(_){return Array.isArray(_)?"local":"path"in _&&(0,R.M8)(_.path)?"hosted":"unknown"}(g.source),tileInfoView:h,canAcceptRequest:c}}}(g,a,h,d,c,f);switch(p.type){case"feature":switch(p.origin){case"hosted":case"local":return new es(p);case"snapshot":return new Rs(p);default:return new Nt(p)}case"stream":return new Ut(p)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(d,c)=>(this._invalidated=!0,this._patchTile(d,c)),()=>this._updateQueue&&this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("stream"===this._source.type){const g=this._source.events,a=this._source;this.addHandles([(0,Z.YP)(()=>a.connectionStatus,h=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:h}).catch(ht),{initial:!0}),(0,Z.YP)(()=>a.errorString,h=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:h}).catch(ht),{initial:!0}),g.on("data-received",h=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:h.attributes,centroid:h.centroid,geometry:h.geometry}}).catch(ht)),g.on("message-received",h=>this.remoteClient.invoke("emitEvent",{name:"message-received",event:h}).catch(ht)),g.on("updateRate",h=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:Ie({},h)}).catch(ht))])}}_initAttributeStore(g){this.attributeStore||(this.attributeStore=new er({type:"remote",initialize:(a,h)=>(0,G.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:h}).catch(ht)),update:(a,h)=>(0,G.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:h}).catch(ht)),render:a=>(0,G.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(ht))},g,()=>this.notifyChange("updating")))}_initStores(){this.featureStore=new F.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(g){var h,d;const a=this;null==(h=this.featureQueryEngine)||h.destroy(),this.featureQueryEngine=new v.q({definitionExpression:null!=(d=g.schema.source.definitionExpression)?d:void 0,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:c=>(0,C.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(c).map(f=>a.getObjectId(f))},timeInfo:this.service.timeInfo})}_initAggregateQueryEngine(g,a){var d;if(null==(d=this.aggregateQueryEngine)||d.destroy(),(0,C.Wi)(g))return;const h=a.targets.aggregate.params.fields.slice();this.aggregateQueryEngine=new v.q({definitionExpression:void 0,fields:h,geometryType:g.geometryInfo.geometryType,objectIdField:g.objectIdField,hasM:g.geometryInfo.hasM,hasZ:g.geometryInfo.hasZ,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!1,featureStore:g,aggregateAdapter:{getFeatureObjectIds:c=>[]}})}destroy(){var g,a,h;this._updateQueue.destroy(),this._source.destroy(),null==(g=this.featureQueryEngine)||g.destroy(),null==(a=this.aggregateQueryEngine)||a.destroy(),null==(h=this.attributeStore)||h.destroy();for(const d of this.tileStore.tiles)this._source.unsubscribe(d);clearInterval(this._checkUpdating)}get fieldsIndex(){return new I.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const g=this._source.updating,a=!!this._updateQueue.length,h=!this.attributeStore||this.attributeStore.isUpdating(),d=g||a||h;return(0,S.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${d}\n  -> updatingSource ${g}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${h}\n`),d}updateCustomParameters(g){"stream"===this._source.type&&this._source.updateCustomParameters(g)}enableEvent(g){this._source.enableEvent(g.name,g.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"stream"===this._source.type&&this._source.pauseStream()}resumeStream(){"stream"===this._source.type&&this._source.resumeStream()}sendMessageToSocket(g){"stream"===this._source.type&&this._source.sendMessageToSocket(g)}sendMessageToClient(g){"stream"===this._source.type&&this._source.sendMessageToClient(g)}_initAggregateStore(g){var d,c;const a=null==(c=null==(d=g.schema.targets)?void 0:d.aggregate)?void 0:c.type;if((0,C.yw)(this.config,f=>{var p,_;return null==(_=null==(p=f.schema.targets)?void 0:p.aggregate)?void 0:_.type})!==a&&((0,C.pC)(this.aggregateStore)&&(this.removeHandles("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),a)){switch(a){case"cluster":this.aggregateStore=new mr({geometryInfo:{geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service),this.addHandles(this.aggregateStore.events.on("valueRangesChanged",p=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:p.valueRanges}}).catch(ht)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new fr({geometryInfo:{geometryType:"esriGeometryPolygon",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(g,a){var h=this;return(0,U.Z)(function*(){h._updateVersion++,h._initQueryEngine(a),h._initAttributeStore(a),h.pause(),yield Promise.all([h._source.update(g,a.schema.source),h.featureStore.updateSchema(g,a.schema.targets.feature),h.attributeStore.update(g,a),h.attributeStore.updateFilters(g,a,h)]),h._initAggregateStore(a),(0,C.pC)(h.aggregateStore)&&(yield h.aggregateStore.updateSchema(g,a.schema.targets.aggregate)),h._initAggregateQueryEngine(h.aggregateStore,a.schema),(0,S.Z)("esri-2d-update-debug")&&g.describe(),h._set("config",a)})()}applyUpdate(g){var a=this;return(0,U.Z)(function*(){g.version=a._updateVersion,(0,S.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${g.version}`),g.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(g),a.notifyChange("updating"),yield(0,Z.N1)(()=>!a.updating),(0,C.pC)(a.aggregateStore)&&(yield(0,G.e4)(10),yield(0,Z.N1)(()=>!a.updating))})()}onEdits({edits:g}){var a=this;return(0,U.Z)(function*(){(0,S.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",g),a._didEdit=!0;try{const h=g.removed.map(c=>c.objectId&&-1!==c.objectId?c.objectId:a._lookupObjectIdByGlobalId(c.globalId)),d=g.addOrModified.map(({objectId:c})=>c);a.featureStore.invalidate(),yield a._source.edit(d,h),a.clearTiles(),a.notifyChange("updating"),(0,C.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,Z.N1)(()=>!a.updating)}catch(h){}})()}refresh(g){var a=this;return(0,U.Z)(function*(){if(!g.dataChanged){const h=ne.empty();return h.storage.filters=!0,a.applyUpdate(h)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion,g),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,Z.N1)(()=>!a.updating)})()}clearTiles(){for(const g of this.tileStore.tiles)this.processor.onTileClear(g)}onTileUpdate(g){(0,C.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(g);for(const a of g.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of g.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var g=this;return(0,U.Z)(function*(){g._invalidated&&(g._invalidated=!1,((0,C.pC)(g.aggregateStore)||"heatmap"===g.processor.type)&&(yield g._repushCurrentLevelTiles())),g._markAndSweep()})()}querySummaryStatistics({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForSummaryStatistics(g,a)})()}queryAggregateSummaryStatistics({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForSummaryStatistics(g,a)})()}queryUniqueValues({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForUniqueValues(g,a)})()}queryAggregateUniqueValues({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForUniqueValues(g,a)})()}queryClassBreaks({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForClassBreaks(g,a)})()}queryAggregateClassBreaks({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForClassBreaks(g,a)})()}queryHistogram({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForHistogram(g,a)})()}queryAggregateHistogram({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForHistogram(g,a)})()}queryExtent(g){return this.featureQueryEngine.executeQueryForExtent(g)}queryAggregates(g){return this.aggregateQueryEngine.executeQuery(g)}queryAggregateCount(g){return this.aggregateQueryEngine.executeQueryForCount(g)}queryAggregateIds(g){return this.aggregateQueryEngine.executeQueryForIds(g)}queryFeatures(g){return this.featureQueryEngine.executeQuery(g)}queryVisibleFeatures(g){var a=this;return(0,U.Z)(function*(){const h=yield a.featureQueryEngine.executeQuery(g),d=h.objectIdFieldName;return h.features=h.features.filter(c=>{const p=a.getDisplayId(c.attributes[d]);return(0,C.yw)(p,_=>a.attributeStore.isVisible(_))}),h})()}queryFeatureCount(g){return this.featureQueryEngine.executeQueryForCount(g)}queryLatestObservations(g){return this.featureQueryEngine.executeQueryForLatestObservations(g)}queryObjectIds(g){return this.featureQueryEngine.executeQueryForIds(g)}queryStatistics(){var g=this;return(0,U.Z)(function*(){return g.featureStore.storeStatistics})()}getObjectId(g){return this.featureStore.lookupObjectId(g,this._storage)}getDisplayId(g){if((0,C.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(g);if((0,C.Wi)(a)){const h=this.featureStore.lookupDisplayId(g);return this.aggregateStore.getDisplayIdForReferenceId(h)}return a}return this.featureStore.lookupDisplayId(g)}getFeatures(g){const a=[],h=[];for(const d of g){const c=(0,C.pC)(this.aggregateStore)?this.getAggregate(d):null;if((0,C.pC)(c))if((0,C.pC)(c.attributes.referenceId)){const f=this.getFeature(c.attributes.referenceId);(0,C.pC)(f)&&a.push(f)}else h.push(c);else{const f=this.getFeature(d);(0,C.pC)(f)&&a.push(f)}}return{features:a,aggregates:h}}getFeature(g){const a=this.featureStore.lookupFeatureByDisplayId(g,this._storage);if((0,C.Wi)(a))return null;const h=a.readHydratedGeometry(),d=(0,A.di)(h,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:d}}getAggregate(g){return(0,C.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(g)}getAggregates(){return(0,C.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(g){var a=this;return(0,U.Z)(function*(){const h=(0,C.lV)(g.map(d=>a.getDisplayId(d)));return a.attributeStore.setHighlight(g,h)})()}_lookupObjectIdByGlobalId(g){const a=this.service.globalIdField;if((0,C.Wi)(a))throw new Error("Expected globalIdField to be defined");let h=null;if(this.featureStore.forEach(d=>{g===d.readAttribute(a)&&(h=d.getObjectId())}),(0,C.Wi)(h))throw new Error(`Expected to find a feature with globalId ${g}`);return h}_repushCurrentLevelTiles(){var g=this;return(0,U.Z)(function*(){const a=g.tileStore.tiles.filter(d=>d.level===g._level);a.map(function(){var d=(0,U.Z)(function*(c){return g._patchTile({type:"append",id:c.key.id,clear:!0,addOrUpdate:null,end:!1})});return function(c){return d.apply(this,arguments)}}());const h=a.map(function(){var d=(0,U.Z)(function*(c){return g._patchTile({type:"append",id:c.key.id,addOrUpdate:E.fromOptimizedFeatures([],g.service),remove:[],end:!0,isRepush:!0,status:ne.empty()})});return function(c){return d.apply(this,arguments)}}());yield Promise.all(h)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(g,a){const h=this._updateQueue.push(g,a).then(()=>{this.notifyChange("updating")}).catch(d=>{this.notifyChange("updating")});return this.notifyChange("updating"),h}_onTileMessage(g,a){var h=this;return(0,U.Z)(function*(){var p;if((0,G.k_)(a),(0,S.Z)("esri-2d-update-debug")){const _=(0,C.yw)(g.addOrUpdate,y=>y.hasFeatures);console.debug(g.id,`FeatureController:onTileMessage: [clear:${g.clear}, end:${g.end}, features: ${_}]`)}const d=h.tileStore.get(g.id);if(!d)return;if(g.clear)return h.processor.onTileClear(d);const c=g.status;h._cleanupNeeded=!0;const f=[];for(const _ of null!=(p=g.remove)?p:[]){const y=h.featureStore.lookupDisplayId(_);y&&f.push(y)}g.remove=f;try{if((0,C.Wi)(g.addOrUpdate))return void h.processor.onTileMessage(d,Ee(Ie({},g),{addOrUpdate:null}),(0,C.pC)(h.aggregateStore),a).catch(G.H9);if(g.addOrUpdate.setArcadeSpatialReference(h.spatialReference),h.featureStore.hasInstance(g.addOrUpdate.instance)&&c.targets.feature||(c.targets.feature=!0,h.featureStore.onTileData(d,g)),(!c.storage.data||!c.storage.filters)&&(c.storage.data=!0,c.storage.filters=!0,h.attributeStore.onTileData(d,g),"stream"===h._source.type||h._didEdit?(yield h.attributeStore.sendUpdates(),(0,G.k_)(a)):h.attributeStore.sendUpdates()),(0,C.pC)(h.aggregateStore)&&!c.targets.aggregate){c.targets.aggregate=!0;const _=Ms(h._source)&&h._source.loading,y=!Ms(h._source)||_||g.end;if(h.aggregateStore.onTileData(d,g,h._storage,h.attributeStore,y),!y)return;c.mesh||(h.attributeStore.onTileData(d,g),yield h.attributeStore.sendUpdates())}if(!c.mesh){c.mesh=!0;const _=(0,C.pC)(h.aggregateStore)&&"cluster"===h.aggregateStore.type;yield h.processor.onTileMessage(d,g,_,a),(0,G.k_)(a)}h._maybeForceCleanup()}catch(_){(0,G.H9)(_)}})()}_mark(g,a,h){const d=(4294901760&this._storage.getInstanceId(g))>>>16;g&&(a.add(d),h.set(g))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"stream"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const g=this._storage.getBitset(this._markedIdsBufId),a=new Set;g.clear();for(const h of this.tileStore.tiles)for(const d of this._source.readers(h.id)){const c=d.getCursor();for(;c.next();){let f=c.getDisplayId();if(!f){const p=c.getObjectId();f=this.featureStore.lookupDisplayId(p)}this._mark(f,a,g)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(h=>{this._mark(h,a,g)}),this._updateQueue.forEach(h=>{var d;for(const c of null!=(d=h.remove)?d:[]){const f=this.featureStore.lookupDisplayId(c);this._mark(f,a,g)}}),(0,C.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(g,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(g,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,ee._)([(0,O.Cb)({constructOnly:!0})],$e.prototype,"tileStore",void 0),(0,ee._)([(0,O.Cb)()],$e.prototype,"config",void 0),(0,ee._)([(0,O.Cb)({readOnly:!0})],$e.prototype,"fieldsIndex",null),(0,ee._)([(0,O.Cb)()],$e.prototype,"processor",void 0),(0,ee._)([(0,O.Cb)({constructOnly:!0})],$e.prototype,"remoteClient",void 0),(0,ee._)([(0,O.Cb)({constructOnly:!0})],$e.prototype,"service",void 0),(0,ee._)([(0,O.Cb)()],$e.prototype,"spatialReference",null),(0,ee._)([(0,O.Cb)()],$e.prototype,"updating",null),$e=(0,ee._)([(0,H.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],$e);const Fr=$e;var Mr=T(35575),Er=T(65401),Ar=T(89621),Es=T(58098);class Ht{constructor(a,h){this.key=new Es.Z(0,0,0,0),this.bounds=(0,Er.Ue)(),this.objectIds=new Set,this.key.set(h);const d=a.getLODInfoAt(this.key);this.tileInfoView=a,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=d.resolution,this.scale=d.scale,this.level=d.level}get id(){return this.key.id}get extent(){return us.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const a=this.key.getChildKeys(),h=Mr.Z.acquire();for(let d=0;d<a.length;d++)h[d]=new Ht(this.tileInfoView,a[d]);return h}getQuantizationParameters(){return Ar.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}var wr=T(84378);const Ft={added:[],removed:[]},cs=new Set,Dr=new Es.Z(0,0,0,0);class Ur extends gt.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,gs.r)(9,(0,S.Z)("esri-csp-restrictions")?h=>({minX:h.bounds[0],minY:h.bounds[1],maxX:h.bounds[2],maxY:h.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const h={added:[],removed:[]};for(const d of a.added)if(!this.has(d)){const c=new Ht(this.tileScheme,d);this._tiles.set(d,c),this._index.insert(c),h.added.push(c)}for(const d of a.removed)if(this.has(d)){const c=this.get(d);this._tiles.delete(d),this._index.remove(c),h.removed.push(c)}this.tiles.length=0,this._tiles.forEach(d=>this.tiles.push(d)),(h.added.length||h.removed.length)&&this.emit("update",h)}setViewState(a){const h=this.tileScheme.getTileCoverage(a,0);if(!h)return;const{spans:d,lodInfo:c}=h,{level:f}=c;if(d.length>0)for(const{row:p,colFrom:_,colTo:y}of d)for(let m=_;m<=y;m++){const x=Dr.set(f,p,c.normalizeCol(m),c.getWorldForColumn(m)).id;if(cs.add(x),!this.has(x)){const b=new Ht(this.tileScheme,x);this._tiles.set(x,b),this._index.insert(b),this.tiles.push(b),Ft.added.push(b)}}for(let p=this.tiles.length-1;p>=0;p--){const _=this.tiles[p];cs.has(_.id)||(this._tiles.delete(_.id),this.tiles.splice(p,1),this._index.remove(_),Ft.removed.push(_))}(Ft.added.length||Ft.removed.length)&&this.emit("update",Ft),wr.Z.pool.release(h),cs.clear(),Ft.added.length=0,Ft.removed.length=0}}var Rr=T(9598);let Mt=class extends j.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,Z.YP)(()=>this.updating,g=>{this.remoteClient.invoke("setUpdating",g).catch(a=>{})}))}destroy(){var g,a;this.stop(),null==(g=this.controller)||g.destroy(),null==(a=this.processor)||a.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){var g,a,h;this._paused=!0,Array.isArray(null==(g=this.service)?void 0:g.source)&&(this.service.source.forEach(d=>d.close()),this.service.source.length=0),null==(a=this.tileStore)||a.updateTiles({added:[],removed:this.tileStore.tiles.map(d=>d.id)}),null==(h=this.tileStore)||h.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:g,config:a,tileInfo:h,tiles:d}){var c=this;return(0,U.Z)(function*(){var f,p,_;if(c._paused=!0,Array.isArray(null==(f=c.service)?void 0:f.source)&&(c.service.source.forEach(y=>y.close()),c.service.source.length=0),c.service=g,!c.tileStore||!(0,ue.fS)(c.tileStore.tileScheme.spatialReference,h.spatialReference)){const y=new Rr.Z($.Z.fromJSON(h));d.added.length=d.removed.length=0,null==(p=c.tileStore)||p.updateTiles({added:[],removed:c.tileStore.tiles.map(m=>m.id)}),null==(_=c.tileStore)||_.destroy(),c.tileStore=new Ur(y),c._pendingTileUpdates.length=0}for(yield c._createProcessorAndController(a),yield c.update({config:a}),c.controller.resume(),c.tileStore.clear(),c.tileStore.updateTiles(d),c._paused=!1;c._pendingTileUpdates.length;)c.tileStore.updateTiles(c._pendingTileUpdates.pop())})()}updateTiles(g){var a=this;return(0,U.Z)(function*(){var h;a._paused?a._pendingTileUpdates.push(g):null==(h=a.tileStore)||h.updateTiles(g)})()}update({config:g}){var a=this;return(0,U.Z)(function*(){const h=ne.empty();return yield Promise.all([a.processor.update(h,g),a.controller.update(h,g)]),h.toJSON()})()}applyUpdate(g){var a=this;return(0,U.Z)(function*(){return a.controller.applyUpdate(ne.create(g))})()}_createProcessorAndController(g){var a=this;return(0,U.Z)(function*(){yield Promise.all([a._handleControllerConfig(g),a._handleProcessorConfig(g)]),a.controller.processor=a.processor})()}_handleControllerConfig(g){var a=this;return(0,U.Z)(function*(){return a._createController(a.service,g)})()}_handleProcessorConfig(g){var a=this;return(0,U.Z)(function*(){return a._createProcessor(a.service,g)})()}_createController(g,a){var h=this;return(0,U.Z)(function*(){h.controller&&h.controller.destroy();const{tileStore:d,remoteClient:c}=h,f=new Fr({service:g,tileStore:d,remoteClient:c});return h.controller=f,f})()}_createProcessor(g,a){var h=this;return(0,U.Z)(function*(){const d=a.schema.processors[0].type,c=(yield function V(g){return"heatmap"===g?Promise.all([T.e(8592),T.e(7434)]).then(T.bind(T,67434)):Promise.all([T.e(2815),T.e(3678),T.e(8592),T.e(8460)]).then(T.bind(T,28460))}(d)).default,{remoteClient:f,tileStore:p}=h,_=new c({service:g,config:a,tileStore:p,remoteClient:f});return h.processor&&h.processor.destroy(),h.processor=_,_})()}};(0,ee._)([(0,O.Cb)()],Mt.prototype,"controller",void 0),(0,ee._)([(0,O.Cb)()],Mt.prototype,"processor",void 0),(0,ee._)([(0,O.Cb)()],Mt.prototype,"updating",null),(0,ee._)([(0,O.Cb)()],Mt.prototype,"viewState",void 0),Mt=(0,ee._)([(0,H.j)("esri.views.2d.layers.features.Pipeline")],Mt);const Pr=Mt},16669:(Ce,pe,T)=>{T.d(pe,{J:()=>H});var U=T(15861),ee=T(8314),j=T(62208),S=T(84682),Z=T(46679),O=T(63290);const P=Promise.resolve().then(T.bind(T,22445));class H{constructor($,V){this._canCacheExpressionValue=!1,this._sourceInfo=$,this._storage=V,this._bitsets={computed:V.getBitset(V.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema($,V){var he=this;return(0,U.Z)(function*(){const C=(0,S.Hg)(he._schema,V);if(he._schema=V,!V||(0,j.Wi)(C)||!(0,S.uD)(C,"attributes"))return;(0,ee.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",C),he._bitsets.computed.clear(),$.targets[V.name]=!0;const G=V.attributes,A=[],v=[];for(const I in G){const F=G[I];switch(F.type){case"field":break;case"expression":A.push(he._createArcadeComputedField(F));break;case"label-expression":A.push(he._createLabelArcadeComputedField(F));break;case"statistic":v.push(F)}}he._computedFields=yield Promise.all(A),he._canCacheExpressionValue=!he._computedFields.some(I=>"expression"===I.type&&(0,j.pC)(I.expression)&&I.expression.referencesScale()),he._statisticFields=v})()}setComputedAttributes($,V,he,C){const G=this._bitsets.computed;if(!this._canCacheExpressionValue||!G.has(he)){G.set(he);for(const A of this._computedFields){const v=this._evaluateField(V,A,C);switch(A.resultType){case"numeric":$.setComputedNumericAtIndex(he,A.fieldIndex,v);break;case"string":$.setComputedStringAtIndex(he,A.fieldIndex,v)}}}}_createArcadeComputedField($){var V=this;return(0,U.Z)(function*(){const he=V._sourceInfo.spatialReference,C=V._sourceInfo.fieldsIndex;return Ee(Ie({},$),{expression:yield(0,Z.Yi)($.valueExpression,he,C)})})()}_createLabelArcadeComputedField($){var V=this;return(0,U.Z)(function*(){const he=V._sourceInfo.spatialReference,C=V._sourceInfo.fieldsIndex,{createLabelFunction:G}=yield P,A=yield G($.label,C,he);return Ee(Ie({},$),{builder:A})})()}_evaluateField($,V,he){switch(V.type){case"label-expression":{const C=$.readArcadeFeature();return V.builder.evaluate(C)||""}case"expression":{const{expression:C}=V;return function K(ue,$,V){if((0,j.Wi)(ue))return null;const he=$.readArcadeFeature();try{return ue.evaluate(Ee(Ie({},V),{$feature:he}))}catch(C){return O.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",C),null}}(C,$,{$view:{scale:he}})}}}}},25208:(Ce,pe,T)=>{var ie,de,me;T.d(pe,{s:()=>k}),T(29132);var ee=T(91365),j=T(29050),S=T(8314),Z=T(62208),O=T(77044),K=T(82054),P=T(88071),H=T(42797),ue=T(91179);let $=0;const V=null!=(ie=(0,S.Z)("featurelayer-simplify-thresholds"))?ie:[.5,.5,.5,.5],he=V[0],C=V[1],G=V[2],A=V[3],v=null!=(de=(0,S.Z)("featurelayer-simplify-payload-size-factors"))?de:[1,2,4],I=v[0],F=v[1],R=v[2],B=null!=(me=(0,S.Z)("featurelayer-simplify-mobile-factor"))?me:2,W=(0,S.Z)("esri-mobile");class k{constructor(D,Y){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this._datetimeMetadata=null,this.contextTimeReference=null,this.instance=D,this._layerSchema=Y}static createInstance(){return $++,$=$>65535?0:$,$}get isEmpty(){return(0,Z.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(D){this._level=D}getAreaSimplificationThreshold(D,Y){let ae=1;const E=W?B:1;Y>4e6?ae=R*E:Y>1e6?ae=F*E:Y>5e5?ae=I*E:Y>1e5&&(ae=E);let z=0;D>4e3?z=A*ae:D>2e3?z=G*ae:D>100?z=C:D>15&&(z=he);let X=8;return this._level<4?X=1:this._level<5?X=2:this._level<6&&(X=4),z*X}createQuantizedExtrudedQuad(D,Y){return new P.Z([5],[D-1,Y,1,-1,1,1,-1,1,-1,-1])}setArcadeSpatialReference(D){this._arcadeSpatialReference=D}attachStorage(D){this._storage=D}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(D){return this.getComputedNumericAtIndex(0)}setComputedNumeric(D,Y){return this.setComputedNumericAtIndex(Y,0)}getComputedString(D){return this.getComputedStringAtIndex(0)}setComputedString(D,Y){return this.setComputedStringAtIndex(0,Y)}getComputedNumericAtIndex(D){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),D)}setComputedNumericAtIndex(D,Y){this._storage.setComputedNumericAtIndex(this.getDisplayId(),D,Y)}getComputedStringAtIndex(D){return this._storage.getComputedStringAtIndex(this.getDisplayId(),D)}setComputedStringAtIndex(D,Y){return this._storage.setComputedStringAtIndex(this.getDisplayId(),D,Y)}transform(D,Y,ae,E){const z=this.copy();return z._tx+=D,z._ty+=Y,z._sx*=ae,z._sy*=E,z}readAttribute(D,Y=!1){const ae=this._readAttribute(D,Y);if(void 0!==ae)return ae;for(const E of this._joined){E.setIndex(this.getIndex());const z=E._readAttribute(D,Y);if(void 0!==z)return z}}readAttributes(){const D=this._readAttributes();for(const Y of this._joined){Y.setIndex(this.getIndex());const ae=Y._readAttributes();for(const E of Object.keys(ae))D[E]=ae[E]}return D}joinAttributes(D){this._joined.push(D)}readArcadeFeature(){return this}geometry(){const D=this.readHydratedGeometry(),Y=(0,K.di)(D,this.geometryType,this.hasZ,this.hasM),ae=(0,ue.im)(Y);return ae&&(ae.spatialReference=this._arcadeSpatialReference),ae}get dateTimeReferenceFieldIndex(){return this._datetimeMetadata||(this._datetimeMetadata=j.nu.create(this._layerSchema.fields,this._layerSchema)),this._datetimeMetadata}autocastArcadeDate(D,Y){var ae,E;return Y&&Y instanceof Date?this.isUnknownDateTimeField(D)?ee.iG.unknownDateJSToArcadeDate(Y):ee.iG.dateJSAndZoneToArcadeDate(Y,null!=(E=null==(ae=this.contextTimeReference)?void 0:ae.timeZone)?E:"system"):Y}isUnknownDateTimeField(D){var Y;return"unknown"===(null==(Y=this.dateTimeReferenceFieldIndex)?void 0:Y.fieldTimeZone(D))}fieldSourceTimeZone(D){var Y,ae;return null!=(ae=null==(Y=this.dateTimeReferenceFieldIndex)?void 0:Y.fieldTimeZone(D))?ae:""}get layerPreferredTimeZone(){var D,Y;return null!=(Y=null==(D=this.dateTimeReferenceFieldIndex)?void 0:D.layerPreferredTimeZone)?Y:""}field(D){if(this.hasField(D))return this.autocastArcadeDate(D,this.readAttribute(D,!0));for(const Y of this._joined)if(Y.setIndex(this.getIndex()),Y.hasField(D)){const ae=Y._readAttribute(D,!0);return this.autocastArcadeDate(D,ae)}throw new Error(`Field ${D} does not exist`)}setField(D,Y){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(D=!1){if(!D)return JSON.stringify(this.readLegacyFeature());const Y=this.readLegacyFeature();if(!Y)return JSON.stringify(null);const ae={geometry:Y.geometry,attributes:Ie({},Y.attributes?Y.attributes:{})};for(const E in ae.attributes){const z=ae.attributes[E];z instanceof Date&&(ae.attributes[E]=z.getTime())}return JSON.stringify(ae)}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(D=null){var Y,ae;return{attributes:this._readAttributes(),geometry:!0===(null==D?void 0:D.keepGeometryType)?this.geometry():null!=(ae=null==(Y=this.geometry())?void 0:Y.toJSON())?ae:null}}castAsJsonAsync(D=null,Y=null){return Promise.resolve(this.castAsJson(Y))}removeIds(D){if((0,Z.Wi)(this._objectIdToIndex)){const ae=new Map,E=this.getCursor();for(;E.next();){const z=(0,Z.s3)(E.getObjectId());ae.set(z,E.getIndex())}this._objectIdToIndex=ae}const Y=this._objectIdToIndex;for(const ae of D)Y.has(ae)&&this.removeAtIndex(Y.get(ae))}removeAtIndex(D){(0,Z.Wi)(this._deleted)&&(this._deleted=H.p.create(this.getSize())),this._deleted.set(D)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const D=this.getCursor();for(;D.next();)yield D.readOptimizedFeature()}_getExists(){return(0,Z.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const D=this.readUnquantizedGeometry();if(!D||D.hasIndeterminateRingOrder)return null;const Y=(0,Z.Pt)(this.getQuantizationTransform(),null);return(0,O.Y)(new P.Z,D,this.hasM,this.hasZ,Y)}copyInto(D){D.seen=this.seen,D._storage=this._storage,D._arcadeSpatialReference=this._arcadeSpatialReference,D._joined=this._joined,D._tx=this._tx,D._ty=this._ty,D._sx=this._sx,D._sy=this._sy,D._deleted=this._deleted,D._objectIdToIndex=this._objectIdToIndex}}},52397:(Ce,pe,T)=>{T.d(pe,{t:()=>ee});var U=T(25208);class ee extends U.s{static from(S,Z){return new ee(S.copy(),Z)}constructor(S,Z){super(U.s.createInstance(),S.fullSchema()),this._currentIndex=-1,this._reader=S,this._indices=Z}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const S=new ee(this._reader.copy(),this._indices);return S._currentIndex=this._currentIndex,S}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(S){this._reader.setArcadeSpatialReference(S)}attachStorage(S){this._reader.attachStorage(S)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(S){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(S,Z){return this._reader.setComputedNumericAtIndex(Z,0)}getComputedString(S){return this._reader.getComputedStringAtIndex(0)}setComputedString(S,Z){return this._reader.setComputedStringAtIndex(0,Z)}getComputedNumericAtIndex(S){return this._reader.getComputedNumericAtIndex(S)}setComputedNumericAtIndex(S,Z){this._reader.setComputedNumericAtIndex(S,Z)}getComputedStringAtIndex(S){return this._reader.getComputedStringAtIndex(S)}setComputedStringAtIndex(S,Z){return this._reader.setComputedStringAtIndex(S,Z)}transform(S,Z,O,K){const P=this.copy();return P._reader=this._reader.transform(S,Z,O,K),P}readAttribute(S,Z=!1){return this._reader.readAttribute(S,Z)}readAttributes(){return this._reader.readAttributes()}joinAttributes(S){return this._reader.joinAttributes(S)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(S){return this.readAttribute(S,!0)}hasField(S){return this._reader.hasField(S)}setField(S,Z){return this._reader.setField(S,Z)}keys(){return this._reader.keys()}castToText(S=!1){return this._reader.castToText(S)}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(S){return this._reader.setDisplayId(S)}getGroupId(){return this._reader.getGroupId()}setGroupId(S){return this._reader.setGroupId(S)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(S){return this._reader.setIndex(S)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(S,Z){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(Ce,pe,T)=>{T.d(pe,{p:()=>U});class U{static fromBuffer(j,S){return new U(j,S)}static create(j,S=4294967295){const Z=new Uint32Array(Math.ceil(j/32));return new U(Z,S)}constructor(j,S){this._mask=0,this._buf=j,this._mask=S}_getIndex(j){return Math.floor(j/32)}has(j){const S=this._mask&j;return!!(this._buf[this._getIndex(S)]&1<<S%32)}hasRange(j,S){let Z=j,O=S;for(;Z%32&&Z!==O;){if(this.has(Z))return!0;Z++}for(;O%32&&Z!==O;){if(this.has(Z))return!0;O--}if(Z===O)return!1;for(let K=Z/32;K!==O/32;K++)if(this._buf[K])return!0;return!1}set(j){const S=this._mask&j,Z=this._getIndex(S);this._buf[Z]|=1<<S%32}setRange(j,S){let Z=j,O=S;for(;Z%32&&Z!==O;)this.set(Z++);for(;O%32&&Z!==O;)this.set(O--);if(Z!==O)for(let K=Z/32;K!==O/32;K++)this._buf[K]=4294967295}unset(j){const S=this._mask&j,Z=this._getIndex(S);this._buf[Z]&=4294967295^1<<S%32}resize(j){const S=this._buf,Z=new Uint32Array(Math.ceil(j/32));Z.set(S),this._buf=Z}or(j){for(let S=0;S<this._buf.length;S++)this._buf[S]|=j._buf[S];return this}and(j){for(let S=0;S<this._buf.length;S++)this._buf[S]&=j._buf[S];return this}xor(j){for(let S=0;S<this._buf.length;S++)this._buf[S]^=j._buf[S];return this}ior(j){for(let S=0;S<this._buf.length;S++)this._buf[S]|=~j._buf[S];return this}iand(j){for(let S=0;S<this._buf.length;S++)this._buf[S]&=~j._buf[S];return this}ixor(j){for(let S=0;S<this._buf.length;S++)this._buf[S]^=~j._buf[S];return this}any(){for(let j=0;j<this._buf.length;j++)if(this._buf[j])return!0;return!1}copy(j){for(let S=0;S<this._buf.length;S++)this._buf[S]=j._buf[S];return this}clone(){return new U(this._buf.slice(),this._mask)}clear(){for(let j=0;j<this._buf.length;j++)this._buf[j]=0}forEachSet(j){for(let S=0;S<this._buf.length;S++){let Z=this._buf[S],O=32*S;if(Z)for(;Z;)1&Z&&j(O),Z>>>=1,O++}}countSet(){let j=0;return this.forEachSet(S=>{j++}),j}}},71251:(Ce,pe,T)=>{T.d(pe,{e:()=>O});var U=T(62208),ee=T(10699),j=T(35133),S=T(50618);class Z{constructor(P,H){this.item=P,this.controller=H,this.promise=null}}class O{constructor(P){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,P.concurrency&&(this.concurrency=P.concurrency),this._queue=new j.Z(P.peeker),this.process=P.process;const H=P.scheduler;P.priority&&(0,U.pC)(H)&&(this._task=H.registerTask(P.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(P){const H=this._controllers.get(P);H&&H.abort()}clear(){this._queue.clear();const P=[];this._controllers.forEach(H=>P.push(H)),this._controllers.clear(),P.forEach(H=>H.abort()),this._processingItems.clear(),this._cancelNext()}forEach(P){this._deferreds.forEach((H,ue)=>P(ue))}get(P){const H=this._deferreds.get(P);return H?H.promise:void 0}isOngoing(P){return this._processingItems.has(P)}has(P){return this._deferreds.has(P)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(P,H){const ue=this.get(P);if(ue)return ue;const $=new AbortController;let V=null;H&&(V=(0,ee.fu)(H,()=>$.abort()));const C=()=>{G.remove(),(0,U.pC)(V)&&V.remove(),this._deferreds.delete(P),this._controllers.delete(P),this._queue.remove(P),this._processingItems.delete(P),this._scheduleNext()},G=(0,ee.$F)($.signal,()=>{const v=this._processingItems.get(P);v&&v.controller.abort(),C(),A.reject((0,ee.zE)())}),A=(0,ee.dD)();return this._deferreds.set(P,A),this._controllers.set(P,$),A.promise.then(C,C),this._queue.push(P),this._scheduleNext(),A.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const P=[];this._processingItems.forEach(H=>P.push(H)),this._processingItems.clear();for(const H of P)this._queue.push(H.item),H.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const P=[];for(;this._queue.length;)P.push(this._queue.pop());return this.clear(),P}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(P){for(;!P.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),P.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,S.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(P,H){this._canProcessFulfillment(P)&&(this._scheduleNext(),this._deferreds.get(P.item).resolve(H))}_processError(P,H){this._canProcessFulfillment(P)&&(this._scheduleNext(),this._deferreds.get(P.item).reject(H))}_canProcessFulfillment(P){return!!this._deferreds.get(P.item)&&this._processingItems.get(P.item)===P}_process(P){if((0,U.Wi)(P))return;let H;const ue=new AbortController,$=new Z(P,ue);this._processingItems.set(P,$);try{H=this.process(P,ue.signal)}catch(V){this._processError($,V)}(0,ee.y8)(H)?($.promise=H,H.then(V=>this._processResult($,V),V=>this._processError($,V))):this._processResult($,H)}get test(){return{update:P=>this.runTask(P)}}}}}]);
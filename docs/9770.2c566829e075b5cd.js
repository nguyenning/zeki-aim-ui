"use strict";var Bs=Object.defineProperty,Vs=Object.defineProperties,Gs=Object.getOwnPropertyDescriptors,zt=Object.getOwnPropertySymbols,Ws=Object.prototype.hasOwnProperty,zs=Object.prototype.propertyIsEnumerable,Kt=(se,D,l)=>D in se?Bs(se,D,{enumerable:!0,configurable:!0,writable:!0,value:l}):se[D]=l,Ne=(se,D)=>{for(var l in D||(D={}))Ws.call(D,l)&&Kt(se,l,D[l]);if(zt)for(var l of zt(D))zs.call(D,l)&&Kt(se,l,D[l]);return se},Te=(se,D)=>Vs(se,Gs(D));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[9770],{128:(se,D,l)=>{l.d(D,{B:()=>ie});var N=l(15861),m=l(22558),C=l(21726),ce=l(35948),te=l(34117),pe=l(31283),_e=l(77712),q=l(61556),j=l(29840);function ie(v){var O;const M=null!=(O=null==v?void 0:v.origins)?O:[void 0];return(B,I)=>{const P=function o(v,M,O){var B;if("resource"===(null==v?void 0:v.type))return function ne(v,M,O){const B=(0,te.Oe)(M,O);return{type:String,read:(I,P,W)=>{const R=(0,j.r)(I,P,W);return B.type===String?R:"function"==typeof B.type?new B.type({url:R}):void 0},write:{writer(I,P,W,R){if(!R||!R.resources)return"string"==typeof I?void(P[W]=(0,j.t)(I,R)):void(P[W]=I.write({},R));const g=function ge(v){return null==v?null:"string"==typeof v?v:v.url}(I),b=(0,j.t)(g,Te(Ne({},R),{verifyItemRelativeUrls:R&&R.verifyItemRelativeUrls?{writtenUrls:R.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0}),j.M.NO),E=B.type!==String&&(!(0,m.l)(this)||R&&R.origin&&this.originIdOf(O)>(0,pe.M9)(R.origin)),Q={object:this,propertyName:O,value:I,targetUrl:b,dest:P,targetPropertyName:W,context:R,params:v};R&&R.portalItem&&b&&!(0,C.YP)(b)?E?function T(v){var ee;const{context:M,targetUrl:O,params:B,value:I,dest:P,targetPropertyName:W}=v;if(!M.portalItem)return;const R=M.portalItem.resourceFromPath(O),g=G(I,O,M),b=(0,q.B)(g),E=(0,C.Ml)(R.path),Q=null!=(ee=null==B?void 0:B.compress)&&ee;b===E?(M.resources&&x(Te(Ne({},v),{resource:R,content:g,compress:Q,updates:M.resources.toUpdate})),P[W]=O):V(v)}(Q):function U({context:v,targetUrl:M,dest:O,targetPropertyName:B}){v.portalItem&&v.resources&&(v.resources.toKeep.push({resource:v.portalItem.resourceFromPath(M),compress:!1}),O[B]=M)}(Q):R&&R.portalItem&&(null==b||null!=(0,j.i)(b)||(0,C.jc)(b)||E)?V(Q):P[W]=b}}}}(v,M,O);switch(null!=(B=null==v?void 0:v.type)?B:"other"){case"other":return{read:!0,write:!0};case"url":{const{read:I,write:P}=j.a;return{read:I,write:P}}}}(v,B,I);for(const W of M){const R=(0,_e.CJ)(B,W,I);for(const g in P)R[g]=P[g]}}}function V(v){var Ce,Ie,xe;const{targetUrl:M,params:O,value:B,context:I,dest:P,targetPropertyName:W}=v;if(!I.portalItem)return;const R=(0,j.p)(M),g=null!=(Ce=null==R?void 0:R.filename)?Ce:(0,ce.D)(),b=null!=(Ie=null==O?void 0:O.prefix)?Ie:null==R?void 0:R.prefix,E=G(B,M,I),Q=(0,C.v_)(b,g),ee=`${Q}.${(0,q.B)(E)}`,fe=I.portalItem.resourceFromPath(ee);(0,C.jc)(M)&&I.resources&&I.resources.pendingOperations.push(function f(v){return Y.apply(this,arguments)}(M).then(Le=>{fe.path=`${Q}.${(0,q.B)(Le)}`,P[W]=fe.itemRelativeUrl}).catch(()=>{}));const oe=null!=(xe=null==O?void 0:O.compress)&&xe;I.resources&&x(Te(Ne({},v),{resource:fe,content:E,compress:oe,updates:I.resources.toAdd})),P[W]=fe.itemRelativeUrl}function x({object:v,propertyName:M,updates:O,resource:B,content:I,compress:P}){O.push({resource:B,content:I,compress:P,finish:W=>{!function F(v,M,O){"string"==typeof v[M]?v[M]=O.url:v[M].url=O.url}(v,M,W)}})}function G(v,M,O){return"string"==typeof v?{url:M}:new Blob([JSON.stringify(v.toJSON(O))],{type:"application/json"})}function Y(){return(Y=(0,N.Z)(function*(v){const M=(yield Promise.resolve().then(l.bind(l,84792))).default,{data:O}=yield M(v,{responseType:"blob"});return O})).apply(this,arguments)}},22558:(se,D,l)=>{function N(m){return m&&"getAtOrigin"in m&&"originOf"in m}l.d(D,{l:()=>N})},10439:(se,D,l)=>{l.d(D,{Z:()=>U});var V,N=l(17626),C=(l(29132),l(86810)),ce=l(58817),te=l(14889),pe=l(77712),q=(l(90912),l(76898)),j=l(99433),ie=l(128),o=l(55915),ne=l(37118);let T=V=class extends C.wq{constructor(x){super(x),this.geometry=null,this.type="clip"}writeGeometry(x,G,f,Y){if(Y.layer&&Y.layer.spatialReference&&!Y.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,o.Up)(x.spatialReference,Y.layer.spatialReference))return void(Y&&Y.messages&&Y.messages.push(new te.Z("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:Y.layer.spatialReference,context:Y})));const ge=new ne.Z;(0,o.Wt)(x,ge,Y.layer.spatialReference),G[f]=ge.toJSON(Y)}else G[f]=x.toJSON(Y);delete G[f].spatialReference}clone(){return new V({geometry:(0,ce.d9)(this.geometry),type:this.type})}};(0,N._)([(0,pe.Cb)({type:ne.Z}),(0,ie.B)()],T.prototype,"geometry",void 0),(0,N._)([(0,j.c)(["web-scene","portal-item"],"geometry")],T.prototype,"writeGeometry",null),(0,N._)([(0,pe.Cb)({type:["clip","mask","replace"],nonNullable:!0}),(0,ie.B)()],T.prototype,"type",void 0),T=V=(0,N._)([(0,q.j)("esri.layers.support.SceneModification")],T);const U=T},17926:(se,D,l)=>{var N,m,C;l.d(D,{B:()=>m,P:()=>N}),(C=N||(N={}))[C.None=0]="None",C[C.Int16=1]="Int16",C[C.Int32=2]="Int32",function(C){C[C.Replace=0]="Replace",C[C.Outside=1]="Outside",C[C.Inside=2]="Inside",C[C.Finished=3]="Finished"}(m||(m={}))},61556:(se,D,l)=>{l.d(D,{B:()=>m});var N=l(21726);function m(j){return te[function C(j){return j instanceof Blob?j.type:function ce(j){const ie=(0,N.Ml)(j);return q[ie]||pe}(j.url)}(j)]||_e}const te={},pe="text/plain",_e=te[pe],q={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const j in q)te[q[j]]=j},89770:(se,D,l)=>{l.d(D,{N:()=>bs});var N=l(15861),m=l(17626),C=l(91558),ce=l(88879),te=l(85931),pe=l(27306),_e=l(46160),q=l(8314),j=l(63290),ie=l(88159),o=l(62208),ne=l(77029),V=l(10699),T=l(32917),U=l(50618),x=l(55713),G=l(16730),f=l(77712),ge=(l(90912),l(76898)),F=l(30217),v=l(49966),M=l(28347),O=l(43703),B=l(78451),I=l(84161),P=l(28093),W=l(993),R=l(4794),g=l(55915),b=l(5548),E=l(65401),Q=l(5437),ee=l(66607),fe=l(36630),oe=l(10439),Ce=l(81808),Ie=l(46679),xe=l(39368),Le=l(29505),De=(l(20383),l(14517)),Qe=l(72392),Ge=l(84682),ke=l(38114),me=l(8333),Ee=l(67873),ye=l(2694),He=l(61885);class ht extends He.Z{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const r=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:r})}}get length(){return this._map.size}get(r){return this._map.get(r)}addMany(r){if(0===r.length)return;const e=new Set;for(let s=0;s<r.length;s++){const i=r[s],n=i.objectId,d=this._map.get(n);d?(e.add(n),i!==d&&(r[s]=d),d.refCount||(d.refCount=0),++d.refCount):(i.refCount=1,this._map.set(n,i))}const t=e.size>0?r.filter(s=>!e.has(s.objectId)):r;t.length>0&&this.emit("change",{added:t,removed:[]})}removeMany(r){const e=[];for(const t of r){const s=t.objectId,i=this._map.get(s);null!=i&&(!i.refCount||--i.refCount<=0)&&(this._map.delete(s),e.push(t))}e.length>0&&this.emit("change",{added:[],removed:e})}removeManyByObjectId(r){const e=[];for(const t of r){const s=this._map.get(t);null!=s&&(!s.refCount||--s.refCount<=0)&&(this._map.delete(t),e.push(s))}e.length>0&&this.emit("change",{added:[],removed:e})}toArray(){return[...this._map.values()]}find(r){let e;return(0,ie.oE)(this._map,t=>!!r(t)&&(e=t,!0)),e}forEach(r){this._map.forEach(e=>r(e))}}class w extends He.Z{constructor(r){super(),this._limit=r,this._all=new ht,this._active=new qe(this),this._pending=new Map,this._handle=this._all.on("change",e=>this._handleChanges(e))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(r){return this._active.find(r)}forEach(r){this._active.forEach(r)}addMany(r){this._all.addMany(r)}removeManyByObjectId(r){this._all.removeManyByObjectId(r)}_handleChanges(r){let e=r.removed;if(this._pending.size>0){e=new Array;for(const n of r.removed)this._pending.delete(n.objectId)||e.push(n)}let t=this._limit-this._active.length+e.length;t<r.added.length&&(this._active.removeMany(e),e=[],Oe.reset(1-this._limit/(this._active.length+r.added.length)),this._active.forEach(n=>{Oe.sample()&&(e.push(n),this._pending.set(n.objectId,n))}),t=this._limit-this._active.length+e.length);let s=r.added;if(t<r.added.length){s=new Array,Oe.reset(t/r.added.length);for(const n of r.added)Oe.sample()?s.push(n):this._pending.set(n.objectId,n)}const i=t-s.length;i>0&&this._pending.size>0&&(Oe.reset(i/this._pending.size),this._pending.forEach(n=>{Oe.sample()&&(s.push(n),this._pending.delete(n.objectId))})),this._active.addAndRemove(s,e)}}const Oe=new class We{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(r){this._percentage=r,this._last=-1}sample(){const r=Math.floor(this._index*this._percentage);return++this._index,r!==this._last&&(this._last=r,!0)}};class qe{constructor(r){this._parent=r,this._map=new Map}get length(){return this._map.size}forEach(r){this._map.forEach(e=>r(e))}find(r){let e;return(0,ie.oE)(this._map,t=>!!r(t)&&(e=t,!0)),e}toArray(){return[...this._map.values()]}addAndRemove(r,e){for(const t of r)this._map.set(t.objectId,t);for(const t of e)this._map.delete(t.objectId);(r.length>0||e.length>0)&&this._parent.emit("change",{added:r,removed:e})}removeMany(r){for(const e of r)this._map.delete(e.objectId);r.length>0&&this._parent.emit("change",{added:[],removed:r})}}var et=l(23147),tt=l(69852);let be=class extends De.Z{get updating(){var a,r;return null!=(r=null==(a=this._graphicsCore)?void 0:a.updating)&&r}constructor(a){super(a),this.loadedGraphics=new w(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new tt.Z},this._handles=new Qe.Z,this._graphicsByNode=new Map}initialize(){const a=this.view.basemapTerrain;this._graphicsCore=new me.w({owner:this,layer:this.layer,preferredUpdatePolicy:et.j.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:r=>this.view.deconflictor.addGraphicsOwner(r),labeler:(r,e)=>this.view.labeler.addGraphicsOwner(r,e,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(r,e)=>new Ee.Z({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:e,graphicsCore:r,basemapTerrain:a,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then(()=>this._graphicsCore.startCreateGraphics()).catch(()=>{}),this._handles.add((0,T.YP)(()=>this.layer.labelingInfo,(r,e)=>{(0,Ge.Hg)(r,e)&&this._graphicsCore.updateLabelingInfo()}))}destroy(){this._handles=(0,o.SC)(this._handles),this._graphicsCore=(0,o.SC)(this._graphicsCore),this.loadedGraphics=(0,o.SC)(this.loadedGraphics),this.view=null}addNodeMeta(a,r){let e=0;const t=a.filteredIds,s=this.view.spatialReference,i=a.featureIds.map((n,d)=>{(0,ye.YF)(d,this.collection,a.objectHandle,ue);const u=(0,ke.Tx)(0,0,0,s);this.view.renderCoordsHelper.fromRenderCoords(ue,u);const h=r(d,a);let c=!1;return(0,o.Wi)(t)?c=!0:e<t.length&&n===t[e]&&(c=!0,e++),{objectId:n,uid:ce.Z.generateUID(),attributes:h,visible:c,geometry:u}});this.loadedGraphics.addMany(i),this._graphicsByNode.set(a.node.index,i)}updateLabelPositions(a){const r=this._graphicsByNode.get(a.node.index);if(!r)return;let e=0;const t=this.view.spatialReference,s=this.view.renderCoordsHelper;for(let i=0;i<a.featureIds.length;i++){const n=r[e];if(a.featureIds[i]===n.objectId){e++;const d=this._graphicsCore.getGraphics3DGraphicById(n.uid);if((0,o.Wi)(d))continue;(0,ye.YF)(i,this.collection,a.objectHandle,ue),this.view.renderCoordsHelper.fromRenderCoords(ue,ue,t),d.alignWithAbsoluteElevation(ue[2],s,!1),(0,o.pC)(n.geometry)&&"point"===n.geometry.type&&(n.geometry.z=ue[2])}}}setNodeMetaAttributes(a,r){const e=this._graphicsByNode.get(a.node.index);if(!e)return;const t=new Array(e.length);for(let s=0;s<e.length;s++){const i=e[s];i.attributes=r(s,a),t[s]=i.uid}this._graphicsCore.updateLabelingInfo(t)}applyFilterChange(a){const r=this._graphicsByNode.get(a.node.index);if(r)if((0,o.Wi)(a.filteredIds))for(const e of r)e.visible||(e.visible=!0,ve.graphic=e,ve.property="visible",ve.oldValue=!1,ve.newValue=!0,this._graphicsCore.graphicUpdateHandler(ve));else{let e=0;for(const t of r){const s=t.visible;e<a.filteredIds.length&&t.objectId===a.filteredIds[e]?(t.visible=!0,e++):t.visible=!1,s!==t.visible&&(ve.graphic=t,ve.property="visible",ve.oldValue=s,ve.newValue=t.visible,this._graphicsCore.graphicUpdateHandler(ve))}}}removeNodeMeta(a){this.loadedGraphics.removeManyByObjectId(a.featureIds)}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};(0,m._)([(0,f.Cb)()],be.prototype,"view",void 0),(0,m._)([(0,f.Cb)()],be.prototype,"layer",void 0),(0,m._)([(0,f.Cb)()],be.prototype,"collection",void 0),(0,m._)([(0,f.Cb)()],be.prototype,"loadedGraphics",void 0),(0,m._)([(0,f.Cb)()],be.prototype,"updating",null),(0,m._)([(0,f.Cb)()],be.prototype,"slicePlaneEnabled",void 0),(0,m._)([(0,f.Cb)()],be.prototype,"_graphicsCore",void 0),be=(0,m._)([(0,ge.j)("esri.views.3d.layers.I3SMeshViewLabeler")],be);const ve={graphic:null,property:null,oldValue:null,newValue:null},ue=(0,P.c)(),Pe=be;var Zt=l(42930),je=l(17926);class Yt extends Zt.q{constructor(r){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer]},r,{hasInitialize:!0})}setModifications(r,e,t,s){const i={context:r,modifications:Mt(e,t,s),isGeodetic:s.isGeographic};this.broadcast(i,"setModifications")}setLegacySchema(r,e){const t=JSON.stringify(e);this.broadcast({context:r,jsonSchema:t},"setLegacySchema")}destroyContext(r){return this.broadcast(r,"destroyContext")}}const _=new ne.Z({deallocator:null}),Be=[0,0,0];function Mt(a,r,e){_.clear();let t=1/0,s=1/0,i=-1/0,n=-1/0,d=!1;for(const h of r){const c="clip"===h.type?je.B.Inside:"mask"===h.type?je.B.Outside:je.B.Replace,p=(0,o.s3)(h.geometry,"modification.geometry");let y=A=>A;if(p.spatialReference){if(!(0,g.Up)(p.spatialReference,e)){j.Z.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}y=A=>((0,g.SH)(A,p.spatialReference,Be,e),Be)}else p.hasZ||(Be[2]=0,y=A=>(Be[0]=A[0],Be[1]=A[1],Be));d=d||c===je.B.Outside,_.push(c),_.push(p.rings.length);for(const A of p.rings){_.push(A.length);for(const z of A){const K=y(z);_.push(K[0]),_.push(K[1]),_.push(K[2]),t=Math.min(t,K[0]),s=Math.min(s,K[1]),i=Math.max(i,K[0]),n=Math.max(n,K[1])}}}(0,o.pC)(a)&&(d?(_.push(je.B.Inside),_.push(2),_.push(4),_.push(t-1e-4),_.push(s-1e-4),_.push(0),_.push(i+1e-4),_.push(s-1e-4),_.push(0),_.push(i+1e-4),_.push(n+1e-4),_.push(0),_.push(t-1e-4),_.push(n+1e-4),_.push(0),_.push(4),_.push(a[0]),_.push(a[1]),_.push(0),_.push(a[2]),_.push(a[1]),_.push(0),_.push(a[2]),_.push(a[3]),_.push(0),_.push(a[0]),_.push(a[3]),_.push(0)):(_.push(je.B.Outside),_.push(1),_.push(4),_.push(a[0]),_.push(a[1]),_.push(0),_.push(a[2]),_.push(a[1]),_.push(0),_.push(a[2]),_.push(a[3]),_.push(0),_.push(a[0]),_.push(a[3]),_.push(0))),_.push(je.B.Finished);const u=new Float64Array(_.length);for(let h=0;h<_.length;++h)u[h]=_.getItemAt(h);return u}var k=l(52836),st=l(30375),Ot=l(67225),$t=l(2364),Re=l(81937);class Jt{constructor(){this.ids=new Set,this.paused=!1}}class Xt{constructor({collection:r,forAllFeatures:e,forAllFeaturesOfNode:t}){this._highlights=[],this._collection=r,this._forAllFeatures=e,this._forAllFeaturesOfNode=t}destroy(){this._highlights.forEach(r=>this._releaseSet(r)),this._highlights=null}acquireSet(){const r=new Jt;return this._highlights.push(r),{set:r,handle:{remove:()=>{this._highlights&&(this._releaseSet(r),(0,te.e$)(this._highlights,r))},pause:()=>{this._releaseSet(r),r.paused=!0},resume:()=>{r.paused=!1,this._initializeSet(r)}}}}setFeatureIds(r,e){e.forEach(t=>r.ids.add(t)),this._initializeSet(r)}_initializeSet(r){this._forAllFeatures((e,t,s)=>(r.ids.has(e)&&this._collection.addComponentHighlight(s.objectHandle,t),k.K.CONTINUE))}_releaseSet(r){this._forAllFeatures((e,t,s)=>(r.ids.has(e)&&this._collection.removeComponentHighlight(s.objectHandle,t),k.K.CONTINUE))}objectCreated(r){this._highlights.forEach(e=>{e.paused||this._forAllFeaturesOfNode(r,(t,s)=>(e.ids.has(t)&&this._collection.addComponentHighlight(r.objectHandle,s),k.K.CONTINUE))})}objectDeleted(r){this._collection.clearHighlights(r.objectHandle)}}var Qt=l(51541),kt=l(87091);let it=class extends De.Z{constructor(a,r,e){super({}),this._updateExtent=r,this._updateNode=e,this.running=!1,this._extentSet=new Qt.D,this._nodeSet=new Set,this.addHandles(a.registerTask(kt.T8.ELEVATION_ALIGNMENT,this))}normalizeCtorArgs(){return{}}addExtent(a){this._extentSet.add(a),this.running=!0}schedule(a){this._nodeSet.add(a),this.running=!0}remove(a){this._nodeSet.delete(a),this._updateRunning()}runTask(a){const r=this._extentSet;for(a.run(()=>r.merge(a));!r.empty&&!a.done;){const t=this._updateExtent(r.pop());(0,o.pC)(t)&&t.forAll(s=>this.schedule(s)),a.madeProgress()}if(a.done)return;const e=this._nodeSet;for(const t of e)if(e.delete(t),this._updateNode(t),a.madeProgress(),a.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}};(0,m._)([(0,f.Cb)()],it.prototype,"running",void 0),it=(0,m._)([(0,ge.j)("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater.ts")],it);var rt=l(73683);class es{constructor(r){this._view=r,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}get updating(){return this._numFadingNodes>0}stopNodeFading(r){null!=r.lodCrossfadeProgress&&(this._numFadingNodes--,r.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=(0,o.hw)(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(r,e,t){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=(0,U.A)({preRender:s=>this._updateAllNodeFading(s)}),this._view.notifyLODUpdate()),null==r.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),r.lodCrossfadeSignedDuration=t,r.lodCrossfadeProgress=e}_updateAllNodeFading(r){const e=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((t,s)=>{if((0,o.pC)(s)&&(0,o.pC)(s.lodCrossfadeProgress)){const i=s.lodCrossfadeSignedDuration,n=i>0?this._view.fullOpacity:0,u=s.lodCrossfadeProgress+Math.abs(r.deltaTime/i),h=!e||u>=1||0===i,c=n-(h?0:i>0?1:-1)*(1-u);h?(this.stopNodeFading(s),i<0&&this._view.markNodeToRemove(t)):s.lodCrossfadeProgress=u,this._view.setNodeOpacityByIndex(t,c)}}),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode((r,e)=>{if((0,o.pC)(e)&&(0,o.pC)(e.lodCrossfadeProgress)){this.stopNodeFading(e);const t=e.lodCrossfadeSignedDuration;t<0&&this._view.markNodeToRemove(r),this._view.setNodeOpacityByIndex(r,t>0?this._view.fullOpacity:0)}}),this._view.removeMarkedNodes()}fadeNode(r,e,t,s){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const i=this._view,n=i.nodeCrossfadingEnabled,d=t===rt.B.FadeIn?i.fullOpacity:0,u=n?s?t===rt.B.FadeIn?i.lodCrossfadeinDuration:i.lodCrossfadeoutDuration:i.lodCrossfadeUncoveredDuration:0,h=this._view.getNodeOpacityByIndex(r);if(n&&h!==d&&u>0){const c=1-Math.abs(d-h);this._startNodeFading(e,c,function ts(a){return a===rt.B.FadeIn?1:-1}(t)*u)}else this.stopNodeFading(e),this._view.setNodeOpacityByIndex(r,d),t===rt.B.FadeOut&&this._view.removeNode(r)}isNodeFullyFadedIn(r){const e=this._view.getNodeCrossfadeMetaData(r);return(0,o.Wi)(e)||null==e.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(r)===this._view.fullOpacity}}var St=l(62483),ct=l(67857);const Ue=(0,E.cS)(),ze=(0,O.c)(),ae=(0,P.c)(),ut=(0,P.c)(),pt=(0,P.c)();let Fe=class extends(He.Z.EventedMixin(De.Z)){get spatialReference(){var a,r;return null==(r=null==(a=this.view)?void 0:a.elevationProvider)?void 0:r.spatialReference}constructor(a){super(a),this._tmpEvent={spatialReference:null,extent:Ue,context:"scene"}}initialize(){this.view=this.layerView.view,this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersector=(0,St.Z8)(this.view.state.viewingMode),this._intersector.options.store=ct.eC.MIN;const a=this.layerView.i3slayer.fullExtent;(0,o.Wi)(a)?j.Z.getLogger(this.declaredClass).error("I3SElevationProvider expected fullExtent on I3SLayer."):(this._zmin=a.zmin,this._zmax=a.zmax),this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}getElevation(a,r,e,t){if(ae[0]=a,ae[1]=r,ae[2]=e,!this._renderCoordsHelper.toRenderCoords(ae,t,ae))return j.Z.getLogger(this.declaredClass).error("could not project point to compute elevation"),null;const s=this.layerView.elevationOffset,i=this._zmin+s;return this._renderCoordsHelper.setAltitude(ut,this._zmax+s,ae),this._renderCoordsHelper.setAltitude(pt,i,ae),this._intersector.reset(ut,pt,null),this.intersectionHandler.intersect(this._intersector,null,ut,pt),this._intersector.results.min.getIntersectionPoint(ae)?this._renderCoordsHelper.getAltitude(ae):null}layerChanged(){this.spatialReference&&(this._tmpEvent.extent=this._computeLayerExtent(),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(a){this.spatialReference&&(this._tmpEvent.extent=this._computeObjectExtent(a),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(a){return(0,E.cS)(Ue),this._expandExtent(a,Ue),Ue}_computeLayerExtent(){(0,E.cS)(Ue);for(const a of this.layerView.getVisibleNodes())this._expandExtent(a,Ue);return Ue}_expandExtent(a,r){const e=this.spatialReference;if((0,o.Wi)(e))return;const t=this.layerView.getNodeComponentObb(a);if(!(0,o.Wi)(t)){(0,M.F)(ze,t.quaternion),ze[12]=t.center[0],ze[13]=t.center[1],ze[14]=t.center[2];for(let s=0;s<8;++s)ae[0]=1&s?t.halfSize[0]:-t.halfSize[0],ae[1]=2&s?t.halfSize[1]:-t.halfSize[1],ae[2]=4&s?t.halfSize[2]:-t.halfSize[2],(0,I.m)(ae,ae,ze),this._renderCoordsHelper.fromRenderCoords(ae,ae,e),(0,E.jn)(r,ae,r)}}};(0,m._)([(0,f.Cb)({constructOnly:!0})],Fe.prototype,"layerView",void 0),(0,m._)([(0,f.Cb)({constructOnly:!0})],Fe.prototype,"intersectionHandler",void 0),(0,m._)([(0,f.Cb)()],Fe.prototype,"view",void 0),(0,m._)([(0,f.Cb)()],Fe.prototype,"spatialReference",null),Fe=(0,m._)([(0,ge.j)("esri.views.3d.layers.i3s.I3SElevationProvider")],Fe);const ss=Fe;var is=l(59617),L=l(42964),rs=l(77926),Ke=l(93394),ns=l(40841);class os{constructor(r){this.type=ct.q7.I3S,this._needVerticalOffset=!1,this.layerUid=r.layerUid,this.sublayerUid=r.sublayerUid,this._collection=r.collection,this._traverseNodeHierarchy=r.traverseNodeHierarchy,this.slicePlaneEnabled=r.slicePlaneEnabled,this.isGround=r.isGround}updateElevationAlignState(r,e){this._needVerticalOffset=r&&e===is.JY.Global}intersect(r,e,t,s){const i=r.results,n=r.options.store===ct.eC.ALL,d=r.ray.direction,u=r.tolerance;let h=y=>y,c=y=>y;const p=(0,ns.iO)((0,o.pC)(r.verticalOffset)?r.verticalOffset:this._needVerticalOffset?0:null);(0,o.pC)(r.verticalOffset)&&(0,o.pC)(p)&&(h=y=>p.applyToMbs(y),c=y=>p.applyToObb(y)),this._traverseNodeHierarchy((y,A)=>{if(0===y.childrenLoaded)return!1;const z=(0,o.pC)(y.serviceObbInRenderSR)&&(0,L.vH)(y.serviceObbInRenderSR)?y.serviceObbInRenderSR:null;return!((0,o.pC)(z)&&!(0,Ke.fn)(c(z),t,d,u)||(A&&((0,o.pC)(z)||!(0,L.c$)(y.renderMbs)||function as(a,r,e,t=0){const s=a[3]+t,i=r[0]-a[0],n=r[1]-a[1],d=r[2]-a[2],u=e[0],h=e[1],c=e[2],p=u*i+h*n+c*d;return p*p-(u*u+h*h+c*c)*(i*i+n*n+d*d-s*s)>=0}(h(y.renderMbs),t,d,u))&&((0,o.Wi)(y.geometryObb)||(0,Ke.fn)(c(y.geometryObb),t,d,u))&&this._collection.intersect(A,t,s,u,p,(K,$,de,J)=>{if($>=0){if(null!=e&&!e(t,s,$))return;const Z=S=>{const X=new rs.f9(this.layerUid,this.sublayerUid,y.index,K,J);S.set(this.type,X,$,de)};if(this.isGround&&(null==i.ground.dist||$<i.ground.dist)&&Z(i.ground),r.options.isFiltered)return;if((null==i.min.dist||$<i.min.dist)&&Z(i.min),(null==i.max.dist||$>i.max.dist)&&Z(i.max),n){const S=(0,St.LP)(r.ray);Z(S),r.results.all.push(S)}}}),0))})}}var Ze=l(42767),gt=l(52565),ls=l(86152),ft=l(5590),ds=l(26584);class cs{constructor(r,e,t=14){this._version=t,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=pe.Y8.GIGABYTES,this.quotaReductionFactor=.2,this._dbName=r,this._storeName=e}init(){return Promise.resolve().then(()=>{const r=indexedDB.open(this._dbName,this._version);return r.onupgradeneeded=e=>{const t=r.result,s=r.transaction,i=t.objectStoreNames.contains(this._storeName)?s.objectStore(this._storeName):t.createObjectStore(this._storeName),n=t.objectStoreNames.contains("last_access")?s.objectStore("last_access"):t.createObjectStore("last_access");n.indexNames.contains("date")||n.createIndex("date","date",{unique:!1}),n.indexNames.contains("byteSize")||n.createIndex("byteSize","byteSize",{unique:!1}),e.oldVersion<this._version&&(i.clear(),n.clear())},Ve(r)}).then(r=>{this._destroyed?r.close():this._db=r})}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(r,e){return null==this._db?Promise.reject(new ds.Z("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then(()=>this._put(r,e)).catch(t=>{if(t&&"QuotaExceededError"===t.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then(s=>this._removeLeastRecentlyAccessed(e.byteSize+Math.ceil(s*this.quotaReductionFactor))),this._quotaReductionPromise.then(()=>this._quotaReductionPromise=null,()=>this._quotaReductionPromise=null)),this._quotaReductionPromise.then(()=>this._put(r,e));throw t}).then(()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then(t=>this._removeLeastRecentlyAccessed(t-this.maxByteSize)))})}get(r,e){const t=this._db;if(null==t)return Promise.resolve(void 0);let s=null;return Promise.resolve().then(()=>{const i=t.transaction(this._storeName,"readonly");return s=(0,V.fu)(e,()=>{i.abort()}),Ve(i.objectStore(this._storeName).get(r))}).then(i=>(null==i?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:i.byteSize},r)),(0,o.pC)(s)&&s.remove(),i)).catch(()=>{++this._miss,(0,V.k_)(e),(0,o.pC)(s)&&s.remove()})}remove(r){var e=this;const t=this._db;return null==t?Promise.resolve():Promise.resolve().then((0,N.Z)(function*(){const s=t.transaction([e._storeName,"last_access"],"readwrite"),i=s.objectStore(e._storeName),n=s.objectStore("last_access"),d=i.delete(r),u=n.delete(r);yield Promise.all([Ve(d),Ve(u),nt(s)])}))}_put(r,e){const t=this._db;if(null==t)return Promise.resolve();const s=t.transaction([this._storeName,"last_access"],"readwrite"),i=s.objectStore(this._storeName),n=s.objectStore("last_access"),d=i.put(e,r),u=n.put({date:Date.now(),byteSize:e.byteSize},r);return Promise.all([Ve(d),Ve(u),nt(s)])}_removeLeastRecentlyAccessed(r){if(r<=0||!this._db)return Promise.resolve();const e=this._db.transaction([this._storeName,"last_access"],"readwrite"),t=e.objectStore(this._storeName),s=e.objectStore("last_access");let i=0;const n=s.index("date").openCursor(null,"next");return n.onsuccess=()=>{const d=n.result;null!=d&&(null!=d.value.byteSize&&(i+=d.value.byteSize),t.delete(d.primaryKey),s.delete(d.primaryKey),i<r&&d.continue())},nt(e)}_getCacheSize(){const r=this._db;if(null==r)return Promise.resolve(0);const e=r.transaction("last_access"),t=e.objectStore("last_access");let s=0;const i=t.index("byteSize").openKeyCursor();return i.onsuccess=()=>{const n=i.result;if(!n)return;const d=n.key;null!=d&&(s+=d),n.continue()},nt(e).then(()=>s)}}function nt(a){return new Promise((r,e)=>{a.oncomplete=()=>r(),a.onerror=()=>e(a.error),a.onabort=()=>e(a.error)})}function Ve(a){return new Promise((r,e)=>{"done"===a.readyState?null!=a.error?e(a.error):r(a.result):(a.onsuccess=()=>r(a.result),a.onerror=()=>e(a.error))})}class us{constructor(){this._data=new Map,this._miss=0,this._hit=0,this.initialized=!0}init(){return Promise.resolve()}get(r,e){var t=this;return(0,N.Z)(function*(){var s;if(t._data.has(r))return t._hit++,null!=(s=t._data.get(r))?s:void 0;t._miss++})()}destroy(){}put(r,e){return this._data.set(r,e),Promise.resolve()}remove(r){return this._data.delete(r),Promise.resolve()}getHitRate(){return this._hit/(this._hit+this._miss)}}var mt=l(97445),_t=l(9044),Ye=l(93605),xt=l(55745),ps=l(41632),gs=l(4511),yt=l(24225),fs=l(27355),ot=l(36603),Pt=l(13756),Rt=l(6040),at=l(17803);const At="esri.views.3d.layers.I3SMeshView3D",Se=j.Z.getLogger(At),Nt=[1,1,1,1];class ms extends class qt{constructor(){this.lodCrossfadeSignedDuration=0}}{constructor(r,e,t,s,i,n,d){super(),this.node=r,this.featureIds=e,this.objectHandle=t,this.cachedRendererVersion=s,this.attributeInfo=i,this.material=n,this.textures=d,this.cachedMidsTerrainSR=null,this.cachedEdgeMaterials=new Array,this.edgeMemoryUsage=0,this.cachedSymbology=null}}var we,a;(a=we||(we={}))[a.CastShadows=4]="CastShadows",a[a.Pickable=5]="Pickable";const ys=100*pe.Y8.MEGABYTES,bs=a=>{let r=class extends a{constructor(...e){super(e),this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._snappingSourcesTrackers=[],this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._currentRenderer=null,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._visibleGeometryChangedSchedulerHandle=null,this._idbCache=(0,q.Z)("enable-feature:idb-mock-cache")?new us:new cs("esri-scenelayer-cache","geometries"),this._hasComponentData=!1,this._hasVertexColors=!1,this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this._layerUrl="",this._cacheKeySuffix=null,this._elevationTask=null,this._filters=[],this._arcade=null,this._tmpAttributeOnlyGraphic=new ce.Z(null,null,{}),this._crossfadeHelper=new es(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerUid(){return this.i3slayer&&this.i3slayer.uid}get sublayerUid(){return null}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get updatingProgressValue(){var e,t;return null!=(t=null==(e=this._controller)?void 0:e.updatingProgress)?t:0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return(0,L.a7)(this._currentRenderer)?this._usePBR||this._hasLoadedPBRTextures?Re.v.AllTexturesPBR:Re.v.AllTextures:this._usePBR||this._hasLoadedPBRTextures?Re.v.GeometryTexturesPBR:Re.v.GeometryTextures}get elevationOffset(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){const t=(0,G._R)(this.i3slayer.spatialReference),s=(0,Le.Z7)(e.unit);return(0,o.Pt)(e.offset,0)*s/t}return 0}get elevationInfo(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null==e)return{mode:le.Absolute,offset:0};const t=(0,G._R)(this.i3slayer.spatialReference),s=(0,Le.Z7)(e.unit),i=(0,o.Pt)(e.offset,0)*s/t;switch(e.mode){case"absolute-height":return{mode:le.Absolute,offset:i};case"relative-to-ground":return{mode:le.RelativeToGround,offset:i};case"on-the-ground":return{mode:le.OnTheGround,offset:0};default:return{mode:le.Absolute,offset:0}}}get supportedTextureEncodings(){return(0,Ze.K0)(this.view._stage.renderView.capabilities)}get uncompressedTextureDownsamplingEnabled(){var s;return(null==(s=this.view)?void 0:s.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled)&&0==(this.supportedTextureEncodings&Re.j.DDS_S3TC)}initialize(){var h;this._preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const e=this.view.resourceController;this.i3sOverrides=new ls.v({view:this.view,layer:this.i3slayer,memoryController:e.memoryController}),this._worker=new Yt(c=>e.immediate.schedule(c)),this.addResolvingPromise(this._worker.promise);const s=this.i3slayer.store;this._worker.setLegacySchema(this.uid,s.defaultGeometrySchema),(0,L.p8)(this.i3slayer),(0,L.gn)(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new ee.Z({layerView:this}),this._gpuMemoryEstimate=0,this._texMemoryEstimate=0,this._geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this.resetHighlights();const i=s.defaultGeometrySchema;if(this._isIntegratedMesh||!i)this._hasComponentData=!1;else{const c=i.featureAttributes;this._hasComponentData=!!(c&&c.faceRange&&c.id)}this._hasVertexColors=null!=(null!=(h=null==i?void 0:i.vertexAttributes.color)?h:null)&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color),this._isIntegratedMesh||(this._edgeView=this._stage.renderer.ensureEdgeView());const n=this.view.resourceController.memoryController.newCache(this.uid,c=>this._deleteComponentObject(c));this._memCache=n,this._intersectionHandler=new os({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:c=>(0,o.pC)(this._controller.index)&&(0,o.pC)(this._controller.index.rootNode)?this._controller.index.traverse(this._controller.index.rootNode,p=>{const y=p.index,A=this._nodeId2Meta.get(y)||this._nodeId2MetaReloading.get(y);return c(p,(0,o.pC)(A)?A.objectHandle:null)}):()=>{}}),this.updatingHandles.add(()=>this.layerUid,c=>this._intersectionHandler.layerUid=c),this.updatingHandles.add(()=>this.sublayerUid,c=>this._intersectionHandler.sublayerUid=c),this._elevationProvider=new ss({layerView:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR,this.updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),T.nn),this.updatingHandles.add(()=>this.fullOpacity,c=>this._opacityChange(c)),this.updatingHandles.add(()=>this.slicePlaneEnabled,c=>this._slicePlaneEnabledChange(c)),this.updatingHandles.add(()=>this.elevationOffset,(c,p)=>{this._reloadAll(p),this._controller.invalidateVisibilityObbs()}),this.updatingHandles.add(()=>this.elevationInfo,(c,p)=>this._elevationInfoChanged(c,p),T.nn),this.updatingHandles.add(()=>!this.suspended&&this.elevationInfo.mode!==le.Absolute,(c,p)=>{c?this.handles.add(this.view.basemapTerrain.on("elevation-change",({extent:y})=>this._ensureElevationTask().addExtent(y)),Ht):p&&this.handles.remove(Ht)},T.nn),this.updatingHandles.add(()=>this._usePBR,c=>this._updatePBR(c));const u=()=>{this._reloadAll(),this.clearMemCache()};this.updatingHandles.add(()=>this.rendererTextureUsage,u),this.updatingHandles.add(()=>this.uncompressedTextureDownsamplingEnabled,u),this.updatingHandles.add(()=>this.suspended,c=>this._suspendedChange(c),T.nn),this.updatingHandles.add(()=>this.i3slayer.labelsVisible,()=>this._labelingChanged(),T.nn),this.updatingHandles.add(()=>this.i3slayer.labelingInfo,()=>this._labelingChanged(),T.nn),this.updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),T.nn),this.handles.add([(0,T.YP)(()=>Ye.Z.I3S_TREE_SHOW_TILES,c=>{if(c&&!this._treeDebugger){const p=this._controller.crsIndex;Promise.all([l.e(8592),l.e(3109)]).then(l.bind(l,3109)).then(({I3STreeDebugger:y})=>{!this._treeDebugger&&Ye.Z.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new y({lv:this,view:this.view,nodeSR:p}))})}else c||Ye.Z.I3S_TREE_SHOW_TILES||(this._treeDebugger=(0,o.SC)(this._treeDebugger))},T.nn),(0,T.YP)(()=>Ye.Z.I3S_SHOW_MODIFICATIONS,()=>this._showModifications(),T.nn)]),this._cacheKeySuffix=(0,L.ei)(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch(c=>Se.warn(`Failed to initialize IndexedDB cache: ${c}`))}destroy(){this._clearAddTasks(),this._elevationTask=(0,o.SC)(this._elevationTask),this.i3sOverrides=(0,o.SC)(this.i3sOverrides),this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const e=this._worker;e&&(e.destroyContext(this.uid).then(()=>e.destroy()),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=(0,o.SC)(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=(0,o.SC)(this._labeler),this._treeDebugger=(0,o.SC)(this._treeDebugger),this._controller=(0,o.SC)(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_memEstimateTextureAdded(e){const t=e.estimatedTexMemRequired;return this._gpuMemoryEstimate+=t,this._texMemoryEstimate+=t,t}_memEstimateTextureRemoved(e){if((0,o.pC)(e)){const t=e.estimatedTexMemRequired;this._gpuMemoryEstimate-=t,this._texMemoryEstimate-=t}}_memEstimateGeometryAdded(e){const t=this._collection.getObjectGPUMemoryUsage(e);return this._gpuMemoryEstimate+=t,this._geoMemoryEstimate+=t,t}_memEstimateGeometryRemoved(e){const t=this._collection.getObjectGPUMemoryUsage(e);this._gpuMemoryEstimate-=t,this._geoMemoryEstimate-=t}isNodeLoaded(e){return this._nodeId2Meta.has(e)}isNodeReloading(e){return this._nodeId2MetaReloading.has(e)}getUsedMemory(){let e=(0,o.pC)(this._labeler)?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach(t=>e+=(0,o.pC)(t)?t.node.memory:0),this._nodeId2MetaReloading.forEach(t=>e+=(0,o.pC)(t)?t.node.memory:0),e}getUnloadedMemory(){return((0,o.pC)(this._controller)?this._controller.unloadedMemoryEstimate:0)+((0,o.pC)(this._labeler)?this._labeler.unloadedMemoryEstimate:0)}ignoresMemoryFactor(){return!1}_labelingChanged(){if(!(0,$t.C)(this.i3slayer)||!this._supportsLabeling)return void((0,o.pC)(this._labeler)&&(this._labeler.destroy(),this._labeler=null));if((0,o.pC)(this._labeler))return;const e=new Pe({view:this.view,layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach(t=>(0,o.pC)(t)&&this._addMetaToLabeler(e,t)),this._labeler=e}_loadAsyncModule(e){return++this._asyncModuleLoading,e.then(t=>(--this._asyncModuleLoading,t),t=>{throw--this._asyncModuleLoading,t})}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=(0,st.initialize)().then(()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()}),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const e=this.uid,t=this.i3slayer.spatialReference;this._worker.setModifications(e,this._layerClippingArea,this._modifications,t);const s=Mt(this._layerClippingArea,this._modifications,t);(0,st.setModificationsSync)({context:e,modifications:s,isGeodetic:t.isGeographic}),this._controller.modificationsChanged();const i=this.hasModifications?new ne.Z:null;this._nodeId2Meta.forEach((n,d)=>{(0,o.Wi)(n)?(this._nodeId2Meta.delete(d),this._controller.updateLoadStatus(d,!1)):n.node.hasModifications?(this._nodeId2Meta.delete(d),this._nodeId2MetaReloading.set(d,n)):(0,o.pC)(i)&&i.push(n.node)}),(0,o.pC)(i)&&this._nodeId2MetaReloading.forEach(n=>i.push(n.node)),(0,o.pC)(i)&&i.length>0&&(this.updateNodeModificationStatus(i),i.forAll(n=>{if(n.imModificationImpact!==gt.O4.Culled){const d=this._nodeId2Meta.get(n.index);this._controller.invalidateGeometryVisibility(n.index),(0,o.pC)(d)?(this._nodeId2Meta.delete(n.index),this._nodeId2MetaReloading.set(n.index,d)):this._nodeId2Meta.has(n.index)&&(this._nodeId2Meta.delete(n.index),this._controller.updateLoadStatus(n.index,!1))}})),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if((0,o.pC)(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!Ye.Z.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(const s of this._modifications){const i=s.geometry;i.spatialReference=this.i3slayer.spatialReference;const n=Te(Ne({},t),{color:e[s.type]});this._modificationGraphics.push(new ce.Z({geometry:i,symbol:n}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(e,t){e.addNodeMeta(t,(s,i)=>this._createAttributes(s,i))}_suspendedChange(e){e?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(e){const t=this._nodeId2Meta.get(e);if((0,o.pC)(t)&&(0,o.pC)(t.attributeInfo))return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodeId2Meta.get(e);if((0,o.pC)(t)&&(0,o.pC)(t.attributeInfo))return t.attributeInfo.attributeData}setAttributeData(e,t){const s=this._nodeId2Meta.get(e);(0,o.pC)(s)&&(0,o.pC)(s.attributeInfo)&&(s.attributeInfo.attributeData=t,this._attributeValuesChanged(s))}updateAttributes(e,t,s){var i=this;return(0,N.Z)(function*(){const n=i._nodeId2Meta.get(e);(0,o.pC)(n)&&(yield i.i3sOverrides.apply(n.featureIds,t,s),n.attributeInfo=t,i._controller.reschedule(()=>i._attributeValuesChanged(n),s).catch(d=>{(0,V.D_)(d)||Se.warn("Error while updating attribute values. Layer might not display correctly.",d)}))})()}_attributeValuesChanged(e){e.cachedRendererVersion=this._getInvalidRendererVersion(),e.filteredIds=null,(0,o.pC)(this._labeler)&&this._labeler.setNodeMetaAttributes(e,(t,s)=>this._createAttributes(t,s)),this._updateEngineObject(e)}clearMemCache(){(0,o.pC)(this._memCache)&&this._memCache.clear()}getVisibleNodes(){const e=new Array;return this._nodeId2Meta.forEach(t=>(0,o.pC)(t)&&e.push(t.node)),e}getNodeComponentObb(e){var s;const t=null!=(s=this._nodeId2Meta.get(e.index))?s:this._nodeId2MetaReloading.get(e.index);return(0,o.pC)(t)?this._collection.getComponentObb(t.objectHandle):null}getLoadedNodeIndices(e){this._nodeId2Meta.forEach((t,s)=>e.push(s)),this._nodeId2MetaReloading.forEach((t,s)=>e.push(s))}_preLoadBasis(){!(0,q.Z)("disable-feature:i3s-basis")&&0!=(this.supportedTextureEncodings&Re.j.Basis)&&(0,o.yw)(this.i3slayer.textureSetDefinitions,e=>e.some(t=>t.formats.some(s=>"basis"===s.format||"ktx2"===s.format)))&&(0,Pt.$8)()}_getVertexBufferLayout(e,t){const s={hasTexture:Ut(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return(0,gs.K)((0,fs.N)(this._getGeometryParameters(s)))}_getObjectIdField(){return this.i3slayer.objectIdField||Q.d}_findGraphicNodeAndIndex(e){const t=(0,mt.g)(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField());let s=null;return(0,ie.oE)(this._nodeId2Meta,i=>{if((0,o.Wi)(i))return!1;const n=i.featureIds.indexOf(t);return-1!==n&&(s={node:i.node,index:n},!0)}),s}_getGraphicIndices(e,t){const s=this._nodeId2Meta.get(e.index);if((0,o.Wi)(s))return[];const i=[],n=this._getObjectIdField(),d=this.i3slayer.fieldsIndex;for(const u of t){const h=(0,mt.g)(d,u.attributes,n),c=s.featureIds.indexOf(h);-1!==c&&i.push(c)}return i}whenGraphicBounds(e){const t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();const s=this._getAABB(t.node.index,t.index);return(0,o.Wi)(s)?Promise.reject():Promise.resolve({boundingBox:s,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(e){return null==e.nodeIndex||null==e.componentIndex?null:this._getAABB(e.nodeIndex,e.componentIndex)}_getAABB(e,t){const s=this._nodeId2Meta.get(e);if((0,o.Wi)(s)||null==s.featureIds||t>=s.featureIds.length)return null;const n=(0,ye.z6)(t,this._collection,s.objectHandle,(0,Rt.bg)(24));if(!(0,g.CM)(n,this.view.renderSpatialReference,0,n,this.view.spatialReference,0,8))return null;const h=(0,b.cS)();return(0,b.G1)(h,n,0,8),h}whenGraphicAttributes(e,t){return(0,L.bf)(this.i3slayer,e,this._getObjectIdField(),t,()=>[...this._nodeId2Meta.values()].filter(o.pC))}getGraphicFromIntersectorTarget(e){if(null==e.nodeIndex||null==e.componentIndex)return null;const t=this._nodeId2Meta.get(e.nodeIndex);return(0,o.Wi)(t)||null==t.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)}_getCacheKey(e){return`${this._layerUrl}/v19/${e.id}${this._cacheKeySuffix}`}_getMemCacheKey(e,t=this.elevationOffset){return e+"#"+t}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(e){return(0,o.pC)(this._memCache)?this._memCache.pop(this._getMemCacheKey(e.index)):null}deleteCachedGPUData(e){(0,o.pC)(e)&&this._deleteComponentObject(e)}_cacheGPUData(e,t=this.elevationOffset){if((0,o.Wi)(this._memCache))return void this._deleteComponentObject(e);const s=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,s)}loadMissingTextures(e,t,s,i){var d;const n=null!=(d=null==e?void 0:e.filter((u,h)=>{if(0==(u.usage&this.rendererTextureUsage))return!1;if((0,o.Wi)(t))return!0;const c=(0,Ze.nn)(u.encodings,this.supportedTextureEncodings),p=t[h];return!!((0,o.Wi)(p)||null==p.data||c&&p.encoding!==c.encoding)}))?d:[];return 0===n.length?Promise.resolve(!1):s(n,i).then(u=>{let h=0;for(let c=0;c<e.length;c++)h<u.length&&u[h].id===e[c].id&&(t[c]=u[h],h++);return!0})}loadCachedNodeData(e,t,s){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e),t).then(i=>null==i?null:i.nodeVersion!==e.version?(this._idbCache.remove(this._getCacheKey(e)),null):(this.elevationInfo.mode===le.Absolute&&(e.geometryObb=i.geometryObb),this.loadMissingTextures(i.requiredTextures,i.textureData,s,t).then(n=>(n&&this._idbCache.initialized&&(0,o.pC)(i.textureData)&&(i.byteSize=wt(i.transformedGeometry,i.textureData),i.textureData.every(Ft)&&Lt(e,i)&&this._idbCache.put(this._getCacheKey(e),i).catch(d=>Se.warn(`Failed to update node with textures in IndexedDB cache: ${e.id}: ${d}`))),(0,V.k_)(t),i)))):Promise.resolve(null)}addNode(e,t,s){return function Es(a){return"geometryData"in a}(t)?null==t.geometryBuffer?(this._addNodeMeta(e.index,null),Promise.resolve()):this._addData(e,t.attributeDataInfo,()=>this._transformNode(e,t,s).then(i=>this._safeReschedule(()=>{if((0,o.Wi)(i))return e.hasModifications=!1,this._addCachedNodeData(e,null,s);e.hasModifications=i.transformedGeometry.hasModifications;const{obb:n,componentOffsets:d,featureIds:u,transformedGeometry:h}=i,y=(0,ft.c)(e.mbs,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference),A=(0,Ke.Ue)([n.center.x,n.center.y,n.center.z],[n.extents.x,n.extents.y,n.extents.z],(0,B.f)(n.orientation.x,n.orientation.y,n.orientation.z,n.orientation.w));(0,I.m)(A.center,A.center,y),this.elevationInfo.mode===le.Absolute&&(e.geometryObb=A),t.geometryData.componentOffsets=d,u&&(t.geometryData.featureIds=Array.from(u));const z={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:h,globalTrafo:y,geometryObb:A,byteSize:wt(h,t.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&Lt(e,z)){const K=(0,o.pC)(z.textureData)?z.textureData.map($=>Ft($)?$:null):null;this._idbCache.put(this._getCacheKey(e),Te(Ne({},z),{textureData:K})).catch($=>Se.warn(`Failed to store node in IndexedDB cache: ${e.id}: ${$}`))}return this._addCachedNodeData(e,z,s)},s))):Promise.reject()}computeVisibilityObb(e){return(0,L.Cx)(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)}_transformNode(e,t,s){var de;const i=null!=(de=t.geometryData.geometries)?de:[],n=new Array(i.length);for(let J=0;J<i.length;++J)n[J]=this._getVertexBufferLayout(i[J],t.geometryDescriptor);const d=e.mbs,u=this.elevationOffset,h=this._controller.crsIndex,c=this._controller.crsVertex,p=this.view.renderSpatialReference,y=(0,ft.n)(d,u,h),A=(0,ft.c)(d,u,h,p),z=(0,g.YD)(h,c),K=(0,g.YD)(c,p);return(0,o.Wi)(z)||(0,o.Wi)(K)?Promise.resolve(null):this._worker.invoke({context:this.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:n,localOrigin:y,globalTrafo:A,mbs:d,obb:e.serviceObb,elevationOffset:u,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:z,vertexToRenderProjector:K},s)}get _supportsNodeCrossFading(){var e,t;return!(null!=(t=null==(e=this.view)?void 0:e._stage)&&t.renderer.shadowsEnabled)}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(e){this._setNodeOpacity(e,this.nodeCrossfadingEnabled?0:this.fullOpacity)}addCachedGPUData(e,t,s){if(this.elevationInfo.mode===le.Absolute&&(e.geometryObb=(0,Ke.d9)(this._collection.getComponentObb(t.objectHandle))),!this._controller.isGeometryVisible(e))return void this._cacheGPUData(t);(0,o.pC)(this._labeler)&&this._addMetaToLabeler(this._labeler,t);const i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,s),this._collection.setObjectVisibility(t.objectHandle,yt.Z.Visible),this._updateMaterial(t),this._setNewNodeOpacity(t),this.elevationInfo.mode!==le.Absolute&&this._ensureElevationTask().schedule(i),this._updateEngineObject(t),this._highlights.objectCreated(t),(0,o.pC)(this._treeDebugger)&&this._treeDebugger.update()}addCachedNodeData(e,t,s,i){return this._addData(e,s,()=>this._addCachedNodeData(e,t,i))}_addCachedNodeData(e,t,s){var i=this;return(0,N.Z)(function*(){var Wt;if(i.suspended||!i._controller.isGeometryVisible(e))return void i._removeNodeStageData(e.index,i.elevationOffset,i._nodeId2MetaReloading);if((0,o.Wi)(t))return void i._addNodeMeta(e.index,null);const n=i._addTasks.get(e.index),{geometryData:d,transformedGeometry:u,globalTrafo:h}=t;yield i.i3sOverrides.apply(d.featureIds,n.attributeInfo,s);const c=(0,o.pC)(t.textureData)?t.textureData.filter(re=>(0,o.pC)(re)&&0!=(re.usage&i.rendererTextureUsage)):[];!(0,q.Z)("disable-feature:i3s-basis")&&c.some(re=>(0,o.pC)(re)&&(re.encoding===Re.j.Basis||re.encoding===Re.j.KTX2))&&(yield(0,Pt.$8)()),e.memory=0;const{componentOffsets:p,geometries:y,featureIds:A}=d,z=i._collection,K=y[0],{layout:$,indices:de,interleavedVertexData:J,positionData:Z,hasColors:S}=u,X=i._materialParameters(K,$),H=p||new Uint32Array([0,de?de.length:J.byteLength/$[0].stride]),Ps={vertices:{data:J,count:J.byteLength/$[0].stride,layoutParameters:X.geometryParams},positionData:{positions:Z.data,indices:Z.indices},indices:de,componentOffsets:H},lt=K.transformation?(0,O.b)(K.transformation):(0,O.c)();(0,M.m)(lt,h,lt);const bt=(0,M.D)((0,P.c)(),lt),Rs=(0,F.f)((0,v.c)(),lt),Bt=i.view.renderSpatialReference,Vt=i.view.basemapTerrain.spatialReference,vt=(0,P.c)(),Ct=[1,1,1];(0,g.X4)(bt,Bt,Ct,Vt)||Se.errorOnce("Unsupported coordinate system for IM overlay"),(0,g.SH)(bt,Bt,vt,Vt);const dt=z.createObject({toMapSpace:(0,R.f)(vt[0],vt[1],Ct[0],Ct[1]),geometry:Ps,obb:t.geometryObb,transform:{position:bt,rotationScale:Rs}}),As=X.geometryParams.textureCoordinates===ot.N.Atlas,{textures:Gt,texturePromise:Ns}=i._initMaterialAndTextures(dt,X.material,c,As);e.memory+=i._memEstimateGeometryAdded(dt),e.memory+=Gt.reduce((re,It)=>re+((0,o.pC)(It)?i._memEstimateTextureAdded(It):0),0);const Ts=!!X.material.hasParametersFromSource,Ds="blend"!==X.material.alphaMode&&X.material.metallicRoughness.baseColorFactor[3]>=1,he=new ms(e,A,dt,i._getInvalidRendererVersion(),n.attributeInfo,{hasParametersFromSource:Ts,isOpaque:Ds},Gt);n.meta=he,!i._hasTextures&&(null==(Wt=t.requiredTextures)?void 0:Wt.some(({usage:re})=>0!=(re&Re.v.ColorTextures)))&&(i._hasTextures=!0),i._hasData=!0,i._hasColors=i._hasColors||S,i._hasTextures=i._hasTextures||!!e.resources.texture,i.notifyChange("hasTexturesOrVertexColors");const js=i.slicePlaneEnabled;return Promise.all([i._addOrUpdateEdgeRendering(he),Ns]).then(([re,It])=>((0,o.pC)(re)&&re.updateObjectVisibility(he.objectHandle,!1).catch(Xe=>Ae(Xe,i.i3slayer.title)),i._safeReschedule(()=>{const Xe=i._addTasks.get(e.index);if(!Xe)return;if(i._addNodeMeta(e.index,he),Xe.meta=null,i.suspended)return void i._removeNodeStageData(e.index,i.elevationOffset);z.setObjectVisibility(dt,yt.Z.Visible),(0,o.pC)(re)&&re.updateObjectVisibility(he.objectHandle,!0).catch(Hs=>Ae(Hs,i.i3slayer.title)),he.attributeInfo=Xe.attributeInfo;const Us=he.cachedRendererVersion!==i._rendererVersion,Fs=js!==i.slicePlaneEnabled;i._updateElevationOffsets(he);const ws=he.elevationOffsets;i._updateComponentData(he);const Ls=i._applyFiltersToNode(he);(Us||(0,o.pC)(re)&&(Fs||Ls||ws))&&i._addOrUpdateEdgeRendering(he),(0,o.pC)(i._labeler)&&i._addMetaToLabeler(i._labeler,he),i._visibleGeometryChanged(he,Me.ADD),i._highlights.objectCreated(he),i._updateMaterial(he),i._setNewNodeOpacity(he),(0,o.pC)(i._treeDebugger)&&i._treeDebugger.update()},s))).catch(re=>{throw(0,o.pC)(n.meta)&&(i._cacheGPUData(n.meta),n.meta=null),re})})()}_addNodeMeta(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){Se.error("Removing duplicated node");const s=this._nodeId2Meta.get(e);(0,o.pC)(s)&&this._deleteComponentObject(s)}else this._controller.updateLoadStatus(e,!0);(0,o.pC)(t)&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&Je(t.cachedEdgeMaterials,0)),this._nodeId2Meta.set(e,t)}_updateElevationOffsets(e){var Z;const t=this.view.renderSpatialReference,s=this.elevationInfo,i=this.view.basemapTerrain,n=i.spatialReference,d=s.mode;if((0,o.Wi)(t)||(0,o.Wi)(n)||d===le.Absolute)return void(e.elevationOffsets=null);const u=this._collection.getObjectTransform(e.objectHandle);e.elevationOffsets=null!=(Z=e.elevationOffsets)?Z:[];const h=Ss,c=xs,p=d===le.OnTheGround,y=this.view.renderCoordsHelper,z=e.featureIds.length;if(!e.cachedMidsTerrainSR){e.cachedMidsTerrainSR=(0,Rt.bg)(3*z);const S=e.cachedMidsTerrainSR;for(let X=0;X<z;X++){this._collection.getComponentAabb(e.objectHandle,X,c,!0),(0,I.s)(h,(c[0]+c[3])/2,(c[1]+c[4])/2,c[2]),(0,I.t)(h,h,u.rotationScale),(0,I.a)(h,h,u.position);const H=3*X;S[H+2]=y.getAltitude(h),(0,g.SH)(h,t,h,n),S[H+0]=h[0],S[H+1]=h[1]}}const K=e.cachedMidsTerrainSR,$=s.offset,de=e.elevationOffsets;i.getElevations(K,z,(S,X)=>{const H=p?K[3*S+2]:0;de[S]=$+((0,o.pC)(X)?X-H:0)})}_ensureElevationTask(){return(0,o.pC)(this._elevationTask)||(this._elevationTask=new it(this.view.resourceController.scheduler,e=>{const t=this._controller.updateElevationChanged(e,this.view.basemapTerrain.spatialReference);return(0,o.pC)(t)?t.filterInPlace(s=>(0,o.pC)(this._nodeId2Meta.get(s))):null},e=>{const t=this._nodeId2Meta.get(e);this._nodeElevationAlignmentChanged(t)})),this._elevationTask}_elevationInfoChanged(e,t){const s=e.mode!==le.Absolute,i=!!t&&t!==e&&t.mode!==le.Absolute;this._intersectionHandler.updateElevationAlignState(s,this.view.state.viewingMode),s&&!i&&this._controller.removeAllGeometryObbs(),this._nodeId2Meta.forEach(n=>this._nodeElevationAlignmentChanged(n))}_nodeElevationAlignmentChanged(e){(0,o.Wi)(e)||(this._updateElevationOffsets(e),this._updateComponentData(e),this._updateEdgeRendering(e),(0,o.pC)(this._labeler)&&this._labeler.updateLabelPositions(e),this._updateSnappingSources(e,Me.UPDATE))}_safeReschedule(e,t){return(0,V.k_)(t),this._controller.reschedule(e,t)}_materialParameters(e,t){const s=(0,o.pC)(e.params.material)?e.params.material:(0,Ze.dY)(),i=t.some(u=>"uvRegion"===u.name),n=t.some(u=>"normalCompressed"===u.name),d=Ut(s);return{geometryParams:this._getGeometryParameters({hasTexture:d,hasNormals:n,hasRegions:i}),material:s}}_initMaterialAndTextures(e,t,s,i){const n=this._stage.renderView,d=s.map(h=>(0,Ze.cU)(h,t,i,n));this._stage.addMany(d);let u=null;return this._collection.updateMaterial(e,h=>{u=(0,Ze.RE)(h,t,d,s,this.view._stage.renderView.textureRepository,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(h)}),{textures:d,texturePromise:u}}_getGeometryParameters(e){return{textureCoordinates:e.hasTexture?e.hasRegions?ot.N.Atlas:ot.N.Default:ot.N.None,colors:this._hasVertexColors,normals:e.hasNormals&&!this._isIntegratedMesh}}_addData(e,t,s){let i=this._addTasks.get(e.index);return i?i.attributeInfo=t:(i=Te(Ne({},(0,V.hh)()),{attributeInfo:t,meta:null}),this._addTasks.set(e.index,i),s().then(i.resolve,i.reject).then(()=>this._addTasks.delete(e.index)).catch(n=>{throw this._addTasks.delete(e.index),n})),i.promise}_clearAddTasks(){this._addTasks.forEach(e=>{(0,o.pC)(e.meta)&&(this._cacheGPUData(e.meta),e.meta=null)}),this._addTasks.clear()}_clippingAreaChanged(){const e=this.view.renderSpatialReference,t=this.i3slayer.spatialReference,s=(0,E.Ue)();this._renderClippingArea=(0,xt.G)(this.view.clippingArea,s,e)?s:null;const i=(0,E.Ue)();this._layerClippingArea=(0,xt.G)(this.view.clippingArea,i,t)?i:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const e=this.hasGeometryFilter;this._controller.geometryFilterChanged(e),this._applyFilters(e)}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(e){this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(t=>{(0,o.pC)(t)&&this._applyFiltersToNode(t)&&(this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t,Me.UPDATE))})}getFilters(){const e=[],t=this._renderClippingArea;return(0,o.pC)(t)&&e.push((s,i)=>this._boundingRectFilter(s,i,t)),e}addSqlFilter(e,t,s){if((0,o.pC)(t)){const i=t.fieldNames;e.push((n,d)=>this._sqlFilter(n,d,t,i,s))}}_sqlFilter(e,t,s,i,n){const d={},u=this._createLayerGraphic(d),h=this.i3slayer.objectIdField,c=t.featureIds,p=(0,o.pC)(t.attributeInfo)&&t.attributeInfo.attributeData;i.every(y=>y===h||p&&null!=p[y])&&(0,L.hv)(e,c,y=>{d[h]=c[y];for(const A of i)A!==h&&(d[A]=p?(0,L.Jx)(p[A],y):null);try{return s.testFeature(u)}catch(A){return n(A),!1}})}_boundingRectNodeTest(e,t){return(0,g.st)(e.node.mbs,this._controller.crsIndex,jt,this.view.renderSpatialReference),(0,L.cr)(t,jt)}_boundingRectFeatureTest(e,t,s){return this._collection.getComponentAabb(e.objectHandle,t,Tt),(0,b.y8)(Tt,Dt),(0,E.kK)(s,Dt)}_boundingRectFilter(e,t,s){const i=this._collection,n=this._boundingRectNodeTest(t,s);if(n===L.pD.INSIDE)return;if(n===L.pD.OUTSIDE)return void(e.length=0);const d=i.getComponentCount(t.objectHandle);if(d.invisible+d.visible!==t.featureIds.length)return;const u=this._transformClippingArea(vs,s,t.objectHandle);(0,L.hv)(e,t.featureIds,h=>this._boundingRectFeatureTest(t,h,u))}_transformClippingArea(e,t,s){const i=this._collection.getObjectTransform(s),n=i.position,d=i.rotationScale;return e[0]=(t[0]-n[0])/d[0],e[1]=(t[1]-n[1])/d[4],e[2]=(t[2]-n[0])/d[0],e[3]=(t[3]-n[1])/d[4],e}_addOrUpdateEdgeRendering(e,t=!0){const s=this._edgeView;if((0,o.Wi)(s))return Promise.resolve(null);const i=e.objectHandle,n=s.hasObject(i),{hasEdges:d,perFeatureEdgeMaterials:u}=this._getFilteredEdgeMaterials(e),h={hasSlicePlane:this.slicePlaneEnabled};return d&&n?(this.nodeCrossfadingEnabled&&Je(u,this.getNodeOpacity(e)),s.updateAllComponentMaterials(i,u,h,t).catch(c=>Ae(c,this.i3slayer.title)),s.updateObjectVisibility(i,!0).catch(c=>Ae(c,this.i3slayer.title)),s.updateAllVerticalOffsets(i,e.elevationOffsets).catch(c=>Ae(c,this.i3slayer.title)),Promise.resolve(s)):d&&!n?this._collection.addEdges(i,s,u,h).then(c=>(e.edgeMemoryUsage=c,e.node.memory+=c,s.updateAllVerticalOffsets(i,e.elevationOffsets).catch(p=>Ae(p,this.i3slayer.title)),s)):(!d&&n&&(e.node.memory-=e.edgeMemoryUsage,e.edgeMemoryUsage=0,s.removeObject(i)),Promise.resolve(null))}_applyFiltersToNode(e){return!!this._applyFiltersToNodeComponents(e)&&((0,o.pC)(this._labeler)&&this._labeler.applyFilterChange(e),!0)}_applyFiltersToNodeComponents(e){const t=this._collection,s=0===t.getComponentCount(e.objectHandle).invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!s;if(this._updateCachedFilteredIds(e),e.filteredIds===e.featureIds)return!s;const i=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,i),!0}_updateCachedFilteredIds(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)}_computeFilteredIds(e){const t=e.featureIds.slice();for(const s of this._filters)if(s(t,e),0===t.length)break;return t.length===e.featureIds.length?e.featureIds:t}_computeFilteredComponentIndices(e){const t=new Array,s=e.filteredIds;return(0,o.pC)(s)&&e.featureIds.forEach((i,n)=>{s[t.length]===i&&t.push(n)}),t}_removeAllNodeDataFromStage(e=this.elevationOffset){this._nodeId2Meta.forEach((t,s)=>this._removeNodeStageData(s,e)),this._nodeId2MetaReloading.forEach((t,s)=>this._removeNodeStageData(s,e,this._nodeId2MetaReloading)),this._elevationTask=(0,o.SC)(this._elevationTask)}removeNode(e){const t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading),(0,o.pC)(this._elevationTask)&&this._elevationTask.remove(e)}_removeNodeStageData(e,t,s=this._nodeId2Meta){s.has(e)&&this._controller.updateLoadStatus(e,!1);const i=s.get(e);(0,o.Wi)(i)?s.delete(e):(this._collection.setObjectVisibility(i.objectHandle,yt.Z.Hidden),(0,o.pC)(this._edgeView)&&this._edgeView.hasObject(i.objectHandle)&&this._edgeView.updateObjectVisibility(i.objectHandle,!1).catch(n=>Ae(n,this.i3slayer.title)),this._visibleGeometryChanged(i,Me.REMOVE),(0,o.pC)(this._labeler)&&this._labeler.removeNodeMeta(i),s.delete(e),this._highlights.objectDeleted(i),s===this._nodeId2Meta?(this._cacheGPUData(i,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(i)):this._deleteComponentObject(i),(0,o.pC)(this._treeDebugger)&&this._treeDebugger.update())}_deleteComponentObject(e){if((0,o.pC)(this._edgeView)&&this._edgeView.removeObject(e.objectHandle),this._memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(const t of e.textures)this._memEstimateTextureRemoved(t),this._stage.remove(t)}updateNodeState(e,t){const s=this._nodeId2Meta.get(e);(0,o.pC)(s)&&this._collection.updateMaterial(s.objectHandle,i=>i.polygonOffsetEnabled=t===gt.FE.Hole)}_invalidateAllSymbols(){this._rendererVersion=(0,L.HV)(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}_getInvalidRendererVersion(){return(0,L.HV)(this._rendererVersion,-1)}_rendererChange(e){var t=this;return(0,N.Z)(function*(){if(t._currentRenderer=e,t.notifyChange("rendererTextureUsage"),t._rendererVersion=(0,L.HV)(t._rendererVersion,1),t._rendererFields=null,t._colorVariable=null,t._opacityVariable=null,t._invalidateAllSymbols(),e&&(t._rendererFields=yield e.getRequiredFields(t.i3slayer.fieldsIndex)),t._updateSymbologyFields(),!t._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired&&(t._arcade=yield(0,Ie.LC)()),e&&"visualVariables"in e&&e.visualVariables)for(const s of e.visualVariables)"color"===s.type?t._colorVariable=s:"opacity"===s.type?t._opacityVariable=s:Se.warn(`Unsupported visual variable type for 3D Object Scene Services: ${s.type}`);if(e)for(const s of e.getSymbols())"mesh-3d"!==s.type&&Se.error(`Symbols of type '${s.type}' are not supported for 3D Object Scene Services.`);t._controller&&t._controller.requestUpdate()})()}_getCachedEdgeMaterials(e){return this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}_getComponentParameters(e){this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);const t=e.cachedSymbology;return(s,i)=>{var d,u;const n=5*s;if((0,W.s)(i.externalColor,t[n+0]/255,t[n+1]/255,t[n+2]/255,t[n+3]/255),(0,o.pC)(this._stage.renderView.objectAndLayerIdRenderHelper)){const h=e.featureIds[s];this._stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(h,h,this.layerId,this.layerUid+"_"+this.sublayerId,this.layerPopupEnabled,e.node.resources.attributes,s,this.sublayerId),i.objectAndLayerIdColor=this._stage.renderView.getObjectAndLayerIdColor({graphicUid:h,layerUid:this.layerUid+"_"+this.sublayerId})}i.externalColorMixMode=t[n+4]&(1<<we.CastShadows)-1,i.castShadows=0!=(t[n+4]&1<<we.CastShadows),i.pickable=0!=(t[n+4]&1<<we.Pickable),i.elevationOffset=null!=(u=null==(d=e.elevationOffsets)?void 0:d[s])?u:0}}_getSymbolInfo(e,t){const s=e&&e.getSymbol(t,{arcade:this._arcade});if(!(s instanceof xe.Z))return null;const i=s.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);const n=(0,L.ix)(s);return this._symbolInfos.set(i,n),n}_setSymbologyOverride(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=(0,o.pC)(this._symbologyOverrideFields)&&this._symbologyOverrideFields.length>0?(0,o.pC)(this._rendererFields)&&this._rendererFields.length>0?(0,fe.Q0)(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(e){if(e.cachedRendererVersion=this._rendererVersion,!this._hasComponentData)return;const t=this._tmpAttributeOnlyGraphic,s={};t.attributes=s;const i=this._currentRenderer,n=(0,o.pC)(e.attributeInfo)&&e.attributeInfo.attributeData,d=null!=e.featureIds?this.i3slayer.objectIdField:null,u=null!=n&&(0,o.pC)(this._symbologyFields)&&this._symbologyFields.length>0;let h=null,c=null;if(u&&(0,o.pC)(this._symbologyFields)){h=[],c=[];for(const J of this._symbologyFields){const Z=n[J];Z&&(h.push(J),c.push(Z))}}e.cachedSymbology||(e.cachedSymbology=new Uint8Array(5*e.featureIds.length));const p={color:$e,castShadows:!0,pickable:!0,colorMixMode:_t.a9.Multiply,edgeMaterial:null},y=this.fullOpacity,A=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):y;let z=null,K=at.i.OPAQUE,$=L.uC,de=0;for(let J=0;J<e.featureIds.length;J++){if(null!=d&&(s[d]=e.featureIds[J]),u&&h)for(let H=0;H<h.length;H++)s[h[H]]=(0,L.Jx)(c[H],J);const Z=i?this._getSymbolInfo(i,t):null;let S=null,X=null;if(i&&"visualVariables"in i){if(this._colorVariable){const H=(0,Ce.getColor)(this._colorVariable,t,{color:Is,arcade:this._arcade});H&&(S=$e,S[0]=H.r/255,S[1]=H.g/255,S[2]=H.b/255,this._opacityVariable||null===H.a||(X=H.a))}this._opacityVariable&&(X=(0,Ce.getOpacity)(this._opacityVariable,t,{arcade:this._arcade}))}if(Z&&Z.material){const H=Z.material;S=(0,o.Wi)(S)||(0,o.Wi)(X)?(0,Ot.$o)(S,X,H.color,H.alpha,Nt,$e):(0,Ot.$o)(S,X,null,null,Nt,$e)}if((0,o.Wi)(S)&&(S=$e,S[0]=1,S[1]=1,S[2]=1,S[3]=1),p.pickable=!0,p.castShadows=!Z||Z.castShadows,p.colorMixMode=Z&&Z.material?Z.material.colorMixMode:_t.a9.Multiply,p.edgeMaterial=Z?Z.edgeMaterial:null,(0,o.pC)(this._symbologyOverride)&&(p.color=S,this._symbologyOverride(t,p),S=p.color),(0,o.pC)(p.edgeMaterial)){const H=S[3]<=0?at.i.INVISIBLE:S[3]>=1&&(e.material.isOpaque||p.colorMixMode===_t.a9.Replace)?at.i.OPAQUE:at.i.TRANSPARENT;p.edgeMaterial===z&&H===K||($=Te(Ne({},p.edgeMaterial),{opacity:A,objectTransparency:H}),z=p.edgeMaterial,K=H),e.cachedEdgeMaterials[J]=$}else e.cachedEdgeMaterials[J]=L.uC;e.cachedSymbology[de+0]=Math.round(255*S[0]),e.cachedSymbology[de+1]=Math.round(255*S[1]),e.cachedSymbology[de+2]=Math.round(255*S[2]),e.cachedSymbology[de+3]=Math.round(255*S[3]),e.cachedSymbology[de+4]=p.colorMixMode|+p.castShadows<<we.CastShadows|+p.pickable<<we.Pickable,de+=5}}_getFilteredEdgeMaterials(e){const t=this._getCachedEdgeMaterials(e);this.nodeCrossfadingEnabled||Je(t,this.fullOpacity);const s=e.filteredIds;if((0,o.Wi)(s))return{hasEdges:t.some(u=>u!==L.uC),perFeatureEdgeMaterials:t};let i=0,n=!1;const d=t.map((u,h)=>e.featureIds[h]!==s[i]?L.uC:(n=n||u!==L.uC,i++,u));return{hasEdges:n,perFeatureEdgeMaterials:d}}_updateComponentData(e){if(!this._hasComponentData)return;const t=e.objectHandle,s=this._getComponentParameters(e);this._collection.setComponentData(t,s),this._stage.renderView.requestRender()}_reloadAll(e=this.elevationOffset){this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(e){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach(t=>{(0,o.Wi)(t)||(this._collection.updateMaterial(t.objectHandle,s=>s.objectOpacity=e),Je(t.cachedEdgeMaterials,e),this._updateEdgeRendering(t))})}_updateMaterial(e){this._collection.updateMaterial(e.objectHandle,t=>{t.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,t.usePBR=this._usePBR,this._updateMaterialOverlay(t)})}_updateMaterialOverlay(e){}_updateEngineObject(e){this._updateComponentData(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,Me.UPDATE)}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),(0,o.pC)(this._labeler)&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach(t=>{(0,o.Wi)(t)||(this._collection.updateMaterial(t.objectHandle,s=>s.commonMaterialParameters.hasSlicePlane=e),this._updateEdgeRendering(t,!1))})}_updatePBR(e){this._nodeId2Meta.forEach(t=>{(0,o.Wi)(t)||this._collection.updateMaterial(t.objectHandle,s=>s.usePBR=e)}),this._hasLoadedPBRTextures=!0}get _usePBR(){return!this._isIntegratedMesh&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(e,t=!0){(0,o.pC)(this._edgeView)&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}_forAllNodes(e){this._nodeId2Meta.forEach(e)}_forAllFeatures(e,t,s=k.u.VISIBLE_ONLY){(0,ie.oE)(this._nodeId2Meta,i=>{if((0,o.Wi)(i))return!1;if((0,o.pC)(t))switch(t(i)){case k.K.EXIT:return!0;case k.K.SKIP:return!1}let n=k.K.CONTINUE;switch(s){case k.u.ALL:n=this._forAllFeaturesOfNode(i,e);break;case k.u.VISIBLE_ONLY:n=this._forVisibleFeaturesOfNode(i,e);break;case k.u.ALL_IN_CLIPPING_AREA:n=this._forAllFeaturesOfNodeInClippingArea(i,e)}return n===k.K.EXIT})}_forAllFeaturesOfNode(e,t){let s=k.K.CONTINUE;const i=e.featureIds;for(let n=0;n<i.length;n++)if(s=t(i[n],n,e),s===k.K.EXIT)return s;return s}_forVisibleFeaturesOfNode(e,t){let s=k.K.CONTINUE;const i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,n=>(s=t(i[n],n,e),s===k.K.CONTINUE)),s}_forAllFeaturesOfNodeInClippingArea(e,t){if((0,o.Wi)(this._renderClippingArea))return this._forAllFeaturesOfNode(e,t);const s=this._boundingRectNodeTest(e,this._renderClippingArea);if(s===L.pD.OUTSIDE)return k.K.CONTINUE;if(s===L.pD.INSIDE)return this._forAllFeaturesOfNode(e,t);const i=k.K.CONTINUE,n=e.featureIds,u=(0,L.ns)(this._renderClippingArea,this._collection.getObjectTransform(e.objectHandle));for(let h=0;h<n.length;h++){if(!this._boundingRectFeatureTest(e,h,u))continue;const c=t(n[h],h,e);if(c===k.K.EXIT)return c}return i}_createAttributes(e,t){const s={};null!=t.featureIds&&(s[this._getObjectIdField()]=t.featureIds[e]);const i=(0,o.pC)(t.attributeInfo)&&t.attributeInfo.attributeData;if((0,o.pC)(i))for(const n of Object.keys(i))s[n]=(0,L.Jx)(i[n],e);return s}_createGraphic(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}highlight(e){const t=this._highlights;if("number"==typeof e||e instanceof ce.Z?e=[e]:e instanceof _e.Z&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof ce.Z){const s=e,i=this.i3slayer.fieldsIndex,n=this._getObjectIdField(),d=s.map(c=>(0,mt.g)(i,c.attributes,n)),{set:u,handle:h}=t.acquireSet();return t.setFeatureIds(u,d),h}if("number"==typeof e[0]){const s=e,{set:i,handle:n}=t.acquireSet();return t.setFeatureIds(i,s),n}}return Os}resetHighlights(){(0,o.SC)(this._highlights),this._highlights=new Xt({collection:this._collection,forAllFeatures:e=>this._forAllFeatures(e,null,k.u.ALL),forAllFeaturesOfNode:(e,t)=>this._forAllFeaturesOfNode(e,t)})}_visibleGeometryChanged(e,t){this._elevationProvider&&(this._elevationProvider.objectChanged(e.node),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=(0,U.Os)(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})),this._updateSnappingSources(e,t))}get performanceInfo(){const e={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this._gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this._geoMemoryEstimate/1048576).toFixed(1)+"MB","Texture Memory Estimate":(this._texMemoryEstimate/1048576).toFixed(1)+"MB","Unloaded Memory Estimate":(this.getUnloadedMemory()/1048576).toFixed(1)+"MB"};return(0,o.pC)(this._memCache)&&(e.MemCache=Math.round(100*this._memCache.hitRate)+"% hit"),this._controller&&(this._idbCacheEnabled&&(e.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(e)),e}get test(){const e=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const t=[];return e._forAllFeatures(s=>(t.push(s),k.K.CONTINUE),null,k.u.VISIBLE_ONLY),t.sort((s,i)=>s-i),t},get numNodes(){return e._nodeId2Meta.size},get loadedNodes(){return Array.from(e._nodeId2Meta.keys()).sort((t,s)=>t-s)}}}getNodeOpacityByIndex(e){const t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}getNodeOpacity(e){return(0,o.pC)(e)?this._collection.getMaterial(e.objectHandle).objectOpacity:0}isNodeFullyFadedIn(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}getNodeCrossfadeMetaData(e){return this._nodeId2Meta.get(e)}markNodeToRemove(e){this._controller&&this._controller.markNodeToRemove(e)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(e){this._nodeId2Meta.forEach((t,s)=>e(s,t))}fadeNode(e,t,s){if(!this.nodeCrossfadingEnabled)return;const i=this._nodeId2Meta.get(e);(0,o.pC)(i)&&this._crossfadeHelper.fadeNode(e,i,t,s)}setNodeOpacityByIndex(e,t){const s=this._nodeId2Meta.get(e);(0,o.pC)(s)&&this._setNodeOpacity(s,t)}_setNodeOpacity(e,t){this._collection.updateMaterial(e.objectHandle,s=>s.objectOpacity=t),this._setNodeEdgeOpacity(e,t)}_setNodeEdgeOpacity(e,t){if((0,o.Wi)(this._edgeView)||!e.cachedEdgeMaterials)return;Je(e.cachedEdgeMaterials,t);const s=e.objectHandle;this._edgeView.hasObject(s)&&this._edgeView.updateAllComponentOpacities(s,t).catch(i=>Ae(i,this.i3slayer.title))}get hasModifications(){return this._isIntegratedMesh&&(0,o.pC)(this._layerClippingArea)||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(e){if(!this.hasModifications||e.length<=0||!0!==this._i3sWasmLoaded)return;const s=this.uid,i=function Ms(a){if(0===a.length)return null;const e=new Float64Array(10*a.length);return a.forAll((t,s)=>{let i=t.serviceObb;(0,o.Wi)(i)&&(i=Cs,(0,I.c)(i.center,t.mbs),i.halfSize[0]=i.halfSize[1]=i.halfSize[2]=t.mbs[3]);const n=10*s;e[n+0]=i.center[0],e[n+1]=i.center[1],e[n+2]=i.center[2],e[n+3]=i.halfSize[0],e[n+4]=i.halfSize[1],e[n+5]=i.halfSize[2],e[n+6]=i.quaternion[0],e[n+7]=i.quaternion[1],e[n+8]=i.quaternion[2],e[n+9]=i.quaternion[3]}),e}(e);if((0,o.pC)(i)){(0,st.filterObbsForModificationsSync)({context:s,buffer:i.buffer});const d=new Float64Array(i.buffer);e.forAll((u,h)=>{const p=(0,st.interpretObbModificationResults)(d[h]);u.imModificationImpact=p,p!==gt.O4.Unmodified&&this._controller.invalidateGeometryVisibility(u.index)})}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||(0,o.pC)(this._labeler)&&this._labeler.updating||this._crossfadeHelper.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0||(0,o.pC)(this._elevationTask)&&this._elevationTask.running}trackSnappingSources(e){var t=this;const s={events:e,fetchEdgeLocations:(i=(0,N.Z)(function*(n,d,u){const h=t._nodeId2Meta.get(n);if((0,o.Wi)(h))throw new Error("invalid-node");const{origin:c,buffer:p}=yield t._collection.extractEdgeInformation(h.objectHandle,d,u);return t._snappingLocationsApplyElevation(h,p,c),{type:"components",objectIds:h.featureIds,locations:p,origin:c}}),function(d,u,h){return i.apply(this,arguments)}),remove:()=>{(0,te.e$)(this._snappingSourcesTrackers,s)}};var i;return this._snappingSourcesTrackers.push(s),this._nodeId2Meta.forEach((i,n)=>{if((0,o.Wi)(i))return;const d=this._controller.getRenderMbs(i.node);(0,o.pC)(d)&&e.add(n,d)}),s}_snappingLocationsApplyElevation(e,t,s){if(!e.elevationOffsets||this.elevationInfo.mode===le.Absolute)return;const i=t.position0,n=t.position1,d=t.componentIndex,u=(0,P.c)(),h=(0,P.c)(),c=(p,y)=>{(0,I.a)(p,p,s),this.view.renderCoordsHelper.worldUpAtPosition(p,h),(0,I.a)(p,p,(0,I.g)(h,h,y)),(0,I.b)(p,p,s)};for(let p=0;p<i.count;p++){const y=e.elevationOffsets[d.get(p)];i.getVec(p,u),c(u,y),i.setVec(p,u),n.getVec(p,u),c(u,y),n.setVec(p,u)}}_updateSnappingSources(e,t){const{index:s}=e.node,i=this._controller.getRenderMbs(e.node);if(!(0,o.Wi)(i))for(const n of this._snappingSourcesTrackers)t!==Me.REMOVE&&t!==Me.UPDATE||n.events.remove(s),t!==Me.ADD&&t!==Me.UPDATE||n.events.add(s,i)}};return(0,m._)([(0,f.Cb)()],r.prototype,"_hasLoadedPBRTextures",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"_asyncModuleLoading",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"view",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"i3slayer",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"_controller",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"_labeler",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"updating",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"suspended",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"holeFilling",void 0),(0,m._)([(0,f.Cb)(ps.q)],r.prototype,"updatingProgress",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"updatingProgressValue",null),(0,m._)([(0,f.Cb)()],r.prototype,"hasTexturesOrVertexColors",null),(0,m._)([(0,f.Cb)()],r.prototype,"rendererTextureUsage",null),(0,m._)([(0,f.Cb)()],r.prototype,"elevationOffset",null),(0,m._)([(0,f.Cb)()],r.prototype,"elevationInfo",null),(0,m._)([(0,f.Cb)({type:Boolean})],r.prototype,"slicePlaneEnabled",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"supportedTextureEncodings",null),(0,m._)([(0,f.Cb)()],r.prototype,"uncompressedTextureDownsamplingEnabled",null),(0,m._)([(0,f.Cb)({type:[oe.Z]})],r.prototype,"_modifications",void 0),(0,m._)([(0,f.Cb)()],r.prototype,"_elevationTask",void 0),(0,m._)([(0,f.Cb)({readOnly:!0})],r.prototype,"_usePBR",null),r=(0,m._)([(0,ge.j)(At)],r),r};function Ae(a,r){(0,V.D_)(a)||Se.warn("Error while processing edges. Edges on this layer might not display correctly",r,a)}var Me;!function(a){a[a.ADD=0]="ADD",a[a.REMOVE=1]="REMOVE",a[a.UPDATE=2]="UPDATE"}(Me||(Me={}));const Tt=(0,b.Ue)(),Dt=(0,E.Ue)(),vs=(0,E.Ue)(),Cs=(0,Ke.Ue)(),$e=[0,0,0,0],Is=new C.Z([0,0,0,0]),jt=[0,0,0,0];function Ut(a){if((0,o.Wi)(a))return!1;const r=a.metallicRoughness;return r&&r.baseColorTextureId>=0||r&&r.metallicRoughnessTextureId>=0||a.normalTextureId>=0||a.emissiveTextureId>=0||a.occlusionTextureId>=0}function Ft(a){return(0,o.pC)(a)&&(0,x.eP)(a.data)}function wt(a,r){let e=1024+a.interleavedVertexData.byteLength+(a.indices?a.indices.byteLength:0)+a.positionData.data.byteLength+a.positionData.indices.byteLength;if((0,o.pC)(r))for(const t of r)(0,o.pC)(t)&&(0,x.eP)(t.data)&&(e+=t.data.byteLength);return e}function Lt(a,r){return r.byteSize>ys?(Se.warn(`Node is too big to store in IndexedDB cache: ${a.id} (${r.byteSize} bytes)`),!1):r.byteSize>0}const Os={remove(){},pause(){},resume(){}};function Je(a,r){a.forEach(e=>e.opacity=r)}var le;!function(a){a[a.Absolute=0]="Absolute",a[a.RelativeToGround=1]="RelativeToGround",a[a.OnTheGround=2]="OnTheGround"}(le||(le={}));const Ss=(0,P.c)(),xs=(0,b.Ue)(),Ht="elevation-change"},52836:(se,D,l)=>{var N,m,C;l.d(D,{K:()=>m,u:()=>N}),(C=N||(N={}))[C.VISIBLE_ONLY=0]="VISIBLE_ONLY",C[C.ALL=1]="ALL",C[C.ALL_IN_CLIPPING_AREA=2]="ALL_IN_CLIPPING_AREA",function(C){C[C.EXIT=0]="EXIT",C[C.CONTINUE=1]="CONTINUE",C[C.SKIP=2]="SKIP"}(m||(m={}))},30375:(se,D,l)=>{l.r(D),l.d(D,{destroyContext:()=>Y,dracoDecompressPointCloudData:()=>o,filterObbsForModifications:()=>V,filterObbsForModificationsSync:()=>B,initialize:()=>W,interpretObbModificationResults:()=>O,process:()=>j,setLegacySchema:()=>G,setModifications:()=>U,setModificationsSync:()=>v,test:()=>R});var N=l(15861),m=l(62208),C=l(17926),ce=l(54346);function pe(g){return(0,ce.V)(`esri/libs/i3s/${g}`)}let _e;var q=l(52565);function j(g){return ie.apply(this,arguments)}function ie(){return(ie=(0,N.Z)(function*(g){yield W();const b=[g.geometryBuffer];return{result:M(g,b),transferList:b}})).apply(this,arguments)}function o(g){return ne.apply(this,arguments)}function ne(){return(ne=(0,N.Z)(function*(g){var xe;yield W();const b=[g.geometryBuffer],{geometryBuffer:E}=g,Q=E.byteLength,ee=F._malloc(Q),fe=new Uint8Array(F.HEAPU8.buffer,ee,Q);fe.set(new Uint8Array(E));const oe=F.dracoDecompressPointCloudData(ee,fe.byteLength);if(F._free(ee),oe.error.length>0)throw new Error(`i3s.wasm: ${oe.error}`);const Ce=(null==(xe=oe.featureIds)?void 0:xe.length)>0?oe.featureIds.slice():null,Ie=oe.positions.slice();return Ce&&b.push(Ce.buffer),b.push(Ie.buffer),{result:{positions:Ie,featureIds:Ce},transferList:b}})).apply(this,arguments)}function V(g){return T.apply(this,arguments)}function T(){return(T=(0,N.Z)(function*(g){yield W(),B(g);const b={buffer:g.buffer};return{result:b,transferList:[b.buffer]}})).apply(this,arguments)}function U(g){return x.apply(this,arguments)}function x(){return(x=(0,N.Z)(function*(g){yield W(),v(g)})).apply(this,arguments)}function G(g){return f.apply(this,arguments)}function f(){return(f=(0,N.Z)(function*(g){yield W(),F.setLegacySchema(g.context,g.jsonSchema)})).apply(this,arguments)}function Y(g){I(g)}let ge,F;function v(g){const b=g.modifications,E=F._malloc(8*b.length),Q=new Float64Array(F.HEAPU8.buffer,E,b.length);for(let ee=0;ee<b.length;++ee)Q[ee]=b[ee];F.setModifications(g.context,E,b.length,g.isGeodetic),F._free(E)}function M(g,b){if(!F)return null;const{context:E,localOrigin:Q,globalTrafo:ee,mbs:fe,obb:oe,elevationOffset:Ce,geometryBuffer:Ie,geometryDescriptor:xe,indexToVertexProjector:Le,vertexToRenderProjector:Et}=g,De=F._malloc(Ie.byteLength),Ge=F._malloc(33*Float64Array.BYTES_PER_ELEMENT),ke=new Uint8Array(F.HEAPU8.buffer,De,Ie.byteLength);ke.set(new Uint8Array(Ie));const me=new Float64Array(F.HEAPU8.buffer,Ge,33);P(me,Q);let Ee=me.byteOffset+3*me.BYTES_PER_ELEMENT,ye=new Float64Array(me.buffer,Ee);P(ye,ee),Ee+=16*me.BYTES_PER_ELEMENT,ye=new Float64Array(me.buffer,Ee),P(ye,fe),Ee+=4*me.BYTES_PER_ELEMENT,(0,m.pC)(oe)&&(ye=new Float64Array(me.buffer,Ee),P(ye,oe.center),Ee+=3*me.BYTES_PER_ELEMENT,ye=new Float64Array(me.buffer,Ee),P(ye,oe.halfSize),Ee+=3*me.BYTES_PER_ELEMENT,ye=new Float64Array(me.buffer,Ee),P(ye,oe.quaternion));const He=xe,ht={isDraco:!1,isLegacy:!1,color:g.layouts.some(ue=>ue.some(Pe=>"color"===Pe.name)),normal:g.needNormals&&g.layouts.some(ue=>ue.some(Pe=>"normalCompressed"===Pe.name)),uv0:g.layouts.some(ue=>ue.some(Pe=>"uv0"===Pe.name)),uvRegion:g.layouts.some(ue=>ue.some(Pe=>"uvRegion"===Pe.name)),featureIndex:He.featureIndex},w=F.process(E,!!g.obb,De,ke.byteLength,He,ht,Ge,Ce,Le,Et,g.normalReferenceFrame);if(F._free(Ge),F._free(De),w.error.length>0)throw new Error(`i3s.wasm: ${w.error}`);if(w.discarded)return null;const We=w.componentOffsets.length>0?w.componentOffsets.slice():null,Oe=w.featureIds.length>0?w.featureIds.slice():null,qe=w.interleavedVertedData.slice().buffer,et=w.indicesType===C.P.Int16?new Uint16Array(w.indices.buffer,w.indices.byteOffset,w.indices.byteLength/2).slice():new Uint32Array(w.indices.buffer,w.indices.byteOffset,w.indices.byteLength/4).slice(),tt=w.positions.slice(),be=w.positionIndicesType===C.P.Int16?new Uint16Array(w.positionIndices.buffer,w.positionIndices.byteOffset,w.positionIndices.byteLength/2).slice():new Uint32Array(w.positionIndices.buffer,w.positionIndices.byteOffset,w.positionIndices.byteLength/4).slice(),ve={layout:g.layouts[0],interleavedVertexData:qe,indices:et,hasColors:w.hasColors,hasModifications:w.hasModifications,positionData:{data:tt,indices:be}};return Oe&&b.push(Oe.buffer),We&&b.push(We.buffer),b.push(qe),b.push(et.buffer),b.push(tt.buffer),b.push(be.buffer),{componentOffsets:We,featureIds:Oe,transformedGeometry:ve,obb:w.obb}}function O(g){return 0===g?q.O4.Unmodified:1===g?q.O4.PotentiallyModified:2===g?q.O4.Culled:q.O4.Unknown}function B(g){const{context:b,buffer:E}=g,Q=F._malloc(E.byteLength),ee=E.byteLength/Float64Array.BYTES_PER_ELEMENT,fe=new Float64Array(F.HEAPU8.buffer,Q,ee),oe=new Float64Array(E);fe.set(oe),F.filterOBBs(b,Q,ee),oe.set(fe),F._free(Q)}function I(g){F&&F.destroy(g)}function P(g,b){for(let E=0;E<b.length;++E)g[E]=b[E]}function W(){return F?Promise.resolve():(ge||(ge=function te(){return _e||(_e=new Promise(g=>l.e(5979).then(l.bind(l,85979)).then(b=>b.i).then(({default:b})=>{const E=b({locateFile:pe,onRuntimeInitialized:()=>g(E)});delete E.then})).catch(g=>{throw g})),_e}().then(g=>{F=g,ge=null})),ge)}const R={transform:M,destroy:I}},2694:(se,D,l)=>{l.d(D,{YF:()=>j,gz:()=>q,z6:()=>_e});var N=l(62208),m=l(84161),C=l(28093),ce=l(55915),te=l(5548),pe=l(6040);function _e(ne,V,T,U){const x=V.getComponentAabb(T,ne,ie),G=V.getObjectTransform(T);for(let f=0;f<8;++f)o[0]=1&f?x[0]:x[3],o[1]=2&f?x[1]:x[4],o[2]=4&f?x[2]:x[5],(0,m.t)(o,o,G.rotationScale),(0,m.a)(o,o,G.position),U[3*f]=o[0],U[3*f+1]=o[1],U[3*f+2]=o[2];return U}function q(ne,V,T){const U=(0,pe.bg)(24);return x=>{let G=x.meta.featureExtents;if((0,N.Wi)(G)){G=new Float64Array(6*x.meta.featureIds.length),x.meta.featureExtents=G;for(let Y=0;Y<G.length;Y+=6)G[Y]=Number.POSITIVE_INFINITY}const f=new Float64Array(G.buffer,6*x.index*Float64Array.BYTES_PER_ELEMENT,6);return f[0]===Number.POSITIVE_INFINITY&&(_e(x.index,T,x.meta.objectHandle,U),(0,ce.CM)(U,V,0,U,ne,0,8)?((0,te.t8)(f,te.Gv),(0,te.G1)(f,U,0,8)):(0,te.t8)(f,te.xE)),f}}function j(ne,V,T,U){const x=V.getComponentAabb(T,ne,ie),G=V.getObjectTransform(T);U[0]=0,U[1]=0,U[2]=0;for(let f=0;f<8;++f)o[0]=1&f?x[0]:x[3],o[1]=2&f?x[1]:x[4],o[2]=x[5],(0,m.t)(o,o,G.rotationScale),(0,m.a)(o,o,G.position),U[0]+=o[0],U[1]+=o[1],U[2]+=o[2];return U[0]/=8,U[1]/=8,U[2]/=8,U}const ie=(0,te.Ue)(),o=(0,C.c)()}}]);
"use strict";var me=Object.defineProperty,Pe=Object.defineProperties,ve=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,Ee=Object.prototype.hasOwnProperty,De=Object.prototype.propertyIsEnumerable,se=(S,v,i)=>v in S?me(S,v,{enumerable:!0,configurable:!0,writable:!0,value:i}):S[v]=i,re=(S,v)=>{for(var i in v||(v={}))Ee.call(v,i)&&se(S,i,v[i]);if(ne)for(var i of ne(v))De.call(v,i)&&se(S,i,v[i]);return S},ae=(S,v)=>Pe(S,ve(v));(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[3792],{9088:(S,v,i)=>{i.d(v,{L:()=>b,b:()=>p});var a=i(28347),o=i(43703),u=i(67831),y=i(99770),T=i(47634),A=i(95285),D=i(65787),O=i(17625),R=i(63123),h=i(22355),m=i(16396);function p(C){const E=new h.kG;E.include(T.j,C);const{vertex:w,fragment:f}=E;return w.uniforms.add([new R.g("modelView",(M,l)=>(0,a.j)(d,l.camera.viewMatrix,M.origin)),new R.g("proj",(M,l)=>l.camera.projectionMatrix),new D.p("glowWidth",(M,l)=>M.glowWidth*l.camera.pixelRatio),new A.A("pixelToNDC",(M,l)=>(0,u.a)(P,2/l.camera.fullViewport[2],2/l.camera.fullViewport[3]))]),E.attributes.add(m.T.START,"vec3"),E.attributes.add(m.T.END,"vec3"),E.attributes.add(m.T.UP,"vec3"),E.attributes.add(m.T.EXTRUDE,"vec2"),E.varyings.add("uv","vec2"),E.varyings.add("vViewStart","vec3"),E.varyings.add("vViewEnd","vec3"),E.varyings.add("vViewPlane","vec4"),w.code.add(O.H`void main() {
vec3 pos = mix(start, end, extrude.x);
vec4 viewPos = modelView * vec4(pos, 1);
vec4 projPos = proj * viewPos;
vec2 ndcPos = projPos.xy / projPos.w;
vec3 viewUp = (modelView * vec4(extrude.y * up, 0)).xyz;
vec4 projPosUp = proj * vec4(viewPos.xyz + viewUp, 1);
vec2 projExtrudeDir = normalize(projPosUp.xy / projPosUp.w - ndcPos);
vec2 lxy = abs(sign(projExtrudeDir) - ndcPos);
ndcPos += length(lxy) * projExtrudeDir;
vec3 worldPlaneNormal = normalize(cross(up, normalize(end - start)));
vec3 viewPlaneNormal = (modelView * vec4(worldPlaneNormal, 0)).xyz;
vViewStart = (modelView * vec4(start, 1)).xyz;
vViewEnd = (modelView * vec4(end, 1)).xyz;
vViewPlane = vec4(viewPlaneNormal, -dot(viewPlaneNormal, vViewStart));
float xPaddingPixels = sign(dot(viewPlaneNormal, viewPos.xyz)) * (extrude.x * 2.0 - 1.0) * glowWidth;
ndcPos.x += xPaddingPixels * pixelToNDC.x;
uv = ndcPos * 0.5 + 0.5;
gl_Position = vec4(ndcPos, 0, 1);
}`),f.uniforms.add(new D.p("perScreenPixelRatio",(M,l)=>l.camera.perScreenPixelRatio)),f.code.add(O.H`float planeDistancePixels(vec4 plane, vec3 pos, vec3 start, vec3 end) {
vec3 origin = mix(start, end, 0.5);
vec3 basis = end - origin;
vec3 posAtOrigin = pos - origin;
float x = dot(normalize(basis), posAtOrigin);
float y = dot(plane.xyz, posAtOrigin);
float dx = max(abs(x) - length(basis), 0.0);
float dy = y;
float dist = length(vec2(dx, dy));
float width = fwidth(y);
float maxPixelDistance = length(pos) * perScreenPixelRatio * 2.0;
float pixelDist = dist / min(width, maxPixelDistance);
return abs(pixelDist);
}
void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
float distance = planeDistancePixels(vViewPlane, pos, vViewStart, vViewEnd);
vec4 color = laserlineProfile(distance);
float alpha = 1.0 - smoothstep(0.995, 0.999, abs(dot(normal, vViewPlane.xyz)));
gl_FragColor = laserlineOutput(color * alpha * depthDiscontinuityAlpha);
}`),E}const P=(0,y.a)(),d=(0,o.c)(),b=Object.freeze(Object.defineProperty({__proto__:null,build:p},Symbol.toStringTag,{value:"Module"}))},66501:(S,v,i)=>{i.d(v,{L:()=>w,b:()=>b,d:()=>d});var a=i(21286),o=i(62208),u=i(67831),y=i(99770),T=i(47634),A=i(98071),D=i(95285),O=i(39704),R=i(66054),h=i(65787),m=i(84178),p=i(17625),P=i(22355);const d=(0,a.Vl)(6);function b(f){const M=new P.kG;M.extensions.add("GL_OES_standard_derivatives"),M.include(A.k),M.include(T.j,f);const l=M.fragment;return f.heightManifoldEnabled&&l.uniforms.add(new R.y("heightPlane")),f.pointDistanceEnabled&&l.uniforms.add(new R.y("pointDistanceSphere")),f.lineVerticalPlaneEnabled&&(l.uniforms.add(new R.y("lineVerticalPlane")),l.uniforms.add(new O.K("lineVerticalStart")),l.uniforms.add(new O.K("lineVerticalEnd"))),(f.heightManifoldEnabled||f.pointDistanceEnabled||f.lineVerticalPlaneEnabled)&&l.uniforms.add(new m.d("maxPixelDistance")),(f.lineVerticalPlaneEnabled||f.heightManifoldEnabled)&&l.code.add(p.H`float planeDistancePixels(vec4 plane, vec3 pos) {
float dist = dot(plane.xyz, pos) + plane.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),f.pointDistanceEnabled&&l.code.add(p.H`float sphereDistancePixels(vec4 sphere, vec3 pos) {
float dist = distance(sphere.xyz, pos) - sphere.w;
float width = fwidth(dist);
dist /= min(width, maxPixelDistance);
return abs(dist);
}`),f.intersectsLineEnabled&&(l.uniforms.add(new O.K("intersectsLineStart")),l.uniforms.add(new O.K("intersectsLineEnd")),l.uniforms.add(new O.K("intersectsLineDirection")),l.uniforms.add(new m.d("intersectsLineRadius")),l.uniforms.add(new h.p("perScreenPixelRatio",(n,_)=>_.camera.perScreenPixelRatio)),l.code.add(p.H`float lineDistancePixels(vec3 start, vec3 dir, float radius, vec3 pos) {
float dist = length(cross(dir, pos - start)) / (length(pos) * perScreenPixelRatio);
return abs(dist) - radius;
}`)),(f.lineVerticalPlaneEnabled||f.intersectsLineEnabled)&&l.code.add(p.H`bool pointIsWithinLine(vec3 pos, vec3 start, vec3 end) {
vec3 dir = end - start;
float t2 = dot(dir, pos - start);
float l2 = dot(dir, dir);
return t2 >= 0.0 && t2 <= l2;
}`),l.code.add(p.H`void main() {
vec3 pos;
vec3 normal;
float depthDiscontinuityAlpha;
if (!laserlineReconstructFromDepth(pos, normal, depthDiscontinuityAlpha)) {
discard;
}
vec4 color = vec4(0, 0, 0, 0);`),f.heightManifoldEnabled&&(l.uniforms.add(new D.A("angleCutoff",n=>C(n))),l.code.add(p.H`{
float heightManifoldAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, heightPlane.xyz)));
vec4 heightManifoldColor = laserlineProfile(planeDistancePixels(heightPlane, pos));
color = max(color, heightManifoldColor * heightManifoldAlpha);
}`)),f.pointDistanceEnabled&&(l.uniforms.add(new D.A("angleCutoff",n=>C(n))),l.code.add(p.H`{
float pointDistanceSphereDistance = sphereDistancePixels(pointDistanceSphere, pos);
vec4 pointDistanceSphereColor = laserlineProfile(pointDistanceSphereDistance);
float pointDistanceSphereAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, normalize(pos - pointDistanceSphere.xyz))));
color = max(color, pointDistanceSphereColor * pointDistanceSphereAlpha);
}`)),f.lineVerticalPlaneEnabled&&(l.uniforms.add(new D.A("angleCutoff",n=>C(n))),l.code.add(p.H`{
if (pointIsWithinLine(pos, lineVerticalStart, lineVerticalEnd)) {
float lineVerticalDistance = planeDistancePixels(lineVerticalPlane, pos);
vec4 lineVerticalColor = laserlineProfile(lineVerticalDistance);
float lineVerticalAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, abs(dot(normal, lineVerticalPlane.xyz)));
color = max(color, lineVerticalColor * lineVerticalAlpha);
}
}`)),f.intersectsLineEnabled&&(l.uniforms.add(new D.A("angleCutoff",n=>C(n))),l.code.add(p.H`{
if (pointIsWithinLine(pos, intersectsLineStart, intersectsLineEnd)) {
float intersectsLineDistance = lineDistancePixels(intersectsLineStart, intersectsLineDirection, intersectsLineRadius, pos);
vec4 intersectsLineColor = laserlineProfile(intersectsLineDistance);
float intersectsLineAlpha = 1.0 - smoothstep(angleCutoff.x, angleCutoff.y, 1.0 - abs(dot(normal, intersectsLineDirection)));
color = max(color, intersectsLineColor * intersectsLineAlpha);
}
}`)),l.code.add(p.H`gl_FragColor = laserlineOutput(color * depthDiscontinuityAlpha);
}`),M}function C(f){const M=(0,o.pC)(f.angleCutoff)?f.angleCutoff:d;return(0,u.a)(E,Math.cos(M),Math.cos(Math.max(0,M-(0,a.Vl)(2))))}const E=(0,y.a)(),w=Object.freeze(Object.defineProperty({__proto__:null,defaultAngleCutoff:d,build:b},Symbol.toStringTag,{value:"Module"}))},23018:(S,v,i)=>{i.d(v,{W:()=>ge});var a=i(62208),o=i(84161),u=i(28093),y=i(13777),T=i(68604),A=i(21286),D=i(993),O=i(4794),R=i(85072),h=i(8834),m=i(90014),p=i(70562),P=i(97126),d=i(4511),b=i(19625),C=i(16396),E=i(651),w=i(91056),f=i(12407),M=i(9088),l=i(67969),n=i(2078);class _ extends w.A{initializeProgram(t){const r=_.shader.get().build(this.configuration);return new f.$(t.rctx,r,_.attributeLocations)}initializePipeline(){return(0,n.sm)({blending:(0,n.if)(l.zi.ONE,l.zi.ONE_MINUS_SRC_ALPHA),colorWrite:n.BK})}}_.shader=new E.J(M.L,()=>i.e(9689).then(i.bind(i,79689))),_.attributeLocations=new Map([[C.T.START,0],[C.T.END,1],[C.T.UP,2],[C.T.EXTRUDE,3]]);var g=i(83994),j=i(49353);class W{constructor(t){this._renderCoordsHelper=t,this._buffers=null,this._origin=(0,u.c)(),this._dirty=!1,this._count=0,this._vao=null}set vertices(t){const r=new Float64Array(3*t.length);let s=0;for(const c of t)r[s++]=c[0],r[s++]=c[1],r[s++]=c[2];this.buffers=[r]}set buffers(t){if(this._buffers=t,this._buffers.length>0){const r=this._buffers[0],s=3*Math.floor(r.length/3/2);(0,o.s)(this._origin,r[s+0],r[s+1],r[s+2])}else(0,o.s)(this._origin,0,0,0);this._dirty=!0}get origin(){return this._origin}draw(t){const r=this._ensureVAO(t);(0,a.pC)(r)&&(t.bindVAO(r),t.drawArrays(l.MX.TRIANGLES,0,this._count))}dispose(){(0,a.pC)(this._vao)&&this._vao.dispose()}_ensureVAO(t){return(0,a.Wi)(this._buffers)?null:((0,a.Wi)(this._vao)&&(this._vao=this._createVAO(t,this._buffers)),this._ensureVertexData(this._vao,this._buffers),this._vao)}_createVAO(t,r){const s=this._createDataBuffer(r);return this._dirty=!1,new j.U(t,_.attributeLocations,{data:(0,d.K)(Q)},{data:g.f.createVertex(t,l.l1.STATIC_DRAW,s)})}_ensureVertexData(t,r){if(!this._dirty)return;const s=this._createDataBuffer(r);t.vertexBuffers.data.setData(s),this._dirty=!1}_numberOfRenderVertices(t){return 2*(t.length/3-1)*3}_createDataBuffer(t){const r=t.reduce((x,U)=>x+this._numberOfRenderVertices(U),0);this._count=r;const s=Q.createBuffer(r),c=this._origin;let V=0,K=0;for(const x of t){for(let U=0;U<x.length;U+=3){const B=(0,o.s)(G,x[U+0],x[U+1],x[U+2]);0===U?K=this._renderCoordsHelper.getAltitude(B):this._renderCoordsHelper.setAltitude(B,K);const I=this._renderCoordsHelper.worldUpAtPosition(B,Y),L=V+2*U,ie=(0,o.b)(G,B,c);if(U<x.length-3){s.up.setVec(L,I),s.up.setVec(L+3,I),s.up.setVec(L+5,I);for(let H=0;H<6;H++)s.start.setVec(L+H,ie);s.extrude.setValues(L+0,0,-1),s.extrude.setValues(L+1,1,-1),s.extrude.setValues(L+2,1,1),s.extrude.setValues(L+3,0,-1),s.extrude.setValues(L+4,1,1),s.extrude.setValues(L+5,0,1)}if(U>0){s.up.setVec(L-2,I),s.up.setVec(L-4,I),s.up.setVec(L-5,I);for(let H=-6;H<0;H++)s.end.setVec(L+H,ie)}}V+=this._numberOfRenderVertices(x)}return s.buffer}}const Y=(0,u.c)(),G=(0,u.c)(),Q=(0,b.U$)().vec3f(C.T.START).vec3f(C.T.END).vec3f(C.T.UP).vec2f(C.T.EXTRUDE);var oe=i(19597),q=i(5894),k=i(57623),N=i(17626),F=i(87601);class Z extends F.m{constructor(){super(...arguments),this.contrastControlEnabled=!1}}(0,N._)([(0,F.o)()],Z.prototype,"contrastControlEnabled",void 0),i(17625);var le=i(39114),ee=i(66501);class $ extends w.A{initializeProgram(t){const r=$.shader.get().build(this.configuration);return new f.$(t.rctx,r,le.i)}initializePipeline(){return(0,n.sm)({blending:(0,n.if)(l.zi.ONE,l.zi.ONE_MINUS_SRC_ALPHA),colorWrite:n.BK})}}$.shader=new E.J(ee.L,()=>i.e(7794).then(i.bind(i,17794)));class J extends Z{constructor(){super(...arguments),this.heightManifoldEnabled=!1,this.pointDistanceEnabled=!1,this.lineVerticalPlaneEnabled=!1,this.intersectsLineEnabled=!1}}(0,N._)([(0,F.o)()],J.prototype,"heightManifoldEnabled",void 0),(0,N._)([(0,F.o)()],J.prototype,"pointDistanceEnabled",void 0),(0,N._)([(0,F.o)()],J.prototype,"lineVerticalPlaneEnabled",void 0),(0,N._)([(0,F.o)()],J.prototype,"intersectsLineEnabled",void 0);const ce=(0,u.c)(),he=(0,O.c)(),de={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:(0,A.Vl)(6),globalAlphaContrastBoost:2,__tagStrict:"NoParameters"};function te(z,t,r,s){const c=ce,V=he;(0,o.m)(c,t,s),(0,o.c)(V,r),V[3]=0,(0,D.t)(V,V,s),(0,m.Yq)(c,V,z)}class _e{constructor(t,r={},s={contrastControlEnabled:!1}){this._renderCoordsHelper=t,this._config=s,this._technique=null,this._heightManifoldEnabled=!1,this._heightManifoldTarget=(0,u.c)(),this._pointDistanceEnabled=!1,this._pointDistanceOrigin=(0,u.c)(),this._pointDistanceTarget=(0,u.c)(),this._lineVerticalPlaneEnabled=!1,this._lineVerticalPlaneSegment=(0,y.Ue)(),this._intersectsLineEnabled=!1,this._intersectsLineSegment=(0,y.Ue)(),this._intersectsLineRadius=3,this._intersectsLineInfinite=!1,this._pathVerticalPlaneEnabled=!1,this._pathVerticalPlaneData=null,this._pathTechnique=null,this.canRender=!0,this._tempNormal=(0,u.c)(),this._tempDir=(0,u.c)(),this._tempUp=(0,u.c)(),this._tempVec3A=(0,u.c)(),this._tempVec3B=(0,u.c)(),this._tempVec4=(0,O.c)(),this._tempPlane=(0,m.Ue)(),this._tempSphere=(0,P.c)(),this._parameters=(0,k.Uf)(r,de)}get renderSlots(){return[this._config.contrastControlEnabled?q.r.LASERLINES_CONTRAST_CONTROL:q.r.LASERLINES]}get needsLinearDepth(){return!0}get heightManifoldEnabled(){return this._heightManifoldEnabled}set heightManifoldEnabled(t){this._heightManifoldEnabled!==t&&(this._heightManifoldEnabled=t,this._requestRender())}get heightManifoldTarget(){return this._heightManifoldTarget}set heightManifoldTarget(t){(0,o.c)(this._heightManifoldTarget,t),this._requestRender()}get pointDistanceEnabled(){return this._pointDistanceEnabled}set pointDistanceEnabled(t){t!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=t,this._requestRender())}get pointDistanceTarget(){return this._pointDistanceTarget}set pointDistanceTarget(t){(0,o.c)(this._pointDistanceTarget,t),this._requestRender()}get pointDistanceOrigin(){return this._pointDistanceOrigin}set pointDistanceOrigin(t){(0,o.c)(this._pointDistanceOrigin,t),this._requestRender()}get lineVerticalPlaneEnabled(){return this._lineVerticalPlaneEnabled}set lineVerticalPlaneEnabled(t){t!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=t,this._requestRender())}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){(0,y.JG)(t,this._lineVerticalPlaneSegment),this._requestRender()}get intersectsLineEnabled(){return this._intersectsLineEnabled}set intersectsLineEnabled(t){t!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=t,this._requestRender())}get intersectsLineSegment(){return this._intersectsLineSegment}set intersectsLineSegment(t){(0,y.JG)(t,this._intersectsLineSegment),this._requestRender()}get intersectsLineRadius(){return this._intersectsLineRadius}set intersectsLineRadius(t){t!==this._intersectsLineRadius&&(this._intersectsLineRadius=t,this._requestRender())}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(t){t!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=t,this._requestRender())}get pathVerticalPlaneEnabled(){return this._pathVerticalPlaneEnabled}set pathVerticalPlaneEnabled(t){t!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=t,(0,a.pC)(this._pathVerticalPlaneData)&&this._requestRender())}set pathVerticalPlaneVertices(t){(0,a.Wi)(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new W(this._renderCoordsHelper)),this._pathVerticalPlaneData.vertices=t,this.pathVerticalPlaneEnabled&&this._requestRender()}set pathVerticalPlaneBuffers(t){(0,a.Wi)(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new W(this._renderCoordsHelper)),this._pathVerticalPlaneData.buffers=t,this.pathVerticalPlaneEnabled&&this._requestRender()}setParameters(t){(0,k.LO)(this._parameters,t)&&this._requestRender()}initializeRenderContext(t){this._context=t,this._quadVAO=(0,oe.ow)(t.renderContext.rctx),this._techniqueRepository=t.shaderTechniqueRepository,this._techniqueConfig=new J;const s=new Z;s.contrastControlEnabled=this._config.contrastControlEnabled,this._pathTechnique=this._techniqueRepository.acquire(_,s)}uninitializeRenderContext(){this._quadVAO=(0,a.O3)(this._quadVAO),this._technique=(0,a.RY)(this._technique),this._pathVerticalPlaneData=(0,a.O3)(this._pathVerticalPlaneData),this._pathTechnique=(0,a.RY)(this._pathTechnique)}prepareTechnique(){return this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled?(this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled,this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled,this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled,this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled,this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled,this._technique=this._techniqueRepository.releaseAndAcquire($,this._techniqueConfig,this._technique),this._technique):this._pathTechnique}render(t,r){(this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled)&&this._renderUnified(t,r),this.pathVerticalPlaneEnabled&&this._renderPath(t)}_renderUnified(t,r){const s=t.rctx,c=s.bindTechnique(r,this._parameters,t.bindParameters);this._bindGlobalUniforms(t,c),this._bindHeightManifoldUniforms(t,c),this._bindPointDistanceUniforms(t,c),this._bindLineVerticalPlaneUniforms(t,c),this._bindIntersectsLineUniforms(t,c),s.bindVAO(this._quadVAO),s.drawArrays(l.MX.TRIANGLE_STRIP,0,4)}_renderPath(t){if((0,a.Wi)(this._pathVerticalPlaneData)||(0,a.Wi)(this._pathTechnique))return;const c=t.rctx.bindTechnique(this._pathTechnique,ae(re({},this._parameters),{origin:this._pathVerticalPlaneData.origin}),t.bindParameters);this._bindGlobalUniforms(t,c),this._pathVerticalPlaneData.draw(t.rctx)}_bindHeightManifoldUniforms(t,r){if(!this.heightManifoldEnabled)return;const s=this._tempVec3A,c=this._tempPlane,V=t.bindParameters.camera;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,s),te(c,this._heightManifoldTarget,s,V.viewMatrix),r.setUniform4fv("heightPlane",c)}_bindPointDistanceUniforms(t,r){if(!this._pointDistanceEnabled)return;const s=t.bindParameters.camera,c=this._tempSphere;(0,o.c)(c,this._pointDistanceOrigin),(0,o.m)(c,c,s.viewMatrix),c[3]=(0,o.i)(this._pointDistanceOrigin,this._pointDistanceTarget),r.setUniform4f("pointDistanceSphere",c[0],c[1],c[2],c[3])}_bindLineVerticalPlaneUniforms(t,r){if(!this._lineVerticalPlaneEnabled)return;const s=this._renderCoordsHelper,c=t.bindParameters.camera,V=this._tempPlane,K=this._tempVec3A,x=this._tempUp,U=this._tempDir,B=this._tempNormal;(0,y.KU)(this._lineVerticalPlaneSegment,.5,K),s.worldUpAtPosition(K,x),(0,o.n)(U,this._lineVerticalPlaneSegment.vector),(0,o.f)(B,x,U),(0,o.n)(B,B),te(V,this._lineVerticalPlaneSegment.origin,B,c.viewMatrix),r.setUniform4fv("lineVerticalPlane",V);const I=this._tempVec3A;(0,o.c)(I,this._lineVerticalPlaneSegment.origin),s.setAltitude(I,0),(0,o.m)(I,I,c.viewMatrix),r.setUniform3fv("lineVerticalStart",I);const L=this._tempVec3B;(0,o.a)(L,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector),s.setAltitude(L,0),(0,o.m)(L,L,c.viewMatrix),r.setUniform3fv("lineVerticalEnd",L)}_bindIntersectsLineUniforms(t,r){if(!this._intersectsLineEnabled)return;const s=ue,c=fe,V=t.bindParameters.camera;if(this._intersectsLineInfinite){if((0,R.iL)((0,p.re)(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),X),X.c0=-Number.MAX_VALUE,!(0,h.zq)(V.frustum,X))return;(0,R.Ws)(X,s),(0,R.S$)(X,c)}else(0,o.c)(s,this._intersectsLineSegment.origin),(0,o.a)(c,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);const K=this._tempVec3A;(0,o.m)(K,s,V.viewMatrix),r.setUniform3fv("intersectsLineStart",K);const x=this._tempVec4;(0,o.c)(x,this._intersectsLineSegment.vector),this._tempVec4[3]=0,(0,D.t)(this._tempVec4,this._tempVec4,V.viewMatrix),(0,o.m)(c,c,V.viewMatrix),r.setUniform3fv("intersectsLineEnd",c),(0,o.n)(x,x),r.setUniform3f("intersectsLineDirection",x[0],x[1],x[2]),r.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}_bindGlobalUniforms(t,r){const s=t.bindParameters.camera;this._heightManifoldEnabled?r.setUniform1f("maxPixelDistance",2*s.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?r.setUniform1f("maxPixelDistance",2*s.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&r.setUniform1f("maxPixelDistance",2*s.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin)),r.bindTexture("frameColor",t.offscreenRenderingHelper.mainColorTexture)}_requestRender(){this._context&&this._context.requestRender()}}const X=(0,R.Ue)(),ue=(0,u.c)(),fe=(0,u.c)();class ge extends T.l{constructor(t){super(t.view),this._angleCutoff=ee.d,this._style={},this._heightManifoldTarget=(0,u.c)(),this._heightManifoldEnabled=!1,this._intersectsLine=(0,y.Ue)(),this._intersectsLineEnabled=!1,this._intersectsLineInfinite=!1,this._lineVerticalPlaneSegment=null,this._pathVerticalPlaneBuffers=null,this._pointDistanceLine=null,this.applyProps(t)}get testData(){return this.renderer}createResources(){this._ensureRenderer()}destroyResources(){this._disposeRenderer()}updateVisibility(){this._syncRenderer(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance()}get angleCutoff(){return this._angleCutoff}set angleCutoff(t){this._angleCutoff!==t&&(this._angleCutoff=t,this._syncAngleCutoff())}get style(){return this._style}set style(t){this._style=t,this._syncStyle()}get heightManifoldTarget(){return this._heightManifoldEnabled?this._heightManifoldTarget:null}set heightManifoldTarget(t){(0,a.pC)(t)?((0,o.c)(this._heightManifoldTarget,t),this._heightManifoldEnabled=!0):this._heightManifoldEnabled=!1,this._syncRenderer(),this._syncHeightManifold()}set intersectsWorldUpAtLocation(t){if((0,a.Wi)(t))return void(this.intersectsLine=null);const r=this.view.renderCoordsHelper.worldUpAtPosition(t,pe);this.intersectsLine=(0,y.al)(t,r),this.intersectsLineInfinite=!0}get intersectsLine(){return this._intersectsLineEnabled?this._intersectsLine:null}set intersectsLine(t){(0,a.pC)(t)?((0,y.JG)(t,this._intersectsLine),this._intersectsLineEnabled=!0):this._intersectsLineEnabled=!1,this._syncIntersectsLine(),this._syncRenderer()}get intersectsLineInfinite(){return this._intersectsLineInfinite}set intersectsLineInfinite(t){this._intersectsLineInfinite=t,this._syncIntersectsLineInfinite()}get lineVerticalPlaneSegment(){return this._lineVerticalPlaneSegment}set lineVerticalPlaneSegment(t){this._lineVerticalPlaneSegment=(0,a.pC)(t)?(0,y.JG)(t):null,this._syncLineVerticalPlane(),this._syncRenderer()}get pathVerticalPlane(){return this._pathVerticalPlaneBuffers}set pathVerticalPlane(t){this._pathVerticalPlaneBuffers=t,this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncRenderer()}get pointDistanceLine(){return this._pointDistanceLine}set pointDistanceLine(t){this._pointDistanceLine=(0,a.pC)(t)?{origin:(0,u.a)(t.origin),target:(0,u.a)(t.target)}:null,this._syncPointDistance(),this._syncRenderer()}_syncRenderer(){this.attached&&this.visible&&(this._intersectsLineEnabled||this._heightManifoldEnabled||(0,a.pC)(this._pointDistanceLine)||(0,a.pC)(this._pathVerticalPlaneBuffers))?this._ensureRenderer():this._disposeRenderer()}_ensureRenderer(){(0,a.pC)(this.renderer)||(this.renderer=new _e(this.view.renderCoordsHelper,void 0,{contrastControlEnabled:!0}),this._syncStyle(),this._syncHeightManifold(),this._syncIntersectsLine(),this._syncIntersectsLineInfinite(),this._syncPathVerticalPlane(),this._syncLineVerticalPlane(),this._syncPointDistance(),this._syncAngleCutoff(),this.view._stage&&this.view._stage.addRenderPlugin(this.renderer.renderSlots,this.renderer))}_syncStyle(){(0,a.Wi)(this.renderer)||(this.renderer.setParameters(this._style),null!=this._style.intersectsLineRadius&&(this.renderer.intersectsLineRadius=this._style.intersectsLineRadius))}_syncAngleCutoff(){(0,a.Wi)(this.renderer)||this.renderer.setParameters({angleCutoff:this._angleCutoff})}_syncHeightManifold(){(0,a.Wi)(this.renderer)||(this.renderer.heightManifoldEnabled=this._heightManifoldEnabled&&this.visible,this._heightManifoldEnabled&&(this.renderer.heightManifoldTarget=this._heightManifoldTarget))}_syncIntersectsLine(){(0,a.Wi)(this.renderer)||(this.renderer.intersectsLineEnabled=this._intersectsLineEnabled&&this.visible,this._intersectsLineEnabled&&(this.renderer.intersectsLineSegment=this._intersectsLine))}_syncIntersectsLineInfinite(){(0,a.Wi)(this.renderer)||(this.renderer.intersectsLineInfinite=this._intersectsLineInfinite)}_syncPathVerticalPlane(){(0,a.Wi)(this.renderer)||(this.renderer.pathVerticalPlaneEnabled=(0,a.pC)(this._pathVerticalPlaneBuffers)&&this.visible,(0,a.pC)(this._pathVerticalPlaneBuffers)&&(this.renderer.pathVerticalPlaneBuffers=this._pathVerticalPlaneBuffers))}_syncLineVerticalPlane(){(0,a.Wi)(this.renderer)||(this.renderer.lineVerticalPlaneEnabled=(0,a.pC)(this._lineVerticalPlaneSegment)&&this.visible,(0,a.pC)(this._lineVerticalPlaneSegment)&&(this.renderer.lineVerticalPlaneSegment=this._lineVerticalPlaneSegment))}_syncPointDistance(){(0,a.Wi)(this.renderer)||(this.renderer.pointDistanceEnabled=(0,a.pC)(this._pointDistanceLine)&&this.visible,(0,a.pC)(this._pointDistanceLine)&&(this.renderer.pointDistanceOrigin=this._pointDistanceLine.origin,this.renderer.pointDistanceTarget=this._pointDistanceLine.target))}_disposeRenderer(){(0,a.pC)(this.renderer)&&this.view._stage&&(this.view._stage.removeRenderPlugin(this.renderer),this.renderer=null)}}const pe=(0,u.c)()},30693:(S,v,i)=>{i.d(v,{L:()=>E});var a=i(21286),o=i(62208),u=i(84161),y=i(28093),T=i(993),A=i(4794),D=i(55915),O=i(5548),R=i(26242),h=i(94375),m=i(81468),p=i(79112),P=i(10596),d=i(57521),b=i(16396),C=i(80805);class E{constructor(n){this.view=null,this._geometry=null,this._size=3,this._color=(0,A.f)(1,0,1,1),this._pixelSnappingEnabled=!0,this._primitive="square",this._outlineSize=1,this._outlineColor=(0,A.f)(1,1,1,1),this._elevationInfo=null,this.resources=new h.O({view:n.view,createResources:g=>this._createResources(g),recreateGeometry:(g,j)=>(g.geometry=this._recreateGeometry(j,g.material),(0,o.pC)(g.geometry)?[g.geometry]:[])});let _=!0;for(const g in n)g in this?"attached"===g?_=n[g]:this[g]=n[g]:console.error("Cannot set unknown property",g);this.attached=_}destroy(){this.resources.destroy()}get visible(){return this.resources.visible}set visible(n){this.resources.visible=n}get attached(){return this.resources.attached}set attached(n){this.resources.attached=n}get geometry(){return this._geometry}set geometry(n){this._geometry=n,this.resources.recreateGeometry()}get size(){return this._size}set size(n){if(n!==this._size){const _=this.preferredTextureSize;this._size=n,_<this.preferredTextureSize?(0,o.pC)(this.resources)&&this.resources.recreate():this._updateSizeAttribute()}}get color(){return this._color}set color(n){(0,T.g)(n,this._color)||((0,T.c)(this._color,n),this._updateMaterial())}get pixelSnappingEnabled(){return this._pixelSnappingEnabled}set pixelSnappingEnabled(n){this._pixelSnappingEnabled!==n&&(this._pixelSnappingEnabled=n,this._updateMaterial())}get primitive(){return this._primitive}set primitive(n){this._primitive!==n&&(this._primitive=n,(0,o.pC)(this.resources)&&this.resources.recreate())}get outlineSize(){return this._outlineSize}set outlineSize(n){n!==this._outlineSize&&(this._outlineSize=n,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(n){(0,T.g)(n,this._outlineColor)||((0,T.c)(this._outlineColor,n),this._updateMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(n){this._elevationInfo=n,this.resources&&this.resources.recreateGeometry()}_updateMaterial(){const n=this.resources.resources;(0,o.Wi)(n)||n.material.setParameters(this._materialParameters(n.texture.id))}_updateSizeAttribute(){const n=this.resources.resources,_=this.resources.object;if((0,o.Wi)(n)||(0,o.Wi)(_))return;const g=n.geometry;if((0,o.Wi)(g))return;const j=g.getMutableAttribute(b.T.SIZE).data,W=this.geometrySize;j[0]=W,j[1]=W,_.geometryVertexAttrsUpdated(_.geometryRecords[0])}_materialParameters(n){return{color:this._color,textureIsSignedDistanceField:!0,distanceFieldBoundingBox:f,occlusionTest:!1,outlineColor:this._outlineColor,outlineSize:this._outlineSize,textureId:n,polygonOffset:!1,shaderPolygonOffset:0,drawInSecondSlot:!0,depthEnabled:!1,pixelSnappingEnabled:this.pixelSnappingEnabled}}get geometrySize(){return this._size/w}_recreateGeometry(n,_){const g=this._createRenderGeometry();return(0,o.pC)(g)&&n.addGeometry(g,_),g}_createResources(n){const _=(0,P.cU)(this._primitive,this.preferredTextureSize),g=new C.A(this._materialParameters(_.id)),j=this._recreateGeometry(n,g);return{material:g,texture:_,geometry:j,forEach(W){W(_),W(g),(0,o.pC)(this.geometry)&&W(this.geometry)}}}get preferredTextureSize(){return(0,a.uZ)((0,a.Sf)(2*this.geometrySize),16,128)}calculateMapBounds(n){if((0,o.Wi)(this.resources.resources)||(0,o.Wi)(this.resources.resources.geometry))return!1;const _=this.resources.resources.geometry.vertexAttributes.get(b.T.POSITION);return(0,D.SH)(_.data,this.view.renderCoordsHelper.spatialReference,M,this.view.spatialReference),(0,O.G1)(n,M),!0}_createRenderGeometry(){const n=this.geometry;if((0,o.Wi)(n))return null;const{renderCoordsHelper:_,elevationProvider:g}=this.view,j=(0,m.w7)(n,g,p.o.fromElevationInfo(this.elevationInfo),_),W=(0,u.s)(R.WM.get(),n.x,n.y,j),Y=R.WM.get();(0,D.SH)(W,n.spatialReference,Y,_.spatialReference);const G=this.geometrySize;return d.Z.createPointGeometry(null,Y,null,[G,G],[0,0,0,1])}}const w=P.Ns,f=[w/2,w/2,1-w/2,1-w/2],M=(0,y.c)()},94375:(S,v,i)=>{i.d(v,{O:()=>O});var a=i(62208),o=i(32917),u=i(42743),y=i(24425),T=i(97272),A=i(81695),D=i(34103);class O{constructor(h){this.resourceFactory=h,this._resources=null,this._visible=!0,this._attached=!1}destroy(){this._destroyResources()}get object(){return(0,a.pC)(this._resources)?this._resources.object:null}get resources(){return(0,a.pC)(this._resources)?this._resources.external:null}get visible(){return this._visible}set visible(h){h!==this._visible&&(this._visible=h,this._syncVisible())}get attached(){return this._attached}set attached(h){h!==this._attached&&(this._attached=h,this._createOrDestroyResources())}recreate(){this.attached&&this._createResources()}recreateGeometry(){if(!this.resourceFactory.recreateGeometry)return void this.recreate();const h=this.resourceFactory.view._stage;if((0,a.Wi)(this._resources)||!h)return;const m=this._resources.object;this._resources.external.forEach(P=>{P.type===y.U.Geometry&&h.remove(P)}),m.removeAllGeometries();const p=this.resourceFactory.recreateGeometry(this._resources.external,m,this._resources.layer);h.addMany(p)}_createOrDestroyResources(){this._attached?this._resources||this._createResources():this._destroyResources()}_createResources(){this._destroyResources();const h=this.resourceFactory,m=h.view,p=m._stage;if(!p)return;const P=new D.F({isPickable:!1,updatePolicy:u.jq.SYNC});p.add(P);const d=new T.T({castShadow:!1}),b=h.createResources(d,P);b.forEach(E=>{p.add(E),E instanceof A.x&&p.loadImmediate(E)}),p.add(d),P.add(d);const C=h.cameraChanged?(0,o.YP)(()=>m.state.camera,E=>h.cameraChanged(E),o.nn):null;this._resources={layer:P,object:d,external:b,cameraHandle:C},this._syncVisible()}_destroyResources(){if((0,a.Wi)(this._resources))return;const h=this.resourceFactory.view._stage;null==h||h.remove(this._resources.object),null==h||h.remove(this._resources.layer),this._resources.external.forEach(m=>{null==h||h.remove(m),"dispose"in m&&m.dispose()}),this._resources.object.dispose(),this._resources.cameraHandle&&this._resources.cameraHandle.remove(),this._resources=null}_syncVisible(){(0,a.Wi)(this._resources)||this._resources.object.setVisible(this._visible)}}},47634:(S,v,i)=>{i.d(v,{j:()=>h});var a=i(62208),o=i(47923),u=i(39832),y=i(95285),T=i(97139),A=i(65787),D=i(17625),O=i(35387),R=i(66838);function h(m,p){m.extensions.add("GL_OES_standard_derivatives");const P=m.fragment;P.include(o.S),m.include(u.G),P.uniforms.add([new A.p("globalAlpha",d=>d.globalAlpha),new T.J("glowColor",d=>d.glowColor),new A.p("glowWidth",(d,b)=>d.glowWidth*b.camera.pixelRatio),new A.p("glowFalloff",d=>d.glowFalloff),new T.J("innerColor",d=>d.innerColor),new A.p("innerWidth",(d,b)=>d.innerWidth*b.camera.pixelRatio),new O.A("depthMap",(d,b)=>b.linearDepthTexture),new y.A("nearFar",(d,b)=>b.camera.nearFar),new R.Q("frameColor")]),P.code.add(D.H`vec4 blendPremultiplied(vec4 source, vec4 dest) {
float oneMinusSourceAlpha = 1.0 - source.a;
return vec4(
source.rgb + dest.rgb * oneMinusSourceAlpha,
source.a + dest.a * oneMinusSourceAlpha
);
}`),P.code.add(D.H`vec4 premultipliedColor(vec3 rgb, float alpha) {
return vec4(rgb * alpha, alpha);
}`),P.code.add(D.H`vec4 laserlineProfile(float dist) {
if (dist > glowWidth) {
return vec4(0.0);
}
float innerAlpha = (1.0 - smoothstep(0.0, innerWidth, dist));
float glowAlpha = pow(max(0.0, 1.0 - dist / glowWidth), glowFalloff);
return blendPremultiplied(
premultipliedColor(innerColor, innerAlpha),
premultipliedColor(glowColor, glowAlpha)
);
}`),P.code.add(D.H`bool laserlineReconstructFromDepth(out vec3 pos, out vec3 normal, out float depthDiscontinuityAlpha) {
float depth = linearDepthFromTexture(depthMap, uv, nearFar);
if (-depth == nearFar[0]) {
return false;
}
pos = reconstructPosition(gl_FragCoord.xy, depth);
normal = normalize(cross(dFdx(pos), dFdy(pos)));
float ddepth = fwidth(depth);
depthDiscontinuityAlpha = 1.0 - smoothstep(0.0, 0.01, -ddepth / depth);
return true;
}`),p.contrastControlEnabled?(P.uniforms.add(new A.p("globalAlphaContrastBoost",d=>(0,a.pC)(d.globalAlphaContrastBoost)?d.globalAlphaContrastBoost:1)),P.code.add(D.H`float rgbToLuminance(vec3 color) {
return dot(vec3(0.2126, 0.7152, 0.0722), color);
}
vec4 laserlineOutput(vec4 color) {
float backgroundLuminance = rgbToLuminance(texture2D(frameColor, uv).rgb);
float alpha = clamp(globalAlpha * max(backgroundLuminance * globalAlphaContrastBoost, 1.0), 0.0, 1.0);
return color * alpha;
}`)):P.code.add(D.H`vec4 laserlineOutput(vec4 color) {
return color * globalAlpha;
}`)}}}]);
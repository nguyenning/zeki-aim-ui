"use strict";var V=Object.defineProperty,N=Object.getOwnPropertySymbols,X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable,D=(S,y,o)=>y in S?V(S,y,{enumerable:!0,configurable:!0,writable:!0,value:o}):S[y]=o,T=(S,y)=>{for(var o in y||(y={}))X.call(y,o)&&D(S,o,y[o]);if(N)for(var o of N(y))Y.call(y,o)&&D(S,o,y[o]);return S};(self.webpackChunkexample_app=self.webpackChunkexample_app||[]).push([[5895],{65389:(S,y,o)=>{o.d(y,{Z:()=>O});var _=o(62208);class O{constructor(g){this.size=0,this._start=0,this.maxSize=g,this._buffer=new Array(g)}get entries(){return this._buffer}enqueue(g){if(this.size===this.maxSize){const a=this._buffer[this._start];return this._buffer[this._start]=g,this._start=(this._start+1)%this.maxSize,a}return this._buffer[(this._start+this.size++)%this.maxSize]=g,null}dequeue(){if(0===this.size)return null;const g=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,g}peek(){return 0===this.size?null:this._buffer[this._start]}find(g){if(0===this.size)return null;for(const a of this._buffer)if((0,_.pC)(a)&&g(a))return a;return null}clear(g){let a=this.dequeue();for(;(0,_.pC)(a);)g&&g(a),a=this.dequeue()}}},5075:(S,y,o)=>{o.d(y,{Qo:()=>l});var _=o(65389),O=o(21286),v=o(62208);const a="__esri_timestamp__";class l{constructor(n,c,d,h,b=128){this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=d,this._purgeOptions=h,this.store=n,this.objectIdField=c,this.purgeInterval=b,this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}add(n){if(this._useGeneratedIds){const h=this._nextId();n.attributes[this.objectIdField]=h,n.objectId=h}else n.objectId=n.attributes[this.objectIdField];if(this._addOrUpdated.set(n.objectId,n),this._maxAge=Math.max(this._maxAge,n.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,v.Wi)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new _.Z(1e5)),void this._trackIdLessObservations.enqueue(n.objectId);const c=n.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(c)){const h=(0,v.pC)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,b=(0,O.uZ)(h,0,1e3);this._trackIdToObservations.set(c,new _.Z(b))}const d=this._trackIdToObservations.get(c).enqueue(n.objectId);(0,v.pC)(d)&&(this._addOrUpdated.has(d)?this._addOrUpdated.delete(d):this._removed.push(d))}checkForUpdates(){const n=this._getToAdd(),c=this._getToRemove(),d=performance.now();d-this._lastPurge>=this.purgeInterval&&(this._purge(d),this._lastPurge=d);const h=[];if((0,v.pC)(c))for(const b of c){const F=this.store.removeById(b);(0,v.pC)(F)&&h.push(F)}if((0,v.pC)(n))for(const b of n)b.attributes[a]=d,this.store.add(b);(n||h)&&this.store.update(n,h)}_getToAdd(){if(!this._addOrUpdated.size)return null;const n=new Array(this._addOrUpdated.size);let c=0;return this._addOrUpdated.forEach(d=>n[c++]=d),this._addOrUpdated.clear(),n}_getToRemove(){const n=this._removed;return this._removed.length?(this._removed=[],n):null}_nextId(){const n=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,n}_purge(n){const c=this._purgeOptions;(0,v.pC)(c)&&(this._purgeSomeByDisplayCount(c),this._purgeByAge(c),this._purgeByAgeReceived(n,c),this._purgeTracks())}_purgeSomeByDisplayCount(n){if(!n.displayCount)return;let c=this.store.size;if(c>n.displayCount){if(this._timeInfo.trackIdField)for(const d of this._trackIdToObservations.values())if(c>n.displayCount&&d.size){const h=(0,v.Wg)(d.dequeue());this._removed.push(h),c--}if((0,v.pC)(this._trackIdLessObservations)){let d=c-n.displayCount;for(;d-- >0;){const h=this._trackIdLessObservations.dequeue();(0,v.pC)(h)&&this._removed.push(h)}}}}_purgeByAge(n){var h;if(!n.age||null==(h=this._timeInfo)||!h.startTimeField)return;const d=this._maxAge-60*n.age*1e3;this.store.forEach(b=>{b.attributes[this._timeInfo.startTimeField]<d&&this._removed.push(b.objectId)})}_purgeByAgeReceived(n,c){if(!c.ageReceived)return;const d=n-60*c.ageReceived*1e3;this.store.forEach(h=>{h.attributes[a]<d&&this._removed.push(h.objectId)})}_purgeTracks(){this._trackIdToObservations.forEach((n,c)=>{0===n.size&&this._trackIdToObservations.delete(c)})}}},16147:(S,y,o)=>{o.d(y,{I:()=>q});var _=o(15861),O=o(17626),g=(o(29132),o(84792)),a=o(26584),Z=o(63290),l=o(62208),R=o(10699),n=o(21726),F=(o(90912),o(85931),o(8314),o(82255),o(76898)),P=o(77712),L=o(33696),z=o(61885),M=o(80542);let j=class extends(z.Z.EventedMixin(M.r)){onFeature(e){this.emit("feature",e)}};j=(0,O._)([(0,F.j)("esri.layers.graphics.sources.connections.StreamConnection")],j);const B=j,k=Z.Z.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");var x,e;(e=x||(x={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let E=class extends B{constructor(e){super(),this.errorString=null;const{geometryType:t,spatialReference:s,sourceSpatialReference:r}=e;this._config=e,this._featureZScaler=(0,L.k)(t,r,s),this._open()}_open(){var e=this;return(0,_.Z)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){(0,l.pC)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if((0,l.Wi)(this._websocket))return"disconnected";switch(this._websocket.readyState){case x.CONNECTING:case x.OPEN:return"connected";case x.CLOSING:case x.CLOSED:return"disconnected"}}_tryCreateWebSocket(e=this._config.source.path,t=1e3,s=0){var r=this;return(0,_.Z)(function*(){try{if(r.destroyed)return;const i=(0,n.fl)(e,r._config.customParameters);r._websocket=yield r._createWebSocket(i),r.notifyChange("connectionStatus")}catch(i){const u=t/1e3;return r._config.maxReconnectionAttempts&&s>=r._config.maxReconnectionAttempts?(k.error(new a.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void r.destroy()):(k.error(new a.Z("websocket-connection",`Failed to connect. Attempting to reconnect in ${u}s`,i)),yield(0,R.e4)(t),r._tryCreateWebSocket(e,Math.min(1.5*t,1e3*r._config.maxReconnectionInterval),s+1))}})()}_createWebSocket(e){return new Promise((t,s)=>{const r=new WebSocket(e);r.onopen=()=>{if(r.onopen=null,this.destroyed)return r.onclose=null,void r.close();r.onclose=i=>this._onClose(i),r.onerror=i=>this._onError(i),r.onmessage=i=>this._onMessage(i),t(r)},r.onclose=i=>{r.onopen=r.onclose=null,s(i)}})}_handshake(e=1e4){var t=this;return(0,_.Z)(function*(){const s=t._websocket;if((0,l.Wi)(s))return;const r=(0,R.hh)(),i=s.onmessage,{filter:u,outFields:p,spatialReference:C}=t._config;return r.timeout(e),s.onmessage=w=>{var f;let m=null;try{m=JSON.parse(w.data)}catch(A){}m&&"object"==typeof m||(k.error(new a.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",w.data)),r.reject(),t.destroy()),(null==(f=m.spatialReference)?void 0:f.wkid)!==(null==C?void 0:C.wkid)&&(k.error(new a.Z("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${C.wkid}`,w.data)),r.reject(),t.destroy()),"json"!==m.format&&(k.error(new a.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",w.data)),r.reject(),t.destroy()),u&&m.filter!==u&&k.error(new a.Z("websocket-connection","Tried to set filter, but server doesn't support it")),p&&m.outFields!==p&&k.error(new a.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),s.onmessage=i,r.resolve()},s.send(JSON.stringify({filter:u,outFields:p,format:"json",spatialReference:{wkid:C.wkid}})),r.promise})()}_onMessage(e){try{const t=JSON.parse(e.data);if("featureResult"!==t.type)throw new a.Z("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);for(const s of t.features)(0,l.pC)(this._featureZScaler)&&this._featureZScaler(s.geometry),this.onFeature(s)}catch(t){return k.error(new a.Z("websocket-connection","Failed to parse message",t)),void this.destroy()}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),k.error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&k.error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,O._)([(0,P.Cb)()],E.prototype,"connectionStatus",null),(0,O._)([(0,P.Cb)()],E.prototype,"errorString",void 0),E=(0,O._)([(0,F.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],E);var U=o(20477),G=o(84952),Q=o(91179),J=o(65234);const I=Z.Z.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),H={maxQueryDepth:5,maxRecordCountFactor:3};let W=class extends E{constructor(e){super(T(T({},H),e))}_open(){var e=this;return(0,_.Z)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||I.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const s=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(s);const{filter:r,outFields:i}=e._config;e.destroyed||e._setFilter(r,i)})()}_onMessage(e){let t;try{t=this._enrich(JSON.parse(e.data)),(0,l.pC)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(s){return void I.error(new a.Z("geoevent-connection","Failed to parse message",s))}this.onFeature(t)}_fetchServiceDefinition(e){var t=this;return(0,_.Z)(function*(){const s=T({f:"json"},t._config.customParameters),r=(0,g.default)(e.path,{query:s,responseType:"json"}),i=(yield r).data;return t._serviceDefinition=i,i})()}_fetchWebSocketUrl(e,t){const s=e[0],{urls:r,token:i}=s,u=this._inferWebSocketBaseUrl(r);return(0,n.fl)(`${u}/subscribe`,{outSR:""+t.wkid,token:i})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return I.error(new a.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var s=this;return(0,_.Z)(function*(){const r=s._websocket;if((0,l.Wi)(r)||(0,l.Wi)(e)&&(0,l.Wi)(t))return;const i=JSON.stringify({filter:s._serializeFilter(e,t)});let u=!1;const p=(0,R.hh)();return r.onmessage=m=>{const f=JSON.parse(m.data);f.filter&&(f.error&&(I.error(new a.Z("geoevent-connection","Failed to set service filter",f.error)),s._set("errorString",`Could not set service filter - ${f.error}`),p.reject(f.error)),r.onmessage=s._onMessage.bind(s),u=!0,p.resolve())},r.send(i),setTimeout(()=>{u||(s.destroyed||s._websocket!==r||I.error(new a.Z("geoevent-connection","Server timed out when setting filter")),p.reject())},1e4),p.promise})()}_serializeFilter(e,t){const s={};if((0,l.Wi)(e)&&(0,l.Wi)(t))return s;if((0,l.pC)(e)&&e.geometry)try{const r=(0,Q.im)(e.geometry);if("extent"!==r.type)throw new a.Z(`Expected extent but found type ${r.type}`);s.geometry=JSON.stringify(r.shiftCentralMeridian())}catch(r){I.error(new a.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",r))}return(0,l.pC)(e)&&e.where&&"1 = 1"!==e.where&&(s.where=e.where),(0,l.pC)(t)&&(s.outFields=t.join(",")),s}_enrich(e){if(!this._relatedFeatures)return e;const s=e.attributes[this._serviceDefinition.relatedFeatures.joinField];if(!this._relatedFeatures.has(s))return I.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:r,geometry:i}=this._relatedFeatures.get(s);for(const u in r)e.attributes[u]=r[u];return i&&(e.geometry=i),e.geometry||e.centroid||I.error(new a.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,_.Z)(function*(){try{const{relatedFeatures:t,keepLatestArchive:s}=e._serviceDefinition,r=e._queryRelatedFeatures(t),i=e._queryArchive(s);yield r;const u=yield i;if(!u)return;for(const p of u.features)e.onFeature(e._enrich(p))}catch(t){I.error(new a.Z("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,_.Z)(function*(){if(!e)return;const s=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(s)})()}_queryArchive(e){var t=this;return(0,_.Z)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,_.Z)(function*(){const s=new((yield Promise.resolve().then(o.bind(o,32258))).default)({url:e}),{capabilities:r}=yield s.load(),i=r.query.supportsMaxRecordCountFactor,u=r.query.supportsPagination,p=r.query.supportsCentroid,C=t._config.maxRecordCountFactor,w=s.capabilities.query.maxRecordCount,m=i?w*C:w,f=new G.Z;if(f.outFields=(0,l.Pt)(t._config.outFields,["*"]),f.where=(0,l.Pt)((0,l.U2)(t._config.filter,"where"),"1=1"),f.returnGeometry=!0,f.returnExceededLimitFeatures=!0,f.outSpatialReference=J.Z.fromJSON(t._config.spatialReference),p&&(f.returnCentroid=!0),i&&(f.maxRecordCountFactor=C),u)return f.num=m,s.destroy(),t._queryPages(e,f);const A=yield(0,U.executeQuery)(e,f,t._config.sourceSpatialReference);return s.destroy(),A.data})()}_queryPages(e,t,s=[],r=0){var i=this;return(0,_.Z)(function*(){t.start=(0,l.pC)(t.num)?r*t.num:null;const{data:u}=yield(0,U.executeQuery)(e,t,i._config.sourceSpatialReference);return u.exceededTransferLimit&&r<i._config.maxQueryDepth?(u.features.forEach(p=>s.push(p)),i._queryPages(e,t,s,r+1)):(s.forEach(p=>u.features.push(p)),u)})()}_addRelatedFeatures(e){const t=new Map,s=e.features,r=this._serviceDefinition.relatedFeatures.joinField;for(const i of s)t.set(i.attributes[r],i);this._relatedFeatures=t}};W=(0,O._)([(0,F.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],W);const K=W;function q(e,t,s,r,i,u,p,C){const w=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),m={source:e,sourceSpatialReference:t,spatialReference:s,geometryType:r,filter:i,maxReconnectionAttempts:u,maxReconnectionInterval:p,customParameters:C};return w?new E(m):new K(m)}}}]);